

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/Lsh.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="核心内容：1. 解决用户认证登录问题">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
  <title>畅购商城项目第四部分 - laobanjiu</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"laobanjiu9527.github.io","root":"/","version":"1.8.11","typing":{"enable":true,"typeSpeed":70,"cursorChar":" ","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>老斑鸠</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/snoopy3.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="畅购商城项目第四部分">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-07-28 16:32" pubdate>
        2021年7月28日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      8.8k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      115
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">畅购商城项目第四部分</h1>
            
            <div class="markdown-body">
              <h1 id="Part09-用户认证"><a href="#Part09-用户认证" class="headerlink" title="Part09 用户认证"></a>Part09 用户认证</h1><h2 id="1-用户认证分析"><a href="#1-用户认证分析" class="headerlink" title="1. 用户认证分析"></a>1. 用户认证分析</h2><p><img src="/images/image-20210806165006789.png" srcset="/img/loading.gif" lazyload alt="image-20210806165006789"></p>
<p>上面流程图描述了用户要操作的各个微服务，用户查看个人信息需要访问客户微服务，下单需要访问订单微服务，秒杀抢购商品需要访问秒杀微服务。每个服务都需要认证用户的身份，身份认证成功后，需要识别用户的角色然后授权访问对应的功能。</p>
<h3 id="1-1-单点登录"><a href="#1-1-单点登录" class="headerlink" title="1.1 单点登录"></a>1.1 单点登录</h3><p>用户访问的项目中，至少有3个微服务需要识别用户身份，如果用户访问每个微服务都登录一次就太麻烦了，为了提高用户的体验，我们需要实现让用户在一个系统中登录，其他任意受信任的系统都可以访问，这个功能就叫单点登录。</p>
<p>单点登录（Single Sign On），简称为 SSO，是目前比较流行的企业业务整合的解决方案之一。 SSO的定义是在多个应用系统中，用户只需要登录一次就可以访问所有相互信任的应用系统</p>
<h3 id="1-2-第三方账号登陆"><a href="#1-2-第三方账号登陆" class="headerlink" title="1.2 第三方账号登陆"></a>1.2 第三方账号登陆</h3><p>随着国内及国外巨头们的平台开放战略以及移动互联网的发展，第三方登录已经不是一个陌生的产品设计概念了。 所谓的第三方登录，是说基于用户在第三方平台上已有的账号和密码来快速完成己方应用的登录或者注册的功能。而这里的第三方平台，一般是已经拥有大量用户的平台，国外的比如Facebook，Twitter等，国内的比如微博、微信、QQ等。</p>
<p><img src="/images/image-20210806165406268.png" srcset="/img/loading.gif" lazyload alt="image-20210806165406268"></p>
<h2 id="2-认证解决方案"><a href="#2-认证解决方案" class="headerlink" title="2. 认证解决方案"></a>2. 认证解决方案</h2><h3 id="2-1-单点登录技术方案"><a href="#2-1-单点登录技术方案" class="headerlink" title="2.1 单点登录技术方案"></a>2.1 单点登录技术方案</h3><p>分布式系统要实现单点登录，通常将认证系统独立抽取出来，并且将用户身份信息存储在单独的存储介质，比如： MySQL、Redis，考虑性能要求，通常存储在Redis中，如下图：</p>
<p><img src="/images/image-20210806165638050.png" srcset="/img/loading.gif" lazyload alt="image-20210806165638050"></p>
<p>Java中有很多用户认证的框架都可以实现单点登录：</p>
<ul>
<li>Apache Shiro</li>
<li>CAS</li>
<li>Spring security  </li>
</ul>
<h3 id="第三方登录技术方案"><a href="#第三方登录技术方案" class="headerlink" title="第三方登录技术方案"></a>第三方登录技术方案</h3><h4 id="2-2-1-Oauth2认证流程"><a href="#2-2-1-Oauth2认证流程" class="headerlink" title="2.2.1 Oauth2认证流程"></a>2.2.1 Oauth2认证流程</h4><p>第三方认证技术方案最主要是解决认证协议的通用标准问题，因为要实现跨系统认证，各系统之间要遵循一定的 接口协议。 OAUTH协议为用户资源的授权提供了一个安全的、开放而又简易的标准。同时，任何第三方都可以使用OAUTH认 证服务，任何服务提供商都可以实现自身的OAUTH认证服务，因而OAUTH是开放的。业界提供了OAUTH的多种实现如PHP、JavaScript，Java，Ruby等各种语言开发包，大大节约了程序员的时间，因而OAUTH是简易的。互联网很多服务如Open API，很多大公司如Google，Yahoo，Microsoft等都提供了OAUTH认证服务，这些都足以说明OAUTH标准逐渐成为开放资源授权的标准。 Oauth协议目前发展到2.0版本，1.0版本过于复杂，2.0版本已得到广泛应用。 参考：<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/oAuth/7153134?fr=aladdin">https://baike.baidu.com/item/oAuth/7153134?fr=aladdin</a> Oauth协议：<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a> 下边分析一个Oauth2认证的例子，黑马程序员网站使用微信认证的过程</p>
<p><img src="/images/image-20210806170159857.png" srcset="/img/loading.gif" lazyload alt="image-20210806170159857"></p>
<ol>
<li><p>客户端请求第三方授权</p>
<p>用户进入黑马程序员的登录页面，点击微信的图标以微信账号登录系统，用户是自己在微信里信息的资源拥有者。</p>
<p><img src="/images/image-20210806171203045.png" srcset="/img/loading.gif" lazyload alt="image-20210806171203045"></p>
<p>点击“用QQ账号登录”出现一个二维码，此时用户扫描二维码，开始给黑马程序员授权。</p>
<p><img src="/images/image-20210806171233254.png" srcset="/img/loading.gif" lazyload alt="image-20210806171233254"></p>
</li>
<li><p>资源拥有者同意给客户端授权</p>
<p>资源拥有者扫描二维码表示资源拥有者同意给客户端授权，微信会对资源拥有者的身份进行验证， 验证通过后，QQ会询问用户是否给授权黑马程序员访问自己的QQ数据，用户点击“确认登录”表示同意授权，QQ认证服务器会 颁发一个授权码，并重定向到黑马程序员的网站</p>
<p><img src="/images/image-20210806171257120.png" srcset="/img/loading.gif" lazyload alt="image-20210806171257120"></p>
</li>
<li><p>客户端获取到授权码，请求认证服务器申请令牌 此过程用户看不到，客户端应用程序请求认证服务器，请求携带授权码。</p>
</li>
<li><p>认证服务器向客户端响应令牌 认证服务器验证了客户端请求的授权码，如果合法则给客户端颁发令牌，令牌是客户端访问资源的通行证。 此交互过程用户看不到，当客户端拿到令牌后，用户在黑马程序员看到已经登录成功。</p>
</li>
<li><p>客户端请求资源服务器的资源 客户端携带令牌访问资源服务器的资源。 黑马程序员网站携带令牌请求访问微信服务器获取用户的基本信息。</p>
</li>
<li><p>资源服务器返回受保护资源 资源服务器校验令牌的合法性，如果合法则向用户响应资源信息内容。 注意：资源服务器和认证服务器可以是一个服务也可以分开的服务，如果是分开的服务, 资源服务器通常要请求认证服务器来校验令牌的合法性。</p>
</li>
</ol>
<p>Oauth2.0认证流程如下： 引自Oauth2.0协议rfc6749 <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a></p>
<p><img src="/images/image-20210806171345750.png" srcset="/img/loading.gif" lazyload alt="image-20210806171345750"></p>
<p>Oauth2包括以下角色：</p>
<ol>
<li>客户端本身不存储资源，需要通过资源拥有者的授权去请求资源服务器的资源，比如：畅购Android客户端、畅购Web客户端（浏览器端）、微信客户端等。</li>
<li>资源拥有者 通常为用户，也可以是应用程序，即该资源的拥有者。</li>
<li>授权服务器（也称认证服务器） 用来对资源拥有的身份进行认证、对访问资源进行授权。客户端要想访问资源需要通过认证服务器由资源拥有者授权后方可访问。</li>
<li>资源服务器 存储资源的服务器，比如，畅购用户管理服务器存储了畅购的用户信息，微信的资源服务存储了微信的用户信息等。客户端最终访问资源服务器获取资源信息。</li>
</ol>
<h4 id="2-2-2-Oauth2在项目的应用"><a href="#2-2-2-Oauth2在项目的应用" class="headerlink" title="2.2.2 Oauth2在项目的应用"></a>2.2.2 Oauth2在项目的应用</h4><p>Oauth2是一个标准的开放的授权协议，应用程序可以根据自己的要求去使用Oauth2，项目中使用Oauth2可以实现实现如下功能：</p>
<ol>
<li>本系统访问第三方系统的资源</li>
<li>外部系统访问本系统的资源</li>
<li>本系统前端（客户端） 访问本系统后端微服务的资源</li>
<li>本系统微服务之间访问资源，例如：微服务A访问微服务B的资源，B访问A的资源</li>
</ol>
<h3 id="2-3-Spring-security-Oauth2认证解决方案"><a href="#2-3-Spring-security-Oauth2认证解决方案" class="headerlink" title="2.3 Spring security + Oauth2认证解决方案"></a>2.3 Spring security + Oauth2认证解决方案</h3><p>本项目采用 Spring security + Oauth2+JWT完成用户认证及用户授权，Spring security 是一个强大的和高度可定制的身份验证和访问控制框架，Spring security 框架集成了Oauth2协议，下图是项目认证架构图：</p>
<p><img src="/images/image-20210806172024614.png" srcset="/img/loading.gif" lazyload alt="image-20210806172024614"></p>
<ol>
<li>用户请求认证服务完成认证</li>
<li>认证服务下发用户身份令牌，拥有身份令牌表示身份合法</li>
<li>用户携带令牌请求资源服务，请求资源服务必先经过网关</li>
<li>网关校验用户身份令牌的合法，不合法表示用户没有登录，如果合法则放行继续访问</li>
<li>资源服务获取令牌，根据令牌完成授权</li>
<li>资源服务完成授权则响应资源信息</li>
</ol>
<h2 id="3-Jwt令牌回顾"><a href="#3-Jwt令牌回顾" class="headerlink" title="3. Jwt令牌回顾"></a>3. Jwt令牌回顾</h2><p>JSON Web Token（JWT）是一个开放的行业标准（RFC 7519），它定义了一种简介的、自包含的协议格式，用于 在通信双方传递json对象，传递的信息经过数字签名可以被验证和信任。JWT可以使用HMAC算法或使用RSA的公 钥/私钥对来签名，防止被篡改。</p>
<p>官网：<a target="_blank" rel="noopener" href="https://jwt.io/">https://jwt.io/</a></p>
<p>标准：<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc7519">https://tools.ietf.org/html/rfc7519</a></p>
<p>JWT令牌的优点：</p>
<ol>
<li>jwt基于json，非常方便解析</li>
<li>可以在令牌中自定义丰富的内容，易扩展</li>
<li>通过非对称加密算法及数字签名技术，JWT防止篡改，安全性高</li>
<li>资源服务使用JWT可不依赖认证服务即可完成授权</li>
</ol>
<p>缺点：</p>
<ul>
<li>JWT令牌较长，占存储空间比较大</li>
</ul>
<h3 id="3-1-令牌结构"><a href="#3-1-令牌结构" class="headerlink" title="3.1 令牌结构"></a>3.1 令牌结构</h3><p>JWT令牌由三部分组成，每部分中间使用点（.）分隔，比如：xxxxx.yyyyy.zzzzz</p>
<p><strong>Header</strong></p>
<p>头部包括令牌的类型（即JWT）及使用的哈希算法（如HMAC SHA256或RSA）</p>
<p>一个例子如下：</p>
<p>下边是Header部分的内容</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>    <span class="hljs-attr">&quot;alg&quot;</span>: <span class="hljs-string">&quot;HS256&quot;</span>,<br>    <span class="hljs-attr">&quot;typ&quot;</span>: <span class="hljs-string">&quot;JWT&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>将上边的内容使用Base64Url编码，得到一个字符串就是JWT令牌的第一部分</p>
<p><strong>Payload</strong></p>
<p>第二部分是负载，内容也是一个json对象，它是存放有效信息的地方，它可以存放jwt提供的现成字段，比 如：iss（签发者）,exp（过期时间戳）, sub（面向的用户）等，也可自定义字段。</p>
<p>此部分不建议存放敏感信息，因为此部分可以解码还原原始内容。</p>
<p>最后将第二部分负载使用Base64Url编码，得到一个字符串就是JWT令牌的第二部分。</p>
<p>一个例子：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>    <span class="hljs-attr">&quot;sub&quot;</span>: <span class="hljs-string">&quot;1234567890&quot;</span>,<br>    <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;456&quot;</span>,<br>    <span class="hljs-attr">&quot;admin&quot;</span>: <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>Signature</strong></p>
<p>第三部分是签名，此部分用于防止jwt内容被篡改。</p>
<p>这个部分使用base64url将前两部分进行编码，编码后使用点（.）连接组成字符串，最后使用header中声明 签名算法进行签名。</p>
<p>一个例子：</p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-function"><span class="hljs-title">HMACSHA256</span>(</span><br><span class="hljs-function">    <span class="hljs-title">base64UrlEncode</span>(<span class="hljs-variable">header</span>) + <span class="hljs-string">&quot;.&quot;</span> +</span><br><span class="hljs-function">    <span class="hljs-title">base64UrlEncode</span>(<span class="hljs-variable">payload</span>) + <span class="hljs-string">&quot;.&quot;</span> +</span><br><span class="hljs-function">    <span class="hljs-variable">secret</span>)</span><br></code></pre></td></tr></table></figure>

<p>base64UrlEncode(header)：jwt令牌的第一部分。</p>
<p>base64UrlEncode(payload)：jwt令牌的第二部分。</p>
<p>secret：签名所使用的密钥。</p>
<h3 id="3-2-生成私钥公钥"><a href="#3-2-生成私钥公钥" class="headerlink" title="3.2 生成私钥公钥"></a>3.2 生成私钥公钥</h3><p>私钥加密，公钥解析</p>
<p>私钥作为签名用于生成令牌，用公钥来校验。相应的公钥只能校验相应的私钥</p>
<p>JWT令牌生成采用非对称加密算法</p>
<ol>
<li><p>生成密钥证书 下边命令生成密钥证书，采用RSA 算法每个证书包含公钥和私钥</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">keytool -genkeypair -<span class="hljs-built_in">alias</span> changgou -keyalg RSA -keypass changgou -keystore changgou.jks -storepass changgou <br></code></pre></td></tr></table></figure>

<p>Keytool 是一个java提供的证书管理工具</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs haml">-<span class="ruby"><span class="hljs-keyword">alias</span>：密钥的别名 </span><br><span class="ruby"></span>-<span class="ruby">keyalg：使用的hash算法 </span><br><span class="ruby"></span>-<span class="ruby">keypass：密钥的访问密码 </span><br><span class="ruby"></span>-<span class="ruby">keystore：密钥库文件名，changgou.jks保存了生成的证书 </span><br><span class="ruby"></span>-<span class="ruby">storepass：密钥库的访问密码 </span><br></code></pre></td></tr></table></figure>

<p>查询证书信息：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lsl">keytool -<span class="hljs-type">list</span> -keystore changgou.jks<br></code></pre></td></tr></table></figure></li>
<li><p>导出公钥</p>
<p>openssl是一个加解密工具包，这里使用openssl来导出公钥信息</p>
<p>安装 openssl：<a target="_blank" rel="noopener" href="http://slproweb.com/products/Win32OpenSSL.html">http://slproweb.com/products/Win32OpenSSL.html</a></p>
<p>安装资料目录下的Win64OpenSSL-1_1_1b.exe</p>
<p>配置openssl的path环境变量(有两种方式)</p>
<ol>
<li><p>方法一</p>
<p>先编辑一个系统变量</p>
<p><img src="/images/image-20210806194341094.png" srcset="/img/loading.gif" lazyload alt="image-20210806194341094"></p>
<p>再双击Path配置环境变量。看高亮代码</p>
<p><img src="/images/image-20210806194443619.png" srcset="/img/loading.gif" lazyload alt="image-20210806194443619"></p>
</li>
<li><p>方法二</p>
<p>直接在环境变量页面配置路径</p>
<p><img src="/images/image-20210806194546318.png" srcset="/img/loading.gif" lazyload alt="image-20210806194546318"></p>
</li>
</ol>
<p>cmd进入changgou.jks文件所在目录(这里就是jwt目录)执行如下命令：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">keytool -list -rfc --keystore changgou.jks <span class="hljs-string">| openssl x509 -inform pem -pubkey</span><br></code></pre></td></tr></table></figure>

<p>下面段内容是公钥</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">-----<span class="hljs-keyword">BEGIN</span> PUBLIC KEY-----<br>MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAjhE4fgF8oIaY5ERSiigWJJ2OK2icj7XU<span class="hljs-regexp">/lyB3CKdEcLcGw6bStTR9FdSJWSFvSbYl/</span>q0QlsWQvEHrPkvGEXWK5fQmdY71<span class="hljs-regexp">/QbGR+eoIQiE0U0QAowI1MLy+XwMvU8DfFyNPmMevq0OOW/</span><span class="hljs-number">4</span>+mqlPyvzCqV1N5VjpUsvcYoso5kHOpiWqf0aSTcTyY3FBgtv3phSA69VO4OgVq9+ma13TerauY<span class="hljs-regexp">/BbzQAIMOYP8Brla3I+8HVVxGgc2O5ij4+SkLISPNK5G1e00JvN5H5JiKaaBd3rFFd+NHvUv5TTrPjNOQX4uSo7bbhJGqglf60Wr5rYa0wzqbRkS7enW4qfdg3I/</span>YKQIDAQAB<br>-----<span class="hljs-keyword">END</span> PUBLIC KEY-----<br></code></pre></td></tr></table></figure>

<p>将上边的公钥拷贝到文本public.key文件中，合并为一行,可以将它放到需要实现授权认证的工程中。</p>
</li>
</ol>
<h3 id="3-3-基于私钥生成jwt令牌（小案例）"><a href="#3-3-基于私钥生成jwt令牌（小案例）" class="headerlink" title="3.3 基于私钥生成jwt令牌（小案例）"></a>3.3 基于私钥生成jwt令牌（小案例）</h3><h4 id="3-3-1导入认证服务"><a href="#3-3-1导入认证服务" class="headerlink" title="3.3.1导入认证服务"></a>3.3.1导入认证服务</h4><ol>
<li><p>将课件中<code>changgou_user_auth</code>的工程导入到项目中去，如果导入后包名，pom文件显示格式不对，可以按照如下操作</p>
<p>点击加号</p>
<p><img src="/images/image-20210806201611292.png" srcset="/img/loading.gif" lazyload alt="image-20210806201611292"></p>
<p>点击pom文件</p>
<p><img src="/images/image-20210806201718682.png" srcset="/img/loading.gif" lazyload alt="image-20210806201718682"></p>
<p>最后点击ok，如果是个正常包这里点不了。</p>
<p><img src="/images/image-20210806201758851.png" srcset="/img/loading.gif" lazyload alt="image-20210806201758851"></p>
</li>
<li><p>认证服务中创建测试类CreateJwtTest</p>
<p>注意：</p>
<ul>
<li><p>将需要用到的文件放到resources下</p>
<p><img src="/images/image-20210806202207124.png" srcset="/img/loading.gif" lazyload alt="image-20210806202207124"></p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.changgou.oauth;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.springframework.core.io.ClassPathResource;<br><span class="hljs-keyword">import</span> org.springframework.security.jwt.Jwt;<br><span class="hljs-keyword">import</span> org.springframework.security.jwt.JwtHelper;<br><span class="hljs-keyword">import</span> org.springframework.security.jwt.crypto.sign.RsaSigner;<br><span class="hljs-keyword">import</span> org.springframework.security.rsa.crypto.KeyStoreKeyFactory;<br><br><span class="hljs-keyword">import</span> java.security.KeyPair;<br><span class="hljs-keyword">import</span> java.security.interfaces.RSAPrivateKey;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CreateJwtTest</span> </span>&#123;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">createJWT</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-comment">//基于私钥生成jwt</span><br>        <span class="hljs-comment">//1. 创建一个秘钥工厂</span><br>        <span class="hljs-comment">//1: 指定私钥的位置  </span><br>        ClassPathResource classPathResource = <span class="hljs-keyword">new</span> ClassPathResource(<span class="hljs-string">&quot;changgou.jks&quot;</span>);<br>        <span class="hljs-comment">//2: 指定秘钥库的密码</span><br>        String keyPass = <span class="hljs-string">&quot;changgou&quot;</span>;<br>        KeyStoreKeyFactory keyStoreKeyFactory = <span class="hljs-keyword">new</span> KeyStoreKeyFactory(classPathResource,keyPass.toCharArray());<br><br>        <span class="hljs-comment">//2. 基于工厂获取私钥</span><br>        String alias = <span class="hljs-string">&quot;changgou&quot;</span>;<br>        String password = <span class="hljs-string">&quot;changgou&quot;</span>;<br>        KeyPair keyPair = keyStoreKeyFactory.getKeyPair(alias, password.toCharArray());<br>        <span class="hljs-comment">//将当前的私钥转换为rsa私钥</span><br>        RSAPrivateKey rsaPrivateKey = (RSAPrivateKey) keyPair.getPrivate();<br><br>        <span class="hljs-comment">//3.生成jwt</span><br>        Map&lt;String,String&gt; map = <span class="hljs-keyword">new</span> HashMap();<br>        map.put(<span class="hljs-string">&quot;company&quot;</span>,<span class="hljs-string">&quot;heima&quot;</span>);<br>        map.put(<span class="hljs-string">&quot;address&quot;</span>,<span class="hljs-string">&quot;beijing&quot;</span>);<br><br>        Jwt jwt = JwtHelper.encode(JSON.toJSONString(map), <span class="hljs-keyword">new</span> RsaSigner(rsaPrivateKey));<br>        String jwtEncoded = jwt.getEncoded();<br>        System.out.println(jwtEncoded);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>基于公钥解析jwt令牌</p>
<p>上面创建令牌后，我们可以对JWT令牌进行解析，这里解析需要用到公钥，我们可以将之前生成的公钥public.key拷贝出来用字符串变量token存储，然后通过公钥解密。</p>
<p>在changgou-user-oauth创建测试类com.changgou.token.ParseJwtTest实现解析校验令牌数据，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.springframework.security.jwt.Jwt;<br><span class="hljs-keyword">import</span> org.springframework.security.jwt.JwtHelper;<br><span class="hljs-keyword">import</span> org.springframework.security.jwt.crypto.sign.RsaVerifier;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ParseJwtTest</span> </span>&#123;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">parseJwt</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-comment">//基于公钥去解析jwt</span><br>        String jwt =<span class="hljs-string">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhZGRyZXNzIjoiYmVpamluZyIsImNvbXBhbnkiOiJoZWltYSJ9.cjZNz8G0m4noNYN2VM1SH3ujAtbHElW5Vtbadb0NDI0cjM1DaAXzMA53Qbj4pmVQPl_IfSKqUEXbLxowdRa5NHR43laFsR0kzGbJiTINfSVSroSslYpDdEVwCeAF_a7I-R819YTj4p6sjuYKXbzXpeZQErczFbWWWGR2_U44xH6u1ejRNv8PikFiuzNw-muL7zUJkvqeSJzbEMnQdZMbfvZp4LtSI6B4G_PqpdNXkv19-juxAh99VgJInH_ItF0y5IBOxofA7gRebCZmU8L57gO9ohf2L00D95kis_Ji8lmA1ptLIfXqO_qLVvLBUNH-VtgjGAF0-0pyB-5jlbHP7w&quot;</span>;<br><br>        String publicKey =<span class="hljs-string">&quot;-----BEGIN PUBLIC KEY-----MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAvFsEiaLvij9C1Mz+oyAmt47whAaRkRu/8kePM+X8760UGU0RMwGti6Z9y3LQ0RvK6I0brXmbGB/RsN38PVnhcP8ZfxGUH26kX0RK+tlrxcrG+HkPYOH4XPAL8Q1lu1n9x3tLcIPxq8ZZtuIyKYEmoLKyMsvTviG5flTpDprT25unWgE4md1kthRWXOnfWHATVY7Y/r4obiOL1mS5bEa/iNKotQNnvIAKtjBM4RlIDWMa6dmz+lHtLtqDD2LF1qwoiSIHI75LQZ/CNYaHCfZSxtOydpNKq8eb1/PGiLNolD4La2zf0/1dlcr5mkesV570NxRmU1tFm8Zd3MZlZmyv9QIDAQAB-----END PUBLIC KEY-----&quot;</span>;<br><br>        Jwt token = JwtHelper.decodeAndVerify(jwt, <span class="hljs-keyword">new</span> RsaVerifier(publicKey));<br><br>        String claims = token.getClaims();<br>        System.out.println(claims);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>执行结果为：（就是创建令牌时放入的数据）</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;address&quot;</span>:<span class="hljs-string">&quot;beijing&quot;</span>,<span class="hljs-attr">&quot;company&quot;</span>:<span class="hljs-string">&quot;heima&quot;</span>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h2 id="4-Oauth2-0入门"><a href="#4-Oauth2-0入门" class="headerlink" title="4. Oauth2.0入门"></a>4. Oauth2.0入门</h2><h3 id="4-1-准备工作"><a href="#4-1-准备工作" class="headerlink" title="4.1 准备工作"></a>4.1 准备工作</h3><p>这里都准备好了，主要看下表结构就可以了</p>
<ol>
<li><p>搭建认证服务器之前，先在用户系统表结构中增加如下表结构：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `oauth_client_details` (<br>  `client_id` <span class="hljs-type">varchar</span>(<span class="hljs-number">48</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;客户端ID，主要用于标识对应的应用&#x27;</span>,<br>  `resource_ids` <span class="hljs-type">varchar</span>(<span class="hljs-number">256</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `client_secret` <span class="hljs-type">varchar</span>(<span class="hljs-number">256</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;客户端秘钥，BCryptPasswordEncoder加密&#x27;</span>,<br>  `<span class="hljs-keyword">scope</span>` <span class="hljs-type">varchar</span>(<span class="hljs-number">256</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;对应的范围&#x27;</span>,<br>  `authorized_grant_types` <span class="hljs-type">varchar</span>(<span class="hljs-number">256</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;认证模式&#x27;</span>,<br>  `web_server_redirect_uri` <span class="hljs-type">varchar</span>(<span class="hljs-number">256</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;认证后重定向地址&#x27;</span>,<br>  `authorities` <span class="hljs-type">varchar</span>(<span class="hljs-number">256</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `access_token_validity` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;令牌有效期&#x27;</span>,<br>  `refresh_token_validity` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;令牌刷新周期&#x27;</span>,<br>  `additional_information` <span class="hljs-type">varchar</span>(<span class="hljs-number">4096</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `autoapprove` <span class="hljs-type">varchar</span>(<span class="hljs-number">256</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`client_id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;<br></code></pre></td></tr></table></figure></li>
<li><p>导入1条初始化数据,其中加密字符明文为changgou：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `oauth_client_details` <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;changgou&#x27;</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">&#x27;$2a$10$Yvkp3xzDcri6MAsPIqnzzeGBHez1QZR3A079XDdmNU4R725KrkXi2&#x27;</span>, <span class="hljs-string">&#x27;app&#x27;</span>, <span class="hljs-string">&#x27;authorization_code,password,refresh_token,client_credentials&#x27;</span>, <span class="hljs-string">&#x27;http://localhost&#x27;</span>, <span class="hljs-keyword">null</span>, <span class="hljs-string">&#x27;43200&#x27;</span>, <span class="hljs-string">&#x27;43200&#x27;</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>);<br></code></pre></td></tr></table></figure></li>
</ol>
<h3 id="4-2-Oauth2授权模式介绍"><a href="#4-2-Oauth2授权模式介绍" class="headerlink" title="4.2 Oauth2授权模式介绍"></a>4.2 Oauth2授权模式介绍</h3><p>Oauth2有以下授权模式：</p>
<ol>
<li>授权码模式（Authorization Code）</li>
<li>隐式授权模式（Implicit）</li>
<li>密码模式（Resource Owner Password Credentials） </li>
<li>客户端模式（Client Credentials）</li>
</ol>
<p>其中授权码模式和密码模式应用较多，本小节介绍授权码模式。</p>
<h4 id="4-2-1-授权码模式"><a href="#4-2-1-授权码模式" class="headerlink" title="4.2.1 授权码模式"></a>4.2.1 授权码模式</h4><ol>
<li><p><strong>授权码授权流程</strong></p>
<ol>
<li>客户端（这个客户端不是用户，是客户端服务器）请求第三方授权</li>
<li>用户同意给客户端授权</li>
<li>客户端获取到授权码，请求认证服务器申请令牌</li>
<li>认证服务器向客户端响应令牌</li>
<li>客户端请求资源服务器的资源，资源服务校验令牌合法性，完成授权</li>
<li>资源服务器返回受保护资源</li>
</ol>
</li>
<li><p><strong>申请授权码</strong></p>
<p>请求认证服务获取授权码：</p>
<p>注意：</p>
<ul>
<li><p>9200是项目中设置好的用户认证微服务的端口号</p>
</li>
<li><p><code>/oauth/authorize</code>是oauth2.0内部已经规定好的获得授权码的路径</p>
</li>
<li><p><code>client_id=changgou</code>是服务器数据库中表的字段和对应的属性</p>
<p><img src="/images/image-20210806223116209.png" srcset="/img/loading.gif" lazyload alt="image-20210806223116209"></p>
</li>
<li><p><code>response_type=code</code>表明用的是oauth2.0的授权码模式</p>
</li>
<li><p><code>scop=app</code>也是表中的字段和属性</p>
<p><img src="/images/image-20210806223447185.png" srcset="/img/loading.gif" lazyload alt="image-20210806223447185"></p>
</li>
<li><p><code>redirect_uri</code>：跳转uri，当授权码申请成功后会跳转到此地址，并在后边带上code参数（授权码）</p>
</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">Get请求：<br>http:<span class="hljs-regexp">//</span>localhost:<span class="hljs-number">9200</span><span class="hljs-regexp">/oauth/</span>authorize?client_id=changgou&amp;response_type=code&amp;scop=app&amp;redirect_uri=http:<span class="hljs-regexp">//</span>localhost<br></code></pre></td></tr></table></figure>

<p>在浏览器输入上面的请求，发现跳转到了登陆页面</p>
<p><img src="/images/image-20210806223824348.png" srcset="/img/loading.gif" lazyload alt="image-20210806223824348"></p>
<p>输入账号和密码，点击Login。 Spring Security接收到请求会调用UserDetailsService接口（这个接口它内部自己写好了，不用编写）的loadUserByUsername方法查询用户正确的密码。 当前导入的基础工程中客户端ID为changgou，秘钥也为changgou（这个客户端ID还有密钥的加密字符在最开始被插入数据库了，所以这里能够登录成功）即可认证通过。</p>
<p>接下来进入授权页面：</p>
<p><img src="/images/image-20210806224201321.png" srcset="/img/loading.gif" lazyload alt="image-20210806224201321"></p>
<p>点击Authorize,接下来返回授权码： 认证服务携带授权码跳转redirect_uri,code=OicI5N就是返回的授权码, <strong>每一个授权码只能使用一次</strong></p>
<p><img src="/images/image-20210806224319499.png" srcset="/img/loading.gif" lazyload alt="image-20210806224319499"></p>
</li>
<li><p><strong>申请令牌</strong></p>
<p>拿到授权码后，申请令牌</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">Post请求：<br>http:<span class="hljs-regexp">//</span>localhost:<span class="hljs-number">9200</span><span class="hljs-regexp">/oauth/</span>token<br></code></pre></td></tr></table></figure>

<p>此链接需要使用 http Basic认证(下图Basic Auth就是这个认证)</p>
<p>以上测试使用postman完成：</p>
<p><img src="/images/image-20210806225752649.png" srcset="/img/loading.gif" lazyload alt="image-20210806225752649"></p>
<p><img src="/images/image-20210806225820728.png" srcset="/img/loading.gif" lazyload alt="image-20210806225820728"></p>
<p>客户端Id和客户端密码会匹配数据库oauth_client_details表中的客户端id及客户端密码。</p>
<p>点击发送： 申请令牌成功</p>
<p><img src="/images/image-20210806230037261.png" srcset="/img/loading.gif" lazyload alt="image-20210806230037261"></p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stata">access_token：访问令牌，携带此令牌访问资源 <br>token_type：有<span class="hljs-keyword">MAC</span> <span class="hljs-keyword">Token</span>与Bearer <span class="hljs-keyword">Token</span>两种类型，两种的校验算法不同，RFC 6750建议Oauth2采用 Bearer <span class="hljs-keyword">Token</span>（http:<span class="hljs-comment">//www.rfcreader.com/#rfc6750）。 </span><br>refresh_token：刷新令牌，使用此令牌可以延长访问令牌的过期时间。 <br>expires_in：过期时间，单位为秒。 <br>scope：范围，与定义的客户端范围一致。    <br>jti：当前<span class="hljs-keyword">token</span>的唯一标识<br></code></pre></td></tr></table></figure>

<p>关于access_token和jti的关系，需要多强调一点：</p>
<ul>
<li><p>jti与access_token成对出现，一 一对应。他俩是一个键值对。jti作为键存储在cookie中，access_token作为值存储在redis中（因为cookei存放的数据长度有限，不然不需要下面的</p>
<p>redis）</p>
</li>
</ul>
</li>
<li><p><strong>令牌校验</strong>  </p>
<p>Spring Security Oauth2提供校验令牌的端点，如下：</p>
<p>Get: <a target="_blank" rel="noopener" href="http://localhost:9200/oauth/check_token?token=">http://localhost:9200/oauth/check_token?token=</a> [access_token]</p>
<p>（这里的[access_token]就是刚刚获得的令牌）</p>
<p>使用postman测试如下:</p>
<p><img src="/images/image-20210806231247708.png" srcset="/img/loading.gif" lazyload alt="image-20210806231247708"></p>
<p>此时说明校验成功</p>
</li>
<li><p><strong>刷新令牌</strong></p>
<p>刷新令牌是当令牌快过期时重新生成一个令牌，它与授权码授权和密码授权生成令牌不同，刷新令牌不需要授权码 也不需要账号和密码，只需要一个刷新令牌、客户端id和客户端密码。</p>
<p>测试如下： Post：<a target="_blank" rel="noopener" href="http://localhost:9200/oauth/token">http://localhost:9200/oauth/token</a></p>
<p>参数：</p>
<ul>
<li><p>grant_type： 固定为 refresh_token</p>
</li>
<li><p>refresh_token：刷新令牌（注意不是access_token，而是refresh_token）</p>
<p><img src="/images/image-20210806231738266.png" srcset="/img/loading.gif" lazyload alt="image-20210806231738266"></p>
</li>
</ul>
</li>
</ol>
<h4 id="4-2-2-密码模式"><a href="#4-2-2-密码模式" class="headerlink" title="4.2.2 密码模式"></a>4.2.2 密码模式</h4><p>密码模式（Resource Owner Password Credentials）与授权码模式的区别是申请令牌不再使用授权码，而是直接 通过用户名和密码即可申请令牌。</p>
<ol>
<li><p><strong>申请令牌</strong></p>
<p>测试如下</p>
<p>注意：</p>
<ul>
<li>这里的用户名和密码就是真正的用户的账号和密码，和前面客户端的不是一个概念。</li>
<li>这里的用户名和密码需要去<code>tb_user</code>表中找，但是这里代码还没有完成，都用的<code>itheima</code>做密码</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk">Post请求：<br>http:<span class="hljs-regexp">//</span>localhost:<span class="hljs-number">9200</span><span class="hljs-regexp">/oauth/</span>token<br><br>携带参数： <br>grant_type：密码模式授权填写password <br>username：账号  <br>password：密码<br></code></pre></td></tr></table></figure>

<p>此链接也需要使用 http Basic认证</p>
<p><img src="/images/image-20210806233653549.png" srcset="/img/loading.gif" lazyload alt="image-20210806233653549"></p>
<p>测试结果如下</p>
<p><img src="/images/image-20210806233733190.png" srcset="/img/loading.gif" lazyload alt="image-20210806233733190"></p>
</li>
</ol>
<h3 id="4-3-资源服务授权"><a href="#4-3-资源服务授权" class="headerlink" title="4.3 资源服务授权"></a>4.3 资源服务授权</h3><p>资源服务拥有要访问的受保护资源，客户端携带令牌访问资源服务，如果令牌合法则可成功访问资源服务中的资源，如下图:</p>
<p><img src="/images/image-20210806234229211.png" srcset="/img/loading.gif" lazyload alt="image-20210806234229211"></p>
<p>上图的业务流程如下:</p>
<ol>
<li>客户端请求认证服务申请令牌</li>
<li>认证服务生成令牌认证服务采用非对称加密算法，使用私钥生成令牌</li>
<li>客户端携带令牌访问资源服务客户端在Http header 中添加： Authorization：Bearer令牌</li>
<li>资源服务请求认证服务校验令牌的有效性资源服务接收到令牌，使用公钥校验令牌的合法性</li>
<li>令牌有效，资源服务向客户端响应资源信息</li>
</ol>
<h4 id="4-3-1-用户服务对接Oauth2"><a href="#4-3-1-用户服务对接Oauth2" class="headerlink" title="4.3.1 用户服务对接Oauth2"></a>4.3.1 用户服务对接Oauth2</h4><ol>
<li><p>配置公钥 ，将 changggou_user_auth 项目中public.key复制到changgou_service_user中</p>
<p><img src="/images/image-20210806234937362.png" srcset="/img/loading.gif" lazyload alt="image-20210806234937362"></p>
</li>
<li><p>添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li>
<li><p>配置每个系统的Http请求路径安全控制策略以及读取公钥信息识别令牌，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableResourceServer</span> <span class="hljs-comment">//声明当前的服务是一个资源服务器</span><br><span class="hljs-meta">@EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)</span><span class="hljs-comment">//激活方法上的PreAuthorize注解</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ResourceServerConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ResourceServerConfigurerAdapter</span> </span>&#123;<br><br>    <span class="hljs-comment">//公钥</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PUBLIC_KEY = <span class="hljs-string">&quot;public.key&quot;</span>;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 定义JwtTokenStore</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> jwtAccessTokenConverter</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> TokenStore <span class="hljs-title">tokenStore</span><span class="hljs-params">(JwtAccessTokenConverter jwtAccessTokenConverter)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> JwtTokenStore(jwtAccessTokenConverter);<br>    &#125;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 定义JJwtAccessTokenConverter</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> JwtAccessTokenConverter <span class="hljs-title">jwtAccessTokenConverter</span><span class="hljs-params">()</span> </span>&#123;<br>        JwtAccessTokenConverter converter = <span class="hljs-keyword">new</span> JwtAccessTokenConverter();<br>        converter.setVerifierKey(getPubKey());<br>        <span class="hljs-keyword">return</span> converter;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取非对称加密公钥 Key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 公钥 Key</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getPubKey</span><span class="hljs-params">()</span> </span>&#123;<br>        Resource resource = <span class="hljs-keyword">new</span> ClassPathResource(PUBLIC_KEY);<br>        <span class="hljs-keyword">try</span> &#123;<br>            InputStreamReader inputStreamReader = <span class="hljs-keyword">new</span> InputStreamReader(resource.getInputStream());<br>            BufferedReader br = <span class="hljs-keyword">new</span> BufferedReader(inputStreamReader);<br>            <span class="hljs-keyword">return</span> br.lines().collect(Collectors.joining(<span class="hljs-string">&quot;\n&quot;</span>));<br>        &#125; <span class="hljs-keyword">catch</span> (IOException ioe) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * Http安全配置，对每个到达系统的http请求链接进行校验</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> http</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-comment">//所有请求必须认证通过</span><br>        http.authorizeRequests()<br>                <span class="hljs-comment">//下边的路径放行</span><br>                .antMatchers(<br>                        <span class="hljs-string">&quot;/user/add&quot;</span>,<span class="hljs-string">&quot;/user/load/**&quot;</span>). <span class="hljs-comment">//配置地址放行</span><br>                permitAll()<br>                .anyRequest().<br>                authenticated();    <span class="hljs-comment">//其他地址需要认证授权</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>资源服务授权测试</p>
<p>不携带令牌访问<a target="_blank" rel="noopener" href="http://localhost:9005/user">http://localhost:9005/user</a></p>
<p>由于该地址受访问限制，需要授权，所以出现如下错误：</p>
<p><img src="/images/image-20210807000317476.png" srcset="/img/loading.gif" lazyload alt="image-20210807000317476"></p>
<p>携带令牌访问<a target="_blank" rel="noopener" href="http://localhost:9005/user">http://localhost:9005/user</a></p>
<p>在http header中添加 Authorization： Bearer 令牌</p>
<p>注意：</p>
<ul>
<li>Bearer 令牌之间有空格</li>
<li>令牌是前面生成的还没过期，所以这里可以直接用</li>
</ul>
<p><img src="/images/image-20210807000526789.png" srcset="/img/loading.gif" lazyload alt="image-20210807000526789"></p>
<p><img src="/images/image-20210807000550001.png" srcset="/img/loading.gif" lazyload alt="image-20210807000550001"></p>
</li>
</ol>
<h2 id="5-认证开发"><a href="#5-认证开发" class="headerlink" title="5 认证开发"></a>5 认证开发</h2><h3 id="5-1-需求分析"><a href="#5-1-需求分析" class="headerlink" title="5.1 需求分析"></a>5.1 需求分析</h3><p><img src="/images/image-20210807125506369.png" srcset="/img/loading.gif" lazyload alt="image-20210807125506369"></p>
<p>执行流程：</p>
<ol>
<li>用户登录，请求认证服务</li>
<li>认证服务认证通过，生成jwt令牌，将jwt令牌及相关信息写入Redis，并且将身份令牌写入cookie </li>
<li>用户访问资源页面，带着cookie到网关 </li>
<li>网关从cookie获取token，并查询Redis校验token,如果token不存在则拒绝访问，否则放行</li>
<li>用户退出，请求认证服务，清除redis中的token，并且删除cookie中的token </li>
</ol>
<p>使用redis存储用户的身份令牌有以下作用：</p>
<ol>
<li>实现用户退出注销功能，服务端清除令牌后，即使客户端请求携带token也是无效的</li>
<li>由于jwt令牌过长，不宜存储在cookie中，所以将jwt令牌存储在redis，由客户端请求服务端获取并在客户端存储 </li>
</ol>
<h3 id="5-2-Redis配置"><a href="#5-2-Redis配置" class="headerlink" title="5.2 Redis配置"></a>5.2 Redis配置</h3><p>增加认证服务changgou_user_auth中application.yml配置文件中的Redis配置</p>
<h3 id="5-3-认证服务"><a href="#5-3-认证服务" class="headerlink" title="5.3 认证服务"></a>5.3 认证服务</h3><h4 id="5-3-1-认证服务需求分析"><a href="#5-3-1-认证服务需求分析" class="headerlink" title="5.3.1 认证服务需求分析"></a>5.3.1 认证服务需求分析</h4><p>认证服务需要实现的功能如下：</p>
<ol>
<li><p>登录接口</p>
<p>前端post提交账号、密码等，用户身份校验通过，生成令牌，并将令牌存储到redis。 将令牌写入cookie。</p>
</li>
<li><p>退出接口 </p>
<p>校验当前用户的身份为合法并且为已登录状态。 将令牌从redis删除。 删除cookie中的令牌。</p>
<p><img src="/images/image-20210807132848712.png" srcset="/img/loading.gif" lazyload alt="image-20210807132848712"></p>
</li>
</ol>
<h4 id="5-3-2-授权参数配置"><a href="#5-3-2-授权参数配置" class="headerlink" title="5.3.2 授权参数配置"></a>5.3.2 授权参数配置</h4><p>修改changgou_user_auth中application.yml配置文件，修改对应的授权配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">auth:</span><br>  <span class="hljs-attr">ttl:</span> <span class="hljs-number">1200</span>  <span class="hljs-comment">#token存储到redis的过期时间</span><br>  <span class="hljs-attr">clientId:</span> <span class="hljs-string">changgou</span>    <span class="hljs-comment">#客户端ID</span><br>  <span class="hljs-attr">clientSecret:</span> <span class="hljs-string">changgou</span>    <span class="hljs-comment">#客户端秘钥</span><br>  <span class="hljs-attr">cookieDomain:</span> <span class="hljs-string">localhost</span>   <span class="hljs-comment">#Cookie保存对应的域名</span><br>  <span class="hljs-attr">cookieMaxAge:</span> <span class="hljs-number">-1</span>          <span class="hljs-comment">#Cookie过期时间，-1表示浏览器关闭则销毁</span><br></code></pre></td></tr></table></figure>

<h4 id="5-3-3-申请令牌测试"><a href="#5-3-3-申请令牌测试" class="headerlink" title="5.3.3 申请令牌测试"></a>5.3.3 申请令牌测试</h4><p>这里和正常的业务代码无关，这里只是测试申请令牌有没有错</p>
<p>为了不破坏Spring Security的代码，我们在Service方法中通过RestTemplate请求Spring Security所暴露的申请令牌接口来申请令牌，下边是测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApplyTokenTest</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span>  <span class="hljs-comment">//这个bean需要自己声明，已经声明在启动类中了</span><br>    <span class="hljs-keyword">private</span> RestTemplate restTemplate;<br><br>    <span class="hljs-meta">@Autowired</span>  <span class="hljs-comment">//通过它可以在注册中心获取地址信息</span><br>    <span class="hljs-keyword">private</span> LoadBalancerClient loadBalancerClient;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">applyToken</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-comment">//构建请求地址  http://localhost:9200/oauth/token</span><br>        <span class="hljs-comment">//user-auth是这个微服务在注册中心的名字。返回的是这个服务的实例对象</span><br>        ServiceInstance serviceInstance = loadBalancerClient.choose(<span class="hljs-string">&quot;user-auth&quot;</span>);<br>        <span class="hljs-comment">// 通过这个实例对象，就可以获得他的路径信息  http://localhost:9200</span><br>        URI uri = serviceInstance.getUri();<br>        <span class="hljs-comment">// http://localhost:9200/oauth/token</span><br>        String url =uri+<span class="hljs-string">&quot;/oauth/token&quot;</span>;<br><br>        <span class="hljs-comment">// 封装请求参数 body , headers。这里的用户名和密码写死了，实际开发中不是这样</span><br>        MultiValueMap&lt;String, String&gt; body = <span class="hljs-keyword">new</span> LinkedMultiValueMap&lt;&gt;();<br>        body.add(<span class="hljs-string">&quot;grant_type&quot;</span>,<span class="hljs-string">&quot;password&quot;</span>);<br>        body.add(<span class="hljs-string">&quot;username&quot;</span>,<span class="hljs-string">&quot;itheima&quot;</span>);<br>        body.add(<span class="hljs-string">&quot;password&quot;</span>,<span class="hljs-string">&quot;itheima&quot;</span>);<br><br>        MultiValueMap&lt;String, String&gt; headers = <span class="hljs-keyword">new</span> LinkedMultiValueMap&lt;&gt;();<br>        headers.add(<span class="hljs-string">&quot;Authorization&quot;</span>,<span class="hljs-keyword">this</span>.getHttpBasic(<span class="hljs-string">&quot;changgou&quot;</span>,<span class="hljs-string">&quot;changgou&quot;</span>));<br>        HttpEntity&lt;MultiValueMap&lt;String,String&gt;&gt; requestEntity = <span class="hljs-keyword">new</span> HttpEntity&lt;&gt;(body,headers);    <span class="hljs-comment">//body, header就是封装在这个里面的</span><br><br>        <span class="hljs-comment">//当后端出现了401,400.后端不对着两个异常编码进行处理,而是直接返回给前端</span><br>        restTemplate.setErrorHandler(<span class="hljs-keyword">new</span> DefaultResponseErrorHandler()&#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleError</span><span class="hljs-params">(ClientHttpResponse response)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>                <span class="hljs-keyword">if</span> (response.getRawStatusCode()!=<span class="hljs-number">400</span> &amp;&amp; response.getRawStatusCode() != <span class="hljs-number">401</span>)&#123;<br>                    <span class="hljs-keyword">super</span>.handleError(response);<br>                &#125;<br>            &#125;<br>        &#125;);<br><br>        <span class="hljs-comment">//发送请求</span><br>        ResponseEntity&lt;Map&gt; responseEntity = restTemplate.exchange(url, HttpMethod.POST, requestEntity, Map.class);<br>        Map map = responseEntity.getBody();<br>        System.out.println(map);<br><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getHttpBasic</span><span class="hljs-params">(String clientId, String clientSecret)</span> </span>&#123;<br>        String value =clientId+<span class="hljs-string">&quot;:&quot;</span>+clientSecret;<br>        <span class="hljs-keyword">byte</span>[] encode = Base64Utils.encode(value.getBytes());<br>        <span class="hljs-comment">//Basic Y2hhbmdnb3U6Y2hhbmdnb3U=</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Basic &quot;</span>+<span class="hljs-keyword">new</span> String(encode);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="5-3-4-业务层"><a href="#5-3-4-业务层" class="headerlink" title="5.3.4 业务层"></a>5.3.4 业务层</h4><p>AuthService接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">AuthService</span> </span>&#123;<br>    <span class="hljs-function">AuthToken <span class="hljs-title">login</span><span class="hljs-params">(String username, String password, String clientId, String clientSecret)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>AuthServiceImpl实现类：</p>
<p>基于刚才写的测试实现申请令牌的service方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AuthService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RestTemplate restTemplate;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> LoadBalancerClient loadBalancerClient;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;auth.ttl&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> ttl;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> AuthToken <span class="hljs-title">login</span><span class="hljs-params">(String username, String password, String clientId, String clientSecret)</span> </span>&#123;<br>        <span class="hljs-comment">//1.申请令牌</span><br>        ServiceInstance serviceInstance = loadBalancerClient.choose(<span class="hljs-string">&quot;user-auth&quot;</span>);<br>        URI uri = serviceInstance.getUri();<br>        String url=uri+<span class="hljs-string">&quot;/oauth/token&quot;</span>;<br><br>        MultiValueMap&lt;String, String&gt; body = <span class="hljs-keyword">new</span> LinkedMultiValueMap&lt;&gt;();<br>        body.add(<span class="hljs-string">&quot;grant_type&quot;</span>,<span class="hljs-string">&quot;password&quot;</span>);<br>        body.add(<span class="hljs-string">&quot;username&quot;</span>,username);<br>        body.add(<span class="hljs-string">&quot;password&quot;</span>,password);<br><br>        MultiValueMap&lt;String, String&gt; headers = <span class="hljs-keyword">new</span> LinkedMultiValueMap&lt;&gt;();<br>        headers.add(<span class="hljs-string">&quot;Authorization&quot;</span>,<span class="hljs-keyword">this</span>.getHttpBasic(clientId,clientSecret));<br>        HttpEntity&lt;MultiValueMap&lt;String,String&gt;&gt; requestEntity = <span class="hljs-keyword">new</span> HttpEntity&lt;&gt;(body,headers);<br><br>        restTemplate.setErrorHandler(<span class="hljs-keyword">new</span> DefaultResponseErrorHandler()&#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleError</span><span class="hljs-params">(ClientHttpResponse response)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>                <span class="hljs-keyword">if</span> (response.getRawStatusCode()!=<span class="hljs-number">400</span> &amp;&amp; response.getRawStatusCode()!=<span class="hljs-number">401</span>)&#123;<br>                    <span class="hljs-keyword">super</span>.handleError(response);<br>                &#125;<br>            &#125;<br>        &#125;);<br><br>        ResponseEntity&lt;Map&gt; responseEntity = restTemplate.exchange(url, HttpMethod.POST, requestEntity, Map.class);<br>        Map map = responseEntity.getBody();<br>        <span class="hljs-keyword">if</span> (map == <span class="hljs-keyword">null</span> || map.get(<span class="hljs-string">&quot;access_token&quot;</span>) == <span class="hljs-keyword">null</span> || map.get(<span class="hljs-string">&quot;refresh_token&quot;</span>) == <span class="hljs-keyword">null</span> || map.get(<span class="hljs-string">&quot;jti&quot;</span>) == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-comment">//申请令牌失败</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;申请令牌失败&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">//2.封装结果数据</span><br>        AuthToken authToken = <span class="hljs-keyword">new</span> AuthToken();<br>        authToken.setAccessToken((String) map.get(<span class="hljs-string">&quot;access_token&quot;</span>));<br>        authToken.setRefreshToken((String) map.get(<span class="hljs-string">&quot;refresh_token&quot;</span>));<br>        authToken.setJti((String)map.get(<span class="hljs-string">&quot;jti&quot;</span>));<br><br>        <span class="hljs-comment">//3.将jti作为redis中的key,将jwt作为redis中的value进行数据的存放</span><br>        stringRedisTemplate.boundValueOps(authToken.getJti()).set(authToken.getAccessToken(),ttl, TimeUnit.SECONDS);<br>        <span class="hljs-keyword">return</span> authToken;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getHttpBasic</span><span class="hljs-params">(String clientId, String clientSecret)</span> </span>&#123;<br>        String value = clientId+<span class="hljs-string">&quot;:&quot;</span>+clientSecret;<br>        <span class="hljs-keyword">byte</span>[] encode = Base64Utils.encode(value.getBytes());<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Basic &quot;</span>+<span class="hljs-keyword">new</span> String(encode);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="5-3-5-控制层"><a href="#5-3-5-控制层" class="headerlink" title="5.3.5 控制层"></a>5.3.5 控制层</h4><p>AuthController编写用户登录授权方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/oauth&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> AuthService authService;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;auth.clientId&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String clientId;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;auth.clientSecret&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String clientSecret;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;auth.cookieDomain&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String cookieDomain;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;auth.cookieMaxAge&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> cookieMaxAge;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/login&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">login</span><span class="hljs-params">(String username, String password)</span></span>&#123;<br><br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(username))&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;用户名不存在&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(password))&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;密码不存在&quot;</span>);<br>        &#125;<br><br>        AuthToken authToken = authService.login(username,password,clientId,clientSecret);<br><br>        <span class="hljs-keyword">this</span>.saveJtiToCookie(authToken.getJti());<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>, StatusCode.OK,<span class="hljs-string">&quot;登录成功&quot;</span>);<br><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">saveJtiToCookie</span><span class="hljs-params">(String jti)</span> </span>&#123;<br>        HttpServletResponse response = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getResponse();<br>        CookieUtil.addCookie(response,cookieDomain,<span class="hljs-string">&quot;/&quot;</span>,<span class="hljs-string">&quot;uid&quot;</span>,jti,cookieMaxAge,<span class="hljs-keyword">false</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="5-3-6-登录请求放行"><a href="#5-3-6-登录请求放行" class="headerlink" title="5.3.6 登录请求放行"></a>5.3.6 登录请求放行</h4><p>修改认证服务WebSecurityConfig类中configure（），添加放行路径</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(WebSecurity web)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>    web.ignoring().antMatchers(<br>            <span class="hljs-string">&quot;/oauth/login&quot;</span>,<br>            <span class="hljs-string">&quot;/oauth/logout&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="5-3-7-测试认证接口"><a href="#5-3-7-测试认证接口" class="headerlink" title="5.3.7 测试认证接口"></a>5.3.7 测试认证接口</h4><p>使用postman测试：<a target="_blank" rel="noopener" href="http://localhost:9200/oauth/login">http://localhost:9200/oauth/login</a></p>
<p><img src="/images/image-20210807144203187.png" srcset="/img/loading.gif" lazyload alt="image-20210807144203187"></p>
<h4 id="5-3-8-动态获取用户信息"><a href="#5-3-8-动态获取用户信息" class="headerlink" title="5.3.8 动态获取用户信息"></a>5.3.8 动态获取用户信息</h4><p>当前在认证服务中，用户密码是写死在用户认证类中。所以用户登录时，无论帐号输入什么，只要密码是itheima都可以访问。 因此需要动态获取用户帐号与密码</p>
<ol>
<li><p>定义被访问接口</p>
<p>用户微服务changgou_service_user对外暴露根据用户名获取用户信息接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/load/&#123;username&#125;&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">findUserInfo</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;username&quot;)</span> String username)</span></span>&#123;<br>    <span class="hljs-keyword">return</span> userService.findById(username);<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>放行该接口，修改用户微服务下的ResourceServerConfig类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>    <span class="hljs-comment">//所有请求必须认证通过</span><br>    http.authorizeRequests()<br>            <span class="hljs-comment">//下边的路径放行</span><br>            .antMatchers(<br>                    <span class="hljs-string">&quot;/user/add&quot;</span>,<span class="hljs-string">&quot;/user/load/**&quot;</span>). <span class="hljs-comment">//配置地址放行</span><br>            permitAll()<br>            .anyRequest().<br>            authenticated();    <span class="hljs-comment">//其他地址需要认证授权</span><br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>定义feign接口</p>
<p>changgou_service_user_api新增feign接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name=&quot;user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserFeign</span> </span>&#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/user/load/&#123;username&#125;&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">findUserInfo</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;username&quot;)</span> String username)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>认证服务添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.changgou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>changgou_service_user_api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li>
<li><p>修改认证服务启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableFeignClients(basePackages = &quot;com.changgou.user.feign&quot;)</span><br></code></pre></td></tr></table></figure></li>
<li><p>修改用户认证类</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">/*****</span><br><span class="hljs-comment"> * 自定义授权认证类</span><br><span class="hljs-comment"> */</span><br>@Service<br>public <span class="hljs-keyword">class</span> UserDetailsServiceImpl implements UserDetailsService &#123;<br><br>    @Autowired<br>    ClientDetailsService clientDetailsService;<br><br>    @Autowired<br>    <span class="hljs-keyword">private</span> UserFeign userFeign;<br><br>    <span class="hljs-comment">/****</span><br><span class="hljs-comment">     * 自定义授权认证</span><br><span class="hljs-comment">     * @param username</span><br><span class="hljs-comment">     * @return</span><br><span class="hljs-comment">     * @throws UsernameNotFoundException</span><br><span class="hljs-comment">     */</span><br>    @Override<br>    public UserDetails load<span class="hljs-constructor">UserByUsername(String <span class="hljs-params">username</span>)</span> throws UsernameNotFoundException &#123;<br>        <span class="hljs-comment">//取出身份，如果身份为空说明没有认证</span><br>        Authentication authentication = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SecurityContextHolder</span>.</span></span>get<span class="hljs-constructor">Context()</span>.get<span class="hljs-constructor">Authentication()</span>;<br>        <span class="hljs-comment">//没有认证统一采用httpbasic认证，httpbasic中存储了client_id和client_secret，开始认证client_id和client_secret</span><br>        <span class="hljs-keyword">if</span>(authentication==null)&#123;<br>            ClientDetails clientDetails = clientDetailsService.load<span class="hljs-constructor">ClientByClientId(<span class="hljs-params">username</span>)</span>;<br>            <span class="hljs-keyword">if</span>(clientDetails!=null)&#123;<br>                <span class="hljs-comment">//秘钥</span><br>                String clientSecret = clientDetails.get<span class="hljs-constructor">ClientSecret()</span>;<br>                <span class="hljs-comment">//静态方式</span><br>                <span class="hljs-comment">//return new User(username,new BCryptPasswordEncoder().encode(clientSecret), AuthorityUtils.commaSeparatedStringToAuthorityList(&quot;&quot;));</span><br>                <span class="hljs-comment">//数据库查找方式</span><br>                return <span class="hljs-keyword">new</span> <span class="hljs-constructor">User(<span class="hljs-params">username</span>,<span class="hljs-params">clientSecret</span>, AuthorityUtils.<span class="hljs-params">commaSeparatedStringToAuthorityList</span>(<span class="hljs-string">&quot;&quot;</span>)</span>);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">StringUtils</span>.</span></span>is<span class="hljs-constructor">Empty(<span class="hljs-params">username</span>)</span>) &#123;<br>            return null;<br>        &#125;<br><br>        <span class="hljs-comment">//根据用户名查询用户信息</span><br><span class="hljs-comment">//        String pwd = new BCryptPasswordEncoder().encode(&quot;itheima&quot;);</span><br>        com.changgou.user.pojo.User userInfo = userFeign.find<span class="hljs-constructor">UserInfo(<span class="hljs-params">username</span>)</span>;<br>        <span class="hljs-comment">//创建User对象</span><br>        String permissions = <span class="hljs-string">&quot;goods_list,seckill_list&quot;</span>;<br>        UserJwt userDetails = <span class="hljs-keyword">new</span> <span class="hljs-constructor">UserJwt(<span class="hljs-params">username</span>,<span class="hljs-params">userInfo</span>.<span class="hljs-params">getPassword</span>()</span>,<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AuthorityUtils</span>.</span></span>comma<span class="hljs-constructor">SeparatedStringToAuthorityList(<span class="hljs-params">permissions</span>)</span>);<br>        return userDetails;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<p>测试：localhost:9200/oauth/login</p>
<p>这次输入真正的用户名和密码（这里我测试失败了，感觉是密码有问题）</p>
<h2 id="6-认证服务对接网关"><a href="#6-认证服务对接网关" class="headerlink" title="6 认证服务对接网关"></a>6 认证服务对接网关</h2><h3 id="6-1-新建网关工程changgou-gateway-web"><a href="#6-1-新建网关工程changgou-gateway-web" class="headerlink" title="6.1 新建网关工程changgou_gateway_web"></a>6.1 新建网关工程changgou_gateway_web</h3><ol>
<li><p>changgou_gateway(网关的父工程)的pom文件添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--网关依赖--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>   <br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--redis--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis-reactive<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.3.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure></li>
<li><p>新建工程changgou_gateway_web,并创建启动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableEurekaClient</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebGatewayApplication</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(WebGatewayApplication.class,args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>创建application.yml (网管这里的路径配置还不熟，有时间加强)</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">gateway-web</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">globalcors:</span><br>        <span class="hljs-attr">cors-configurations:</span><br>          <span class="hljs-string">&#x27;[/**]&#x27;</span><span class="hljs-string">:</span> <span class="hljs-comment"># 匹配所有请求</span><br>            <span class="hljs-attr">allowedOrigins:</span> <span class="hljs-string">&quot;*&quot;</span> <span class="hljs-comment">#跨域处理 允许所有的域</span><br>            <span class="hljs-attr">allowedMethods:</span> <span class="hljs-comment"># 支持的方法</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">GET</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">POST</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">PUT</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">DELETE</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">changgou_goods_route</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://goods</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/album/**,/api/brand/**,/api/cache/**,/api/categoryBrand/**,/api/category/**,/api/para/**,/api/pref/**,/api/sku/**,/api/spec/**,/api/spu/**,/api/stockBack/**,/api/template/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-comment">#- PrefixPath=/brand</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br>          <span class="hljs-comment">#用户微服务</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">changgou_user_route</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://user</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/user/**,/api/address/**,/api/areas/**,/api/cities/**,/api/provinces/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br>          <span class="hljs-comment">#认证微服务</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">changgou_oauth_user</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://user-auth</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/oauth/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.128</span><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8001</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:6868/eureka</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">management:</span><br>  <span class="hljs-attr">endpoint:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">web:</span><br>      <span class="hljs-attr">exposure:</span><br>        <span class="hljs-attr">include:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure></li>
</ol>
<h3 id="6-2-网关全局过滤器"><a href="#6-2-网关全局过滤器" class="headerlink" title="6.2 网关全局过滤器"></a>6.2 网关全局过滤器</h3><p><img src="/images/image-20210807164927008.png" srcset="/img/loading.gif" lazyload alt="image-20210807164927008"></p>
<p>新建过滤器类AuthorizeFilter,对请求进行过滤</p>
<p>业务逻辑：</p>
<ol>
<li>判断当前请求是否为登录请求，是的话，则放行</li>
<li>判断cookie中是否存在信息, 没有的话，拒绝访问</li>
<li>判断redis中令牌是否存在，没有的话，拒绝访问</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">GlobalFilter</span>, <span class="hljs-title">Ordered</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> AuthService authService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;<br>        ServerHttpRequest request = exchange.getRequest();<br>        ServerHttpResponse response = exchange.getResponse();<br><br>        <span class="hljs-comment">//1.判断当前请求路径是否为登录请求,如果是,则直接放行</span><br>        String path = request.getURI().getPath();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;/api/oauth/login&quot;</span>.equals(path) || !UrlFilter.hasAuthorize(path) )&#123;<br>            <span class="hljs-comment">//直接放行</span><br>            <span class="hljs-keyword">return</span> chain.filter(exchange);<br>        &#125;<br><br>        <span class="hljs-comment">//2.从cookie中获取jti的值,如果该值不存在,拒绝本次访问</span><br>        String jti = authService.getJtiFromCookie(request);<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(jti))&#123;<br>            <span class="hljs-comment">//拒绝访问</span><br>            response.setStatusCode(HttpStatus.UNAUTHORIZED);<br>            <span class="hljs-keyword">return</span> response.setComplete();<br>        &#125;<br><br>        <span class="hljs-comment">//3.从redis中获取jwt的值,如果该值不存在,拒绝本次访问</span><br>        String jwt = authService.getJwtFromRedis(jti);<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(jwt))&#123;<br>            <span class="hljs-comment">//拒绝访问</span><br>            response.setStatusCode(HttpStatus.UNAUTHORIZED);<br>            <span class="hljs-keyword">return</span> response.setComplete();<br>        &#125;<br><br>        <span class="hljs-comment">//4.对当前的请求对象进行增强,让它会携带令牌的信息</span><br>        request.mutate().header(<span class="hljs-string">&quot;Authorization&quot;</span>,<span class="hljs-string">&quot;Bearer &quot;</span>+jwt);<br>        <span class="hljs-keyword">return</span> chain.filter(exchange);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getOrder</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>新建业务逻辑类AuthService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-comment">//从cookie中获取jti的值</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getJtiFromCookie</span><span class="hljs-params">(ServerHttpRequest request)</span> </span>&#123;<br>        HttpCookie httpCookie = request.getCookies().getFirst(<span class="hljs-string">&quot;uid&quot;</span>);<br>        <span class="hljs-keyword">if</span> (httpCookie != <span class="hljs-keyword">null</span>)&#123;<br>            String jti = httpCookie.getValue();<br>            <span class="hljs-keyword">return</span> jti;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//从redis中获取jwt</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getJwtFromRedis</span><span class="hljs-params">(String jti)</span> </span>&#123;<br>        String jwt = stringRedisTemplate.boundValueOps(jti).get();<br>        <span class="hljs-keyword">return</span> jwt;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试</p>
<p>访问：<a target="_blank" rel="noopener" href="http://localhost:8001/api/oauth/login%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%8F%91%E7%8E%B0%E6%B5%8B%E8%AF%95%E9%80%9A%E8%BF%87%EF%BC%8C%E6%8B%BF%E5%88%B0%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%E6%95%B0%E6%8D%AE">http://localhost:8001/api/oauth/login，可以发现测试通过，拿到返回结果数据</a></p>
<p><img src="/images/image-20210807165333771.png" srcset="/img/loading.gif" lazyload alt="image-20210807165333771"></p>
<h2 id="7-自定义登录页面"><a href="#7-自定义登录页面" class="headerlink" title="7 自定义登录页面"></a>7 自定义登录页面</h2><ol>
<li><p>认证服务添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--thymeleaf--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li>
<li><p>把静态资源和页面放到changgou_user_auth微服务中</p>
<p><img src="/images/image-20210807172105423.png" srcset="/img/loading.gif" lazyload alt="image-20210807172105423"></p>
</li>
<li><p>静态资源放行，修改WebSecurityConfig类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 忽略安全拦截的URL</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> web</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(WebSecurity web)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>    web.ignoring().antMatchers(<br>            <span class="hljs-string">&quot;/oauth/login&quot;</span>,<br>            <span class="hljs-string">&quot;/oauth/logout&quot;</span>,<br>            <span class="hljs-string">&quot;/oauth/toLogin&quot;</span>,<span class="hljs-string">&quot;/login.html&quot;</span>,<span class="hljs-string">&quot;/css/**&quot;</span>,<span class="hljs-string">&quot;/data/**&quot;</span>,<span class="hljs-string">&quot;/fonts/**&quot;</span>,<span class="hljs-string">&quot;/img/**&quot;</span>,<span class="hljs-string">&quot;/js/**&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>开启表单登录</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>    http.csrf().disable()<br>            .httpBasic()        <span class="hljs-comment">//启用Http基本身份验证</span><br>            .and()<br>            .formLogin()       <span class="hljs-comment">//启用表单身份验证</span><br>            .and()<br>            .authorizeRequests()    <span class="hljs-comment">//限制基于Request请求访问</span><br>            .anyRequest()<br>            .authenticated();       <span class="hljs-comment">//其他请求都需要经过验证</span><br>   <br>    http.formLogin().loginPage(<span class="hljs-string">&quot;/oauth/toLogin&quot;</span>)  <span class="hljs-comment">//设置访问登录页面的路径</span><br>            .loginProcessingUrl(<span class="hljs-string">&quot;/oauth/login&quot;</span>);  <span class="hljs-comment">//设置执行登录操作的路径</span><br>   <br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>在changgou_user_auth微服务中的AuthController类上怎加下面的访问路径</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/toLogin&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toLogin</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;login&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>修改login.html的登录页面, 并定义前端的login方法</p>
<p>100行开始</p>
<p><img src="/images/image-20210807173951504.png" srcset="/img/loading.gif" lazyload alt="image-20210807173951504"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-comment">&lt;!--script样式的修改放最后面--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">th:inline</span>=<span class="hljs-string">&quot;javascript&quot;</span>&gt;</span><span class="javascript"></span><br><span class="javascript">	<span class="hljs-keyword">var</span> app = <span class="hljs-keyword">new</span> Vue(&#123;</span><br><span class="javascript">		<span class="hljs-attr">el</span>:<span class="hljs-string">&quot;#app&quot;</span>,</span><br><span class="javascript">		<span class="hljs-attr">data</span>:&#123;</span><br><span class="javascript">			<span class="hljs-attr">username</span>:<span class="hljs-string">&quot;&quot;</span>,</span><br><span class="javascript">			<span class="hljs-attr">password</span>:<span class="hljs-string">&quot;&quot;</span>,</span><br><span class="javascript">			<span class="hljs-attr">msg</span>:<span class="hljs-string">&quot;&quot;</span></span><br><span class="javascript">		&#125;,</span><br><span class="javascript">		<span class="hljs-attr">methods</span>:&#123;</span><br><span class="javascript">			<span class="hljs-attr">login</span>:<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;</span><br><span class="javascript">				app.msg=<span class="hljs-string">&quot;正在登录&quot;</span>;</span><br><span class="javascript">				axios.post(<span class="hljs-string">&quot;/api/oauth/login?username=&quot;</span>+app.username+<span class="hljs-string">&quot;&amp;password=&quot;</span>+app.password).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) </span>&#123;</span><br><span class="javascript">					<span class="hljs-keyword">if</span> (response.data.flag)&#123;</span><br><span class="javascript">						app.msg=<span class="hljs-string">&quot;登录成功&quot;</span>;</span><br><span class="javascript">					&#125; <span class="hljs-keyword">else</span>&#123;</span><br><span class="javascript">						app.msg=<span class="hljs-string">&quot;登录失败&quot;</span>;</span><br><span class="javascript">					&#125;</span><br><span class="javascript">				&#125;)</span><br><span class="javascript">			&#125;</span><br><span class="javascript">		&#125;</span><br><span class="javascript">	&#125;)</span><br><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure></li>
<li><p>定义路经过滤，方便统一授权资源</p>
<p><img src="/images/image-20210807174204477.png" srcset="/img/loading.gif" lazyload alt="image-20210807174204477"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UrlFilter</span> </span>&#123;<br><br>    <span class="hljs-comment">//所有需要传递令牌的地址</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String filterPath=<span class="hljs-string">&quot;/api/wseckillorder,/api/seckill,/api/wxpay,/api/wxpay/**,/api/worder/**,/api/user/**,/api/address/**,/api/wcart/**,/api/cart/**,/api/categoryReport/**,/api/orderConfig/**,/api/order/**,/api/orderItem/**,/api/orderLog/**,/api/preferential/**,/api/returnCause/**,/api/returnOrder/**,/api/returnOrderItem/**&quot;</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">hasAuthorize</span><span class="hljs-params">(String url)</span></span>&#123;<br><br>        String[] split = filterPath.replace(<span class="hljs-string">&quot;**&quot;</span>, <span class="hljs-string">&quot;&quot;</span>).split(<span class="hljs-string">&quot;,&quot;</span>);<br><br>        <span class="hljs-keyword">for</span> (String value : split) &#123;<br><br>            <span class="hljs-keyword">if</span> (url.startsWith(value))&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>; <span class="hljs-comment">//代表当前的访问地址是需要传递令牌的</span><br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>; <span class="hljs-comment">//代表当前的访问地址是不需要传递令牌的</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>最后进行测试</p>
<p>访问：<a target="_blank" rel="noopener" href="http://localhost:9200/oauth/toLogin">http://localhost:9200/oauth/toLogin</a></p>
<p><img src="/images/image-20210807174443284.png" srcset="/img/loading.gif" lazyload alt="image-20210807174443284"></p>
</li>
</ol>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/">畅购商城项目</a>
                    
                  </div>
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/07/29/1.5%20%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">畅购商城项目第五部分</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/07/27/1.3%20%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86/">
                        <span class="hidden-mobile">畅购商城项目第三部分</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>



  <script  src="/js/local-search.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
