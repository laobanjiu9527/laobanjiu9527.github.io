

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/Lsh.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="核心内容：1. 实现购物车业务功能。2. 实现订单业务功能">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
  <title>畅购商城项目第五部分 - laobanjiu</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"laobanjiu9527.github.io","root":"/","version":"1.8.11","typing":{"enable":true,"typeSpeed":70,"cursorChar":" ","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>老斑鸠</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/snoopy3.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="畅购商城项目第五部分">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-07-29 16:32" pubdate>
        2021年7月29日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      10.9k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      155
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">畅购商城项目第五部分</h1>
            
            <div class="markdown-body">
              <h1 id="Part10-购物车"><a href="#Part10-购物车" class="headerlink" title="Part10 购物车"></a>Part10 购物车</h1><h2 id="1-SpringSecurity权限控制"><a href="#1-SpringSecurity权限控制" class="headerlink" title="1. SpringSecurity权限控制"></a>1. SpringSecurity权限控制</h2><p><img src="/images/image-20210807190309378.png" srcset="/img/loading.gif" lazyload alt="image-20210807190309378"></p>
<p>用户每次访问微服务的时候，先去oauth2.0服务登录，登录后再访问微服务网关，微服务网关将请求转发给其他微服务处理。</p>
<p>由于我们项目使用了微服务，任何用户都有可能使用任意微服务，此时我们需要控制相关权限，例如：普通用户角色不能使用用户的删除操作，只有管理员才可以使用,那么这个时候就需要使用到SpringSecurity的权限控制功能了。</p>
<h3 id="1-1-角色权限加载"><a href="#1-1-角色权限加载" class="headerlink" title="1.1 角色权限加载"></a>1.1 角色权限加载</h3><p>在changgou-user-oauth服务中，com.changgou.oauth.config.UserDetailsServiceImpl该类实现了加载用户相关信息，如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">        <span class="hljs-comment">//根据用户名查询用户信息</span><br><span class="hljs-comment">//        String pwd = new BCryptPasswordEncoder().encode(&quot;itheima&quot;);</span><br>        com.changgou.user.pojo.User userInfo = userFeign.findUserInfo(username);<br>        <span class="hljs-comment">//创建User对象</span><br>        String permissions = <span class="hljs-string">&quot;salesman, accountant, user&quot;</span>;<br>        UserJwt userDetails = <span class="hljs-keyword">new</span> UserJwt(username,userInfo.getPassword(),AuthorityUtils.commaSeparatedStringToAuthorityList(permissions));<br>        <span class="hljs-keyword">return</span> userDetails;<br></code></pre></td></tr></table></figure>

<p>上述代码给登录用户定义了两个角色，分别为goods_list,seckill_list，这一块我们目前使用的是硬编码方式将角色写死了。</p>
<p>在这里我们先进行一次登录操作，输入地址：<a target="_blank" rel="noopener" href="http://localhost:8001/api/oauth/login">http://localhost:8001/api/oauth/login</a></p>
<p>登录成功</p>
<p><img src="/images/image-20210807193630600.png" srcset="/img/loading.gif" lazyload alt="image-20210807193630600"></p>
<p>此时我们去redis里面看有没有data部分的jti和相应的token值, 发现是存在的</p>
<p><img src="/images/image-20210807193740222.png" srcset="/img/loading.gif" lazyload alt="image-20210807193740222"></p>
<p>我么可以用之前编写好的解析令牌的测试类来解析令牌里面的内容</p>
<p>解析类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ParseJwtTest</span> </span>&#123;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">parseJwt</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-comment">//基于公钥去解析jwt</span><br>        String jwt =<span class="hljs-string">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzY29wZSI6WyJhcHAiXSwibmFtZSI6bnVsbCwiaWQiOm51bGwsImV4cCI6MTYyODM3OTE0OCwiYXV0aG9yaXRpZXMiOlsic2Vja2lsbF9saXN0IiwiZ29vZHNfbGlzdCJdLCJqdGkiOiI3YjIwYTBkNS04NzI5LTRkMWMtYTY4YS0xM2IyM2MwYmUyNzMiLCJjbGllbnRfaWQiOiJjaGFuZ2dvdSIsInVzZXJuYW1lIjoiaGVpbWEifQ.XjAafeLs2QrMJH3BkBpqLknmdUe4Tumi7gv3Yxh5Vpt5mj1KizFWnfjYwHZHuLKZkHkNcDRH933D472HK95bFX4Ag_1bDjFrj2X5CzV6-fb7L3ncl_rZxoOAoES2J0GEquQGdx04KqB0uIlUFI-jMQ0wL0Lufz9LIDCF_2F1dXJQvV6sWQVkFQeVvE11_z5_Cn8Z7FMPIwYPmsidSDeE7aPldJpG4cNnY4YDyZQVhVJjdANP02Vx83ysDd5dDpmtNCNcGqVR3c2qBp49bewH0QjUmlfhhm_EbR9C_8NPk7XTlrZEPYzapSU27qIGhNaNHLjqZP9jOkRowHqoi2dUuw&quot;</span>;<br><br>        String publicKey =<span class="hljs-string">&quot;-----BEGIN PUBLIC KEY-----MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAvFsEiaLvij9C1Mz+oyAmt47whAaRkRu/8kePM+X8760UGU0RMwGti6Z9y3LQ0RvK6I0brXmbGB/RsN38PVnhcP8ZfxGUH26kX0RK+tlrxcrG+HkPYOH4XPAL8Q1lu1n9x3tLcIPxq8ZZtuIyKYEmoLKyMsvTviG5flTpDprT25unWgE4md1kthRWXOnfWHATVY7Y/r4obiOL1mS5bEa/iNKotQNnvIAKtjBM4RlIDWMa6dmz+lHtLtqDD2LF1qwoiSIHI75LQZ/CNYaHCfZSxtOydpNKq8eb1/PGiLNolD4La2zf0/1dlcr5mkesV570NxRmU1tFm8Zd3MZlZmyv9QIDAQAB-----END PUBLIC KEY-----&quot;</span>;<br><br>        Jwt token = JwtHelper.decodeAndVerify(jwt, <span class="hljs-keyword">new</span> RsaVerifier(publicKey));<br><br>        String claims = token.getClaims();<br>        System.out.println(claims);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到里面的三个权限是之前定义好的</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;scope&quot;</span>:[<span class="hljs-string">&quot;app&quot;</span>],<span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-literal">null</span>,<span class="hljs-attr">&quot;id&quot;</span>:<span class="hljs-literal">null</span>,<span class="hljs-attr">&quot;exp&quot;</span>:<span class="hljs-number">1628379737</span>,<span class="hljs-attr">&quot;authorities&quot;</span>:[<span class="hljs-string">&quot;accountant&quot;</span>,<span class="hljs-string">&quot;user&quot;</span>,<span class="hljs-string">&quot;salesman&quot;</span>],<span class="hljs-attr">&quot;jti&quot;</span>:<span class="hljs-string">&quot;2c87dd69-7a16-469a-9033-f7fb158b2317&quot;</span>,<span class="hljs-attr">&quot;client_id&quot;</span>:<span class="hljs-string">&quot;changgou&quot;</span>,<span class="hljs-attr">&quot;username&quot;</span>:<span class="hljs-string">&quot;heima&quot;</span>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-2-角色权限控制"><a href="#1-2-角色权限控制" class="headerlink" title="1.2 角色权限控制"></a>1.2 角色权限控制</h3><p>在每个微服务中，需要获取用户的角色，然后根据角色识别是否允许操作指定的方法，Spring Security中定义了四个支持权限控制的表达式注解，分别是<code>@PreAuthorize</code>、<code>@PostAuthorize</code>、<code>@PreFilter</code>和<code>@PostFilter</code>。其中前两者可以用来在方法调用前或者调用后进行权限检查，后两者可以用来对集合类型的参数或者返回值进行过滤。在需要控制权限的方法上，我们可以添加<code>@PreAuthorize</code>注解，用于方法执行前进行权限检查，校验用户当前角色是否能访问该方法。</p>
<ol>
<li><p>开启@PreAuthorize</p>
<p>在<code>changgou-service-user</code>的<code>ResourceServerConfig</code>类上添加<code>@EnableGlobalMethodSecurity</code>注解，用于开启@PreAuthorize的支持，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableResourceServer</span><br><span class="hljs-meta">@EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)</span><span class="hljs-comment">//激活方法上的PreAuthorize注解</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ResourceServerConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ResourceServerConfigurerAdapter</span> </span>&#123;&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>方法权限控制</p>
<p>在<code>changgou-service-user</code>微服务的<code>com.changgou.user.controller.UserController</code>类的delete()方法上添加权限控制注解<code>@PreAuthorize</code>，代码如下：</p>
<p>注意：</p>
<ul>
<li><code>@PreAuthorize(&quot;hasAnyAuthority(&#39;admin&#39;)&quot;)</code>表示只有admin角色才能访问该方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PreAuthorize(&quot;hasAnyAuthority(&#x27;admin&#x27;)&quot;)</span><br><span class="hljs-meta">@GetMapping</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">findAll</span><span class="hljs-params">()</span></span>&#123;<br>    List&lt;User&gt; userList = userService.findAll();<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>, StatusCode.OK,<span class="hljs-string">&quot;查询成功&quot;</span>,userList) ;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>测试</p>
<p>我们使用Postman测试，先创建令牌，然后将令牌数存放到头文件中访问微服务网关来调用user微服务的search方法，效果如下：</p>
<p>提交方式：GET，地址：<a target="_blank" rel="noopener" href="http://localhost:8001/api/user">http://localhost:8001/api/user</a> </p>
<p>发现上面无法访问，因为用户登录的时候，角色不包含admin角色，而findAll方法需要admin角色，所以被拦截了。</p>
<p>我们再测试其他方法，其他方法没有配置拦截，所以用户登录后就会放行。</p>
</li>
</ol>
<h3 id="1-3-小结"><a href="#1-3-小结" class="headerlink" title="1.3 小结"></a>1.3 小结</h3><p>如果希望一个方法能被多个角色访问，配置:<code>@PreAuthorize(&quot;hasAnyAuthority(&#39;admin&#39;,&#39;user&#39;)&quot;)</code></p>
<p>如果希望一个类都能被多个角色访问，在类上配置:<code>@PreAuthorize(&quot;hasAnyAuthority(&#39;admin&#39;,&#39;user&#39;)&quot;)</code></p>
<h2 id="2-购物车"><a href="#2-购物车" class="headerlink" title="2. 购物车"></a>2. 购物车</h2><p>购物车分为用户登录购物车和未登录购物车操作，国内知名电商京东用户登录和不登录都可以操作购物车，如果用户不登录，操作购物车可以将数据存储到Cookie，用户登录后购物车数据可以存储到Redis中，再将之前未登录加入的购物车合并到Redis中即可。</p>
<p>淘宝天猫则采用了另外一种实现方案，用户要想将商品加入购物车，必须先登录才能操作购物车。</p>
<p>我们今天实现的购物车是天猫解决方案，即用户必须先登录才能使用购物车功能。</p>
<h3 id="2-1-购物车业务分析"><a href="#2-1-购物车业务分析" class="headerlink" title="2.1 购物车业务分析"></a>2.1 购物车业务分析</h3><ol>
<li><p>需求分析</p>
<p>用户在商品详细页点击加入购物车，提交商品SKU编号和购买数量，添加到购物车。购物车展示页面如下：</p>
<p><img src="/images/image-20210807195831748.png" srcset="/img/loading.gif" lazyload alt="image-20210807195831748"></p>
</li>
<li><p>购物车实现思路</p>
<p><img src="/images/image-20210807195957757.png" srcset="/img/loading.gif" lazyload alt="image-20210807195957757"></p>
<p>我们实现的是用户登录后的购物车，用户将商品加入购物车的时候，直接将要加入购物车的详情存入到Redis即可。每次查看购物车的时候直接从Redis中获取。</p>
</li>
<li><p>表结构分析</p>
<p>用户登录后将商品加入购物车，需要存储商品详情以及购买数量，购物车详情表如下：</p>
<p>changgou_order数据中tb_order_item表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `tb_order_item` (<br>  `id` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;ID&#x27;</span>,<br>  `category_id1` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;1级分类&#x27;</span>,<br>  `category_id2` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;2级分类&#x27;</span>,<br>  `category_id3` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;3级分类&#x27;</span>,<br>  `spu_id` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;SPU_ID&#x27;</span>,<br>  `sku_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;SKU_ID&#x27;</span>,<br>  `order_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;订单ID&#x27;</span>,<br>  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;商品名称&#x27;</span>,<br>  `price` <span class="hljs-type">int</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;单价&#x27;</span>,<br>  `num` <span class="hljs-type">int</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;数量&#x27;</span>,<br>  `money` <span class="hljs-type">int</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;总金额&#x27;</span>,<br>  `pay_money` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;实付金额&#x27;</span>,<br>  `image` <span class="hljs-type">varchar</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;图片地址&#x27;</span>,<br>  `weight` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;重量&#x27;</span>,<br>  `post_fee` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;运费&#x27;</span>,<br>  `is_return` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;是否退货&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),<br>  KEY `item_id` (`sku_id`),<br>  KEY `order_id` (`order_id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8_bin;<br></code></pre></td></tr></table></figure></li>
</ol>
<h3 id="2-2-添加购物车"><a href="#2-2-添加购物车" class="headerlink" title="2.2 添加购物车"></a>2.2 添加购物车</h3><p><img src="/images/image-20210807200521515.png" srcset="/img/loading.gif" lazyload alt="image-20210807200521515"></p>
<h4 id="2-2-1-获取sku数据"><a href="#2-2-1-获取sku数据" class="headerlink" title="2.2.1 获取sku数据"></a>2.2.1 获取sku数据</h4><p>goods服务中定义根据id查询sku对象实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;Sku&gt; <span class="hljs-title">findById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span></span>&#123;<br>    Sku sku = skuService.findById(id);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>,StatusCode.OK,<span class="hljs-string">&quot;查询成功&quot;</span>,sku);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2-2-2-定义feign接口"><a href="#2-2-2-定义feign接口" class="headerlink" title="2.2.2 定义feign接口"></a>2.2.2 定义feign接口</h4><p>goods.api工程中定义skuFeign接口,并定义查询方法</p>
<p>注意：</p>
<ul>
<li><code>@FeignClient(name=&quot;goods&quot;)</code>和<code>@FeignClient(value=&quot;goods&quot;)</code>表示的是一个意思：指定服务的提供方为goods(这个就是服务的名字，在他的配置文件里定义了的)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name=&quot;goods&quot;)</span>  <span class="hljs-comment">//表示goods是服务提供方，必须为客户端指定服务提供方，name和value是一个意思</span><br><span class="hljs-meta">@RequestMapping(&quot;/sku&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SkuFeign</span> </span>&#123;<br>    <br>    <span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;Sku&gt; <span class="hljs-title">findById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span></span>;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2-2-3-订单服务添加依赖"><a href="#2-2-3-订单服务添加依赖" class="headerlink" title="2.2.3 订单服务添加依赖"></a>2.2.3 订单服务添加依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.changgou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>changgou_service_goods_api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-4-订单服务启动类添加feign接口扫描"><a href="#2-2-4-订单服务启动类添加feign接口扫描" class="headerlink" title="2.2.4 订单服务启动类添加feign接口扫描"></a>2.2.4 订单服务启动类添加feign接口扫描</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableFeignClients(basePackages = &quot;com.changgou.goods.feign&quot;)</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-5-订单服务添加CartService及其实现类"><a href="#2-2-5-订单服务添加CartService及其实现类" class="headerlink" title="2.2.5 订单服务添加CartService及其实现类"></a>2.2.5 订单服务添加CartService及其实现类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CartService</span> </span>&#123;<br><br>    <span class="hljs-comment">//添加购物车</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">addCart</span><span class="hljs-params">(String skuId, Integer num, String username)</span></span>;<br><br>    <span class="hljs-comment">//查询购物车数据</span><br>    <span class="hljs-function">Map <span class="hljs-title">list</span><span class="hljs-params">(String username)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CartServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CartService</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String CART=<span class="hljs-string">&quot;cart_&quot;</span>;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SkuFeign skuFeign;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SpuFeign spuFeign;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addCart</span><span class="hljs-params">(String skuId, Integer num, String username)</span> </span>&#123;<br>        <span class="hljs-comment">//1.查询redis中相对应的商品信息</span><br>        OrderItem orderItem = (OrderItem) redisTemplate.boundHashOps(CART+username).get(skuId);<br>        <span class="hljs-keyword">if</span> (orderItem != <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-comment">//2.如果当前商品在redis中的存在,则更新商品的数量与价钱</span><br>            orderItem.setNum(orderItem.getNum()+num);<br>            <span class="hljs-keyword">if</span> (orderItem.getNum()&lt;=<span class="hljs-number">0</span>)&#123;<br>                <span class="hljs-comment">//删除该商品</span><br>                redisTemplate.boundHashOps(CART+username).delete(skuId);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            orderItem.setMoney(orderItem.getNum()*orderItem.getPrice());<br>            orderItem.setPayMoney(orderItem.getNum()*orderItem.getPrice());<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//3.如果当前商品在redis中不存在,将商品添加到redis中</span><br>            Sku sku = skuFeign.findById(skuId).getData();<br>            Spu spu = spuFeign.findSpuById(sku.getSpuId()).getData();<br><br>            <span class="hljs-comment">//封装orderItem</span><br>           orderItem = <span class="hljs-keyword">this</span>.sku2OrderItem(sku,spu,num);<br>        &#125;<br><br>        <span class="hljs-comment">//3.将orderitem添加到redis中</span><br>        redisTemplate.boundHashOps(CART+username).put(skuId,orderItem);<br>    &#125;<br><br>    <span class="hljs-comment">//查询购物车列表数据</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Map <span class="hljs-title">list</span><span class="hljs-params">(String username)</span> </span>&#123;<br>        Map map = <span class="hljs-keyword">new</span> HashMap();<br><br>        List&lt;OrderItem&gt; orderItemList = redisTemplate.boundHashOps(CART + username).values();<br>        map.put(<span class="hljs-string">&quot;orderItemList&quot;</span>,orderItemList);<br><br>        <span class="hljs-comment">//商品的总数量与总价格</span><br>        Integer totalNum = <span class="hljs-number">0</span>;<br>        Integer totalMoney = <span class="hljs-number">0</span>;<br><br>        <span class="hljs-keyword">for</span> (OrderItem orderItem : orderItemList) &#123;<br>            totalNum+=orderItem.getNum();<br>            totalMoney+=orderItem.getMoney();<br>        &#125;<br><br>        map.put(<span class="hljs-string">&quot;totalNum&quot;</span>,totalNum);<br>        map.put(<span class="hljs-string">&quot;totalMoney&quot;</span>,totalMoney);<br><br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> OrderItem <span class="hljs-title">sku2OrderItem</span><span class="hljs-params">(Sku sku, Spu spu, Integer num)</span> </span>&#123;<br>        OrderItem orderItem = <span class="hljs-keyword">new</span> OrderItem();<br>        orderItem.setSpuId(sku.getSpuId());<br>        orderItem.setSkuId(sku.getId());<br>        orderItem.setName(sku.getName());<br>        orderItem.setPrice(sku.getPrice());<br>        orderItem.setNum(num);<br>        orderItem.setMoney(orderItem.getPrice()*num);<br>        orderItem.setPayMoney(orderItem.getPrice()*num);<br>        orderItem.setImage(sku.getImage());<br>        orderItem.setWeight(sku.getWeight()*num);<br>        <span class="hljs-comment">//分类信息</span><br>        orderItem.setCategoryId1(spu.getCategory1Id());<br>        orderItem.setCategoryId2(spu.getCategory2Id());<br>        orderItem.setCategoryId3(spu.getCategory3Id());<br>        <span class="hljs-keyword">return</span> orderItem;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2-2-6-订单服务新建CartController"><a href="#2-2-6-订单服务新建CartController" class="headerlink" title="2.2.6 订单服务新建CartController"></a>2.2.6 订单服务新建CartController</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/cart&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CartController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CartService cartService;<br><br>    <span class="hljs-comment">/*@Autowired</span><br><span class="hljs-comment">    private TokenDecode tokenDecode;*/</span><br><br>    <span class="hljs-meta">@GetMapping(&quot;/addCart&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">addCart</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;skuId&quot;)</span> String skuId, <span class="hljs-meta">@RequestParam(&quot;num&quot;)</span> Integer num)</span></span>&#123;<br><br>        <span class="hljs-comment">//动态获取当前人信息,暂时静态</span><br>        String username = <span class="hljs-string">&quot;itcast&quot;</span>;<br><span class="hljs-comment">//        String username = tokenDecode.getUserInfo().get(&quot;username&quot;);</span><br>        cartService.addCart(skuId,num,username);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>, StatusCode.OK,<span class="hljs-string">&quot;加入购物车成功&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/list&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Map <span class="hljs-title">list</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-comment">//动态获取当前人信息,暂时静态</span><br>        String username = <span class="hljs-string">&quot;itcast&quot;</span>;<br><span class="hljs-comment">//        String username = tokenDecode.getUserInfo().get(&quot;username&quot;);</span><br>        Map map = cartService.list(username);<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>最后测试添加购物车，请求地址：localhost:9002/cart/addCart?skuId=100000003145&amp;num=1</p>
<p>效果如下：</p>
<p><img src="/images/image-20210807205116509.png" srcset="/img/loading.gif" lazyload alt="image-20210807205116509"></p>
<p>可以发现redis缓存中已经有商品了</p>
<p><img src="/images/image-20210807205216459.png" srcset="/img/loading.gif" lazyload alt="image-20210807205216459"></p>
<h3 id="2-3-购物车列表"><a href="#2-3-购物车列表" class="headerlink" title="2.3 购物车列表"></a>2.3 购物车列表</h3><h4 id="2-3-1-思路分析"><a href="#2-3-1-思路分析" class="headerlink" title="2.3.1 思路分析"></a>2.3.1 思路分析</h4><p><img src="/images/image-20210807205435727.png" srcset="/img/loading.gif" lazyload alt="image-20210807205435727"></p>
<p>接着我们实现一次购物车列表操作。因为存的时候是根据用户名往Redis中存储用户的购物车数据的，所以我们这里可以将用户的名字作为key去Redis中查询对应的数据。##</p>
<h4 id="2-3-2-代码实现"><a href="#2-3-2-代码实现" class="headerlink" title="2.3.2 代码实现"></a>2.3.2 代码实现</h4><ol>
<li><p>业务层</p>
<p>com.changgou.order.service.CartService接口，添加购物车列表方法，代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//查询购物车数据</span><br><span class="hljs-function">Map <span class="hljs-title">list</span><span class="hljs-params">(String username)</span></span>;<br></code></pre></td></tr></table></figure></li>
<li><p>业务层接口实现类</p>
<p>com.changgou.order.service.impl.CartServiceImpl类，添加购物车列表实现方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//查询购物车列表数据</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Map <span class="hljs-title">list</span><span class="hljs-params">(String username)</span> </span>&#123;<br>    Map map = <span class="hljs-keyword">new</span> HashMap();<br>   <br>    List&lt;OrderItem&gt; orderItemList = redisTemplate.boundHashOps(CART + username).values();<br>    map.put(<span class="hljs-string">&quot;orderItemList&quot;</span>,orderItemList);<br>   <br>    <span class="hljs-comment">//商品的总数量与总价格</span><br>    Integer totalNum = <span class="hljs-number">0</span>;<br>    Integer totalMoney = <span class="hljs-number">0</span>;<br>   <br>    <span class="hljs-keyword">for</span> (OrderItem orderItem : orderItemList) &#123;<br>        totalNum+=orderItem.getNum();<br>        totalMoney+=orderItem.getMoney();<br>    &#125;<br>   <br>    map.put(<span class="hljs-string">&quot;totalNum&quot;</span>,totalNum);<br>    map.put(<span class="hljs-string">&quot;totalMoney&quot;</span>,totalMoney);<br>   <br>    <span class="hljs-keyword">return</span> map;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>控制层</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 查询用户购物车列表</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(value = &quot;/list&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Map <span class="hljs-title">list</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-comment">//暂时静态，后续修改</span><br>    String username = <span class="hljs-string">&quot;itcast&quot;</span>;<br>    <span class="hljs-keyword">return</span> cartService.list(username);<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>测试</p>
<p>使用Postman访问 GET <a target="_blank" rel="noopener" href="http://localhost:9002/cart/list">http://localhost:9002/cart/list</a></p>
<p>效果如下</p>
<p><img src="/images/image-20210807210847527.png" srcset="/img/loading.gif" lazyload alt="image-20210807210847527"></p>
</li>
</ol>
<h2 id="3-购物车渲染"><a href="#3-购物车渲染" class="headerlink" title="3. 购物车渲染"></a>3. 购物车渲染</h2><h3 id="3-1-购物车渲染服务搭建"><a href="#3-1-购物车渲染服务搭建" class="headerlink" title="3.1 购物车渲染服务搭建"></a>3.1 购物车渲染服务搭建</h3><p>在changgou_web中搭建订单购物车微服务工程<code>changgou_web_order</code>，该工程主要实现购物车和订单的渲染操作。</p>
<ol>
<li><p>导入pom文件依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.changgou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>changgou_service_order_api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.changgou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>changgou_common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure></li>
<li><p>application.yml配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9011</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">order-web</span><br>  <span class="hljs-attr">main:</span><br>    <span class="hljs-attr">allow-bean-definition-overriding:</span> <span class="hljs-literal">true</span>   <span class="hljs-comment">#当遇到同样名字的时候，是否允许覆盖注册</span><br>  <span class="hljs-attr">thymeleaf:</span><br>    <span class="hljs-attr">cache:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:6868/eureka</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">hystrix:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">default:</span>   <span class="hljs-comment">#配置全局的feign的调用超时时间  如果 有指定的服务配置 默认的配置不会生效</span><br>        <span class="hljs-attr">connectTimeout:</span> <span class="hljs-number">60000</span> <span class="hljs-comment"># 指定的是 消费者 连接服务提供者的连接超时时间 是否能连接  单位是毫秒</span><br>        <span class="hljs-attr">readTimeout:</span> <span class="hljs-number">80000</span>  <span class="hljs-comment"># 指定的是调用服务提供者的 服务 的超时时间（）  单位是毫秒</span><br><span class="hljs-comment">#hystrix 配置</span><br><span class="hljs-attr">hystrix:</span><br>  <span class="hljs-attr">command:</span><br>    <span class="hljs-attr">default:</span><br>      <span class="hljs-attr">execution:</span><br>        <span class="hljs-attr">timeout:</span><br>          <span class="hljs-comment">#如果enabled设置为false，则请求超时交给ribbon控制</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">isolation:</span><br>          <span class="hljs-attr">strategy:</span> <span class="hljs-string">SEMAPHORE</span><br>          <span class="hljs-attr">thread:</span><br>            <span class="hljs-comment"># 熔断器超时时间，默认：1000/毫秒</span><br>            <span class="hljs-attr">timeoutInMilliseconds:</span> <span class="hljs-number">80000</span><br><span class="hljs-comment">#请求处理的超时时间</span><br><span class="hljs-attr">ribbon:</span><br>  <span class="hljs-attr">ReadTimeout:</span> <span class="hljs-number">4000</span><br>  <span class="hljs-comment">#请求连接的超时时间</span><br>  <span class="hljs-attr">ConnectTimeout:</span> <span class="hljs-number">3000</span><br></code></pre></td></tr></table></figure></li>
<li><p>创建启动类</p>
<p>创建com.changgou.OrderWebApplication启动类，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableEurekaClient</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderWebApplication</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(OrderWebApplication.class,args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>静态资源拷贝</p>
<p>资源\成品页面\cart.html页面拷贝到工程中，如下图：</p>
<p><img src="/images/image-20210807225516860.png" srcset="/img/loading.gif" lazyload alt="image-20210807225516860"></p>
</li>
</ol>
<h3 id="3-2-购物车列表渲染"><a href="#3-2-购物车列表渲染" class="headerlink" title="3.2 购物车列表渲染"></a>3.2 购物车列表渲染</h3><ol>
<li><p>Feign创建</p>
<p>在changgou_service_order_api中添加CartFeign接口，并在接口中创建添加购物车和查询购物车列表，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name = &quot;order&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CartFeign</span> </span>&#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/cart/addCart&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">addCart</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;skuId&quot;)</span> String skuId, <span class="hljs-meta">@RequestParam(&quot;num&quot;)</span> Integer num)</span></span>;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/cart/list&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Map <span class="hljs-title">list</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>后台代码</p>
<p>在changgou_web_order中创建com.changgou.order.controller.CartController,并添加查询购物车集合方法和添加购物车方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/wcart&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CartController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CartFeign cartFeign;<br><br>    <span class="hljs-comment">//查询</span><br>    <span class="hljs-meta">@GetMapping(&quot;/list&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">list</span><span class="hljs-params">(Model model)</span></span>&#123;<br>        Map map = cartFeign.list();<br>        model.addAttribute(<span class="hljs-string">&quot;items&quot;</span>,map);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;cart&quot;</span>;<br>    &#125;<br><br><br>    <span class="hljs-comment">//添加</span><br>    <span class="hljs-meta">@GetMapping(&quot;/add&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;Map&gt; <span class="hljs-title">add</span><span class="hljs-params">(String id,Integer num)</span></span>&#123;<br>        cartFeign.addCart(id,num);<br>        Map map = cartFeign.list();<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result&lt;&gt;(<span class="hljs-keyword">true</span>, StatusCode.OK,<span class="hljs-string">&quot;添加购物车成功&quot;</span>,map);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>前端页面</p>
<ul>
<li>加载列表数据</li>
<li>购物车渲染服务</li>
</ul>
<p>这里暂时不细学，后面系统学期前端再深入</p>
</li>
<li><p>订单服务对接网关</p>
<p>修改微服务网关<code>changgou-gateway-web</code>的application.yml配置文件，添加order的路由过滤配置，配置如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yml">  <span class="hljs-comment">#认证微服务</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">changgou_oauth_user</span><br>  <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://user-auth</span><br>  <span class="hljs-attr">predicates:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/oauth/**</span><br>  <span class="hljs-attr">filters:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">changgou_order_route</span><br>  <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://order</span><br>  <span class="hljs-attr">predicates:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/cart/**,/api/categoryReport/**,/api/orderConfig/**,/api/order/**,/api/orderItem/**,/api/orderLog/**,/api/preferential/**,/api/returnCause/**,/api/returnOrder/**,/api/returnOrderItem/**</span><br>  <span class="hljs-attr">filters:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br>  <span class="hljs-comment">#购物车订单渲染微服务</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">changgou_order_web_route</span><br>  <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://order-web</span><br>  <span class="hljs-attr">predicates:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/wcart/**,/api/worder/**</span><br>  <span class="hljs-attr">filters:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br></code></pre></td></tr></table></figure></li>
<li><p>测试</p>
<p>由于开启了网关，要先登录才能访问</p>
<p>登录路径：<a target="_blank" rel="noopener" href="http://192.168.114.1:8001/api/oauth/toLogin">http://192.168.114.1:8001/api/oauth/toLogin</a></p>
<p>访问购物车路径（我的登录界面的权限好像存在问题，登录没上，显示未授权）：<a target="_blank" rel="noopener" href="http://localhost:8001/api/wcart/list">http://localhost:8001/api/wcart/list</a></p>
</li>
</ol>
<h3 id="3-3-商品数量变更"><a href="#3-3-商品数量变更" class="headerlink" title="3.3 商品数量变更"></a>3.3 商品数量变更</h3><p>用户可以点击+号或者-号，或者手动输入一个数字，然后更新购物车列表，我们可以给-+号一个点击事件，给数字框一个失去焦点事件，然后调用后台，实现购物车的更新。</p>
<p>请求后台方法：</p>
<p>在js里面创建一个请求后台的方法，代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;script th:inline=<span class="hljs-string">&quot;javascript&quot;</span>&gt;<br>	<span class="hljs-keyword">var</span> app = <span class="hljs-keyword">new</span> Vue(&#123;<br>		<span class="hljs-attr">el</span>:<span class="hljs-string">&quot;#app&quot;</span>,<br>		<span class="hljs-attr">data</span>:&#123;<br>			<span class="hljs-attr">items</span>:[[$&#123;items&#125;]]<br>		&#125;,<br>		<span class="hljs-attr">methods</span>:&#123;<br>			<span class="hljs-attr">add</span>:<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">skuId,num</span>) </span>&#123;<br>				axios.get(<span class="hljs-string">&quot;/api/wcart/add?id=&quot;</span>+skuId+<span class="hljs-string">&quot;&amp;num=&quot;</span>+num).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) </span>&#123;<br>					<span class="hljs-keyword">if</span> (response.data.flag)&#123;<br>						app.items=response.data.data;<br>					&#125;<br>				&#125;)<br>			&#125;<br>		&#125;<br>	&#125;)<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure>

<p>添加事件：</p>
<p>在+-号和数字框那里添加点击事件和失去焦点事件，然后调用上面的add方法，代码如下：</p>
<p><img src="/images/image-20210807223449940.png" srcset="/img/loading.gif" lazyload alt="image-20210807223449940"></p>
<h3 id="3-4-删除商品购物车"><a href="#3-4-删除商品购物车" class="headerlink" title="3.4 删除商品购物车"></a>3.4 删除商品购物车</h3><p>我们发现个问题，就是用户将商品加入购物车，无论数量是正负，都会执行添加购物车，如果数量如果&lt;=0，应该移除该商品的。</p>
<p>修改changgou-service-order的com.changgou.order.service.impl.CartServiceImpl的add方法，添加如下代码：</p>
<p><img src="/images/image-20210807223724709.png" srcset="/img/loading.gif" lazyload alt="image-20210807223724709"></p>
<h3 id="3-5-订单服务对接oauth"><a href="#3-5-订单服务对接oauth" class="headerlink" title="3.5 订单服务对接oauth"></a>3.5 订单服务对接oauth</h3><p>在订单微服务里进行的</p>
<ol>
<li><p>配置公钥</p>
</li>
<li><p>在pom文件中导入oauth依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li>
<li><p>添加配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableResourceServer</span><br><span class="hljs-comment">//开启方法上的PreAuthorize注解</span><br><span class="hljs-meta">@EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ResourceServerConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ResourceServerConfigurerAdapter</span> </span>&#123;<br><br>    <span class="hljs-comment">//公钥</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PUBLIC_KEY = <span class="hljs-string">&quot;public.key&quot;</span>;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 定义JwtTokenStore</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> jwtAccessTokenConverter</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> TokenStore <span class="hljs-title">tokenStore</span><span class="hljs-params">(JwtAccessTokenConverter jwtAccessTokenConverter)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> JwtTokenStore(jwtAccessTokenConverter);<br>    &#125;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 定义JJwtAccessTokenConverter</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> JwtAccessTokenConverter <span class="hljs-title">jwtAccessTokenConverter</span><span class="hljs-params">()</span> </span>&#123;<br>        JwtAccessTokenConverter converter = <span class="hljs-keyword">new</span> JwtAccessTokenConverter();<br>        converter.setVerifierKey(getPubKey());<br>        <span class="hljs-keyword">return</span> converter;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取非对称加密公钥 Key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 公钥 Key</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getPubKey</span><span class="hljs-params">()</span> </span>&#123;<br>        Resource resource = <span class="hljs-keyword">new</span> ClassPathResource(PUBLIC_KEY);<br>        <span class="hljs-keyword">try</span> &#123;<br>            InputStreamReader inputStreamReader = <span class="hljs-keyword">new</span> InputStreamReader(resource.getInputStream());<br>            BufferedReader br = <span class="hljs-keyword">new</span> BufferedReader(inputStreamReader);<br>            <span class="hljs-keyword">return</span> br.lines().collect(Collectors.joining(<span class="hljs-string">&quot;\n&quot;</span>));<br>        &#125; <span class="hljs-keyword">catch</span> (IOException ioe) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * Http安全配置，对每个到达系统的http请求链接进行校验</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> http</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-comment">//所有请求必须认证通过</span><br>        http.authorizeRequests()<br>                .anyRequest().<br>                authenticated();    <span class="hljs-comment">//其他地址需要认证授权</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h3 id="3-6-微服务间认证"><a href="#3-6-微服务间认证" class="headerlink" title="3.6 微服务间认证"></a>3.6 微服务间认证</h3><p><img src="/images/image-20210807224437427.png" srcset="/img/loading.gif" lazyload alt="image-20210807224437427"></p>
<p>如上图：因为微服务之间并没有传递头文件，所以我们可以定义一个拦截器，每次微服务调用之前都先检查下头文件，将请求的头文件中的令牌数据再放入到header中，再调用其他微服务即可。</p>
<p><strong>feign拦截器实现微服务间认证</strong></p>
<ol>
<li><p>创建拦截器</p>
<p>在changgou_common服务中创建一个com.changgou.interceptor.FeignInterceptor拦截器，并将所有头文件数据再次加入到Feign请求的微服务头文件中，代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FeignInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RequestInterceptor</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">apply</span><span class="hljs-params">(RequestTemplate requestTemplate)</span> </span>&#123;<br>        <span class="hljs-comment">//传递令牌</span><br>        RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();<br>        <span class="hljs-keyword">if</span> (requestAttributes != <span class="hljs-keyword">null</span>)&#123;<br>            HttpServletRequest request = ((ServletRequestAttributes) requestAttributes).getRequest();<br>            <span class="hljs-keyword">if</span> (request != <span class="hljs-keyword">null</span>)&#123;<br>                Enumeration&lt;String&gt; headerNames = request.getHeaderNames();<br>                <span class="hljs-keyword">while</span> (headerNames.hasMoreElements())&#123;<br>                    String headerName = headerNames.nextElement();<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;authorization&quot;</span>.equals(headerName))&#123;<br>                        String headerValue = request.getHeader(headerName); <span class="hljs-comment">// Bearer jwt</span><br><br>                        <span class="hljs-comment">//传递令牌</span><br>                        requestTemplate.header(headerName,headerValue);<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>更改changgou_order_web启动类，添加拦截器声明</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> FeignInterceptor <span class="hljs-title">feignInterceptor</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> FeignInterceptor();<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h3 id="3-7-动态获取当前登录人"><a href="#3-7-动态获取当前登录人" class="headerlink" title="3.7 动态获取当前登录人"></a>3.7 动态获取当前登录人</h3><h4 id="3-7-1-数据分析"><a href="#3-7-1-数据分析" class="headerlink" title="3.7.1 数据分析"></a>3.7.1 数据分析</h4><p>用户登录后，数据会封装到<code>SecurityContextHolder.getContext().getAuthentication()</code>里面，我们可以将数据从这里面取出，然后转换成<code>OAuth2AuthenticationDetails</code>,在这里面可以获取到令牌信息、令牌类型等，代码如下（这里的代码不是自己编写的）：</p>
<p><img src="/images/image-20210807230417232.png" srcset="/img/loading.gif" lazyload alt="image-20210807230417232"></p>
<p>这里的tokenValue是加密之后的令牌数据，remoteAddress是用户的IP信息，tokenType是令牌类型。</p>
<p>我们可以获取令牌加密数据后，使用公钥对它进行解密，如果能解密说明数据无误，如果不能解密用户也没法执行到这一步。解密后可以从明文中获取用户信息。</p>
<h4 id="3-7-2-代码实现"><a href="#3-7-2-代码实现" class="headerlink" title="3.7.2 代码实现"></a>3.7.2 代码实现</h4><p>因为该类在很多微服务中都会被使用到，所以需要将该类添加到common工程中</p>
<ol>
<li><p>在changgou-common工程中引入鉴权包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--鉴权--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li>
<li><p>添加资源中的TokenDecode工具类到changgou-service-order微服务config包下，用于解密令牌信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TokenDecode</span> </span>&#123;<br>    <span class="hljs-comment">//公钥</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PUBLIC_KEY = <span class="hljs-string">&quot;public.key&quot;</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String publickey=<span class="hljs-string">&quot;&quot;</span>;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 获取用户信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String,String&gt; <span class="hljs-title">getUserInfo</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-comment">//获取授权信息</span><br>        OAuth2AuthenticationDetails details = (OAuth2AuthenticationDetails) SecurityContextHolder.getContext().getAuthentication().getDetails();<br>        <span class="hljs-comment">//令牌解码</span><br>        <span class="hljs-keyword">return</span> dcodeToken(details.getTokenValue());<br>    &#125;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 读取令牌数据</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String,String&gt; <span class="hljs-title">dcodeToken</span><span class="hljs-params">(String token)</span></span>&#123;<br>        <span class="hljs-comment">//校验Jwt</span><br>        Jwt jwt = JwtHelper.decodeAndVerify(token, <span class="hljs-keyword">new</span> RsaVerifier(getPubKey()));<br><br>        <span class="hljs-comment">//获取Jwt原始内容</span><br>        String claims = jwt.getClaims();<br>        <span class="hljs-keyword">return</span> JSON.parseObject(claims,Map.class);<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取非对称加密公钥 Key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 公钥 Key</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getPubKey</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(!StringUtils.isEmpty(publickey))&#123;<br>            <span class="hljs-keyword">return</span> publickey;<br>        &#125;<br>        Resource resource = <span class="hljs-keyword">new</span> ClassPathResource(PUBLIC_KEY);<br>        <span class="hljs-keyword">try</span> &#123;<br>            InputStreamReader inputStreamReader = <span class="hljs-keyword">new</span> InputStreamReader(resource.getInputStream());<br>            BufferedReader br = <span class="hljs-keyword">new</span> BufferedReader(inputStreamReader);<br>            publickey = br.lines().collect(Collectors.joining(<span class="hljs-string">&quot;\n&quot;</span>));<br>            <span class="hljs-keyword">return</span> publickey;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException ioe) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>将该工具类以bean的形式声明到order服务中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableEurekaClient</span><br><span class="hljs-meta">@EnableFeignClients(basePackages = &quot;com.changgou.goods.feign&quot;)</span><br><span class="hljs-meta">@MapperScan(basePackages = &#123;&quot;com.changgou.order.dao&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderApplication</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run( OrderApplication.class);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> TokenDecode <span class="hljs-title">tokenDecode</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TokenDecode();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>控制层获取用户数据</p>
<p>在CartController中注入TokenDecode，并调用TokenDecode的getUserInfo方法获取用户信息，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/cart&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CartController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CartService cartService;<br><br>    <span class="hljs-comment">//===================</span><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> TokenDecode tokenDecode;<br>    <span class="hljs-comment">//===================</span><br><br>    <span class="hljs-meta">@GetMapping(&quot;/addCart&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">addCart</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;skuId&quot;)</span> String skuId, <span class="hljs-meta">@RequestParam(&quot;num&quot;)</span> Integer num)</span></span>&#123;<br><br>        <span class="hljs-comment">//===================</span><br>        <span class="hljs-comment">//动态获取当前人信息,暂时静态</span><br>        <span class="hljs-comment">//String username = &quot;itcast&quot;;</span><br>        String username = tokenDecode.getUserInfo().get(<span class="hljs-string">&quot;username&quot;</span>);<br>        <span class="hljs-comment">//===================</span><br>        <br>        cartService.addCart(skuId,num,username);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>, StatusCode.OK,<span class="hljs-string">&quot;加入购物车成功&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 查询用户购物车列表</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(value = &quot;/list&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Map <span class="hljs-title">list</span><span class="hljs-params">()</span></span>&#123;<br>        <br>        <span class="hljs-comment">//===================</span><br>        <span class="hljs-comment">//暂时静态，后续修改</span><br><span class="hljs-comment">//        String username = &quot;itcast&quot;;</span><br>        String username = tokenDecode.getUserInfo().get(<span class="hljs-string">&quot;username&quot;</span>);<br>        <span class="hljs-comment">//===================</span><br>        <br>        <span class="hljs-keyword">return</span> cartService.list(username);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h3 id="3-8-页面跳转"><a href="#3-8-页面跳转" class="headerlink" title="3.8 页面跳转"></a>3.8 页面跳转</h3><h4 id="3-9-1-未登录时登录跳转"><a href="#3-9-1-未登录时登录跳转" class="headerlink" title="3.9.1 未登录时登录跳转"></a>3.9.1 未登录时登录跳转</h4><p>在用户没有登录的情况下，直接访问购物车页面会报401(未授权错误)。</p>
<p>我们可以发现，返回的只是个错误状态码，这个毫无意义，我们应该重定向到登录页面，让用户登录，我们可以修改网关的头文件，让用户每次没登录的时候，都跳转到登录页面。</p>
<p>修改changgou-gateway-web的<code>com.changgou.filter.AuthorizeFilter</code>，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">GlobalFilter</span>, <span class="hljs-title">Ordered</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String LOGIN_URL=<span class="hljs-string">&quot;http://localhost:8001/api/oauth/toLogin&quot;</span>;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> AuthService authService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;<br>        ServerHttpRequest request = exchange.getRequest();<br>        ServerHttpResponse response = exchange.getResponse();<br><br>        <span class="hljs-comment">//1.判断当前请求路径是否为登录请求,如果是,则直接放行</span><br>        String path = request.getURI().getPath();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;/api/oauth/login&quot;</span>.equals(path) || !UrlFilter.hasAuthorize(path))&#123;<br>            <span class="hljs-comment">//直接放行</span><br>            <span class="hljs-keyword">return</span> chain.filter(exchange);<br>        &#125;<br><br>        <span class="hljs-comment">//2.从cookie中获取jti的值,如果该值不存在,拒绝本次访问</span><br>        String jti = authService.getJtiFromCookie(request);<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(jti))&#123;<br>            <span class="hljs-comment">//拒绝访问</span><br>            <span class="hljs-comment">/*response.setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="hljs-comment">            return response.setComplete();*/</span><br>            <span class="hljs-comment">//跳转登录页面</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.toLoginPage(LOGIN_URL+<span class="hljs-string">&quot;?FROM=&quot;</span>+request.getURI().getPath(),exchange);<br>        &#125;<br><br>        <span class="hljs-comment">//3.从redis中获取jwt的值,如果该值不存在,拒绝本次访问</span><br>        String jwt = authService.getJwtFromRedis(jti);<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(jwt))&#123;<br>            <span class="hljs-comment">//拒绝访问</span><br>            <span class="hljs-comment">/*response.setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="hljs-comment">            return response.setComplete();*/</span><br>            <span class="hljs-keyword">return</span>  <span class="hljs-keyword">this</span>.toLoginPage(LOGIN_URL,exchange);<br>        &#125;<br><br>        <span class="hljs-comment">//4.对当前的请求对象进行增强,让它会携带令牌的信息</span><br>        request.mutate().header(<span class="hljs-string">&quot;Authorization&quot;</span>,<span class="hljs-string">&quot;Bearer &quot;</span>+jwt);<br>        <span class="hljs-keyword">return</span> chain.filter(exchange);<br>    &#125;<br><br>    <span class="hljs-comment">//跳转登录页面</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> Mono&lt;Void&gt; <span class="hljs-title">toLoginPage</span><span class="hljs-params">(String loginUrl, ServerWebExchange exchange)</span> </span>&#123;<br>        ServerHttpResponse response = exchange.getResponse();<br>        response.setStatusCode(HttpStatus.SEE_OTHER);<br>        response.getHeaders().set(<span class="hljs-string">&quot;Location&quot;</span>,loginUrl);<br>        <span class="hljs-keyword">return</span> response.setComplete();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getOrder</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>此时再测试，就可以跳转到登录页面了。</p>
<p>访问：<a target="_blank" rel="noopener" href="http://localhost:8001/api/wcart/list">http://localhost:8001/api/wcart/list</a></p>
<h4 id="3-8-2-登录成功跳转原地址"><a href="#3-8-2-登录成功跳转原地址" class="headerlink" title="3.8.2 登录成功跳转原地址"></a>3.8.2 登录成功跳转原地址</h4><p>刚才已经实现了未登录时跳转登录页，但是当登录成功后，并没有跳转到用户本来要访问的页面。(这个功能在3.8.1已经实现了，这里熟悉下流程)</p>
<p>要实现这个功能的话，可以将用户要访问的页面作为参数传递到登录控制器，由登录控制器根据参数完成路径跳转.</p>
<ol>
<li><p>修改网关携带当前访问URI</p>
<p>修改changgou-gateway-web的<code>com.changgou.filter.AuthorizeFilter</code>，在之前的URL后面添加FROM参数以及FROM参数的值为<code>request.getURI()</code>，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//2.从cookie中获取jti的值,如果该值不存在,拒绝本次访问</span><br>String jti = authService.getJtiFromCookie(request);<br><span class="hljs-keyword">if</span> (StringUtils.isEmpty(jti))&#123;<br>    <span class="hljs-comment">//拒绝访问</span><br>    <span class="hljs-comment">/*response.setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="hljs-comment">    return response.setComplete();*/</span><br>    <span class="hljs-comment">//跳转登录页面</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.toLoginPage(LOGIN_URL+<span class="hljs-string">&quot;?FROM=&quot;</span>+request.getURI().getPath(),exchange);<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>登录控制器获取参数</p>
<p>修改changgou-user-oauth的<code>com.changgou.oauth.controller.LoginRedirect</code>记录访问来源页，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/toLogin&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toLogin</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = &quot;FROM&quot;,required = false,defaultValue = &quot;&quot;)</span> String from, Model model)</span></span>&#123;<br>    model.addAttribute(<span class="hljs-string">&quot;from&quot;</span>,from);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;login&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>修改页面，获取来源页信息，并存到from变量中，登录成功后跳转到该地址</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;script th:inline=<span class="hljs-string">&quot;javascript&quot;</span>&gt;<br>	<span class="hljs-keyword">var</span> app = <span class="hljs-keyword">new</span> Vue(&#123;<br>		<span class="hljs-attr">el</span>:<span class="hljs-string">&quot;#app&quot;</span>,<br>		<span class="hljs-attr">data</span>:&#123;<br>			<span class="hljs-attr">username</span>:<span class="hljs-string">&quot;&quot;</span>,<br>			<span class="hljs-attr">password</span>:<span class="hljs-string">&quot;&quot;</span>,<br>			<span class="hljs-attr">msg</span>:<span class="hljs-string">&quot;&quot;</span><br>		&#125;,<br>		<span class="hljs-attr">methods</span>:&#123;<br>			<span class="hljs-attr">login</span>:<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>				app.msg=<span class="hljs-string">&quot;正在登录&quot;</span>;<br>				axios.post(<span class="hljs-string">&quot;/api/oauth/login?username=&quot;</span>+app.username+<span class="hljs-string">&quot;&amp;password=&quot;</span>+app.password).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) </span>&#123;<br>					<span class="hljs-keyword">if</span> (response.data.flag)&#123;<br>						app.msg=<span class="hljs-string">&quot;登录成功&quot;</span>;<br>						location.href-app.from<br>					&#125; <span class="hljs-keyword">else</span>&#123;<br>						app.msg=<span class="hljs-string">&quot;登录失败&quot;</span>;<br>					&#125;<br>				&#125;)<br>			&#125;<br>		&#125;<br>	&#125;)<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure></li>
<li><p>测试</p>
<p>此时再测试，就可以识别未登录用户，跳转到登录页，然后根据登录状态，如果登录成功，则跳转到来源页。</p>
</li>
</ol>
<h1 id="Part11-订单"><a href="#Part11-订单" class="headerlink" title="Part11 订单"></a>Part11 订单</h1><h2 id="1-订单结算页"><a href="#1-订单结算页" class="headerlink" title="1. 订单结算页"></a>1. 订单结算页</h2><h3 id="1-1-收件地址分析"><a href="#1-1-收件地址分析" class="headerlink" title="1.1 收件地址分析"></a>1.1 收件地址分析</h3><p>用户从购物车页面点击结算，跳转到订单结算页，结算页需要加载用户对应的收件地址，如下图：</p>
<p><img src="/images/image-20210808120723726.png" srcset="/img/loading.gif" lazyload alt="image-20210808120723726"></p>
<p>表结构分析：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `tb_address` (<br>  `id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `username` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;用户名&#x27;</span>,<br>  `provinceid` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;省&#x27;</span>,<br>  `cityid` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;市&#x27;</span>,<br>  `areaid` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;县/区&#x27;</span>,<br>  `phone` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;电话&#x27;</span>,<br>  `address` <span class="hljs-type">varchar</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;详细地址&#x27;</span>,<br>  `contact` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;联系人&#x27;</span>,<br>  `is_default` <span class="hljs-type">varchar</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;是否是默认 1默认 0否&#x27;</span>,<br>  `alias` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;别名&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">66</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;<br></code></pre></td></tr></table></figure>

<p>我们可以根据用户登录名去tb_address表中查询对应的数据。</p>
<h3 id="1-2-实现用户收件地址查询"><a href="#1-2-实现用户收件地址查询" class="headerlink" title="1.2 实现用户收件地址查询"></a>1.2 实现用户收件地址查询</h3><h4 id="1-2-1-代码实现"><a href="#1-2-1-代码实现" class="headerlink" title="1.2.1 代码实现"></a>1.2.1 代码实现</h4><ol>
<li><p>业务层接口</p>
<p>修改changgou-service-user微服务，需改com.changgou.user.service.AddressService接口，添加根据用户名字查询用户收件地址信息，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 收件地址查询</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> username</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-function">List&lt;Address&gt; <span class="hljs-title">list</span><span class="hljs-params">(String username)</span></span>;<br></code></pre></td></tr></table></figure></li>
<li><p>业务层接口实现类</p>
<p>修改changgou-service-user微服务，修改impl.AddressServiceImpl类，添加根据用户查询用户收件地址信息实现方法，如下代码：</p>
<p>注意：</p>
<ul>
<li><p>不要忘了dao层的AddressMapper，是通过他才来操作数据库的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">AddressMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Mapper</span>&lt;<span class="hljs-title">Address</span>&gt; </span>&#123;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AddressServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AddressService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> AddressMapper addressMapper;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Address&gt; <span class="hljs-title">list</span><span class="hljs-params">(String username)</span> </span>&#123;<br>        Address address = <span class="hljs-keyword">new</span> Address();<br>        address.setUsername(username);<br>        List&lt;Address&gt; addressList = addressMapper.select(address);<br>        <span class="hljs-keyword">return</span> addressList;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>控制层</p>
<p>修改changgou-service-user微服务，修改AddressController，添加根据用户名查询用户收件信息方法，代码如下：</p>
<p>注意：</p>
<ul>
<li><p><code>TokenDecode</code>要自己添加到spring容器。UserApplication中创建TokenDecode,代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> TokenDecode <span class="hljs-title">tokenDecode</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">return</span>  <span class="hljs-keyword">new</span> TokenDecode();<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> TokenDecode tokenDecode;<br><br><span class="hljs-comment">/****</span><br><span class="hljs-comment"> * 用户收件地址</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(value = &quot;/list&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;List&lt;Address&gt;&gt; list()&#123;<br>    <span class="hljs-comment">//获取用户登录信息</span><br>    Map&lt;String, String&gt; userMap = tokenDecode.getUserInfo();<br>    String username = userMap.get(<span class="hljs-string">&quot;username&quot;</span>);<br>    <span class="hljs-comment">//查询用户收件地址</span><br>    List&lt;Address&gt; addressList = addressService.list(username);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>, StatusCode.OK,<span class="hljs-string">&quot;查询成功！&quot;</span>,addressList);<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>测试</p>
<p>首先进行登录：<a target="_blank" rel="noopener" href="http://localhost:8001/api/oauth/login">http://localhost:8001/api/oauth/login</a></p>
<p><img src="/images/image-20210808123905648.png" srcset="/img/loading.gif" lazyload alt="image-20210808123905648"></p>
<p>然后再进行访问 <a target="_blank" rel="noopener" href="http://localhost:8001/api/address/list">http://localhost:8001/api/address/list</a></p>
</li>
</ol>
<h3 id="1-3-页面模板渲染"><a href="#1-3-页面模板渲染" class="headerlink" title="1.3 页面模板渲染"></a>1.3 页面模板渲染</h3><p><img src="/images/image-20210808124121419.png" srcset="/img/loading.gif" lazyload alt="image-20210808124121419"></p>
<p>购物车这块也使用的是模板渲染，用户先请求经过微服务网关，微服务网关转发到订单购物车模板渲染服务，模板渲染服务调用用户微服务和订单购物车微服务查询用户收件地址和购物车清单，然后到页面显示。</p>
<h4 id="1-3-1-准备工作"><a href="#1-3-1-准备工作" class="headerlink" title="1.3.1 准备工作"></a>1.3.1 准备工作</h4><ol>
<li><p>静态资源导入</p>
<p>将资料中的<code>order.html</code>拷贝到<code>changgou-web-order</code>工程的templates中</p>
<p><img src="/images/image-20210808124632321.png" srcset="/img/loading.gif" lazyload alt="image-20210808124632321"></p>
</li>
<li><p>页面跳转实现</p>
<p>在changgou-web-order中创建<code>com.changgou.order.controller.OrderController</code>实现页面跳转，代码如下：</p>
<p><img src="/images/image-20210808130134240.png" srcset="/img/loading.gif" lazyload alt="image-20210808130134240"></p>
</li>
<li><p>网关配置</p>
<p>修改changgou-gateway-web的application.yml文件，将订单的路由过滤地址添加上去，代码如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yml">  <span class="hljs-comment">#购物车订单渲染微服务</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">changgou_order_web_route</span><br>  <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://order-web</span><br>  <span class="hljs-attr">predicates:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/wcart/**,/api/worder/**</span><br>  <span class="hljs-attr">filters:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br></code></pre></td></tr></table></figure>

<p>同时不要忘了把该地址添加到登录过滤地址中，修改<code>com.changgou.filter.URLFilter</code>，在orderFilterPath里添加<code>/api/worder/**</code>过滤</p>
</li>
</ol>
<h4 id="1-3-2-信息查询"><a href="#1-3-2-信息查询" class="headerlink" title="1.3.2 信息查询"></a>1.3.2 信息查询</h4><p>因为一会儿要调用changgou-service-user查询用户的收件地址信息，调用changgou-service-order查询购物车清单信息，所以我们需要创建Feign。购物车的Feign之前已经创建过了，所以只需要创建用户地址相关的即可。</p>
<ol>
<li><p>用户地址查询</p>
<p>在changgou-service-user-api中创建AddressFeign，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name=&quot;user&quot;)</span><br><span class="hljs-meta">@RequestMapping(&quot;/address&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">AddressFeign</span> </span>&#123;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 查询用户的收件地址信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(value = &quot;/list&quot;)</span><br>    Result&lt;List&lt;Address&gt;&gt; list();<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>查询购物车和用户收件地址信息</p>
<p>修改changgou-web-order中的<code>com.changgou.order.controller.OrderController</code>的readyOrder方法，在该方法中，使用feign调用查询收件地址信息和用户购物车信息，代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/worder&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> AddressFeign addressFeign;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CartFeign cartFeign;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/ready/order&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">readyOrder</span><span class="hljs-params">(Model model)</span></span>&#123;<br>        <span class="hljs-comment">//收件人的地址信息</span><br>        List&lt;Address&gt; addressList = addressFeign.list().getData();<br>        model.addAttribute(<span class="hljs-string">&quot;address&quot;</span>,addressList);<br><br>        <span class="hljs-comment">//购物车信息</span><br>        Map map = cartFeign.list();<br>        List&lt;OrderItem&gt; orderItemList = (List&lt;OrderItem&gt;) map.get(<span class="hljs-string">&quot;orderItemList&quot;</span>);<br>        Integer totalMoney = (Integer) map.get(<span class="hljs-string">&quot;totalMoney&quot;</span>);<br>        Integer totalNum = (Integer) map.get(<span class="hljs-string">&quot;totalNum&quot;</span>);<br><br>        model.addAttribute(<span class="hljs-string">&quot;carts&quot;</span>,orderItemList);<br>        model.addAttribute(<span class="hljs-string">&quot;totalMoney&quot;</span>,totalMoney);<br>        model.addAttribute(<span class="hljs-string">&quot;totalNum&quot;</span>,totalNum);<br><br>        <span class="hljs-comment">//默认收件人信息</span><br>        <span class="hljs-keyword">for</span> (Address address : addressList) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;1&quot;</span>.equals(address.getIsDefault()))&#123;<br>                <span class="hljs-comment">//默认收件人</span><br>                model.addAttribute(<span class="hljs-string">&quot;deAddr&quot;</span>,address);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;order&quot;</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>数据回显</p>
<p>修改order.html，回显收件地址信息和购物车信息，代码如下：</p>
<p>收件地址信息：</p>
<p><img src="/images/image-20210808131410819.png" srcset="/img/loading.gif" lazyload alt="image-20210808131410819"></p>
<p>购物车清单：</p>
<p><img src="/images/image-20210808131443336.png" srcset="/img/loading.gif" lazyload alt="image-20210808131443336"></p>
<p>测试效果：</p>
<p>基于登录过的前提下</p>
<p><img src="/images/image-20210808132559714.png" srcset="/img/loading.gif" lazyload alt="image-20210808132559714"></p>
</li>
<li><p>默认收件地址选中</p>
<p>上面所有数据都查询出来了，但是用户的收件地址全部选中了(我这里提供的是完整的代码，所以上面只选中一个)，这里应该只有默认收件地址选中。修改order.html代码如下：</p>
<p><img src="/images/image-20210808132814643.png" srcset="/img/loading.gif" lazyload alt="image-20210808132814643"></p>
<p>效果如下</p>
<p><img src="/images/image-20210808132730293.png" srcset="/img/loading.gif" lazyload alt="image-20210808132730293"></p>
</li>
</ol>
<h4 id="1-3-3-记录选中收件人"><a href="#1-3-3-记录选中收件人" class="headerlink" title="1.3.3 记录选中收件人"></a>1.3.3 记录选中收件人</h4><p>用户每次点击收件人的时候，我们需要记录收件人信息。我们可以使用Vue，定义一个订单变量，并且每次点击的时候，将该收件人信息传给Vue的一个方法在订单变量中记录选中的用户信息即可。</p>
<ol>
<li><p>引入vue</p>
<p>我们要先引入Vue,在order.html中引入vue，代码如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/js/vue.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/js/axios.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>同时在72行左右添加一个id=”app”作为Vue入口标签</p>
<p><img src="/images/image-20210808133130110.png" srcset="/img/loading.gif" lazyload alt="image-20210808133130110"></p>
</li>
<li><p>定义记录用户信息方法</p>
<p><img src="/images/image-20210808133255575.png" srcset="/img/loading.gif" lazyload alt="image-20210808133255575"></p>
<p>修改地址列表，每次点击的时候调用上面的方法，代码如下：</p>
<p><img src="/images/image-20210808133355885.png" srcset="/img/loading.gif" lazyload alt="image-20210808133355885"></p>
<p>将选中的地址收件人信息回显到页面输出，代码如下：</p>
<p><img src="/images/image-20210808133432751.png" srcset="/img/loading.gif" lazyload alt="image-20210808133432751"></p>
<p>测试效果如下：</p>
<p><img src="/images/image-20210808133512274.png" srcset="/img/loading.gif" lazyload alt="image-20210808133512274"></p>
</li>
<li><p>默认收件人加载</p>
<p>用户没有手动选择收件人信息的时候，收件人信息没有初始化。</p>
<p><img src="/images/image-20210808133559222.png" srcset="/img/loading.gif" lazyload alt="image-20210808133559222"></p>
<p>我们可以在后台加载找出默认的收件人信息，前台通过Vue直接绑定给变量即可。</p>
<p>修改<code>com.changgou.order.controller.OrderController</code>,添加默认收件人信息判断，代码如下：</p>
<p><img src="/images/image-20210808133826109.png" srcset="/img/loading.gif" lazyload alt="image-20210808133826109"></p>
<p>修改order.html，代码如下：</p>
<p><img src="/images/image-20210808133906590.png" srcset="/img/loading.gif" lazyload alt="image-20210808133906590"></p>
<p>此时页面可以正常显示用户信息了。</p>
</li>
</ol>
<h4 id="1-3-4-支付方式选中"><a href="#1-3-4-支付方式选中" class="headerlink" title="1.3.4 支付方式选中"></a>1.3.4 支付方式选中</h4><p>支付方式为线上支付和货到付款，我们可以在order变量中定义一个属性<code>payType</code>,点击线上支付让他的值为1，点击货到付款，让他的值为0即可。</p>
<p>定义变量</p>
<p><img src="/images/image-20210808134036160.png" srcset="/img/loading.gif" lazyload alt="image-20210808134036160"></p>
<p>修改页面，添加点击事件</p>
<p><img src="/images/image-20210808134118198.png" srcset="/img/loading.gif" lazyload alt="image-20210808134118198"></p>
<h2 id="2-下单"><a href="#2-下单" class="headerlink" title="2. 下单"></a>2. 下单</h2><h3 id="2-1-业务分析"><a href="#2-1-业务分析" class="headerlink" title="2.1 业务分析"></a>2.1 业务分析</h3><p>点击提交订单的时候，会立即创建订单数据，创建订单数据会将数据存入到2张表中，分别是订单表和订单明细表，此处还需要修改商品对应的库存数量。</p>
<p><img src="/images/image-20210808141232601.png" srcset="/img/loading.gif" lazyload alt="image-20210808141232601"></p>
<p>订单表结构如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `tb_order` (<br>  `id` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;订单id&#x27;</span>,<br>  `total_num` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;数量合计&#x27;</span>,<br>  `total_money` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;金额合计&#x27;</span>,<br>  `pre_money` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;优惠金额&#x27;</span>,<br>  `post_fee` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;邮费&#x27;</span>,<br>  `pay_money` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;实付金额&#x27;</span>,<br>  `pay_type` <span class="hljs-type">varchar</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;支付类型，1、在线支付、0 货到付款&#x27;</span>,<br>  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;订单创建时间&#x27;</span>,<br>  `update_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;订单更新时间&#x27;</span>,<br>  `pay_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;付款时间&#x27;</span>,<br>  `consign_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;发货时间&#x27;</span>,<br>  `end_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;交易完成时间&#x27;</span>,<br>  `close_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;交易关闭时间&#x27;</span>,<br>  `shipping_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;物流名称&#x27;</span>,<br>  `shipping_code` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;物流单号&#x27;</span>,<br>  `username` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;用户名称&#x27;</span>,<br>  `buyer_message` <span class="hljs-type">varchar</span>(<span class="hljs-number">1000</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;买家留言&#x27;</span>,<br>  `buyer_rate` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;是否评价&#x27;</span>,<br>  `receiver_contact` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;收货人&#x27;</span>,<br>  `receiver_mobile` <span class="hljs-type">varchar</span>(<span class="hljs-number">12</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;收货人手机&#x27;</span>,<br>  `receiver_address` <span class="hljs-type">varchar</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;收货人地址&#x27;</span>,<br>  `source_type` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;订单来源：1:web，2：app，3：微信公众号，4：微信小程序  5 H5手机页面&#x27;</span>,<br>  `transaction_id` <span class="hljs-type">varchar</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;交易流水号&#x27;</span>,<br>  `order_status` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;订单状态,0:未完成,1:已完成，2：已退货&#x27;</span>,<br>  `pay_status` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;支付状态,0:未支付，1：已支付，2：支付失败&#x27;</span>,<br>  `consign_status` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;发货状态,0:未发货，1：已发货，2：已收货&#x27;</span>,<br>  `is_delete` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;是否删除&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),<br>  KEY `create_time` (`create_time`),<br>  KEY `status` (`order_status`),<br>  KEY `payment_type` (`pay_type`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8_bin;<br></code></pre></td></tr></table></figure>

<p>订单明细表结构如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `tb_order_item` (<br>  `id` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;ID&#x27;</span>,<br>  `category_id1` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;1级分类&#x27;</span>,<br>  `category_id2` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;2级分类&#x27;</span>,<br>  `category_id3` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;3级分类&#x27;</span>,<br>  `spu_id` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;SPU_ID&#x27;</span>,<br>  `sku_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;SKU_ID&#x27;</span>,<br>  `order_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;订单ID&#x27;</span>,<br>  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;商品名称&#x27;</span>,<br>  `price` <span class="hljs-type">int</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;单价&#x27;</span>,<br>  `num` <span class="hljs-type">int</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;数量&#x27;</span>,<br>  `money` <span class="hljs-type">int</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;总金额&#x27;</span>,<br>  `pay_money` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;实付金额&#x27;</span>,<br>  `image` <span class="hljs-type">varchar</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;图片地址&#x27;</span>,<br>  `weight` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;重量&#x27;</span>,<br>  `post_fee` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;运费&#x27;</span>,<br>  `is_return` <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">COLLATE</span> utf8_bin <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;是否退货,0:未退货，1：已退货&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),<br>  KEY `item_id` (`sku_id`),<br>  KEY `order_id` (`order_id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8 <span class="hljs-keyword">COLLATE</span><span class="hljs-operator">=</span>utf8_bin;<br></code></pre></td></tr></table></figure>

<h3 id="2-2-下单实现"><a href="#2-2-下单实现" class="headerlink" title="2.2 下单实现"></a>2.2 下单实现</h3><p>下单的时候，先往tb_order表中增加数据，再往tb_order_item表中增加数据。</p>
<h4 id="2-2-1-代码实现"><a href="#2-2-1-代码实现" class="headerlink" title="2.2.1 代码实现"></a>2.2.1 代码实现</h4><p>这里先修改changgou-service-order微服务，实现下单操作，这里会生成订单号，我们首先需要在启动类中创建一个IdWorker对象。</p>
<p>在<code>com.changgou.OrderApplication</code>中创建IdWorker，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> IdWorker <span class="hljs-title">idWorker</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> IdWorker(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<ol>
<li><p>业务层实现类</p>
<p>实现逻辑：</p>
<ol>
<li>获取所有购物项</li>
<li>统计计算：总金额，总数量</li>
<li>填充订单数据并保存</li>
<li>获取每一个购物项保存到orderItem</li>
<li>删除购物车中数据</li>
</ol>
<p>修改订单微服务添加com.changgou.order.service.impl.OrderServiceImpl,代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">(Order order)</span></span>&#123;<br>    <span class="hljs-comment">//1)获取所有购物项</span><br>    Map cartMap = cartService.list(order.getUsername());<br>    List&lt;OrderItem&gt; orderItemList = (List&lt;OrderItem&gt;) cartMap.get(<span class="hljs-string">&quot;orderItemList&quot;</span>);<br>    <span class="hljs-comment">//3）填充订单数据并保存</span><br>    order.setTotalNum((Integer) cartMap.get(<span class="hljs-string">&quot;totalNum&quot;</span>));<br>    order.setTotalMoney((Integer) cartMap.get(<span class="hljs-string">&quot;totalMoney&quot;</span>));<br>    order.setPayMoney((Integer) cartMap.get(<span class="hljs-string">&quot;totalMoney&quot;</span>));<br>    order.setCreateTime(<span class="hljs-keyword">new</span> Date());<br>    order.setUpdateTime(order.getCreateTime());<br>    order.setBuyerRate(<span class="hljs-string">&quot;0&quot;</span>);        <span class="hljs-comment">//0:未评价，1：已评价</span><br>    order.setSourceType(<span class="hljs-string">&quot;1&quot;</span>);       <span class="hljs-comment">//来源，1：WEB</span><br>    order.setOrderStatus(<span class="hljs-string">&quot;0&quot;</span>);      <span class="hljs-comment">//0:未完成,1:已完成，2：已退货</span><br>    order.setPayStatus(<span class="hljs-string">&quot;0&quot;</span>);        <span class="hljs-comment">//0:未支付，1：已支付，2：支付失败</span><br>    order.setConsignStatus(<span class="hljs-string">&quot;0&quot;</span>);    <span class="hljs-comment">//0:未发货，1：已发货，2：已收货</span><br>    order.setId(idWorker.nextId()+<span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-keyword">int</span> count = orderMapper.insertSelective(order);<br>   <br>    <span class="hljs-comment">//添加订单明细</span><br>    <span class="hljs-keyword">for</span> (OrderItem orderItem : orderItemList) &#123;<br>        orderItem.setId(idWorker.nextId()+<span class="hljs-string">&quot;&quot;</span>);<br>        orderItem.setIsReturn(<span class="hljs-string">&quot;0&quot;</span>);<br>        orderItem.setOrderId(order.getId());<br>        orderItemMapper.insertSelective(orderItem);<br>    &#125;<br>   <br>    <span class="hljs-comment">//清除Redis缓存购物车数据</span><br>    redisTemplate.delete(<span class="hljs-string">&quot;Cart_&quot;</span>+order.getUsername());<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>控制层</p>
<p>修改changgou-service-order微服务，修改com.changgou.order.controller.OrderController类，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 新增Order数据</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> order</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@PostMapping</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Order order)</span></span>&#123;<br>    <span class="hljs-comment">//获取用户名</span><br>    Map&lt;String, String&gt; userMap = tokenDecode.getUserInfo();<br>    String username = userMap.get(<span class="hljs-string">&quot;username&quot;</span>);<br>    <span class="hljs-comment">//设置购买用户</span><br>    order.setUsername(username);<br>    orderService.add(order);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>,StatusCode.OK,<span class="hljs-string">&quot;添加成功&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h4 id="2-2-2-渲染服务对接"><a href="#2-2-2-渲染服务对接" class="headerlink" title="2.2.2 渲染服务对接"></a>2.2.2 渲染服务对接</h4><p><img src="/images/image-20210808140007275-1628403167768.png" srcset="/img/loading.gif" lazyload alt="image-20210808140007275"></p>
<p>我们需要在模板渲染端调用订单微服务实现下单操作,下单操作需要调用订单微服务，所以需要创建对应的Feign。(前面我已经创建好了，这里再来过一遍流程)</p>
<ol>
<li><p>Feign创建</p>
<p>修改changgou-service-order-api，添加OrderFeign，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name = &quot;order&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">OrderFeign</span> </span>&#123;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/order&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Order order)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>下单调用</p>
<p>修改changgou-web-order的<code>com.changgou.order.controller.OrderController</code>添加下单方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> OrderFeign orderFeign;<br><br><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 添加订单数据到购物车中</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> order</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@PostMapping(value = &quot;/add&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Order order)</span></span>&#123;<br>   Result result = orderFeign.add(order);<br>   <span class="hljs-keyword">return</span>  result;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>页面调用</p>
<p>修改order.html，增加下单js方法，并且在页面点击下单调用，代码如下：</p>
<p><img src="/images/image-20210808141545746.png" srcset="/img/loading.gif" lazyload alt="image-20210808141545746"></p>
<p>点击提交订单调用</p>
<p><img src="/images/image-20210808141647120.png" srcset="/img/loading.gif" lazyload alt="image-20210808141647120"></p>
<p>保存订单测试，注意观察tb_order表数据以及tb_order_item表数据的变化</p>
</li>
</ol>
<h3 id="2-3-库存变更"><a href="#2-3-库存变更" class="headerlink" title="2.3 库存变更"></a>2.3 库存变更</h3><h4 id="2-3-1-业务分析"><a href="#2-3-1-业务分析" class="headerlink" title="2.3.1 业务分析"></a>2.3.1 业务分析</h4><p>上面操作只实现了下单操作，但对应的库存还没跟着一起减少，我们在下单之后，应该调用商品微服务，将下单的商品库存减少，销量增加。每次订单微服务只需要将用户名传到商品微服务，商品微服务通过用户名到Redis中查询对应的购物车数据，然后执行库存减少，库存减少需要控制当前商品库存&gt;=销售数量。</p>
<p><img src="/images/image-20210808141928494.png" srcset="/img/loading.gif" lazyload alt="image-20210808141928494"></p>
<p>如何控制库存数量&gt;=购买数量呢？其实可以通过SQL语句实现，每次减少数量之前，加个条件判断。</p>
<p><code>where num&gt;=#&#123;num&#125;</code>即可。</p>
<p>商品服务需要查询购物车数据，所以需要引入订单的api，在pom.xml中添加如下依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--order api 依赖--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.changgou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>changgou_service_order_api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-2-代码实现-1"><a href="#2-3-2-代码实现-1" class="headerlink" title="2.3.2 代码实现"></a>2.3.2 代码实现</h4><p>要调用其他微服务，需要将头文件中的令牌数据携带到其他微服务中取，所以我们不能使用hystrix的多线程模式，修改changgou-service-order的applicatin.yml配置，代码如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment">#hystrix 配置</span><br><span class="hljs-attr">hystrix:</span><br>  <span class="hljs-attr">command:</span><br>    <span class="hljs-attr">default:</span><br>      <span class="hljs-attr">execution:</span><br>        <span class="hljs-attr">isolation:</span><br>          <span class="hljs-attr">thread:</span><br>            <span class="hljs-attr">timeoutInMilliseconds:</span> <span class="hljs-number">10000</span><br>          <span class="hljs-attr">strategy:</span> <span class="hljs-string">SEMAPHORE</span><br></code></pre></td></tr></table></figure>

<p>每次还需要使用拦截器添加头文件信息，修改配置类com.changgou.OrderApplication添加拦截器，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> FeignInterceptor <span class="hljs-title">feignInterceptor</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> FeignInterceptor();<br>&#125;<br></code></pre></td></tr></table></figure>

<ol>
<li><p>dao层</p>
<p>修改changgou-service-goods微服务的<code>com.changgou.goods.dao.SkuMapper</code>接口，增加库存递减方法,代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 递减库存</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> orderItem</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Update(&quot;UPDATE tb_sku SET num=num-#&#123;num&#125;,sale_num=sale_num+#&#123;num&#125; WHERE id=#&#123;skuId&#125; AND num&gt;=#&#123;num&#125;&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">decrCount</span><span class="hljs-params">(OrderItem orderItem)</span></span>;<br></code></pre></td></tr></table></figure></li>
<li><p>业务层</p>
<p>修改changgou-service-goods微服务的<code>com.changgou.goods.service.SkuService</code>接口，添加如下方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 库存递减</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> username</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">decrCount</span><span class="hljs-params">(String username)</span></span>;<br></code></pre></td></tr></table></figure>

<p>修改changgou-service-order微服务的<code>com.changgou.goods.service.impl.SkuServiceImpl</code>实现类，添加一个实现方法，代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 库存递减</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> username</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">decrCount</span><span class="hljs-params">(String username)</span> </span>&#123;<br>    <span class="hljs-comment">//获取购物车数据</span><br>    List&lt;OrderItem&gt; orderItems = redisTemplate.boundHashOps(<span class="hljs-string">&quot;Cart_&quot;</span> + username).values();<br><br>    <span class="hljs-comment">//循环递减</span><br>    <span class="hljs-keyword">for</span> (OrderItem orderItem : orderItems) &#123;<br>        <span class="hljs-comment">//递减库存</span><br>        <span class="hljs-keyword">int</span> count = skuMapper.decrCount(orderItem);<br>        <span class="hljs-keyword">if</span>(count&lt;=<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;库存不足，递减失败！&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>控制层</p>
<p>修改changgou-service-goods的<code>com.changgou.goods.controller.SkuController</code>类，添加库存递减方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 库存递减</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> username</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@PostMapping(value = &quot;/decr/count&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">decrCount</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;username&quot;)</span> String username)</span></span>&#123;<br>    <span class="hljs-comment">//库存递减</span><br>    skuService.decrCount(username);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>,StatusCode.OK,<span class="hljs-string">&quot;库存递减成功！&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>创建Feign</p>
<p>同时在changgou-service-goods-api工程添加<code>com.changgou.goods.feign.SkuFeign</code>的实现，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 库存递减</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> username</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@PostMapping(value = &quot;/decr/count&quot;)</span><br><span class="hljs-function">Result <span class="hljs-title">decrCount</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = &quot;username&quot;)</span> String username)</span></span>;<br></code></pre></td></tr></table></figure></li>
</ol>
<h4 id="2-3-3-调用库存递减"><a href="#2-3-3-调用库存递减" class="headerlink" title="2.3.3 调用库存递减"></a>2.3.3 调用库存递减</h4><p>修改changgou-service-order微服务的com.changgou.order.service.impl.OrderServiceImpl类的add方法，增加库存递减的调用。</p>
<p>先注入SkuFeign</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> SkuFeign skuFeign;<br></code></pre></td></tr></table></figure>

<p>再在调用库存递减方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 增加</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> order</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">(Order order)</span></span>&#123;<br>    <span class="hljs-comment">//1)获取所有购物项</span><br>    Map cartMap = cartService.list(order.getUsername());<br>    List&lt;OrderItem&gt; orderItemList = (List&lt;OrderItem&gt;) cartMap.get(<span class="hljs-string">&quot;orderItemList&quot;</span>);<br>    <span class="hljs-comment">//3）填充订单数据并保存</span><br>    order.setTotalNum((Integer) cartMap.get(<span class="hljs-string">&quot;totalNum&quot;</span>));<br>    order.setTotalMoney((Integer) cartMap.get(<span class="hljs-string">&quot;totalMoney&quot;</span>));<br>    order.setPayMoney((Integer) cartMap.get(<span class="hljs-string">&quot;totalMoney&quot;</span>));<br>    order.setCreateTime(<span class="hljs-keyword">new</span> Date());<br>    order.setUpdateTime(order.getCreateTime());<br>    order.setBuyerRate(<span class="hljs-string">&quot;0&quot;</span>);        <span class="hljs-comment">//0:未评价，1：已评价</span><br>    order.setSourceType(<span class="hljs-string">&quot;1&quot;</span>);       <span class="hljs-comment">//来源，1：WEB</span><br>    order.setOrderStatus(<span class="hljs-string">&quot;0&quot;</span>);      <span class="hljs-comment">//0:未完成,1:已完成，2：已退货</span><br>    order.setPayStatus(<span class="hljs-string">&quot;0&quot;</span>);        <span class="hljs-comment">//0:未支付，1：已支付，2：支付失败</span><br>    order.setConsignStatus(<span class="hljs-string">&quot;0&quot;</span>);    <span class="hljs-comment">//0:未发货，1：已发货，2：已收货</span><br>    order.setId(idWorker.nextId()+<span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-keyword">int</span> count = orderMapper.insertSelective(order);<br><br>    <span class="hljs-comment">//添加订单明细</span><br>    <span class="hljs-keyword">for</span> (OrderItem orderItem : orderItemList) &#123;<br>        orderItem.setId(idWorker.nextId()+<span class="hljs-string">&quot;&quot;</span>);<br>        orderItem.setIsReturn(<span class="hljs-string">&quot;0&quot;</span>);<br>        orderItem.setOrderId(order.getId());<br>        orderItemMapper.insertSelective(orderItem);<br>    &#125;<br><br>    <span class="hljs-comment">//==================</span><br>    <span class="hljs-comment">//库存减库存</span><br>    skuFeign.decrCount(order.getUsername());<br>    <span class="hljs-comment">//==================</span><br><br>    <span class="hljs-comment">//清除Redis缓存购物车数据</span><br>    redisTemplate.delete(<span class="hljs-string">&quot;Cart_&quot;</span>+order.getUsername());<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2-3-4-测试"><a href="#2-3-4-测试" class="headerlink" title="2.3.4 测试"></a>2.3.4 测试</h4><p>库存减少前，查询数据库Sku数据如下：个数98，销量0</p>
<p>使用Postman执行 <a target="_blank" rel="noopener" href="http://localhost:8001/api/order/add">http://localhost:8001/api/order/add</a></p>
<p>执行测试后，剩余库存97，销量1</p>
<h3 id="2-4-增加积分"><a href="#2-4-增加积分" class="headerlink" title="2.4 增加积分"></a>2.4 增加积分</h3><p>比如每次下单完成之后，给用户增加10个积分，支付完成后赠送优惠券，优惠券可用于支付时再次抵扣。我们先完成增加积分功能。如下表：points表示用户积分</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `tb_user` (<br>  `username` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;用户名&#x27;</span>,<br>  `password` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;密码，加密存储&#x27;</span>,<br>  `phone` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;注册手机号&#x27;</span>,<br>  `email` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;注册邮箱&#x27;</span>,<br>  `created` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;创建时间&#x27;</span>,<br>  `updated` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;修改时间&#x27;</span>,<br>  `source_type` <span class="hljs-type">varchar</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;会员来源：1:PC，2：H5，3：Android，4：IOS&#x27;</span>,<br>  `nick_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;昵称&#x27;</span>,<br>  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;真实姓名&#x27;</span>,<br>  `status` <span class="hljs-type">varchar</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;使用状态（1正常 0非正常）&#x27;</span>,<br>  `head_pic` <span class="hljs-type">varchar</span>(<span class="hljs-number">150</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;头像地址&#x27;</span>,<br>  `qq` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;QQ号码&#x27;</span>,<br>  `is_mobile_check` <span class="hljs-type">varchar</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0&#x27;</span> COMMENT <span class="hljs-string">&#x27;手机是否验证 （0否  1是）&#x27;</span>,<br>  `is_email_check` <span class="hljs-type">varchar</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;0&#x27;</span> COMMENT <span class="hljs-string">&#x27;邮箱是否检测（0否  1是）&#x27;</span>,<br>  `sex` <span class="hljs-type">varchar</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;1&#x27;</span> COMMENT <span class="hljs-string">&#x27;性别，1男，0女&#x27;</span>,<br>  `user_level` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;会员等级&#x27;</span>,<br>  `points` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;积分&#x27;</span>,<br>  `experience_value` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;经验值&#x27;</span>,<br>  `birthday` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;出生年月日&#x27;</span>,<br>  `last_login_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;最后登录时间&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`username`),<br>  <span class="hljs-keyword">UNIQUE</span> KEY `username` (`username`) <span class="hljs-keyword">USING</span> BTREE<br>) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8 COMMENT<span class="hljs-operator">=</span><span class="hljs-string">&#x27;用户表&#x27;</span>;<br></code></pre></td></tr></table></figure>

<h4 id="2-4-1-代码实现"><a href="#2-4-1-代码实现" class="headerlink" title="2.4.1 代码实现"></a>2.4.1 代码实现</h4><ol>
<li><p>dao层</p>
<p>修改changgou-service-user微服务的<code>com.changgou.user.dao.UserMapper</code>接口，增加用户积分方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 增加用户积分</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> username</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pint</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Update(&quot;UPDATE tb_user SET points=points+#&#123;point&#125; WHERE  username=#&#123;username&#125;&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">addUserPoints</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;username&quot;)</span> String username, <span class="hljs-meta">@Param(&quot;point&quot;)</span> Integer pint)</span></span>;<br></code></pre></td></tr></table></figure></li>
<li><p>业务层</p>
<p>修改changgou-service-user微服务的<code>com.changgou.user.service.UserService</code>接口，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 添加用户积分</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> username</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pint</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">addUserPoints</span><span class="hljs-params">(String username,Integer pint)</span></span>;<br></code></pre></td></tr></table></figure>

<p>修改changgou-service-user微服务的<code>com.changgou.user.service.impl.UserServiceImpl</code>，增加添加积分方法实现，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 修改用户积分</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> username</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pint</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">addUserPoints</span><span class="hljs-params">(String username, Integer pint)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> userMapper.addUserPoints(username,pint);<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>控制层</p>
<p>修改changgou-service-user微服务的<code>com.changgou.user.controller.UserController</code>，添加增加用户积分方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> TokenDecode tokenDecode;<br><br><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 增加用户积分</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> points:要添加的积分</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(value = &quot;/points/add&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">addPoints</span><span class="hljs-params">(Integer points)</span></span>&#123;<br>    <span class="hljs-comment">//获取用户名</span><br>    Map&lt;String, String&gt; userMap = tokenDecode.getUserInfo();<br>    String username = userMap.get(<span class="hljs-string">&quot;username&quot;</span>);<br><br>    <span class="hljs-comment">//添加积分</span><br>    userService.addUserPoints(username,points);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>,StatusCode.OK,<span class="hljs-string">&quot;添加积分成功！&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>Feign添加</p>
<p>修改changgou-service-user-api工程，修改<code>com.changgou.user.feign.UserFeign</code>，添加增加用户积分方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 添加用户积分</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> points</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(value = &quot;/points/add&quot;)</span><br><span class="hljs-function">Result <span class="hljs-title">addPoints</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = &quot;points&quot;)</span>Integer points)</span></span>;<br></code></pre></td></tr></table></figure></li>
</ol>
<h4 id="2-4-2-增加积分调用"><a href="#2-4-2-增加积分调用" class="headerlink" title="2.4.2 增加积分调用"></a>2.4.2 增加积分调用</h4><p>修改changgou-service-order，添加changgou-service-user-api的依赖，修改pom.xml,添加如下依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--user api 依赖--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.changgou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>changgou_service_user_api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>在增加订单的时候，同时添加用户积分，修改changgou-service-order微服务的<code>com.changgou.order.service.impl.OrderServiceImpl</code>下单方法，增加调用添加积分方法，代码如下：</p>
<p><img src="/images/image-20210808210321063.png" srcset="/img/loading.gif" lazyload alt="image-20210808210321063"></p>
<p>修改changgou-service-order的启动类<code>com.changgou.OrderApplication</code>，添加feign的包路径：</p>
<p><img src="/images/image-20210808210556231.png" srcset="/img/loading.gif" lazyload alt="image-20210808210556231"></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE/">畅购商城项目</a>
                    
                  </div>
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/07/29/1.6%20%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E7%AC%AC%E5%85%AD%E9%83%A8%E5%88%86/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">畅购商城项目第六部分</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/07/28/1.4%20%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86/">
                        <span class="hidden-mobile">畅购商城项目第四部分</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>



  <script  src="/js/local-search.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
