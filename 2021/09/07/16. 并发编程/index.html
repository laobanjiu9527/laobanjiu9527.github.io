

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/Lsh.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="暂无摘要">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
  <title>并发编程 - laobanjiu</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"laobanjiu9527.github.io","root":"/","version":"1.8.11","typing":{"enable":true,"typeSpeed":70,"cursorChar":" ","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>老斑鸠</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/snoopy3.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="并发编程">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-09-07 22:41" pubdate>
        2021年9月7日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      10k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      144
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">并发编程</h1>
            
            <div class="markdown-body">
              <h1 id="Java-线程"><a href="#Java-线程" class="headerlink" title="Java 线程"></a>Java 线程</h1><h2 id="1-创建和运行线程"><a href="#1-创建和运行线程" class="headerlink" title="1. 创建和运行线程"></a>1. 创建和运行线程</h2><h3 id="1-1-直接使用Thread"><a href="#1-1-直接使用Thread" class="headerlink" title="1.1 直接使用Thread"></a>1.1 直接使用Thread</h3><p>创建新线程并重写里面的run()方法</p>
<p>注意：</p>
<ul>
<li>开启一个线程用的是start()方法，如果调用线程的run()方法，此时并未开启新线程，而是执行普通的run()方法。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestMultiThread</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Thread t1 = <span class="hljs-keyword">new</span> Thread(<span class="hljs-string">&quot;t1&quot;</span>)&#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>                log.debug(<span class="hljs-string">&quot;t1 running&quot;</span>);<br>            &#125;<br>        &#125;;<br><br>        t1.start();<br>        log.debug(<span class="hljs-string">&quot;main running&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">13</span>:<span class="hljs-number">15</span>:<span class="hljs-number">29.164</span> c<span class="hljs-selector-class">.TestMultiThread</span> <span class="hljs-selector-attr">[main]</span> - <span class="hljs-selector-tag">main</span> running<br><span class="hljs-number">13</span>:<span class="hljs-number">15</span>:<span class="hljs-number">29.164</span> c<span class="hljs-selector-class">.TestMultiThread</span> <span class="hljs-selector-attr">[t1]</span> - t1 running<br></code></pre></td></tr></table></figure>

<h3 id="1-2-使用-Runnable-接口配合-Thread"><a href="#1-2-使用-Runnable-接口配合-Thread" class="headerlink" title="1.2 使用 Runnable 接口配合 Thread"></a>1.2 <strong>使用</strong> <strong>Runnable</strong> 接口配合 Thread</h3><p>这种方法的好处：</p>
<ol>
<li>用 Runnable 更容易与线程池等高级 API 配合</li>
<li>用 Runnable 让任务类脱离了 Thread 继承体系，更灵活</li>
</ol>
<p>把线程和任务（要执行的代码）分开</p>
<ul>
<li><p>Thread 代表线程</p>
</li>
<li><p>Runnable 可运行的任务（线程要执行的代码）</p>
</li>
</ul>
<p>注意</p>
<ul>
<li>创建<code>Runnable</code>对象以后，把它作为参数赋值给线程的构造方法，同时给线程命好名。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j(topic = &quot;c.Test2&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test2</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Runnable runnable = <span class="hljs-keyword">new</span> Runnable() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>                log.debug(<span class="hljs-string">&quot;runnable running&quot;</span>);<br>            &#125;<br>        &#125;;<br><br>        Thread t1 = <span class="hljs-keyword">new</span> Thread(runnable, <span class="hljs-string">&quot;t1&quot;</span>);<br>        t1.start();<br>        log.debug(<span class="hljs-string">&quot;main running&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">13</span>:<span class="hljs-number">28</span>:<span class="hljs-number">39.782</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[t1]</span> - runnable running<br><span class="hljs-number">13</span>:<span class="hljs-number">28</span>:<span class="hljs-number">39.782</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[main]</span> - <span class="hljs-selector-tag">main</span> running<br></code></pre></td></tr></table></figure>

<h3 id="1-3-使用-FutureTask-接口配合-Thread"><a href="#1-3-使用-FutureTask-接口配合-Thread" class="headerlink" title="1.3 使用 FutureTask 接口配合 Thread"></a>1.3 <strong>使用</strong> FutureTask 接口配合 Thread</h3><p>用来处理有返回结果的情况</p>
<p>注意</p>
<ul>
<li><p><code>FutureTask&lt;Integer&gt; futureTask = new FutureTask&lt;Integer&gt;(Callable&lt;V&gt; callable)</code></p>
</li>
<li><p>这里的lambda表达式其实是一个实现了Callable中的call() 方法的一个对象</p>
</li>
<li><p>Callable接口中只有call() 一个抽象方法</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j(topic = &quot;c.Test2&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test2</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException </span>&#123;<br>        FutureTask&lt;Integer&gt; futureTask = <span class="hljs-keyword">new</span> FutureTask&lt;Integer&gt;(<br>                ()-&gt;&#123;<br>                    log.debug(<span class="hljs-string">&quot;futuretask running.&quot;</span>);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-number">100</span>;<br>                &#125;<br>        );<br><br>        <span class="hljs-comment">//这里如果t1线程不执行的话，后面的主线程由于拿不到结果，会陷入阻塞状态。</span><br>        <span class="hljs-keyword">new</span> Thread(futureTask, <span class="hljs-string">&quot;t1&quot;</span>).start();<br><br>        <span class="hljs-keyword">int</span> result;<br>        result = futureTask.get();<br>        log.debug(<span class="hljs-string">&quot;结果是：&#123;&#125;&quot;</span>, result);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">13</span>:<span class="hljs-number">44</span>:<span class="hljs-number">37</span>.<span class="hljs-number">711</span> c.Test<span class="hljs-number">2</span><span class="hljs-meta"> [t1] - futuretask running.</span><br><span class="hljs-meta">13:44:37.727 c.Test2 [main] - 结果是：100</span><br></code></pre></td></tr></table></figure>

<h2 id="2-线程常见方法"><a href="#2-线程常见方法" class="headerlink" title="2. 线程常见方法"></a>2. 线程常见方法</h2><h3 id="2-1-start-与-run-方法"><a href="#2-1-start-与-run-方法" class="headerlink" title="2.1 start 与 run 方法"></a>2.1 start 与 run 方法</h3><ul>
<li><p>直接调用 run 是在主线程中执行了 run 方法，没有启动新的线程</p>
</li>
<li><p>使用 start 是启动新的线程，通过新的线程间接执行 run 方法中的代码</p>
</li>
</ul>
<h3 id="2-2-sleep-与-yield-方法"><a href="#2-2-sleep-与-yield-方法" class="headerlink" title="2.2 sleep 与 yield 方法"></a>2.2 sleep 与 yield 方法</h3><p>都会让出时间片</p>
<p><strong>sleep</strong></p>
<ol>
<li>调用 sleep 会让当前线程从 <em>Running</em> 进入 <em>Timed Waiting</em> 状态（阻塞）</li>
<li>其它线程可以使用 interrupt 方法打断正在睡眠的线程，这时 sleep 方法会抛出 InterruptedException</li>
<li>睡眠结束后的线程未必会立刻得到执行 (需要有时间片才行)</li>
<li>建议用 TimeUnit 的 sleep 代替 Thread 的 sleep 来获得更好的可读性</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test2</span> </span>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> r = <span class="hljs-number">0</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        test1();<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test1</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br><br>        log.debug(<span class="hljs-string">&quot;开始&quot;</span>);<br>        Thread t1 = <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;开始&quot;</span>);<br>            <span class="hljs-keyword">try</span> &#123;<br>                sleep(<span class="hljs-number">1</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            log.debug(<span class="hljs-string">&quot;结束&quot;</span>);<br>            r = <span class="hljs-number">10</span>;<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br><br>        t1.start();<br>        log.debug(<span class="hljs-string">&quot;结果为:&#123;&#125;&quot;</span>, r);<br>        log.debug(<span class="hljs-string">&quot;结束&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<p>这俩线程是并行执行的，所以对于临界资源r的值，由于t1线程睡了1ms，所以此时结果仍为0。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">14</span>:<span class="hljs-number">35</span>:<span class="hljs-number">09.534</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[main]</span> - 开始<br><span class="hljs-number">14</span>:<span class="hljs-number">35</span>:<span class="hljs-number">09.537</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[t1]</span> - 开始<br><span class="hljs-number">14</span>:<span class="hljs-number">35</span>:<span class="hljs-number">09.538</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[t1]</span> - 结束<br><span class="hljs-number">14</span>:<span class="hljs-number">35</span>:<span class="hljs-number">09.537</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[main]</span> - 结果为:<span class="hljs-number">0</span><br><span class="hljs-number">14</span>:<span class="hljs-number">35</span>:<span class="hljs-number">09.538</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[main]</span> - 结束<br></code></pre></td></tr></table></figure>

<p>如果让主线程睡眠一个更久的时间，结果会变成10。</p>
<p><strong>yield</strong></p>
<ol>
<li>调用 yield 会让当前线程从 <em>Running</em> 进入 <em>Runnable</em> 就绪状态，然后调度执行其它线程。（让出时间片）</li>
<li>具体的实现依赖于操作系统的任务调度器</li>
</ol>
<p><strong>线程优先级</strong></p>
<ol>
<li>线程优先级会提示（hint）调度器优先调度该线程，但它仅仅是一个提示，调度器可以忽略它</li>
<li>如果 cpu 比较忙，那么优先级高的线程会获得更多的时间片，但 cpu 闲时，优先级几乎没作用</li>
</ol>
<h3 id="2-3-join-方法"><a href="#2-3-join-方法" class="headerlink" title="2.3 join 方法"></a>2.3 join 方法</h3><p>用来进行线程同步的</p>
<p><code>t1.join()</code>在代码中表示等待，t1线程执行完，再执行后面的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test2</span> </span>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> r = <span class="hljs-number">0</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        test1();<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test1</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br><br>        log.debug(<span class="hljs-string">&quot;开始&quot;</span>);<br>        Thread t1 = <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;开始&quot;</span>);<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">100</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            log.debug(<span class="hljs-string">&quot;结束&quot;</span>);<br>            r = <span class="hljs-number">10</span>;<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br><br>        t1.start();<br>        <br>        t1.join();<br>        log.debug(<span class="hljs-string">&quot;结果为:&#123;&#125;&quot;</span>, r);<br>        log.debug(<span class="hljs-string">&quot;结束&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<p>注意</p>
<ul>
<li>虽然t1线程阻塞了100ms，但是由于在主线程代码中调用了<code>t1.join()</code>，必须等t1执行完了，主线程才能执行后面的代码，所以输出的结果一直都是10</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">19</span>:<span class="hljs-number">55</span>:<span class="hljs-number">29.366</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[main]</span> - 开始<br><span class="hljs-number">19</span>:<span class="hljs-number">55</span>:<span class="hljs-number">29.369</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[t1]</span> - 开始<br><span class="hljs-number">19</span>:<span class="hljs-number">55</span>:<span class="hljs-number">29.481</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[t1]</span> - 结束<br><span class="hljs-number">19</span>:<span class="hljs-number">55</span>:<span class="hljs-number">29.481</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[main]</span> - 结果为:<span class="hljs-number">10</span><br><span class="hljs-number">19</span>:<span class="hljs-number">55</span>:<span class="hljs-number">29.483</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[main]</span> - 结束<br></code></pre></td></tr></table></figure>

<h3 id="2-4-interrupt-方法"><a href="#2-4-interrupt-方法" class="headerlink" title="2.4 interrupt 方法"></a>2.4 interrupt 方法</h3><p>使用 interrupt 方法打断阻塞的线程，打断标记会变为false。打断正常运行的线程，打断标记会变成true。以 sleep 线程为例</p>
<ol>
<li><p>打断 sleep 的线程, 会抛出异常，并且会清空打断状态。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test2</span> </span>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> r = <span class="hljs-number">0</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        Thread t1 = <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                sleep(<span class="hljs-number">2</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br>        t1.start();<br>        sleep(<span class="hljs-number">1</span>);<br>        t1.interrupt();<br>        log.debug(<span class="hljs-string">&quot; 打断状态: &#123;&#125;&quot;</span>, t1.isInterrupted());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs oxygene"><span class="hljs-number">20</span>:<span class="hljs-number">15</span>:<span class="hljs-number">46.760</span> c.Test2 [main] -  打断状态: <span class="hljs-keyword">false</span><br>java.lang.InterruptedException: sleep interrupted<br>	at java.base/java.lang.Thread.sleep(Native <span class="hljs-function"><span class="hljs-keyword">Method</span>)</span><br><span class="hljs-function">	<span class="hljs-title">at</span> <span class="hljs-title">Test2</span>.<span class="hljs-title">lambda</span>$<span class="hljs-title">main</span>$0<span class="hljs-params">(Test2.java:14)</span></span><br><span class="hljs-function">	<span class="hljs-title">at</span> <span class="hljs-title">java</span>.<span class="hljs-title">base</span>/<span class="hljs-title">java</span>.<span class="hljs-title">lang</span>.<span class="hljs-title">Thread</span>.<span class="hljs-title">run</span><span class="hljs-params">(Thread.java:844)</span></span><br></code></pre></td></tr></table></figure></li>
<li><p>打断正常运行的线程, 不会清空打断状态</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test2</span> </span>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> r = <span class="hljs-number">0</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        Thread t1 = <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            log.debug(<span class="hljs-string">&quot;t1 running&quot;</span>);<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br>        t1.start();<br>        sleep(<span class="hljs-number">2</span>);<br>        t1.interrupt();<br>        log.debug(<span class="hljs-string">&quot; 打断状态: &#123;&#125;&quot;</span>, t1.isInterrupted());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">20</span>:<span class="hljs-number">19</span>:<span class="hljs-number">03.195</span> c.Test2 [t1] - t1 running<br><span class="hljs-number">20</span>:<span class="hljs-number">19</span>:<span class="hljs-number">03.196</span> c.Test2 [main] -  打断状态: <span class="hljs-keyword">true</span><br></code></pre></td></tr></table></figure></li>
<li><p>打断 park 线程</p>
<p>park 虽然也是用来阻塞线程的，但他和前面几个阻塞线程的方法并不一样。他不是Thread的方法。打断 park 线程, 不会清空打断状态</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test2</span> </span>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> r = <span class="hljs-number">0</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        Thread t1 = <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;park...&quot;</span>);<br>            LockSupport.park();<br>            log.debug(<span class="hljs-string">&quot;unpark...&quot;</span>);<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br>        t1.start();<br>        sleep(<span class="hljs-number">5</span>);<br>        t1.interrupt();<br>        log.debug(<span class="hljs-string">&quot; 打断状态: &#123;&#125;&quot;</span>, t1.isInterrupted());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">20</span>:<span class="hljs-number">23</span>:<span class="hljs-number">01.550</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[t1]</span> - park...<br><span class="hljs-number">20</span>:<span class="hljs-number">23</span>:<span class="hljs-number">01.553</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[t1]</span> - unpark...<br><span class="hljs-number">20</span>:<span class="hljs-number">23</span>:<span class="hljs-number">01.553</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[main]</span> -  打断状态: true<br></code></pre></td></tr></table></figure>

<p>当打断状态变为true时，park方法就失效了，即他阻塞不了这个线程了。</p>
</li>
</ol>
<h2 id="3-运行状态"><a href="#3-运行状态" class="headerlink" title="3. 运行状态"></a>3. 运行状态</h2><h3 id="3-1-操作系统层面"><a href="#3-1-操作系统层面" class="headerlink" title="3.1 操作系统层面"></a>3.1 操作系统层面</h3><p>5 种状态</p>
<p><img src="/images/image-20210908202818685.png" srcset="/img/loading.gif" lazyload alt="image-20210908202818685"></p>
<h3 id="3-2-Java-api-层面"><a href="#3-2-Java-api-层面" class="headerlink" title="3.2 Java api 层面"></a>3.2 Java api 层面</h3><p>6 种状态</p>
<p><img src="/images/image-20210908203010615.png" srcset="/img/loading.gif" lazyload alt="image-20210908203010615"></p>
<ul>
<li><p>NEW：线程刚被创建，但是还没有调用 start() 方法</p>
</li>
<li><p>RUNNABLE：当调用了 start() 方法之后，注意，<strong>Java API</strong> 层面的 RUNNABLE 状态涵盖了 <strong>操作系统</strong> 层面的【可运行状态】、【运行状态】和【阻塞状态】（由于 BIO 导致的线程阻塞，在 Java 里无法区分，仍然认为是可运行）</p>
</li>
<li><p>BLOCKED ， WAITING ， TIMED_WAITING 都是 <strong>Java API</strong> 层面对【阻塞状态】的细分</p>
</li>
<li><p>TERMINATED：当线程代码运行结束</p>
</li>
</ul>
<h2 id="4-共享模型之管程"><a href="#4-共享模型之管程" class="headerlink" title="4. 共享模型之管程"></a>4. 共享模型之管程</h2><h3 id="4-1-共享带来的问题"><a href="#4-1-共享带来的问题" class="headerlink" title="4.1 共享带来的问题"></a>4.1 共享带来的问题</h3><p>由于自增自减不是原子性操作，对一个全局变量自增5000次，然后自减5000次，得到的结果大概率不是0</p>
<p>注意</p>
<ul>
<li>各个线程首次读取临界区的数值都是访问主内存，每次把修改后的值在返回给主内存用于更新。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test2</span> </span>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> counter = <span class="hljs-number">0</span>; <span class="hljs-comment">//在主内存中</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        <br>        <span class="hljs-comment">//自增操作在t1的工作内存中进行</span><br>        Thread t1 = <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5000</span>; i++) &#123;<br>                counter++;<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br>        <br>        <span class="hljs-comment">//自减操作在t2的工作内存中进行</span><br>        Thread t2 = <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5000</span>; i++) &#123;<br>                counter--;<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t2&quot;</span>);<br><br>        t1.start();<br>        t2.start();<br><br>        t1.join();<br>        t2.join();<br><br>        log.debug(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>,counter);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">21</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00</span>.<span class="hljs-number">183</span> c.Test<span class="hljs-number">2</span><span class="hljs-meta"> [main] - 210</span><br></code></pre></td></tr></table></figure>

<hr>
<p>一个程序运行多个线程本身是没有问题的，问题出在多个线程访问<strong>共享资源</strong>（读操作没有问题，有问题的是写操作）</p>
<h3 id="4-2-synchronized-解决方案"><a href="#4-2-synchronized-解决方案" class="headerlink" title="4.2 synchronized 解决方案"></a>4.2 synchronized 解决方案</h3><p>属于阻塞式的解决方案。</p>
<p>把变量定义成原子变量属于非阻塞式的解决方案。</p>
<p><strong>synchronized 解决方案</strong></p>
<ul>
<li>采用互斥的方式让同一时刻至多只有一个线程能持有【对象锁】，其它线程再想获取这个【对象锁】时就会阻塞住。这样就能保证拥有锁的线程可以安全的执行临界区内的代码，不用担心线程上下文切换。</li>
</ul>
<ol>
<li><p>synchronized 加在临界区上 （保证临界区代码的原子性）</p>
<p>在每个线程的临界区都加上 synchronized（obj）</p>
<p>注意：</p>
<ul>
<li>这种解决方案需要有一个对象用来当作锁对象，下面代码里的room就是这里的锁对象</li>
<li>锁住了对象并不是说拥有锁的对象就可以一直执行到代码结束，他的时间片用完如果没执行完还是要把时间片还回去，但是如果其他线程获得时间片会被阻塞住，于是时间片会被让出去，因此拥有锁对象的线程会再度获得时间片，直到执行完他的临界区后该线程释放锁。</li>
<li>锁对象相同的线程才会互斥进行</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test2</span> </span>&#123;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> counter = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Object room = <span class="hljs-keyword">new</span> Object();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        Thread t1 = <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br><br>            <span class="hljs-keyword">synchronized</span> (room) &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5000</span>; i++) &#123;<br>                    counter++;<br>                &#125;<br>            &#125;<br><br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br><br>        Thread t2 = <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br><br>            <span class="hljs-keyword">synchronized</span> (room) &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5000</span>; i++) &#123;<br>                    counter--;<br>                &#125;<br>            &#125;<br><br>        &#125;, <span class="hljs-string">&quot;t2&quot;</span>);<br><br>        t1.start();<br>        t2.start();<br><br>        t1.join();<br>        t2.join();<br><br>        log.debug(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>,counter);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">21</span>:<span class="hljs-number">37</span>:<span class="hljs-number">29</span>.<span class="hljs-number">387</span> c.Test<span class="hljs-number">2</span><span class="hljs-meta"> [main] - 0</span><br></code></pre></td></tr></table></figure></li>
<li><p>对要操作的临界资源用一个类把他封装起来，定义自增，自减方法来实现对临界资源数值的加减。</p>
<p>把临界资源封装到一个类中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Room</span> </span>&#123;<br>    <span class="hljs-keyword">int</span> value = <span class="hljs-number">0</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">//this指的是这个Room类对象</span><br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>) &#123;<br>            value++;<br>        &#125;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">decrement</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>) &#123;<br>            value--;<br>        &#125;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">get</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>) &#123;<br>            <span class="hljs-keyword">return</span> value;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在测试类中定义多个线程操作临界资源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test2</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        Room room = <span class="hljs-keyword">new</span> Room();<br>        Thread t1 = <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">5000</span>; j++) &#123;<br>                room.increment();<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br>        Thread t2 = <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">5000</span>; j++) &#123;<br>                room.decrement();<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t2&quot;</span>);<br>        t1.start();<br>        t2.start();<br>        t1.join();<br>        t2.join();<br>        log.debug(<span class="hljs-string">&quot;count: &#123;&#125;&quot;</span> , room.get());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">22</span>:<span class="hljs-number">07</span>:<span class="hljs-number">51.451</span> c.Test2 [main] - count: <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure></li>
<li><p>也可在方法上加 synchronized 关键字</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>&#123;<br><br>    &#125;<br>&#125;<br>等价于<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">synchronized</span>(<span class="hljs-keyword">this</span>) &#123;<br><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h3 id="4-3-Monitor-概念"><a href="#4-3-Monitor-概念" class="headerlink" title="4.3 Monitor 概念"></a>4.3 Monitor 概念</h3><p>64 位虚拟机 对象头的 Mark Word</p>
<p><img src="/images/image-20210908224610716.png" srcset="/img/loading.gif" lazyload alt="image-20210908224610716"></p>
<p><img src="C:/Users/Ahao/Desktop/Java%E5%90%8E%E7%AB%AF%E9%9D%A2%E8%AF%95%E7%9F%A5%E8%AF%86/image/image-20210915212518530.png" srcset="/img/loading.gif" lazyload alt="image-20210915212518530"></p>
<p>每个 Java 对象都可以关联一个 Monitor 对象，如果使用 synchronized 给对象上锁（重量级）之后，该对象头的Mark Word 中就被设置指向 Monitor 对象的指针。</p>
<ul>
<li><p>刚开始 Monitor 中 Owner 为 null</p>
</li>
<li><p>当 Thread-2 执行 synchronized(obj) 就会将 Monitor 的所有者 Owner 置为 Thread-2，Monitor中只能有一个 Owner</p>
</li>
<li><p>在 Thread-2 上锁的过程中，如果 Thread-3，Thread-4，Thread-5 也来执行 synchronized(obj)，就会进入EntryList BLOCKED</p>
</li>
<li><p>Thread-2 执行完同步代码块的内容，然后唤醒 EntryList 中等待的线程来竞争锁，竞争的时是非公平的</p>
</li>
<li><p>图中 WaitSet 中的 Thread-0，Thread-1 是之前获得过锁，但条件不满足进入 WAITING 状态的线程，后面讲wait-notify 时会分析</p>
</li>
</ul>
<h3 id="4-4-wait-和-notify-方法"><a href="#4-4-wait-和-notify-方法" class="headerlink" title="4.4 wait 和 notify 方法"></a>4.4 wait 和 notify 方法</h3><p>wait() 方法会释放锁，如果没有被 notify 的话，他会在WaitSet等待区无限等待。</p>
<p>wait(long n) 有时限的等待, 到 n 毫秒后结束等待，或是没有等够时间就被 notify</p>
<p><strong>API 介绍</strong></p>
<ul>
<li><code>obj.wait()</code> 让进入 object 监视器的线程到 waitSet 等待</li>
<li><code>obj.notify()</code> 在 object 上正在 waitSet 等待的线程中挑一个唤醒</li>
<li><code>obj.notifyAll()</code> 让 object 上正在 waitSet 等待的线程全部唤醒</li>
</ul>
<p>这些方法都是属于 Object 对象的方法，注意和 Thread 那里的方法进行区分</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test2</span> </span>&#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> Object obj = <span class="hljs-keyword">new</span> Object();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br><br>            <span class="hljs-keyword">synchronized</span> (obj) &#123;<br>                log.debug(<span class="hljs-string">&quot;执行....&quot;</span>);<br>                <span class="hljs-keyword">try</span> &#123;<br>                    obj.wait(); <span class="hljs-comment">// 让线程在obj上一直等待下去</span><br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>                log.debug(<span class="hljs-string">&quot;其它代码....&quot;</span>);<br>            &#125;<br><br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br><br>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br><br>            <span class="hljs-keyword">synchronized</span> (obj) &#123;<br>                log.debug(<span class="hljs-string">&quot;执行....&quot;</span>);<br>                <span class="hljs-keyword">try</span> &#123;<br>                    obj.wait(); <span class="hljs-comment">// 让线程在obj上一直等待下去</span><br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>                log.debug(<span class="hljs-string">&quot;其它代码....&quot;</span>);<br>            &#125;<br><br>        &#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();<br><br>        <span class="hljs-comment">// 主线程两秒后执行</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            sleep(<span class="hljs-number">2</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        log.debug(<span class="hljs-string">&quot;唤醒 obj 上其它线程&quot;</span>);<br>        <span class="hljs-keyword">synchronized</span> (obj) &#123;<br>            obj.notify(); <span class="hljs-comment">// 唤醒obj上一个线程</span><br>           <span class="hljs-comment">// obj.notifyAll(); // 唤醒obj上所有等待线程</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<p>由于这里调用的是 notify 方法，所以在 t1, t2 线程里面随机挑选一个唤醒</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">22</span>:<span class="hljs-number">54</span>:<span class="hljs-number">08.221</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[t1]</span> - 执行....<br><span class="hljs-number">22</span>:<span class="hljs-number">54</span>:<span class="hljs-number">08.224</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[t2]</span> - 执行....<br><span class="hljs-number">22</span>:<span class="hljs-number">54</span>:<span class="hljs-number">08.221</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[main]</span> - 唤醒 obj 上其它线程<br><span class="hljs-number">22</span>:<span class="hljs-number">54</span>:<span class="hljs-number">08.224</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[t1]</span> - 其它代码....<br></code></pre></td></tr></table></figure>

<h3 id="4-5-sleep-long-n-和-wait-long-n-的异同"><a href="#4-5-sleep-long-n-和-wait-long-n-的异同" class="headerlink" title="4.5 sleep(long n) 和 wait(long n) 的异同"></a>4.5 sleep(long n) 和 wait(long n) 的异同</h3><ol>
<li>sleep 是 Thread 方法，而 wait 是 Object 的方法 </li>
<li>sleep 不需要强制和 synchronized 配合使用，但 wait 需要和 synchronized 一起用 </li>
<li>sleep 在睡眠的同时，不会释放对象锁的，但 wait 在等待的时候会释放对象锁</li>
<li>它们的状态都为 TIMED_WAITING</li>
</ol>
<h3 id="4-6-park-和-unpark-方法"><a href="#4-6-park-和-unpark-方法" class="headerlink" title="4.6 park 和 unpark 方法"></a>4.6 park 和 unpark 方法</h3><p><strong>基本使用</strong></p>
<p>它们是 LockSupport 类中的方法</p>
<p>注意</p>
<ul>
<li><code>LockSupport.park()</code>用于暂停当前线程</li>
<li><code>LockSupport.unpark(t1)</code>用于恢复 t1 线程的运行</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test2</span> </span>&#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> Object obj = <span class="hljs-keyword">new</span> Object();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Thread t1 = <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;start...&quot;</span>);<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                sleep(<span class="hljs-number">1</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br><br>            log.debug(<span class="hljs-string">&quot;park...&quot;</span>);<br>            LockSupport.park();<br>            log.debug(<span class="hljs-string">&quot;resume...&quot;</span>);<br>        &#125;,<span class="hljs-string">&quot;t1&quot;</span>);<br><br>        t1.start();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            sleep(<span class="hljs-number">100</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        log.debug(<span class="hljs-string">&quot;unpark...&quot;</span>);<br>        LockSupport.unpark(t1);<br><br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs prolog"><span class="hljs-number">10</span>:<span class="hljs-number">43</span>:<span class="hljs-number">26.841</span> c.<span class="hljs-symbol">Test2</span> [t1] - start...<br><span class="hljs-number">10</span>:<span class="hljs-number">43</span>:<span class="hljs-number">26.854</span> c.<span class="hljs-symbol">Test2</span> [t1] - park...<br><span class="hljs-number">10</span>:<span class="hljs-number">43</span>:<span class="hljs-number">26.948</span> c.<span class="hljs-symbol">Test2</span> [main] - unpark...<br><span class="hljs-number">10</span>:<span class="hljs-number">43</span>:<span class="hljs-number">26.948</span> c.<span class="hljs-symbol">Test2</span> [t1] - resume...<br></code></pre></td></tr></table></figure>

<p>也可以先 unpark() 再 park() </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test2</span> </span>&#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> Object obj = <span class="hljs-keyword">new</span> Object();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Thread t1 = <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;start...&quot;</span>);<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                sleep(<span class="hljs-number">10</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br><br>            log.debug(<span class="hljs-string">&quot;park...&quot;</span>);<br>            LockSupport.park();<br>            log.debug(<span class="hljs-string">&quot;resume...&quot;</span>);<br>        &#125;,<span class="hljs-string">&quot;t1&quot;</span>);<br><br>        t1.start();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            sleep(<span class="hljs-number">1</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        log.debug(<span class="hljs-string">&quot;unpark...&quot;</span>);<br>        LockSupport.unpark(t1);<br><br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs prolog"><span class="hljs-number">10</span>:<span class="hljs-number">56</span>:<span class="hljs-number">01.548</span> c.<span class="hljs-symbol">Test2</span> [t1] - start...<br><span class="hljs-number">10</span>:<span class="hljs-number">56</span>:<span class="hljs-number">01.548</span> c.<span class="hljs-symbol">Test2</span> [main] - unpark...<br><span class="hljs-number">10</span>:<span class="hljs-number">56</span>:<span class="hljs-number">01.563</span> c.<span class="hljs-symbol">Test2</span> [t1] - park...<br><span class="hljs-number">10</span>:<span class="hljs-number">56</span>:<span class="hljs-number">01.563</span> c.<span class="hljs-symbol">Test2</span> [t1] - resume...<br></code></pre></td></tr></table></figure>

<h3 id="4-7-wait-amp-notify-与-park-amp-unpark-方法的比较"><a href="#4-7-wait-amp-notify-与-park-amp-unpark-方法的比较" class="headerlink" title="4.7 wait &amp; notify 与 park &amp; unpark 方法的比较"></a>4.7 wait &amp; notify 与 park &amp; unpark 方法的比较</h3><ol>
<li>wait，notify 和 notifyAll 必须配合 Object Monitor（也就是上锁）一起使用，而 park，unpark 不必。</li>
<li>park &amp; unpark 是以线程为单位来【阻塞】和【唤醒】线程（就是说可以指定唤醒哪一个线程），而 notify 只能随机唤醒一个等待线程，notifyAll 是唤醒所有等待线程，就不那么【精确】。</li>
<li>park &amp; unpark 可以先 unpark，而 wait &amp; notify 不能先 notify。</li>
</ol>
<h3 id="4-8-重新理解线程状态转换"><a href="#4-8-重新理解线程状态转换" class="headerlink" title="4.8 重新理解线程状态转换"></a>4.8 重新理解线程状态转换</h3><h4 id="4-8-1-NEW-–-gt-RUNNABLE"><a href="#4-8-1-NEW-–-gt-RUNNABLE" class="headerlink" title="4.8.1 NEW –&gt; RUNNABLE"></a>4.8.1 NEW –&gt; RUNNABLE</h4><ul>
<li>当调用 <code>t.start()</code> 方法时，由 <code>NEW --&gt; RUNNABLE</code></li>
</ul>
<h4 id="4-8-2-RUNNABLE-–-gt-WAITING"><a href="#4-8-2-RUNNABLE-–-gt-WAITING" class="headerlink" title="4.8.2 RUNNABLE –&gt; WAITING"></a>4.8.2 RUNNABLE –&gt; WAITING</h4><ol>
<li><p>情况一</p>
<p>t 线程用 <code>synchronized(obj)</code> 获取了对象锁后</p>
<p>调用 <code>obj.wait()</code> 方法时，<strong>t</strong> <strong>线程</strong>从 <code>RUNNABLE --&gt; WAITING</code></p>
<p>调用 <code>obj.notify()</code> ， <code>obj.notifyAll()</code> ， <code>t.interrupt()</code> 时</p>
<ul>
<li>竞争锁成功，<strong>t</strong> <strong>线程</strong>从 <code>WAITING --&gt; RUNNABLE</code></li>
<li>竞争锁失败，<strong>t</strong> <strong>线程</strong>从 <code>WAITING --&gt; BLOCKED</code></li>
</ul>
</li>
<li><p>情况二</p>
<p><strong>当前线程</strong>调用<code>t.join()</code>方法时，<strong>当前线程</strong>从 <code>RUNNABLE --&gt; WAITING</code></p>
<p><strong>t</strong> <strong>线程</strong>运行结束，或调用了<strong>当前线程</strong>的 <code>interrupt()</code> 时，<strong>当前线程</strong>从 <code>WAITING --&gt; RUNNABLE</code></p>
</li>
<li><p>情况三</p>
<p>当前线程调用 <code>LockSupport.park()</code> 方法会让当前线程从 <code>RUNNABLE --&gt; WAITING</code></p>
<p>调用 <code>LockSupport.unpark(目标线程)</code> 或调用了线程 的 <code>interrupt()</code> ，会让目标线程从 <code>WAITING --&gt; RUNNABLE</code></p>
</li>
</ol>
<h4 id="4-8-3-RUNNABLE-–-gt-TIMED-WAITING"><a href="#4-8-3-RUNNABLE-–-gt-TIMED-WAITING" class="headerlink" title="4.8.3 RUNNABLE –&gt; TIMED_WAITING"></a>4.8.3 RUNNABLE –&gt; TIMED_WAITING</h4><ol>
<li><p>情况一</p>
<p><strong>t</strong> <strong>线程</strong>用 synchronized(obj) 获取了对象锁后</p>
<ul>
<li><p>调用 <code>obj.wait(long n)</code> 方法时，<strong>t</strong> <strong>线程</strong>从 <code>RUNNABLE --&gt; TIMED_WAITING</code></p>
</li>
<li><p><strong>t</strong> <strong>线程</strong>等待时间超过了 n 毫秒，或调用 <code>obj.notify()</code> ， <code>obj.notifyAll()</code> ， <code>t.interrupt()</code> 时</p>
<p>竞争锁成功，<strong>t</strong> <strong>线程</strong>从 <code>TIMED_WAITING --&gt; RUNNABLE</code></p>
<p>竞争锁失败，<strong>t</strong> <strong>线程</strong>从 <code>TIMED_WAITING --&gt; BLOCKED</code></p>
</li>
</ul>
</li>
<li><p>情况二</p>
<p><strong>当前线程</strong>调用 <code>t.join(long n)</code> 方法时，<strong>当前线程</strong>从 <code>RUNNABLE --&gt; TIMED_WAITING</code></p>
<p><strong>当前线程</strong>等待时间超过了 n 毫秒，或<strong>t</strong> <strong>线程</strong>运行结束，或调用了<strong>当前线程</strong>的 <code>interrupt()</code> 时，<strong>当前线程</strong>从<code>TIMED_WAITING --&gt; RUNNABLE</code></p>
</li>
<li><p>情况三</p>
<p>当前线程调用 <code>Thread.sleep(long n)</code> ，当前线程从 <code>RUNNABLE --&gt; TIMED_WAITING</code></p>
<p><strong>当前线程</strong>等待时间超过了 n 毫秒，<strong>当前线程</strong>从 <code>TIMED_WAITING --&gt; RUNNABLE</code></p>
</li>
<li><p>情况四</p>
<p>当前线程调用 <code>LockSupport.parkNanos(long nanos)</code> 或 <code>LockSupport.parkUntil(long millis)</code> 时，<strong>当前线程</strong>从 <code>RUNNABLE --&gt; TIMED_WAITING</code></p>
<p>调用 <code>LockSupport.unpark(目标线程) </code>, 或调用了线程 的 <code>interrupt()</code> ，或是等待超时，会让目标线程从 <code>TIMED_WAITING--&gt; RUNNABLE</code></p>
</li>
</ol>
<h4 id="4-8-4-RUNNABLE-–-gt-BLOCKED"><a href="#4-8-4-RUNNABLE-–-gt-BLOCKED" class="headerlink" title="4.8.4 RUNNABLE –&gt; BLOCKED"></a>4.8.4 RUNNABLE –&gt; BLOCKED</h4><p><strong>t</strong> <strong>线程</strong>用 <code>synchronized(obj)</code> 获取了对象锁时如果竞争失败，从 <code>RUNNABLE --&gt; BLOCKED</code></p>
<p>持 obj 锁线程的同步代码块执行完毕，会唤醒该对象上所有 BLOCKED 的线程重新竞争，如果其中 <strong>t</strong> <strong>线程</strong>竞争成功，从 <code>BLOCKED --&gt; RUNNABLE</code> ，其它失败的线程仍然 BLOCKED</p>
<h4 id="4-8-5-RUNNABLE-–-gt-TERMINATED"><a href="#4-8-5-RUNNABLE-–-gt-TERMINATED" class="headerlink" title="4.8.5 RUNNABLE –&gt; TERMINATED"></a>4.8.5 RUNNABLE –&gt; TERMINATED</h4><p>当前线程所有代码运行完毕，进入 TERMINATED</p>
<h2 id="5-ReentrantLock"><a href="#5-ReentrantLock" class="headerlink" title="5 ReentrantLock"></a>5 ReentrantLock</h2><p>相对于 synchronized 它具备如下特点</p>
<ul>
<li>可中断</li>
<li>可以设置超时时间</li>
<li>可以设置为公平锁</li>
<li>支持多个条件变量（相当于有多个管程中的WaitSet，不满足对应条件的去相应的 WaitSet 等待）</li>
</ul>
<p>与 synchronized 一样，都支持可重入</p>
<h3 id="5-1-可重入"><a href="#5-1-可重入" class="headerlink" title="5.1 可重入"></a>5.1 可重入</h3><p>可重入是指同一个线程如果首次获得了这把锁，那么因为它是这把锁的拥有者，因此有权利再次获取这把锁。</p>
<p>注意：</p>
<ul>
<li></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test2</span> </span>&#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> Object obj = <span class="hljs-keyword">new</span> Object();<br>    <span class="hljs-keyword">static</span> ReentrantLock lock = <span class="hljs-keyword">new</span> ReentrantLock();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br><br>        method1();<br>        <br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                lock.lock();<br>                log.debug(<span class="hljs-string">&quot;t1 running&quot;</span>);<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                lock.unlock();<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br><br>        <br><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">method1</span><span class="hljs-params">()</span> </span>&#123;<br>        lock.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            log.debug(<span class="hljs-string">&quot;execute method1&quot;</span>);<br>            method2();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">method2</span><span class="hljs-params">()</span> </span>&#123;<br>        lock.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            log.debug(<span class="hljs-string">&quot;execute method2&quot;</span>);<br>            method3();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">method3</span><span class="hljs-params">()</span> </span>&#123;<br>        lock.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            log.debug(<span class="hljs-string">&quot;execute method3&quot;</span>);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br><span class="hljs-comment">//            lock.unlock();</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<p>在主线程里，先执行<code>method1()</code>，可以看到在m1还没有释放锁之前就调用了m2，m3方法，但是仍然打印出了m2, m3的方法。又可以看到m3 没有释放锁，导致新建立的线程 t1 被阻塞。</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs smali">12:19:33.164 c.Test2 [main] -<span class="hljs-built_in"> execute </span>method1<br>12:19:33.167 c.Test2 [main] -<span class="hljs-built_in"> execute </span>method2<br>12:19:33.167 c.Test2 [main] -<span class="hljs-built_in"> execute </span>method3<br></code></pre></td></tr></table></figure>

<h3 id="5-2-可打断"><a href="#5-2-可打断" class="headerlink" title="5.2 可打断"></a>5.2 可打断</h3><p>注意：</p>
<ul>
<li><code>lock.lockInterruptibly()</code>表示这个等待过程可以被打断，打断之后会抛出异常</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test2</span> </span>&#123;<br><br>    <span class="hljs-keyword">static</span> ReentrantLock lock = <span class="hljs-keyword">new</span> ReentrantLock();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br><br><br>        Thread t1 = <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            log.debug(<span class="hljs-string">&quot;启动...&quot;</span>);<br>            <span class="hljs-keyword">try</span> &#123;<br>                lock.lockInterruptibly();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>                log.debug(<span class="hljs-string">&quot;等锁的过程中被打断&quot;</span>);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-keyword">try</span> &#123;<br>                log.debug(<span class="hljs-string">&quot;获得了锁&quot;</span>);<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                lock.unlock();<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br><br>        lock.lock();<br>        log.debug(<span class="hljs-string">&quot;获得了锁&quot;</span>);<br>        t1.start();<br>        <span class="hljs-keyword">try</span> &#123;<br>            sleep(<span class="hljs-number">1</span>);<br>            t1.interrupt();<br>            log.debug(<span class="hljs-string">&quot;执行打断&quot;</span>);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs stylus">java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.InterruptedException</span><br><span class="hljs-number">16</span>:<span class="hljs-number">27</span>:<span class="hljs-number">37.405</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[main]</span> - 获得了锁<br><span class="hljs-number">16</span>:<span class="hljs-number">27</span>:<span class="hljs-number">37.408</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[t1]</span> - 启动...<br><span class="hljs-number">16</span>:<span class="hljs-number">27</span>:<span class="hljs-number">37.409</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[main]</span> - 执行打断<br><span class="hljs-number">16</span>:<span class="hljs-number">27</span>:<span class="hljs-number">37.410</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[t1]</span> - 等锁的过程中被打断<br>	at java.base/java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.concurrent</span><span class="hljs-selector-class">.locks</span><span class="hljs-selector-class">.AbstractQueuedSynchronizer</span><span class="hljs-selector-class">.doAcquireInterruptibly</span>(AbstractQueuedSynchronizer<span class="hljs-selector-class">.java</span>:<span class="hljs-number">929</span>)<br>	at java.base/java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.concurrent</span><span class="hljs-selector-class">.locks</span><span class="hljs-selector-class">.AbstractQueuedSynchronizer</span><span class="hljs-selector-class">.acquireInterruptibly</span>(AbstractQueuedSynchronizer<span class="hljs-selector-class">.java</span>:<span class="hljs-number">1249</span>)<br>	at java.base/java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.concurrent</span><span class="hljs-selector-class">.locks</span><span class="hljs-selector-class">.ReentrantLock</span><span class="hljs-selector-class">.lockInterruptibly</span>(ReentrantLock<span class="hljs-selector-class">.java</span>:<span class="hljs-number">317</span>)<br>	at Test2.lambda<span class="hljs-variable">$main</span>$<span class="hljs-number">0</span>(Test2<span class="hljs-selector-class">.java</span>:<span class="hljs-number">21</span>)<br>	at java.base/java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Thread</span><span class="hljs-selector-class">.run</span>(Thread<span class="hljs-selector-class">.java</span>:<span class="hljs-number">844</span>)<br></code></pre></td></tr></table></figure>

<p>如果换成普通的 lock() 方法就是不可打断的了，调用该方法的阻塞线程会一直等锁。</p>
<h3 id="5-3-锁超时"><a href="#5-3-锁超时" class="headerlink" title="5.3 锁超时"></a>5.3 锁超时</h3><p>注意</p>
<ul>
<li><code>lock.tryLock(1, TimeUnit.SECONDS)</code>表明如果在1s内获取锁成功，会返回true，获取失败返回false。</li>
<li>这里由于主线程睡了2s，所以t1线程一定会获取锁失败。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test2</span> </span>&#123;<br><br>    <span class="hljs-keyword">static</span> ReentrantLock lock = <span class="hljs-keyword">new</span> ReentrantLock();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br><br>        Thread t1 = <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;启动...&quot;</span>);<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (!lock.tryLock(<span class="hljs-number">1</span>, TimeUnit.SECONDS)) &#123;<br>                    log.debug(<span class="hljs-string">&quot;获取等待 1s 后失败，返回&quot;</span>);<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            <span class="hljs-keyword">try</span> &#123;<br>                log.debug(<span class="hljs-string">&quot;获得了锁&quot;</span>);<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                lock.unlock();<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br>        lock.lock();<br>        log.debug(<span class="hljs-string">&quot;获得了锁&quot;</span>);<br>        t1.start();<br>        <span class="hljs-keyword">try</span> &#123;<br>            sleep(<span class="hljs-number">2000</span>);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">16</span>:<span class="hljs-number">37</span>:<span class="hljs-number">59.262</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[main]</span> - 获得了锁<br><span class="hljs-number">16</span>:<span class="hljs-number">37</span>:<span class="hljs-number">59.265</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[t1]</span> - 启动...<br><span class="hljs-number">16</span>:<span class="hljs-number">38</span>:<span class="hljs-number">00.272</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[t1]</span> - 获取等待 <span class="hljs-number">1s</span> 后失败，返回<br></code></pre></td></tr></table></figure>

<p>这里如果主线程等待时间小于1s的话，t1线程获取锁是可以成功的 </p>
<p>输出</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">16</span>:<span class="hljs-number">42</span>:<span class="hljs-number">20.918</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[main]</span> - 获得了锁<br><span class="hljs-number">16</span>:<span class="hljs-number">42</span>:<span class="hljs-number">20.921</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[t1]</span> - 启动...<br><span class="hljs-number">16</span>:<span class="hljs-number">42</span>:<span class="hljs-number">20.924</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[t1]</span> - 获得了锁<br></code></pre></td></tr></table></figure>

<h3 id="5-4-非公平锁"><a href="#5-4-非公平锁" class="headerlink" title="5.4 非公平锁"></a>5.4 非公平锁</h3><p>就是指不会按照进入阻塞队列的线程顺序来分配锁，而是靠抢。</p>
<p>ReentrantLock 默认是不公平的</p>
<p>注意</p>
<ul>
<li><code>new ReentrantLock(true)</code>表示把它设置成公平锁</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test2</span> </span>&#123;<br><br>    <span class="hljs-keyword">static</span> ReentrantLock lock = <span class="hljs-keyword">new</span> ReentrantLock(<span class="hljs-keyword">true</span>);<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br><br>        lock.lock();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5000</span>; i++) &#123;<br>            <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>                lock.lock();<br>                <span class="hljs-keyword">try</span> &#123;<br>                    System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; running...&quot;</span>);<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    lock.unlock();<br>                &#125;<br>            &#125;, <span class="hljs-string">&quot;t&quot;</span> + i).start();<br>        &#125;<br><br>        <span class="hljs-comment">// 1s 之后去争抢锁</span><br>        Thread.sleep(<span class="hljs-number">2</span>);<br>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; start...&quot;</span>);<br>            lock.lock();<br>            <span class="hljs-keyword">try</span> &#123;<br>                System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; running...&quot;</span>);<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                lock.unlock();<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;强行插入&quot;</span>).start();<br>        lock.unlock();<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<p>设置成公平锁的话，【强行插入】这个线程会在最后面运行</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-function"><span class="hljs-title">t4995</span></span> running...<br><span class="hljs-function"><span class="hljs-title">t4996</span></span> running...<br><span class="hljs-function"><span class="hljs-title">t4997</span></span> running...<br><span class="hljs-function"><span class="hljs-title">t4998</span></span> running...<br><span class="hljs-function"><span class="hljs-title">t4999</span></span> running...<br>强行插入 running...<br></code></pre></td></tr></table></figure>

<p>如果设置成非公平锁以后，【强行插入】这个线程不一定在最后面运行</p>
<p>输出</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-function"><span class="hljs-title">t1</span></span> running...<br>强行插入 start...<br>强行插入 running...<br><span class="hljs-function"><span class="hljs-title">t5</span></span> running...<br><span class="hljs-function"><span class="hljs-title">t2</span></span> running...<br></code></pre></td></tr></table></figure>

<h3 id="5-5-条件变量"><a href="#5-5-条件变量" class="headerlink" title="5.5 条件变量"></a>5.5 条件变量</h3><p>synchronized 中也有条件变量，就是我们讲原理时那个 waitSet 休息室，当条件不满足时进入 waitSet 等待。</p>
<p>ReentrantLock 的条件变量比 synchronized 强大之处在于，它是支持多个条件变量的，这就好比</p>
<ul>
<li>synchronized 是那些不满足条件的线程都在一间休息室等消息</li>
<li>而 ReentrantLock 支持多间休息室，有专门等烟的休息室、专门等早餐的休息室、唤醒时也是按休息室来唤醒</li>
</ul>
<p>注意</p>
<ul>
<li>知道如何创建对应条件的休息室。<code>static Condition waitCigaretteQueue = lock.newCondition()</code></li>
<li><code>Condition</code>接口的<code>await()</code>方法是用来阻塞线程的和<code>signal()</code>方法是用来唤醒相应队列的线程的。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test2</span> </span>&#123;<br><br>    <span class="hljs-keyword">static</span> ReentrantLock lock = <span class="hljs-keyword">new</span> ReentrantLock();<br>    <span class="hljs-keyword">static</span> Condition waitCigaretteQueue = lock.newCondition();<br>    <span class="hljs-keyword">static</span> Condition waitbreakfastQueue = lock.newCondition();<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">boolean</span> hasCigrette = <span class="hljs-keyword">false</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">boolean</span> hasBreakfast = <span class="hljs-keyword">false</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br><br>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                lock.lock();<br>                <span class="hljs-keyword">while</span> (!hasCigrette) &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        waitCigaretteQueue.await();<br>                    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                        e.printStackTrace();<br>                    &#125;<br>                &#125;<br>                log.debug(<span class="hljs-string">&quot;等到了它的烟&quot;</span>);<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                lock.unlock();<br>            &#125;<br>        &#125;).start();<br>        <br>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                lock.lock();<br>                <span class="hljs-keyword">while</span> (!hasBreakfast) &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        waitbreakfastQueue.await();<br>                    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                        e.printStackTrace();<br>                    &#125;<br>                &#125;<br>                log.debug(<span class="hljs-string">&quot;等到了它的早餐&quot;</span>);<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                lock.unlock();<br>            &#125;<br>        &#125;).start();<br>        sleep(<span class="hljs-number">1</span>);<br>        sendBreakfast();<br>        sleep(<span class="hljs-number">1</span>);<br>        sendCigarette();<br>    &#125;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendCigarette</span><span class="hljs-params">()</span> </span>&#123;<br>        lock.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            log.debug(<span class="hljs-string">&quot;送烟来了&quot;</span>);<br>            hasCigrette = <span class="hljs-keyword">true</span>;<br>            waitCigaretteQueue.signal();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendBreakfast</span><span class="hljs-params">()</span> </span>&#123;<br>        lock.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            log.debug(<span class="hljs-string">&quot;送早餐来了&quot;</span>);<br>            hasBreakfast = <span class="hljs-keyword">true</span>;<br>            waitbreakfastQueue.signal();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">18</span>:<span class="hljs-number">50</span>:<span class="hljs-number">45.093</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[main]</span> - 送早餐来了<br><span class="hljs-number">18</span>:<span class="hljs-number">50</span>:<span class="hljs-number">45.096</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[Thread-1]</span> - 等到了它的早餐<br><span class="hljs-number">18</span>:<span class="hljs-number">50</span>:<span class="hljs-number">45.097</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[main]</span> - 送烟来了<br><span class="hljs-number">18</span>:<span class="hljs-number">50</span>:<span class="hljs-number">45.097</span> c<span class="hljs-selector-class">.Test2</span> <span class="hljs-selector-attr">[Thread-0]</span> - 等到了它的烟<br></code></pre></td></tr></table></figure>

<h2 id="6-共享模型之内存"><a href="#6-共享模型之内存" class="headerlink" title="6. 共享模型之内存"></a>6. 共享模型之内存</h2><h3 id="6-1-Java内存模型"><a href="#6-1-Java内存模型" class="headerlink" title="6.1 Java内存模型"></a>6.1 Java内存模型</h3><p>JMM 即 Java Memory Model，它定义了主存、工作内存抽象概念，底层对应着 CPU 寄存器、缓存、硬件内存、CPU 指令优化等。</p>
<p>JMM 体现在以下几个方面：</p>
<ul>
<li>原子性 - 保证指令不会受到线程上下文切换的影响</li>
<li>可见性 - 保证指令不会受 cpu 缓存的影响</li>
<li>有序性 - 保证指令不会受 cpu 指令并行优化的影响</li>
</ul>
<h3 id="6-2-可见性"><a href="#6-2-可见性" class="headerlink" title="6.2 可见性"></a>6.2 可见性</h3><p>先来看一个现象，main 线程对 run 变量的修改对于 t 线程不可见，导致了 t 线程无法停止：</p>
<p>注意：</p>
<ul>
<li>一个线程对主存中的共享变量值的改变对于其他线程是不可见的， 因为其他线程获取主存值以后用的是工作内存中的值</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test2</span> </span>&#123;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> run = <span class="hljs-keyword">true</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        <br>        Thread t = <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            <span class="hljs-keyword">while</span>(run)&#123;<br>                System.out.println(<span class="hljs-number">1</span>);<br>            &#125;<br>        &#125;);<br><br>        t.start();<br><br>        sleep(<span class="hljs-number">1</span>);<br>        run = <span class="hljs-keyword">false</span>; <span class="hljs-comment">// 线程t不会如预想的停下来</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>解决办法 volatile</strong></p>
<p>它可以用来修饰成员变量和静态成员变量，他可以避免线程从自己的工作缓存中查找变量的值，必须到主存中获取它的值，线程操作 volatile 变量都是直接操作主存。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test2</span> </span>&#123;<br><br>    <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> run = <span class="hljs-keyword">true</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br><br>        Thread t = <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            <span class="hljs-keyword">while</span>(run)&#123;<br>                System.out.println(<span class="hljs-number">1</span>);<br>            &#125;<br>        &#125;);<br><br>        t.start();<br><br>        sleep(<span class="hljs-number">1</span>);<br>        run = <span class="hljs-keyword">false</span>; <span class="hljs-comment">// 线程t不会如预想的停下来</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="6-3-有序性"><a href="#6-3-有序性" class="headerlink" title="6.3 有序性"></a>6.3 有序性</h3><p>JVM 会在不影响正确性的前提下，可以调整语句的执行顺序</p>
<p>例如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> i;<br><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> j;<br><span class="hljs-comment">// 在某个线程内执行如下赋值操作</span><br>i = ...; <br>j = ...;<br></code></pre></td></tr></table></figure>

<p>可以是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">i = ...; <br>j = ...;<br></code></pre></td></tr></table></figure>

<p>也可以是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">j = ...;<br>i = ...;<br></code></pre></td></tr></table></figure>

<p>这种特性称之为『指令重排』，多线程下『指令重排』会影响正确性。</p>
<p><strong>解决方法 volatile</strong></p>
<p>volatile 修饰的变量（只能修饰成员变量或者静态成员变量），可以禁用指令重排</p>
<p>volatile 的底层实现原理是内存屏障，Memory Barrier（Memory Fence） </p>
<ul>
<li>写屏障会确保指令重排序时，不会将写屏障之前的代码排在写屏障之后</li>
<li>读屏障会确保指令重排序时，不会将读屏障之后的代码排在读屏障之前</li>
</ul>
<h2 id="7-共享模型之无锁"><a href="#7-共享模型之无锁" class="headerlink" title="7. 共享模型之无锁"></a>7. 共享模型之无锁</h2><h3 id="7-1-问题引入"><a href="#7-1-问题引入" class="headerlink" title="7.1 问题引入"></a>7.1 问题引入</h3><p>有如下需求，保证 account.withdraw 取款方法的线程安全。</p>
<p>先看最初不安全的情况</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Account</span> </span>&#123;<br>    <span class="hljs-comment">// 获取余额</span><br>    <span class="hljs-function">Integer <span class="hljs-title">getBalance</span><span class="hljs-params">()</span></span>;<br>    <span class="hljs-comment">// 取款</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">withdraw</span><span class="hljs-params">(Integer amount)</span></span>;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 方法内会启动 1000 个线程，每个线程做 -10 元 的操作</span><br><span class="hljs-comment">     * 如果初始余额为 10000 那么正确的结果应当是 0</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">demo</span><span class="hljs-params">(Account account)</span> </span>&#123;<br>        List&lt;Thread&gt; ts = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>        <span class="hljs-keyword">long</span> start = System.nanoTime();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) &#123;<br>            ts.add(<span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>                account.withdraw(<span class="hljs-number">10</span>);<br>            &#125;));<br>        &#125;<br>        ts.forEach(Thread::start);<br>        ts.forEach(t -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                t.join();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;);<br>        <span class="hljs-keyword">long</span> end = System.nanoTime();<br>        System.out.println(account.getBalance()<br>                + <span class="hljs-string">&quot; cost: &quot;</span> + (end-start)/<span class="hljs-number">1000_000</span> + <span class="hljs-string">&quot; ms&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AccountUnsafe</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Account</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> Integer balance;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AccountUnsafe</span><span class="hljs-params">(Integer balance)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.balance = balance;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getBalance</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> balance;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">withdraw</span><span class="hljs-params">(Integer amount)</span> </span>&#123;<br>        balance -= amount;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test2</span> </span>&#123;<br><br>    <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> run = <span class="hljs-keyword">true</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br><br>        Account.demo(<span class="hljs-keyword">new</span> AccountUnsafe(<span class="hljs-number">10000</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">230 </span>cost: <span class="hljs-number">75</span> ms<br></code></pre></td></tr></table></figure>

<p>发现结果并不为0</p>
<p>因为操作数据的那个方法不能够保证线程安全</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">withdraw</span><span class="hljs-params">(Integer amount)</span> </span>&#123;<br>    balance -= amount;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>解决思路1 上锁</strong></p>
<p>给方法上锁，保证每次只有一个线程可以访问</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">withdraw</span><span class="hljs-params">(Integer amount)</span> </span>&#123;<br>    balance -= amount;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<p>发现结果并无异常</p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">0 </span>cost: <span class="hljs-number">71</span> ms<br></code></pre></td></tr></table></figure>

<p><strong>解决思路2 无锁</strong></p>
<p>对要改变的公共数值的变量设置成原子引用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AccountSafe</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Account</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> AtomicInteger balance;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AccountSafe</span><span class="hljs-params">(Integer balance)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.balance = <span class="hljs-keyword">new</span> AtomicInteger(balance);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getBalance</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> balance.get();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">withdraw</span><span class="hljs-params">(Integer amount)</span> </span>&#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;<br>            <span class="hljs-keyword">int</span> prev = balance.get();<br>            <span class="hljs-keyword">int</span> next = prev - amount;<br>            <span class="hljs-keyword">if</span> (balance.compareAndSet(prev, next)) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">// 可以简化为下面的方法</span><br>        <span class="hljs-comment">// balance.addAndGet(-1 * amount);</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-symbol">0 </span>cost: <span class="hljs-number">61</span> ms<br></code></pre></td></tr></table></figure>

<h3 id="7-2-CAS"><a href="#7-2-CAS" class="headerlink" title="7.2 CAS"></a>7.2 CAS</h3><p>无锁过程分析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test2</span> </span>&#123;<br><br>    <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> run = <span class="hljs-keyword">true</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception</span>&#123;<br><br>        AtomicInteger balance = <span class="hljs-keyword">new</span> AtomicInteger(<span class="hljs-number">10000</span>);<br>        <span class="hljs-keyword">int</span> mainPrev = balance.get();<br><br>        log.debug(<span class="hljs-string">&quot;try get &#123;&#125;&quot;</span>, mainPrev);<br><br>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            sleep(<span class="hljs-number">1000</span>);<br>            <span class="hljs-keyword">int</span> prev = balance.get();<br>            balance.compareAndSet(prev, <span class="hljs-number">9000</span>);<br>            log.debug(balance.toString());<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br><br>        sleep(<span class="hljs-number">2000</span>);<br>        log.debug(<span class="hljs-string">&quot;try set 8000...&quot;</span>);<br>        <span class="hljs-keyword">boolean</span> isSuccess = balance.compareAndSet(mainPrev, <span class="hljs-number">8000</span>);<br>        log.debug(<span class="hljs-string">&quot;is success ? &#123;&#125;&quot;</span>, isSuccess);<br><br>        <span class="hljs-keyword">if</span>(!isSuccess)&#123;<br>            mainPrev = balance.get();<br>            log.debug(<span class="hljs-string">&quot;try set 8000...&quot;</span>);<br>            isSuccess = balance.compareAndSet(mainPrev, <span class="hljs-number">8000</span>);<br>            log.debug(<span class="hljs-string">&quot;is success ? &#123;&#125;&quot;</span>, isSuccess);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//这个方法是为了让主方法中的sleep方法不用被 try catch，看起来代码会简单一点</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sleep</span><span class="hljs-params">(<span class="hljs-keyword">int</span> millis)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(millis);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出结果</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs actionscript"><span class="hljs-number">00</span>:<span class="hljs-number">31</span>:<span class="hljs-number">22.391</span> c.Test2 [main] - <span class="hljs-keyword">try</span> <span class="hljs-keyword">get</span> <span class="hljs-number">10000</span><br><span class="hljs-number">00</span>:<span class="hljs-number">31</span>:<span class="hljs-number">23.406</span> c.Test2 [t1] - <span class="hljs-number">9000</span><br><span class="hljs-number">00</span>:<span class="hljs-number">31</span>:<span class="hljs-number">24.402</span> c.Test2 [main] - <span class="hljs-keyword">try</span> <span class="hljs-keyword">set</span> <span class="hljs-number">8000.</span>..<br><span class="hljs-number">00</span>:<span class="hljs-number">31</span>:<span class="hljs-number">24.402</span> c.Test2 [main] - <span class="hljs-keyword">is</span> success ? <span class="hljs-literal">false</span><br><span class="hljs-number">00</span>:<span class="hljs-number">31</span>:<span class="hljs-number">24.402</span> c.Test2 [main] - <span class="hljs-keyword">try</span> <span class="hljs-keyword">set</span> <span class="hljs-number">8000.</span>..<br><span class="hljs-number">00</span>:<span class="hljs-number">31</span>:<span class="hljs-number">24.402</span> c.Test2 [main] - <span class="hljs-keyword">is</span> success ? <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<p>CAS 必须借助 volatile 才能读取到共享变量的最新值来实现【比较并交换】的效果</p>
<p><strong>为什么无锁效率高</strong></p>
<ul>
<li>无锁情况下，即使重试失败，线程始终在高速运行，没有停歇，而 synchronized 会让线程在没有获得锁的时候，发生上下文切换，进入阻塞。</li>
</ul>
<p><strong>CAS的特点</strong></p>
<p>结合 CAS 和 volatile 可以实现无锁并发，适用于线程数少、多核 CPU 的场景下。</p>
<ul>
<li>CAS 是基于乐观锁的思想：最乐观的估计，不怕别的线程来修改共享变量，就算改了也没关系，我吃亏点再重试呗。</li>
<li>synchronized 是基于悲观锁的思想：最悲观的估计，得防着其它线程来修改共享变量，我上了锁你们都别想改，我改完了解开锁，你们才有机会。</li>
</ul>
<h2 id="8-线程池-ThreadPoolExecutor"><a href="#8-线程池-ThreadPoolExecutor" class="headerlink" title="8. 线程池 ThreadPoolExecutor"></a>8. 线程池 ThreadPoolExecutor</h2><p><img src="/images/image-20210910143028975.png" srcset="/img/loading.gif" lazyload alt="image-20210910143028975"></p>
<h3 id="8-1-线程池状态"><a href="#8-1-线程池状态" class="headerlink" title="8.1 线程池状态"></a>8.1 线程池状态</h3><p>ThreadPoolExecutor 使用 int 的高 3 位来表示线程池状态，低 29 位表示线程数量</p>
<table>
<thead>
<tr>
<th>状态名</th>
<th>高3位</th>
<th>接受新任务</th>
<th>处理阻塞队列任务</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>RUNNING</td>
<td>111</td>
<td>Y</td>
<td>Y</td>
<td></td>
</tr>
<tr>
<td>SHUTDOWN</td>
<td>000</td>
<td>N</td>
<td>Y</td>
<td>不会接收新任务，但会处理阻塞队列剩余任务</td>
</tr>
<tr>
<td>STOP</td>
<td>001</td>
<td>N</td>
<td>N</td>
<td>会中断正在执行的任务，并抛弃阻塞队列任务</td>
</tr>
<tr>
<td>TIDYING</td>
<td>010</td>
<td></td>
<td></td>
<td>任务全执行完毕，活动线程为 0 即将进入终结</td>
</tr>
<tr>
<td>TERMINATED</td>
<td>011</td>
<td></td>
<td></td>
<td>终结状态</td>
</tr>
</tbody></table>
<h3 id="8-2-构造方法"><a href="#8-2-构造方法" class="headerlink" title="8.2 构造方法"></a>8.2 构造方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-keyword">int</span> corePoolSize,</span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-keyword">int</span> maximumPoolSize,</span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-keyword">long</span> keepAliveTime,</span></span><br><span class="hljs-params"><span class="hljs-function">                          TimeUnit unit,</span></span><br><span class="hljs-params"><span class="hljs-function">                          BlockingQueue&lt;Runnable&gt; workQueue,</span></span><br><span class="hljs-params"><span class="hljs-function">                          ThreadFactory threadFactory,</span></span><br><span class="hljs-params"><span class="hljs-function">                          RejectedExecutionHandler handler)</span></span><br></code></pre></td></tr></table></figure>

<ul>
<li>corePoolSize 核心线程数目 (最多保留的线程数)</li>
<li>maximumPoolSize 最大线程数目</li>
<li>keepAliveTime 生存时间 - 针对救急线程</li>
<li>unit 时间单位 - 针对救急线程</li>
<li>workQueue 阻塞队列</li>
<li>threadFactory 线程工厂 - 可以为线程创建时起个好名字</li>
<li>handler 拒绝策略</li>
</ul>
<p><strong>工作方式</strong></p>
<ol>
<li>线程池中刚开始没有线程，当一个任务提交给线程池后，线程池会创建一个新线程来执行务。</li>
<li>当线程数达到 corePoolSize 并没有线程空闲，这时再加入任务，新加的任务会被加入workQueue 队列排队，直到有空闲的线程。</li>
<li>如果队列选择了有界队列，那么任务超过了队列大小时，会创建 maximumPoolSize - corePoolSize 数目的线程来救急。如果选择了无界队列，则可以一直将任务放入队列中。</li>
<li>如果线程到达 maximumPoolSize 仍然有新任务这时会执行拒绝策略。拒绝策略 jdk 提供了 4 种实现。<ul>
<li>AbortPolicy 让调用者抛出 RejectedExecutionException 异常，这是默认策略</li>
<li>CallerRunsPolicy 让调用者运行任务</li>
<li>DiscardPolicy 放弃本次任务</li>
<li>DiscardOldestPolicy 放弃队列中最早的任务，本任务取而代之</li>
</ul>
</li>
</ol>
<h3 id="8-3-不同用途的线程池"><a href="#8-3-不同用途的线程池" class="headerlink" title="8.3 不同用途的线程池"></a>8.3 不同用途的线程池</h3><h4 id="8-3-1-newFixedThreadPool"><a href="#8-3-1-newFixedThreadPool" class="headerlink" title="8.3.1 newFixedThreadPool"></a>8.3.1 newFixedThreadPool</h4><p>固定大小线程池，<code>Executors</code>类的方法。</p>
<p> <code>newFixedThreadPool(int nThreads)</code> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title">newFixedThreadPool</span><span class="hljs-params">(<span class="hljs-keyword">int</span> nThreads)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ThreadPoolExecutor(nThreads, nThreads,<br>            <span class="hljs-number">0L</span>, TimeUnit.MILLISECONDS,<br>            <span class="hljs-keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;());<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>特点</strong></p>
<ul>
<li>核心线程数 == 最大线程数（没有救急线程被创建），因此也无需超时时间</li>
<li>阻塞队列是无界的，可以放任意数量的任务</li>
</ul>
<h4 id="8-3-2-newCachedThreadPool"><a href="#8-3-2-newCachedThreadPool" class="headerlink" title="8.3.2 newCachedThreadPool"></a>8.3.2 newCachedThreadPool</h4><p>带缓冲线程池，<code>Executors</code>类的方法。</p>
<p><code>newCachedThreadPool() </code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title">newCachedThreadPool</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ThreadPoolExecutor(<span class="hljs-number">0</span>, Integer.MAX_VALUE,<br>            <span class="hljs-number">60L</span>, TimeUnit.SECONDS,<br>            <span class="hljs-keyword">new</span> SynchronousQueue&lt;Runnable&gt;());<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>特点</strong></p>
<ul>
<li>核心线程数是 0， 最大线程数是 Integer.MAX_VALUE，救急线程的空闲生存时间是 60s，意味着<ol>
<li>全部都是救急线程（60s 后可以回收）</li>
<li>救急线程可以无限创建</li>
</ol>
</li>
<li>队列采用了 SynchronousQueue 实现特点是，它没有容量，没有线程来取是放不进去的（一手交钱、一手交货）</li>
</ul>
<h4 id="8-3-3-newSingleThreadExecutor"><a href="#8-3-3-newSingleThreadExecutor" class="headerlink" title="8.3.3 newSingleThreadExecutor"></a>8.3.3 newSingleThreadExecutor</h4><p>单线程线程池，<code>Executors</code>类的方法。</p>
<p><code>newSingleThreadExecutor()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title">newSingleThreadExecutor</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> FinalizableDelegatedExecutorService<br>            (<span class="hljs-keyword">new</span> ThreadPoolExecutor(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>,<br>                    <span class="hljs-number">0L</span>, TimeUnit.MILLISECONDS,<br>                    <span class="hljs-keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;()));<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>特点</strong></p>
<ul>
<li>希望多个任务排队执行。线程数固定为 1，任务数多于 1 时，会放入无界队列排队。任务执行完毕，这唯一的线程也不会被释放。</li>
</ul>
<h3 id="8-4-执行任务方法"><a href="#8-4-执行任务方法" class="headerlink" title="8.4 执行任务方法"></a>8.4 执行任务方法</h3><p>对于不需要返回结果的用 <code>execute(Runnable command)</code>方法，并且传的参数是 Runnable 接口类型。</p>
<p>对于需要返回结果的用<code>submit(Callable&lt;T&gt; task)</code>方法，并且传递的参数是<code>Callable&lt;T&gt;</code>接口类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 执行任务</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">execute</span><span class="hljs-params">(Runnable command)</span></span>;<br><br><span class="hljs-comment">// 提交任务 task，用返回值 Future 获得任务执行结果</span><br>&lt;T&gt; <span class="hljs-function">Future&lt;T&gt; <span class="hljs-title">submit</span><span class="hljs-params">(Callable&lt;T&gt; task)</span></span>;<br></code></pre></td></tr></table></figure>

<p>代码示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j(topic = &quot;c.TestSubmit&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestSubmit</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException </span>&#123;<br>        ExecutorService pool = Executors.newFixedThreadPool(<span class="hljs-number">2</span>);<br><br>        Future&lt;String&gt; future = pool.submit(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;Running...&quot;</span>);<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ok&quot;</span>;<br>        &#125;);<br><br>        log.debug(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, future.get());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">15</span>:<span class="hljs-number">48</span>:<span class="hljs-number">45.624</span> c<span class="hljs-selector-class">.TestSubmit</span> <span class="hljs-selector-attr">[pool-1-thread-1]</span> - Running...<br><span class="hljs-number">15</span>:<span class="hljs-number">48</span>:<span class="hljs-number">46.633</span> c<span class="hljs-selector-class">.TestSubmit</span> <span class="hljs-selector-attr">[main]</span> - ok<br></code></pre></td></tr></table></figure>

<p>如果执行的任务不需要返回值，则换成<code>execute(Runnable command)</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j(topic = &quot;c.TestSubmit&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestSubmit</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException </span>&#123;<br>        ExecutorService pool = Executors.newFixedThreadPool(<span class="hljs-number">2</span>);<br><br>        Future&lt;String&gt; future = pool.submit(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;submit...&quot;</span>);<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ok&quot;</span>;<br>        &#125;);<br><br>        pool.execute(<span class="hljs-keyword">new</span> Runnable() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>                log.debug(<span class="hljs-string">&quot;execute...&quot;</span>);<br>            &#125;<br>        &#125;);<br><br>        log.debug(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, future.get());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="9-J-U-C"><a href="#9-J-U-C" class="headerlink" title="9. J.U.C"></a>9. J.U.C</h2><h3 id="9-1-读写锁-ReentrantReadWriteLock"><a href="#9-1-读写锁-ReentrantReadWriteLock" class="headerlink" title="9.1 读写锁 ReentrantReadWriteLock"></a>9.1 读写锁 ReentrantReadWriteLock</h3><p>当读操作远远高于写操作时，这时候使用 读写锁 让 读-读 可以并发，提高性能。 </p>
<p>提供一个 数据容器类 内部分别使用读锁保护数据的 read() 方法，写锁保护数据的 write() 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j(topic = &quot;c.DataContainer&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataContainer</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> Object data;<br>    <span class="hljs-keyword">private</span> ReentrantReadWriteLock rw = <span class="hljs-keyword">new</span> ReentrantReadWriteLock();<br>    <span class="hljs-keyword">private</span> ReentrantReadWriteLock.ReadLock r = rw.readLock();<br>    <span class="hljs-keyword">private</span> ReentrantReadWriteLock.WriteLock w = rw.writeLock();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">read</span><span class="hljs-params">()</span> </span>&#123;<br>        log.debug(<span class="hljs-string">&quot;获取读锁...&quot;</span>);<br>        r.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            log.debug(<span class="hljs-string">&quot;读取&quot;</span>);<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">10</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            <span class="hljs-keyword">return</span> data;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            log.debug(<span class="hljs-string">&quot;释放读锁...&quot;</span>);<br>            r.unlock();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">write</span><span class="hljs-params">()</span> </span>&#123;<br>        log.debug(<span class="hljs-string">&quot;获取写锁...&quot;</span>);<br>        w.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            log.debug(<span class="hljs-string">&quot;写入&quot;</span>);<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">10</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            log.debug(<span class="hljs-string">&quot;释放写锁...&quot;</span>);<br>            w.unlock();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>测试 读锁-读锁 可以并发</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j(topic = &quot;c.Demo&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        DataContainer dataContainer = <span class="hljs-keyword">new</span> DataContainer();<br><br>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            dataContainer.read();<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br><br>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            dataContainer.read();<br>        &#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<p>发现一个线程即使没有释放读锁，另外一个线程也可以获得读锁</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">16</span>:<span class="hljs-number">39</span>:<span class="hljs-number">25.153</span> c<span class="hljs-selector-class">.DataContainer</span> <span class="hljs-selector-attr">[t2]</span> - 获取读锁...<br><span class="hljs-number">16</span>:<span class="hljs-number">39</span>:<span class="hljs-number">25.156</span> c<span class="hljs-selector-class">.DataContainer</span> <span class="hljs-selector-attr">[t2]</span> - 读取<br><span class="hljs-number">16</span>:<span class="hljs-number">39</span>:<span class="hljs-number">25.153</span> c<span class="hljs-selector-class">.DataContainer</span> <span class="hljs-selector-attr">[t1]</span> - 获取读锁...<br><span class="hljs-number">16</span>:<span class="hljs-number">39</span>:<span class="hljs-number">25.156</span> c<span class="hljs-selector-class">.DataContainer</span> <span class="hljs-selector-attr">[t1]</span> - 读取<br><span class="hljs-number">16</span>:<span class="hljs-number">39</span>:<span class="hljs-number">25.169</span> c<span class="hljs-selector-class">.DataContainer</span> <span class="hljs-selector-attr">[t1]</span> - 释放读锁...<br><span class="hljs-number">16</span>:<span class="hljs-number">39</span>:<span class="hljs-number">25.169</span> c<span class="hljs-selector-class">.DataContainer</span> <span class="hljs-selector-attr">[t2]</span> - 释放读锁...<br></code></pre></td></tr></table></figure>

<p><strong>测试 读锁-写锁 相互阻塞</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j(topic = &quot;c.Demo&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        DataContainer dataContainer = <span class="hljs-keyword">new</span> DataContainer();<br><br>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            dataContainer.read();<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br><br>        Thread.sleep(<span class="hljs-number">100</span>);<br>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            dataContainer.write();<br>        &#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<p>可以发现一个线程没有释放锁的时候。另外一个线程是无法获取锁的</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">16</span>:<span class="hljs-number">43</span>:<span class="hljs-number">03.682</span> c<span class="hljs-selector-class">.DataContainer</span> <span class="hljs-selector-attr">[t1]</span> - 获取读锁...<br><span class="hljs-number">16</span>:<span class="hljs-number">43</span>:<span class="hljs-number">03.685</span> c<span class="hljs-selector-class">.DataContainer</span> <span class="hljs-selector-attr">[t1]</span> - 读取<br><span class="hljs-number">16</span>:<span class="hljs-number">43</span>:<span class="hljs-number">03.698</span> c<span class="hljs-selector-class">.DataContainer</span> <span class="hljs-selector-attr">[t1]</span> - 释放读锁...<br><span class="hljs-number">16</span>:<span class="hljs-number">43</span>:<span class="hljs-number">03.779</span> c<span class="hljs-selector-class">.DataContainer</span> <span class="hljs-selector-attr">[t2]</span> - 获取写锁...<br><span class="hljs-number">16</span>:<span class="hljs-number">43</span>:<span class="hljs-number">03.779</span> c<span class="hljs-selector-class">.DataContainer</span> <span class="hljs-selector-attr">[t2]</span> - 写入<br><span class="hljs-number">16</span>:<span class="hljs-number">43</span>:<span class="hljs-number">03.794</span> c<span class="hljs-selector-class">.DataContainer</span> <span class="hljs-selector-attr">[t2]</span> - 释放写锁...<br></code></pre></td></tr></table></figure>

<h3 id="9-2-Semaphore"><a href="#9-2-Semaphore" class="headerlink" title="9.2 Semaphore"></a>9.2 Semaphore</h3><p><strong>基本用法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 1. 创建 semaphore 为3的对象</span><br>Semaphore semaphore = <span class="hljs-keyword">new</span> Semaphore(<span class="hljs-number">3</span>);<br><br><span class="hljs-comment">//获取许可        </span><br>semaphore.acquire();<br><br><span class="hljs-comment">//释放许可</span><br>semaphore.release();<br></code></pre></td></tr></table></figure>

<p>信号量，用来限制能同时访问共享资源的线程上限。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j(topic = &quot;c.Demo&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-comment">// 1. 创建 semaphore 对象</span><br>        Semaphore semaphore = <span class="hljs-keyword">new</span> Semaphore(<span class="hljs-number">3</span>);<br>        <span class="hljs-comment">// 2. 10个线程同时运行</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>            <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>                <span class="hljs-comment">// 3. 获取许可</span><br>                <span class="hljs-keyword">try</span> &#123;<br>                    semaphore.acquire();<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    log.debug(<span class="hljs-string">&quot;running...&quot;</span>);<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        Thread.sleep(<span class="hljs-number">10</span>);<br>                    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                        e.printStackTrace();<br>                    &#125;<br>                    log.debug(<span class="hljs-string">&quot;end...&quot;</span>);<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    <span class="hljs-comment">// 4. 释放许可</span><br>                    semaphore.release();<br>                &#125;<br>            &#125;).start();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<p>可以发现每次最多只能有3个线程并发执行</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs prolog"><span class="hljs-number">16</span>:<span class="hljs-number">51</span>:<span class="hljs-number">06.272</span> c.<span class="hljs-symbol">Demo</span> [<span class="hljs-symbol">Thread</span><span class="hljs-number">-0</span>] - running...<br><span class="hljs-number">16</span>:<span class="hljs-number">51</span>:<span class="hljs-number">06.272</span> c.<span class="hljs-symbol">Demo</span> [<span class="hljs-symbol">Thread</span><span class="hljs-number">-2</span>] - running...<br><span class="hljs-number">16</span>:<span class="hljs-number">51</span>:<span class="hljs-number">06.272</span> c.<span class="hljs-symbol">Demo</span> [<span class="hljs-symbol">Thread</span><span class="hljs-number">-1</span>] - running...<br><span class="hljs-number">16</span>:<span class="hljs-number">51</span>:<span class="hljs-number">06.289</span> c.<span class="hljs-symbol">Demo</span> [<span class="hljs-symbol">Thread</span><span class="hljs-number">-0</span>] - end...<br><span class="hljs-number">16</span>:<span class="hljs-number">51</span>:<span class="hljs-number">06.289</span> c.<span class="hljs-symbol">Demo</span> [<span class="hljs-symbol">Thread</span><span class="hljs-number">-2</span>] - end...<br><span class="hljs-number">16</span>:<span class="hljs-number">51</span>:<span class="hljs-number">06.289</span> c.<span class="hljs-symbol">Demo</span> [<span class="hljs-symbol">Thread</span><span class="hljs-number">-1</span>] - end...<br><span class="hljs-number">16</span>:<span class="hljs-number">51</span>:<span class="hljs-number">06.289</span> c.<span class="hljs-symbol">Demo</span> [<span class="hljs-symbol">Thread</span><span class="hljs-number">-4</span>] - running...<br><span class="hljs-number">16</span>:<span class="hljs-number">51</span>:<span class="hljs-number">06.289</span> c.<span class="hljs-symbol">Demo</span> [<span class="hljs-symbol">Thread</span><span class="hljs-number">-3</span>] - running...<br><span class="hljs-number">16</span>:<span class="hljs-number">51</span>:<span class="hljs-number">06.289</span> c.<span class="hljs-symbol">Demo</span> [<span class="hljs-symbol">Thread</span><span class="hljs-number">-8</span>] - running...<br><span class="hljs-number">16</span>:<span class="hljs-number">51</span>:<span class="hljs-number">06.305</span> c.<span class="hljs-symbol">Demo</span> [<span class="hljs-symbol">Thread</span><span class="hljs-number">-4</span>] - end...<br><span class="hljs-number">16</span>:<span class="hljs-number">51</span>:<span class="hljs-number">06.305</span> c.<span class="hljs-symbol">Demo</span> [<span class="hljs-symbol">Thread</span><span class="hljs-number">-8</span>] - end...<br><span class="hljs-number">16</span>:<span class="hljs-number">51</span>:<span class="hljs-number">06.305</span> c.<span class="hljs-symbol">Demo</span> [<span class="hljs-symbol">Thread</span><span class="hljs-number">-3</span>] - end...<br></code></pre></td></tr></table></figure>

<h3 id="9-3-CountdownLatch-倒计时锁"><a href="#9-3-CountdownLatch-倒计时锁" class="headerlink" title="9.3 CountdownLatch (倒计时锁)"></a>9.3 CountdownLatch (倒计时锁)</h3><p><strong>基本使用</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//倒计时锁计数初始化</span><br>CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">3</span>);<br><br><span class="hljs-comment">//计数减一</span><br>latch.countDown();<br><br><span class="hljs-comment">//获得当前计数</span><br>latch.getCount();<br><br><span class="hljs-comment">//计数为0时才会往下执行，否则一直阻塞</span><br>latch.await();<br></code></pre></td></tr></table></figure>

<p>用来进行线程同步协作，等待所有线程完成倒计时。</p>
<p>其中构造参数用来初始化等待计数值，await() 用来等待计数归零，countDown() 用来让计数减一。（记数不为0，不会执行await后面的代码）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j(topic = &quot;c.Demo&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        CountDownLatch latch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">3</span>);<br><br>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;begin...&quot;</span>);<br>            <span class="hljs-keyword">try</span> &#123;<br>                sleep(<span class="hljs-number">10</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            latch.countDown();<br>            log.debug(<span class="hljs-string">&quot;end...&#123;&#125;&quot;</span>, latch.getCount());<br>        &#125;).start();<br><br>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;begin...&quot;</span>);<br>            <span class="hljs-keyword">try</span> &#123;<br>                sleep(<span class="hljs-number">20</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            latch.countDown();<br>            log.debug(<span class="hljs-string">&quot;end...&#123;&#125;&quot;</span>, latch.getCount());<br>        &#125;).start();<br><br>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;begin...&quot;</span>);<br>            <span class="hljs-keyword">try</span> &#123;<br>                sleep(<span class="hljs-number">15</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            latch.countDown();<br>            log.debug(<span class="hljs-string">&quot;end...&#123;&#125;&quot;</span>, latch.getCount());<br>        &#125;).start();<br><br>        log.debug(<span class="hljs-string">&quot;waiting...&quot;</span>);<br>        latch.await();<br>        log.debug(<span class="hljs-string">&quot;wait end...&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><span class="hljs-number">17</span>:<span class="hljs-number">04</span>:<span class="hljs-number">25.826</span> <span class="hljs-keyword">c</span>.Demo [Thread<span class="hljs-number">-2</span>] - <span class="hljs-keyword">begin</span>...<br><span class="hljs-number">17</span>:<span class="hljs-number">04</span>:<span class="hljs-number">25.826</span> <span class="hljs-keyword">c</span>.Demo [Thread<span class="hljs-number">-0</span>] - <span class="hljs-keyword">begin</span>...<br><span class="hljs-number">17</span>:<span class="hljs-number">04</span>:<span class="hljs-number">25.826</span> <span class="hljs-keyword">c</span>.Demo [Thread<span class="hljs-number">-1</span>] - <span class="hljs-keyword">begin</span>...<br><span class="hljs-number">17</span>:<span class="hljs-number">04</span>:<span class="hljs-number">25.826</span> <span class="hljs-keyword">c</span>.Demo [main] - waiting...<br><span class="hljs-number">17</span>:<span class="hljs-number">04</span>:<span class="hljs-number">25.839</span> <span class="hljs-keyword">c</span>.Demo [Thread<span class="hljs-number">-0</span>] - <span class="hljs-keyword">end</span>...<span class="hljs-number">2</span><br><span class="hljs-number">17</span>:<span class="hljs-number">04</span>:<span class="hljs-number">25.843</span> <span class="hljs-keyword">c</span>.Demo [Thread<span class="hljs-number">-2</span>] - <span class="hljs-keyword">end</span>...<span class="hljs-number">1</span><br><span class="hljs-number">17</span>:<span class="hljs-number">04</span>:<span class="hljs-number">25.849</span> <span class="hljs-keyword">c</span>.Demo [Thread<span class="hljs-number">-1</span>] - <span class="hljs-keyword">end</span>...<span class="hljs-number">0</span><br><span class="hljs-number">17</span>:<span class="hljs-number">04</span>:<span class="hljs-number">25.849</span> <span class="hljs-keyword">c</span>.Demo [main] - wait <span class="hljs-keyword">end</span>...<br></code></pre></td></tr></table></figure>

<h3 id="9-4-CyclicBarrier"><a href="#9-4-CyclicBarrier" class="headerlink" title="9.4 CyclicBarrier"></a>9.4 CyclicBarrier</h3><p><strong>基本使用</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//阻塞的线程个数为2时才会执行</span><br>CyclicBarrier cb = <span class="hljs-keyword">new</span> CyclicBarrier(<span class="hljs-number">2</span>);<br><br><span class="hljs-comment">//阻塞线程个数不足时，等待</span><br>cb.await();<br></code></pre></td></tr></table></figure>

<p>构造时设置『计数个数』，每个线程执行到某个需要“同步”的时刻调用 await() 方法进行等待，当等待的线程数满足『计数个数』时，继续执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        CyclicBarrier cb = <span class="hljs-keyword">new</span> CyclicBarrier(<span class="hljs-number">2</span>); <span class="hljs-comment">// 个数为2时才会继续执行</span><br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            System.out.println(<span class="hljs-string">&quot;线程1开始..&quot;</span>+<span class="hljs-keyword">new</span> Date());<br>            <span class="hljs-keyword">try</span> &#123;<br>                cb.await(); <span class="hljs-comment">// 当个数不足时，等待</span><br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            System.out.println(<span class="hljs-string">&quot;线程1继续向下运行...&quot;</span>+<span class="hljs-keyword">new</span> Date());<br>        &#125;).start();<br><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;&#123;<br>            System.out.println(<span class="hljs-string">&quot;线程2开始..&quot;</span>+<span class="hljs-keyword">new</span> Date());<br>            <span class="hljs-keyword">try</span> &#123; Thread.sleep(<span class="hljs-number">2000</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123; &#125;<br>            <span class="hljs-keyword">try</span> &#123;<br>                cb.await(); <span class="hljs-comment">// 2 秒后，线程个数够2，继续运行</span><br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            System.out.println(<span class="hljs-string">&quot;线程2继续向下运行...&quot;</span>+<span class="hljs-keyword">new</span> Date());<br>        &#125;).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出</p>
<p>可以看到线程数满足后所有的线程都会执行，并不只是刚好满足的那一个。</p>
<figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cos">线程<span class="hljs-number">2</span>开始<span class="hljs-built_in">..Fri</span> Sep <span class="hljs-number">10</span> <span class="hljs-number">17</span>:<span class="hljs-number">18</span>:<span class="hljs-number">20</span> CST <span class="hljs-number">2021</span><br>线程<span class="hljs-number">1</span>开始<span class="hljs-built_in">..Fri</span> Sep <span class="hljs-number">10</span> <span class="hljs-number">17</span>:<span class="hljs-number">18</span>:<span class="hljs-number">20</span> CST <span class="hljs-number">2021</span><br>线程<span class="hljs-number">2</span>继续向下运行.<span class="hljs-built_in">..Fri</span> Sep <span class="hljs-number">10</span> <span class="hljs-number">17</span>:<span class="hljs-number">18</span>:<span class="hljs-number">22</span> CST <span class="hljs-number">2021</span><br>线程<span class="hljs-number">1</span>继续向下运行.<span class="hljs-built_in">..Fri</span> Sep <span class="hljs-number">10</span> <span class="hljs-number">17</span>:<span class="hljs-number">18</span>:<span class="hljs-number">22</span> CST <span class="hljs-number">2021</span><br></code></pre></td></tr></table></figure>




            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/09/04/1.7%20%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E7%AC%AC%E4%B8%83%E9%83%A8%E5%88%86/">
                        <span class="hidden-mobile">畅购商城第七部分</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>



  <script  src="/js/local-search.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
