<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>ElasticSearch</title>
    <link href="/2021/08/02/5.%20ElasticSearch/"/>
    <url>/2021/08/02/5.%20ElasticSearch/</url>
    
    <content type="html"><![CDATA[<h1 id="1-初识ElasticSearch"><a href="#1-初识ElasticSearch" class="headerlink" title="1. 初识ElasticSearch"></a>1. 初识ElasticSearch</h1><h2 id="1-1-倒排索引"><a href="#1-1-倒排索引" class="headerlink" title="1.1 倒排索引"></a>1.1 倒排索引</h2><p><strong>倒排索引</strong>：将文档进行分词，形成词条和id的对应关系即为反向索引。</p><p>以唐诗为例，所处包含“前”的诗句</p><p>正向索引：由《静夜思》–&gt;床前明月光—&gt;“前”字</p><p>反向索引：“前”字–&gt;床前明月光–&gt;《静夜思》</p><p>反向索引的实现就是对诗句进行分词，分成单个的词，由词推据，即为反向索引</p><p>“床前明月光”–&gt; 分词</p><p>将一段文本按照一定的规则，拆分为不同的词条（term）</p><p><img src="/images/image-20210802232553086.png" alt="image-20210802232553086"></p><h2 id="1-2-ES存储和查询的原理"><a href="#1-2-ES存储和查询的原理" class="headerlink" title="1.2 ES存储和查询的原理"></a>1.2 ES存储和查询的原理</h2><ul><li>index（索引）：相当于mysql的数据库</li><li>映射：相当于mysql 的表结构</li><li>document(文档)：相当于mysql的表中的数据</li></ul><p>数据库查询存在的问题：</p><ol><li>性能低：使用模糊查询，左边有通配符，不会走索引，会全表扫描，性能低</li><li>功能弱：如果以”华为手机“作为条件查询下图索引库，查询不出来数据</li></ol><p>Es使用倒排索引，对title 进行分词</p><p><img src="/images/image-20210802233002078.png" alt="image-20210802233002078"></p><ol><li><p>使用“手机”作为关键字查询</p><p>生成的倒排索引中，词条会排序，形成一颗树形结构，提升词条的查询速度</p></li><li><p>使用“华为手机”作为关键字查询</p><p>华为：1,3</p><p>手机：1,2,3</p></li></ol><p><img src="/images/image-20210802233215711.png" alt="image-20210802233215711"></p><h2 id="1-3-ES概念详解"><a href="#1-3-ES概念详解" class="headerlink" title="1.3 ES概念详解"></a>1.3 ES概念详解</h2><ul><li><p>ElasticSearch是一个基于Lucene的搜索服务器</p><p><img src="/images/image-20210802233322245.png" alt="image-20210802233322245"></p></li><li><p>是一个分布式、高扩展、高实时的搜索与数据分析引擎</p></li><li><p>基于RESTful web接口</p></li><li><p>Elasticsearch是用Java语言开发的，并作为Apache许可条款下的开放源码发布，是一种流行的企业级搜索引擎</p></li></ul><p>官网：<a href="https://www.elastic.co/">https://www.elastic.co/</a></p><p>应用场景：</p><ol><li>搜索：海量数据的查询</li><li>日志数据分析</li><li>实时数据分析</li></ol><h1 id="2-安装ElasticSearch"><a href="#2-安装ElasticSearch" class="headerlink" title="2. 安装ElasticSearch"></a>2. 安装ElasticSearch</h1><h2 id="2-1-ES安装"><a href="#2-1-ES安装" class="headerlink" title="2.1 ES安装"></a>2.1 ES安装</h2><ol><li><p>上传ElasticSearch安装包(在官网下载到了宿主机上，也可以直接在虚拟机中用命令下载)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">alt+p # 打开sftp窗口<br><span class="hljs-meta">#</span><span class="bash"> 上传es安装包</span><br>put e:/software/elasticsearch-7.4.0-linux-x86_64.tar.gz<br></code></pre></td></tr></table></figure></li><li><p>执行解压操作 ，如下图</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 将elasticsearch-7.4.0-linux-x86_64.tar.gz解压到opt文件夹下. -C 大写</span><br>tar -zxvf elasticsearch-7.4.0-linux-x86_64.tar.gz  -C /opt<br></code></pre></td></tr></table></figure></li><li><p>创建普通用户</p><p>因为安全问题，Elasticsearch 不允许root用户直接运行，所以要创建新用户，在root用户中创建新用户,执行如下命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">useradd itheima  # 新增itheima用户<br>passwd  itheima  # 为itheima用户设置密码<br></code></pre></td></tr></table></figure></li><li><p>为新用户授权，如下图</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">chown -R itheima:itheima /opt/elasticsearch-7.4.0 #文件夹所有者<br></code></pre></td></tr></table></figure></li><li><p>修改elasticsearch.yml文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /opt/elasticsearch-7.4.0/config/elasticsearch.yml <br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> ======================== Elasticsearch Configuration =========================</span><br>cluster.name: my-application<br>node.name: node-1<br>network.host: 0.0.0.0  # 配置成这个地址可以让外网访问到，localhost外网访问不到<br>http.port: 9200<br>cluster.initial_master_nodes: [&quot;node-1&quot;]<br></code></pre></td></tr></table></figure><p>cluster.name：配置elasticsearch的集群名称，默认是elasticsearch。建议修改成一个有意义的名称</p><p>node.name：节点名，elasticsearch会默认随机指定一个名字，建议指定一个有意义的名称，方便管理</p><p>network.host：设置为0.0.0.0允许外网访问</p><p>http.port：Elasticsearch的http访问端口</p><p>cluster.initial_master_nodes：初始化新的集群时需要此配置来选举master</p></li><li><p>修改配置文件</p><p>新创建的itheima用户最大可创建文件数太小，最大虚拟内存太小，切换到root用户，编辑下列配置文件， 添加类似如下内容</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 切换到root用户</span><br>su root <br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash">1. ===最大可创建文件数太小=======</span><br>vim /etc/security/limits.conf <br><span class="hljs-meta">#</span><span class="bash"> 在文件末尾中增加下面内容</span><br>itheima soft nofile 65536<br>itheima hard nofile 65536<br><span class="hljs-meta">#</span><span class="bash"> =====</span><br>vim /etc/security/limits.d/20-nproc.conf<br><span class="hljs-meta">#</span><span class="bash"> 在文件末尾中增加下面内容</span><br>itheima soft nofile 65536<br>itheima hard nofile 65536<br>*  hard    nproc     4096<br><span class="hljs-meta">#</span><span class="bash"> 注：* 代表Linux所有用户名称</span><br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash">2. ===最大虚拟内存太小=======</span><br>vim /etc/sysctl.conf<br><span class="hljs-meta">#</span><span class="bash"> 在文件中增加下面内容</span><br>vm.max_map_count=655360<br><span class="hljs-meta">#</span><span class="bash"> 重新加载，输入下面命令：</span><br>sysctl -p<br></code></pre></td></tr></table></figure></li><li><p>启动elasticsearch</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">su itheima  # 切换到itheima用户启动<br>cd /opt/elasticsearch-7.4.0/bin<br>./elasticsearch #启动<br></code></pre></td></tr></table></figure></li></ol><h2 id="2-2-访问elasticsearch"><a href="#2-2-访问elasticsearch" class="headerlink" title="2.2 访问elasticsearch"></a>2.2 访问elasticsearch</h2><ol><li><p>在访问elasticsearch前，请确保防火墙是关闭的，执行命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">暂时关闭防火墙</span><br>systemctl  stop  firewalld<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> 或者</span><br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash">永久设置防火墙状态</span><br>systemctl enable firewalld.service  #打开防火墙永久性生效，重启后不会复原 <br>systemctl disable firewalld.service #关闭防火墙，永久性生效，重启后不会复原 <br></code></pre></td></tr></table></figure></li><li><p>浏览器输入<a href="http://192.168.200.129:9200/">http://192.168.200.129:9200/</a></p><p><img src="/images/image-20210802234919469.png" alt="image-20210802234919469"></p><p>看到上图说明此时elasticsearch已成功启动：</p><figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs d">重点几个关注下即可:<br>numbe<span class="hljs-string">r&quot; : &quot;</span><span class="hljs-number">7.4</span><span class="hljs-number">.0</span><span class="hljs-string">&quot;   表示elasticsearch版本</span><br><span class="hljs-string">lucene_version&quot;</span> : <span class="hljs-string">&quot;8.2.0&quot;</span>  表示lucene版本<br>name ： 默认启动的时候指定了 ES 实例名称<br>cluster_name ： 默认名为 elasticsearch<br></code></pre></td></tr></table></figure></li></ol><h1 id="3-Elasticsearch辅助插件Kibana安装"><a href="#3-Elasticsearch辅助插件Kibana安装" class="headerlink" title="3. Elasticsearch辅助插件Kibana安装"></a>3. Elasticsearch辅助插件Kibana安装</h1><p>什么是Kibana?</p><ul><li>Kibana是一个针对Elasticsearch的开源分析及可视化平台，用来搜索、查看交互存储在Elasticsearch索引中的数据。使用Kibana，可以通过各种图表进行高级数据分析及展示。</li><li>Kibana让海量数据更容易理解。它操作简单，基于浏览器的用户界面可以快速创建仪表板（dashboard）实时显示Elasticsearch查询动态。</li></ul><h2 id="3-1-Kibana安装"><a href="#3-1-Kibana安装" class="headerlink" title="3.1 Kibana安装"></a>3.1 Kibana安装</h2><ol><li><p>上传kibana</p><p>CRT中克隆一个窗口，上传Kibana</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">put ‪E:\software\kibana-7.4.0-linux-x86_64.tar.gz<br></code></pre></td></tr></table></figure></li><li><p>解压kibana</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">tar -xzf kibana-7.4.0-linux-x86_64.tar.gz -C /opt<br></code></pre></td></tr></table></figure></li><li><p>修改kibana.yml文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /opt/kibana-7.4.0-linux-x86_64/config/kibana.yml<br></code></pre></td></tr></table></figure><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server.port:</span> <span class="hljs-number">5601</span><br><span class="hljs-attr">server.host:</span> <span class="hljs-string">&quot;0.0.0.0&quot;</span><br><span class="hljs-attr">server.name:</span> <span class="hljs-string">&quot;kibana-itcast&quot;</span><br><span class="hljs-attr">elasticsearch.hosts:</span> [<span class="hljs-string">&quot;http://127.0.0.1:9200&quot;</span>] <span class="hljs-comment"># 因为他和es是装一个上面了，所以直接用的127.0.0.1本机ip，如果不在一个上面的话，要改成装es的那台服务器的ip</span><br><span class="hljs-attr">elasticsearch.requestTimeout:</span> <span class="hljs-number">99999</span><br></code></pre></td></tr></table></figure><p>server.port：http访问端口</p><p>server.host：ip地址，0.0.0.0表示可远程访问</p><p>server.name：kibana服务名</p><p>elasticsearch.hosts：elasticsearch地址</p><p>elasticsearch.requestTimeout：请求elasticsearch超时时间，默认为30000，此处可根据情况设置</p></li><li><p>启动kibana</p><p>由于kibana不建议使用root用户启动，如果用root启动，需要加–allow-root参数</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 切换到kibana的bin目录</span><br>cd /opt/kibana-7.4.0-linux-x86_64/bin<br><span class="hljs-meta">#</span><span class="bash"> 启动</span><br>./kibana --allow-root<br></code></pre></td></tr></table></figure></li><li><p>访问kibana</p><p>浏览器输入<a href="http://192.168.200.129:5601/">http://192.168.200.129:5601/</a></p><p><img src="/images/image-20210803000515080.png" alt="image-20210803000515080"></p><p>看到这个界面，说明Kibanan已成功安装。</p><ul><li><code>Discover</code>：可视化查询分析器</li><li><code>Visualize</code>：统计分析图表</li><li><code>Dashboard</code>：自定义主面板（添加图表）</li><li><code>Timelion</code>：Timelion是一个kibana时间序列展示组件（暂时不用）</li><li><code>Dev Tools</code>：Console控制台（同CURL/POSTER，操作ES代码工具，代码提示，很方便）</li><li><code>Management</code>：管理索引库(index)、已保存的搜索和可视化结果(save objects)、设置 kibana 服务器属性。</li></ul></li></ol><h1 id="4-ElasticSearch核心概念"><a href="#4-ElasticSearch核心概念" class="headerlink" title="4. ElasticSearch核心概念"></a>4. ElasticSearch核心概念</h1><p><strong>索引（index）</strong></p><p>ElasticSearch存储数据的地方，可以理解成关系型数据库中的数据库概念。</p><p><strong>映射（mapping）</strong></p><p>mapping定义了每个字段的类型、字段所使用的分词器等。相当于关系型数据库中的表结构。</p><p><strong>文档（document）</strong></p><p>Elasticsearch中的最小数据单元，常以json格式显示。一个document相当于关系型数据库中的一行数据。</p><p><strong>倒排索引</strong></p><p>一个倒排索引由文档中所有不重复词的列表构成，对于其中每个词，对应一个包含它的文档id列表。</p><p><strong>类型（type）</strong></p><p>一种type就像一类表。如用户表、角色表等。在Elasticsearch7.X默认type为_doc</p><h1 id="5-脚本操作ES"><a href="#5-脚本操作ES" class="headerlink" title="5 脚本操作ES"></a>5 脚本操作ES</h1><p>使用脚本操作es一般是由运维人员来进行的</p><h2 id="5-1-RESTful风格介绍"><a href="#5-1-RESTful风格介绍" class="headerlink" title="5.1 RESTful风格介绍"></a>5.1 RESTful风格介绍</h2><ol><li>ST（Representational State Transfer），表述性状态转移，是一组架构约束条件和原则。满足这些约束条件和原则的应用程序或设计就是RESTful。就是一种定义接口的规范。</li><li>基于HTTP</li><li>参数使用XML格式定义或JSON格式定义</li><li>每一个URI代表1种资源</li><li>客户端使用GET、POST、PUT、DELETE 4个表示操作方式的动词对服务端资源进行操作：<ul><li>GET：用来获取资源</li><li>POST：用来新建资源（也可以用于更新资源）</li><li>PUT：用来更新资源</li><li>DELETE：用来删除资源</li></ul></li></ol><h2 id="5-2-操作索引"><a href="#5-2-操作索引" class="headerlink" title="5.2 操作索引"></a>5.2 操作索引</h2><ol><li><p><strong>添加索引</strong></p><p>添加goods_index索引，使用put请求(这里不是post，稍微注意下)，我这里是用postman操作的</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span><span class="hljs-number">192.168</span>.<span class="hljs-number">200.129</span>:<span class="hljs-number">9200</span>/goods_index<br></code></pre></td></tr></table></figure><p>操作成功后会看到</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>    <span class="hljs-attr">&quot;acknowledged&quot;</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">&quot;shards_acknowledged&quot;</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">&quot;index&quot;</span>: <span class="hljs-string">&quot;goods_index&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>查询索引</strong></p><p>使用get请求</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET http:<span class="hljs-regexp">//i</span>p:端口/索引名称  <span class="hljs-comment"># 查询单个索引信息</span><br>GET http:<span class="hljs-regexp">//i</span>p:端口/索引名称<span class="hljs-number">1</span>,索引名称<span class="hljs-number">2</span>  <span class="hljs-comment"># 查询多个索引信息</span><br>GET http:<span class="hljs-regexp">//i</span>p:端口/_all  <span class="hljs-comment"># 查询所有索引信息</span><br></code></pre></td></tr></table></figure></li><li><p><strong>删除索引</strong></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">DELETE http:<span class="hljs-regexp">//i</span>p:端口/索引名称<br></code></pre></td></tr></table></figure></li><li><p><strong>关闭及打开索引</strong></p><p>关闭是为了不想删除索引库，但是同时又不想让别人访问到，所以选择关闭。关闭之后不能往里面添加数据</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST http:<span class="hljs-regexp">//i</span>p:端口<span class="hljs-regexp">/索引名称/</span>_close  <br>POST http:<span class="hljs-regexp">//i</span>p:端口<span class="hljs-regexp">/索引名称/</span>_open <br></code></pre></td></tr></table></figure></li></ol><h2 id="5-3-ES数据类型"><a href="#5-3-ES数据类型" class="headerlink" title="5.3 ES数据类型"></a>5.3 ES数据类型</h2><ol><li><p><strong>简单数据类型</strong></p><ul><li><p>字符串</p><p>text：会分词，不支持聚合（聚合相当于mysql中的求和）</p><p>keyword：不会分词，将全部内容作为一个词条，支持聚合</p></li><li><p>数值</p></li><li><p>布尔</p><p>boolean</p></li><li><p>二进制</p><p>binary</p></li><li><p>范围类型</p><p>integer_range, float_range, long_range, double_range, date_range </p></li></ul></li><li><p><strong>复杂数据类型</strong></p><ul><li>数组：[ ] </li><li>对象：{ } </li></ul></li></ol><h2 id="5-4-操作映射"><a href="#5-4-操作映射" class="headerlink" title="5.4 操作映射"></a>5.4 操作映射</h2><p>下面的操作都是基于kibana的</p><ol><li><p><strong>添加映射</strong></p><p>先创建一个person索引</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">PUT person</span><br></code></pre></td></tr></table></figure><p>给索引添加映射</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs json">PUT /person/_mapping<br>&#123;<br>  <span class="hljs-attr">&quot;properties&quot;</span>:&#123;<br>    <span class="hljs-attr">&quot;name&quot;</span>:&#123;<br>      <span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;text&quot;</span><br>    &#125;,<br>    <span class="hljs-attr">&quot;age&quot;</span>:&#123;<br>      <span class="hljs-attr">&quot;type&quot;</span>:<span class="hljs-string">&quot;integer&quot;</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p>或者用另外一种方法直接在创建索引的同时创建好映射关系</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs json">#创建索引并添加映射<br>PUT /person1<br>&#123;<br>  <span class="hljs-attr">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;properties&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;name&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span><br>      &#125;,<br>      <span class="hljs-attr">&quot;age&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;integer&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>查询映射</strong></p><p>注意</p><ul><li>只用在kibana中写上查询方式以及映射名称就行了，不用写ip和端口啥的，比较方便</li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">GET</span> person1/_mapping<br></code></pre></td></tr></table></figure><p>查询的结果</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;person1&quot;</span> : &#123;# 索引名称<br>    <span class="hljs-attr">&quot;mappings&quot;</span> : &#123;# 映射<br>      <span class="hljs-attr">&quot;properties&quot;</span> : &#123;  # 映射的属性<br>        <span class="hljs-attr">&quot;age&quot;</span> : &#123;<br>          <span class="hljs-attr">&quot;type&quot;</span> : <span class="hljs-string">&quot;integer&quot;</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;name&quot;</span> : &#123;<br>          <span class="hljs-attr">&quot;type&quot;</span> : <span class="hljs-string">&quot;text&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>添加字段</strong></p><p>要是添加的是映射本来就有的，会报错，要是没有就直接添加。注意，对映射关系的修改中是没有直接删除映射的，因为这样容易产生事故</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs json">#添加字段<br>PUT /person1/_mapping<br>&#123;<br>  <span class="hljs-attr">&quot;properties&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;name&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span><br>      &#125;,<br>      <span class="hljs-attr">&quot;age&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;integer&quot;</span><br>      &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h2 id="5-5-操作文档"><a href="#5-5-操作文档" class="headerlink" title="5.5 操作文档"></a>5.5 操作文档</h2><ol><li><p><strong>添加文档以及查询文档</strong></p><p>添加文档，指定id</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json">POST /person1/_doc/<span class="hljs-number">2</span><br>&#123;<br>  <span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-string">&quot;张三&quot;</span>,<br>  <span class="hljs-attr">&quot;age&quot;</span>:<span class="hljs-number">18</span>,<br>  <span class="hljs-attr">&quot;address&quot;</span>:<span class="hljs-string">&quot;北京&quot;</span><br>&#125;<br><br># 添加完毕进行查询<br>GET /person1/_doc/<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>查询结果如下</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;_index&quot;</span> : <span class="hljs-string">&quot;person1&quot;</span>,<br>  <span class="hljs-attr">&quot;_type&quot;</span> : <span class="hljs-string">&quot;_doc&quot;</span>,<br>  <span class="hljs-attr">&quot;_id&quot;</span> : <span class="hljs-string">&quot;2&quot;</span>,<br>  <span class="hljs-attr">&quot;_version&quot;</span> : <span class="hljs-number">1</span>,<br>  <span class="hljs-attr">&quot;_seq_no&quot;</span> : <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">&quot;_primary_term&quot;</span> : <span class="hljs-number">1</span>,<br>  <span class="hljs-attr">&quot;found&quot;</span> : <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">&quot;_source&quot;</span> : &#123;<br>    <span class="hljs-attr">&quot;name&quot;</span> : <span class="hljs-string">&quot;张三&quot;</span>,<br>    <span class="hljs-attr">&quot;age&quot;</span> : <span class="hljs-number">18</span>,<br>    <span class="hljs-attr">&quot;address&quot;</span> : <span class="hljs-string">&quot;北京&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p>添加文档，不指定id</p><p>注意：</p><ul><li>稍微注意下如果查特定文档时候的语句以及查所有文档语句的区别</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json">#添加文档，不指定id<br>POST /person1/_doc/<br>&#123;<br>  <span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-string">&quot;张三&quot;</span>,<br>  <span class="hljs-attr">&quot;age&quot;</span>:<span class="hljs-number">18</span>,<br>  <span class="hljs-attr">&quot;address&quot;</span>:<span class="hljs-string">&quot;北京&quot;</span><br>&#125;<br><br>#查询所有文档<br>GET /person1/_search<br></code></pre></td></tr></table></figure><p>查询结果如下</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span> : <span class="hljs-number">778</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;</span> : <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span> : &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span> : <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span> : <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">&quot;skipped&quot;</span> : <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span> : <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;</span> : &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span> : &#123;<br>      <span class="hljs-attr">&quot;value&quot;</span> : <span class="hljs-number">2</span>,  # 查询到的文档数量<br>      <span class="hljs-attr">&quot;relation&quot;</span> : <span class="hljs-string">&quot;eq&quot;</span><br>    &#125;,<br>    <span class="hljs-attr">&quot;max_score&quot;</span> : <span class="hljs-number">1.0</span>,<br>    <span class="hljs-attr">&quot;hits&quot;</span> : [<br>      &#123;<br>        <span class="hljs-attr">&quot;_index&quot;</span> : <span class="hljs-string">&quot;person1&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span> : <span class="hljs-string">&quot;_doc&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span> : <span class="hljs-string">&quot;2&quot;</span>,<br>        <span class="hljs-attr">&quot;_score&quot;</span> : <span class="hljs-number">1.0</span>,<br>        <span class="hljs-attr">&quot;_source&quot;</span> : &#123;<br>          <span class="hljs-attr">&quot;name&quot;</span> : <span class="hljs-string">&quot;张三&quot;</span>,<br>          <span class="hljs-attr">&quot;age&quot;</span> : <span class="hljs-number">18</span>,<br>          <span class="hljs-attr">&quot;address&quot;</span> : <span class="hljs-string">&quot;北京&quot;</span><br>        &#125;<br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;_index&quot;</span> : <span class="hljs-string">&quot;person1&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span> : <span class="hljs-string">&quot;_doc&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span> : <span class="hljs-string">&quot;K5KtC3sBCY0ja69ZDmup&quot;</span>,  # 如果自己不指定文档id，系统会自动分配一个<br>        <span class="hljs-attr">&quot;_score&quot;</span> : <span class="hljs-number">1.0</span>,<br>        <span class="hljs-attr">&quot;_source&quot;</span> : &#123;<br>          <span class="hljs-attr">&quot;name&quot;</span> : <span class="hljs-string">&quot;李四&quot;</span>,<br>          <span class="hljs-attr">&quot;age&quot;</span> : <span class="hljs-number">20</span>,<br>          <span class="hljs-attr">&quot;address&quot;</span> : <span class="hljs-string">&quot;武汉&quot;</span><br>        &#125;<br>      &#125;<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>修改文档</strong></p></li><li><p><strong>删除文档</strong></p><p>删除指定文档</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs json">#删除指定id文档<br>DELETE /person1/_doc/K5KtC3sBCY0ja69ZDmup<br></code></pre></td></tr></table></figure></li></ol><h1 id="6-分词器"><a href="#6-分词器" class="headerlink" title="6. 分词器"></a>6. 分词器</h1><h2 id="6-1-分词器介绍"><a href="#6-1-分词器介绍" class="headerlink" title="6.1 分词器介绍"></a>6.1 分词器介绍</h2><ul><li>IKAnalyzer是一个开源的，基于java语言开发的轻量级的中文分词工具包</li><li>是一个基于Maven构建的项目</li><li>具有60万字/秒的高速处理能力</li><li>支持用户词典扩展定义</li></ul><p>下载地址（注意选择和es匹配的版本）：<a href="https://github.com/medcl/elasticsearch-analysis-ik/archive/v7.4.0.zip">https://github.com/medcl/elasticsearch-analysis-ik/archive/v7.4.0.zip</a> </p><h2 id="6-2-ik分词器安装"><a href="#6-2-ik分词器安装" class="headerlink" title="6.2 ik分词器安装"></a>6.2 ik分词器安装</h2><h3 id="6-2-1-环境准备"><a href="#6-2-1-环境准备" class="headerlink" title="6.2.1 环境准备"></a>6.2.1 环境准备</h3><p>Elasticsearch 要使用 ik，就要先构建 ik 的 jar包，这里要用到 maven 包管理工具，而 maven 需要java 环境，而 Elasticsearch 内置了jdk， 所以可以将JAVA_HOME设置为Elasticsearch 内置的jdk</p><ol><li><p>设置JAVA_HOME</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /etc/profile<br><span class="hljs-meta">#</span><span class="bash"> 在profile文件末尾添加</span><br><span class="hljs-meta">#</span><span class="bash">java environment</span><br>export JAVA_HOME=/opt/elasticsearch-7.4.0/jdk<br>export PATH=$PATH:$&#123;JAVA_HOME&#125;/bin<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> 保存退出后，重新加载profile</span><br>source /etc/profile<br></code></pre></td></tr></table></figure></li><li><p>下载maven安装包</p><p>有的镜像可能不好用，如果失败了就换其他镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget http://mirror.cc.columbia.edu/pub/software/apache/maven/maven-3/3.1.1/binaries/apache-maven-3.1.1-bin.tar.gz<br>wget http://maven.aliyun.com/pub/software/apache/maven/maven-3/3.1.1/binaries/apache-maven-3.1.1-bin.tar.gz<br></code></pre></td></tr></table></figure></li><li><p>解压maven安装包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">tar xzf apache-maven-3.1.1-bin.tar.gz <br></code></pre></td></tr></table></figure></li><li><p>设置软连接</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ln -s apache-maven-3.1.1 maven <br></code></pre></td></tr></table></figure></li><li><p>设置path</p><p>打开文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim  /etc/profile.d/maven.sh<br></code></pre></td></tr></table></figure><p>将下面的内容复制到文件，保存</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">export MAVEN_HOME=/opt/maven  <br>export PATH=$&#123;MAVEN_HOME&#125;/bin:$&#123;PATH&#125; <br></code></pre></td></tr></table></figure><p>设置好Maven的路径之后，需要运行下面的命令使其生效</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">source /etc/profile.d/maven.sh<br></code></pre></td></tr></table></figure></li><li><p>验证maven是否安装成功</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mvn -v<br></code></pre></td></tr></table></figure></li></ol><h3 id="6-2-2-安装IK分词器"><a href="#6-2-2-安装IK分词器" class="headerlink" title="6.2.2 安装IK分词器"></a>6.2.2 安装IK分词器</h3><ol><li><p>下载IK</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget https://github.com/medcl/elasticsearch-analysis-ik/archive/v7.4.0.zip<br></code></pre></td></tr></table></figure></li><li><p>解压IK</p><p>由于这里是zip包不是gz包，所以我们需要使用unzip命令进行解压，如果本机环境没有安装unzip，请执行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install zip <br>yum install unzip<br></code></pre></td></tr></table></figure><p>解压IK</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">unzip v7.4.0.zip<br></code></pre></td></tr></table></figure></li><li><p>编译jar包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 切换到 elasticsearch-analysis-ik-7.4.0目录</span><br>cd elasticsearch-analysis-ik-7.4.0/<br><span class="hljs-meta">#</span><span class="bash">打包</span><br>mvn package  #这里用阿里云的镜像弄，改一下配置就行了<br></code></pre></td></tr></table></figure></li><li><p> jar包移动</p></li></ol><p>   package执行完毕后会在当前目录下生成target/releases目录，将其中的elasticsearch-analysis-ik-7.4.0.zip。拷贝到elasticsearch目录下的新建的目录plugins/analysis-ik，并解压</p>   <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">切换目录</span><br>cd /opt/elasticsearch-7.4.0/plugins/<br><span class="hljs-meta">#</span><span class="bash">新建目录</span><br>mkdir analysis-ik<br>cd analysis-ik<br><span class="hljs-meta">#</span><span class="bash">执行拷贝</span><br>cp -R /opt/elasticsearch-analysis-ik-7.4.0/target/releases/elasticsearch-analysis-ik-7.4.0.zip      /opt/elasticsearch-7.4.0/plugins/analysis-ik<br><span class="hljs-meta">#</span><span class="bash">执行解压</span><br>unzip  /opt/elasticsearch-7.4.0/plugins/analysis-ik/elasticsearch-analysis-ik-7.4.0.zip<br></code></pre></td></tr></table></figure><ol start="5"><li><p>拷贝辞典</p><p>将elasticsearch-analysis-ik-7.4.0目录下的config目录中的所有文件 拷贝到elasticsearch的config目录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cp -R /opt/elasticsearch-analysis-ik-7.4.0/config/*   /opt/elasticsearch-7.4.0/config<br></code></pre></td></tr></table></figure></li></ol><p>最后记得重启es才能生效</p><h2 id="6-3-ik分词器使用"><a href="#6-3-ik分词器使用" class="headerlink" title="6.3 ik分词器使用"></a>6.3 ik分词器使用</h2><p>IK分词器有两种分词模式：ik_max_word和ik_smart模式。</p><ol><li><p><strong>ik_max_word</strong></p><p>会将文本做最细粒度的拆分，比如会将“乒乓球明年总冠军”拆分为“乒乓球、乒乓、球、明年、总冠军、冠军。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json">#方式一ik_max_word<br>GET /_analyze<br>&#123;<br>  <span class="hljs-attr">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span>,<br>  <span class="hljs-attr">&quot;text&quot;</span>: <span class="hljs-string">&quot;乒乓球明年总冠军&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ik_max_word分词器执行如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;tokens&quot;</span> : [<br>    &#123;<br>      <span class="hljs-attr">&quot;token&quot;</span> : <span class="hljs-string">&quot;乒乓球&quot;</span>,<br>      <span class="hljs-attr">&quot;start_offset&quot;</span> : <span class="hljs-number">0</span>,<br>      <span class="hljs-attr">&quot;end_offset&quot;</span> : <span class="hljs-number">3</span>,<br>      <span class="hljs-attr">&quot;type&quot;</span> : <span class="hljs-string">&quot;CN_WORD&quot;</span>,<br>      <span class="hljs-attr">&quot;position&quot;</span> : <span class="hljs-number">0</span><br>    &#125;,<br>    &#123;<br>      <span class="hljs-attr">&quot;token&quot;</span> : <span class="hljs-string">&quot;乒乓&quot;</span>,<br>      <span class="hljs-attr">&quot;start_offset&quot;</span> : <span class="hljs-number">0</span>,<br>      <span class="hljs-attr">&quot;end_offset&quot;</span> : <span class="hljs-number">2</span>,<br>      <span class="hljs-attr">&quot;type&quot;</span> : <span class="hljs-string">&quot;CN_WORD&quot;</span>,<br>      <span class="hljs-attr">&quot;position&quot;</span> : <span class="hljs-number">1</span><br>    &#125;,<br>    &#123;<br>      <span class="hljs-attr">&quot;token&quot;</span> : <span class="hljs-string">&quot;球&quot;</span>,<br>      <span class="hljs-attr">&quot;start_offset&quot;</span> : <span class="hljs-number">2</span>,<br>      <span class="hljs-attr">&quot;end_offset&quot;</span> : <span class="hljs-number">3</span>,<br>      <span class="hljs-attr">&quot;type&quot;</span> : <span class="hljs-string">&quot;CN_CHAR&quot;</span>,<br>      <span class="hljs-attr">&quot;position&quot;</span> : <span class="hljs-number">2</span><br>    &#125;,<br>    &#123;<br>      <span class="hljs-attr">&quot;token&quot;</span> : <span class="hljs-string">&quot;明年&quot;</span>,<br>      <span class="hljs-attr">&quot;start_offset&quot;</span> : <span class="hljs-number">3</span>,<br>      <span class="hljs-attr">&quot;end_offset&quot;</span> : <span class="hljs-number">5</span>,<br>      <span class="hljs-attr">&quot;type&quot;</span> : <span class="hljs-string">&quot;CN_WORD&quot;</span>,<br>      <span class="hljs-attr">&quot;position&quot;</span> : <span class="hljs-number">3</span><br>    &#125;,<br>    &#123;<br>      <span class="hljs-attr">&quot;token&quot;</span> : <span class="hljs-string">&quot;总冠军&quot;</span>,<br>      <span class="hljs-attr">&quot;start_offset&quot;</span> : <span class="hljs-number">5</span>,<br>      <span class="hljs-attr">&quot;end_offset&quot;</span> : <span class="hljs-number">8</span>,<br>      <span class="hljs-attr">&quot;type&quot;</span> : <span class="hljs-string">&quot;CN_WORD&quot;</span>,<br>      <span class="hljs-attr">&quot;position&quot;</span> : <span class="hljs-number">4</span><br>    &#125;,<br>    &#123;<br>      <span class="hljs-attr">&quot;token&quot;</span> : <span class="hljs-string">&quot;冠军&quot;</span>,<br>      <span class="hljs-attr">&quot;start_offset&quot;</span> : <span class="hljs-number">6</span>,<br>      <span class="hljs-attr">&quot;end_offset&quot;</span> : <span class="hljs-number">8</span>,<br>      <span class="hljs-attr">&quot;type&quot;</span> : <span class="hljs-string">&quot;CN_WORD&quot;</span>,<br>      <span class="hljs-attr">&quot;position&quot;</span> : <span class="hljs-number">5</span><br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>ik_smart</strong></p><p>会做最粗粒度的拆分，比如会将“乒乓球明年总冠军”拆分为乒乓球、明年、总冠军。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json">#方式二ik_smart<br>GET /_analyze<br>&#123;<br>  <span class="hljs-attr">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_smart&quot;</span>,<br>  <span class="hljs-attr">&quot;text&quot;</span>: <span class="hljs-string">&quot;乒乓球明年总冠军&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ik_smart分词器执行如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;tokens&quot;</span> : [<br>    &#123;<br>      <span class="hljs-attr">&quot;token&quot;</span> : <span class="hljs-string">&quot;乒乓球&quot;</span>,<br>      <span class="hljs-attr">&quot;start_offset&quot;</span> : <span class="hljs-number">0</span>,<br>      <span class="hljs-attr">&quot;end_offset&quot;</span> : <span class="hljs-number">3</span>,<br>      <span class="hljs-attr">&quot;type&quot;</span> : <span class="hljs-string">&quot;CN_WORD&quot;</span>,<br>      <span class="hljs-attr">&quot;position&quot;</span> : <span class="hljs-number">0</span><br>    &#125;,<br>    &#123;<br>      <span class="hljs-attr">&quot;token&quot;</span> : <span class="hljs-string">&quot;明年&quot;</span>,<br>      <span class="hljs-attr">&quot;start_offset&quot;</span> : <span class="hljs-number">3</span>,<br>      <span class="hljs-attr">&quot;end_offset&quot;</span> : <span class="hljs-number">5</span>,<br>      <span class="hljs-attr">&quot;type&quot;</span> : <span class="hljs-string">&quot;CN_WORD&quot;</span>,<br>      <span class="hljs-attr">&quot;position&quot;</span> : <span class="hljs-number">1</span><br>    &#125;,<br>    &#123;<br>      <span class="hljs-attr">&quot;token&quot;</span> : <span class="hljs-string">&quot;总冠军&quot;</span>,<br>      <span class="hljs-attr">&quot;start_offset&quot;</span> : <span class="hljs-number">5</span>,<br>      <span class="hljs-attr">&quot;end_offset&quot;</span> : <span class="hljs-number">8</span>,<br>      <span class="hljs-attr">&quot;type&quot;</span> : <span class="hljs-string">&quot;CN_WORD&quot;</span>,<br>      <span class="hljs-attr">&quot;position&quot;</span> : <span class="hljs-number">2</span><br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h2 id="6-4-使用IK分词器-查询文档"><a href="#6-4-使用IK分词器-查询文档" class="headerlink" title="6.4 使用IK分词器-查询文档"></a>6.4 使用IK分词器-查询文档</h2><ul><li><p>词条查询：term</p><p>词条查询不会分析查询条件，只有当词条和查询字符串完全匹配时才匹配搜索</p></li><li><p>全文查询：match</p><p>全文查询会分析查询条件，先将查询条件进行分词，然后查询，求并集</p></li></ul><p><strong>分词案例</strong></p><ol><li><p>创建索引，添加映射，并指定分词器为ik分词器</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs json">PUT person2<br>&#123;<br>  <span class="hljs-attr">&quot;mappings&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;properties&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;name&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;keyword&quot;</span><br>      &#125;,<br>      <span class="hljs-attr">&quot;address&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>        <span class="hljs-attr">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>添加文档</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs json">POST /person2/_doc/<span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-string">&quot;张三&quot;</span>,<br>  <span class="hljs-attr">&quot;age&quot;</span>:<span class="hljs-number">18</span>,<br>  <span class="hljs-attr">&quot;address&quot;</span>:<span class="hljs-string">&quot;北京海淀区&quot;</span><br>&#125;<br><br>POST /person2/_doc/<span class="hljs-number">2</span><br>&#123;<br>  <span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-string">&quot;李四&quot;</span>,<br>  <span class="hljs-attr">&quot;age&quot;</span>:<span class="hljs-number">18</span>,<br>  <span class="hljs-attr">&quot;address&quot;</span>:<span class="hljs-string">&quot;北京朝阳区&quot;</span><br>&#125;<br><br>POST /person2/_doc/<span class="hljs-number">3</span><br>&#123;<br>  <span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-string">&quot;王五&quot;</span>,<br>  <span class="hljs-attr">&quot;age&quot;</span>:<span class="hljs-number">18</span>,<br>  <span class="hljs-attr">&quot;address&quot;</span>:<span class="hljs-string">&quot;北京昌平区&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>查询映射</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">GET person2<br></code></pre></td></tr></table></figure><p>查询结果</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;person2&quot;</span> : &#123;<br>    <span class="hljs-attr">&quot;aliases&quot;</span> : &#123; &#125;,<br>    <span class="hljs-attr">&quot;mappings&quot;</span> : &#123;<br>      <span class="hljs-attr">&quot;properties&quot;</span> : &#123;<br>        <span class="hljs-attr">&quot;address&quot;</span> : &#123;<br>          <span class="hljs-attr">&quot;type&quot;</span> : <span class="hljs-string">&quot;text&quot;</span>,<br>          <span class="hljs-attr">&quot;analyzer&quot;</span> : <span class="hljs-string">&quot;ik_max_word&quot;</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;age&quot;</span> : &#123;<br>          <span class="hljs-attr">&quot;type&quot;</span> : <span class="hljs-string">&quot;long&quot;</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;name&quot;</span> : &#123;<br>          <span class="hljs-attr">&quot;type&quot;</span> : <span class="hljs-string">&quot;keyword&quot;</span><br>        &#125;<br>      &#125;<br>    &#125;,<br>    <span class="hljs-attr">&quot;settings&quot;</span> : &#123;<br>      <span class="hljs-attr">&quot;index&quot;</span> : &#123;<br>        <span class="hljs-attr">&quot;creation_date&quot;</span> : <span class="hljs-string">&quot;1627990806608&quot;</span>,<br>        <span class="hljs-attr">&quot;number_of_shards&quot;</span> : <span class="hljs-string">&quot;1&quot;</span>,<br>        <span class="hljs-attr">&quot;number_of_replicas&quot;</span> : <span class="hljs-string">&quot;1&quot;</span>,<br>        <span class="hljs-attr">&quot;uuid&quot;</span> : <span class="hljs-string">&quot;fVX6890BS1a2WBqeFtVqoA&quot;</span>,<br>        <span class="hljs-attr">&quot;version&quot;</span> : &#123;<br>          <span class="hljs-attr">&quot;created&quot;</span> : <span class="hljs-string">&quot;7040099&quot;</span><br>        &#125;,<br>        <span class="hljs-attr">&quot;provided_name&quot;</span> : <span class="hljs-string">&quot;person2&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>查看分词效果</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">GET _analyze<br>&#123;<br>  <span class="hljs-attr">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span>,<br>  <span class="hljs-attr">&quot;text&quot;</span>: <span class="hljs-string">&quot;北京海淀&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;tokens&quot;</span> : [<br>    &#123;<br>      <span class="hljs-attr">&quot;token&quot;</span> : <span class="hljs-string">&quot;北京&quot;</span>,<br>      <span class="hljs-attr">&quot;start_offset&quot;</span> : <span class="hljs-number">0</span>,<br>      <span class="hljs-attr">&quot;end_offset&quot;</span> : <span class="hljs-number">2</span>,<br>      <span class="hljs-attr">&quot;type&quot;</span> : <span class="hljs-string">&quot;CN_WORD&quot;</span>,<br>      <span class="hljs-attr">&quot;position&quot;</span> : <span class="hljs-number">0</span><br>    &#125;,<br>    &#123;<br>      <span class="hljs-attr">&quot;token&quot;</span> : <span class="hljs-string">&quot;京海&quot;</span>,<br>      <span class="hljs-attr">&quot;start_offset&quot;</span> : <span class="hljs-number">1</span>,<br>      <span class="hljs-attr">&quot;end_offset&quot;</span> : <span class="hljs-number">3</span>,<br>      <span class="hljs-attr">&quot;type&quot;</span> : <span class="hljs-string">&quot;CN_WORD&quot;</span>,<br>      <span class="hljs-attr">&quot;position&quot;</span> : <span class="hljs-number">1</span><br>    &#125;,<br>    &#123;<br>      <span class="hljs-attr">&quot;token&quot;</span> : <span class="hljs-string">&quot;海淀&quot;</span>,<br>      <span class="hljs-attr">&quot;start_offset&quot;</span> : <span class="hljs-number">2</span>,<br>      <span class="hljs-attr">&quot;end_offset&quot;</span> : <span class="hljs-number">4</span>,<br>      <span class="hljs-attr">&quot;type&quot;</span> : <span class="hljs-string">&quot;CN_WORD&quot;</span>,<br>      <span class="hljs-attr">&quot;position&quot;</span> : <span class="hljs-number">2</span><br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>分词器查询</p><p>5.1 词条查询（term）</p><p>查询person2中匹配到”北京”两字的词条</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json">GET /person2/_search<br>&#123;<br>  <span class="hljs-attr">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;term&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;address&quot;</span>: &#123;<br>        <span class="hljs-attr">&quot;value&quot;</span>: <span class="hljs-string">&quot;北京昌平&quot;</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>查询结果</p><p>可以看见并没有查到，因为分词的时候并没有一个叫做“北京昌平”的token, 所以按照term匹配的时候并没有搜索出地址为北京昌平区的那个文档</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span> : <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;</span> : <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span> : &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span> : <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span> : <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">&quot;skipped&quot;</span> : <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span> : <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;</span> : &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span> : &#123;<br>      <span class="hljs-attr">&quot;value&quot;</span> : <span class="hljs-number">0</span>,<br>      <span class="hljs-attr">&quot;relation&quot;</span> : <span class="hljs-string">&quot;eq&quot;</span><br>    &#125;,<br>    <span class="hljs-attr">&quot;max_score&quot;</span> : <span class="hljs-literal">null</span>,<br>    <span class="hljs-attr">&quot;hits&quot;</span> : [ ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><p>5.2 全文查询 (match)</p><p>全文查询会分析查询条件，先将查询条件进行分词，然后查询，求并集</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json">GET /person2/_search<br>&#123;<br>  <span class="hljs-attr">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-attr">&quot;match&quot;</span>: &#123;<br>      <span class="hljs-attr">&quot;address&quot;</span>:<span class="hljs-string">&quot;北京昌平&quot;</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>查询结果如下</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;took&quot;</span> : <span class="hljs-number">22</span>,<br>  <span class="hljs-attr">&quot;timed_out&quot;</span> : <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">&quot;_shards&quot;</span> : &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span> : <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">&quot;successful&quot;</span> : <span class="hljs-number">1</span>,<br>    <span class="hljs-attr">&quot;skipped&quot;</span> : <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">&quot;failed&quot;</span> : <span class="hljs-number">0</span><br>  &#125;,<br>  <span class="hljs-attr">&quot;hits&quot;</span> : &#123;<br>    <span class="hljs-attr">&quot;total&quot;</span> : &#123;<br>      <span class="hljs-attr">&quot;value&quot;</span> : <span class="hljs-number">3</span>,<br>      <span class="hljs-attr">&quot;relation&quot;</span> : <span class="hljs-string">&quot;eq&quot;</span><br>    &#125;,<br>    <span class="hljs-attr">&quot;max_score&quot;</span> : <span class="hljs-number">1.1505673</span>,<br>    <span class="hljs-attr">&quot;hits&quot;</span> : [<br>      &#123;<br>        <span class="hljs-attr">&quot;_index&quot;</span> : <span class="hljs-string">&quot;person2&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span> : <span class="hljs-string">&quot;_doc&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span> : <span class="hljs-string">&quot;3&quot;</span>,<br>        <span class="hljs-attr">&quot;_score&quot;</span> : <span class="hljs-number">1.1505673</span>,<br>        <span class="hljs-attr">&quot;_source&quot;</span> : &#123;<br>          <span class="hljs-attr">&quot;name&quot;</span> : <span class="hljs-string">&quot;王五&quot;</span>,<br>          <span class="hljs-attr">&quot;age&quot;</span> : <span class="hljs-number">18</span>,<br>          <span class="hljs-attr">&quot;address&quot;</span> : <span class="hljs-string">&quot;北京昌平区&quot;</span><br>        &#125;<br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;_index&quot;</span> : <span class="hljs-string">&quot;person2&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span> : <span class="hljs-string">&quot;_doc&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span> : <span class="hljs-string">&quot;2&quot;</span>,<br>        <span class="hljs-attr">&quot;_score&quot;</span> : <span class="hljs-number">0.13786995</span>,<br>        <span class="hljs-attr">&quot;_source&quot;</span> : &#123;<br>          <span class="hljs-attr">&quot;name&quot;</span> : <span class="hljs-string">&quot;李四&quot;</span>,<br>          <span class="hljs-attr">&quot;age&quot;</span> : <span class="hljs-number">18</span>,<br>          <span class="hljs-attr">&quot;address&quot;</span> : <span class="hljs-string">&quot;北京朝阳区&quot;</span><br>        &#125;<br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">&quot;_index&quot;</span> : <span class="hljs-string">&quot;person2&quot;</span>,<br>        <span class="hljs-attr">&quot;_type&quot;</span> : <span class="hljs-string">&quot;_doc&quot;</span>,<br>        <span class="hljs-attr">&quot;_id&quot;</span> : <span class="hljs-string">&quot;1&quot;</span>,<br>        <span class="hljs-attr">&quot;_score&quot;</span> : <span class="hljs-number">0.12562492</span>,<br>        <span class="hljs-attr">&quot;_source&quot;</span> : &#123;<br>          <span class="hljs-attr">&quot;name&quot;</span> : <span class="hljs-string">&quot;张三&quot;</span>,<br>          <span class="hljs-attr">&quot;age&quot;</span> : <span class="hljs-number">18</span>,<br>          <span class="hljs-attr">&quot;address&quot;</span> : <span class="hljs-string">&quot;北京海淀区&quot;</span><br>        &#125;<br>      &#125;<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h1 id="7-ElasticSearch-JavaApi"><a href="#7-ElasticSearch-JavaApi" class="headerlink" title="7. ElasticSearch JavaApi"></a>7. ElasticSearch JavaApi</h1><p>开发人员一般使用这部分知识比较多。一般是操作文档，对于索引和映射一般都是通过脚本提前创建好了的</p><h2 id="7-1-SpringBoot整合ES"><a href="#7-1-SpringBoot整合ES" class="headerlink" title="7.1 SpringBoot整合ES"></a>7.1 SpringBoot整合ES</h2><ol><li><p>搭建SpringBoot工程</p></li><li><p>引入ElasticSearch相关依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--引入es的坐标--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.elasticsearch.client<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.elasticsearch.client<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elasticsearch-rest-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.elasticsearch<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elasticsearch<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>配置es的yml文件</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">elasticsearch:</span><br>  <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.129</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9200</span><br></code></pre></td></tr></table></figure></li><li><p>配置ES客户端的测试类，用于获得es的客户端对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ConfigurationProperties(prefix=&quot;elasticsearch&quot;)</span> <span class="hljs-comment">//读取配置文件中前缀为elasticsearch的属性值，并在程序启动的时候自动将这些属性注入到这个配置类中对应的成员变量</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ElasticSearchConfig</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> String host;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> port;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getHost</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> host;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setHost</span><span class="hljs-params">(String host)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.host = host;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getPort</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> port;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setPort</span><span class="hljs-params">(<span class="hljs-keyword">int</span> port)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.port = port;<br>    &#125;<br>    <span class="hljs-comment">//创建es客户端对象</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> RestHighLevelClient <span class="hljs-title">client</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RestHighLevelClient(RestClient.builder(<br>                <span class="hljs-keyword">new</span> HttpHost(host,port,<span class="hljs-string">&quot;http&quot;</span>)<br>        ));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>在测试类中测试是否能注入RestHighLevelClient 对象</p><p>如果能打印出对象的信息说明整个过程是成功的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ElasticsearchApplicationTests</span> </span>&#123;<br><br><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> RestHighLevelClient client;<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">contextLoads</span><span class="hljs-params">()</span> </span>&#123;<br>System.out.println(client);<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h2 id="7-2-操作索引"><a href="#7-2-操作索引" class="headerlink" title="7.2 操作索引"></a>7.2 操作索引</h2><h3 id="7-2-1-添加索引"><a href="#7-2-1-添加索引" class="headerlink" title="7.2.1 添加索引"></a>7.2.1 添加索引</h3><ol><li><p>添加索引</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 添加索引</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addIndex</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br><span class="hljs-comment">//1.使用client获取操作索引对象</span><br>IndicesClient indices = client.indices();<br>   <br><span class="hljs-comment">//2.具体操作获取返回值</span><br><span class="hljs-comment">//2.1 设置索引名称</span><br>CreateIndexRequest createIndexRequest=<span class="hljs-keyword">new</span> CreateIndexRequest(<span class="hljs-string">&quot;itheima1&quot;</span>);<br>CreateIndexResponse createIndexResponse = indices.create(createIndexRequest, RequestOptions.DEFAULT);<br>   <br><span class="hljs-comment">//3.根据返回值判断结果</span><br>System.out.println(createIndexResponse.isAcknowledged());<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>添加索引，并添加映射</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 添加索引，并添加映射</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addIndexAndMapping</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br><span class="hljs-comment">//1.使用client获取操作索引对象</span><br>IndicesClient indices = client.indices();<br><span class="hljs-comment">//2.具体操作获取返回值</span><br><span class="hljs-comment">//2.具体操作，获取返回值</span><br>CreateIndexRequest createIndexRequest = <span class="hljs-keyword">new</span> CreateIndexRequest(<span class="hljs-string">&quot;itcast1&quot;</span>);<br><span class="hljs-comment">//2.1 设置mappings</span><br>String mapping = <span class="hljs-string">&quot;&#123;\n&quot;</span> +<br><span class="hljs-string">&quot;      \&quot;properties\&quot; : &#123;\n&quot;</span> +<br><span class="hljs-string">&quot;        \&quot;address\&quot; : &#123;\n&quot;</span> +<br><span class="hljs-string">&quot;          \&quot;type\&quot; : \&quot;text\&quot;,\n&quot;</span> +<br><span class="hljs-string">&quot;          \&quot;analyzer\&quot; : \&quot;ik_max_word\&quot;\n&quot;</span> +<br><span class="hljs-string">&quot;        &#125;,\n&quot;</span> +<br><span class="hljs-string">&quot;        \&quot;age\&quot; : &#123;\n&quot;</span> +<br><span class="hljs-string">&quot;          \&quot;type\&quot; : \&quot;long\&quot;\n&quot;</span> +<br><span class="hljs-string">&quot;        &#125;,\n&quot;</span> +<br><span class="hljs-string">&quot;        \&quot;name\&quot; : &#123;\n&quot;</span> +<br><span class="hljs-string">&quot;          \&quot;type\&quot; : \&quot;keyword\&quot;\n&quot;</span> +<br><span class="hljs-string">&quot;        &#125;\n&quot;</span> +<br><span class="hljs-string">&quot;      &#125;\n&quot;</span> +<br><span class="hljs-string">&quot;    &#125;&quot;</span>;<br>createIndexRequest.mapping(mapping, XContentType.JSON);<br><br>CreateIndexResponse createIndexResponse = indices.create(createIndexRequest, RequestOptions.DEFAULT);<br><span class="hljs-comment">//3.根据返回值判断结果</span><br>System.out.println(createIndexResponse.isAcknowledged());<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h3 id="7-2-2-查询、删除、判断索引"><a href="#7-2-2-查询、删除、判断索引" class="headerlink" title="7.2.2 查询、删除、判断索引"></a>7.2.2 查询、删除、判断索引</h3><p>查询索引</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 查询索引</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">queryIndex</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>IndicesClient indices = client.indices();<br><br>GetIndexRequest getRequest=<span class="hljs-keyword">new</span> GetIndexRequest(<span class="hljs-string">&quot;itcast&quot;</span>);<br>GetIndexResponse response = indices.get(getRequest, RequestOptions.DEFAULT);<br>Map&lt;String, MappingMetaData&gt; mappings = response.getMappings();<br><span class="hljs-comment">//iter 提示foreach</span><br><span class="hljs-keyword">for</span> (String key : mappings.keySet()) &#123;<br>System.out.println(key+<span class="hljs-string">&quot;===&quot;</span>+mappings.get(key).getSourceAsMap());<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>删除索引</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 删除索引</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">deleteIndex</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>IndicesClient indices = client.indices();<br>DeleteIndexRequest deleteRequest=<span class="hljs-keyword">new</span> DeleteIndexRequest(<span class="hljs-string">&quot;itheima&quot;</span>);<br>AcknowledgedResponse delete = indices.delete(deleteRequest, RequestOptions.DEFAULT);<br>System.out.println(delete.isAcknowledged());<br>&#125;<br></code></pre></td></tr></table></figure><p>判断索引是否存在</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 索引是否存在</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">existIndex</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>IndicesClient indices = client.indices();<br><br>GetIndexRequest getIndexRequest=<span class="hljs-keyword">new</span> GetIndexRequest(<span class="hljs-string">&quot;itheima&quot;</span>);<br><span class="hljs-keyword">boolean</span> exists = indices.exists(getIndexRequest, RequestOptions.DEFAULT);<br><br>System.out.println(exists);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="7-3-操作文档"><a href="#7-3-操作文档" class="headerlink" title="7.3 操作文档"></a>7.3 操作文档</h2><h3 id="7-3-1-添加文档"><a href="#7-3-1-添加文档" class="headerlink" title="7.3.1 添加文档"></a>7.3.1 添加文档</h3><ol><li><p>添加文档,使用map作为数据</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addDoc1</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>Map&lt;String, Object&gt; map=<span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>map.put(<span class="hljs-string">&quot;name&quot;</span>,<span class="hljs-string">&quot;张三&quot;</span>);<br>map.put(<span class="hljs-string">&quot;age&quot;</span>,<span class="hljs-string">&quot;18&quot;</span>);<br>map.put(<span class="hljs-string">&quot;address&quot;</span>,<span class="hljs-string">&quot;北京二环&quot;</span>);<br>IndexRequest request=<span class="hljs-keyword">new</span> IndexRequest(<span class="hljs-string">&quot;itcast1&quot;</span>).id(<span class="hljs-string">&quot;1&quot;</span>).source(map);<br>IndexResponse response = client.index(request, RequestOptions.DEFAULT);<br>System.out.println(response.getId());<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>添加文档,使用对象作为数据</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addDoc2</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>Person person=<span class="hljs-keyword">new</span> Person();<br>person.setId(<span class="hljs-string">&quot;2&quot;</span>);<br>person.setName(<span class="hljs-string">&quot;李四&quot;</span>);<br>person.setAge(<span class="hljs-number">20</span>);<br>person.setAddress(<span class="hljs-string">&quot;北京三环&quot;</span>);<br>String data = JSON.toJSONString(person);<br>IndexRequest request=<span class="hljs-keyword">new</span> IndexRequest(<span class="hljs-string">&quot;itcast1&quot;</span>).id(person.getId()).source(data,XContentType.JSON);<br>IndexResponse response = client.index(request, RequestOptions.DEFAULT);<br>System.out.println(response.getId());<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h3 id="7-3-2-修改、查询、删除文档"><a href="#7-3-2-修改、查询、删除文档" class="headerlink" title="7.3.2 修改、查询、删除文档"></a>7.3.2 修改、查询、删除文档</h3><ol><li><p>修改文档：添加文档时，如果id存在则修改，id不存在则添加</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UpdateDoc</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>Person person=<span class="hljs-keyword">new</span> Person();<br>person.setId(<span class="hljs-string">&quot;2&quot;</span>);<br>person.setName(<span class="hljs-string">&quot;李四&quot;</span>);<br>person.setAge(<span class="hljs-number">20</span>);<br>person.setAddress(<span class="hljs-string">&quot;北京三环车王&quot;</span>);<br>   <br>String data = JSON.toJSONString(person);<br>   <br>IndexRequest request=<span class="hljs-keyword">new</span> IndexRequest(<span class="hljs-string">&quot;itcast1&quot;</span>).id(person.getId()).source(data,XContentType.JSON);<br>IndexResponse response = client.index(request, RequestOptions.DEFAULT);<br>System.out.println(response.getId());<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>根据id查询文档</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据id查询文档</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getDoc</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>   <br>    <span class="hljs-comment">//设置查询的索引、文档</span><br>    GetRequest indexRequest=<span class="hljs-keyword">new</span> GetRequest(<span class="hljs-string">&quot;itcast&quot;</span>,<span class="hljs-string">&quot;2&quot;</span>);<br>   <br>    GetResponse response = client.get(indexRequest, RequestOptions.DEFAULT);<br>    System.out.println(response.getSourceAsString());<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>根据id删除文档</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据id删除文档</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">delDoc</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>   <br><span class="hljs-comment">//设置要删除的索引、文档</span><br>DeleteRequest deleteRequest=<span class="hljs-keyword">new</span> DeleteRequest(<span class="hljs-string">&quot;itcast&quot;</span>,<span class="hljs-string">&quot;1&quot;</span>);<br>   <br>DeleteResponse response = client.delete(deleteRequest, RequestOptions.DEFAULT);<br>System.out.println(response.getId());<br>&#125;<br></code></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Hystrix</title>
    <link href="/2021/08/01/4.%20Hystrix%20%E7%86%94%E6%96%AD%E5%99%A8/"/>
    <url>/2021/08/01/4.%20Hystrix%20%E7%86%94%E6%96%AD%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="1-Hystrix-概述"><a href="#1-Hystrix-概述" class="headerlink" title="1. Hystrix 概述"></a>1. <strong>Hystrix</strong> 概述</h1><ul><li>Hystix 是 Netflix 开源的一个延迟和容错库，用于隔离访问远程服务、第三方库，防止出现级联失败（雪崩: 一个服务失败，导致整条链路的服务都失败的情形）。</li></ul><p>Hystix 主要功能</p><ol><li>隔离<ol><li>线程池隔离 （对要请求的微服务设置可使用的线程数，这样不会导致一个微服务占用所有线程）</li><li>信号量隔离</li></ol></li><li>降级 （对异常提供降级方案，出现异常了就调用降级方案）</li><li>熔断</li><li>限流</li></ol><h2 id="1-1-Hystrix-降级"><a href="#1-1-Hystrix-降级" class="headerlink" title="1.1 Hystrix 降级"></a>1.1 <strong>Hystrix</strong> <strong>降级</strong></h2><p>Hystix 降级：当服务发生异常或调用超时，返回默认数据</p><p><img src="/images/image-20210801232052828.png" alt="image-20210801232052828"></p><h3 id="1-1-1-服务提供方"><a href="#1-1-1-服务提供方" class="headerlink" title="1.1.1 服务提供方"></a>1.1.1 服务提供方</h3><ol><li><p>在服务提供方，引入hystrix依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- hystrix --&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>在服务提供方的启动类上开启hystrix功能<code>@EnableCircuitBreaker</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableEurekaClient</span> <span class="hljs-comment">//该注解 在新版本中可以省略</span><br><span class="hljs-meta">@SpringBootApplication</span><br><br><span class="hljs-meta">@EnableCircuitBreaker</span> <span class="hljs-comment">// 开启Hystrix功能</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProviderApp</span> </span>&#123;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(ProviderApp.class,args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>对要被消费者调用的方法定义降级方法</p><p>注意： </p><ul><li>使用注解<code>@HystrixCommand(fallbackMethod = &quot;findOne_fallback&quot;)</code>指定降级方法</li><li>定义降级方法注意事项<ul><li>方法的返回值需要和原方法一样</li><li>方法的参数需要和原方法一样</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Goods Controller 服务提供方</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/goods&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GoodsController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> GoodsService goodsService;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> port;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 降级：</span><br><span class="hljs-comment">     *  1. 出现异常</span><br><span class="hljs-comment">     *  2. 服务调用超时</span><br><span class="hljs-comment">     *      * 默认1s超时</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     *  <span class="hljs-doctag">@HystrixCommand</span>(fallbackMethod = &quot;findOne_fallback&quot;)</span><br><span class="hljs-comment">     *      fallbackMethod：指定降级后调用的方法名称</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-meta">@GetMapping(&quot;/findOne/&#123;id&#125;&quot;)</span><br>    <span class="hljs-meta">@HystrixCommand(fallbackMethod = &quot;findOne_fallback&quot;,commandProperties = &#123;</span><br><span class="hljs-meta">            //设置Hystrix的超时时间，默认1s</span><br><span class="hljs-meta">            @HystrixProperty(name=&quot;execution.isolation.thread.timeoutInMilliseconds&quot;,value = &quot;3000&quot;)</span><br><span class="hljs-meta"></span><br><span class="hljs-meta">    &#125;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Goods <span class="hljs-title">findOne</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> <span class="hljs-keyword">int</span> id)</span></span>&#123;<br><br>        <span class="hljs-comment">//1.造个异常</span><br>        <span class="hljs-keyword">int</span> i = <span class="hljs-number">3</span>/<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//2. 休眠2秒</span><br>            Thread.sleep(<span class="hljs-number">2000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        Goods goods = goodsService.findOne(id);<br><br>        goods.setTitle(goods.getTitle() + <span class="hljs-string">&quot;:&quot;</span> + port);<span class="hljs-comment">//将端口号，设置到了 商品标题上</span><br>        <span class="hljs-keyword">return</span> goods;<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 定义降级方法：</span><br><span class="hljs-comment">     *  1. 方法的返回值需要和原方法一样</span><br><span class="hljs-comment">     *  2. 方法的参数需要和原方法一样</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Goods <span class="hljs-title">findOne_fallback</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span></span>&#123;<br>        Goods goods = <span class="hljs-keyword">new</span> Goods();<br>        goods.setTitle(<span class="hljs-string">&quot;降级了~~~&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> goods;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h3 id="1-1-2-服务消费方"><a href="#1-1-2-服务消费方" class="headerlink" title="1.1.2 服务消费方"></a>1.1.2 服务消费方</h3><ol><li><p>因为feign组件中已经集成了hystrix组件，所以hytrix的依赖就不用导入了</p></li><li><p>配置yml文件，开启feign对hystrix的支持</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 开启feign对hystrix的支持</span><br><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">hystrix:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure></li><li><p>定义feign 调用接口实现类，复写方法，即 降级方法</p><p>注意：</p><ul><li>降级类要实现<code>GoodsFeignClient</code>接口</li><li>记得将这个降级类放到spring容器中</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Feign 客户端的降级处理类</span><br><span class="hljs-comment"> * 1. 定义类 实现 Feign 客户端接口</span><br><span class="hljs-comment"> * 2. 使用<span class="hljs-doctag">@Component</span>注解将该类的Bean加入SpringIOC容器</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GoodsFeignClientFallback</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">GoodsFeignClient</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Goods <span class="hljs-title">findGoodsById</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span> </span>&#123;<br>        Goods goods = <span class="hljs-keyword">new</span> Goods();<br>        goods.setTitle(<span class="hljs-string">&quot;又被降级了~~~&quot;</span>);<br>        <span class="hljs-keyword">return</span> goods;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>在 @FeignClient 注解中使用 fallback 属性设置刚编写的降级处理类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(value = &quot;HYSTRIX-PROVIDER&quot;,fallback = GoodsFeignClientFallback.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">GoodsFeignClient</span> </span>&#123;<br><br><br>    <span class="hljs-meta">@GetMapping(&quot;/goods/findOne/&#123;id&#125;&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Goods <span class="hljs-title">findGoodsById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> <span class="hljs-keyword">int</span> id)</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h2 id="1-2-Hystrix熔断"><a href="#1-2-Hystrix熔断" class="headerlink" title="1.2 Hystrix熔断"></a>1.2 Hystrix熔断</h2><p>Hystrix 熔断机制，用于监控微服务调用情况，当失败的情况达到预定的阈值（5秒失败20次），会打开断路器，拒绝所有请求（全都降级），直到服务恢复正常为止。</p><p>断路器状态改变图：</p><p>连续调用服务方的方法出现异常或连接超时导致服务降级时，若达到预定的阈值，断路器打开，此时无论请求是否正常都会提供降级方法给消费方。等到默认开启时间结束，断路器会转变为半开状态，这时会放过来一个请求，如果调用成功，断路器关闭；反之断路器会再次打开。</p><p><img src="/images/image-20210802212254669.png" alt="image-20210802212254669"></p><p>在1.1配置hystrix时，已经有了默认参数的熔断机制，不需要自己额外编写代码。</p><p>在服务提供方的方法上可以改变熔断机制的一些默认参数</p><p>到时候如果要改的话，参照下面<code>@HystrixProperty</code>注解代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/findOne/&#123;id&#125;&quot;)</span><br><span class="hljs-meta">@HystrixCommand(fallbackMethod = &quot;findOne_fallback&quot;,commandProperties = &#123;</span><br><span class="hljs-meta">        //设置Hystrix的超时时间，默认1s</span><br><span class="hljs-meta">        @HystrixProperty(name=&quot;execution.isolation.thread.timeoutInMilliseconds&quot;,value = &quot;3000&quot;),</span><br><span class="hljs-meta">        //监控时间 默认5000 毫秒</span><br><span class="hljs-meta">        @HystrixProperty(name=&quot;circuitBreaker.sleepWindowInMilliseconds&quot;,value = &quot;5000&quot;),</span><br><span class="hljs-meta">        //失败次数。默认20次</span><br><span class="hljs-meta">        @HystrixProperty(name=&quot;circuitBreaker.requestVolumeThreshold&quot;,value = &quot;20&quot;),</span><br><span class="hljs-meta">        //失败率 默认50%</span><br><span class="hljs-meta">        @HystrixProperty(name=&quot;circuitBreaker.errorThresholdPercentage&quot;,value = &quot;50&quot;)</span><br><span class="hljs-meta"></span><br><span class="hljs-meta">&#125;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Goods <span class="hljs-title">findOne</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> <span class="hljs-keyword">int</span> id)</span></span>&#123;<br><br>    <span class="hljs-comment">//如果id == 1 ，则出现异常，id != 1 则正常访问</span><br>    <span class="hljs-keyword">if</span>(id == <span class="hljs-number">1</span>)&#123;<br>        <span class="hljs-comment">//1.造个异常</span><br>        <span class="hljs-keyword">int</span> i = <span class="hljs-number">3</span>/<span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/*try &#123;</span><br><span class="hljs-comment">        //2. 休眠2秒</span><br><span class="hljs-comment">        Thread.sleep(2000);</span><br><span class="hljs-comment">    &#125; catch (InterruptedException e) &#123;</span><br><span class="hljs-comment">        e.printStackTrace();</span><br><span class="hljs-comment">    &#125;*/</span><br>    Goods goods = goodsService.findOne(id);<br><br>    goods.setTitle(goods.getTitle() + <span class="hljs-string">&quot;:&quot;</span> + port);<span class="hljs-comment">//将端口号，设置到了 商品标题上</span><br>    <span class="hljs-keyword">return</span> goods;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-3-hystrix熔断监控"><a href="#1-3-hystrix熔断监控" class="headerlink" title="1.3 hystrix熔断监控"></a>1.3 hystrix熔断监控</h2><ul><li><p>Hystrix 提供了 Hystrix-dashboard 功能，用于实时监控微服务运行状态。</p></li><li><p>但是Hystrix-dashboard只能监控一个微服务。</p></li><li><p>Netflix 还提供了 Turbine ，进行聚合监控。</p></li></ul><p>这部分不详细展开了，需要用的时候去查对应博客</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Feign声明式服务调用</title>
    <link href="/2021/08/01/3.%20Feign/"/>
    <url>/2021/08/01/3.%20Feign/</url>
    
    <content type="html"><![CDATA[<h1 id="1-Feign-概述"><a href="#1-Feign-概述" class="headerlink" title="1. Feign 概述"></a>1. Feign 概述</h1><ul><li>Feign 是一个声明式的 REST 客户端，它用了基于接口的注解方式，很方便实现客户端配置。是简化了 RestTemplate+Ribbon 一个组件</li><li>Feign 最初由 Netflix 公司提供，但不支持SpringMVC注解，后由 SpringCloud 对其封装，支持了SpringMVC注解，让使用者更易于接受。</li></ul><h1 id="2-Feign-快速入门"><a href="#2-Feign-快速入门" class="headerlink" title="2. Feign 快速入门"></a>2. <strong>Feign</strong> <strong>快速入门</strong></h1><p>基础的环境搭好了，主要研究feign的部分。如果想要了解完整过程可以查看本地笔记</p><ol><li><p>在消费端引入 open-feign 依赖 (消费端指的是 Service Consumer)</p><p><img src="/images/image-20210801205806595.png" alt="image-20210801205806595"></p><p><img src="/images/image-20210801211807913.png" alt="image-20210801211807913"></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--feign--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>编写Feign接口调用</p><p>创建包feign用于存放GoodsFeignClient接口</p><p><img src="/images/image-20210801212031590.png" alt="image-20210801212031590"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * feign声明式接口。发起远程调用的。</span><br><span class="hljs-comment"> * 代替了 RestTemplate+Ribbon 的下面两行代码</span><br><span class="hljs-comment"> * String url = &quot;http://FEIGN-PROVIDER/goods/findOne/&quot;+id;</span><br><span class="hljs-comment"> * Goods goods = restTemplate.getForObject(url, Goods.class);</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * 1. 定义接口</span><br><span class="hljs-comment"> * 2. 接口上添加注解 <span class="hljs-doctag">@FeignClient</span>,设置value属性为 服务提供者的 应用名称</span><br><span class="hljs-comment"> * 3. 编写调用接口，接口的声明规则 和 提供方接口保持一致。</span><br><span class="hljs-comment"> * 4. 注入该接口对象，调用接口方法完成远程调用</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">@FeignClient(value = &quot;FEIGN-PROVIDER&quot;)</span>  <span class="hljs-comment">//这里的value是provider在注册中心的名称</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">GoodsFeignClient</span> </span>&#123;<br><br><br>    <span class="hljs-meta">@GetMapping(&quot;/goods/findOne/&#123;id&#125;&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Goods <span class="hljs-title">findGoodsById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> <span class="hljs-keyword">int</span> id)</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>在controller类中注入刚定义好的接口，在需要使用其他微服务的地方调用接口中相应的方法</p><p>这里就是在order微服务中调用了goods微服务的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/order&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RestTemplate restTemplate;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> GoodsFeignClient goodsFeignClient;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/goods/&#123;id&#125;&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Goods <span class="hljs-title">findGoodsById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> <span class="hljs-keyword">int</span> id)</span></span>&#123;<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        String url = &quot;http://FEIGN-PROVIDER/goods/findOne/&quot;+id;</span><br><span class="hljs-comment">        // 3. 调用方法</span><br><span class="hljs-comment">        Goods goods = restTemplate.getForObject(url, Goods.class);</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">        return goods;*/</span><br><br>        Goods goods = goodsFeignClient.findGoodsById(id);<br><br>        <span class="hljs-keyword">return</span> goods;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>在启动类 添加 @EnableFeignClients 注解，开启Feign功能</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableDiscoveryClient</span> <span class="hljs-comment">// 激活DiscoveryClient</span><br><span class="hljs-meta">@EnableEurekaClient</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableFeignClients</span> <span class="hljs-comment">//开启Feign的功能</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsumerApp</span> </span>&#123;<br><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(ConsumerApp.class,args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>测试调用</p><p>输入服务消费方的对应url调用服务提供方的方法</p></li></ol><h1 id="3-Feign-其他功能"><a href="#3-Feign-其他功能" class="headerlink" title="3. Feign 其他功能"></a>3. <strong>Feign</strong> <strong>其他功能</strong></h1><h2 id="3-1-超时设置"><a href="#3-1-超时设置" class="headerlink" title="3.1 超时设置"></a>3.1 超时设置</h2><ul><li><p>Feign 底层依赖于 Ribbon 实现负载均衡和远程调用。</p></li><li><p>Ribbon默认1秒超时。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 设置Ribbon的超时时间</span><br><span class="hljs-attr">ribbon:</span><br>  <span class="hljs-attr">ConnectTimeout:</span> <span class="hljs-number">1000</span> <span class="hljs-comment"># 连接超时时间 默认1s</span><br>  <span class="hljs-attr">ReadTimeout:</span> <span class="hljs-number">3000</span> <span class="hljs-comment"># 逻辑处理的超时时间 默认1s</span><br></code></pre></td></tr></table></figure></li></ul><h2 id="3-2-日志记录"><a href="#3-2-日志记录" class="headerlink" title="3.2 日志记录"></a>3.2 日志记录</h2><ul><li>Feign 只能记录 debug 级别的日志信息</li></ul><p>具体用法先不掌握，需要时去搜相应博客</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>RabbitMQ</title>
    <link href="/2021/07/30/2.%20RabbitMQ/"/>
    <url>/2021/07/30/2.%20RabbitMQ/</url>
    
    <content type="html"><![CDATA[<h1 id="1-消息中间件概述"><a href="#1-消息中间件概述" class="headerlink" title="1. 消息中间件概述"></a>1. 消息中间件概述</h1><h2 id="1-1-什么是消息中间件"><a href="#1-1-什么是消息中间件" class="headerlink" title="1.1 什么是消息中间件"></a>1.1 什么是消息中间件</h2><p>MQ全称为Message Queue（消息队列），消息队列在分布式系统开发中应用非常广泛</p><p>消息队列是应用程序和应用程序之间的通信方法</p><ul><li><p>使用MQ的原因</p><p>在项目中，可将一些无需即时返回且耗时的操作提取出来，进行<strong>异步处理</strong>，而这种异步处理的方式大大的节省了服务器的请求响应时间，从而<strong>提高</strong>了<strong>系统</strong>的<strong>吞吐量</strong></p></li><li><p>开发中消息队列通常有如下应用场景：</p><ol><li><p>任务<strong>异步</strong>处理</p><p>将不需要同步处理的并且耗时长的操作由消息队列通知消息接收方进行异步处理。提高了应用程序的响应时间</p></li><li><p>应用程序<strong>解耦合</strong></p><p>生产方通过MQ与消费方交互，它将应用程序进行解耦合</p></li><li><p><strong>削峰填谷</strong></p><p>如订单系统，在下单的时候就会往数据库写数据。但是数据库只能支撑每秒1000左右的并发写入，并发量再高就容易宕机。低峰期的时候并发也就100多个，但是在高峰期时候，并发量会突然激增到5000以上，这个时候数据库肯定卡死了。</p><p>如果使用MQ, 消息被MQ保存起来了，然后系统就可以按照自己的消费能力来消费，比如每秒1000个数据，这样慢慢写入数据库，这样就不会卡死数据库了。</p><p><img src="/images/image-20210730231412854.png" alt="image-20210730231412854"></p><p>但是使用了MQ之后，限制消费消息的速度为1000，但是这样一来，高峰期产生的数据势必会被积压在MQ中，高峰就被“削”掉了。但是因为消息积压，在高峰期过后的一段时间内，消费消息的速度还是会维持在1000QPS，直到消费完积压的消息,这就叫做“填谷”</p><img src="/images/image-20210730231500453.png"  style="zoom:80%;" /></li></ol></li></ul><h2 id="1-2-AMQP-和-JMS"><a href="#1-2-AMQP-和-JMS" class="headerlink" title="1.2 AMQP 和 JMS"></a>1.2 AMQP 和 JMS</h2><p>实现MQ的大致有两种主流方式：AMQP、JMS</p><ul><li>AMQP（Advanced Message Queue 高级消息队列协议）是一种协议, 直接定义网络交换的数据格式, 不规定实现方式，是跨语言的</li><li>JMS即Java消息服务（JavaMessage Service）是应用程序接口, 必须使用Java语言</li></ul><p>基于这两种方式的消息队列产品</p><ul><li>ActiveMQ：基于JMS</li><li>ZeroMQ：基于C语言开发</li><li><strong>RabbitMQ：基于AMQP协议，erlang语言开发，稳定性好</strong></li><li>RocketMQ：基于JMS，阿里巴巴产品</li><li>Kafka：类似MQ的产品；分布式消息系统，高吞吐量</li></ul><h2 id="1-3-RabbitMQ"><a href="#1-3-RabbitMQ" class="headerlink" title="1.3 RabbitMQ"></a>1.3 RabbitMQ</h2><p>RabbitMQ官方地址：<a href="http://www.rabbitmq.com/">http://www.rabbitmq.com/</a></p><p>RabbitMQ提供了7种模式：简单模式，work模式，Publish/Subscribe发布与订阅模式，Routing路由模式，Topics主题模式，RPC远程调用模式，Publisher Confirms（远程调用，不太算MQ，暂不作介绍, 用到再去查博客；Publisher Confirms也暂不介绍，有需要再查博客）</p><h1 id="2-安装及配置RabbitMQ"><a href="#2-安装及配置RabbitMQ" class="headerlink" title="2. 安装及配置RabbitMQ"></a>2. 安装及配置RabbitMQ</h1><ol><li><p>在线安装依赖环境：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install build-essential openssl openssl-devel unixODBC unixODBC-devel make gcc gcc-c++ kernel-devel m4 ncurses-devel tk tc xz<br></code></pre></td></tr></table></figure></li><li><p>安装Erlang</p><p>首先需要下载一个 <code>erlang-18.3-1.el7.centos.x86_64.rpm </code>文件 (版本根据网上的推荐来选，这个可能有点旧了)，然后进行安装 </p><p>注意：</p><ul><li>这个过程可能会报错，到时候根据错误查看本地文档或者上网查找相关博客来解决</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 安装</span><br>rpm -ivh erlang-18.3-1.el7.centos.x86_64.rpm<br></code></pre></td></tr></table></figure></li><li><p>安装RabbitMQ</p><p>需要提前把<code>socat-1.7.3.2-5.el7.lux.x86_64.rpm</code>, <code>rabbitmq-server-3.6.5-1.noarch.rpm</code>给下载好。（建议这三个rpm文件下载在一个命名为rabbitmq的文件夹。这里的版本根据需要选择）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 安装</span><br>rpm -ivh socat-1.7.3.2-5.el7.lux.x86_64.rpm<br><span class="hljs-meta"></span><br><span class="hljs-meta">#</span><span class="bash"> 安装</span><br>rpm -ivh rabbitmq-server-3.6.5-1.noarch.rpm<br></code></pre></td></tr></table></figure><p>到这里就安装完成了</p></li><li><p>然后开启管理界面及配置</p><p>注意：</p><ul><li>第一步如果想要开启管理界面是必须操作的</li><li>第二步如果信息保持默认的话也可以不改，如果需要改相关信息，去网上搜相关博客</li></ul><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 开启管理界面</span><br>rabbitmq-plugins <span class="hljs-built_in">enable</span> rabbitmq_management<br><span class="hljs-comment"># 修改默认配置信息, 比如修改密码、配置等等</span><br>vim /usr/lib/rabbitmq/lib/rabbitmq_server-3.6.5/ebin/rabbit.app <br></code></pre></td></tr></table></figure></li><li><p>启动和关闭</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">service rabbitmq-server start <span class="hljs-comment"># 启动服务</span><br>service rabbitmq-server stop <span class="hljs-comment"># 停止服务</span><br>service rabbitmq-server restart <span class="hljs-comment"># 重启服务</span><br></code></pre></td></tr></table></figure></li></ol><p>RabbitMQ在配置好后，可以访问<code>http://ip地址:15672</code> ；其自带了guest/guest的用户名和密码</p><p><img src="/images/image-20210730234122057.png" alt="image-20210730234122057"></p><p>(关于配置虚拟主机和用户这里的知识就先不介绍，需要的话去网上查询详细博客)</p><h1 id="3-AMQP"><a href="#3-AMQP" class="headerlink" title="3. AMQP"></a>3. AMQP</h1><h2 id="3-1-相关概念介绍"><a href="#3-1-相关概念介绍" class="headerlink" title="3.1. 相关概念介绍"></a>3.1. 相关概念介绍</h2><p>AMQP  一个提供统一消息服务的应用层标准高级消息队列协议，是应用层协议的一个开放标准，为面向消息的中间件设计。</p><p>AMQP是一个二进制协议，拥有一些现代化特点：多信道、协商式，异步，安全，扩平台，中立，高效。</p><p>RabbitMQ是AMQP协议的Erlang的实现。</p><table><thead><tr><th>概念</th><th>说明</th></tr></thead><tbody><tr><td>连接Connection</td><td>一个网络连接，比如TCP/IP套接字连接。</td></tr><tr><td>会话Session</td><td>端点之间的命名对话。在一个会话上下文中，保证“恰好传递一次”。</td></tr><tr><td>信道Channel</td><td>多路复用连接中的一条独立的双向数据流通道。为会话提供物理传输介质。</td></tr><tr><td>客户端Client</td><td>AMQP连接或者会话的发起者。AMQP是非对称的，客户端生产和消费消息，服务器存储和路由这些消息。</td></tr><tr><td>服务节点Broker</td><td>消息中间件的服务节点；一般情况下可以将一个RabbitMQ Broker看作一台RabbitMQ 服务器。</td></tr><tr><td>端点</td><td>AMQP对话的任意一方。一个AMQP连接包括两个端点（一个是客户端，一个是服务器）。</td></tr><tr><td>消费者Consumer</td><td>一个从消息队列里请求消息的客户端程序。</td></tr><tr><td>生产者Producer</td><td>一个向交换机发布消息的客户端应用程序。</td></tr></tbody></table><h2 id="3-2-RabbitMQ运转流程"><a href="#3-2-RabbitMQ运转流程" class="headerlink" title="3.2 RabbitMQ运转流程"></a>3.2 RabbitMQ运转流程</h2><p>在入门案例中：</p><ul><li><p>生产者发送消息</p><ol><li>生产者创建连接（Connection），开启一个信道（Channel），连接到RabbitMQ Broker；</li><li>声明队列并设置属性；如是否排它，是否持久化，是否自动删除；</li><li>将路由键（空字符串）与队列绑定起来；</li><li>发送消息至RabbitMQ Broker；</li><li>关闭信道；</li><li>关闭连接；</li></ol></li><li><p>消费者接收消息</p><ol><li><p>消费者创建连接（Connection），开启一个信道（Channel），连接到RabbitMQ Broker</p></li><li><p>向Broker 请求消费相应队列中的消息，设置相应的回调函数；</p></li><li><p>等待Broker回应闭关投递响应队列中的消息，消费者接收消息；</p></li><li><p>确认（ack，自动确认）接收到的消息；</p></li><li><p>RabbitMQ从队列中删除相应已经被确认的消息；</p></li><li><p>关闭信道；</p></li><li><p>关闭连接；</p><p><img src="/images/image-20210731135723102.png" alt="image-20210731135723102"></p></li></ol></li></ul><h1 id="4-RabbitMQ入门"><a href="#4-RabbitMQ入门" class="headerlink" title="4. RabbitMQ入门"></a>4. RabbitMQ入门</h1><h2 id="4-1-HelloWorld简单模式"><a href="#4-1-HelloWorld简单模式" class="headerlink" title="4.1 HelloWorld简单模式"></a>4.1 HelloWorld简单模式</h2><p>这个入门工程就是一个<strong>简单模式 HelloWorld</strong></p><ol><li><p>创建工程</p></li><li><p>向pom.xml文件中添加依赖</p><p>注意：</p><ul><li><p>有可能报这个错，如果报了的话再加第二个包</p><p><img src="/images/image-20210730235828100-1627661205170.png" alt="image-20210730235828100"></p></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.rabbitmq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>amqp-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.6.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>   <br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>slf4j-nop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.7.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>   <br>   <br></code></pre></td></tr></table></figure></li><li><p>编写生产者Producer</p><p>注意：</p><ul><li><p>这里的虚拟主机名称不能乱设置，不然可能会报错，rabbitmq默认的是<code>\</code></p><p><img src="/images/image-20210731000917757.png" alt="image-20210731000917757"></p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Producer</span> </span>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String QUEUE_NAME = <span class="hljs-string">&quot;simple_queue&quot;</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;<br>        <span class="hljs-comment">//创建连接工厂</span><br>        ConnectionFactory connectionFactory = <span class="hljs-keyword">new</span> ConnectionFactory();<br>        <span class="hljs-comment">//主机地址;默认为 localhost</span><br>        connectionFactory.setHost(<span class="hljs-string">&quot;192.168.200.128&quot;</span>);<br>        <span class="hljs-comment">//连接端口;默认为 5672</span><br>        connectionFactory.setPort(<span class="hljs-number">5672</span>);<br>        <span class="hljs-comment">//虚拟主机名称;默认为 /</span><br>        connectionFactory.setVirtualHost(<span class="hljs-string">&quot;/&quot;</span>);<br>        <span class="hljs-comment">//连接用户名；默认为guest</span><br>        connectionFactory.setUsername(<span class="hljs-string">&quot;guest&quot;</span>);<br>        <span class="hljs-comment">//连接密码；默认为guest</span><br>        connectionFactory.setPassword(<span class="hljs-string">&quot;guest&quot;</span>);<br><br>        <span class="hljs-comment">//创建连接</span><br>        Connection connection = connectionFactory.newConnection();<br><br>        <span class="hljs-comment">// 创建频道</span><br>        Channel channel = connection.createChannel();<br><br>        <span class="hljs-comment">// 声明（创建）队列</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：队列名称</span><br><span class="hljs-comment">         * 参数2：是否定义持久化队列</span><br><span class="hljs-comment">         * 参数3：是否独占本次连接</span><br><span class="hljs-comment">         * 参数4：是否在不使用的时候自动删除队列</span><br><span class="hljs-comment">         * 参数5：队列其它参数</span><br><span class="hljs-comment">         */</span><br>        channel.queueDeclare(QUEUE_NAME, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-comment">// 要发送的信息</span><br>        String message = <span class="hljs-string">&quot;你好；小兔子！&quot;</span>;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：交换机名称，如果没有指定则使用默认Default Exchage</span><br><span class="hljs-comment">         * 参数2：路由key,简单模式可以传递队列名称</span><br><span class="hljs-comment">         * 参数3：消息其它属性</span><br><span class="hljs-comment">         * 参数4：消息内容</span><br><span class="hljs-comment">         */</span><br>        channel.basicPublish(<span class="hljs-string">&quot;&quot;</span>, QUEUE_NAME, <span class="hljs-keyword">null</span>, message.getBytes());<br>        System.out.println(<span class="hljs-string">&quot;已发送消息：&quot;</span> + message);<br><br>        <span class="hljs-comment">// 关闭资源</span><br>        channel.close();<br>        connection.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>在执行上述的消息发送之后；可以登录rabbitMQ的管理控制台，可以发现队列和其消息</p></li></ol><p><img src="/images/image-20210731001205411.png" alt="image-20210731001205411"></p><ol start="4"><li><p>编写消费者</p><p>由于连接部分都是相同的操作，我们把它抽取成工具类ConnectionUtil</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConnectionUtil</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title">getConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;<br>        <span class="hljs-comment">//创建连接工厂</span><br>        ConnectionFactory connectionFactory = <span class="hljs-keyword">new</span> ConnectionFactory();<br>        <span class="hljs-comment">//主机地址;默认为 localhost</span><br>        connectionFactory.setHost(<span class="hljs-string">&quot;192.168.200.128&quot;</span>);<br>        <span class="hljs-comment">//连接端口;默认为 5672</span><br>        connectionFactory.setPort(<span class="hljs-number">5672</span>);<br>        <span class="hljs-comment">//虚拟主机名称;默认为 /</span><br>        connectionFactory.setVirtualHost(<span class="hljs-string">&quot;/&quot;</span>);<br>        <span class="hljs-comment">//连接用户名；默认为guest</span><br>        connectionFactory.setUsername(<span class="hljs-string">&quot;guest&quot;</span>);<br>        <span class="hljs-comment">//连接密码；默认为guest</span><br>        connectionFactory.setPassword(<span class="hljs-string">&quot;guest&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> connectionFactory.newConnection();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>编写消息的消费者Consumer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Consumer</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;<br>        Connection connection = ConnectionUtil.getConnection();<br>        <span class="hljs-comment">// 创建频道</span><br>        Channel channel = connection.createChannel();<br>        <span class="hljs-comment">// 声明（创建）队列</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：队列名称</span><br><span class="hljs-comment">         * 参数2：是否定义持久化队列</span><br><span class="hljs-comment">         * 参数3：是否独占本次连接</span><br><span class="hljs-comment">         * 参数4：是否在不使用的时候自动删除队列</span><br><span class="hljs-comment">         * 参数5：队列其它参数</span><br><span class="hljs-comment">         */</span><br>        channel.queueDeclare(Producer.QUEUE_NAME, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-comment">//创建消费者；并设置消息处理</span><br>        DefaultConsumer consumer = <span class="hljs-keyword">new</span> DefaultConsumer(channel)&#123;<br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * consumerTag 消息者标签，在channel.basicConsume时候可以指定</span><br><span class="hljs-comment">             * envelope 消息包的内容，可从中获取消息id，消息routingkey，交换机，消息和重传标志(收到消息失败后是否需要重新发送)</span><br><span class="hljs-comment">             * properties 属性信息</span><br><span class="hljs-comment">             * body 消息</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-keyword">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> UnsupportedEncodingException </span>&#123;<br>                <span class="hljs-comment">//路由key</span><br>                System.out.println(<span class="hljs-string">&quot;路由key为：&quot;</span> + envelope.getRoutingKey());<br>                <span class="hljs-comment">//交换机</span><br>                System.out.println(<span class="hljs-string">&quot;交换机为：&quot;</span> + envelope.getExchange());<br>                <span class="hljs-comment">//消息id</span><br>                System.out.println(<span class="hljs-string">&quot;消息id为：&quot;</span> + envelope.getDeliveryTag());<br>                <span class="hljs-comment">//收到的消息</span><br>                System.out.println(<span class="hljs-string">&quot;接收到的消息为：&quot;</span> + <span class="hljs-keyword">new</span> String(body, <span class="hljs-string">&quot;utf-8&quot;</span>));<br>            &#125;<br>        &#125;;<br><br>        <span class="hljs-comment">//监听消息</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：队列名称</span><br><span class="hljs-comment">         * 参数2：是否自动确认，设置为true为表示消息接收到自动向mq回复接收到了，mq接收到回复会删除消息，设置为false则需要手动确认</span><br><span class="hljs-comment">         * 参数3：消息接收到后回调</span><br><span class="hljs-comment">         */</span><br><br>        channel.basicConsume(Producer.QUEUE_NAME, <span class="hljs-keyword">true</span>, consumer);<br><br>        <span class="hljs-comment">//不关闭资源，应该一直监听消息</span><br>        <span class="hljs-comment">//channel.close();</span><br>        <span class="hljs-comment">//connection.close();</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><p><strong>小结</strong>  </p><p>上述的入门案例中中其实使用的是如下的简单模式：</p><p><img src="/images/image-20210731002649177.png" alt="image-20210731002649177"></p><p>在上图的模型中，有以下概念：</p><ul><li>P：生产者，也就是要发送消息的程序</li><li>C：消费者：消息的接受者，会一直等待消息到来。</li><li>queue：消息队列，图中红色部分，可以缓存消息；生产者向其中投递消息，消费者从其中取出消息。</li></ul><h2 id="4-2-Work-queues工作队列模式"><a href="#4-2-Work-queues工作队列模式" class="headerlink" title="4.2 Work queues工作队列模式"></a>4.2 Work queues工作队列模式</h2><p>模式说明</p><p><img src="/images/image-20210731133440033.png" alt="image-20210731133440033"></p><p><code>Work Queues</code>与入门程序的<code>简单模式</code>相比，多了一个或一些消费端，多个消费端共同消费同一个队列中的消息。</p><p><strong>应用场景</strong>：对于任务过重或任务较多情况使用工作队列可以提高任务处理的速度。(多安排几个消费者去消费生产者的消息)</p><p>代码和简单模式几乎一样，除了要多一个或几个消费者（基础环境和简单模式相同，这里就不赘叙了）：</p><ol><li><p>生产者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Producer</span> </span>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String QUEUE_NAME = <span class="hljs-string">&quot;work_queue&quot;</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;<br><br>        <span class="hljs-comment">//创建连接</span><br>        Connection connection = ConnectionUtil.getConnection();<br><br>        <span class="hljs-comment">// 创建频道</span><br>        Channel channel = connection.createChannel();<br><br>        <span class="hljs-comment">// 声明（创建）队列</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：队列名称</span><br><span class="hljs-comment">         * 参数2：是否定义持久化队列</span><br><span class="hljs-comment">         * 参数3：是否独占本次连接</span><br><span class="hljs-comment">         * 参数4：是否在不使用的时候自动删除队列</span><br><span class="hljs-comment">         * 参数5：队列其它参数</span><br><span class="hljs-comment">         */</span><br>        channel.queueDeclare(QUEUE_NAME, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">30</span> ; i++) &#123;<br>            <span class="hljs-comment">//发送信息</span><br>            String message = <span class="hljs-string">&quot;你好；小兔子！work模式--&quot;</span> + i;<br><br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * 参数1：交换机名称，如果没有指定则使用默认Default Exchage</span><br><span class="hljs-comment">             * 参数2：路由key,简单模式可以传递队列名称</span><br><span class="hljs-comment">             * 参数3：消息其它属性</span><br><span class="hljs-comment">             * 参数4：消息内容</span><br><span class="hljs-comment">             */</span><br>            channel.basicPublish(<span class="hljs-string">&quot;&quot;</span>, QUEUE_NAME, <span class="hljs-keyword">null</span>, message.getBytes());<br>            System.out.println(<span class="hljs-string">&quot;已发送消息：&quot;</span> + message);<br>        &#125;<br><br>        <span class="hljs-comment">// 关闭资源</span><br>        channel.close();<br>        connection.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>消费者1</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Consumer</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>&#123;<br>        Connection connection = ConnectionUtil.getConnection();<br>        <span class="hljs-comment">// 创建频道</span><br>       <span class="hljs-keyword">final</span> Channel channel = connection.createChannel();<br>        <span class="hljs-comment">// 声明（创建）队列</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：队列名称</span><br><span class="hljs-comment">         * 参数2：是否定义持久化队列</span><br><span class="hljs-comment">         * 参数3：是否独占本次连接</span><br><span class="hljs-comment">         * 参数4：是否在不使用的时候自动删除队列</span><br><span class="hljs-comment">         * 参数5：队列其它参数</span><br><span class="hljs-comment">         */</span><br>        channel.queueDeclare(Producer.QUEUE_NAME, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-comment">//一次只能接收并处理一个消息</span><br>        channel.basicQos(<span class="hljs-number">1</span>);<br><br>        <span class="hljs-comment">//创建消费者；并设置消息处理</span><br>        DefaultConsumer consumer = <span class="hljs-keyword">new</span> DefaultConsumer(channel)&#123;<br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * consumerTag 消息者标签，在channel.basicConsume时候可以指定</span><br><span class="hljs-comment">             * envelope 消息包的内容，可从中获取消息id，消息routingkey，交换机，消息和重传标志(收到消息失败后是否需要重新发送)</span><br><span class="hljs-comment">             * properties 属性信息</span><br><span class="hljs-comment">             * body 消息</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-keyword">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">//路由key</span><br>                    System.out.println(<span class="hljs-string">&quot;路由key为：&quot;</span> + envelope.getRoutingKey());<br>                    <span class="hljs-comment">//交换机</span><br>                    System.out.println(<span class="hljs-string">&quot;交换机为：&quot;</span> + envelope.getExchange());<br>                    <span class="hljs-comment">//消息id</span><br>                    System.out.println(<span class="hljs-string">&quot;消息id为：&quot;</span> + envelope.getDeliveryTag());<br>                    <span class="hljs-comment">//收到的消息</span><br>                    System.out.println(<span class="hljs-string">&quot;消费者1-接收到的消息为：&quot;</span> + <span class="hljs-keyword">new</span> String(body, <span class="hljs-string">&quot;utf-8&quot;</span>));<br><br>                    Thread.sleep(<span class="hljs-number">1000</span>);<br><br>                    <span class="hljs-comment">//确认消息, 这里确认是因为下面没有设置消息自动确认</span><br>                    channel.basicAck(envelope.getDeliveryTag(), <span class="hljs-keyword">false</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;;<br><br>        <span class="hljs-comment">//监听消息</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：队列名称</span><br><span class="hljs-comment">         * 参数2：是否自动确认，设置为true为表示消息接收到自动向mq回复接收到了，mq接收到回复会删除消息，设置为false则需要手动确认</span><br><span class="hljs-comment">         * 参数3：消息接收到后回调</span><br><span class="hljs-comment">         */</span><br><br>        channel.basicConsume(Producer.QUEUE_NAME, <span class="hljs-keyword">false</span>, consumer);<br><br>        <span class="hljs-comment">//不关闭资源，应该一直监听消息</span><br>        <span class="hljs-comment">//channel.close();</span><br>        <span class="hljs-comment">//connection.close();</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>消费者2</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Consumer2</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        Connection connection = ConnectionUtil.getConnection();<br><br>        <span class="hljs-comment">// 创建频道</span><br>        <span class="hljs-keyword">final</span> Channel channel = connection.createChannel();<br><br>        <span class="hljs-comment">// 声明（创建）队列</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：队列名称</span><br><span class="hljs-comment">         * 参数2：是否定义持久化队列</span><br><span class="hljs-comment">         * 参数3：是否独占本次连接</span><br><span class="hljs-comment">         * 参数4：是否在不使用的时候自动删除队列</span><br><span class="hljs-comment">         * 参数5：队列其它参数</span><br><span class="hljs-comment">         */</span><br>        channel.queueDeclare(Producer.QUEUE_NAME, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-comment">//一次只能接收并处理一个消息</span><br>        channel.basicQos(<span class="hljs-number">1</span>);<br><br>        <span class="hljs-comment">//创建消费者；并设置消息处理</span><br>        DefaultConsumer consumer = <span class="hljs-keyword">new</span> DefaultConsumer(channel) &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * consumerTag 消息者标签，在channel.basicConsume时候可以指定</span><br><span class="hljs-comment">             * envelope 消息包的内容，可从中获取消息id，消息routingkey，交换机，消息和重传标志(收到消息失败后是否需要重新发送)</span><br><span class="hljs-comment">             * properties 属性信息</span><br><span class="hljs-comment">             * body 消息</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-keyword">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">//路由key</span><br>                    System.out.println(<span class="hljs-string">&quot;路由key为：&quot;</span> + envelope.getRoutingKey());<br>                    <span class="hljs-comment">//交换机</span><br>                    System.out.println(<span class="hljs-string">&quot;交换机为：&quot;</span> + envelope.getExchange());<br>                    <span class="hljs-comment">//消息id</span><br>                    System.out.println(<span class="hljs-string">&quot;消息id为：&quot;</span> + envelope.getDeliveryTag());<br>                    <span class="hljs-comment">//收到的消息</span><br>                    System.out.println(<span class="hljs-string">&quot;消费者2-接收到的消息为：&quot;</span> + <span class="hljs-keyword">new</span> String(body, <span class="hljs-string">&quot;utf-8&quot;</span>));<br>                    Thread.sleep(<span class="hljs-number">1000</span>);<br><br>                    <span class="hljs-comment">//确认消息</span><br>                    channel.basicAck(envelope.getDeliveryTag(), <span class="hljs-keyword">false</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;;<br>        <span class="hljs-comment">//监听消息</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：队列名称</span><br><span class="hljs-comment">         * 参数2：是否自动确认，设置为true为表示消息接收到自动向mq回复接收到了，mq接收到回复会删除消息，设置为false则需要手动确认</span><br><span class="hljs-comment">         * 参数3：消息接收到后回调</span><br><span class="hljs-comment">         */</span><br>        channel.basicConsume(Producer.QUEUE_NAME, <span class="hljs-keyword">false</span>, consumer);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>测试启动两个消费者，然后再启动生产者发送消息；到IDEA的两个消费者对应的控制台查看是否竞争性的接收到消息</p><p><img src="/images/image-20210731225717102.png" alt="image-20210731225717102"></p><p><img src="/images/image-20210731225747964.png" alt="image-20210731225747964"></p></li></ol><p>在一个队列中如果有多个消费者，那么消费者之间对于同一个消息的关系是<strong>竞争</strong>的关系</p><h2 id="4-3-Publish-Subscribe发布与订阅模式"><a href="#4-3-Publish-Subscribe发布与订阅模式" class="headerlink" title="4.3 Publish/Subscribe发布与订阅模式"></a>4.3 Publish/Subscribe发布与订阅模式</h2><p>前面2个案例中，只有3个角色：</p><ul><li>P：生产者，也就是要发送消息的程序</li><li>C：消费者：消息的接受者，会一直等待消息到来。</li><li>queue：消息队列</li></ul><p>而在Publish/Subscribe模型中，多了一个exchange角色，而且过程略有变化：</p><p><img src="/images/image-20210731230311829-1627743833934.png" alt="image-20210731230311829"></p><ul><li>P：生产者，也就是要发送消息的程序，但是不再发送到队列中，而是发给X（交换机）</li><li>C：消费者，消息的接受者，会一直等待消息到来。</li><li>Queue：消息队列，接收消息、缓存消息。</li><li>Exchange：交换机，图中的X。一方面，接收生产者发送的消息。另一方面，知道如何处理消息，例如递交给某个特别队列、递交给所有队列、或是将消息丢弃。到底如何操作，取决于Exchange的类型。Exchange有常见以下3种类型：<ul><li>Fanout：广播，将消息交给所有绑定到交换机的队列</li><li>Direct：定向，把消息交给符合指定routing key 的队列</li><li>Topic：通配符，把消息交给符合routing pattern（路由模式） 的队列</li></ul></li></ul><p><strong>Exchange（交换机）只负责转发消息，不具备存储消息的能力</strong>，因此如果没有任何队列与Exchange绑定，或者没有符合路由规则的队列，那么消息会丢失！</p><p>Publish/Subscribe模式：</p><ol><li>每个消费者监听自己的队列。</li><li>生产者将消息发给broker，由交换机将消息转发到绑定此交换机的每个队列，每个绑定交换机的队列都将接收到消息</li></ol><p>代码：</p><ol><li><p>生产者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 发布与订阅使用的交换机类型为：fanout</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Producer</span> </span>&#123;<br><br>    <span class="hljs-comment">//交换机名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String FANOUT_EXCHAGE = <span class="hljs-string">&quot;fanout_exchange&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String FANOUT_QUEUE_1 = <span class="hljs-string">&quot;fanout_queue_1&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String FANOUT_QUEUE_2 = <span class="hljs-string">&quot;fanout_queue_2&quot;</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br>        <span class="hljs-comment">//创建连接</span><br>        Connection connection = ConnectionUtil.getConnection();<br><br>        <span class="hljs-comment">// 创建频道</span><br>        Channel channel = connection.createChannel();<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 声明交换机</span><br><span class="hljs-comment">         * 参数1：交换机名称</span><br><span class="hljs-comment">         * 参数2：交换机类型，fanout、topic、direct、headers</span><br><span class="hljs-comment">         */</span><br>        channel.exchangeDeclare(FANOUT_EXCHAGE, BuiltinExchangeType.FANOUT);<br><br>        <span class="hljs-comment">// 声明（创建）队列</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：队列名称</span><br><span class="hljs-comment">         * 参数2：是否定义持久化队列</span><br><span class="hljs-comment">         * 参数3：是否独占本次连接</span><br><span class="hljs-comment">         * 参数4：是否在不使用的时候自动删除队列</span><br><span class="hljs-comment">         * 参数5：队列其它参数</span><br><span class="hljs-comment">         */</span><br>        channel.queueDeclare(FANOUT_QUEUE_1, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<br>        channel.queueDeclare(FANOUT_QUEUE_2, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-comment">//队列绑定交换机</span><br>        channel.queueBind(FANOUT_QUEUE_1, FANOUT_EXCHAGE, <span class="hljs-string">&quot;&quot;</span>);<br>        channel.queueBind(FANOUT_QUEUE_2, FANOUT_EXCHAGE, <span class="hljs-string">&quot;&quot;</span>);<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">10</span>; i++) &#123;<br>            <span class="hljs-comment">// 发送信息</span><br>            String message = <span class="hljs-string">&quot;你好；小兔子！发布订阅模式--&quot;</span> + i;<br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * 参数1：交换机名称，如果没有指定则使用默认Default Exchage</span><br><span class="hljs-comment">             * 参数2：路由key,简单模式可以传递队列名称</span><br><span class="hljs-comment">             * 参数3：消息其它属性</span><br><span class="hljs-comment">             * 参数4：消息内容</span><br><span class="hljs-comment">             */</span><br>            channel.basicPublish(FANOUT_EXCHAGE, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-keyword">null</span>, message.getBytes());<br>            System.out.println(<span class="hljs-string">&quot;已发送消息：&quot;</span> + message);<br>        &#125;<br><br>        <span class="hljs-comment">// 关闭资源</span><br>        channel.close();<br>        connection.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>消费者1</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Consumer1</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        Connection connection = ConnectionUtil.getConnection();<br><br>        <span class="hljs-comment">// 创建频道</span><br>        Channel channel = connection.createChannel();<br><br>        <span class="hljs-comment">//声明交换机</span><br>        channel.exchangeDeclare(Producer.FANOUT_EXCHAGE, BuiltinExchangeType.FANOUT);<br><br>        <span class="hljs-comment">// 声明（创建）队列</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：队列名称</span><br><span class="hljs-comment">         * 参数2：是否定义持久化队列</span><br><span class="hljs-comment">         * 参数3：是否独占本次连接</span><br><span class="hljs-comment">         * 参数4：是否在不使用的时候自动删除队列</span><br><span class="hljs-comment">         * 参数5：队列其它参数</span><br><span class="hljs-comment">         */</span><br>        channel.queueDeclare(Producer.FANOUT_QUEUE_1, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-comment">//队列绑定交换机</span><br>        channel.queueBind(Producer.FANOUT_QUEUE_1, Producer.FANOUT_EXCHAGE, <span class="hljs-string">&quot;&quot;</span>);<br><br>        <span class="hljs-comment">//创建消费者；并设置消息处理</span><br>        DefaultConsumer consumer = <span class="hljs-keyword">new</span> DefaultConsumer(channel)&#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * consumerTag 消息者标签，在channel.basicConsume时候可以指定</span><br><span class="hljs-comment">             * envelope 消息包的内容，可从中获取消息id，消息routingkey，交换机，消息和重传标志(收到消息失败后是否需要重新发送)</span><br><span class="hljs-comment">             * properties 属性信息</span><br><span class="hljs-comment">             * body 消息</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-keyword">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>                <span class="hljs-comment">//路由key</span><br>                System.out.println(<span class="hljs-string">&quot;路由key为：&quot;</span> + envelope.getRoutingKey());<br>                <span class="hljs-comment">//交换机</span><br>                System.out.println(<span class="hljs-string">&quot;交换机为：&quot;</span> + envelope.getExchange());<br>                <span class="hljs-comment">//消息id</span><br>                System.out.println(<span class="hljs-string">&quot;消息id为：&quot;</span> + envelope.getDeliveryTag());<br>                <span class="hljs-comment">//收到的消息</span><br>                System.out.println(<span class="hljs-string">&quot;消费者1-接收到的消息为：&quot;</span> + <span class="hljs-keyword">new</span> String(body, <span class="hljs-string">&quot;utf-8&quot;</span>));<br>            &#125;<br>        &#125;;<br>        <span class="hljs-comment">//监听消息</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：队列名称</span><br><span class="hljs-comment">         * 参数2：是否自动确认，设置为true为表示消息接收到自动向mq回复接收到了，mq接收到回复会删除消息，设置为false则需要手动确认</span><br><span class="hljs-comment">         * 参数3：消息接收到后回调</span><br><span class="hljs-comment">         */</span><br>        channel.basicConsume(Producer.FANOUT_QUEUE_1, <span class="hljs-keyword">true</span>, consumer);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>消费者2</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Consumer2</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        Connection connection = ConnectionUtil.getConnection();<br><br>        <span class="hljs-comment">// 创建频道</span><br>        Channel channel = connection.createChannel();<br><br>        <span class="hljs-comment">//声明交换机</span><br>        channel.exchangeDeclare(Producer.FANOUT_EXCHAGE, BuiltinExchangeType.FANOUT);<br><br>        <span class="hljs-comment">// 声明（创建）队列</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：队列名称</span><br><span class="hljs-comment">         * 参数2：是否定义持久化队列</span><br><span class="hljs-comment">         * 参数3：是否独占本次连接</span><br><span class="hljs-comment">         * 参数4：是否在不使用的时候自动删除队列</span><br><span class="hljs-comment">         * 参数5：队列其它参数</span><br><span class="hljs-comment">         */</span><br>        channel.queueDeclare(Producer.FANOUT_QUEUE_2, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-comment">//队列绑定交换机</span><br>        channel.queueBind(Producer.FANOUT_QUEUE_2, Producer.FANOUT_EXCHAGE, <span class="hljs-string">&quot;&quot;</span>);<br><br>        <span class="hljs-comment">//创建消费者；并设置消息处理</span><br>        DefaultConsumer consumer = <span class="hljs-keyword">new</span> DefaultConsumer(channel)&#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * consumerTag 消息者标签，在channel.basicConsume时候可以指定</span><br><span class="hljs-comment">             * envelope 消息包的内容，可从中获取消息id，消息routingkey，交换机，消息和重传标志(收到消息失败后是否需要重新发送)</span><br><span class="hljs-comment">             * properties 属性信息</span><br><span class="hljs-comment">             * body 消息</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-keyword">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>                <span class="hljs-comment">//路由key</span><br>                System.out.println(<span class="hljs-string">&quot;路由key为：&quot;</span> + envelope.getRoutingKey());<br>                <span class="hljs-comment">//交换机</span><br>                System.out.println(<span class="hljs-string">&quot;交换机为：&quot;</span> + envelope.getExchange());<br>                <span class="hljs-comment">//消息id</span><br>                System.out.println(<span class="hljs-string">&quot;消息id为：&quot;</span> + envelope.getDeliveryTag());<br>                <span class="hljs-comment">//收到的消息</span><br>                System.out.println(<span class="hljs-string">&quot;消费者2-接收到的消息为：&quot;</span> + <span class="hljs-keyword">new</span> String(body, <span class="hljs-string">&quot;utf-8&quot;</span>));<br>            &#125;<br>        &#125;;<br>        <span class="hljs-comment">//监听消息</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：队列名称</span><br><span class="hljs-comment">         * 参数2：是否自动确认，设置为true为表示消息接收到自动向mq回复接收到了，mq接收到回复会删除消息，设置为false则需要手动确认</span><br><span class="hljs-comment">         * 参数3：消息接收到后回调</span><br><span class="hljs-comment">         */</span><br>        channel.basicConsume(Producer.FANOUT_QUEUE_2, <span class="hljs-keyword">true</span>, consumer);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>测试</p><p>启动所有消费者，然后使用生产者发送消息；在每个消费者对应的控制台可以查看到生产者发送的所有消息；到达<strong>广播</strong>的效果。</p><p>在执行完测试代码后，其实到RabbitMQ的管理后台找到<code>Exchanges</code>选项卡，点击 <code>fanout_exchange</code> 的交换机，可以查看到如下的绑定：</p><p><img src="/images/image-20210731232129945.png" alt="image-20210731232129945"></p></li></ol><p>小结：交换机需要与队列进行绑定，绑定之后；一个消息可以被多个消费者都收到。</p><h2 id="4-4-Routing路由模式"><a href="#4-4-Routing路由模式" class="headerlink" title="4.4. Routing路由模式"></a>4.4. Routing路由模式</h2><p><strong>模式说明</strong></p><p>路由模式特点：</p><ul><li><p>队列与交换机的绑定，不能是任意绑定了，而是要指定一个<code>RoutingKey</code>（路由key）</p></li><li><p>消息的发送方在向Exchange发送消息时，也必须指定消息的 <code>RoutingKey</code>。</p></li><li><p>Exchange不再把消息交给每一个绑定的队列，而是根据消息的<code>Routing Key</code>进行判断，只有队列的<code>Routingkey</code>与消息的 <code>Routing key</code>完全一致，才会接收到消息</p><p><img src="/images/image-20210731232559366.png" alt="image-20210731232559366"></p></li></ul><p>图解：</p><ul><li>P：生产者，向Exchange发送消息，发送消息时，会指定一个routing key。</li><li>X：Exchange（交换机），接收生产者的消息，然后把消息递交给 与routing key完全匹配的队列</li><li>C1：消费者，其所在队列指定了需要routing key 为 error 的消息</li><li>C2：消费者，其所在队列指定了需要routing key 为 info、error、warning 的消息</li></ul><p><strong>代码演示</strong></p><p>在编码上与 <code>Publish/Subscribe发布与订阅模式</code> 的区别是交换机的类型为：Direct，还有队列绑定交换机的时候需要指定routing key。</p><ol><li><p>生产者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 路由模式的交换机类型为：direct</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Producer</span> </span>&#123;<br><br>    <span class="hljs-comment">//交换机名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DIRECT_EXCHAGE = <span class="hljs-string">&quot;direct_exchange&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DIRECT_QUEUE_INSERT = <span class="hljs-string">&quot;direct_queue_insert&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DIRECT_QUEUE_UPDATE = <span class="hljs-string">&quot;direct_queue_update&quot;</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br>        <span class="hljs-comment">//创建连接</span><br>        Connection connection = ConnectionUtil.getConnection();<br><br>        <span class="hljs-comment">// 创建频道</span><br>        Channel channel = connection.createChannel();<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 声明交换机</span><br><span class="hljs-comment">         * 参数1：交换机名称</span><br><span class="hljs-comment">         * 参数2：交换机类型，fanout、topic、direct、headers</span><br><span class="hljs-comment">         */</span><br>        channel.exchangeDeclare(DIRECT_EXCHAGE, BuiltinExchangeType.DIRECT);<br><br>        <span class="hljs-comment">// 声明（创建）队列</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：队列名称</span><br><span class="hljs-comment">         * 参数2：是否定义持久化队列</span><br><span class="hljs-comment">         * 参数3：是否独占本次连接</span><br><span class="hljs-comment">         * 参数4：是否在不使用的时候自动删除队列</span><br><span class="hljs-comment">         * 参数5：队列其它参数</span><br><span class="hljs-comment">         */</span><br>        channel.queueDeclare(DIRECT_QUEUE_INSERT, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<br>        channel.queueDeclare(DIRECT_QUEUE_UPDATE, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-comment">//队列绑定交换机</span><br>        channel.queueBind(DIRECT_QUEUE_INSERT, DIRECT_EXCHAGE, <span class="hljs-string">&quot;insert&quot;</span>);<br>        channel.queueBind(DIRECT_QUEUE_UPDATE, DIRECT_EXCHAGE, <span class="hljs-string">&quot;update&quot;</span>);<br><br>        <span class="hljs-comment">// 发送信息</span><br>        String message = <span class="hljs-string">&quot;新增了商品。路由模式；routing key 为 insert &quot;</span> ;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：交换机名称，如果没有指定则使用默认Default Exchage</span><br><span class="hljs-comment">         * 参数2：路由key,简单模式可以传递队列名称</span><br><span class="hljs-comment">         * 参数3：消息其它属性</span><br><span class="hljs-comment">         * 参数4：消息内容</span><br><span class="hljs-comment">         */</span><br>        channel.basicPublish(DIRECT_EXCHAGE, <span class="hljs-string">&quot;insert&quot;</span>, <span class="hljs-keyword">null</span>, message.getBytes());<br>        System.out.println(<span class="hljs-string">&quot;已发送消息：&quot;</span> + message);<br><br>        <span class="hljs-comment">// 发送信息</span><br>        message = <span class="hljs-string">&quot;修改了商品。路由模式；routing key 为 update&quot;</span> ;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：交换机名称，如果没有指定则使用默认Default Exchage</span><br><span class="hljs-comment">         * 参数2：路由key,简单模式可以传递队列名称</span><br><span class="hljs-comment">         * 参数3：消息其它属性</span><br><span class="hljs-comment">         * 参数4：消息内容</span><br><span class="hljs-comment">         */</span><br>        channel.basicPublish(DIRECT_EXCHAGE, <span class="hljs-string">&quot;update&quot;</span>, <span class="hljs-keyword">null</span>, message.getBytes());<br>        System.out.println(<span class="hljs-string">&quot;已发送消息：&quot;</span> + message);<br><br>        <span class="hljs-comment">// 关闭资源</span><br>        channel.close();<br>        connection.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>消费者1</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Consumer1</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        Connection connection = ConnectionUtil.getConnection();<br><br>        <span class="hljs-comment">// 创建频道</span><br>        Channel channel = connection.createChannel();<br><br>        <span class="hljs-comment">//声明交换机</span><br>        channel.exchangeDeclare(Producer.DIRECT_EXCHAGE, BuiltinExchangeType.DIRECT);<br><br>        <span class="hljs-comment">// 声明（创建）队列</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：队列名称</span><br><span class="hljs-comment">         * 参数2：是否定义持久化队列</span><br><span class="hljs-comment">         * 参数3：是否独占本次连接</span><br><span class="hljs-comment">         * 参数4：是否在不使用的时候自动删除队列</span><br><span class="hljs-comment">         * 参数5：队列其它参数</span><br><span class="hljs-comment">         */</span><br>        channel.queueDeclare(Producer.DIRECT_QUEUE_INSERT, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-comment">//队列绑定交换机</span><br>        channel.queueBind(Producer.DIRECT_QUEUE_INSERT, Producer.DIRECT_EXCHAGE, <span class="hljs-string">&quot;insert&quot;</span>);<br><br>        <span class="hljs-comment">//创建消费者；并设置消息处理</span><br>        DefaultConsumer consumer = <span class="hljs-keyword">new</span> DefaultConsumer(channel)&#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * consumerTag 消息者标签，在channel.basicConsume时候可以指定</span><br><span class="hljs-comment">             * envelope 消息包的内容，可从中获取消息id，消息routingkey，交换机，消息和重传标志(收到消息失败后是否需要重新发送)</span><br><span class="hljs-comment">             * properties 属性信息</span><br><span class="hljs-comment">             * body 消息</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-keyword">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>                <span class="hljs-comment">//路由key</span><br>                System.out.println(<span class="hljs-string">&quot;路由key为：&quot;</span> + envelope.getRoutingKey());<br>                <span class="hljs-comment">//交换机</span><br>                System.out.println(<span class="hljs-string">&quot;交换机为：&quot;</span> + envelope.getExchange());<br>                <span class="hljs-comment">//消息id</span><br>                System.out.println(<span class="hljs-string">&quot;消息id为：&quot;</span> + envelope.getDeliveryTag());<br>                <span class="hljs-comment">//收到的消息</span><br>                System.out.println(<span class="hljs-string">&quot;消费者1-接收到的消息为：&quot;</span> + <span class="hljs-keyword">new</span> String(body, <span class="hljs-string">&quot;utf-8&quot;</span>));<br>            &#125;<br>        &#125;;<br>        <span class="hljs-comment">//监听消息</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：队列名称</span><br><span class="hljs-comment">         * 参数2：是否自动确认，设置为true为表示消息接收到自动向mq回复接收到了，mq接收到回复会删除消息，设置为false则需要手动确认</span><br><span class="hljs-comment">         * 参数3：消息接收到后回调</span><br><span class="hljs-comment">         */</span><br>        channel.basicConsume(Producer.DIRECT_QUEUE_INSERT, <span class="hljs-keyword">true</span>, consumer);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>消费者2</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Consumer2</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        Connection connection = ConnectionUtil.getConnection();<br><br>        <span class="hljs-comment">// 创建频道</span><br>        Channel channel = connection.createChannel();<br><br>        <span class="hljs-comment">//声明交换机</span><br>        channel.exchangeDeclare(Producer.DIRECT_EXCHAGE, BuiltinExchangeType.DIRECT);<br><br>        <span class="hljs-comment">// 声明（创建）队列</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：队列名称</span><br><span class="hljs-comment">         * 参数2：是否定义持久化队列</span><br><span class="hljs-comment">         * 参数3：是否独占本次连接</span><br><span class="hljs-comment">         * 参数4：是否在不使用的时候自动删除队列</span><br><span class="hljs-comment">         * 参数5：队列其它参数</span><br><span class="hljs-comment">         */</span><br>        channel.queueDeclare(Producer.DIRECT_QUEUE_UPDATE, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-comment">//队列绑定交换机</span><br>        channel.queueBind(Producer.DIRECT_QUEUE_UPDATE, Producer.DIRECT_EXCHAGE, <span class="hljs-string">&quot;update&quot;</span>);<br><br>        <span class="hljs-comment">//创建消费者；并设置消息处理</span><br>        DefaultConsumer consumer = <span class="hljs-keyword">new</span> DefaultConsumer(channel)&#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * consumerTag 消息者标签，在channel.basicConsume时候可以指定</span><br><span class="hljs-comment">             * envelope 消息包的内容，可从中获取消息id，消息routingkey，交换机，消息和重传标志(收到消息失败后是否需要重新发送)</span><br><span class="hljs-comment">             * properties 属性信息</span><br><span class="hljs-comment">             * body 消息</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-keyword">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>                <span class="hljs-comment">//路由key</span><br>                System.out.println(<span class="hljs-string">&quot;路由key为：&quot;</span> + envelope.getRoutingKey());<br>                <span class="hljs-comment">//交换机</span><br>                System.out.println(<span class="hljs-string">&quot;交换机为：&quot;</span> + envelope.getExchange());<br>                <span class="hljs-comment">//消息id</span><br>                System.out.println(<span class="hljs-string">&quot;消息id为：&quot;</span> + envelope.getDeliveryTag());<br>                <span class="hljs-comment">//收到的消息</span><br>                System.out.println(<span class="hljs-string">&quot;消费者2-接收到的消息为：&quot;</span> + <span class="hljs-keyword">new</span> String(body, <span class="hljs-string">&quot;utf-8&quot;</span>));<br>            &#125;<br>        &#125;;<br>        <span class="hljs-comment">//监听消息</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：队列名称</span><br><span class="hljs-comment">         * 参数2：是否自动确认，设置为true为表示消息接收到自动向mq回复接收到了，mq接收到回复会删除消息，设置为false则需要手动确认</span><br><span class="hljs-comment">         * 参数3：消息接收到后回调</span><br><span class="hljs-comment">         */</span><br>        channel.basicConsume(Producer.DIRECT_QUEUE_UPDATE, <span class="hljs-keyword">true</span>, consumer);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>测试</p><p>启动所有消费者，然后使用生产者发送消息；在消费者对应的控制台可以查看到生产者发送对应routing key对应队列的消息；到达<strong>按照需要接收</strong>的效果。</p><p>在执行完测试代码后，其实到RabbitMQ的管理后台找到<code>Exchanges</code>选项卡，点击 <code>direct_exchange</code> 的交换机，可以查看到如下的绑定：</p><p><img src="/images/image-20210731233707317.png" alt="image-20210731233707317"></p></li></ol><p>小结：Routing模式要求队列在绑定交换机时要指定routing key，消息会转发到符合routing key的队列</p><h2 id="4-5-Topics通配符模式"><a href="#4-5-Topics通配符模式" class="headerlink" title="4.5 Topics通配符模式"></a>4.5 Topics通配符模式</h2><p><strong>模式说明</strong></p><p><code>Topic</code>类型与<code>Direct</code>相比，都是可以根据<code>RoutingKey</code>把消息路由到不同的队列。只不过<code>Topic</code>类型<code>Exchange</code>可以让队列在绑定<code>Routing key</code> 的时候<strong>使用通配符</strong>。</p><p><code>Routingkey</code> 一般都是有一个或多个单词组成，多个单词之间以”.”分割，例如： <code>item.insert</code></p><p> 通配符规则：</p><p><code>#</code>：匹配一个或多个词</p><p><code>*</code>：匹配不多不少恰好1个词</p><p>举例：</p><ul><li><code>item.#</code>：能够匹配<code>item.insert.abc</code> 或者 <code>item.insert</code></li><li><code>item.*</code>：只能匹配<code>item.insert</code></li></ul><p><img src="/images/image-20210731234158546.png" alt="image-20210731234158546"></p><p><strong>代码</strong> </p><ol><li> 生产者</li></ol><p>   本例使用topic类型的Exchange，发送消息的routing key有3种： <code>item.insert</code>、<code>item.update</code>、<code>item.delete</code></p>   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 通配符Topic的交换机类型为：topic</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Producer</span> </span>&#123;<br><br>    <span class="hljs-comment">//交换机名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String TOPIC_EXCHAGE = <span class="hljs-string">&quot;topic_exchange&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String TOPIC_QUEUE_1 = <span class="hljs-string">&quot;topic_queue_1&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String TOPIC_QUEUE_2 = <span class="hljs-string">&quot;topic_queue_2&quot;</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br>        <span class="hljs-comment">//创建连接</span><br>        Connection connection = ConnectionUtil.getConnection();<br><br>        <span class="hljs-comment">// 创建频道</span><br>        Channel channel = connection.createChannel();<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 声明交换机</span><br><span class="hljs-comment">         * 参数1：交换机名称</span><br><span class="hljs-comment">         * 参数2：交换机类型，fanout、topic、topic、headers</span><br><span class="hljs-comment">         */</span><br>        channel.exchangeDeclare(TOPIC_EXCHAGE, BuiltinExchangeType.TOPIC);<br><br><br>        <span class="hljs-comment">// 发送信息</span><br>        String message = <span class="hljs-string">&quot;新增了商品。Topic模式；routing key 为 item.insert &quot;</span> ;<br>        channel.basicPublish(TOPIC_EXCHAGE, <span class="hljs-string">&quot;item.insert&quot;</span>, <span class="hljs-keyword">null</span>, message.getBytes());<br>        System.out.println(<span class="hljs-string">&quot;已发送消息：&quot;</span> + message);<br><br>        <span class="hljs-comment">// 发送信息</span><br>        message = <span class="hljs-string">&quot;修改了商品。Topic模式；routing key 为 item.update&quot;</span> ;<br>        channel.basicPublish(TOPIC_EXCHAGE, <span class="hljs-string">&quot;item.update&quot;</span>, <span class="hljs-keyword">null</span>, message.getBytes());<br>        System.out.println(<span class="hljs-string">&quot;已发送消息：&quot;</span> + message);<br><br>        <span class="hljs-comment">// 发送信息</span><br>        message = <span class="hljs-string">&quot;删除了商品。Topic模式；routing key 为 item.delete&quot;</span> ;<br>        channel.basicPublish(TOPIC_EXCHAGE, <span class="hljs-string">&quot;item.delete&quot;</span>, <span class="hljs-keyword">null</span>, message.getBytes());<br>        System.out.println(<span class="hljs-string">&quot;已发送消息：&quot;</span> + message);<br><br>        <span class="hljs-comment">// 关闭资源</span><br>        channel.close();<br>        connection.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li><p>消费者1</p><p>接收两种类型的消息：更新商品和删除商品</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Consumer1</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        Connection connection = ConnectionUtil.getConnection();<br><br>        <span class="hljs-comment">// 创建频道</span><br>        Channel channel = connection.createChannel();<br><br>        <span class="hljs-comment">//声明交换机</span><br>        channel.exchangeDeclare(Producer.TOPIC_EXCHAGE, BuiltinExchangeType.TOPIC);<br><br>        <span class="hljs-comment">// 声明（创建）队列</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：队列名称</span><br><span class="hljs-comment">         * 参数2：是否定义持久化队列</span><br><span class="hljs-comment">         * 参数3：是否独占本次连接</span><br><span class="hljs-comment">         * 参数4：是否在不使用的时候自动删除队列</span><br><span class="hljs-comment">         * 参数5：队列其它参数</span><br><span class="hljs-comment">         */</span><br>        channel.queueDeclare(Producer.TOPIC_QUEUE_1, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-comment">//队列绑定交换机</span><br>        channel.queueBind(Producer.TOPIC_QUEUE_1, Producer.TOPIC_EXCHAGE, <span class="hljs-string">&quot;item.update&quot;</span>);<br>        channel.queueBind(Producer.TOPIC_QUEUE_1, Producer.TOPIC_EXCHAGE, <span class="hljs-string">&quot;item.delete&quot;</span>);<br><br>        <span class="hljs-comment">//创建消费者；并设置消息处理</span><br>        DefaultConsumer consumer = <span class="hljs-keyword">new</span> DefaultConsumer(channel)&#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * consumerTag 消息者标签，在channel.basicConsume时候可以指定</span><br><span class="hljs-comment">             * envelope 消息包的内容，可从中获取消息id，消息routingkey，交换机，消息和重传标志(收到消息失败后是否需要重新发送)</span><br><span class="hljs-comment">             * properties 属性信息</span><br><span class="hljs-comment">             * body 消息</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-keyword">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>                <span class="hljs-comment">//路由key</span><br>                System.out.println(<span class="hljs-string">&quot;路由key为：&quot;</span> + envelope.getRoutingKey());<br>                <span class="hljs-comment">//交换机</span><br>                System.out.println(<span class="hljs-string">&quot;交换机为：&quot;</span> + envelope.getExchange());<br>                <span class="hljs-comment">//消息id</span><br>                System.out.println(<span class="hljs-string">&quot;消息id为：&quot;</span> + envelope.getDeliveryTag());<br>                <span class="hljs-comment">//收到的消息</span><br>                System.out.println(<span class="hljs-string">&quot;消费者1-接收到的消息为：&quot;</span> + <span class="hljs-keyword">new</span> String(body, <span class="hljs-string">&quot;utf-8&quot;</span>));<br>            &#125;<br>        &#125;;<br>        <span class="hljs-comment">//监听消息</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：队列名称</span><br><span class="hljs-comment">         * 参数2：是否自动确认，设置为true为表示消息接收到自动向mq回复接收到了，mq接收到回复会删除消息，设置为false则需要手动确认</span><br><span class="hljs-comment">         * 参数3：消息接收到后回调</span><br><span class="hljs-comment">         */</span><br>        channel.basicConsume(Producer.TOPIC_QUEUE_1, <span class="hljs-keyword">true</span>, consumer);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>消费者2</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Consumer2</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        Connection connection = ConnectionUtil.getConnection();<br><br>        <span class="hljs-comment">// 创建频道</span><br>        Channel channel = connection.createChannel();<br><br>        <span class="hljs-comment">//声明交换机</span><br>        channel.exchangeDeclare(Producer.TOPIC_EXCHAGE, BuiltinExchangeType.TOPIC);<br><br>        <span class="hljs-comment">// 声明（创建）队列</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：队列名称</span><br><span class="hljs-comment">         * 参数2：是否定义持久化队列</span><br><span class="hljs-comment">         * 参数3：是否独占本次连接</span><br><span class="hljs-comment">         * 参数4：是否在不使用的时候自动删除队列</span><br><span class="hljs-comment">         * 参数5：队列其它参数</span><br><span class="hljs-comment">         */</span><br>        channel.queueDeclare(Producer.TOPIC_QUEUE_2, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-comment">//队列绑定交换机</span><br>        channel.queueBind(Producer.TOPIC_QUEUE_2, Producer.TOPIC_EXCHAGE, <span class="hljs-string">&quot;item.*&quot;</span>);<br><br>        <span class="hljs-comment">//创建消费者；并设置消息处理</span><br>        DefaultConsumer consumer = <span class="hljs-keyword">new</span> DefaultConsumer(channel)&#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * consumerTag 消息者标签，在channel.basicConsume时候可以指定</span><br><span class="hljs-comment">             * envelope 消息包的内容，可从中获取消息id，消息routingkey，交换机，消息和重传标志(收到消息失败后是否需要重新发送)</span><br><span class="hljs-comment">             * properties 属性信息</span><br><span class="hljs-comment">             * body 消息</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="hljs-keyword">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>                <span class="hljs-comment">//路由key</span><br>                System.out.println(<span class="hljs-string">&quot;路由key为：&quot;</span> + envelope.getRoutingKey());<br>                <span class="hljs-comment">//交换机</span><br>                System.out.println(<span class="hljs-string">&quot;交换机为：&quot;</span> + envelope.getExchange());<br>                <span class="hljs-comment">//消息id</span><br>                System.out.println(<span class="hljs-string">&quot;消息id为：&quot;</span> + envelope.getDeliveryTag());<br>                <span class="hljs-comment">//收到的消息</span><br>                System.out.println(<span class="hljs-string">&quot;消费者2-接收到的消息为：&quot;</span> + <span class="hljs-keyword">new</span> String(body, <span class="hljs-string">&quot;utf-8&quot;</span>));<br>            &#125;<br>        &#125;;<br>        <span class="hljs-comment">//监听消息</span><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 参数1：队列名称</span><br><span class="hljs-comment">         * 参数2：是否自动确认，设置为true为表示消息接收到自动向mq回复接收到了，mq接收到回复会删除消息，设置为false则需要手动确认</span><br><span class="hljs-comment">         * 参数3：消息接收到后回调</span><br><span class="hljs-comment">         */</span><br>        channel.basicConsume(Producer.TOPIC_QUEUE_2, <span class="hljs-keyword">true</span>, consumer);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>测试</p><p>启动所有消费者，然后使用生产者发送消息；在消费者对应的控制台可以查看到生产者发送对应routing key对应队列的消息；到达<strong>按照需要接收</strong>的效果；并且这些routing key可以使用通配符。</p></li></ol><p>小结：</p><ul><li>Topic主题模式可以实现 <code>Publish/Subscribe发布与订阅模式</code> 和 <code> Routing路由模式</code> 的功能；只是Topic在配置routing key 的时候可以使用通配符，显得更加灵活。</li></ul><h2 id="4-6-模式总结"><a href="#4-6-模式总结" class="headerlink" title="4.6. 模式总结"></a>4.6. 模式总结</h2><p>RabbitMQ工作模式：<br><strong>1、简单模式 HelloWorld</strong><br>一个生产者、一个消费者，不需要设置交换机（使用默认的交换机）</p><p><strong>2、工作队列模式 Work Queue</strong><br>一个生产者、多个消费者（竞争关系），不需要设置交换机（使用默认的交换机）</p><p><strong>3、发布订阅模式 Publish/subscribe</strong><br>需要设置类型为fanout的交换机，并且交换机和队列进行绑定，当发送消息到交换机后，交换机会将消息发送到绑定的队列</p><p><strong>4、路由模式 Routing</strong><br>需要设置类型为direct的交换机，交换机和队列进行绑定，并且指定routing key，当发送消息到交换机后，交换机会根据routing key将消息发送到对应的队列</p><p><strong>5、通配符模式 Topic</strong><br>需要设置类型为topic的交换机，交换机和队列进行绑定，并且指定通配符方式的routing key，当发送消息到交换机后，交换机会根据routing key将消息发送到对应的队列</p><h1 id="5-Spring-Boot整合RabbitMQ"><a href="#5-Spring-Boot整合RabbitMQ" class="headerlink" title="5. Spring Boot整合RabbitMQ"></a>5. Spring Boot整合RabbitMQ</h1><h2 id="5-1-简介"><a href="#5-1-简介" class="headerlink" title="5.1 简介"></a>5.1 简介</h2><p>在spring boot项目中只需要引入对应的amqp启动器依赖即可，方便的使用RabbitTemplate发送消息，使用注解接收消息。</p><p>一般在开发过程中：</p><ul><li><strong>生产者工程：</strong><ol><li>application.yml文件配置RabbitMQ相关信息；</li><li>在生产者工程中编写配置类，用于创建交换机和队列，并进行绑定</li><li>注入RabbitTemplate对象，通过RabbitTemplate对象发送消息到交换机</li></ol></li><li><strong>消费者工程：</strong><ol><li>application.yml文件配置RabbitMQ相关信息</li><li>创建消息处理类，用于接收队列中的消息并进行处理</li></ol></li></ul><h2 id="5-2-搭建生产者工程"><a href="#5-2-搭建生产者工程" class="headerlink" title="5.2 搭建生产者工程"></a>5.2 搭建生产者工程</h2><h3 id="5-2-1-搭建生产者工程"><a href="#5-2-1-搭建生产者工程" class="headerlink" title="5.2.1 搭建生产者工程"></a>5.2.1 搭建生产者工程</h3><p>创建生产者工程springboot-rabbitmq-producer</p><h3 id="5-2-2-添加依赖"><a href="#5-2-2-添加依赖" class="headerlink" title="5.2.2 添加依赖"></a>5.2.2 添加依赖</h3><p>修改pom.xml文件内容为如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.4.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.itheima<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springboot-rabbitmq-producer<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--主要就是这个包--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="5-2-3-启动类"><a href="#5-2-3-启动类" class="headerlink" title="5.2.3. 启动类"></a>5.2.3. 启动类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProducerApplication</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(ProducerApplication.class);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-2-4-配置RabbitMQ"><a href="#5-2-4-配置RabbitMQ" class="headerlink" title="5.2.4. 配置RabbitMQ"></a>5.2.4. 配置RabbitMQ</h3><ol><li><p>配置文件</p><p>创建application.yml，内容如下：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.128</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">virtual-host:</span> <span class="hljs-string">/</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span><br></code></pre></td></tr></table></figure></li><li><p>绑定交换机和队列</p><p>创建RabbitMQ队列与交换机绑定的配置类com.itheima.rabbitmq.config.RabbitMQConfig</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RabbitMQConfig</span> </span>&#123;<br>    <span class="hljs-comment">//交换机名称</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String ITEM_TOPIC_EXCHANGE = <span class="hljs-string">&quot;item_topic_exchange&quot;</span>;<br>    <span class="hljs-comment">//队列名称</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String ITEM_QUEUE = <span class="hljs-string">&quot;item_queue&quot;</span>;<br><br>    <span class="hljs-comment">//声明交换机</span><br>    <span class="hljs-meta">@Bean(&quot;itemTopicExchange&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Exchange <span class="hljs-title">topicExchange</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> ExchangeBuilder.topicExchange(ITEM_TOPIC_EXCHANGE).durable(<span class="hljs-keyword">true</span>).build();<br>    &#125;<br><br>    <span class="hljs-comment">//声明队列</span><br>    <span class="hljs-meta">@Bean(&quot;itemQueue&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">itemQueue</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> QueueBuilder.durable(ITEM_QUEUE).build();<br>    &#125;<br><br>    <span class="hljs-comment">//绑定队列和交换机</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">itemQueueExchange</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(&quot;itemQueue&quot;)</span> Queue queue,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     <span class="hljs-meta">@Qualifier(&quot;itemTopicExchange&quot;)</span> Exchange exchange)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="hljs-string">&quot;item.#&quot;</span>).noargs();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h2 id="5-3-搭建消费者工程"><a href="#5-3-搭建消费者工程" class="headerlink" title="5.3. 搭建消费者工程"></a>5.3. 搭建消费者工程</h2><h3 id="5-3-1-创建工程"><a href="#5-3-1-创建工程" class="headerlink" title="5.3.1. 创建工程"></a>5.3.1. 创建工程</h3><p>创建消费者工程springboot-rabbitmq-consumer</p><h3 id="5-3-2-添加依赖"><a href="#5-3-2-添加依赖" class="headerlink" title="5.3.2. 添加依赖"></a>5.3.2. 添加依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.4.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.itheima<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springboot-rabbitmq-consumer<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--只用添加这个和消息中间件RabbitMQ有关的包--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="5-3-3-配置RabbitMQ"><a href="#5-3-3-配置RabbitMQ" class="headerlink" title="5.3.3 配置RabbitMQ"></a>5.3.3 配置RabbitMQ</h3><p>创建application.yml，内容如下：</p><p>注意：</p><ul><li>消费者和生产者的配置文件是一样的</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.128</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">virtual-host:</span> <span class="hljs-string">/</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span><br></code></pre></td></tr></table></figure><h3 id="5-3-4-启动类"><a href="#5-3-4-启动类" class="headerlink" title="5.3.4 启动类"></a>5.3.4 启动类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConsumerApplication</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(ConsumerApplication.class);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-3-5-消息监听处理类"><a href="#5-3-5-消息监听处理类" class="headerlink" title="5.3.5 消息监听处理类"></a>5.3.5 消息监听处理类</h3><p>编写消息监听器com.itheima.rabbitmq.listener.MyListener</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyListener</span> </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 监听某个队列的消息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message 接收到的消息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RabbitListener(queues = &quot;item_queue&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">myListener1</span><span class="hljs-params">(String message)</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;消费者接收到的消息为：&quot;</span> + message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>最后进行测试</p><p>在生产者工程springboot-rabbitmq-producer中创建测试类，发送消息：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RabbitMQTest</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span></span>&#123;<br>        rabbitTemplate.convertAndSend(RabbitMQConfig.ITEM_TOPIC_EXCHANGE, <span class="hljs-string">&quot;item.insert&quot;</span>, <span class="hljs-string">&quot;商品新增，routing key 为item.insert&quot;</span>);<br>        rabbitTemplate.convertAndSend(RabbitMQConfig.ITEM_TOPIC_EXCHANGE, <span class="hljs-string">&quot;item.update&quot;</span>, <span class="hljs-string">&quot;商品修改，routing key 为item.update&quot;</span>);<br>        rabbitTemplate.convertAndSend(RabbitMQConfig.ITEM_TOPIC_EXCHANGE, <span class="hljs-string">&quot;item.delete&quot;</span>, <span class="hljs-string">&quot;商品删除，routing key 为item.delete&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>先运行上述测试程序（交换机和队列才能先被声明和绑定），然后启动消费者；在消费者工程springboot-rabbitmq-consumer中控制台查看是否接收到对应消息。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>畅购商城项目第五部分</title>
    <link href="/2021/07/29/1.5%20%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86/"/>
    <url>/2021/07/29/1.5%20%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E7%AC%AC%E4%BA%94%E9%83%A8%E5%88%86/</url>
    
    <content type="html"><![CDATA[<h1 id="Part12-分布式事务解决方案"><a href="#Part12-分布式事务解决方案" class="headerlink" title="Part12 分布式事务解决方案"></a>Part12 分布式事务解决方案</h1><h2 id="1-分布式事务解决方案"><a href="#1-分布式事务解决方案" class="headerlink" title="1. 分布式事务解决方案"></a>1. 分布式事务解决方案</h2><p>刚才我们编写的扣减库存与保存订单是在两个服务中存在的，如果扣减库存后订单保存失败了是不会回滚的，这样就会造成数据不一致的情况，这其实就是我们所说的分布式事务的问题，接下来我们来学习分布式事务的解决方案。</p><h3 id="1-1-本地事务与分布式事务"><a href="#1-1-本地事务与分布式事务" class="headerlink" title="1.1 本地事务与分布式事务"></a>1.1 本地事务与分布式事务</h3><h4 id="1-1-1-事务"><a href="#1-1-1-事务" class="headerlink" title="1.1.1 事务"></a>1.1.1 事务</h4><p>数据库事务(简称：事务，Transaction)是指数据库执行过程中的一个逻辑单位，由一个有限的数据库操作序列构成。</p><p>事务拥有以下四个特性，习惯上被称为ACID特性：</p><ol><li>原子性(Atomicity)：事务作为一个整体被执行，包含在其中的对数据库的操作要么全部被执行，要么都不执行</li><li>一致性(Consistency)：事务应确保数据库的状态从一个一致状态转变为另一个一致状态。一致状态是指数据库中的数据应满足完整性约束。除此之外，一致性还有另外一层语义，就是事务的中间状态不能被观察到(这层语义也有说应该属于原子性)</li><li>隔离性(Isolation)：多个事务并发执行时，一个事务的执行不应影响其他事务的执行，如同只有这一个操作在被数据库所执行一样</li><li>持久性(Durability)：已被提交的事务对数据库的修改应该永久保存在数据库中。在事务结束时，此操作将不可逆转</li></ol><h4 id="1-1-2-本地事务"><a href="#1-1-2-本地事务" class="headerlink" title="1.1.2 本地事务"></a>1.1.2 本地事务</h4><p>起初，事务仅限于对单一数据库资源的访问控制,架构服务化以后，事务的概念延伸到了服务中。倘若将一个单一的服务操作作为一个事务，那么整个服务操作只能涉及一个单一的数据库资源,这类基于单个服务单一数据库资源访问的事务，被称为本地事务(Local Transaction)。</p><p><img src="/images/image-20210808153508886.png" alt="image-20210808153508886"></p><h4 id="1-1-3-分布式事务"><a href="#1-1-3-分布式事务" class="headerlink" title="1.1.3 分布式事务"></a>1.1.3 分布式事务</h4><p>分布式事务指事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于不同的分布式系统的不同节点之上,且属于不同的应用，分布式事务需要保证这些操作要么全部成功，要么全部失败。本质上来说，分布式事务就是为了保证不同数据库的数据一致性。</p><p>最早的分布式事务应用架构很简单，不涉及服务间的访问调用，仅仅是服务内操作涉及到对多个数据库资源的访问。</p><p><img src="/images/image-20210808153651910.png" alt="image-20210808153651910"></p><p>当一个服务操作访问不同的数据库资源，又希望对它们的访问具有事务特性时，就需要采用分布式事务来协调所有的事务参与者。</p><p>对于上面介绍的分布式事务应用架构，尽管一个服务操作会访问多个数据库资源，但是毕竟整个事务还是控制在单一服务的内部。如果一个服务操作需要调用另外一个服务，这时的事务就需要跨越多个服务了。在这种情况下，起始于某个服务的事务在调用另外一个服务的时候，需要以某种机制流转到另外一个服务，从而使被调用的服务访问的资源也自动加入到该事务当中来。下图反映了这样一个跨越多个服务的分布式事务：</p><p><img src="/images/image-20210808153833411.png" alt="image-20210808153833411"></p><p>如果将上面这两种场景(一个服务可以调用多个数据库资源，也可以调用其他服务)结合在一起，对此进行延伸，整个分布式事务的参与者将会组成如下图所示的树形拓扑结构。在一个跨服务的分布式事务中，事务的发起者和提交均系同一个，它可以是整个调用的客户端，也可以是客户端最先调用的那个服务。</p><p><img src="/images/image-20210808154127517.png" alt="image-20210808154127517"></p><p>较之基于单一数据库资源访问的本地事务，分布式事务的应用架构更为复杂。在不同的分布式应用架构下，实现一个分布式事务要考虑的问题并不完全一样，比如对多资源的协调、事务的跨服务传播等，实现机制也是复杂多变。</p><h3 id="1-2-分布式事务相关理论"><a href="#1-2-分布式事务相关理论" class="headerlink" title="1.2 分布式事务相关理论"></a>1.2 分布式事务相关理论</h3><h4 id="1-2-1-CAP定理"><a href="#1-2-1-CAP定理" class="headerlink" title="1.2.1 CAP定理"></a>1.2.1 CAP定理</h4><p><img src="/images/image-20210808154429381.png" alt="image-20210808154429381"></p><p>CAP定理是在 1998年加州大学的计算机科学家 Eric Brewer （埃里克.布鲁尔）提出，分布式系统有三个指标:</p><ol><li>Consistency (一致性)</li><li>Availability (可用性)</li><li>Partition tolerance(分区容错性)</li></ol><p>它们的第一个字母分别是 C、A、P。Eric Brewer 说，这三个指标不可能同时做到。这个结论就叫做 CAP 定理。</p><p><strong>分区容错 Partition tolerance</strong></p><p>大多数分布式系统都分布在多个子网络。每个子网络就叫做一个区（partition）。分区容错的意思是，区间通信可能失败。比如，一台服务器放在中国，另一台服务器放在美国，这就是两个区，它们之间可能无法通信。</p><p><img src="/images/image-20210808154756029.png" alt="image-20210808154756029"></p><p>上图中，G1 和 G2 是两台跨区的服务器。G1 向 G2 发送一条消息，G2 可能无法收到。系统设计的时候，必须考虑到这种情况。</p><p>一般来说，分区容错无法避免，因此可以认为 CAP 的 P 总是成立。CAP 定理告诉我们，剩下的 C 和 A 无法同时做到。</p><p><strong>可用性 Availability</strong></p><p>Availability 中文叫做”可用性”，意思是只要收到用户的请求，服务器就必须给出回应。</p><p>用户可以选择向 G1 或 G2 发起读操作。不管是哪台服务器，只要收到请求，就必须告诉用户，到底是 v0 还是 v1，否则就不满足可用性。</p><p><img src="/images/image-20210808155159592.png" alt="image-20210808155159592"></p><p><strong>一致性 Consistency</strong></p><p>Consistency 中文叫做”一致性”。意思是，写操作之后的读操作，必须返回该值。</p><p>举例来说，某条记录是 v0，用户向 G1 发起一个写操作，将其改为 v1。</p><p><img src="/images/image-20210808155400246.png" alt="image-20210808155400246"></p><p>问题是，用户有可能向 G2 发起读操作，由于 G2 的值没有发生变化，因此返回的是 v0。G1 和 G2 读操作的结果不一致，这就不满足一致性了。</p><p><img src="/images/image-20210808155459722.png" alt="image-20210808155459722"></p><p>为了让 G2 也能变为 v1，就要在 G1 写操作的时候，让 G1 向 G2 发送一条消息，要求 G2 也改成 v1。</p><p><img src="/images/image-20210808155553113.png" alt="image-20210808155553113"></p><p><strong>一致性和可用性的矛盾</strong></p><p>一致性和可用性，为什么不可能同时成立？答案很简单，因为可能通信失败（即出现分区容错）。</p><p>如果保证 G2 的一致性，那么 G1 必须在写操作时，锁定 G2 的读操作和写操作。只有数据同步后，才能重新开放读写。锁定期间，G2 不能读写，没有可用性。</p><p>如果保证 G2 的可用性，那么势必不能锁定 G2，所以一致性不成立。</p><p>综上所述，G2 无法同时做到一致性和可用性。系统设计时只能选择一个目标。如果追求一致性，那么无法保证所有节点的可用性；如果追求所有节点的可用性，那就没法做到一致性。</p><h4 id="1-2-2-BASE理论"><a href="#1-2-2-BASE理论" class="headerlink" title="1.2.2 BASE理论"></a>1.2.2 BASE理论</h4><p>BASE全称：Basically Available(基本可用)，Soft state（软状态）,和 Eventually consistent（最终一致性）三个短语的缩写，来自 ebay 的架构师提出。BASE 理论是对 CAP 中一致性和可用性权衡的结果，其来源于对大型互联网分布式实践的总结，是基于 CAP 定理逐步演化而来的。其核心思想是：</p><ul><li>既是无法做到强一致性（Strong consistency），但每个应用都可以根据自身的业务特点，采用适当的方式来使系统达到最终一致性（Eventual consistency）。</li></ul><p><strong>Basically Available(基本可用)</strong></p><p>什么是基本可用呢？假设系统，出现了不可预知的故障，但还是能用，相比较正常的系统而言：</p><ol><li>响应时间上的损失：正常情况下的搜索引擎 0.5 秒即返回给用户结果，而<strong>基本可用</strong>的搜索引擎可以在 1 秒作用返回结果。</li><li>功能上的损失：在一个电商网站上，正常情况下，用户可以顺利完成每一笔订单，但是到了大促期间，为了保护购物系统的稳定性，部分消费者可能会被引导到一个降级页面。</li></ol><p><strong>Soft state(软状态)</strong></p><p>什么是软状态呢？相对于原子性而言，要求多个节点的数据副本都是一致的，这是一种 “硬状态”。</p><p>软状态指的是：允许系统中的数据存在中间状态，并认为该状态不影响系统的整体可用性，即允许系统在多个不同节点的数据副本存在数据延时。</p><p><strong>Eventually consistent(最终一致性)</strong></p><p>系统能够保证在没有其他新的更新操作的情况下，数据最终一定能够达到一致的状态，因此所有客户端对系统的数据访问最终都能够获取到最新的值</p><h3 id="1-3-分布式事务解决方案"><a href="#1-3-分布式事务解决方案" class="headerlink" title="1.3 分布式事务解决方案"></a>1.3 分布式事务解决方案</h3><p>下面介绍了三种：</p><ol><li>基于XA协议的两阶段提交 2PC</li><li>TCC补偿机制</li><li>消息最终一致性（比较常用）</li></ol><h4 id="1-3-1-基于XA协议的两阶段提交-2PC"><a href="#1-3-1-基于XA协议的两阶段提交-2PC" class="headerlink" title="1.3.1 基于XA协议的两阶段提交 2PC"></a>1.3.1 基于XA协议的两阶段提交 2PC</h4><p>首先我们来简要看下分布式事务处理的XA规范 ：</p><p><img src="/images/image-20210808162019064.png" alt="image-20210808162019064"></p><p>可知XA规范中分布式事务有AP，RM，TM组成：</p><ul><li>其中应用程序(Application Program ，简称AP)：AP定义事务边界（定义事务开始和结束）并访问事务边界内的资源。</li><li>资源管理器(Resource Manager，简称RM)：Rm管理计算机共享的资源，许多软件都可以去访问这些资源，资源包含比如数据库、文件系统、打印机服务器等。</li><li>事务管理器(Transaction Manager ，简称TM)：负责管理全局事务，分配事务唯一标识，监控事务的执行进度，并负责事务的提交、回滚、失败恢复等。</li></ul><p><strong>二阶段协议</strong></p><p><strong>第一阶段</strong>TM要求所有的RM准备提交对应的事务分支，询问RM是否有能力保证成功的提交事务分支，RM根据自己的情况，如果判断自己进行的工作可以被提交，那就对工作内容进行持久化，并给TM回执OK；否者给TM的回执NO。RM在发送了否定答复并回滚了已经完成的工作后，就可以丢弃这个事务分支信息了。</p><p><strong>第二阶段</strong>TM根据阶段1各个RM prepare的结果，决定是提交还是回滚事务。如果所有的RM都prepare成功，那么TM通知所有的RM进行提交；如果有RM prepare回执NO的话，则TM通知所有RM回滚自己的事务分支。</p><p><strong>优点：</strong> 尽量保证了数据的强一致，适合对数据强一致要求很高的关键领域。（其实也不能100%保证强一致）</p><p><strong>缺点：</strong> 实现复杂，牺牲了可用性，对性能影响较大，不适合高并发高性能场景。</p><h4 id="1-3-2-TCC补偿机制"><a href="#1-3-2-TCC补偿机制" class="headerlink" title="1.3.2 TCC补偿机制"></a>1.3.2 TCC补偿机制</h4><p>TCC 其实就是采用的补偿机制，其核心思想是：针对每个操作，都要注册一个与其对应的确认和补偿（撤销）操作。它分为三个阶段：</p><ol><li><p>Try 阶段主要是对业务系统做检测及资源预留</p></li><li><p>Confirm 阶段主要是对业务系统做确认提交，Try阶段执行成功并开始执行 Confirm阶段时，默认 Confirm阶段是不会出错的。即：只要Try成功，Confirm一定成功。</p></li><li><p>Cancel 阶段主要是在业务执行错误，需要回滚的状态下执行的业务取消，预留资源释放。</p><p><img src="/images/image-20210808163206446.png" alt="image-20210808163206446"></p></li></ol><p>例如： A要向 B 转账，思路大概是：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs less">我们有一个本地方法，里面依次调用 <br><span class="hljs-selector-tag">1</span>、首先在 <span class="hljs-selector-tag">Try</span> 阶段，要先调用远程接口把 <span class="hljs-selector-tag">B</span>和 <span class="hljs-selector-tag">A</span>的钱给冻结起来。 <br><span class="hljs-selector-tag">2</span>、在 <span class="hljs-selector-tag">Confirm</span> 阶段，执行远程调用的转账的操作，转账成功进行解冻。 <br><span class="hljs-selector-tag">3</span>、如果第<span class="hljs-selector-tag">2</span>步执行成功，那么转账成功，如果第二步执行失败，则调用远程冻结接口对应的解冻方法 (Cancel)。<br></code></pre></td></tr></table></figure><p><strong>优点：</strong> 相比两阶段提交，可用性比较强</p><p><strong>缺点：</strong> 数据的一致性要差一些。TCC属于应用层的一种补偿方式，所以需要程序员在实现的时候多写很多补偿的代码，在一些场景中，一些业务流程可能用TCC不太好定义及处理。</p><h4 id="1-3-3-消息最终一致性"><a href="#1-3-3-消息最终一致性" class="headerlink" title="1.3.3 消息最终一致性"></a>1.3.3 消息最终一致性</h4><p>消息最终一致性应该是业界使用最多的，其核心思想是将分布式事务拆分成本地事务进行处理，这种思路是来源于ebay。我们可以从下面的流程图中看出其中的一些细节：</p><p><img src="/images/image-20210808163618176.png" alt="image-20210808163618176"></p><p>基本思路就是：</p><p>消息生产方，需要额外建一个消息表，并记录消息发送状态。消息表和业务数据要在一个事务里提交，也就是说他们要在一个数据库里面。然后消息会经过MQ发送到消息的消费方。如果消息发送失败，会进行重试发送。</p><p>消息消费方，需要处理这个消息，并完成自己的业务逻辑。此时如果本地事务处理成功，表明已经处理成功了，如果处理失败，那么就会重试执行。如果是业务上面的失败，可以给生产方发送一个业务补偿消息，通知生产方进行回滚等操作。</p><p>生产方和消费方定时扫描本地消息表，把还没处理完成的消息或者失败的消息再发送一遍。如果有靠谱的自动对账补账逻辑，这种方案还是非常实用的。</p><p><strong>优点：</strong> 一种非常经典的实现，避免了分布式事务，实现了最终一致性。</p><p><strong>缺点：</strong> 消息表会耦合到业务系统中，如果没有封装好的解决方案，会有很多杂活需要处理。</p><h2 id="2-基于Seata实现分布式事务"><a href="#2-基于Seata实现分布式事务" class="headerlink" title="2. 基于Seata实现分布式事务"></a>2. 基于Seata实现分布式事务</h2><h3 id="2-1-Seata简介"><a href="#2-1-Seata简介" class="headerlink" title="2.1 Seata简介"></a>2.1 Seata简介</h3><p>Seata（原名Fescar） 是阿里18年开源的分布式事务的框架。Fescar的开源对分布式事务框架领域影响很大。作为开源大户，Fescar来自阿里的GTS，经历了好几次双十一的考验，一经开源便颇受关注。后来Fescar改名为Seata。</p><p>Fescar虽然是二阶段提交协议的分布式事务，但是其解决了XA的一些缺点:</p><ul><li>单点问题</li><li>同步阻塞:Fescar的二阶段，其再第一阶段的时候本地事务就已经提交释放资源了，不会像XA会再两个prepare和commit阶段资源都锁住，并且Fescar,commit是异步操作，也是提升性能的一大关键。</li><li>数据不一致:如果出现部分commit失败，那么fescar-server会根据当前的事务模式和分支事务的返回状态的结果来进行不同的重试策略。并且fescar的本地事务会在一阶段的时候进行提交，其实单看数据库来说在commit的时候数据库已经是一致的了。</li><li>只能用于单一数据库: Fescar提供了两种模式，AT和MT。在AT模式下事务资源可以是任何支持ACID的数据库，在MT模式下事务资源没有限制，可以是缓存，可以是文件，可以是其他的等等。当然这两个模式也可以混用。</li></ul><p>同时Fescar也保留了接近0业务入侵的优点，只需要简单的配置Fescar的数据代理和加个注解，加一个Undolog表，就可以达到我们想要的目的。</p><h3 id="2-2-实现原理"><a href="#2-2-实现原理" class="headerlink" title="2.2 实现原理"></a>2.2 实现原理</h3><p>Fescar将一个本地事务做为一个分布式事务分支，所以若干个分布在不同微服务中的本地事务共同组成了一个全局事务，结构如下。</p><p><img src="/images/image-20210808170047659.png" alt="image-20210808170047659"></p><p><strong>Transaction Coordinator (TC)：</strong> 事务协调器，维护全局事务的运行状态，负责协调并驱动全局事务的提交或回滚。</p><p><strong>Transaction Manager (TM)：</strong>事务管理器， 控制全局事务的边界，负责开启一个全局事务，并最终发起全局提交或全局回滚的决议。</p><p><strong>Resource Manager (RM)：</strong>资源管理器， 控制分支事务，负责分支注册、状态汇报，并接收事务协调器的指令，驱动分支（本地）事务的提交和回滚。</p><p>一个典型的分布式事务过程：</p><ol><li>TM 向 TC 申请开启一个全局事务，全局事务创建成功并生成一个全局唯一的 XID</li><li>XID 在微服务调用链路的上下文中传播</li><li>RM 向 TC 注册分支事务，将其纳入 XID 对应全局事务的管辖</li><li>TM 向 TC 发起针对 XID 的全局提交或回滚决议</li><li>TC 调度 XID 下管辖的全部分支事务完成提交或回滚请求</li></ol><h3 id="2-3-Fescar模式"><a href="#2-3-Fescar模式" class="headerlink" title="2.3 Fescar模式"></a>2.3 Fescar模式</h3><p>Fescar对分布式事务的实现提供了3种模式，AT模式、MT模式和混合模式：</p><h4 id="2-3-1-AT模式"><a href="#2-3-1-AT模式" class="headerlink" title="2.3.1 AT模式"></a>2.3.1 AT模式</h4><p>业务逻辑不需要关注事务机制，分支与全局事务的交互过程自动进行。</p><p><strong>AT模式</strong>：主要关注多 DB 访问的数据一致性，实现起来比较简单，对业务的侵入较小。</p><p>AT模式部分代码如下：不需要关注执行状态，对业务代码侵入较小。类似代码如下，只需要为方法添加<code>@GlobalTransactional</code>注解即可。</p><p>AT模式的核心是对业务无侵入，是一种改进后的两阶段提交，其设计思路如图：</p><p><strong>第一阶段：</strong></p><p><img src="/images/image-20210808171613070.png" alt="image-20210808171613070"></p><p>核心在于对业务sql进行解析，转换成undolog，两阶段提交往往对资源的锁定需要持续到第二阶段实际的提交或者回滚操作，而有了回滚日志之后，可以在第一阶段释放对资源的锁定，降低了锁范围，提高效率，即使第二阶段发生异常需要回滚，只需找对undolog中对应数据并反解析成sql来达到回滚目的。Seata通过代理数据源将业务sql的执行解析成undolog来与业务数据的更新同时入库，达到了对业务无侵入的效果。</p><p><strong>第二阶段：</strong></p><p>如果决议是全局提交，此时分支事务此时已经完成提交，不需要同步协调处理（只需要异步清理回滚日志），Phase2 可以非常快速地完成。</p><p><img src="/images/image-20210808172343299.png" alt="image-20210808172343299"></p><p>如果决议是全局回滚，RM 收到协调器发来的回滚请求，通过 XID 和 Branch ID 找到相应的回滚日志记录，通过回滚记录生成反向的更新 SQL 并执行，以完成分支的回滚。</p><p><img src="/images/image-20210808172427714.png" alt="image-20210808172427714"></p><h4 id="2-3-2-MT模式"><a href="#2-3-2-MT模式" class="headerlink" title="2.3.2 MT模式"></a>2.3.2 MT模式</h4><p>业务逻辑需要被分解为 Prepare/Commit/Rollback 3 部分，形成一个 MT 分支，加入全局事务。</p><p><img src="/images/image-20210808172713861.png" alt="image-20210808172713861"></p><p>MT 模式一方面是 AT 模式的补充。另外，更重要的价值在于，通过 MT 模式可以把众多非事务性资源纳入全局事务的管理中</p><h4 id="2-3-3-混合模式"><a href="#2-3-3-混合模式" class="headerlink" title="2.3.3 混合模式"></a>2.3.3 混合模式</h4><p>因为 AT 和 MT 模式的分支从根本上行为模式是一致的，所以可以完全兼容，即，一个全局事务中，可以同时存在 AT 和 MT 的分支。这样就可以达到全面覆盖业务场景的目的：AT 模式可以支持的，使用 AT 模式；AT 模式暂时支持不了的，用 MT 模式来替代。另外，自然的，MT 模式管理的非事务性资源也可以和支持事务的关系型数据库资源一起，纳入同一个分布式事务的管理中。</p><h3 id="2-4-代码实现"><a href="#2-4-代码实现" class="headerlink" title="2.4 代码实现"></a>2.4 代码实现</h3><h4 id="2-4-1-分布式事务公共模块"><a href="#2-4-1-分布式事务公共模块" class="headerlink" title="2.4.1 分布式事务公共模块"></a>2.4.1 分布式事务公共模块</h4><ol><li><p>创建工程 changgou_common_fescar（不是在changgou_common这个工程下创建的，是在changgou_parent下创建的），引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">fescar.version</span>&gt;</span>0.4.2<span class="hljs-tag">&lt;/<span class="hljs-name">fescar.version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.changgou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>changgou_common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.fescar<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fescar-tm<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;fescar.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.fescar<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fescar-spring<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;fescar.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>将<code>fescar配置文件</code>文件夹中的所有配置文件拷贝到resources工程下，如下图：</p><p><img src="/images/image-20210808194328959.png" alt="image-20210808194328959"></p><p>注意file.conf的2个配置。service.vgroup_mapping.my_test_tx_group 映射到相应的 Fescar-Server 集群名称，然后再根据集群名称.grouplist 获取到可用服务列表。</p><p><img src="/images/image-20210808194511402.png" alt="image-20210808194511402"></p></li><li><p>创建FescarRMRequestFilter，给每个线程绑定一个XID （资源提供）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FescarRMRequestFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">OncePerRequestFilter</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger LOGGER = org.slf4j.LoggerFactory.getLogger( FescarRMRequestFilter.class);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 给每次线程请求绑定一个XID</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> filterChain</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;<br>        String currentXID = request.getHeader( FescarAutoConfiguration.FESCAR_XID);<br>        <span class="hljs-keyword">if</span>(!StringUtils.isEmpty(currentXID))&#123;<br>            RootContext.bind(currentXID);<br>            LOGGER.info(<span class="hljs-string">&quot;当前线程绑定的XID :&quot;</span> + currentXID);<br>        &#125;<br>        <span class="hljs-keyword">try</span>&#123;<br>            filterChain.doFilter(request, response);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            String unbindXID = RootContext.unbind();<br>            <span class="hljs-keyword">if</span>(unbindXID != <span class="hljs-keyword">null</span>)&#123;<br>                LOGGER.info(<span class="hljs-string">&quot;当前线程从指定XID中解绑 XID :&quot;</span> + unbindXID);<br>                <span class="hljs-keyword">if</span>(!currentXID.equals(unbindXID))&#123;<br>                    LOGGER.info(<span class="hljs-string">&quot;当前线程的XID发生变更&quot;</span>);<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span>(currentXID != <span class="hljs-keyword">null</span>)&#123;<br>                LOGGER.info(<span class="hljs-string">&quot;当前线程的XID发生变更&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>创建FescarRestInterceptor过滤器，每次请求其他微服务的时候，都将XID携带过去。(Feign拦截器)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FescarRestInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RequestInterceptor</span>, <span class="hljs-title">ClientHttpRequestInterceptor</span> </span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">apply</span><span class="hljs-params">(RequestTemplate requestTemplate)</span> </span>&#123;<br>        String xid = RootContext.getXID();<br>        <span class="hljs-keyword">if</span>(!StringUtils.isEmpty(xid))&#123;<br>            requestTemplate.header( FescarAutoConfiguration.FESCAR_XID, xid);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ClientHttpResponse <span class="hljs-title">intercept</span><span class="hljs-params">(HttpRequest request, <span class="hljs-keyword">byte</span>[] body, ClientHttpRequestExecution execution)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        String xid = RootContext.getXID();<br>        <span class="hljs-keyword">if</span>(!StringUtils.isEmpty(xid))&#123;<br>            HttpHeaders headers = request.getHeaders();<br>            headers.put( FescarAutoConfiguration.FESCAR_XID, Collections.singletonList(xid));<br>        &#125;<br>        <span class="hljs-keyword">return</span> execution.execute(request, body);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>创建FescarAutoConfiguration类 </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FescarAutoConfiguration</span> </span>&#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String FESCAR_XID = <span class="hljs-string">&quot;fescarXID&quot;</span>;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 创建代理数据库</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> environment</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> DataSource <span class="hljs-title">dataSource</span><span class="hljs-params">(Environment environment)</span></span>&#123;<br>        DruidDataSource dataSource = <span class="hljs-keyword">new</span> DruidDataSource();<br>        dataSource.setUrl(environment.getProperty(<span class="hljs-string">&quot;spring.datasource.url&quot;</span>));<br>        <span class="hljs-keyword">try</span> &#123;<br>            dataSource.setDriver(DriverManager.getDriver(environment.getProperty(<span class="hljs-string">&quot;spring.datasource.url&quot;</span>)));<br>        &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;can&#x27;t recognize dataSource Driver&quot;</span>);<br>        &#125;<br>        dataSource.setUsername(environment.getProperty(<span class="hljs-string">&quot;spring.datasource.username&quot;</span>));<br>        dataSource.setPassword(environment.getProperty(<span class="hljs-string">&quot;spring.datasource.password&quot;</span>));<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DataSourceProxy(dataSource);<br>    &#125;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 全局事务扫描器</span><br><span class="hljs-comment">     * 用来解析带有<span class="hljs-doctag">@GlobalTransactional</span>注解的方法，然后采用AOP的机制控制事务</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> environment</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> GlobalTransactionScanner <span class="hljs-title">globalTransactionScanner</span><span class="hljs-params">(Environment environment)</span></span>&#123;<br>        String applicationName = environment.getProperty(<span class="hljs-string">&quot;spring.application.name&quot;</span>);<br>        String groupName = environment.getProperty(<span class="hljs-string">&quot;fescar.group.name&quot;</span>);<br>        <span class="hljs-keyword">if</span>(applicationName == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> GlobalTransactionScanner(groupName == <span class="hljs-keyword">null</span> ? <span class="hljs-string">&quot;my_test_tx_group&quot;</span> : groupName);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> GlobalTransactionScanner(applicationName, groupName == <span class="hljs-keyword">null</span> ? <span class="hljs-string">&quot;my_test_tx_group&quot;</span> : groupName);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 每次微服务和微服务之间相互调用</span><br><span class="hljs-comment">     * 要想控制全局事务，每次TM都会请求TC生成一个XID，每次执行下一个事务，也就是调用其他微服务的时候都需要将该XID传递过去</span><br><span class="hljs-comment">     * 所以我们可以每次请求的时候，都获取头中的XID，并将XID传递到下一个微服务</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> restTemplates</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ConditionalOnBean(&#123;RestTemplate.class&#125;)</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">addFescarInterceptor</span><span class="hljs-params">(Collection&lt;RestTemplate&gt; restTemplates)</span></span>&#123;<br>        restTemplates.stream()<br>                .forEach(restTemplate -&gt; &#123;<br>                    List&lt;ClientHttpRequestInterceptor&gt; interceptors = restTemplate.getInterceptors();<br>                    <span class="hljs-keyword">if</span>(interceptors != <span class="hljs-keyword">null</span>)&#123;<br>                        interceptors.add(fescarRestInterceptor());<br>                    &#125;<br>                &#125;);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Object();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> FescarRMRequestFilter <span class="hljs-title">fescarRMRequestFilter</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> FescarRMRequestFilter();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> FescarRestInterceptor <span class="hljs-title">fescarRestInterceptor</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> FescarRestInterceptor();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="2-4-2-分布式事物的实现"><a href="#2-4-2-分布式事物的实现" class="headerlink" title="2.4.2 分布式事物的实现"></a>2.4.2 分布式事物的实现</h4><ol><li><p>涉及到分布式事务的数据库添加表</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE TABLE `undo_log` (<br>  `id` bigint(20) NOT NULL AUTO_INCREMENT,<br>  `branch_id` bigint(20) NOT NULL,<br>  `xid` varchar(100) NOT NULL,<br>  `rollback_info` longblob NOT NULL,<br>  `log_status` int(11) NOT NULL,<br>  `log_created` datetime NOT NULL,<br>  `log_modified` datetime NOT NULL,<br>  `ext` varchar(100) DEFAULT NULL,<br>  PRIMARY KEY (`id`),<br>  KEY `idx_unionkey` (`xid`,`branch_id`)<br>) ENGINE=InnoDB AUTO_INCREMENT=200 DEFAULT CHARSET=utf8;<br></code></pre></td></tr></table></figure><p>核心在于对业务sql进行解析，转换成undolog, 所以只要支持Fescar分布式事务的微服务数据都需要导入该表结构</p></li><li><p>需要添加分布式事务的微服务（<strong>商品微服务、订单微服务</strong>）添加对 changgou_transaction_fescar的依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--fescar依赖--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.changgou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>changgou_common_fescar<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>在订单微服务的OrderServiceImpl的add方法上增加@GlobalTransactional(name = “order_add”)注解</p><p><code>@GlobalTransactional(name = &quot;order_add&quot;)</code>表明这个全局注解的名称是order_add</p></li><li><p>启动Fescar-server</p><p><img src="/images/image-20210808195409252.png" alt="image-20210808195409252"></p></li><li><p>测试</p><ol><li>功能测试，看功能能否正常执行。</li><li>异常测试，我们在方法中添加<code>int x=1/0</code> ，看库存信息是否能够回滚。</li></ol></li></ol><h2 id="3-基于消息队列实现分布式事务"><a href="#3-基于消息队列实现分布式事务" class="headerlink" title="3. 基于消息队列实现分布式事务"></a>3. 基于消息队列实现分布式事务</h2><p><img src="/images/image-20210808195747681.png" alt="image-20210808195747681"></p><h3 id="3-1-准备工作"><a href="#3-1-准备工作" class="headerlink" title="3.1 准备工作"></a>3.1 准备工作</h3><ol><li><p>changgou_order库新增数据表</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs mysql">DROP TABLE IF EXISTS `tb_task`;<br>CREATE TABLE `tb_task` (<br>  `id` bigint(32) NOT NULL AUTO_INCREMENT COMMENT &#x27;任务id&#x27;,<br>  `create_time` datetime DEFAULT NULL,<br>  `update_time` datetime DEFAULT NULL,<br>  `delete_time` datetime DEFAULT NULL,<br>  `task_type` varchar(32) DEFAULT NULL COMMENT &#x27;任务类型&#x27;,<br>  `mq_exchange` varchar(64) DEFAULT NULL COMMENT &#x27;交换机名称&#x27;,<br>  `mq_routingkey` varchar(64) DEFAULT NULL COMMENT &#x27;routingkey&#x27;,<br>  `request_body` varchar(512) DEFAULT NULL COMMENT &#x27;任务请求的内容&#x27;,<br>  `status` varchar(32) DEFAULT NULL COMMENT &#x27;任务状态&#x27;,<br>  `errormsg` varchar(512) DEFAULT NULL COMMENT &#x27;任务错误信息&#x27;,<br>  PRIMARY KEY (`id`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs mysql">DROP TABLE IF EXISTS `tb_task_his`;<br>CREATE TABLE `tb_task_his` (<br>  `id` bigint(32) NOT NULL AUTO_INCREMENT COMMENT &#x27;任务id&#x27;,<br>  `create_time` datetime DEFAULT NULL,<br>  `update_time` datetime DEFAULT NULL,<br>  `delete_time` datetime DEFAULT NULL,<br>  `task_type` varchar(32) DEFAULT NULL COMMENT &#x27;任务类型&#x27;,<br>  `mq_exchange` varchar(64) DEFAULT NULL COMMENT &#x27;交换机名称&#x27;,<br>  `mq_routingkey` varchar(64) DEFAULT NULL COMMENT &#x27;routingkey&#x27;,<br>  `request_body` varchar(512) DEFAULT NULL COMMENT &#x27;任务请求的内容&#x27;,<br>  `status` varchar(32) DEFAULT NULL COMMENT &#x27;任务状态&#x27;,<br>  `errormsg` varchar(512) DEFAULT NULL,<br>  PRIMARY KEY (`id`)<br>) ENGINE=InnoDB AUTO_INCREMENT=9 DEFAULT CHARSET=utf8;<br></code></pre></td></tr></table></figure></li><li><p>changgou_service_order_api添加相关实体类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Table(name = &quot;tb_task&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Task</span> </span>&#123;<br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-keyword">private</span> Long id;<br><br>    <span class="hljs-meta">@Column(name = &quot;create_time&quot;)</span><br>    <span class="hljs-keyword">private</span> Date createTime;<br><br>    <span class="hljs-meta">@Column(name = &quot;update_time&quot;)</span><br>    <span class="hljs-keyword">private</span> Date updateTime;<br><br>    <span class="hljs-meta">@Column(name = &quot;delete_time&quot;)</span><br>    <span class="hljs-keyword">private</span> Date deleteTime;<br><br>    <span class="hljs-meta">@Column(name = &quot;task_type&quot;)</span><br>    <span class="hljs-keyword">private</span> String taskType;<br><br>    <span class="hljs-meta">@Column(name = &quot;mq_exchange&quot;)</span><br>    <span class="hljs-keyword">private</span> String mqExchange;<br><br>    <span class="hljs-meta">@Column(name = &quot;mq_routingkey&quot;)</span><br>    <span class="hljs-keyword">private</span> String mqRoutingkey;<br><br>    <span class="hljs-meta">@Column(name = &quot;request_body&quot;)</span><br>    <span class="hljs-keyword">private</span> String requestBody;<br><br>    <span class="hljs-meta">@Column(name = &quot;status&quot;)</span><br>    <span class="hljs-keyword">private</span> String status;<br><br>    <span class="hljs-meta">@Column(name = &quot;errormsg&quot;)</span><br>    <span class="hljs-keyword">private</span> String errormsg;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getId</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setId</span><span class="hljs-params">(Long id)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Date <span class="hljs-title">getCreateTime</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> createTime;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCreateTime</span><span class="hljs-params">(Date createTime)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.createTime = createTime;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Date <span class="hljs-title">getUpdateTime</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> updateTime;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUpdateTime</span><span class="hljs-params">(Date updateTime)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.updateTime = updateTime;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Date <span class="hljs-title">getDeleteTime</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> deleteTime;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setDeleteTime</span><span class="hljs-params">(Date deleteTime)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.deleteTime = deleteTime;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getTaskType</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> taskType;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setTaskType</span><span class="hljs-params">(String taskType)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.taskType = taskType;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMqExchange</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> mqExchange;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setMqExchange</span><span class="hljs-params">(String mqExchange)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.mqExchange = mqExchange;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMqRoutingkey</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> mqRoutingkey;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setMqRoutingkey</span><span class="hljs-params">(String mqRoutingkey)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.mqRoutingkey = mqRoutingkey;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getRequestBody</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> requestBody;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setRequestBody</span><span class="hljs-params">(String requestBody)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.requestBody = requestBody;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getStatus</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> status;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setStatus</span><span class="hljs-params">(String status)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.status = status;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getErrormsg</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> errormsg;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setErrormsg</span><span class="hljs-params">(String errormsg)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.errormsg = errormsg;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Table(name = &quot;tb_task_his&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TaskHis</span> </span>&#123;<br><br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-keyword">private</span> Long id;<br><br>    <span class="hljs-meta">@Column(name = &quot;create_time&quot;)</span><br>    <span class="hljs-keyword">private</span> Date createTime;<br><br>    <span class="hljs-meta">@Column(name = &quot;update_time&quot;)</span><br>    <span class="hljs-keyword">private</span> Date updateTime;<br><br>    <span class="hljs-meta">@Column(name = &quot;delete_time&quot;)</span><br>    <span class="hljs-keyword">private</span> Date deleteTime;<br><br>    <span class="hljs-meta">@Column(name = &quot;task_type&quot;)</span><br>    <span class="hljs-keyword">private</span> String taskType;<br><br>    <span class="hljs-meta">@Column(name = &quot;mq_exchange&quot;)</span><br>    <span class="hljs-keyword">private</span> String mqExchange;<br><br>    <span class="hljs-meta">@Column(name = &quot;mq_routingkey&quot;)</span><br>    <span class="hljs-keyword">private</span> String mqRoutingkey;<br><br>    <span class="hljs-meta">@Column(name = &quot;request_body&quot;)</span><br>    <span class="hljs-keyword">private</span> String requestBody;<br><br>    <span class="hljs-meta">@Column(name = &quot;status&quot;)</span><br>    <span class="hljs-keyword">private</span> String status;<br><br>    <span class="hljs-meta">@Column(name = &quot;errormsg&quot;)</span><br>    <span class="hljs-keyword">private</span> String errormsg;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getId</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setId</span><span class="hljs-params">(Long id)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Date <span class="hljs-title">getCreateTime</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> createTime;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCreateTime</span><span class="hljs-params">(Date createTime)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.createTime = createTime;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Date <span class="hljs-title">getUpdateTime</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> updateTime;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUpdateTime</span><span class="hljs-params">(Date updateTime)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.updateTime = updateTime;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Date <span class="hljs-title">getDeleteTime</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> deleteTime;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setDeleteTime</span><span class="hljs-params">(Date deleteTime)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.deleteTime = deleteTime;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getTaskType</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> taskType;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setTaskType</span><span class="hljs-params">(String taskType)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.taskType = taskType;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMqExchange</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> mqExchange;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setMqExchange</span><span class="hljs-params">(String mqExchange)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.mqExchange = mqExchange;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMqRoutingkey</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> mqRoutingkey;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setMqRoutingkey</span><span class="hljs-params">(String mqRoutingkey)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.mqRoutingkey = mqRoutingkey;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getRequestBody</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> requestBody;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setRequestBody</span><span class="hljs-params">(String requestBody)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.requestBody = requestBody;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getStatus</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> status;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setStatus</span><span class="hljs-params">(String status)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.status = status;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getErrormsg</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> errormsg;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setErrormsg</span><span class="hljs-params">(String errormsg)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.errormsg = errormsg;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>changgou_user新增积分日志表</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mysql">DROP TABLE IF EXISTS `tb_point_log`;<br>CREATE TABLE `tb_point_log` (<br>  `order_id` varchar(200) NOT NULL,<br>  `user_id` varchar(200) NOT NULL,<br>  `point` int(11) NOT NULL,<br>  PRIMARY KEY (`order_id`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8;<br></code></pre></td></tr></table></figure></li><li><p>changgou_service_user_api添加实体类 PointLog</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Table(name = &quot;tb_point_log&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PointLog</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> String orderId;<br>    <span class="hljs-keyword">private</span> String userId;<br>    <span class="hljs-keyword">private</span> Integer point;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getOrderId</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> orderId;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setOrderId</span><span class="hljs-params">(String orderId)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.orderId = orderId;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getUserId</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> userId;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUserId</span><span class="hljs-params">(String userId)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.userId = userId;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getPoint</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> point;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setPoint</span><span class="hljs-params">(Integer point)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.point = point;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>changgou_service_order添加rabbitMQ配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RabbitMQConfig</span> </span>&#123;<br><br>    <span class="hljs-comment">//添加积分任务交换机</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String EX_BUYING_ADDPOINTUSER = <span class="hljs-string">&quot;ex_buying_addpointuser&quot;</span>;<br><br>    <span class="hljs-comment">//添加积分消息队列</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String CG_BUYING_ADDPOINT = <span class="hljs-string">&quot;cg_buying_addpoint&quot;</span>;<br><br>    <span class="hljs-comment">//完成添加积分消息队列</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String CG_BUYING_FINISHADDPOINT = <span class="hljs-string">&quot;cg_buying_finishaddpoint&quot;</span>;<br><br>    <span class="hljs-comment">//添加积分路由key</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String CG_BUYING_ADDPOINT_KEY = <span class="hljs-string">&quot;addpoint&quot;</span>;<br><br>    <span class="hljs-comment">//完成添加积分路由key</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String CG_BUYING_FINISHADDPOINT_KEY = <span class="hljs-string">&quot;finishaddpoint&quot;</span>;<br><br>    <span class="hljs-comment">//声明交换机</span><br>    <span class="hljs-meta">@Bean(EX_BUYING_ADDPOINTUSER)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Exchange <span class="hljs-title">EX_BUYING_ADDPOINTUSER</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> ExchangeBuilder.directExchange(EX_BUYING_ADDPOINTUSER).durable(<span class="hljs-keyword">true</span>).build();<br>    &#125;<br><br>    <span class="hljs-comment">//声明队列</span><br>    <span class="hljs-meta">@Bean(CG_BUYING_ADDPOINT)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">CG_BUYING_ADDPOINT</span><span class="hljs-params">()</span></span>&#123;<br>        Queue queue = <span class="hljs-keyword">new</span> Queue(CG_BUYING_ADDPOINT);<br>        <span class="hljs-keyword">return</span> queue;<br>    &#125;<br>    <span class="hljs-meta">@Bean(CG_BUYING_FINISHADDPOINT)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">CG_BUYING_FINISHADDPOINT</span><span class="hljs-params">()</span></span>&#123;<br>        Queue queue = <span class="hljs-keyword">new</span> Queue(CG_BUYING_FINISHADDPOINT);<br>        <span class="hljs-keyword">return</span> queue;<br>    &#125;<br><br>    <span class="hljs-comment">//队列绑定交换机</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">BINDING_CG_BUYING_ADDPOINT</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(CG_BUYING_ADDPOINT)</span> Queue queue,<span class="hljs-meta">@Qualifier(EX_BUYING_ADDPOINTUSER)</span>Exchange exchange)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(CG_BUYING_ADDPOINT_KEY).noargs();<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">BINDING_CG_BUYING_FINISHADDPOINT</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(CG_BUYING_FINISHADDPOINT)</span> Queue queue,<span class="hljs-meta">@Qualifier(EX_BUYING_ADDPOINTUSER)</span>Exchange exchange)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(CG_BUYING_FINISHADDPOINT_KEY).noargs();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h3 id="3-2-订单服务添加任务并发送"><a href="#3-2-订单服务添加任务并发送" class="headerlink" title="3.2 订单服务添加任务并发送"></a>3.2 订单服务添加任务并发送</h3><h4 id="3-2-1-修改添加订单方法"><a href="#3-2-1-修改添加订单方法" class="headerlink" title="3.2.1 修改添加订单方法"></a>3.2.1 修改添加订单方法</h4><p>当添加订单的时候，添加任务表中相关数据, 局部代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//增加任务表记录</span><br>Task task = <span class="hljs-keyword">new</span> Task();<br>task.setCreateTime(<span class="hljs-keyword">new</span> Date());<br>task.setUpdateTime(<span class="hljs-keyword">new</span> Date());<br>task.setMqExchange(RabbitMQConfig.EX_BUYING_ADDPOINTURSE);<br>task.setMqRoutingkey(RabbitMQConfig.CG_BUYING_ADDPOINT_KEY);<br><br>Map map = <span class="hljs-keyword">new</span> HashMap();<br>map.put(<span class="hljs-string">&quot;userName&quot;</span>,order.getUsername());<br>map.put(<span class="hljs-string">&quot;orderId&quot;</span>,order.getId());<br>map.put(<span class="hljs-string">&quot;point&quot;</span>,order.getPayMoney());<br>task.setRequestBody(JSON.toJSONString(map));<br>taskMapper.insertSelective(task);<br></code></pre></td></tr></table></figure><h4 id="3-2-2-定时扫描任务表最新数据"><a href="#3-2-2-定时扫描任务表最新数据" class="headerlink" title="3.2.2 定时扫描任务表最新数据"></a>3.2.2 定时扫描任务表最新数据</h4><p>订单服务新增定时任务类，获取小于系统当前时间的所有任务数据</p><ol><li><p>修改订单服务启动类，添加开启定时任务注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableScheduling</span><br></code></pre></td></tr></table></figure></li><li><p>定义定时任务类</p><p>查询最新数据</p><p>更新taskMapper新增方法，查询所有小于系统当前时间的数据</p><p>注意：</p><ul><li><code>@Results</code>开启表和实体类的映射，column后面跟字段名，property后面跟属性名</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">TaskMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Mapper</span>&lt;<span class="hljs-title">Task</span>&gt; </span>&#123;<br><br>    <span class="hljs-meta">@Select(&quot;SELECT * from tb_task WHERE update_time&lt;#&#123;currentTime&#125;&quot;)</span><br>    <span class="hljs-meta">@Results(&#123;@Result(column = &quot;create_time&quot;,property = &quot;createTime&quot;),</span><br><span class="hljs-meta">            @Result(column = &quot;update_time&quot;,property = &quot;updateTime&quot;),</span><br><span class="hljs-meta">            @Result(column = &quot;delete_time&quot;,property = &quot;deleteTime&quot;),</span><br><span class="hljs-meta">            @Result(column = &quot;task_type&quot;,property = &quot;taskType&quot;),</span><br><span class="hljs-meta">            @Result(column = &quot;mq_exchange&quot;,property = &quot;mqExchange&quot;),</span><br><span class="hljs-meta">            @Result(column = &quot;mq_routingkey&quot;,property = &quot;mqRoutingkey&quot;),</span><br><span class="hljs-meta">            @Result(column = &quot;request_body&quot;,property = &quot;requestBody&quot;),</span><br><span class="hljs-meta">            @Result(column = &quot;status&quot;,property = &quot;status&quot;),</span><br><span class="hljs-meta">            @Result(column = &quot;errormsg&quot;,property = &quot;errormsg&quot;)&#125;)</span><br>    <span class="hljs-function">List&lt;Task&gt; <span class="hljs-title">findTaskLessTanCurrentTime</span><span class="hljs-params">(Date currentTime)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>任务类实现</p><p>注意：</p><ul><li><code>cron = &quot;0 0/2 * * * ?&quot;</code>的语法有时间再去看看，这个表示每两秒检查一次</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QueryPointTask</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> TaskMapper taskMapper;<br><br>    <span class="hljs-meta">@Scheduled(cron = &quot;0 0/2 * * * ?&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">queryTask</span><span class="hljs-params">()</span></span>&#123;<br><br>        <span class="hljs-comment">//1.获取小于系统当前时间数据</span><br>        List&lt;Task&gt; taskList = taskMapper.findTaskLessTanCurrentTime(<span class="hljs-keyword">new</span> Date());<br><br>        <span class="hljs-keyword">if</span> (taskList!=<span class="hljs-keyword">null</span> &amp;&amp; taskList.size()&gt;<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-comment">//将任务数据发送到消息队列</span><br>            <span class="hljs-keyword">for</span> (Task task : taskList) &#123;<br> rabbitTemplate.convertAndSend(RabbitMQConfig.EX_BUYING_ADDPOINTUSER,RabbitMQConfig.CG_BUYING_ADDPOINT_KEY, JSON.toJSONString(task));<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h3 id="3-3-用户服务更改积分"><a href="#3-3-用户服务更改积分" class="headerlink" title="3.3 用户服务更改积分"></a>3.3 用户服务更改积分</h3><ol><li><p>添加rabbitmq配置类(与订单服务相同)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RabbitMQConfig</span> </span>&#123;<br><br>    <span class="hljs-comment">//添加积分任务交换机</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String EX_BUYING_ADDPOINTUSER = <span class="hljs-string">&quot;ex_buying_addpointuser&quot;</span>;<br><br>    <span class="hljs-comment">//添加积分消息队列</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String CG_BUYING_ADDPOINT = <span class="hljs-string">&quot;cg_buying_addpoint&quot;</span>;<br><br>    <span class="hljs-comment">//完成添加积分消息队列</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String CG_BUYING_FINISHADDPOINT = <span class="hljs-string">&quot;cg_buying_finishaddpoint&quot;</span>;<br><br>    <span class="hljs-comment">//添加积分路由key</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String CG_BUYING_ADDPOINT_KEY = <span class="hljs-string">&quot;addpoint&quot;</span>;<br><br>    <span class="hljs-comment">//完成添加积分路由key</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String CG_BUYING_FINISHADDPOINT_KEY = <span class="hljs-string">&quot;finishaddpoint&quot;</span>;<br><br>    <span class="hljs-comment">//声明交换机</span><br>    <span class="hljs-meta">@Bean(EX_BUYING_ADDPOINTUSER)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Exchange <span class="hljs-title">EX_BUYING_ADDPOINTUSER</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> ExchangeBuilder.directExchange(EX_BUYING_ADDPOINTUSER).durable(<span class="hljs-keyword">true</span>).build();<br>    &#125;<br><br>    <span class="hljs-comment">//声明队列</span><br>    <span class="hljs-meta">@Bean(CG_BUYING_ADDPOINT)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">CG_BUYING_ADDPOINT</span><span class="hljs-params">()</span></span>&#123;<br>        Queue queue = <span class="hljs-keyword">new</span> Queue(CG_BUYING_ADDPOINT);<br>        <span class="hljs-keyword">return</span> queue;<br>    &#125;<br>    <span class="hljs-meta">@Bean(CG_BUYING_FINISHADDPOINT)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">CG_BUYING_FINISHADDPOINT</span><span class="hljs-params">()</span></span>&#123;<br>        Queue queue = <span class="hljs-keyword">new</span> Queue(CG_BUYING_FINISHADDPOINT);<br>        <span class="hljs-keyword">return</span> queue;<br>    &#125;<br><br>    <span class="hljs-comment">//队列绑定交换机</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">BINDING_CG_BUYING_ADDPOINT</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(CG_BUYING_ADDPOINT)</span> Queue queue,<span class="hljs-meta">@Qualifier(EX_BUYING_ADDPOINTUSER)</span>Exchange exchange)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(CG_BUYING_ADDPOINT_KEY).noargs();<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">BINDING_CG_BUYING_FINISHADDPOINT</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(CG_BUYING_FINISHADDPOINT)</span> Queue queue,<span class="hljs-meta">@Qualifier(EX_BUYING_ADDPOINTUSER)</span>Exchange exchange)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(CG_BUYING_FINISHADDPOINT_KEY).noargs();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>定义消息监听类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AddPointListener</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-meta">@RabbitListener(queues = RabbitMQConfig.CG_BUYING_ADDPOINT)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiveAddPointMessage</span><span class="hljs-params">(String message)</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;用户服务接收到了任务消息&quot;</span>);<br><br>        <span class="hljs-comment">//转换消息</span><br>        Task task = JSON.parseObject(message, Task.class);<br>        <span class="hljs-keyword">if</span> (task == <span class="hljs-keyword">null</span> || StringUtils.isEmpty(task.getRequestBody()))&#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//判断redis中当前的任务是否存在</span><br>        Object value = redisTemplate.boundValueOps(task.getId()).get();<br>        <span class="hljs-keyword">if</span> (value != <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//更新用户积分</span><br>        <span class="hljs-keyword">int</span> result = userService.updateUserPoint(task);<br>        <span class="hljs-keyword">if</span> (result == <span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//向订单服务返回通知消息</span><br>        rabbitTemplate.convertAndSend(RabbitMQConfig.EX_BUYING_ADDPOINTUSER,RabbitMQConfig.CG_BUYING_FINISHADDPOINT_KEY,JSON.toJSONString(task));<br>        System.out.println(<span class="hljs-string">&quot;用户服务向完成添加积分队列发送了一条消息&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>定义PointLogMapper，实现根据订单id查询</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">PointLogMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Mapper</span>&lt;<span class="hljs-title">PointLog</span>&gt; </span>&#123;<br><br>    <span class="hljs-meta">@Select(&quot;select * from tb_point_log where order_id=#&#123;orderId&#125;&quot;)</span><br>    <span class="hljs-function">PointLog <span class="hljs-title">findLogInfoByOrderId</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;orderId&quot;)</span> String orderId)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>定义修改用户积分实现</p><p>实现思路(操作的是UserServiceImpl实现类)：</p><ol><li>判断当前订单是否操作过</li><li>将任务存入redis</li><li>修改用户积分</li><li>添加积分日志表记录</li><li>删除redis中记录</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> PointLogMapper pointLogMapper;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 修改用户积分</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> task</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">updateUserPoints</span><span class="hljs-params">(Task task)</span> </span>&#123;<br>        Map info = JSON.parseObject(task.getRequestBody(), Map.class);<br>        String userName = info.get(<span class="hljs-string">&quot;userName&quot;</span>).toString();<br>        String orderId = info.get(<span class="hljs-string">&quot;orderId&quot;</span>).toString();<br>        <span class="hljs-keyword">int</span> point = (<span class="hljs-keyword">int</span>) info.get(<span class="hljs-string">&quot;point&quot;</span>);<br><br>        <span class="hljs-comment">//判断当前订单是否操作过</span><br>        PointLog pointLog = pointLogMapper.findLogInfoByOrderId(orderId);<br>        <span class="hljs-keyword">if</span> (pointLog != <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//将任务存入redis</span><br>        redisTemplate.boundValueOps(task.getId()).set(<span class="hljs-string">&quot;exist&quot;</span>,<span class="hljs-number">1</span>,TimeUnit.MINUTES);<br><br>        <span class="hljs-comment">//修改用户积分</span><br>        <span class="hljs-keyword">int</span> result = userMapper.updateUserPoint(userName, point);<br>        <span class="hljs-keyword">if</span> (result&lt;=<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">return</span> result;<br>        &#125;<br><br>        <span class="hljs-comment">//添加积分日志表记录</span><br>        pointLog = <span class="hljs-keyword">new</span> PointLog();<br>        pointLog.setOrderId(orderId);<br>        pointLog.setPoint(point);<br>        pointLog.setUserId(userName);<br>        result = pointLogMapper.insertSelective(pointLog);<br>        <span class="hljs-keyword">if</span> (result&lt;=<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">return</span> result;<br>        &#125;<br><br>        <span class="hljs-comment">//删除redis中的记录</span><br>        redisTemplate.delete(task.getId());<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br></code></pre></td></tr></table></figure></li></ol><h3 id="3-4-订单服务删除原任务"><a href="#3-4-订单服务删除原任务" class="headerlink" title="3.4 订单服务删除原任务"></a>3.4 订单服务删除原任务</h3><h4 id="3-4-1-定义监听类"><a href="#3-4-1-定义监听类" class="headerlink" title="3.4.1 定义监听类"></a>3.4.1 定义监听类</h4><p>在订单服务中定义监听类，用于监听队列，如果队列中有消息，则删除原任务防止消息重复发送，并对任务信息进行记录</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DelTaskListener</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> TaskService taskService;<br><br>    <span class="hljs-meta">@RabbitListener(queues = RabbitMQConfig.CG_BUYING_FINISHADDPOINT)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiveMessage</span><span class="hljs-params">(String message)</span></span>&#123;<br><br>        Task task = JSON.parseObject(message, Task.class);<br><br>        taskService.delTask(task);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-4-2-定义任务service"><a href="#3-4-2-定义任务service" class="headerlink" title="3.4.2 定义任务service"></a>3.4.2 定义任务service</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">TaskService</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">delTask</span><span class="hljs-params">(Task task)</span></span>;<br>&#125;<br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TaskServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">TaskService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> TaskMapper taskMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> TaskHisMapper taskHisMapper;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">delTask</span><span class="hljs-params">(Task task)</span> </span>&#123;<br>        <span class="hljs-comment">//1. 设置删除时间</span><br>        task.setDeleteTime(<span class="hljs-keyword">new</span> Date());<br>        Long id = task.getId();<br>        task.setId(<span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-comment">//bean复制</span><br>        TaskHis taskHis = <span class="hljs-keyword">new</span> TaskHis();<br>        BeanUtils.copyProperties(task,taskHis);<br><br>       <span class="hljs-comment">//记录任务信息</span><br>        taskHisMapper.insertSelective(taskHis);<br><br>        <span class="hljs-comment">//删除原任务</span><br>        task.setId(id);<br>        taskMapper.deleteByPrimaryKey(task);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>畅购商城项目</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>畅购商城项目第四部分</title>
    <link href="/2021/07/29/1.4%20%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86/"/>
    <url>/2021/07/29/1.4%20%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86/</url>
    
    <content type="html"><![CDATA[<h1 id="Part10-购物车"><a href="#Part10-购物车" class="headerlink" title="Part10 购物车"></a>Part10 购物车</h1><h2 id="1-SpringSecurity权限控制"><a href="#1-SpringSecurity权限控制" class="headerlink" title="1. SpringSecurity权限控制"></a>1. SpringSecurity权限控制</h2><p><img src="/images/image-20210807190309378.png" alt="image-20210807190309378"></p><p>用户每次访问微服务的时候，先去oauth2.0服务登录，登录后再访问微服务网关，微服务网关将请求转发给其他微服务处理。</p><p>由于我们项目使用了微服务，任何用户都有可能使用任意微服务，此时我们需要控制相关权限，例如：普通用户角色不能使用用户的删除操作，只有管理员才可以使用,那么这个时候就需要使用到SpringSecurity的权限控制功能了。</p><h3 id="1-1-角色权限加载"><a href="#1-1-角色权限加载" class="headerlink" title="1.1 角色权限加载"></a>1.1 角色权限加载</h3><p>在changgou-user-oauth服务中，com.changgou.oauth.config.UserDetailsServiceImpl该类实现了加载用户相关信息，如下代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">        <span class="hljs-comment">//根据用户名查询用户信息</span><br><span class="hljs-comment">//        String pwd = new BCryptPasswordEncoder().encode(&quot;itheima&quot;);</span><br>        com.changgou.user.pojo.User userInfo = userFeign.findUserInfo(username);<br>        <span class="hljs-comment">//创建User对象</span><br>        String permissions = <span class="hljs-string">&quot;salesman, accountant, user&quot;</span>;<br>        UserJwt userDetails = <span class="hljs-keyword">new</span> UserJwt(username,userInfo.getPassword(),AuthorityUtils.commaSeparatedStringToAuthorityList(permissions));<br>        <span class="hljs-keyword">return</span> userDetails;<br></code></pre></td></tr></table></figure><p>上述代码给登录用户定义了两个个角色，分别为goods_list,seckill_list，这一块我们目前使用的是硬编码方式将角色写死了。</p><p>在这里我们先进行一次登录操作，输入地址：<a href="http://localhost:8001/api/oauth/login">http://localhost:8001/api/oauth/login</a></p><p>登录成功</p><p><img src="/images/image-20210807193630600.png" alt="image-20210807193630600"></p><p>此时我们去redis里面看有没有data部分的jti和相应的token值, 发现是存在的</p><p><img src="/images/image-20210807193740222.png" alt="image-20210807193740222"></p><p>我么可以用之前编写好的解析令牌的测试类来解析令牌里面的内容</p><p>解析类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ParseJwtTest</span> </span>&#123;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">parseJwt</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-comment">//基于公钥去解析jwt</span><br>        String jwt =<span class="hljs-string">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzY29wZSI6WyJhcHAiXSwibmFtZSI6bnVsbCwiaWQiOm51bGwsImV4cCI6MTYyODM3OTE0OCwiYXV0aG9yaXRpZXMiOlsic2Vja2lsbF9saXN0IiwiZ29vZHNfbGlzdCJdLCJqdGkiOiI3YjIwYTBkNS04NzI5LTRkMWMtYTY4YS0xM2IyM2MwYmUyNzMiLCJjbGllbnRfaWQiOiJjaGFuZ2dvdSIsInVzZXJuYW1lIjoiaGVpbWEifQ.XjAafeLs2QrMJH3BkBpqLknmdUe4Tumi7gv3Yxh5Vpt5mj1KizFWnfjYwHZHuLKZkHkNcDRH933D472HK95bFX4Ag_1bDjFrj2X5CzV6-fb7L3ncl_rZxoOAoES2J0GEquQGdx04KqB0uIlUFI-jMQ0wL0Lufz9LIDCF_2F1dXJQvV6sWQVkFQeVvE11_z5_Cn8Z7FMPIwYPmsidSDeE7aPldJpG4cNnY4YDyZQVhVJjdANP02Vx83ysDd5dDpmtNCNcGqVR3c2qBp49bewH0QjUmlfhhm_EbR9C_8NPk7XTlrZEPYzapSU27qIGhNaNHLjqZP9jOkRowHqoi2dUuw&quot;</span>;<br><br>        String publicKey =<span class="hljs-string">&quot;-----BEGIN PUBLIC KEY-----MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAvFsEiaLvij9C1Mz+oyAmt47whAaRkRu/8kePM+X8760UGU0RMwGti6Z9y3LQ0RvK6I0brXmbGB/RsN38PVnhcP8ZfxGUH26kX0RK+tlrxcrG+HkPYOH4XPAL8Q1lu1n9x3tLcIPxq8ZZtuIyKYEmoLKyMsvTviG5flTpDprT25unWgE4md1kthRWXOnfWHATVY7Y/r4obiOL1mS5bEa/iNKotQNnvIAKtjBM4RlIDWMa6dmz+lHtLtqDD2LF1qwoiSIHI75LQZ/CNYaHCfZSxtOydpNKq8eb1/PGiLNolD4La2zf0/1dlcr5mkesV570NxRmU1tFm8Zd3MZlZmyv9QIDAQAB-----END PUBLIC KEY-----&quot;</span>;<br><br>        Jwt token = JwtHelper.decodeAndVerify(jwt, <span class="hljs-keyword">new</span> RsaVerifier(publicKey));<br><br>        String claims = token.getClaims();<br>        System.out.println(claims);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>可以看到里面的三个权限是之前定义好的</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;scope&quot;</span>:[<span class="hljs-string">&quot;app&quot;</span>],<span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-literal">null</span>,<span class="hljs-attr">&quot;id&quot;</span>:<span class="hljs-literal">null</span>,<span class="hljs-attr">&quot;exp&quot;</span>:<span class="hljs-number">1628379737</span>,<span class="hljs-attr">&quot;authorities&quot;</span>:[<span class="hljs-string">&quot;accountant&quot;</span>,<span class="hljs-string">&quot;user&quot;</span>,<span class="hljs-string">&quot;salesman&quot;</span>],<span class="hljs-attr">&quot;jti&quot;</span>:<span class="hljs-string">&quot;2c87dd69-7a16-469a-9033-f7fb158b2317&quot;</span>,<span class="hljs-attr">&quot;client_id&quot;</span>:<span class="hljs-string">&quot;changgou&quot;</span>,<span class="hljs-attr">&quot;username&quot;</span>:<span class="hljs-string">&quot;heima&quot;</span>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-2-角色权限控制"><a href="#1-2-角色权限控制" class="headerlink" title="1.2 角色权限控制"></a>1.2 角色权限控制</h3><p>在每个微服务中，需要获取用户的角色，然后根据角色识别是否允许操作指定的方法，Spring Security中定义了四个支持权限控制的表达式注解，分别是<code>@PreAuthorize</code>、<code>@PostAuthorize</code>、<code>@PreFilter</code>和<code>@PostFilter</code>。其中前两者可以用来在方法调用前或者调用后进行权限检查，后两者可以用来对集合类型的参数或者返回值进行过滤。在需要控制权限的方法上，我们可以添加<code>@PreAuthorize</code>注解，用于方法执行前进行权限检查，校验用户当前角色是否能访问该方法。</p><ol><li><p>开启@PreAuthorize</p><p>在<code>changgou-service-user</code>的<code>ResourceServerConfig</code>类上添加<code>@EnableGlobalMethodSecurity</code>注解，用于开启@PreAuthorize的支持，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableResourceServer</span><br><span class="hljs-meta">@EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)</span><span class="hljs-comment">//激活方法上的PreAuthorize注解</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ResourceServerConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ResourceServerConfigurerAdapter</span> </span>&#123;&#125;<br></code></pre></td></tr></table></figure></li><li><p>方法权限控制</p><p>在<code>changgou-service-user</code>微服务的<code>com.changgou.user.controller.UserController</code>类的delete()方法上添加权限控制注解<code>@PreAuthorize</code>，代码如下：</p><p>注意：</p><ul><li><code>@PreAuthorize(&quot;hasAnyAuthority(&#39;admin&#39;)&quot;)</code>表示只有admin角色才能访问该方法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PreAuthorize(&quot;hasAnyAuthority(&#x27;admin&#x27;)&quot;)</span><br><span class="hljs-meta">@GetMapping</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">findAll</span><span class="hljs-params">()</span></span>&#123;<br>    List&lt;User&gt; userList = userService.findAll();<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>, StatusCode.OK,<span class="hljs-string">&quot;查询成功&quot;</span>,userList) ;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>测试</p><p>我们使用Postman测试，先创建令牌，然后将令牌数存放到头文件中访问微服务网关来调用user微服务的search方法，效果如下：</p><p>提交方式：GET，地址：<a href="http://localhost:8001/api/user">http://localhost:8001/api/user</a> </p><p>发现上面无法访问，因为用户登录的时候，角色不包含admin角色，而findAll方法需要admin角色，所以被拦截了。</p><p>我们再测试其他方法，其他方法没有配置拦截，所以用户登录后就会放行。</p></li></ol><h3 id="1-3-小结"><a href="#1-3-小结" class="headerlink" title="1.3 小结"></a>1.3 小结</h3><p>如果希望一个方法能被多个角色访问，配置:<code>@PreAuthorize(&quot;hasAnyAuthority(&#39;admin&#39;,&#39;user&#39;)&quot;)</code></p><p>如果希望一个类都能被多个角色访问，在类上配置:<code>@PreAuthorize(&quot;hasAnyAuthority(&#39;admin&#39;,&#39;user&#39;)&quot;)</code></p><h2 id="2-购物车"><a href="#2-购物车" class="headerlink" title="2. 购物车"></a>2. 购物车</h2><p>购物车分为用户登录购物车和未登录购物车操作，国内知名电商京东用户登录和不登录都可以操作购物车，如果用户不登录，操作购物车可以将数据存储到Cookie，用户登录后购物车数据可以存储到Redis中，再将之前未登录加入的购物车合并到Redis中即可。</p><p>淘宝天猫则采用了另外一种实现方案，用户要想将商品加入购物车，必须先登录才能操作购物车。</p><p>我们今天实现的购物车是天猫解决方案，即用户必须先登录才能使用购物车功能。</p><h3 id="2-1-购物车业务分析"><a href="#2-1-购物车业务分析" class="headerlink" title="2.1 购物车业务分析"></a>2.1 购物车业务分析</h3><ol><li><p>需求分析</p><p>用户在商品详细页点击加入购物车，提交商品SKU编号和购买数量，添加到购物车。购物车展示页面如下：</p><p><img src="/images/image-20210807195831748.png" alt="image-20210807195831748"></p></li><li><p>购物车实现思路</p><p><img src="/images/image-20210807195957757.png" alt="image-20210807195957757"></p><p>我们实现的是用户登录后的购物车，用户将商品加入购物车的时候，直接将要加入购物车的详情存入到Redis即可。每次查看购物车的时候直接从Redis中获取。</p></li><li><p>表结构分析</p><p>用户登录后将商品加入购物车，需要存储商品详情以及购买数量，购物车详情表如下：</p><p>changgou_order数据中tb_order_item表</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE TABLE `tb_order_item` (<br>  `id` varchar(20) COLLATE utf8_bin NOT NULL COMMENT &#x27;ID&#x27;,<br>  `category_id1` int(11) DEFAULT NULL COMMENT &#x27;1级分类&#x27;,<br>  `category_id2` int(11) DEFAULT NULL COMMENT &#x27;2级分类&#x27;,<br>  `category_id3` int(11) DEFAULT NULL COMMENT &#x27;3级分类&#x27;,<br>  `spu_id` varchar(20) COLLATE utf8_bin DEFAULT NULL COMMENT &#x27;SPU_ID&#x27;,<br>  `sku_id` bigint(20) NOT NULL COMMENT &#x27;SKU_ID&#x27;,<br>  `order_id` bigint(20) NOT NULL COMMENT &#x27;订单ID&#x27;,<br>  `name` varchar(200) COLLATE utf8_bin DEFAULT NULL COMMENT &#x27;商品名称&#x27;,<br>  `price` int(20) DEFAULT NULL COMMENT &#x27;单价&#x27;,<br>  `num` int(10) DEFAULT NULL COMMENT &#x27;数量&#x27;,<br>  `money` int(20) DEFAULT NULL COMMENT &#x27;总金额&#x27;,<br>  `pay_money` int(11) DEFAULT NULL COMMENT &#x27;实付金额&#x27;,<br>  `image` varchar(200) COLLATE utf8_bin DEFAULT NULL COMMENT &#x27;图片地址&#x27;,<br>  `weight` int(11) DEFAULT NULL COMMENT &#x27;重量&#x27;,<br>  `post_fee` int(11) DEFAULT NULL COMMENT &#x27;运费&#x27;,<br>  `is_return` char(1) COLLATE utf8_bin DEFAULT NULL COMMENT &#x27;是否退货&#x27;,<br>  PRIMARY KEY (`id`),<br>  KEY `item_id` (`sku_id`),<br>  KEY `order_id` (`order_id`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;<br></code></pre></td></tr></table></figure></li></ol><h3 id="2-2-添加购物车"><a href="#2-2-添加购物车" class="headerlink" title="2.2 添加购物车"></a>2.2 添加购物车</h3><p><img src="/images/image-20210807200521515.png" alt="image-20210807200521515"></p><h4 id="2-2-1-获取sku数据"><a href="#2-2-1-获取sku数据" class="headerlink" title="2.2.1 获取sku数据"></a>2.2.1 获取sku数据</h4><p>goods服务中定义根据id查询sku对象实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;Sku&gt; <span class="hljs-title">findById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span></span>&#123;<br>    Sku sku = skuService.findById(id);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>,StatusCode.OK,<span class="hljs-string">&quot;查询成功&quot;</span>,sku);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-2-2-定义feign接口"><a href="#2-2-2-定义feign接口" class="headerlink" title="2.2.2 定义feign接口"></a>2.2.2 定义feign接口</h4><p>goods.api工程中定义skuFeign接口,并定义查询方法</p><p>注意：</p><ul><li><code>@FeignClient(name=&quot;goods&quot;)</code>和<code>@FeignClient(value=&quot;goods&quot;)</code>表示的是一个意思：指定服务的提供方为goods(这个就是服务的名字，在他的配置文件里定义了的)</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name=&quot;goods&quot;)</span>  <span class="hljs-comment">//表示goods是服务提供方，必须为客户端指定服务提供方，name和value是一个意思</span><br><span class="hljs-meta">@RequestMapping(&quot;/sku&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SkuFeign</span> </span>&#123;<br>    <br>    <span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;Sku&gt; <span class="hljs-title">findById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span></span>;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-2-3-订单服务添加依赖"><a href="#2-2-3-订单服务添加依赖" class="headerlink" title="2.2.3 订单服务添加依赖"></a>2.2.3 订单服务添加依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.changgou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>changgou_service_goods_api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="2-2-4-订单服务启动类添加feign接口扫描"><a href="#2-2-4-订单服务启动类添加feign接口扫描" class="headerlink" title="2.2.4 订单服务启动类添加feign接口扫描"></a>2.2.4 订单服务启动类添加feign接口扫描</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableFeignClients(basePackages = &quot;com.changgou.goods.feign&quot;)</span><br></code></pre></td></tr></table></figure><h4 id="2-2-5-订单服务添加cartService及其实现类"><a href="#2-2-5-订单服务添加cartService及其实现类" class="headerlink" title="2.2.5 订单服务添加cartService及其实现类"></a>2.2.5 订单服务添加cartService及其实现类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CartService</span> </span>&#123;<br><br>    <span class="hljs-comment">//添加购物车</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">addCart</span><span class="hljs-params">(String skuId, Integer num, String username)</span></span>;<br><br>    <span class="hljs-comment">//查询购物车数据</span><br>    <span class="hljs-function">Map <span class="hljs-title">list</span><span class="hljs-params">(String username)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CartServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CartService</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String CART=<span class="hljs-string">&quot;cart_&quot;</span>;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SkuFeign skuFeign;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SpuFeign spuFeign;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addCart</span><span class="hljs-params">(String skuId, Integer num, String username)</span> </span>&#123;<br>        <span class="hljs-comment">//1.查询redis中相对应的商品信息</span><br>        OrderItem orderItem = (OrderItem) redisTemplate.boundHashOps(CART+username).get(skuId);<br>        <span class="hljs-keyword">if</span> (orderItem != <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-comment">//2.如果当前商品在redis中的存在,则更新商品的数量与价钱</span><br>            orderItem.setNum(orderItem.getNum()+num);<br>            <span class="hljs-keyword">if</span> (orderItem.getNum()&lt;=<span class="hljs-number">0</span>)&#123;<br>                <span class="hljs-comment">//删除该商品</span><br>                redisTemplate.boundHashOps(CART+username).delete(skuId);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            orderItem.setMoney(orderItem.getNum()*orderItem.getPrice());<br>            orderItem.setPayMoney(orderItem.getNum()*orderItem.getPrice());<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//3.如果当前商品在redis中不存在,将商品添加到redis中</span><br>            Sku sku = skuFeign.findById(skuId).getData();<br>            Spu spu = spuFeign.findSpuById(sku.getSpuId()).getData();<br><br>            <span class="hljs-comment">//封装orderItem</span><br>           orderItem = <span class="hljs-keyword">this</span>.sku2OrderItem(sku,spu,num);<br>        &#125;<br><br>        <span class="hljs-comment">//3.将orderitem添加到redis中</span><br>        redisTemplate.boundHashOps(CART+username).put(skuId,orderItem);<br>    &#125;<br><br>    <span class="hljs-comment">//查询购物车列表数据</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Map <span class="hljs-title">list</span><span class="hljs-params">(String username)</span> </span>&#123;<br>        Map map = <span class="hljs-keyword">new</span> HashMap();<br><br>        List&lt;OrderItem&gt; orderItemList = redisTemplate.boundHashOps(CART + username).values();<br>        map.put(<span class="hljs-string">&quot;orderItemList&quot;</span>,orderItemList);<br><br>        <span class="hljs-comment">//商品的总数量与总价格</span><br>        Integer totalNum = <span class="hljs-number">0</span>;<br>        Integer totalMoney = <span class="hljs-number">0</span>;<br><br>        <span class="hljs-keyword">for</span> (OrderItem orderItem : orderItemList) &#123;<br>            totalNum+=orderItem.getNum();<br>            totalMoney+=orderItem.getMoney();<br>        &#125;<br><br>        map.put(<span class="hljs-string">&quot;totalNum&quot;</span>,totalNum);<br>        map.put(<span class="hljs-string">&quot;totalMoney&quot;</span>,totalMoney);<br><br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> OrderItem <span class="hljs-title">sku2OrderItem</span><span class="hljs-params">(Sku sku, Spu spu, Integer num)</span> </span>&#123;<br>        OrderItem orderItem = <span class="hljs-keyword">new</span> OrderItem();<br>        orderItem.setSpuId(sku.getSpuId());<br>        orderItem.setSkuId(sku.getId());<br>        orderItem.setName(sku.getName());<br>        orderItem.setPrice(sku.getPrice());<br>        orderItem.setNum(num);<br>        orderItem.setMoney(orderItem.getPrice()*num);<br>        orderItem.setPayMoney(orderItem.getPrice()*num);<br>        orderItem.setImage(sku.getImage());<br>        orderItem.setWeight(sku.getWeight()*num);<br>        <span class="hljs-comment">//分类信息</span><br>        orderItem.setCategoryId1(spu.getCategory1Id());<br>        orderItem.setCategoryId2(spu.getCategory2Id());<br>        orderItem.setCategoryId3(spu.getCategory3Id());<br>        <span class="hljs-keyword">return</span> orderItem;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-2-6-订单服务新建CartController"><a href="#2-2-6-订单服务新建CartController" class="headerlink" title="2.2.6 订单服务新建CartController"></a>2.2.6 订单服务新建CartController</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/cart&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CartController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CartService cartService;<br><br>    <span class="hljs-comment">/*@Autowired</span><br><span class="hljs-comment">    private TokenDecode tokenDecode;*/</span><br><br>    <span class="hljs-meta">@GetMapping(&quot;/addCart&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">addCart</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;skuId&quot;)</span> String skuId, <span class="hljs-meta">@RequestParam(&quot;num&quot;)</span> Integer num)</span></span>&#123;<br><br>        <span class="hljs-comment">//动态获取当前人信息,暂时静态</span><br>        String username = <span class="hljs-string">&quot;itcast&quot;</span>;<br><span class="hljs-comment">//        String username = tokenDecode.getUserInfo().get(&quot;username&quot;);</span><br>        cartService.addCart(skuId,num,username);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>, StatusCode.OK,<span class="hljs-string">&quot;加入购物车成功&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/list&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Map <span class="hljs-title">list</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-comment">//动态获取当前人信息,暂时静态</span><br>        String username = <span class="hljs-string">&quot;itcast&quot;</span>;<br><span class="hljs-comment">//        String username = tokenDecode.getUserInfo().get(&quot;username&quot;);</span><br>        Map map = cartService.list(username);<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>最后测试添加购物车，请求地址：localhost:9002/cart/addCart?skuId=100000003145&amp;num=1</p><p>效果如下：</p><p><img src="/images/image-20210807205116509.png" alt="image-20210807205116509"></p><p>可以发现redis缓存中已经有商品了</p><p><img src="/images/image-20210807205216459.png" alt="image-20210807205216459"></p><h3 id="2-3-购物车列表"><a href="#2-3-购物车列表" class="headerlink" title="2.3 购物车列表"></a>2.3 购物车列表</h3><h4 id="2-3-1-思路分析"><a href="#2-3-1-思路分析" class="headerlink" title="2.3.1 思路分析"></a>2.3.1 思路分析</h4><p><img src="/images/image-20210807205435727.png" alt="image-20210807205435727"></p><p>接着我们实现一次购物车列表操作。因为存的时候是根据用户名往Redis中存储用户的购物车数据的，所以我们这里可以将用户的名字作为key去Redis中查询对应的数据。##</p><h4 id="2-3-2-代码实现"><a href="#2-3-2-代码实现" class="headerlink" title="2.3.2 代码实现"></a>2.3.2 代码实现</h4><ol><li><p>业务层</p><p>com.changgou.order.service.CartService接口，添加购物车列表方法，代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//查询购物车数据</span><br><span class="hljs-function">Map <span class="hljs-title">list</span><span class="hljs-params">(String username)</span></span>;<br></code></pre></td></tr></table></figure></li><li><p>业务层接口实现类</p><p>com.changgou.order.service.impl.CartServiceImpl类，添加购物车列表实现方法，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//查询购物车列表数据</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Map <span class="hljs-title">list</span><span class="hljs-params">(String username)</span> </span>&#123;<br>    Map map = <span class="hljs-keyword">new</span> HashMap();<br>   <br>    List&lt;OrderItem&gt; orderItemList = redisTemplate.boundHashOps(CART + username).values();<br>    map.put(<span class="hljs-string">&quot;orderItemList&quot;</span>,orderItemList);<br>   <br>    <span class="hljs-comment">//商品的总数量与总价格</span><br>    Integer totalNum = <span class="hljs-number">0</span>;<br>    Integer totalMoney = <span class="hljs-number">0</span>;<br>   <br>    <span class="hljs-keyword">for</span> (OrderItem orderItem : orderItemList) &#123;<br>        totalNum+=orderItem.getNum();<br>        totalMoney+=orderItem.getMoney();<br>    &#125;<br>   <br>    map.put(<span class="hljs-string">&quot;totalNum&quot;</span>,totalNum);<br>    map.put(<span class="hljs-string">&quot;totalMoney&quot;</span>,totalMoney);<br>   <br>    <span class="hljs-keyword">return</span> map;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>控制层</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 查询用户购物车列表</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(value = &quot;/list&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Map <span class="hljs-title">list</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-comment">//暂时静态，后续修改</span><br>    String username = <span class="hljs-string">&quot;itcast&quot;</span>;<br>    <span class="hljs-keyword">return</span> cartService.list(username);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>测试</p><p>使用Postman访问 GET <a href="http://localhost:9002/cart/list">http://localhost:9002/cart/list</a></p><p>效果如下</p><p><img src="/images/image-20210807210847527.png" alt="image-20210807210847527"></p></li></ol><h2 id="3-购物车渲染"><a href="#3-购物车渲染" class="headerlink" title="3. 购物车渲染"></a>3. 购物车渲染</h2><h3 id="3-1-购物车渲染服务搭建"><a href="#3-1-购物车渲染服务搭建" class="headerlink" title="3.1 购物车渲染服务搭建"></a>3.1 购物车渲染服务搭建</h3><p>在changgou_web中搭建订单购物车微服务工程<code>changgou_web_order</code>，该工程主要实现购物车和订单的渲染操作。</p><ol><li><p>导入pom文件依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.changgou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>changgou_service_order_api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.changgou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>changgou_common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>application.yml配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9011</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">order-web</span><br>  <span class="hljs-attr">main:</span><br>    <span class="hljs-attr">allow-bean-definition-overriding:</span> <span class="hljs-literal">true</span>   <span class="hljs-comment">#当遇到同样名字的时候，是否允许覆盖注册</span><br>  <span class="hljs-attr">thymeleaf:</span><br>    <span class="hljs-attr">cache:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:6868/eureka</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">hystrix:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">default:</span>   <span class="hljs-comment">#配置全局的feign的调用超时时间  如果 有指定的服务配置 默认的配置不会生效</span><br>        <span class="hljs-attr">connectTimeout:</span> <span class="hljs-number">60000</span> <span class="hljs-comment"># 指定的是 消费者 连接服务提供者的连接超时时间 是否能连接  单位是毫秒</span><br>        <span class="hljs-attr">readTimeout:</span> <span class="hljs-number">80000</span>  <span class="hljs-comment"># 指定的是调用服务提供者的 服务 的超时时间（）  单位是毫秒</span><br><span class="hljs-comment">#hystrix 配置</span><br><span class="hljs-attr">hystrix:</span><br>  <span class="hljs-attr">command:</span><br>    <span class="hljs-attr">default:</span><br>      <span class="hljs-attr">execution:</span><br>        <span class="hljs-attr">timeout:</span><br>          <span class="hljs-comment">#如果enabled设置为false，则请求超时交给ribbon控制</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">isolation:</span><br>          <span class="hljs-attr">strategy:</span> <span class="hljs-string">SEMAPHORE</span><br>          <span class="hljs-attr">thread:</span><br>            <span class="hljs-comment"># 熔断器超时时间，默认：1000/毫秒</span><br>            <span class="hljs-attr">timeoutInMilliseconds:</span> <span class="hljs-number">80000</span><br><span class="hljs-comment">#请求处理的超时时间</span><br><span class="hljs-attr">ribbon:</span><br>  <span class="hljs-attr">ReadTimeout:</span> <span class="hljs-number">4000</span><br>  <span class="hljs-comment">#请求连接的超时时间</span><br>  <span class="hljs-attr">ConnectTimeout:</span> <span class="hljs-number">3000</span><br></code></pre></td></tr></table></figure></li><li><p>创建启动类</p><p>创建com.changgou.OrderWebApplication启动类，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableEurekaClient</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderWebApplication</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(OrderWebApplication.class,args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>静态资源拷贝</p><p>资源\成品页面\cart.html页面拷贝到工程中，如下图：</p><p><img src="/images/image-20210807225516860.png" alt="image-20210807225516860"></p></li></ol><h3 id="3-2-购物车列表渲染"><a href="#3-2-购物车列表渲染" class="headerlink" title="3.2 购物车列表渲染"></a>3.2 购物车列表渲染</h3><ol><li><p>Feign创建</p><p>在changgou_service_order_api中添加CartFeign接口，并在接口中创建添加购物车和查询购物车列表，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name = &quot;order&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CartFeign</span> </span>&#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/cart/addCart&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">addCart</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;skuId&quot;)</span> String skuId, <span class="hljs-meta">@RequestParam(&quot;num&quot;)</span> Integer num)</span></span>;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/cart/list&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Map <span class="hljs-title">list</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>后台代码</p><p>在changgou_web_order中创建com.changgou.order.controller.CartController,并添加查询购物车集合方法和添加购物车方法，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/wcart&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CartController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CartFeign cartFeign;<br><br>    <span class="hljs-comment">//查询</span><br>    <span class="hljs-meta">@GetMapping(&quot;/list&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">list</span><span class="hljs-params">(Model model)</span></span>&#123;<br>        Map map = cartFeign.list();<br>        model.addAttribute(<span class="hljs-string">&quot;items&quot;</span>,map);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;cart&quot;</span>;<br>    &#125;<br><br><br>    <span class="hljs-comment">//添加</span><br>    <span class="hljs-meta">@GetMapping(&quot;/add&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;Map&gt; <span class="hljs-title">add</span><span class="hljs-params">(String id,Integer num)</span></span>&#123;<br>        cartFeign.addCart(id,num);<br>        Map map = cartFeign.list();<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result&lt;&gt;(<span class="hljs-keyword">true</span>, StatusCode.OK,<span class="hljs-string">&quot;添加购物车成功&quot;</span>,map);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>前端页面</p><ul><li>加载列表数据</li><li>购物车渲染服务</li></ul><p>这里暂时不细学，后面系统学期前端再深入</p></li><li><p>订单服务对接网关</p><p>修改微服务网关<code>changgou-gateway-web</code>的application.yml配置文件，添加order的路由过滤配置，配置如下：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yml">  <span class="hljs-comment">#认证微服务</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">changgou_oauth_user</span><br>  <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://user-auth</span><br>  <span class="hljs-attr">predicates:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/oauth/**</span><br>  <span class="hljs-attr">filters:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">changgou_order_route</span><br>  <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://order</span><br>  <span class="hljs-attr">predicates:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/cart/**,/api/categoryReport/**,/api/orderConfig/**,/api/order/**,/api/orderItem/**,/api/orderLog/**,/api/preferential/**,/api/returnCause/**,/api/returnOrder/**,/api/returnOrderItem/**</span><br>  <span class="hljs-attr">filters:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br>  <span class="hljs-comment">#购物车订单渲染微服务</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">changgou_order_web_route</span><br>  <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://order-web</span><br>  <span class="hljs-attr">predicates:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/wcart/**,/api/worder/**</span><br>  <span class="hljs-attr">filters:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br></code></pre></td></tr></table></figure></li><li><p>测试</p><p>由于开启了网关，要先登录才能访问</p><p>登录路径：<a href="http://192.168.114.1:8001/api/oauth/toLogin">http://192.168.114.1:8001/api/oauth/toLogin</a></p><p>访问购物车路径（我的登录界面的权限好像存在问题，登录没上，显示未授权）：<a href="http://localhost:8001/api/wcart/list">http://localhost:8001/api/wcart/list</a></p></li></ol><h3 id="3-3-商品数量变更"><a href="#3-3-商品数量变更" class="headerlink" title="3.3 商品数量变更"></a>3.3 商品数量变更</h3><p>用户可以点击+号或者-号，或者手动输入一个数字，然后更新购物车列表，我们可以给-+号一个点击事件，给数字框一个失去焦点事件，然后调用后台，实现购物车的更新。</p><p>请求后台方法：</p><p>在js里面创建一个请求后台的方法，代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;script th:inline=<span class="hljs-string">&quot;javascript&quot;</span>&gt;<br><span class="hljs-keyword">var</span> app = <span class="hljs-keyword">new</span> Vue(&#123;<br><span class="hljs-attr">el</span>:<span class="hljs-string">&quot;#app&quot;</span>,<br><span class="hljs-attr">data</span>:&#123;<br><span class="hljs-attr">items</span>:[[$&#123;items&#125;]]<br>&#125;,<br><span class="hljs-attr">methods</span>:&#123;<br><span class="hljs-attr">add</span>:<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">skuId,num</span>) </span>&#123;<br>axios.get(<span class="hljs-string">&quot;/api/wcart/add?id=&quot;</span>+skuId+<span class="hljs-string">&quot;&amp;num=&quot;</span>+num).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) </span>&#123;<br><span class="hljs-keyword">if</span> (response.data.flag)&#123;<br>app.items=response.data.data;<br>&#125;<br>&#125;)<br>&#125;<br>&#125;<br>&#125;)<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><p>添加事件：</p><p>在+-号和数字框那里添加点击事件和失去焦点事件，然后调用上面的add方法，代码如下：</p><p><img src="/images/image-20210807223449940.png" alt="image-20210807223449940"></p><h3 id="3-4-删除商品购物车"><a href="#3-4-删除商品购物车" class="headerlink" title="3.4 删除商品购物车"></a>3.4 删除商品购物车</h3><p>我们发现个问题，就是用户将商品加入购物车，无论数量是正负，都会执行添加购物车，如果数量如果&lt;=0，应该移除该商品的。</p><p>修改changgou-service-order的com.changgou.order.service.impl.CartServiceImpl的add方法，添加如下代码：</p><p><img src="/images/image-20210807223724709.png" alt="image-20210807223724709"></p><h3 id="3-5-订单服务对接oauth"><a href="#3-5-订单服务对接oauth" class="headerlink" title="3.5 订单服务对接oauth"></a>3.5 订单服务对接oauth</h3><p>在订单微服务里进行的</p><ol><li><p>配置公钥</p></li><li><p>在pom文件中导入oauth依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>添加配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableResourceServer</span><br><span class="hljs-comment">//开启方法上的PreAuthorize注解</span><br><span class="hljs-meta">@EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ResourceServerConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ResourceServerConfigurerAdapter</span> </span>&#123;<br><br>    <span class="hljs-comment">//公钥</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PUBLIC_KEY = <span class="hljs-string">&quot;public.key&quot;</span>;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 定义JwtTokenStore</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> jwtAccessTokenConverter</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> TokenStore <span class="hljs-title">tokenStore</span><span class="hljs-params">(JwtAccessTokenConverter jwtAccessTokenConverter)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> JwtTokenStore(jwtAccessTokenConverter);<br>    &#125;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 定义JJwtAccessTokenConverter</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> JwtAccessTokenConverter <span class="hljs-title">jwtAccessTokenConverter</span><span class="hljs-params">()</span> </span>&#123;<br>        JwtAccessTokenConverter converter = <span class="hljs-keyword">new</span> JwtAccessTokenConverter();<br>        converter.setVerifierKey(getPubKey());<br>        <span class="hljs-keyword">return</span> converter;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取非对称加密公钥 Key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 公钥 Key</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getPubKey</span><span class="hljs-params">()</span> </span>&#123;<br>        Resource resource = <span class="hljs-keyword">new</span> ClassPathResource(PUBLIC_KEY);<br>        <span class="hljs-keyword">try</span> &#123;<br>            InputStreamReader inputStreamReader = <span class="hljs-keyword">new</span> InputStreamReader(resource.getInputStream());<br>            BufferedReader br = <span class="hljs-keyword">new</span> BufferedReader(inputStreamReader);<br>            <span class="hljs-keyword">return</span> br.lines().collect(Collectors.joining(<span class="hljs-string">&quot;\n&quot;</span>));<br>        &#125; <span class="hljs-keyword">catch</span> (IOException ioe) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * Http安全配置，对每个到达系统的http请求链接进行校验</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> http</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-comment">//所有请求必须认证通过</span><br>        http.authorizeRequests()<br>                .anyRequest().<br>                authenticated();    <span class="hljs-comment">//其他地址需要认证授权</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h3 id="3-6-微服务间认证"><a href="#3-6-微服务间认证" class="headerlink" title="3.6 微服务间认证"></a>3.6 微服务间认证</h3><p><img src="/images/image-20210807224437427.png" alt="image-20210807224437427"></p><p>如上图：因为微服务之间并没有传递头文件，所以我们可以定义一个拦截器，每次微服务调用之前都先检查下头文件，将请求的头文件中的令牌数据再放入到header中，再调用其他微服务即可。</p><p><strong>feign拦截器实现微服务间认证</strong></p><ol><li><p>创建拦截器</p><p>在changgou_common服务中创建一个com.changgou.interceptor.FeignInterceptor拦截器，并将所有头文件数据再次加入到Feign请求的微服务头文件中，代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FeignInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RequestInterceptor</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">apply</span><span class="hljs-params">(RequestTemplate requestTemplate)</span> </span>&#123;<br>        <span class="hljs-comment">//传递令牌</span><br>        RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes();<br>        <span class="hljs-keyword">if</span> (requestAttributes != <span class="hljs-keyword">null</span>)&#123;<br>            HttpServletRequest request = ((ServletRequestAttributes) requestAttributes).getRequest();<br>            <span class="hljs-keyword">if</span> (request != <span class="hljs-keyword">null</span>)&#123;<br>                Enumeration&lt;String&gt; headerNames = request.getHeaderNames();<br>                <span class="hljs-keyword">while</span> (headerNames.hasMoreElements())&#123;<br>                    String headerName = headerNames.nextElement();<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;authorization&quot;</span>.equals(headerName))&#123;<br>                        String headerValue = request.getHeader(headerName); <span class="hljs-comment">// Bearer jwt</span><br><br>                        <span class="hljs-comment">//传递令牌</span><br>                        requestTemplate.header(headerName,headerValue);<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>更改changgou_order_web启动类，添加拦截器声明</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> FeignInterceptor <span class="hljs-title">feignInterceptor</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> FeignInterceptor();<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h3 id="3-7-动态获取当前登录人"><a href="#3-7-动态获取当前登录人" class="headerlink" title="3.7 动态获取当前登录人"></a>3.7 动态获取当前登录人</h3><h4 id="3-7-1-数据分析"><a href="#3-7-1-数据分析" class="headerlink" title="3.7.1 数据分析"></a>3.7.1 数据分析</h4><p>用户登录后，数据会封装到<code>SecurityContextHolder.getContext().getAuthentication()</code>里面，我们可以将数据从这里面取出，然后转换成<code>OAuth2AuthenticationDetails</code>,在这里面可以获取到令牌信息、令牌类型等，代码如下（这里的代码不是自己编写的）：</p><p><img src="/images/image-20210807230417232.png" alt="image-20210807230417232"></p><p>这里的tokenValue是加密之后的令牌数据，remoteAddress是用户的IP信息，tokenType是令牌类型。</p><p>我们可以获取令牌加密数据后，使用公钥对它进行解密，如果能解密说明数据无误，如果不能解密用户也没法执行到这一步。解密后可以从明文中获取用户信息。</p><h4 id="3-7-2-代码实现"><a href="#3-7-2-代码实现" class="headerlink" title="3.7.2 代码实现"></a>3.7.2 代码实现</h4><p>因为该类在很多微服务中都会被使用到，所以需要将该类添加到common工程中</p><ol><li><p>在changgou-common工程中引入鉴权包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--鉴权--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>添加资源中的TokenDecode工具类到changgou-service-order微服务config包下，用于解密令牌信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TokenDecode</span> </span>&#123;<br>    <span class="hljs-comment">//公钥</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PUBLIC_KEY = <span class="hljs-string">&quot;public.key&quot;</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String publickey=<span class="hljs-string">&quot;&quot;</span>;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 获取用户信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String,String&gt; <span class="hljs-title">getUserInfo</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-comment">//获取授权信息</span><br>        OAuth2AuthenticationDetails details = (OAuth2AuthenticationDetails) SecurityContextHolder.getContext().getAuthentication().getDetails();<br>        <span class="hljs-comment">//令牌解码</span><br>        <span class="hljs-keyword">return</span> dcodeToken(details.getTokenValue());<br>    &#125;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 读取令牌数据</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;String,String&gt; <span class="hljs-title">dcodeToken</span><span class="hljs-params">(String token)</span></span>&#123;<br>        <span class="hljs-comment">//校验Jwt</span><br>        Jwt jwt = JwtHelper.decodeAndVerify(token, <span class="hljs-keyword">new</span> RsaVerifier(getPubKey()));<br><br>        <span class="hljs-comment">//获取Jwt原始内容</span><br>        String claims = jwt.getClaims();<br>        <span class="hljs-keyword">return</span> JSON.parseObject(claims,Map.class);<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取非对称加密公钥 Key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 公钥 Key</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getPubKey</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">if</span>(!StringUtils.isEmpty(publickey))&#123;<br>            <span class="hljs-keyword">return</span> publickey;<br>        &#125;<br>        Resource resource = <span class="hljs-keyword">new</span> ClassPathResource(PUBLIC_KEY);<br>        <span class="hljs-keyword">try</span> &#123;<br>            InputStreamReader inputStreamReader = <span class="hljs-keyword">new</span> InputStreamReader(resource.getInputStream());<br>            BufferedReader br = <span class="hljs-keyword">new</span> BufferedReader(inputStreamReader);<br>            publickey = br.lines().collect(Collectors.joining(<span class="hljs-string">&quot;\n&quot;</span>));<br>            <span class="hljs-keyword">return</span> publickey;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException ioe) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>将该工具类以bean的形式声明到order服务中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableEurekaClient</span><br><span class="hljs-meta">@EnableFeignClients(basePackages = &quot;com.changgou.goods.feign&quot;)</span><br><span class="hljs-meta">@MapperScan(basePackages = &#123;&quot;com.changgou.order.dao&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderApplication</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run( OrderApplication.class);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> TokenDecode <span class="hljs-title">tokenDecode</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> TokenDecode();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>控制层获取用户数据</p><p>在CartController中注入TokenDecode，并调用TokenDecode的getUserInfo方法获取用户信息，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/cart&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CartController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CartService cartService;<br><br>    <span class="hljs-comment">//===================</span><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> TokenDecode tokenDecode;<br>    <span class="hljs-comment">//===================</span><br><br>    <span class="hljs-meta">@GetMapping(&quot;/addCart&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">addCart</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;skuId&quot;)</span> String skuId, <span class="hljs-meta">@RequestParam(&quot;num&quot;)</span> Integer num)</span></span>&#123;<br><br>        <span class="hljs-comment">//===================</span><br>        <span class="hljs-comment">//动态获取当前人信息,暂时静态</span><br>        <span class="hljs-comment">//String username = &quot;itcast&quot;;</span><br>        String username = tokenDecode.getUserInfo().get(<span class="hljs-string">&quot;username&quot;</span>);<br>        <span class="hljs-comment">//===================</span><br>        <br>        cartService.addCart(skuId,num,username);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>, StatusCode.OK,<span class="hljs-string">&quot;加入购物车成功&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 查询用户购物车列表</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(value = &quot;/list&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Map <span class="hljs-title">list</span><span class="hljs-params">()</span></span>&#123;<br>        <br>        <span class="hljs-comment">//===================</span><br>        <span class="hljs-comment">//暂时静态，后续修改</span><br><span class="hljs-comment">//        String username = &quot;itcast&quot;;</span><br>        String username = tokenDecode.getUserInfo().get(<span class="hljs-string">&quot;username&quot;</span>);<br>        <span class="hljs-comment">//===================</span><br>        <br>        <span class="hljs-keyword">return</span> cartService.list(username);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h3 id="3-8-页面跳转"><a href="#3-8-页面跳转" class="headerlink" title="3.8 页面跳转"></a>3.8 页面跳转</h3><h4 id="3-9-1-未登录时登录跳转"><a href="#3-9-1-未登录时登录跳转" class="headerlink" title="3.9.1 未登录时登录跳转"></a>3.9.1 未登录时登录跳转</h4><p>在用户没有登录的情况下，直接访问购物车页面会报401(未授权错误)。</p><p>我们可以发现，返回的只是个错误状态码，这个毫无意义，我们应该重定向到登录页面，让用户登录，我们可以修改网关的头文件，让用户每次没登录的时候，都跳转到登录页面。</p><p>修改changgou-gateway-web的<code>com.changgou.filter.AuthorizeFilter</code>，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">GlobalFilter</span>, <span class="hljs-title">Ordered</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String LOGIN_URL=<span class="hljs-string">&quot;http://localhost:8001/api/oauth/toLogin&quot;</span>;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> AuthService authService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;<br>        ServerHttpRequest request = exchange.getRequest();<br>        ServerHttpResponse response = exchange.getResponse();<br><br>        <span class="hljs-comment">//1.判断当前请求路径是否为登录请求,如果是,则直接放行</span><br>        String path = request.getURI().getPath();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;/api/oauth/login&quot;</span>.equals(path) || !UrlFilter.hasAuthorize(path))&#123;<br>            <span class="hljs-comment">//直接放行</span><br>            <span class="hljs-keyword">return</span> chain.filter(exchange);<br>        &#125;<br><br>        <span class="hljs-comment">//2.从cookie中获取jti的值,如果该值不存在,拒绝本次访问</span><br>        String jti = authService.getJtiFromCookie(request);<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(jti))&#123;<br>            <span class="hljs-comment">//拒绝访问</span><br>            <span class="hljs-comment">/*response.setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="hljs-comment">            return response.setComplete();*/</span><br>            <span class="hljs-comment">//跳转登录页面</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.toLoginPage(LOGIN_URL+<span class="hljs-string">&quot;?FROM=&quot;</span>+request.getURI().getPath(),exchange);<br>        &#125;<br><br>        <span class="hljs-comment">//3.从redis中获取jwt的值,如果该值不存在,拒绝本次访问</span><br>        String jwt = authService.getJwtFromRedis(jti);<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(jwt))&#123;<br>            <span class="hljs-comment">//拒绝访问</span><br>            <span class="hljs-comment">/*response.setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="hljs-comment">            return response.setComplete();*/</span><br>            <span class="hljs-keyword">return</span>  <span class="hljs-keyword">this</span>.toLoginPage(LOGIN_URL,exchange);<br>        &#125;<br><br>        <span class="hljs-comment">//4.对当前的请求对象进行增强,让它会携带令牌的信息</span><br>        request.mutate().header(<span class="hljs-string">&quot;Authorization&quot;</span>,<span class="hljs-string">&quot;Bearer &quot;</span>+jwt);<br>        <span class="hljs-keyword">return</span> chain.filter(exchange);<br>    &#125;<br><br>    <span class="hljs-comment">//跳转登录页面</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> Mono&lt;Void&gt; <span class="hljs-title">toLoginPage</span><span class="hljs-params">(String loginUrl, ServerWebExchange exchange)</span> </span>&#123;<br>        ServerHttpResponse response = exchange.getResponse();<br>        response.setStatusCode(HttpStatus.SEE_OTHER);<br>        response.getHeaders().set(<span class="hljs-string">&quot;Location&quot;</span>,loginUrl);<br>        <span class="hljs-keyword">return</span> response.setComplete();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getOrder</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>此时再测试，就可以跳转到登录页面了。</p><p>访问：<a href="http://localhost:8001/api/wcart/list">http://localhost:8001/api/wcart/list</a></p><h4 id="3-8-2-登录成功跳转原地址"><a href="#3-8-2-登录成功跳转原地址" class="headerlink" title="3.8.2 登录成功跳转原地址"></a>3.8.2 登录成功跳转原地址</h4><p>刚才已经实现了未登录时跳转登录页，但是当登录成功后，并没有跳转到用户本来要访问的页面。(这个功能在3.8.1已经实现了，这里熟悉下流程)</p><p>要实现这个功能的话，可以将用户要访问的页面作为参数传递到登录控制器，由登录控制器根据参数完成路径跳转.</p><ol><li><p>修改网关携带当前访问URI</p><p>修改changgou-gateway-web的<code>com.changgou.filter.AuthorizeFilter</code>，在之前的URL后面添加FROM参数以及FROM参数的值为<code>request.getURI()</code>，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//2.从cookie中获取jti的值,如果该值不存在,拒绝本次访问</span><br>String jti = authService.getJtiFromCookie(request);<br><span class="hljs-keyword">if</span> (StringUtils.isEmpty(jti))&#123;<br>    <span class="hljs-comment">//拒绝访问</span><br>    <span class="hljs-comment">/*response.setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="hljs-comment">    return response.setComplete();*/</span><br>    <span class="hljs-comment">//跳转登录页面</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.toLoginPage(LOGIN_URL+<span class="hljs-string">&quot;?FROM=&quot;</span>+request.getURI().getPath(),exchange);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>登录控制器获取参数</p><p>修改changgou-user-oauth的<code>com.changgou.oauth.controller.LoginRedirect</code>记录访问来源页，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/toLogin&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toLogin</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = &quot;FROM&quot;,required = false,defaultValue = &quot;&quot;)</span> String from, Model model)</span></span>&#123;<br>    model.addAttribute(<span class="hljs-string">&quot;from&quot;</span>,from);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;login&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>修改页面，获取来源页信息，并存到from变量中，登录成功后跳转到该地址</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;script th:inline=<span class="hljs-string">&quot;javascript&quot;</span>&gt;<br><span class="hljs-keyword">var</span> app = <span class="hljs-keyword">new</span> Vue(&#123;<br><span class="hljs-attr">el</span>:<span class="hljs-string">&quot;#app&quot;</span>,<br><span class="hljs-attr">data</span>:&#123;<br><span class="hljs-attr">username</span>:<span class="hljs-string">&quot;&quot;</span>,<br><span class="hljs-attr">password</span>:<span class="hljs-string">&quot;&quot;</span>,<br><span class="hljs-attr">msg</span>:<span class="hljs-string">&quot;&quot;</span><br>&#125;,<br><span class="hljs-attr">methods</span>:&#123;<br><span class="hljs-attr">login</span>:<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>app.msg=<span class="hljs-string">&quot;正在登录&quot;</span>;<br>axios.post(<span class="hljs-string">&quot;/api/oauth/login?username=&quot;</span>+app.username+<span class="hljs-string">&quot;&amp;password=&quot;</span>+app.password).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) </span>&#123;<br><span class="hljs-keyword">if</span> (response.data.flag)&#123;<br>app.msg=<span class="hljs-string">&quot;登录成功&quot;</span>;<br>location.href-app.from<br>&#125; <span class="hljs-keyword">else</span>&#123;<br>app.msg=<span class="hljs-string">&quot;登录失败&quot;</span>;<br>&#125;<br>&#125;)<br>&#125;<br>&#125;<br>&#125;)<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure></li><li><p>测试</p><p>此时再测试，就可以识别未登录用户，跳转到登录页，然后根据登录状态，如果登录成功，则跳转到来源页。</p></li></ol><h1 id="Part11-订单"><a href="#Part11-订单" class="headerlink" title="Part11 订单"></a>Part11 订单</h1><h2 id="1-订单结算页"><a href="#1-订单结算页" class="headerlink" title="1. 订单结算页"></a>1. 订单结算页</h2><h3 id="1-1-收件地址分析"><a href="#1-1-收件地址分析" class="headerlink" title="1.1 收件地址分析"></a>1.1 收件地址分析</h3><p>用户从购物车页面点击结算，跳转到订单结算页，结算页需要加载用户对应的收件地址，如下图：</p><p><img src="/images/image-20210808120723726.png" alt="image-20210808120723726"></p><p>表结构分析：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE TABLE `tb_address` (<br>  `id` int(11) NOT NULL AUTO_INCREMENT,<br>  `username` varchar(50) DEFAULT NULL COMMENT &#x27;用户名&#x27;,<br>  `provinceid` varchar(20) DEFAULT NULL COMMENT &#x27;省&#x27;,<br>  `cityid` varchar(20) DEFAULT NULL COMMENT &#x27;市&#x27;,<br>  `areaid` varchar(20) DEFAULT NULL COMMENT &#x27;县/区&#x27;,<br>  `phone` varchar(20) DEFAULT NULL COMMENT &#x27;电话&#x27;,<br>  `address` varchar(200) DEFAULT NULL COMMENT &#x27;详细地址&#x27;,<br>  `contact` varchar(50) DEFAULT NULL COMMENT &#x27;联系人&#x27;,<br>  `is_default` varchar(1) DEFAULT NULL COMMENT &#x27;是否是默认 1默认 0否&#x27;,<br>  `alias` varchar(50) DEFAULT NULL COMMENT &#x27;别名&#x27;,<br>  PRIMARY KEY (`id`)<br>) ENGINE=InnoDB AUTO_INCREMENT=66 DEFAULT CHARSET=utf8;<br></code></pre></td></tr></table></figure><p>我们可以根据用户登录名去tb_address表中查询对应的数据。</p><h3 id="1-2-实现用户收件地址查询"><a href="#1-2-实现用户收件地址查询" class="headerlink" title="1.2 实现用户收件地址查询"></a>1.2 实现用户收件地址查询</h3><h4 id="1-2-1-代码实现"><a href="#1-2-1-代码实现" class="headerlink" title="1.2.1 代码实现"></a>1.2.1 代码实现</h4><ol><li><p>业务层接口</p><p>修改changgou-service-user微服务，需改com.changgou.user.service.AddressService接口，添加根据用户名字查询用户收件地址信息，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 收件地址查询</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> username</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-function">List&lt;Address&gt; <span class="hljs-title">list</span><span class="hljs-params">(String username)</span></span>;<br></code></pre></td></tr></table></figure></li><li><p>业务层接口实现类</p><p>修改changgou-service-user微服务，修改impl.AddressServiceImpl类，添加根据用户查询用户收件地址信息实现方法，如下代码：</p><p>注意：</p><ul><li><p>不要忘了dao层的AddressMapper，是通过他才来操作数据库的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">AddressMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Mapper</span>&lt;<span class="hljs-title">Address</span>&gt; </span>&#123;<br><br>&#125;<br></code></pre></td></tr></table></figure></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AddressServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AddressService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> AddressMapper addressMapper;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Address&gt; <span class="hljs-title">list</span><span class="hljs-params">(String username)</span> </span>&#123;<br>        Address address = <span class="hljs-keyword">new</span> Address();<br>        address.setUsername(username);<br>        List&lt;Address&gt; addressList = addressMapper.select(address);<br>        <span class="hljs-keyword">return</span> addressList;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>控制层</p><p>修改changgou-service-user微服务，修改AddressController，添加根据用户名查询用户收件信息方法，代码如下：</p><p>注意：</p><ul><li><p><code>TokenDecode</code>要自己添加到spring容器。UserApplication中创建TokenDecode,代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> TokenDecode <span class="hljs-title">tokenDecode</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">return</span>  <span class="hljs-keyword">new</span> TokenDecode();<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> TokenDecode tokenDecode;<br><br><span class="hljs-comment">/****</span><br><span class="hljs-comment"> * 用户收件地址</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(value = &quot;/list&quot;)</span><br><span class="hljs-keyword">public</span> Result&lt;List&lt;Address&gt;&gt; list()&#123;<br>    <span class="hljs-comment">//获取用户登录信息</span><br>    Map&lt;String, String&gt; userMap = tokenDecode.getUserInfo();<br>    String username = userMap.get(<span class="hljs-string">&quot;username&quot;</span>);<br>    <span class="hljs-comment">//查询用户收件地址</span><br>    List&lt;Address&gt; addressList = addressService.list(username);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>, StatusCode.OK,<span class="hljs-string">&quot;查询成功！&quot;</span>,addressList);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>测试</p><p>首先进行登录：<a href="http://localhost:8001/api/oauth/login">http://localhost:8001/api/oauth/login</a></p><p><img src="/images/image-20210808123905648.png" alt="image-20210808123905648"></p><p>然后再进行访问 <a href="http://localhost:8001/api/address/list">http://localhost:8001/api/address/list</a></p></li></ol><h3 id="1-3-页面模板渲染"><a href="#1-3-页面模板渲染" class="headerlink" title="1.3 页面模板渲染"></a>1.3 页面模板渲染</h3><p><img src="/images/image-20210808124121419.png" alt="image-20210808124121419"></p><p>购物车这块也使用的是模板渲染，用户先请求经过微服务网关，微服务网关转发到订单购物车模板渲染服务，模板渲染服务调用用户微服务和订单购物车微服务查询用户收件地址和购物车清单，然后到页面显示。</p><h4 id="1-3-1-准备工作"><a href="#1-3-1-准备工作" class="headerlink" title="1.3.1 准备工作"></a>1.3.1 准备工作</h4><ol><li><p>静态资源导入</p><p>将资料中的<code>order.html</code>拷贝到<code>changgou-web-order</code>工程的templates中</p><p><img src="/images/image-20210808124632321.png" alt="image-20210808124632321"></p></li><li><p>页面跳转实现</p><p>在changgou-web-order中创建<code>com.changgou.order.controller.OrderController</code>实现页面跳转，代码如下：</p><p><img src="/images/image-20210808130134240.png" alt="image-20210808130134240"></p></li><li><p>网关配置</p><p>修改changgou-gateway-web的application.yml文件，将订单的路由过滤地址添加上去，代码如下：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yml">  <span class="hljs-comment">#购物车订单渲染微服务</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">changgou_order_web_route</span><br>  <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://order-web</span><br>  <span class="hljs-attr">predicates:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/wcart/**,/api/worder/**</span><br>  <span class="hljs-attr">filters:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br></code></pre></td></tr></table></figure><p>同时不要忘了把该地址添加到登录过滤地址中，修改<code>com.changgou.filter.URLFilter</code>，在orderFilterPath里添加<code>/api/worder/**</code>过滤</p></li></ol><h4 id="1-3-2-信息查询"><a href="#1-3-2-信息查询" class="headerlink" title="1.3.2 信息查询"></a>1.3.2 信息查询</h4><p>因为一会儿要调用changgou-service-user查询用户的收件地址信息，调用changgou-service-order查询购物车清单信息，所以我们需要创建Feign。购物车的Feign之前已经创建过了，所以只需要创建用户地址相关的即可。</p><ol><li><p>用户地址查询</p><p>在changgou-service-user-api中创建AddressFeign，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name=&quot;user&quot;)</span><br><span class="hljs-meta">@RequestMapping(&quot;/address&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">AddressFeign</span> </span>&#123;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 查询用户的收件地址信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(value = &quot;/list&quot;)</span><br>    Result&lt;List&lt;Address&gt;&gt; list();<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>查询购物车和用户收件地址信息</p><p>修改changgou-web-order中的<code>com.changgou.order.controller.OrderController</code>的readyOrder方法，在该方法中，使用feign调用查询收件地址信息和用户购物车信息，代码如下:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/worder&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> AddressFeign addressFeign;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CartFeign cartFeign;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/ready/order&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">readyOrder</span><span class="hljs-params">(Model model)</span></span>&#123;<br>        <span class="hljs-comment">//收件人的地址信息</span><br>        List&lt;Address&gt; addressList = addressFeign.list().getData();<br>        model.addAttribute(<span class="hljs-string">&quot;address&quot;</span>,addressList);<br><br>        <span class="hljs-comment">//购物车信息</span><br>        Map map = cartFeign.list();<br>        List&lt;OrderItem&gt; orderItemList = (List&lt;OrderItem&gt;) map.get(<span class="hljs-string">&quot;orderItemList&quot;</span>);<br>        Integer totalMoney = (Integer) map.get(<span class="hljs-string">&quot;totalMoney&quot;</span>);<br>        Integer totalNum = (Integer) map.get(<span class="hljs-string">&quot;totalNum&quot;</span>);<br><br>        model.addAttribute(<span class="hljs-string">&quot;carts&quot;</span>,orderItemList);<br>        model.addAttribute(<span class="hljs-string">&quot;totalMoney&quot;</span>,totalMoney);<br>        model.addAttribute(<span class="hljs-string">&quot;totalNum&quot;</span>,totalNum);<br><br>        <span class="hljs-comment">//默认收件人信息</span><br>        <span class="hljs-keyword">for</span> (Address address : addressList) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;1&quot;</span>.equals(address.getIsDefault()))&#123;<br>                <span class="hljs-comment">//默认收件人</span><br>                model.addAttribute(<span class="hljs-string">&quot;deAddr&quot;</span>,address);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;order&quot;</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>数据回显</p><p>修改order.html，回显收件地址信息和购物车信息，代码如下：</p><p>收件地址信息：</p><p><img src="/images/image-20210808131410819.png" alt="image-20210808131410819"></p><p>购物车清单：</p><p><img src="/images/image-20210808131443336.png" alt="image-20210808131443336"></p><p>测试效果：</p><p>基于登录过的前提下</p><p><img src="/images/image-20210808132559714.png" alt="image-20210808132559714"></p></li><li><p>默认收件地址选中</p><p>上面所有数据都查询出来了，但是用户的收件地址全部选中了(我这里提供的是完整的代码，所以上面只选中一个)，这里应该只有默认收件地址选中。修改order.html代码如下：</p><p><img src="/images/image-20210808132814643.png" alt="image-20210808132814643"></p><p>效果如下</p><p><img src="/images/image-20210808132730293.png" alt="image-20210808132730293"></p></li></ol><h4 id="1-3-3-记录选中收件人"><a href="#1-3-3-记录选中收件人" class="headerlink" title="1.3.3 记录选中收件人"></a>1.3.3 记录选中收件人</h4><p>用户每次点击收件人的时候，我们需要记录收件人信息。我们可以使用Vue，定义一个订单变量，并且每次点击的时候，将该收件人信息传给Vue的一个方法在订单变量中记录选中的用户信息即可。</p><ol><li><p>引入vue</p><p>我们要先引入Vue,在order.html中引入vue，代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/js/vue.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text/javascript&quot;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/js/axios.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>同时在72行左右添加一个id=”app”作为Vue入口标签</p><p><img src="/images/image-20210808133130110.png" alt="image-20210808133130110"></p></li><li><p>定义记录用户信息方法</p><p><img src="/images/image-20210808133255575.png" alt="image-20210808133255575"></p><p>修改地址列表，每次点击的时候调用上面的方法，代码如下：</p><p><img src="/images/image-20210808133355885.png" alt="image-20210808133355885"></p><p>将选中的地址收件人信息回显到页面输出，代码如下：</p><p><img src="/images/image-20210808133432751.png" alt="image-20210808133432751"></p><p>测试效果如下：</p><p><img src="/images/image-20210808133512274.png" alt="image-20210808133512274"></p></li><li><p>默认收件人加载</p><p>用户没有手动选择收件人信息的时候，收件人信息没有初始化。</p><p><img src="/images/image-20210808133559222.png" alt="image-20210808133559222"></p><p>我们可以在后台加载找出默认的收件人信息，前台通过Vue直接绑定给变量即可。</p><p>修改<code>com.changgou.order.controller.OrderController</code>,添加默认收件人信息判断，代码如下：</p><p><img src="/images/image-20210808133826109.png" alt="image-20210808133826109"></p><p>修改order.html，代码如下：</p><p><img src="/images/image-20210808133906590.png" alt="image-20210808133906590"></p><p>此时页面可以正常显示用户信息了。</p></li></ol><h4 id="1-3-4-支付方式选中"><a href="#1-3-4-支付方式选中" class="headerlink" title="1.3.4 支付方式选中"></a>1.3.4 支付方式选中</h4><p>支付方式为线上支付和货到付款，我们可以在order变量中定义一个属性<code>payType</code>,点击线上支付让他的值为1，点击货到付款，让他的值为0即可。</p><p>定义变量</p><p><img src="/images/image-20210808134036160.png" alt="image-20210808134036160"></p><p>修改页面，添加点击事件</p><p><img src="/images/image-20210808134118198.png" alt="image-20210808134118198"></p><h2 id="2-下单"><a href="#2-下单" class="headerlink" title="2. 下单"></a>2. 下单</h2><h3 id="2-1-业务分析"><a href="#2-1-业务分析" class="headerlink" title="2.1 业务分析"></a>2.1 业务分析</h3><p>点击提交订单的时候，会立即创建订单数据，创建订单数据会将数据存入到2张表中，分别是订单表和订单明细表，此处还需要修改商品对应的库存数量。</p><p><img src="/images/image-20210808141232601.png" alt="image-20210808141232601"></p><p>订单表结构如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE TABLE `tb_order` (<br>  `id` varchar(50) COLLATE utf8_bin NOT NULL COMMENT &#x27;订单id&#x27;,<br>  `total_num` int(11) DEFAULT NULL COMMENT &#x27;数量合计&#x27;,<br>  `total_money` int(11) DEFAULT NULL COMMENT &#x27;金额合计&#x27;,<br>  `pre_money` int(11) DEFAULT NULL COMMENT &#x27;优惠金额&#x27;,<br>  `post_fee` int(11) DEFAULT NULL COMMENT &#x27;邮费&#x27;,<br>  `pay_money` int(11) DEFAULT NULL COMMENT &#x27;实付金额&#x27;,<br>  `pay_type` varchar(1) COLLATE utf8_bin DEFAULT NULL COMMENT &#x27;支付类型，1、在线支付、0 货到付款&#x27;,<br>  `create_time` datetime DEFAULT NULL COMMENT &#x27;订单创建时间&#x27;,<br>  `update_time` datetime DEFAULT NULL COMMENT &#x27;订单更新时间&#x27;,<br>  `pay_time` datetime DEFAULT NULL COMMENT &#x27;付款时间&#x27;,<br>  `consign_time` datetime DEFAULT NULL COMMENT &#x27;发货时间&#x27;,<br>  `end_time` datetime DEFAULT NULL COMMENT &#x27;交易完成时间&#x27;,<br>  `close_time` datetime DEFAULT NULL COMMENT &#x27;交易关闭时间&#x27;,<br>  `shipping_name` varchar(20) COLLATE utf8_bin DEFAULT NULL COMMENT &#x27;物流名称&#x27;,<br>  `shipping_code` varchar(20) COLLATE utf8_bin DEFAULT NULL COMMENT &#x27;物流单号&#x27;,<br>  `username` varchar(50) COLLATE utf8_bin DEFAULT NULL COMMENT &#x27;用户名称&#x27;,<br>  `buyer_message` varchar(1000) COLLATE utf8_bin DEFAULT NULL COMMENT &#x27;买家留言&#x27;,<br>  `buyer_rate` char(1) COLLATE utf8_bin DEFAULT NULL COMMENT &#x27;是否评价&#x27;,<br>  `receiver_contact` varchar(50) COLLATE utf8_bin DEFAULT NULL COMMENT &#x27;收货人&#x27;,<br>  `receiver_mobile` varchar(12) COLLATE utf8_bin DEFAULT NULL COMMENT &#x27;收货人手机&#x27;,<br>  `receiver_address` varchar(200) COLLATE utf8_bin DEFAULT NULL COMMENT &#x27;收货人地址&#x27;,<br>  `source_type` char(1) COLLATE utf8_bin DEFAULT NULL COMMENT &#x27;订单来源：1:web，2：app，3：微信公众号，4：微信小程序  5 H5手机页面&#x27;,<br>  `transaction_id` varchar(30) COLLATE utf8_bin DEFAULT NULL COMMENT &#x27;交易流水号&#x27;,<br>  `order_status` char(1) COLLATE utf8_bin DEFAULT NULL COMMENT &#x27;订单状态,0:未完成,1:已完成，2：已退货&#x27;,<br>  `pay_status` char(1) COLLATE utf8_bin DEFAULT NULL COMMENT &#x27;支付状态,0:未支付，1：已支付，2：支付失败&#x27;,<br>  `consign_status` char(1) COLLATE utf8_bin DEFAULT NULL COMMENT &#x27;发货状态,0:未发货，1：已发货，2：已收货&#x27;,<br>  `is_delete` char(1) COLLATE utf8_bin DEFAULT NULL COMMENT &#x27;是否删除&#x27;,<br>  PRIMARY KEY (`id`),<br>  KEY `create_time` (`create_time`),<br>  KEY `status` (`order_status`),<br>  KEY `payment_type` (`pay_type`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;<br></code></pre></td></tr></table></figure><p>订单明细表结构如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE TABLE `tb_order_item` (<br>  `id` varchar(50) COLLATE utf8_bin NOT NULL COMMENT &#x27;ID&#x27;,<br>  `category_id1` int(11) DEFAULT NULL COMMENT &#x27;1级分类&#x27;,<br>  `category_id2` int(11) DEFAULT NULL COMMENT &#x27;2级分类&#x27;,<br>  `category_id3` int(11) DEFAULT NULL COMMENT &#x27;3级分类&#x27;,<br>  `spu_id` varchar(20) COLLATE utf8_bin DEFAULT NULL COMMENT &#x27;SPU_ID&#x27;,<br>  `sku_id` bigint(20) NOT NULL COMMENT &#x27;SKU_ID&#x27;,<br>  `order_id` bigint(20) NOT NULL COMMENT &#x27;订单ID&#x27;,<br>  `name` varchar(200) COLLATE utf8_bin DEFAULT NULL COMMENT &#x27;商品名称&#x27;,<br>  `price` int(20) DEFAULT NULL COMMENT &#x27;单价&#x27;,<br>  `num` int(10) DEFAULT NULL COMMENT &#x27;数量&#x27;,<br>  `money` int(20) DEFAULT NULL COMMENT &#x27;总金额&#x27;,<br>  `pay_money` int(11) DEFAULT NULL COMMENT &#x27;实付金额&#x27;,<br>  `image` varchar(200) COLLATE utf8_bin DEFAULT NULL COMMENT &#x27;图片地址&#x27;,<br>  `weight` int(11) DEFAULT NULL COMMENT &#x27;重量&#x27;,<br>  `post_fee` int(11) DEFAULT NULL COMMENT &#x27;运费&#x27;,<br>  `is_return` char(1) COLLATE utf8_bin DEFAULT NULL COMMENT &#x27;是否退货,0:未退货，1：已退货&#x27;,<br>  PRIMARY KEY (`id`),<br>  KEY `item_id` (`sku_id`),<br>  KEY `order_id` (`order_id`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin;<br></code></pre></td></tr></table></figure><h3 id="2-2-下单实现"><a href="#2-2-下单实现" class="headerlink" title="2.2 下单实现"></a>2.2 下单实现</h3><p>下单的时候，先往tb_order表中增加数据，再往tb_order_item表中增加数据。</p><h4 id="2-2-1-代码实现"><a href="#2-2-1-代码实现" class="headerlink" title="2.2.1 代码实现"></a>2.2.1 代码实现</h4><p>这里先修改changgou-service-order微服务，实现下单操作，这里会生成订单号，我们首先需要在启动类中创建一个IdWorker对象。</p><p>在<code>com.changgou.OrderApplication</code>中创建IdWorker，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> IdWorker <span class="hljs-title">idWorker</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> IdWorker(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><ol><li><p>业务层实现类</p><p>实现逻辑：</p><ol><li>获取所有购物项</li><li>统计计算：总金额，总数量</li><li>填充订单数据并保存</li><li>获取每一个购物项保存到orderItem</li><li>删除购物车中数据</li></ol><p>修改订单微服务添加com.changgou.order.service.impl.OrderServiceImpl,代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">(Order order)</span></span>&#123;<br>    <span class="hljs-comment">//1)获取所有购物项</span><br>    Map cartMap = cartService.list(order.getUsername());<br>    List&lt;OrderItem&gt; orderItemList = (List&lt;OrderItem&gt;) cartMap.get(<span class="hljs-string">&quot;orderItemList&quot;</span>);<br>    <span class="hljs-comment">//3）填充订单数据并保存</span><br>    order.setTotalNum((Integer) cartMap.get(<span class="hljs-string">&quot;totalNum&quot;</span>));<br>    order.setTotalMoney((Integer) cartMap.get(<span class="hljs-string">&quot;totalMoney&quot;</span>));<br>    order.setPayMoney((Integer) cartMap.get(<span class="hljs-string">&quot;totalMoney&quot;</span>));<br>    order.setCreateTime(<span class="hljs-keyword">new</span> Date());<br>    order.setUpdateTime(order.getCreateTime());<br>    order.setBuyerRate(<span class="hljs-string">&quot;0&quot;</span>);        <span class="hljs-comment">//0:未评价，1：已评价</span><br>    order.setSourceType(<span class="hljs-string">&quot;1&quot;</span>);       <span class="hljs-comment">//来源，1：WEB</span><br>    order.setOrderStatus(<span class="hljs-string">&quot;0&quot;</span>);      <span class="hljs-comment">//0:未完成,1:已完成，2：已退货</span><br>    order.setPayStatus(<span class="hljs-string">&quot;0&quot;</span>);        <span class="hljs-comment">//0:未支付，1：已支付，2：支付失败</span><br>    order.setConsignStatus(<span class="hljs-string">&quot;0&quot;</span>);    <span class="hljs-comment">//0:未发货，1：已发货，2：已收货</span><br>    order.setId(idWorker.nextId()+<span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-keyword">int</span> count = orderMapper.insertSelective(order);<br>   <br>    <span class="hljs-comment">//添加订单明细</span><br>    <span class="hljs-keyword">for</span> (OrderItem orderItem : orderItemList) &#123;<br>        orderItem.setId(idWorker.nextId()+<span class="hljs-string">&quot;&quot;</span>);<br>        orderItem.setIsReturn(<span class="hljs-string">&quot;0&quot;</span>);<br>        orderItem.setOrderId(order.getId());<br>        orderItemMapper.insertSelective(orderItem);<br>    &#125;<br>   <br>    <span class="hljs-comment">//清除Redis缓存购物车数据</span><br>    redisTemplate.delete(<span class="hljs-string">&quot;Cart_&quot;</span>+order.getUsername());<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>控制层</p><p>修改changgou-service-order微服务，修改com.changgou.order.controller.OrderController类，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 新增Order数据</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> order</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@PostMapping</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Order order)</span></span>&#123;<br>    <span class="hljs-comment">//获取用户名</span><br>    Map&lt;String, String&gt; userMap = tokenDecode.getUserInfo();<br>    String username = userMap.get(<span class="hljs-string">&quot;username&quot;</span>);<br>    <span class="hljs-comment">//设置购买用户</span><br>    order.setUsername(username);<br>    orderService.add(order);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>,StatusCode.OK,<span class="hljs-string">&quot;添加成功&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="2-2-2-渲染服务对接"><a href="#2-2-2-渲染服务对接" class="headerlink" title="2.2.2 渲染服务对接"></a>2.2.2 渲染服务对接</h4><p><img src="/images/image-20210808140007275-1628403167768.png" alt="image-20210808140007275"></p><p>我们需要在模板渲染端调用订单微服务实现下单操作,下单操作需要调用订单微服务，所以需要创建对应的Feign。(前面我已经创建好了，这里再来过一遍流程)</p><ol><li><p>Feign创建</p><p>修改changgou-service-order-api，添加OrderFeign，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name = &quot;order&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">OrderFeign</span> </span>&#123;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/order&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Order order)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>下单调用</p><p>修改changgou-web-order的<code>com.changgou.order.controller.OrderController</code>添加下单方法，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> OrderFeign orderFeign;<br><br><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 添加订单数据到购物车中</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> order</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@PostMapping(value = &quot;/add&quot;)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Order order)</span></span>&#123;<br>   Result result = orderFeign.add(order);<br>   <span class="hljs-keyword">return</span>  result;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>页面调用</p><p>修改order.html，增加下单js方法，并且在页面点击下单调用，代码如下：</p><p><img src="/images/image-20210808141545746.png" alt="image-20210808141545746"></p><p>点击提交订单调用</p><p><img src="/images/image-20210808141647120.png" alt="image-20210808141647120"></p><p>保存订单测试，注意观察tb_order表数据以及tb_order_item表数据的变化</p></li></ol><h3 id="2-3-库存变更"><a href="#2-3-库存变更" class="headerlink" title="2.3 库存变更"></a>2.3 库存变更</h3><h4 id="2-3-1-业务分析"><a href="#2-3-1-业务分析" class="headerlink" title="2.3.1 业务分析"></a>2.3.1 业务分析</h4><p>上面操作只实现了下单操作，但对应的库存还没跟着一起减少，我们在下单之后，应该调用商品微服务，将下单的商品库存减少，销量增加。每次订单微服务只需要将用户名传到商品微服务，商品微服务通过用户名到Redis中查询对应的购物车数据，然后执行库存减少，库存减少需要控制当前商品库存&gt;=销售数量。</p><p><img src="/images/image-20210808141928494.png" alt="image-20210808141928494"></p><p>如何控制库存数量&gt;=购买数量呢？其实可以通过SQL语句实现，每次减少数量之前，加个条件判断。</p><p><code>where num&gt;=#&#123;num&#125;</code>即可。</p><p>商品服务需要查询购物车数据，所以需要引入订单的api，在pom.xml中添加如下依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--order api 依赖--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.changgou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>changgou_service_order_api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="2-3-2-代码实现-1"><a href="#2-3-2-代码实现-1" class="headerlink" title="2.3.2 代码实现"></a>2.3.2 代码实现</h3><p>要调用其他微服务，需要将头文件中的令牌数据携带到其他微服务中取，所以我们不能使用hystrix的多线程模式，修改changgou-service-order的applicatin.yml配置，代码如下：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment">#hystrix 配置</span><br><span class="hljs-attr">hystrix:</span><br>  <span class="hljs-attr">command:</span><br>    <span class="hljs-attr">default:</span><br>      <span class="hljs-attr">execution:</span><br>        <span class="hljs-attr">isolation:</span><br>          <span class="hljs-attr">thread:</span><br>            <span class="hljs-attr">timeoutInMilliseconds:</span> <span class="hljs-number">10000</span><br>          <span class="hljs-attr">strategy:</span> <span class="hljs-string">SEMAPHORE</span><br></code></pre></td></tr></table></figure><p>每次还需要使用拦截器添加头文件信息，修改配置类com.changgou.OrderApplication添加拦截器，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> FeignInterceptor <span class="hljs-title">feignInterceptor</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> FeignInterceptor();<br>&#125;<br></code></pre></td></tr></table></figure><ol><li><p>dao层</p><p>修改changgou-service-goods微服务的<code>com.changgou.goods.dao.SkuMapper</code>接口，增加库存递减方法,代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 递减库存</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> orderItem</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Update(&quot;UPDATE tb_sku SET num=num-#&#123;num&#125;,sale_num=sale_num+#&#123;num&#125; WHERE id=#&#123;skuId&#125; AND num&gt;=#&#123;num&#125;&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">decrCount</span><span class="hljs-params">(OrderItem orderItem)</span></span>;<br></code></pre></td></tr></table></figure></li><li><p>业务层</p><p>修改changgou-service-goods微服务的<code>com.changgou.goods.service.SkuService</code>接口，添加如下方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 库存递减</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> username</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">decrCount</span><span class="hljs-params">(String username)</span></span>;<br></code></pre></td></tr></table></figure><p>修改changgou-service-order微服务的<code>com.changgou.goods.service.impl.SkuServiceImpl</code>实现类，添加一个实现方法，代码如下:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 库存递减</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> username</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">decrCount</span><span class="hljs-params">(String username)</span> </span>&#123;<br>    <span class="hljs-comment">//获取购物车数据</span><br>    List&lt;OrderItem&gt; orderItems = redisTemplate.boundHashOps(<span class="hljs-string">&quot;Cart_&quot;</span> + username).values();<br><br>    <span class="hljs-comment">//循环递减</span><br>    <span class="hljs-keyword">for</span> (OrderItem orderItem : orderItems) &#123;<br>        <span class="hljs-comment">//递减库存</span><br>        <span class="hljs-keyword">int</span> count = skuMapper.decrCount(orderItem);<br>        <span class="hljs-keyword">if</span>(count&lt;=<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;库存不足，递减失败！&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>控制层</p><p>修改changgou-service-goods的<code>com.changgou.goods.controller.SkuController</code>类，添加库存递减方法，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 库存递减</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> username</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@PostMapping(value = &quot;/decr/count&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">decrCount</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;username&quot;)</span> String username)</span></span>&#123;<br>    <span class="hljs-comment">//库存递减</span><br>    skuService.decrCount(username);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>,StatusCode.OK,<span class="hljs-string">&quot;库存递减成功！&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>创建Feign</p><p>同时在changgou-service-goods-api工程添加<code>com.changgou.goods.feign.SkuFeign</code>的实现，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 库存递减</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> username</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@PostMapping(value = &quot;/decr/count&quot;)</span><br><span class="hljs-function">Result <span class="hljs-title">decrCount</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = &quot;username&quot;)</span> String username)</span></span>;<br></code></pre></td></tr></table></figure></li></ol><h4 id="2-3-3-调用库存递减"><a href="#2-3-3-调用库存递减" class="headerlink" title="2.3.3 调用库存递减"></a>2.3.3 调用库存递减</h4><p>修改changgou-service-order微服务的com.changgou.order.service.impl.OrderServiceImpl类的add方法，增加库存递减的调用。</p><p>先注入SkuFeign</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> SkuFeign skuFeign;<br></code></pre></td></tr></table></figure><p>再在调用库存递减方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 增加</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> order</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">(Order order)</span></span>&#123;<br>    <span class="hljs-comment">//1)获取所有购物项</span><br>    Map cartMap = cartService.list(order.getUsername());<br>    List&lt;OrderItem&gt; orderItemList = (List&lt;OrderItem&gt;) cartMap.get(<span class="hljs-string">&quot;orderItemList&quot;</span>);<br>    <span class="hljs-comment">//3）填充订单数据并保存</span><br>    order.setTotalNum((Integer) cartMap.get(<span class="hljs-string">&quot;totalNum&quot;</span>));<br>    order.setTotalMoney((Integer) cartMap.get(<span class="hljs-string">&quot;totalMoney&quot;</span>));<br>    order.setPayMoney((Integer) cartMap.get(<span class="hljs-string">&quot;totalMoney&quot;</span>));<br>    order.setCreateTime(<span class="hljs-keyword">new</span> Date());<br>    order.setUpdateTime(order.getCreateTime());<br>    order.setBuyerRate(<span class="hljs-string">&quot;0&quot;</span>);        <span class="hljs-comment">//0:未评价，1：已评价</span><br>    order.setSourceType(<span class="hljs-string">&quot;1&quot;</span>);       <span class="hljs-comment">//来源，1：WEB</span><br>    order.setOrderStatus(<span class="hljs-string">&quot;0&quot;</span>);      <span class="hljs-comment">//0:未完成,1:已完成，2：已退货</span><br>    order.setPayStatus(<span class="hljs-string">&quot;0&quot;</span>);        <span class="hljs-comment">//0:未支付，1：已支付，2：支付失败</span><br>    order.setConsignStatus(<span class="hljs-string">&quot;0&quot;</span>);    <span class="hljs-comment">//0:未发货，1：已发货，2：已收货</span><br>    order.setId(idWorker.nextId()+<span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-keyword">int</span> count = orderMapper.insertSelective(order);<br><br>    <span class="hljs-comment">//添加订单明细</span><br>    <span class="hljs-keyword">for</span> (OrderItem orderItem : orderItemList) &#123;<br>        orderItem.setId(idWorker.nextId()+<span class="hljs-string">&quot;&quot;</span>);<br>        orderItem.setIsReturn(<span class="hljs-string">&quot;0&quot;</span>);<br>        orderItem.setOrderId(order.getId());<br>        orderItemMapper.insertSelective(orderItem);<br>    &#125;<br><br>    <span class="hljs-comment">//==================</span><br>    <span class="hljs-comment">//库存减库存</span><br>    skuFeign.decrCount(order.getUsername());<br>    <span class="hljs-comment">//==================</span><br><br>    <span class="hljs-comment">//清除Redis缓存购物车数据</span><br>    redisTemplate.delete(<span class="hljs-string">&quot;Cart_&quot;</span>+order.getUsername());<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-3-4-测试"><a href="#2-3-4-测试" class="headerlink" title="2.3.4 测试"></a>2.3.4 测试</h4><p>库存减少前，查询数据库Sku数据如下：个数98，销量0</p><p>使用Postman执行 <a href="http://localhost:8001/api/order/add">http://localhost:8001/api/order/add</a></p><p>执行测试后，剩余库存97，销量1</p><h3 id="2-4-增加积分"><a href="#2-4-增加积分" class="headerlink" title="2.4 增加积分"></a>2.4 增加积分</h3><p>比如每次下单完成之后，给用户增加10个积分，支付完成后赠送优惠券，优惠券可用于支付时再次抵扣。我们先完成增加积分功能。如下表：points表示用户积分</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE TABLE `tb_user` (<br>  `username` varchar(50) NOT NULL COMMENT &#x27;用户名&#x27;,<br>  `password` varchar(100) NOT NULL COMMENT &#x27;密码，加密存储&#x27;,<br>  `phone` varchar(20) DEFAULT NULL COMMENT &#x27;注册手机号&#x27;,<br>  `email` varchar(50) DEFAULT NULL COMMENT &#x27;注册邮箱&#x27;,<br>  `created` datetime NOT NULL COMMENT &#x27;创建时间&#x27;,<br>  `updated` datetime NOT NULL COMMENT &#x27;修改时间&#x27;,<br>  `source_type` varchar(1) DEFAULT NULL COMMENT &#x27;会员来源：1:PC，2：H5，3：Android，4：IOS&#x27;,<br>  `nick_name` varchar(50) DEFAULT NULL COMMENT &#x27;昵称&#x27;,<br>  `name` varchar(50) DEFAULT NULL COMMENT &#x27;真实姓名&#x27;,<br>  `status` varchar(1) DEFAULT NULL COMMENT &#x27;使用状态（1正常 0非正常）&#x27;,<br>  `head_pic` varchar(150) DEFAULT NULL COMMENT &#x27;头像地址&#x27;,<br>  `qq` varchar(20) DEFAULT NULL COMMENT &#x27;QQ号码&#x27;,<br>  `is_mobile_check` varchar(1) DEFAULT &#x27;0&#x27; COMMENT &#x27;手机是否验证 （0否  1是）&#x27;,<br>  `is_email_check` varchar(1) DEFAULT &#x27;0&#x27; COMMENT &#x27;邮箱是否检测（0否  1是）&#x27;,<br>  `sex` varchar(1) DEFAULT &#x27;1&#x27; COMMENT &#x27;性别，1男，0女&#x27;,<br>  `user_level` int(11) DEFAULT NULL COMMENT &#x27;会员等级&#x27;,<br>  `points` int(11) DEFAULT NULL COMMENT &#x27;积分&#x27;,<br>  `experience_value` int(11) DEFAULT NULL COMMENT &#x27;经验值&#x27;,<br>  `birthday` datetime DEFAULT NULL COMMENT &#x27;出生年月日&#x27;,<br>  `last_login_time` datetime DEFAULT NULL COMMENT &#x27;最后登录时间&#x27;,<br>  PRIMARY KEY (`username`),<br>  UNIQUE KEY `username` (`username`) USING BTREE<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT=&#x27;用户表&#x27;;<br></code></pre></td></tr></table></figure><h4 id="2-4-1-代码实现"><a href="#2-4-1-代码实现" class="headerlink" title="2.4.1 代码实现"></a>2.4.1 代码实现</h4><ol><li><p>dao层</p><p>修改changgou-service-user微服务的<code>com.changgou.user.dao.UserMapper</code>接口，增加用户积分方法，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 增加用户积分</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> username</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pint</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Update(&quot;UPDATE tb_user SET points=points+#&#123;point&#125; WHERE  username=#&#123;username&#125;&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">addUserPoints</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;username&quot;)</span> String username, <span class="hljs-meta">@Param(&quot;point&quot;)</span> Integer pint)</span></span>;<br></code></pre></td></tr></table></figure></li><li><p>业务层</p><p>修改changgou-service-user微服务的<code>com.changgou.user.service.UserService</code>接口，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 添加用户积分</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> username</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pint</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">addUserPoints</span><span class="hljs-params">(String username,Integer pint)</span></span>;<br></code></pre></td></tr></table></figure><p>修改changgou-service-user微服务的<code>com.changgou.user.service.impl.UserServiceImpl</code>，增加添加积分方法实现，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 修改用户积分</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> username</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pint</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">addUserPoints</span><span class="hljs-params">(String username, Integer pint)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> userMapper.addUserPoints(username,pint);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>控制层</p><p>修改changgou-service-user微服务的<code>com.changgou.user.controller.UserController</code>，添加增加用户积分方法，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> TokenDecode tokenDecode;<br><br><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 增加用户积分</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> points:要添加的积分</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(value = &quot;/points/add&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">addPoints</span><span class="hljs-params">(Integer points)</span></span>&#123;<br>    <span class="hljs-comment">//获取用户名</span><br>    Map&lt;String, String&gt; userMap = tokenDecode.getUserInfo();<br>    String username = userMap.get(<span class="hljs-string">&quot;username&quot;</span>);<br><br>    <span class="hljs-comment">//添加积分</span><br>    userService.addUserPoints(username,points);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>,StatusCode.OK,<span class="hljs-string">&quot;添加积分成功！&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>Feign添加</p><p>修改changgou-service-user-api工程，修改<code>com.changgou.user.feign.UserFeign</code>，添加增加用户积分方法，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 添加用户积分</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> points</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(value = &quot;/points/add&quot;)</span><br><span class="hljs-function">Result <span class="hljs-title">addPoints</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = &quot;points&quot;)</span>Integer points)</span></span>;<br></code></pre></td></tr></table></figure></li></ol><h4 id="2-4-2-增加积分调用"><a href="#2-4-2-增加积分调用" class="headerlink" title="2.4.2 增加积分调用"></a>2.4.2 增加积分调用</h4><p>修改changgou-service-order，添加changgou-service-user-api的依赖，修改pom.xml,添加如下依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--user api 依赖--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.changgou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>changgou_service_user_api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>在增加订单的时候，同时添加用户积分，修改changgou-service-order微服务的<code>com.changgou.order.service.impl.OrderServiceImpl</code>下单方法，增加调用添加积分方法，代码如下：</p><p><img src="/images/image-20210808210321063.png" alt="image-20210808210321063"></p><p>修改changgou-service-order的启动类<code>com.changgou.OrderApplication</code>，添加feign的包路径：</p><p><img src="/images/image-20210808210556231.png" alt="image-20210808210556231"></p>]]></content>
    
    
    <categories>
      
      <category>畅购商城项目</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>畅购商城项目第三部分</title>
    <link href="/2021/07/28/1.3%20%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86/"/>
    <url>/2021/07/28/1.3%20%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86/</url>
    
    <content type="html"><![CDATA[<h1 id="Part09-用户认证"><a href="#Part09-用户认证" class="headerlink" title="Part09 用户认证"></a>Part09 用户认证</h1><h2 id="1-用户认证分析"><a href="#1-用户认证分析" class="headerlink" title="1. 用户认证分析"></a>1. 用户认证分析</h2><p><img src="/images/image-20210806165006789.png" alt="image-20210806165006789"></p><p>上面流程图描述了用户要操作的各个微服务，用户查看个人信息需要访问客户微服务，下单需要访问订单微服务，秒杀抢购商品需要访问秒杀微服务。每个服务都需要认证用户的身份，身份认证成功后，需要识别用户的角色然后授权访问对应的功能。</p><h3 id="1-1-单点登录"><a href="#1-1-单点登录" class="headerlink" title="1.1 单点登录"></a>1.1 单点登录</h3><p>用户访问的项目中，至少有3个微服务需要识别用户身份，如果用户访问每个微服务都登录一次就太麻烦了，为了提高用户的体验，我们需要实现让用户在一个系统中登录，其他任意受信任的系统都可以访问，这个功能就叫单点登录。</p><p>单点登录（Single Sign On），简称为 SSO，是目前比较流行的企业业务整合的解决方案之一。 SSO的定义是在多个应用系统中，用户只需要登录一次就可以访问所有相互信任的应用系统</p><h3 id="1-2-第三方账号登陆"><a href="#1-2-第三方账号登陆" class="headerlink" title="1.2 第三方账号登陆"></a>1.2 第三方账号登陆</h3><p>随着国内及国外巨头们的平台开放战略以及移动互联网的发展，第三方登录已经不是一个陌生的产品设计概念了。 所谓的第三方登录，是说基于用户在第三方平台上已有的账号和密码来快速完成己方应用的登录或者注册的功能。而这里的第三方平台，一般是已经拥有大量用户的平台，国外的比如Facebook，Twitter等，国内的比如微博、微信、QQ等。</p><p><img src="/images/image-20210806165406268.png" alt="image-20210806165406268"></p><h2 id="2-认证解决方案"><a href="#2-认证解决方案" class="headerlink" title="2. 认证解决方案"></a>2. 认证解决方案</h2><h3 id="2-1-单点登录技术方案"><a href="#2-1-单点登录技术方案" class="headerlink" title="2.1 单点登录技术方案"></a>2.1 单点登录技术方案</h3><p>分布式系统要实现单点登录，通常将认证系统独立抽取出来，并且将用户身份信息存储在单独的存储介质，比如： MySQL、Redis，考虑性能要求，通常存储在Redis中，如下图：</p><p><img src="/images/image-20210806165638050.png" alt="image-20210806165638050"></p><p>Java中有很多用户认证的框架都可以实现单点登录：</p><ul><li>Apache Shiro</li><li>CAS</li><li>Spring security  </li></ul><h3 id="第三方登录技术方案"><a href="#第三方登录技术方案" class="headerlink" title="第三方登录技术方案"></a>第三方登录技术方案</h3><h4 id="2-2-1-Oauth2认证流程"><a href="#2-2-1-Oauth2认证流程" class="headerlink" title="2.2.1 Oauth2认证流程"></a>2.2.1 Oauth2认证流程</h4><p>第三方认证技术方案最主要是解决认证协议的通用标准问题，因为要实现跨系统认证，各系统之间要遵循一定的 接口协议。 OAUTH协议为用户资源的授权提供了一个安全的、开放而又简易的标准。同时，任何第三方都可以使用OAUTH认 证服务，任何服务提供商都可以实现自身的OAUTH认证服务，因而OAUTH是开放的。业界提供了OAUTH的多种实现如PHP、JavaScript，Java，Ruby等各种语言开发包，大大节约了程序员的时间，因而OAUTH是简易的。互联网很多服务如Open API，很多大公司如Google，Yahoo，Microsoft等都提供了OAUTH认证服务，这些都足以说明OAUTH标准逐渐成为开放资源授权的标准。 Oauth协议目前发展到2.0版本，1.0版本过于复杂，2.0版本已得到广泛应用。 参考：<a href="https://baike.baidu.com/item/oAuth/7153134?fr=aladdin">https://baike.baidu.com/item/oAuth/7153134?fr=aladdin</a> Oauth协议：<a href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a> 下边分析一个Oauth2认证的例子，黑马程序员网站使用微信认证的过程</p><p><img src="/images/image-20210806170159857.png" alt="image-20210806170159857"></p><ol><li><p>客户端请求第三方授权</p><p>用户进入黑马程序员的登录页面，点击微信的图标以微信账号登录系统，用户是自己在微信里信息的资源拥有者。</p><p><img src="/images/image-20210806171203045.png" alt="image-20210806171203045"></p><p>点击“用QQ账号登录”出现一个二维码，此时用户扫描二维码，开始给黑马程序员授权。</p><p><img src="/images/image-20210806171233254.png" alt="image-20210806171233254"></p></li><li><p>资源拥有者同意给客户端授权</p><p>资源拥有者扫描二维码表示资源拥有者同意给客户端授权，微信会对资源拥有者的身份进行验证， 验证通过后，QQ会询问用户是否给授权黑马程序员访问自己的QQ数据，用户点击“确认登录”表示同意授权，QQ认证服务器会 颁发一个授权码，并重定向到黑马程序员的网站</p><p><img src="/images/image-20210806171257120.png" alt="image-20210806171257120"></p></li><li><p>客户端获取到授权码，请求认证服务器申请令牌 此过程用户看不到，客户端应用程序请求认证服务器，请求携带授权码。</p></li><li><p>认证服务器向客户端响应令牌 认证服务器验证了客户端请求的授权码，如果合法则给客户端颁发令牌，令牌是客户端访问资源的通行证。 此交互过程用户看不到，当客户端拿到令牌后，用户在黑马程序员看到已经登录成功。</p></li><li><p>客户端请求资源服务器的资源 客户端携带令牌访问资源服务器的资源。 黑马程序员网站携带令牌请求访问微信服务器获取用户的基本信息。</p></li><li><p>资源服务器返回受保护资源 资源服务器校验令牌的合法性，如果合法则向用户响应资源信息内容。 注意：资源服务器和认证服务器可以是一个服务也可以分开的服务，如果是分开的服务, 资源服务器通常要请求认证服务器来校验令牌的合法性。</p></li></ol><p>Oauth2.0认证流程如下： 引自Oauth2.0协议rfc6749 <a href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a></p><p><img src="/images/image-20210806171345750.png" alt="image-20210806171345750"></p><p>Oauth2包括以下角色：</p><ol><li>客户端本身不存储资源，需要通过资源拥有者的授权去请求资源服务器的资源，比如：畅购Android客户端、畅购Web客户端（浏览器端）、微信客户端等。</li><li>资源拥有者 通常为用户，也可以是应用程序，即该资源的拥有者。</li><li>授权服务器（也称认证服务器） 用来对资源拥有的身份进行认证、对访问资源进行授权。客户端要想访问资源需要通过认证服务器由资源拥有者授权后方可访问。</li><li>资源服务器 存储资源的服务器，比如，畅购用户管理服务器存储了畅购的用户信息，微信的资源服务存储了微信的用户信息等。客户端最终访问资源服务器获取资源信息。</li></ol><h4 id="2-2-2-Oauth2在项目的应用"><a href="#2-2-2-Oauth2在项目的应用" class="headerlink" title="2.2.2 Oauth2在项目的应用"></a>2.2.2 Oauth2在项目的应用</h4><p>Oauth2是一个标准的开放的授权协议，应用程序可以根据自己的要求去使用Oauth2，项目中使用Oauth2可以实现实现如下功能：</p><ol><li>本系统访问第三方系统的资源</li><li>外部系统访问本系统的资源</li><li>本系统前端（客户端） 访问本系统后端微服务的资源</li><li>本系统微服务之间访问资源，例如：微服务A访问微服务B的资源，B访问A的资源</li></ol><h3 id="2-3-Spring-security-Oauth2认证解决方案"><a href="#2-3-Spring-security-Oauth2认证解决方案" class="headerlink" title="2.3 Spring security + Oauth2认证解决方案"></a>2.3 Spring security + Oauth2认证解决方案</h3><p>本项目采用 Spring security + Oauth2+JWT完成用户认证及用户授权，Spring security 是一个强大的和高度可定制的身份验证和访问控制框架，Spring security 框架集成了Oauth2协议，下图是项目认证架构图：</p><p><img src="/images/image-20210806172024614.png" alt="image-20210806172024614"></p><ol><li>用户请求认证服务完成认证</li><li>认证服务下发用户身份令牌，拥有身份令牌表示身份合法</li><li>用户携带令牌请求资源服务，请求资源服务必先经过网关</li><li>网关校验用户身份令牌的合法，不合法表示用户没有登录，如果合法则放行继续访问</li><li>资源服务获取令牌，根据令牌完成授权</li><li>资源服务完成授权则响应资源信息</li></ol><h2 id="3-Jwt令牌回顾"><a href="#3-Jwt令牌回顾" class="headerlink" title="3. Jwt令牌回顾"></a>3. Jwt令牌回顾</h2><p>JSON Web Token（JWT）是一个开放的行业标准（RFC 7519），它定义了一种简介的、自包含的协议格式，用于 在通信双方传递json对象，传递的信息经过数字签名可以被验证和信任。JWT可以使用HMAC算法或使用RSA的公 钥/私钥对来签名，防止被篡改。</p><p>官网：<a href="https://jwt.io/">https://jwt.io/</a></p><p>标准：<a href="https://tools.ietf.org/html/rfc7519">https://tools.ietf.org/html/rfc7519</a></p><p>JWT令牌的优点：</p><ol><li>jwt基于json，非常方便解析</li><li>可以在令牌中自定义丰富的内容，易扩展</li><li>通过非对称加密算法及数字签名技术，JWT防止篡改，安全性高</li><li>资源服务使用JWT可不依赖认证服务即可完成授权</li></ol><p>缺点：</p><ul><li>JWT令牌较长，占存储空间比较大</li></ul><h3 id="3-1-令牌结构"><a href="#3-1-令牌结构" class="headerlink" title="3.1 令牌结构"></a>3.1 令牌结构</h3><p>JWT令牌由三部分组成，每部分中间使用点（.）分隔，比如：xxxxx.yyyyy.zzzzz</p><p><strong>Header</strong></p><p>头部包括令牌的类型（即JWT）及使用的哈希算法（如HMAC SHA256或RSA）</p><p>一个例子如下：</p><p>下边是Header部分的内容</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>    <span class="hljs-attr">&quot;alg&quot;</span>: <span class="hljs-string">&quot;HS256&quot;</span>,<br>    <span class="hljs-attr">&quot;typ&quot;</span>: <span class="hljs-string">&quot;JWT&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>将上边的内容使用Base64Url编码，得到一个字符串就是JWT令牌的第一部分</p><p><strong>Payload</strong></p><p>第二部分是负载，内容也是一个json对象，它是存放有效信息的地方，它可以存放jwt提供的现成字段，比 如：iss（签发者）,exp（过期时间戳）, sub（面向的用户）等，也可自定义字段。</p><p>此部分不建议存放敏感信息，因为此部分可以解码还原原始内容。</p><p>最后将第二部分负载使用Base64Url编码，得到一个字符串就是JWT令牌的第二部分。</p><p>一个例子：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>    <span class="hljs-attr">&quot;sub&quot;</span>: <span class="hljs-string">&quot;1234567890&quot;</span>,<br>    <span class="hljs-attr">&quot;name&quot;</span>: <span class="hljs-string">&quot;456&quot;</span>,<br>    <span class="hljs-attr">&quot;admin&quot;</span>: <span class="hljs-literal">true</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Signature</strong></p><p>第三部分是签名，此部分用于防止jwt内容被篡改。</p><p>这个部分使用base64url将前两部分进行编码，编码后使用点（.）连接组成字符串，最后使用header中声明 签名算法进行签名。</p><p>一个例子：</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-function"><span class="hljs-title">HMACSHA256</span>(</span><br><span class="hljs-function">    <span class="hljs-title">base64UrlEncode</span>(<span class="hljs-variable">header</span>) + <span class="hljs-string">&quot;.&quot;</span> +</span><br><span class="hljs-function">    <span class="hljs-title">base64UrlEncode</span>(<span class="hljs-variable">payload</span>) + <span class="hljs-string">&quot;.&quot;</span> +</span><br><span class="hljs-function">    <span class="hljs-variable">secret</span>)</span><br></code></pre></td></tr></table></figure><p>base64UrlEncode(header)：jwt令牌的第一部分。</p><p>base64UrlEncode(payload)：jwt令牌的第二部分。</p><p>secret：签名所使用的密钥。</p><h3 id="3-2-生成私钥公钥"><a href="#3-2-生成私钥公钥" class="headerlink" title="3.2 生成私钥公钥"></a>3.2 生成私钥公钥</h3><p>私钥加密，公钥解析</p><p>私钥作为签名用于生成令牌，用公钥来校验。相应的公钥只能校验相应的私钥</p><p>JWT令牌生成采用非对称加密算法</p><ol><li><p>生成密钥证书 下边命令生成密钥证书，采用RSA 算法每个证书包含公钥和私钥</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">keytool -genkeypair -<span class="hljs-built_in">alias</span> changgou -keyalg RSA -keypass changgou -keystore changgou.jks -storepass changgou <br></code></pre></td></tr></table></figure><p>Keytool 是一个java提供的证书管理工具</p><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs haml">-<span class="ruby"><span class="hljs-keyword">alias</span>：密钥的别名 </span><br><span class="ruby"></span>-<span class="ruby">keyalg：使用的hash算法 </span><br><span class="ruby"></span>-<span class="ruby">keypass：密钥的访问密码 </span><br><span class="ruby"></span>-<span class="ruby">keystore：密钥库文件名，changgou.jks保存了生成的证书 </span><br><span class="ruby"></span>-<span class="ruby">storepass：密钥库的访问密码 </span><br></code></pre></td></tr></table></figure><p>查询证书信息：</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lsl">keytool -<span class="hljs-type">list</span> -keystore changgou.jks<br></code></pre></td></tr></table></figure></li><li><p>导出公钥</p><p>openssl是一个加解密工具包，这里使用openssl来导出公钥信息</p><p>安装 openssl：<a href="http://slproweb.com/products/Win32OpenSSL.html">http://slproweb.com/products/Win32OpenSSL.html</a></p><p>安装资料目录下的Win64OpenSSL-1_1_1b.exe</p><p>配置openssl的path环境变量(有两种方式)</p><ol><li><p>方法一</p><p>先编辑一个系统变量</p><p><img src="/images/image-20210806194341094.png" alt="image-20210806194341094"></p><p>再双击Path配置环境变量。看高亮代码</p><p><img src="/images/image-20210806194443619.png" alt="image-20210806194443619"></p></li><li><p>方法二</p><p>直接在环境变量页面配置路径</p><p><img src="/images/image-20210806194546318.png" alt="image-20210806194546318"></p></li></ol><p>cmd进入changgou.jks文件所在目录(这里就是jwt目录)执行如下命令：</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">keytool -list -rfc --keystore changgou.jks <span class="hljs-string">| openssl x509 -inform pem -pubkey</span><br></code></pre></td></tr></table></figure><p>下面段内容是公钥</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">-----<span class="hljs-keyword">BEGIN</span> PUBLIC KEY-----<br>MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAjhE4fgF8oIaY5ERSiigWJJ2OK2icj7XU<span class="hljs-regexp">/lyB3CKdEcLcGw6bStTR9FdSJWSFvSbYl/</span>q0QlsWQvEHrPkvGEXWK5fQmdY71<span class="hljs-regexp">/QbGR+eoIQiE0U0QAowI1MLy+XwMvU8DfFyNPmMevq0OOW/</span><span class="hljs-number">4</span>+mqlPyvzCqV1N5VjpUsvcYoso5kHOpiWqf0aSTcTyY3FBgtv3phSA69VO4OgVq9+ma13TerauY<span class="hljs-regexp">/BbzQAIMOYP8Brla3I+8HVVxGgc2O5ij4+SkLISPNK5G1e00JvN5H5JiKaaBd3rFFd+NHvUv5TTrPjNOQX4uSo7bbhJGqglf60Wr5rYa0wzqbRkS7enW4qfdg3I/</span>YKQIDAQAB<br>-----<span class="hljs-keyword">END</span> PUBLIC KEY-----<br></code></pre></td></tr></table></figure><p>将上边的公钥拷贝到文本public.key文件中，合并为一行,可以将它放到需要实现授权认证的工程中。</p></li></ol><h3 id="3-3-基于私钥生成jwt令牌（小案例）"><a href="#3-3-基于私钥生成jwt令牌（小案例）" class="headerlink" title="3.3 基于私钥生成jwt令牌（小案例）"></a>3.3 基于私钥生成jwt令牌（小案例）</h3><h4 id="3-3-1导入认证服务"><a href="#3-3-1导入认证服务" class="headerlink" title="3.3.1导入认证服务"></a>3.3.1导入认证服务</h4><ol><li><p>将课件中<code>changgou_user_auth</code>的工程导入到项目中去，如果导入后包名，pom文件显示格式不对，可以按照如下操作</p><p>点击加号</p><p><img src="/images/image-20210806201611292.png" alt="image-20210806201611292"></p><p>点击pom文件</p><p><img src="/images/image-20210806201718682.png" alt="image-20210806201718682"></p><p>最后点击ok，如果是个正常包这里点不了。</p><p><img src="/images/image-20210806201758851.png" alt="image-20210806201758851"></p></li><li><p>认证服务中创建测试类CreateJwtTest</p><p>注意：</p><ul><li><p>将需要用到的文件放到resources下</p><p><img src="/images/image-20210806202207124.png" alt="image-20210806202207124"></p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.changgou.oauth;<br><br><span class="hljs-keyword">import</span> com.alibaba.fastjson.JSON;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.springframework.core.io.ClassPathResource;<br><span class="hljs-keyword">import</span> org.springframework.security.jwt.Jwt;<br><span class="hljs-keyword">import</span> org.springframework.security.jwt.JwtHelper;<br><span class="hljs-keyword">import</span> org.springframework.security.jwt.crypto.sign.RsaSigner;<br><span class="hljs-keyword">import</span> org.springframework.security.rsa.crypto.KeyStoreKeyFactory;<br><br><span class="hljs-keyword">import</span> java.security.KeyPair;<br><span class="hljs-keyword">import</span> java.security.interfaces.RSAPrivateKey;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CreateJwtTest</span> </span>&#123;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">createJWT</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-comment">//基于私钥生成jwt</span><br>        <span class="hljs-comment">//1. 创建一个秘钥工厂</span><br>        <span class="hljs-comment">//1: 指定私钥的位置  </span><br>        ClassPathResource classPathResource = <span class="hljs-keyword">new</span> ClassPathResource(<span class="hljs-string">&quot;changgou.jks&quot;</span>);<br>        <span class="hljs-comment">//2: 指定秘钥库的密码</span><br>        String keyPass = <span class="hljs-string">&quot;changgou&quot;</span>;<br>        KeyStoreKeyFactory keyStoreKeyFactory = <span class="hljs-keyword">new</span> KeyStoreKeyFactory(classPathResource,keyPass.toCharArray());<br><br>        <span class="hljs-comment">//2. 基于工厂获取私钥</span><br>        String alias = <span class="hljs-string">&quot;changgou&quot;</span>;<br>        String password = <span class="hljs-string">&quot;changgou&quot;</span>;<br>        KeyPair keyPair = keyStoreKeyFactory.getKeyPair(alias, password.toCharArray());<br>        <span class="hljs-comment">//将当前的私钥转换为rsa私钥</span><br>        RSAPrivateKey rsaPrivateKey = (RSAPrivateKey) keyPair.getPrivate();<br><br>        <span class="hljs-comment">//3.生成jwt</span><br>        Map&lt;String,String&gt; map = <span class="hljs-keyword">new</span> HashMap();<br>        map.put(<span class="hljs-string">&quot;company&quot;</span>,<span class="hljs-string">&quot;heima&quot;</span>);<br>        map.put(<span class="hljs-string">&quot;address&quot;</span>,<span class="hljs-string">&quot;beijing&quot;</span>);<br><br>        Jwt jwt = JwtHelper.encode(JSON.toJSONString(map), <span class="hljs-keyword">new</span> RsaSigner(rsaPrivateKey));<br>        String jwtEncoded = jwt.getEncoded();<br>        System.out.println(jwtEncoded);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>基于公钥解析jwt令牌</p><p>上面创建令牌后，我们可以对JWT令牌进行解析，这里解析需要用到公钥，我们可以将之前生成的公钥public.key拷贝出来用字符串变量token存储，然后通过公钥解密。</p><p>在changgou-user-oauth创建测试类com.changgou.token.ParseJwtTest实现解析校验令牌数据，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.springframework.security.jwt.Jwt;<br><span class="hljs-keyword">import</span> org.springframework.security.jwt.JwtHelper;<br><span class="hljs-keyword">import</span> org.springframework.security.jwt.crypto.sign.RsaVerifier;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ParseJwtTest</span> </span>&#123;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">parseJwt</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-comment">//基于公钥去解析jwt</span><br>        String jwt =<span class="hljs-string">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhZGRyZXNzIjoiYmVpamluZyIsImNvbXBhbnkiOiJoZWltYSJ9.cjZNz8G0m4noNYN2VM1SH3ujAtbHElW5Vtbadb0NDI0cjM1DaAXzMA53Qbj4pmVQPl_IfSKqUEXbLxowdRa5NHR43laFsR0kzGbJiTINfSVSroSslYpDdEVwCeAF_a7I-R819YTj4p6sjuYKXbzXpeZQErczFbWWWGR2_U44xH6u1ejRNv8PikFiuzNw-muL7zUJkvqeSJzbEMnQdZMbfvZp4LtSI6B4G_PqpdNXkv19-juxAh99VgJInH_ItF0y5IBOxofA7gRebCZmU8L57gO9ohf2L00D95kis_Ji8lmA1ptLIfXqO_qLVvLBUNH-VtgjGAF0-0pyB-5jlbHP7w&quot;</span>;<br><br>        String publicKey =<span class="hljs-string">&quot;-----BEGIN PUBLIC KEY-----MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAvFsEiaLvij9C1Mz+oyAmt47whAaRkRu/8kePM+X8760UGU0RMwGti6Z9y3LQ0RvK6I0brXmbGB/RsN38PVnhcP8ZfxGUH26kX0RK+tlrxcrG+HkPYOH4XPAL8Q1lu1n9x3tLcIPxq8ZZtuIyKYEmoLKyMsvTviG5flTpDprT25unWgE4md1kthRWXOnfWHATVY7Y/r4obiOL1mS5bEa/iNKotQNnvIAKtjBM4RlIDWMa6dmz+lHtLtqDD2LF1qwoiSIHI75LQZ/CNYaHCfZSxtOydpNKq8eb1/PGiLNolD4La2zf0/1dlcr5mkesV570NxRmU1tFm8Zd3MZlZmyv9QIDAQAB-----END PUBLIC KEY-----&quot;</span>;<br><br>        Jwt token = JwtHelper.decodeAndVerify(jwt, <span class="hljs-keyword">new</span> RsaVerifier(publicKey));<br><br>        String claims = token.getClaims();<br>        System.out.println(claims);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>执行结果为：（就是创建令牌时放入的数据）</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;address&quot;</span>:<span class="hljs-string">&quot;beijing&quot;</span>,<span class="hljs-attr">&quot;company&quot;</span>:<span class="hljs-string">&quot;heima&quot;</span>&#125;<br></code></pre></td></tr></table></figure></li></ol><h2 id="4-Oauth2-0入门"><a href="#4-Oauth2-0入门" class="headerlink" title="4. Oauth2.0入门"></a>4. Oauth2.0入门</h2><h3 id="4-1-准备工作"><a href="#4-1-准备工作" class="headerlink" title="4.1 准备工作"></a>4.1 准备工作</h3><p>这里都准备好了，主要看下表结构就可以了</p><ol><li><p>搭建认证服务器之前，先在用户系统表结构中增加如下表结构：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE TABLE `oauth_client_details` (<br>  `client_id` varchar(48) NOT NULL COMMENT &#x27;客户端ID，主要用于标识对应的应用&#x27;,<br>  `resource_ids` varchar(256) DEFAULT NULL,<br>  `client_secret` varchar(256) DEFAULT NULL COMMENT &#x27;客户端秘钥，BCryptPasswordEncoder加密&#x27;,<br>  `scope` varchar(256) DEFAULT NULL COMMENT &#x27;对应的范围&#x27;,<br>  `authorized_grant_types` varchar(256) DEFAULT NULL COMMENT &#x27;认证模式&#x27;,<br>  `web_server_redirect_uri` varchar(256) DEFAULT NULL COMMENT &#x27;认证后重定向地址&#x27;,<br>  `authorities` varchar(256) DEFAULT NULL,<br>  `access_token_validity` int(11) DEFAULT NULL COMMENT &#x27;令牌有效期&#x27;,<br>  `refresh_token_validity` int(11) DEFAULT NULL COMMENT &#x27;令牌刷新周期&#x27;,<br>  `additional_information` varchar(4096) DEFAULT NULL,<br>  `autoapprove` varchar(256) DEFAULT NULL,<br>  PRIMARY KEY (`client_id`)<br>) ENGINE=InnoDB DEFAULT CHARSET=utf8;<br></code></pre></td></tr></table></figure></li><li><p>导入1条初始化数据,其中加密字符明文为changgou：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">INSERT INTO `oauth_client_details` VALUES (&#x27;changgou&#x27;, null, &#x27;$2a$10$Yvkp3xzDcri6MAsPIqnzzeGBHez1QZR3A079XDdmNU4R725KrkXi2&#x27;, &#x27;app&#x27;, &#x27;authorization_code,password,refresh_token,client_credentials&#x27;, &#x27;http://localhost&#x27;, null, &#x27;43200&#x27;, &#x27;43200&#x27;, null, null);<br></code></pre></td></tr></table></figure></li></ol><h3 id="4-2-Oauth2授权模式介绍"><a href="#4-2-Oauth2授权模式介绍" class="headerlink" title="4.2 Oauth2授权模式介绍"></a>4.2 Oauth2授权模式介绍</h3><p>Oauth2有以下授权模式：</p><ol><li>授权码模式（Authorization Code）</li><li>隐式授权模式（Implicit）</li><li>密码模式（Resource Owner Password Credentials） </li><li>客户端模式（Client Credentials）</li></ol><p>其中授权码模式和密码模式应用较多，本小节介绍授权码模式。</p><h4 id="4-2-1-授权码模式"><a href="#4-2-1-授权码模式" class="headerlink" title="4.2.1 授权码模式"></a>4.2.1 授权码模式</h4><ol><li><p><strong>授权码授权流程</strong></p><ol><li>客户端（这个客户端不是用户，是客户端服务器）请求第三方授权</li><li>用户同意给客户端授权</li><li>客户端获取到授权码，请求认证服务器申请令牌</li><li>认证服务器向客户端响应令牌</li><li>客户端请求资源服务器的资源，资源服务校验令牌合法性，完成授权</li><li>资源服务器返回受保护资源</li></ol></li><li><p><strong>申请授权码</strong></p><p>请求认证服务获取授权码：</p><p>注意：</p><ul><li><p>9200是项目中设置好的用户认证微服务的端口号</p></li><li><p><code>/oauth/authorize</code>是oauth2.0内部已经规定好的获得授权码的路径</p></li><li><p><code>client_id=changgou</code>是服务器数据库中表的字段和对应的属性</p><p><img src="/images/image-20210806223116209.png" alt="image-20210806223116209"></p></li><li><p><code>response_type=code</code>表明用的是oauth2.0的授权码模式</p></li><li><p><code>scop=app</code>也是表中的字段和属性</p><p><img src="/images/image-20210806223447185.png" alt="image-20210806223447185"></p></li><li><p><code>redirect_uri</code>：跳转uri，当授权码申请成功后会跳转到此地址，并在后边带上code参数（授权码）</p></li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">Get请求：<br>http:<span class="hljs-regexp">//</span>localhost:<span class="hljs-number">9200</span><span class="hljs-regexp">/oauth/</span>authorize?client_id=changgou&amp;response_type=code&amp;scop=app&amp;redirect_uri=http:<span class="hljs-regexp">//</span>localhost<br></code></pre></td></tr></table></figure><p>在浏览器输入上面的请求，发现跳转到了登陆页面</p><p><img src="/images/image-20210806223824348.png" alt="image-20210806223824348"></p><p>输入账号和密码，点击Login。 Spring Security接收到请求会调用UserDetailsService接口（这个接口它内部自己写好了，不用编写）的loadUserByUsername方法查询用户正确的密码。 当前导入的基础工程中客户端ID为changgou，秘钥也为changgou（这个客户端ID还有密钥的加密字符在最开始被插入数据库了，所以这里能够登录成功）即可认证通过。</p><p>接下来进入授权页面：</p><p><img src="/images/image-20210806224201321.png" alt="image-20210806224201321"></p><p>点击Authorize,接下来返回授权码： 认证服务携带授权码跳转redirect_uri,code=OicI5N就是返回的授权码, <strong>每一个授权码只能使用一次</strong></p><p><img src="/images/image-20210806224319499.png" alt="image-20210806224319499"></p></li><li><p><strong>申请令牌</strong></p><p>拿到授权码后，申请令牌</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">Post请求：<br>http:<span class="hljs-regexp">//</span>localhost:<span class="hljs-number">9200</span><span class="hljs-regexp">/oauth/</span>token<br></code></pre></td></tr></table></figure><p>此链接需要使用 http Basic认证(下图Basic Auth就是这个认证)</p><p>以上测试使用postman完成：</p><p><img src="/images/image-20210806225752649.png" alt="image-20210806225752649"></p><p><img src="/images/image-20210806225820728.png" alt="image-20210806225820728"></p><p>客户端Id和客户端密码会匹配数据库oauth_client_details表中的客户端id及客户端密码。</p><p>点击发送： 申请令牌成功</p><p><img src="/images/image-20210806230037261.png" alt="image-20210806230037261"></p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stata">access_token：访问令牌，携带此令牌访问资源 <br>token_type：有<span class="hljs-keyword">MAC</span> <span class="hljs-keyword">Token</span>与Bearer <span class="hljs-keyword">Token</span>两种类型，两种的校验算法不同，RFC 6750建议Oauth2采用 Bearer <span class="hljs-keyword">Token</span>（http:<span class="hljs-comment">//www.rfcreader.com/#rfc6750）。 </span><br>refresh_token：刷新令牌，使用此令牌可以延长访问令牌的过期时间。 <br>expires_in：过期时间，单位为秒。 <br>scope：范围，与定义的客户端范围一致。    <br>jti：当前<span class="hljs-keyword">token</span>的唯一标识<br></code></pre></td></tr></table></figure><p>关于access_token和jti的关系，需要多强调一点：</p><ul><li><p>jti与access_token成对出现，一 一对应。他俩是一个键值对。jti作为键存储在cookie中，access_token作为值存储在redis中（因为cookei存放的数据长度有限，不然不需要下面的</p><p>redis）</p></li></ul></li><li><p><strong>令牌校验</strong>  </p><p>Spring Security Oauth2提供校验令牌的端点，如下：</p><p>Get: <a href="http://localhost:9200/oauth/check_token?token=">http://localhost:9200/oauth/check_token?token=</a> [access_token]</p><p>（这里的[access_token]就是刚刚获得的令牌）</p><p>使用postman测试如下:</p><p><img src="/images/image-20210806231247708.png" alt="image-20210806231247708"></p><p>此时说明校验成功</p></li><li><p><strong>刷新令牌</strong></p><p>刷新令牌是当令牌快过期时重新生成一个令牌，它与授权码授权和密码授权生成令牌不同，刷新令牌不需要授权码 也不需要账号和密码，只需要一个刷新令牌、客户端id和客户端密码。</p><p>测试如下： Post：<a href="http://localhost:9200/oauth/token">http://localhost:9200/oauth/token</a></p><p>参数：</p><ul><li><p>grant_type： 固定为 refresh_token</p></li><li><p>refresh_token：刷新令牌（注意不是access_token，而是refresh_token）</p><p><img src="/images/image-20210806231738266.png" alt="image-20210806231738266"></p></li></ul></li></ol><h4 id="4-2-2-密码模式"><a href="#4-2-2-密码模式" class="headerlink" title="4.2.2 密码模式"></a>4.2.2 密码模式</h4><p>密码模式（Resource Owner Password Credentials）与授权码模式的区别是申请令牌不再使用授权码，而是直接 通过用户名和密码即可申请令牌。</p><ol><li><p><strong>申请令牌</strong></p><p>测试如下</p><p>注意：</p><ul><li>这里的用户名和密码就是真正的用户的账号和密码，和前面客户端的不是一个概念。</li><li>这里的用户名和密码需要去<code>tb_user</code>表中找，但是这里代码还没有完成，都用的<code>itheima</code>做密码</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk">Post请求：<br>http:<span class="hljs-regexp">//</span>localhost:<span class="hljs-number">9200</span><span class="hljs-regexp">/oauth/</span>token<br><br>携带参数： <br>grant_type：密码模式授权填写password <br>username：账号  <br>password：密码<br></code></pre></td></tr></table></figure><p>此链接也需要使用 http Basic认证</p><p><img src="/images/image-20210806233653549.png" alt="image-20210806233653549"></p><p>测试结果如下</p><p><img src="/images/image-20210806233733190.png" alt="image-20210806233733190"></p></li></ol><h3 id="4-3-资源服务授权"><a href="#4-3-资源服务授权" class="headerlink" title="4.3 资源服务授权"></a>4.3 资源服务授权</h3><p>资源服务拥有要访问的受保护资源，客户端携带令牌访问资源服务，如果令牌合法则可成功访问资源服务中的资源，如下图:</p><p><img src="/images/image-20210806234229211.png" alt="image-20210806234229211"></p><p>上图的业务流程如下:</p><ol><li>客户端请求认证服务申请令牌</li><li>认证服务生成令牌认证服务采用非对称加密算法，使用私钥生成令牌</li><li>客户端携带令牌访问资源服务客户端在Http header 中添加： Authorization：Bearer令牌</li><li>资源服务请求认证服务校验令牌的有效性资源服务接收到令牌，使用公钥校验令牌的合法性</li><li>令牌有效，资源服务向客户端响应资源信息</li></ol><h4 id="4-3-1-用户服务对接Oauth2"><a href="#4-3-1-用户服务对接Oauth2" class="headerlink" title="4.3.1 用户服务对接Oauth2"></a>4.3.1 用户服务对接Oauth2</h4><ol><li><p>配置公钥 ，将 changggou_user_auth 项目中public.key复制到changgou_service_user中</p><p><img src="/images/image-20210806234937362.png" alt="image-20210806234937362"></p></li><li><p>添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>配置每个系统的Http请求路径安全控制策略以及读取公钥信息识别令牌，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableResourceServer</span> <span class="hljs-comment">//声明当前的服务是一个资源服务器</span><br><span class="hljs-meta">@EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)</span><span class="hljs-comment">//激活方法上的PreAuthorize注解</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ResourceServerConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ResourceServerConfigurerAdapter</span> </span>&#123;<br><br>    <span class="hljs-comment">//公钥</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PUBLIC_KEY = <span class="hljs-string">&quot;public.key&quot;</span>;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 定义JwtTokenStore</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> jwtAccessTokenConverter</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> TokenStore <span class="hljs-title">tokenStore</span><span class="hljs-params">(JwtAccessTokenConverter jwtAccessTokenConverter)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> JwtTokenStore(jwtAccessTokenConverter);<br>    &#125;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 定义JJwtAccessTokenConverter</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> JwtAccessTokenConverter <span class="hljs-title">jwtAccessTokenConverter</span><span class="hljs-params">()</span> </span>&#123;<br>        JwtAccessTokenConverter converter = <span class="hljs-keyword">new</span> JwtAccessTokenConverter();<br>        converter.setVerifierKey(getPubKey());<br>        <span class="hljs-keyword">return</span> converter;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取非对称加密公钥 Key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 公钥 Key</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getPubKey</span><span class="hljs-params">()</span> </span>&#123;<br>        Resource resource = <span class="hljs-keyword">new</span> ClassPathResource(PUBLIC_KEY);<br>        <span class="hljs-keyword">try</span> &#123;<br>            InputStreamReader inputStreamReader = <span class="hljs-keyword">new</span> InputStreamReader(resource.getInputStream());<br>            BufferedReader br = <span class="hljs-keyword">new</span> BufferedReader(inputStreamReader);<br>            <span class="hljs-keyword">return</span> br.lines().collect(Collectors.joining(<span class="hljs-string">&quot;\n&quot;</span>));<br>        &#125; <span class="hljs-keyword">catch</span> (IOException ioe) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * Http安全配置，对每个到达系统的http请求链接进行校验</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> http</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-comment">//所有请求必须认证通过</span><br>        http.authorizeRequests()<br>                <span class="hljs-comment">//下边的路径放行</span><br>                .antMatchers(<br>                        <span class="hljs-string">&quot;/user/add&quot;</span>,<span class="hljs-string">&quot;/user/load/**&quot;</span>). <span class="hljs-comment">//配置地址放行</span><br>                permitAll()<br>                .anyRequest().<br>                authenticated();    <span class="hljs-comment">//其他地址需要认证授权</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>资源服务授权测试</p><p>不携带令牌访问<a href="http://localhost:9005/user">http://localhost:9005/user</a></p><p>由于该地址受访问限制，需要授权，所以出现如下错误：</p><p><img src="/images/image-20210807000317476.png" alt="image-20210807000317476"></p><p>携带令牌访问<a href="http://localhost:9005/user">http://localhost:9005/user</a></p><p>在http header中添加 Authorization： Bearer 令牌</p><p>注意：</p><ul><li>Bearer 令牌之间有空格</li><li>令牌是前面生成的还没过期，所以这里可以直接用</li></ul><p><img src="/images/image-20210807000526789.png" alt="image-20210807000526789"></p><p><img src="/images/image-20210807000550001.png" alt="image-20210807000550001"></p></li></ol><h2 id="5-认证开发"><a href="#5-认证开发" class="headerlink" title="5 认证开发"></a>5 认证开发</h2><h3 id="5-1-需求分析"><a href="#5-1-需求分析" class="headerlink" title="5.1 需求分析"></a>5.1 需求分析</h3><p><img src="/images/image-20210807125506369.png" alt="image-20210807125506369"></p><p>执行流程：</p><ol><li>用户登录，请求认证服务</li><li>认证服务认证通过，生成jwt令牌，将jwt令牌及相关信息写入Redis，并且将身份令牌写入cookie </li><li>用户访问资源页面，带着cookie到网关 </li><li>网关从cookie获取token，并查询Redis校验token,如果token不存在则拒绝访问，否则放行</li><li>用户退出，请求认证服务，清除redis中的token，并且删除cookie中的token </li></ol><p>使用redis存储用户的身份令牌有以下作用：</p><ol><li>实现用户退出注销功能，服务端清除令牌后，即使客户端请求携带token也是无效的</li><li>由于jwt令牌过长，不宜存储在cookie中，所以将jwt令牌存储在redis，由客户端请求服务端获取并在客户端存储 </li></ol><h3 id="5-2-Redis配置"><a href="#5-2-Redis配置" class="headerlink" title="5.2 Redis配置"></a>5.2 Redis配置</h3><p>增加认证服务changgou_user_auth中application.yml配置文件中的Redis配置</p><h3 id="5-3-认证服务"><a href="#5-3-认证服务" class="headerlink" title="5.3 认证服务"></a>5.3 认证服务</h3><h4 id="5-3-1-认证服务需求分析"><a href="#5-3-1-认证服务需求分析" class="headerlink" title="5.3.1 认证服务需求分析"></a>5.3.1 认证服务需求分析</h4><p>认证服务需要实现的功能如下：</p><ol><li><p>登录接口</p><p>前端post提交账号、密码等，用户身份校验通过，生成令牌，并将令牌存储到redis。 将令牌写入cookie。</p></li><li><p>退出接口 </p><p>校验当前用户的身份为合法并且为已登录状态。 将令牌从redis删除。 删除cookie中的令牌。</p><p><img src="/images/image-20210807132848712.png" alt="image-20210807132848712"></p></li></ol><h4 id="5-3-2-授权参数配置"><a href="#5-3-2-授权参数配置" class="headerlink" title="5.3.2 授权参数配置"></a>5.3.2 授权参数配置</h4><p>修改changgou_user_auth中application.yml配置文件，修改对应的授权配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">auth:</span><br>  <span class="hljs-attr">ttl:</span> <span class="hljs-number">1200</span>  <span class="hljs-comment">#token存储到redis的过期时间</span><br>  <span class="hljs-attr">clientId:</span> <span class="hljs-string">changgou</span>    <span class="hljs-comment">#客户端ID</span><br>  <span class="hljs-attr">clientSecret:</span> <span class="hljs-string">changgou</span>    <span class="hljs-comment">#客户端秘钥</span><br>  <span class="hljs-attr">cookieDomain:</span> <span class="hljs-string">localhost</span>   <span class="hljs-comment">#Cookie保存对应的域名</span><br>  <span class="hljs-attr">cookieMaxAge:</span> <span class="hljs-number">-1</span>          <span class="hljs-comment">#Cookie过期时间，-1表示浏览器关闭则销毁</span><br></code></pre></td></tr></table></figure><h4 id="5-3-3-申请令牌测试"><a href="#5-3-3-申请令牌测试" class="headerlink" title="5.3.3 申请令牌测试"></a>5.3.3 申请令牌测试</h4><p>这里和正常的业务代码无关，这里只是测试申请令牌有没有错</p><p>为了不破坏Spring Security的代码，我们在Service方法中通过RestTemplate请求Spring Security所暴露的申请令牌接口来申请令牌，下边是测试代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApplyTokenTest</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span>  <span class="hljs-comment">//这个bean需要自己声明，已经声明在启动类中了</span><br>    <span class="hljs-keyword">private</span> RestTemplate restTemplate;<br><br>    <span class="hljs-meta">@Autowired</span>  <span class="hljs-comment">//通过它可以在注册中心获取地址信息</span><br>    <span class="hljs-keyword">private</span> LoadBalancerClient loadBalancerClient;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">applyToken</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-comment">//构建请求地址  http://localhost:9200/oauth/token</span><br>        <span class="hljs-comment">//user-auth是这个微服务在注册中心的名字。返回的是这个服务的实例对象</span><br>        ServiceInstance serviceInstance = loadBalancerClient.choose(<span class="hljs-string">&quot;user-auth&quot;</span>);<br>        <span class="hljs-comment">// 通过这个实例对象，就可以获得他的路径信息  http://localhost:9200</span><br>        URI uri = serviceInstance.getUri();<br>        <span class="hljs-comment">// http://localhost:9200/oauth/token</span><br>        String url =uri+<span class="hljs-string">&quot;/oauth/token&quot;</span>;<br><br>        <span class="hljs-comment">// 封装请求参数 body , headers。这里的用户名和密码写死了，实际开发中不是这样</span><br>        MultiValueMap&lt;String, String&gt; body = <span class="hljs-keyword">new</span> LinkedMultiValueMap&lt;&gt;();<br>        body.add(<span class="hljs-string">&quot;grant_type&quot;</span>,<span class="hljs-string">&quot;password&quot;</span>);<br>        body.add(<span class="hljs-string">&quot;username&quot;</span>,<span class="hljs-string">&quot;itheima&quot;</span>);<br>        body.add(<span class="hljs-string">&quot;password&quot;</span>,<span class="hljs-string">&quot;itheima&quot;</span>);<br><br>        MultiValueMap&lt;String, String&gt; headers = <span class="hljs-keyword">new</span> LinkedMultiValueMap&lt;&gt;();<br>        headers.add(<span class="hljs-string">&quot;Authorization&quot;</span>,<span class="hljs-keyword">this</span>.getHttpBasic(<span class="hljs-string">&quot;changgou&quot;</span>,<span class="hljs-string">&quot;changgou&quot;</span>));<br>        HttpEntity&lt;MultiValueMap&lt;String,String&gt;&gt; requestEntity = <span class="hljs-keyword">new</span> HttpEntity&lt;&gt;(body,headers);    <span class="hljs-comment">//body, header就是封装在这个里面的</span><br><br>        <span class="hljs-comment">//当后端出现了401,400.后端不对着两个异常编码进行处理,而是直接返回给前端</span><br>        restTemplate.setErrorHandler(<span class="hljs-keyword">new</span> DefaultResponseErrorHandler()&#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleError</span><span class="hljs-params">(ClientHttpResponse response)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>                <span class="hljs-keyword">if</span> (response.getRawStatusCode()!=<span class="hljs-number">400</span> &amp;&amp; response.getRawStatusCode() != <span class="hljs-number">401</span>)&#123;<br>                    <span class="hljs-keyword">super</span>.handleError(response);<br>                &#125;<br>            &#125;<br>        &#125;);<br><br>        <span class="hljs-comment">//发送请求</span><br>        ResponseEntity&lt;Map&gt; responseEntity = restTemplate.exchange(url, HttpMethod.POST, requestEntity, Map.class);<br>        Map map = responseEntity.getBody();<br>        System.out.println(map);<br><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getHttpBasic</span><span class="hljs-params">(String clientId, String clientSecret)</span> </span>&#123;<br>        String value =clientId+<span class="hljs-string">&quot;:&quot;</span>+clientSecret;<br>        <span class="hljs-keyword">byte</span>[] encode = Base64Utils.encode(value.getBytes());<br>        <span class="hljs-comment">//Basic Y2hhbmdnb3U6Y2hhbmdnb3U=</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Basic &quot;</span>+<span class="hljs-keyword">new</span> String(encode);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="5-3-4-业务层"><a href="#5-3-4-业务层" class="headerlink" title="5.3.4 业务层"></a>5.3.4 业务层</h4><p>AuthService接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">AuthService</span> </span>&#123;<br>    <span class="hljs-function">AuthToken <span class="hljs-title">login</span><span class="hljs-params">(String username, String password, String clientId, String clientSecret)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>AuthServiceImpl实现类：</p><p>基于刚才写的测试实现申请令牌的service方法如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AuthService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RestTemplate restTemplate;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> LoadBalancerClient loadBalancerClient;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;auth.ttl&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> ttl;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> AuthToken <span class="hljs-title">login</span><span class="hljs-params">(String username, String password, String clientId, String clientSecret)</span> </span>&#123;<br>        <span class="hljs-comment">//1.申请令牌</span><br>        ServiceInstance serviceInstance = loadBalancerClient.choose(<span class="hljs-string">&quot;user-auth&quot;</span>);<br>        URI uri = serviceInstance.getUri();<br>        String url=uri+<span class="hljs-string">&quot;/oauth/token&quot;</span>;<br><br>        MultiValueMap&lt;String, String&gt; body = <span class="hljs-keyword">new</span> LinkedMultiValueMap&lt;&gt;();<br>        body.add(<span class="hljs-string">&quot;grant_type&quot;</span>,<span class="hljs-string">&quot;password&quot;</span>);<br>        body.add(<span class="hljs-string">&quot;username&quot;</span>,username);<br>        body.add(<span class="hljs-string">&quot;password&quot;</span>,password);<br><br>        MultiValueMap&lt;String, String&gt; headers = <span class="hljs-keyword">new</span> LinkedMultiValueMap&lt;&gt;();<br>        headers.add(<span class="hljs-string">&quot;Authorization&quot;</span>,<span class="hljs-keyword">this</span>.getHttpBasic(clientId,clientSecret));<br>        HttpEntity&lt;MultiValueMap&lt;String,String&gt;&gt; requestEntity = <span class="hljs-keyword">new</span> HttpEntity&lt;&gt;(body,headers);<br><br>        restTemplate.setErrorHandler(<span class="hljs-keyword">new</span> DefaultResponseErrorHandler()&#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleError</span><span class="hljs-params">(ClientHttpResponse response)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>                <span class="hljs-keyword">if</span> (response.getRawStatusCode()!=<span class="hljs-number">400</span> &amp;&amp; response.getRawStatusCode()!=<span class="hljs-number">401</span>)&#123;<br>                    <span class="hljs-keyword">super</span>.handleError(response);<br>                &#125;<br>            &#125;<br>        &#125;);<br><br>        ResponseEntity&lt;Map&gt; responseEntity = restTemplate.exchange(url, HttpMethod.POST, requestEntity, Map.class);<br>        Map map = responseEntity.getBody();<br>        <span class="hljs-keyword">if</span> (map == <span class="hljs-keyword">null</span> || map.get(<span class="hljs-string">&quot;access_token&quot;</span>) == <span class="hljs-keyword">null</span> || map.get(<span class="hljs-string">&quot;refresh_token&quot;</span>) == <span class="hljs-keyword">null</span> || map.get(<span class="hljs-string">&quot;jti&quot;</span>) == <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-comment">//申请令牌失败</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;申请令牌失败&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">//2.封装结果数据</span><br>        AuthToken authToken = <span class="hljs-keyword">new</span> AuthToken();<br>        authToken.setAccessToken((String) map.get(<span class="hljs-string">&quot;access_token&quot;</span>));<br>        authToken.setRefreshToken((String) map.get(<span class="hljs-string">&quot;refresh_token&quot;</span>));<br>        authToken.setJti((String)map.get(<span class="hljs-string">&quot;jti&quot;</span>));<br><br>        <span class="hljs-comment">//3.将jti作为redis中的key,将jwt作为redis中的value进行数据的存放</span><br>        stringRedisTemplate.boundValueOps(authToken.getJti()).set(authToken.getAccessToken(),ttl, TimeUnit.SECONDS);<br>        <span class="hljs-keyword">return</span> authToken;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getHttpBasic</span><span class="hljs-params">(String clientId, String clientSecret)</span> </span>&#123;<br>        String value = clientId+<span class="hljs-string">&quot;:&quot;</span>+clientSecret;<br>        <span class="hljs-keyword">byte</span>[] encode = Base64Utils.encode(value.getBytes());<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Basic &quot;</span>+<span class="hljs-keyword">new</span> String(encode);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="5-3-5-控制层"><a href="#5-3-5-控制层" class="headerlink" title="5.3.5 控制层"></a>5.3.5 控制层</h4><p>AuthController编写用户登录授权方法，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/oauth&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> AuthService authService;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;auth.clientId&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String clientId;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;auth.clientSecret&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String clientSecret;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;auth.cookieDomain&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String cookieDomain;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;auth.cookieMaxAge&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> cookieMaxAge;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/login&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">login</span><span class="hljs-params">(String username, String password)</span></span>&#123;<br><br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(username))&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;用户名不存在&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(password))&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;密码不存在&quot;</span>);<br>        &#125;<br><br>        AuthToken authToken = authService.login(username,password,clientId,clientSecret);<br><br>        <span class="hljs-keyword">this</span>.saveJtiToCookie(authToken.getJti());<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>, StatusCode.OK,<span class="hljs-string">&quot;登录成功&quot;</span>);<br><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">saveJtiToCookie</span><span class="hljs-params">(String jti)</span> </span>&#123;<br>        HttpServletResponse response = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getResponse();<br>        CookieUtil.addCookie(response,cookieDomain,<span class="hljs-string">&quot;/&quot;</span>,<span class="hljs-string">&quot;uid&quot;</span>,jti,cookieMaxAge,<span class="hljs-keyword">false</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="5-3-6-登录请求放行"><a href="#5-3-6-登录请求放行" class="headerlink" title="5.3.6 登录请求放行"></a>5.3.6 登录请求放行</h4><p>修改认证服务WebSecurityConfig类中configure（），添加放行路径</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(WebSecurity web)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>    web.ignoring().antMatchers(<br>            <span class="hljs-string">&quot;/oauth/login&quot;</span>,<br>            <span class="hljs-string">&quot;/oauth/logout&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="5-3-7-测试认证接口"><a href="#5-3-7-测试认证接口" class="headerlink" title="5.3.7 测试认证接口"></a>5.3.7 测试认证接口</h4><p>使用postman测试：<a href="http://localhost:9200/oauth/login">http://localhost:9200/oauth/login</a></p><p><img src="/images/image-20210807144203187.png" alt="image-20210807144203187"></p><h4 id="5-3-8-动态获取用户信息"><a href="#5-3-8-动态获取用户信息" class="headerlink" title="5.3.8 动态获取用户信息"></a>5.3.8 动态获取用户信息</h4><p>当前在认证服务中，用户密码是写死在用户认证类中。所以用户登录时，无论帐号输入什么，只要密码是itheima都可以访问。 因此需要动态获取用户帐号与密码</p><ol><li><p>定义被访问接口</p><p>用户微服务changgou_service_user对外暴露根据用户名获取用户信息接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/load/&#123;username&#125;&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">findUserInfo</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;username&quot;)</span> String username)</span></span>&#123;<br>    <span class="hljs-keyword">return</span> userService.findById(username);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>放行该接口，修改用户微服务下的ResourceServerConfig类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>    <span class="hljs-comment">//所有请求必须认证通过</span><br>    http.authorizeRequests()<br>            <span class="hljs-comment">//下边的路径放行</span><br>            .antMatchers(<br>                    <span class="hljs-string">&quot;/user/add&quot;</span>,<span class="hljs-string">&quot;/user/load/**&quot;</span>). <span class="hljs-comment">//配置地址放行</span><br>            permitAll()<br>            .anyRequest().<br>            authenticated();    <span class="hljs-comment">//其他地址需要认证授权</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>定义feign接口</p><p>changgou_service_user_api新增feign接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name=&quot;user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserFeign</span> </span>&#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/user/load/&#123;username&#125;&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">findUserInfo</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;username&quot;)</span> String username)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>认证服务添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.changgou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>changgou_service_user_api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>修改认证服务启动类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableFeignClients(basePackages = &quot;com.changgou.user.feign&quot;)</span><br></code></pre></td></tr></table></figure></li><li><p>修改用户认证类</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">/*****</span><br><span class="hljs-comment"> * 自定义授权认证类</span><br><span class="hljs-comment"> */</span><br>@Service<br>public <span class="hljs-keyword">class</span> UserDetailsServiceImpl implements UserDetailsService &#123;<br><br>    @Autowired<br>    ClientDetailsService clientDetailsService;<br><br>    @Autowired<br>    <span class="hljs-keyword">private</span> UserFeign userFeign;<br><br>    <span class="hljs-comment">/****</span><br><span class="hljs-comment">     * 自定义授权认证</span><br><span class="hljs-comment">     * @param username</span><br><span class="hljs-comment">     * @return</span><br><span class="hljs-comment">     * @throws UsernameNotFoundException</span><br><span class="hljs-comment">     */</span><br>    @Override<br>    public UserDetails load<span class="hljs-constructor">UserByUsername(String <span class="hljs-params">username</span>)</span> throws UsernameNotFoundException &#123;<br>        <span class="hljs-comment">//取出身份，如果身份为空说明没有认证</span><br>        Authentication authentication = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SecurityContextHolder</span>.</span></span>get<span class="hljs-constructor">Context()</span>.get<span class="hljs-constructor">Authentication()</span>;<br>        <span class="hljs-comment">//没有认证统一采用httpbasic认证，httpbasic中存储了client_id和client_secret，开始认证client_id和client_secret</span><br>        <span class="hljs-keyword">if</span>(authentication==null)&#123;<br>            ClientDetails clientDetails = clientDetailsService.load<span class="hljs-constructor">ClientByClientId(<span class="hljs-params">username</span>)</span>;<br>            <span class="hljs-keyword">if</span>(clientDetails!=null)&#123;<br>                <span class="hljs-comment">//秘钥</span><br>                String clientSecret = clientDetails.get<span class="hljs-constructor">ClientSecret()</span>;<br>                <span class="hljs-comment">//静态方式</span><br>                <span class="hljs-comment">//return new User(username,new BCryptPasswordEncoder().encode(clientSecret), AuthorityUtils.commaSeparatedStringToAuthorityList(&quot;&quot;));</span><br>                <span class="hljs-comment">//数据库查找方式</span><br>                return <span class="hljs-keyword">new</span> <span class="hljs-constructor">User(<span class="hljs-params">username</span>,<span class="hljs-params">clientSecret</span>, AuthorityUtils.<span class="hljs-params">commaSeparatedStringToAuthorityList</span>(<span class="hljs-string">&quot;&quot;</span>)</span>);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">StringUtils</span>.</span></span>is<span class="hljs-constructor">Empty(<span class="hljs-params">username</span>)</span>) &#123;<br>            return null;<br>        &#125;<br><br>        <span class="hljs-comment">//根据用户名查询用户信息</span><br><span class="hljs-comment">//        String pwd = new BCryptPasswordEncoder().encode(&quot;itheima&quot;);</span><br>        com.changgou.user.pojo.User userInfo = userFeign.find<span class="hljs-constructor">UserInfo(<span class="hljs-params">username</span>)</span>;<br>        <span class="hljs-comment">//创建User对象</span><br>        String permissions = <span class="hljs-string">&quot;goods_list,seckill_list&quot;</span>;<br>        UserJwt userDetails = <span class="hljs-keyword">new</span> <span class="hljs-constructor">UserJwt(<span class="hljs-params">username</span>,<span class="hljs-params">userInfo</span>.<span class="hljs-params">getPassword</span>()</span>,<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AuthorityUtils</span>.</span></span>comma<span class="hljs-constructor">SeparatedStringToAuthorityList(<span class="hljs-params">permissions</span>)</span>);<br>        return userDetails;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><p>测试：localhost:9200/oauth/login</p><p>这次输入真正的用户名和密码（这里我测试失败了，感觉是密码有问题）</p><h2 id="6-认证服务对接网关"><a href="#6-认证服务对接网关" class="headerlink" title="6 认证服务对接网关"></a>6 认证服务对接网关</h2><h3 id="6-1-新建网关工程changgou-gateway-web"><a href="#6-1-新建网关工程changgou-gateway-web" class="headerlink" title="6.1 新建网关工程changgou_gateway_web"></a>6.1 新建网关工程changgou_gateway_web</h3><ol><li><p>changgou_gateway(网关的父工程)的pom文件添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--网关依赖--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>   <br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--redis--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis-reactive<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.3.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>新建工程changgou_gateway_web,并创建启动类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableEurekaClient</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebGatewayApplication</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(WebGatewayApplication.class,args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>创建application.yml (网管这里的路径配置还不熟，有时间加强)</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">gateway-web</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">globalcors:</span><br>        <span class="hljs-attr">cors-configurations:</span><br>          <span class="hljs-string">&#x27;[/**]&#x27;</span><span class="hljs-string">:</span> <span class="hljs-comment"># 匹配所有请求</span><br>            <span class="hljs-attr">allowedOrigins:</span> <span class="hljs-string">&quot;*&quot;</span> <span class="hljs-comment">#跨域处理 允许所有的域</span><br>            <span class="hljs-attr">allowedMethods:</span> <span class="hljs-comment"># 支持的方法</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">GET</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">POST</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">PUT</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">DELETE</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">changgou_goods_route</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://goods</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/album/**,/api/brand/**,/api/cache/**,/api/categoryBrand/**,/api/category/**,/api/para/**,/api/pref/**,/api/sku/**,/api/spec/**,/api/spu/**,/api/stockBack/**,/api/template/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-comment">#- PrefixPath=/brand</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br>          <span class="hljs-comment">#用户微服务</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">changgou_user_route</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://user</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/user/**,/api/address/**,/api/areas/**,/api/cities/**,/api/provinces/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br>          <span class="hljs-comment">#认证微服务</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">changgou_oauth_user</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://user-auth</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/oauth/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.128</span><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8001</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:6868/eureka</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">management:</span><br>  <span class="hljs-attr">endpoint:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">web:</span><br>      <span class="hljs-attr">exposure:</span><br>        <span class="hljs-attr">include:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure></li></ol><h3 id="6-2-网关全局过滤器"><a href="#6-2-网关全局过滤器" class="headerlink" title="6.2 网关全局过滤器"></a>6.2 网关全局过滤器</h3><p><img src="/images/image-20210807164927008.png" alt="image-20210807164927008"></p><p>新建过滤器类AuthorizeFilter,对请求进行过滤</p><p>业务逻辑：</p><ol><li>判断当前请求是否为登录请求，是的话，则放行</li><li>判断cookie中是否存在信息, 没有的话，拒绝访问</li><li>判断redis中令牌是否存在，没有的话，拒绝访问</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">GlobalFilter</span>, <span class="hljs-title">Ordered</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> AuthService authService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;<br>        ServerHttpRequest request = exchange.getRequest();<br>        ServerHttpResponse response = exchange.getResponse();<br><br>        <span class="hljs-comment">//1.判断当前请求路径是否为登录请求,如果是,则直接放行</span><br>        String path = request.getURI().getPath();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;/api/oauth/login&quot;</span>.equals(path) || !UrlFilter.hasAuthorize(path) )&#123;<br>            <span class="hljs-comment">//直接放行</span><br>            <span class="hljs-keyword">return</span> chain.filter(exchange);<br>        &#125;<br><br>        <span class="hljs-comment">//2.从cookie中获取jti的值,如果该值不存在,拒绝本次访问</span><br>        String jti = authService.getJtiFromCookie(request);<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(jti))&#123;<br>            <span class="hljs-comment">//拒绝访问</span><br>            response.setStatusCode(HttpStatus.UNAUTHORIZED);<br>            <span class="hljs-keyword">return</span> response.setComplete();<br>        &#125;<br><br>        <span class="hljs-comment">//3.从redis中获取jwt的值,如果该值不存在,拒绝本次访问</span><br>        String jwt = authService.getJwtFromRedis(jti);<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(jwt))&#123;<br>            <span class="hljs-comment">//拒绝访问</span><br>            response.setStatusCode(HttpStatus.UNAUTHORIZED);<br>            <span class="hljs-keyword">return</span> response.setComplete();<br>        &#125;<br><br>        <span class="hljs-comment">//4.对当前的请求对象进行增强,让它会携带令牌的信息</span><br>        request.mutate().header(<span class="hljs-string">&quot;Authorization&quot;</span>,<span class="hljs-string">&quot;Bearer &quot;</span>+jwt);<br>        <span class="hljs-keyword">return</span> chain.filter(exchange);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getOrder</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>新建业务逻辑类AuthService</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-comment">//从cookie中获取jti的值</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getJtiFromCookie</span><span class="hljs-params">(ServerHttpRequest request)</span> </span>&#123;<br>        HttpCookie httpCookie = request.getCookies().getFirst(<span class="hljs-string">&quot;uid&quot;</span>);<br>        <span class="hljs-keyword">if</span> (httpCookie != <span class="hljs-keyword">null</span>)&#123;<br>            String jti = httpCookie.getValue();<br>            <span class="hljs-keyword">return</span> jti;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//从redis中获取jwt</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getJwtFromRedis</span><span class="hljs-params">(String jti)</span> </span>&#123;<br>        String jwt = stringRedisTemplate.boundValueOps(jti).get();<br>        <span class="hljs-keyword">return</span> jwt;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>测试</p><p>访问：<a href="http://localhost:8001/api/oauth/login%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%8F%91%E7%8E%B0%E6%B5%8B%E8%AF%95%E9%80%9A%E8%BF%87%EF%BC%8C%E6%8B%BF%E5%88%B0%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%E6%95%B0%E6%8D%AE">http://localhost:8001/api/oauth/login，可以发现测试通过，拿到返回结果数据</a></p><p><img src="/images/image-20210807165333771.png" alt="image-20210807165333771"></p><h2 id="7-自定义登录页面"><a href="#7-自定义登录页面" class="headerlink" title="7 自定义登录页面"></a>7 自定义登录页面</h2><ol><li><p>认证服务添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--thymeleaf--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>把静态资源和页面放到changgou_user_auth微服务中</p><p><img src="/images/image-20210807172105423.png" alt="image-20210807172105423"></p></li><li><p>静态资源放行，修改WebSecurityConfig类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 忽略安全拦截的URL</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> web</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(WebSecurity web)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>    web.ignoring().antMatchers(<br>            <span class="hljs-string">&quot;/oauth/login&quot;</span>,<br>            <span class="hljs-string">&quot;/oauth/logout&quot;</span>,<br>            <span class="hljs-string">&quot;/oauth/toLogin&quot;</span>,<span class="hljs-string">&quot;/login.html&quot;</span>,<span class="hljs-string">&quot;/css/**&quot;</span>,<span class="hljs-string">&quot;/data/**&quot;</span>,<span class="hljs-string">&quot;/fonts/**&quot;</span>,<span class="hljs-string">&quot;/img/**&quot;</span>,<span class="hljs-string">&quot;/js/**&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>开启表单登录</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>    http.csrf().disable()<br>            .httpBasic()        <span class="hljs-comment">//启用Http基本身份验证</span><br>            .and()<br>            .formLogin()       <span class="hljs-comment">//启用表单身份验证</span><br>            .and()<br>            .authorizeRequests()    <span class="hljs-comment">//限制基于Request请求访问</span><br>            .anyRequest()<br>            .authenticated();       <span class="hljs-comment">//其他请求都需要经过验证</span><br>   <br>    http.formLogin().loginPage(<span class="hljs-string">&quot;/oauth/toLogin&quot;</span>)  <span class="hljs-comment">//设置访问登录页面的路径</span><br>            .loginProcessingUrl(<span class="hljs-string">&quot;/oauth/login&quot;</span>);  <span class="hljs-comment">//设置执行登录操作的路径</span><br>   <br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>在changgou_user_auth微服务中的AuthController类上怎加下面的访问路径</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/toLogin&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toLogin</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;login&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>修改login.html的登录页面, 并定义前端的login方法</p><p>100行开始</p><p><img src="/images/image-20210807173951504.png" alt="image-20210807173951504"></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-comment">&lt;!--script样式的修改放最后面--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">th:inline</span>=<span class="hljs-string">&quot;javascript&quot;</span>&gt;</span><span class="javascript"></span><br><span class="javascript"><span class="hljs-keyword">var</span> app = <span class="hljs-keyword">new</span> Vue(&#123;</span><br><span class="javascript"><span class="hljs-attr">el</span>:<span class="hljs-string">&quot;#app&quot;</span>,</span><br><span class="javascript"><span class="hljs-attr">data</span>:&#123;</span><br><span class="javascript"><span class="hljs-attr">username</span>:<span class="hljs-string">&quot;&quot;</span>,</span><br><span class="javascript"><span class="hljs-attr">password</span>:<span class="hljs-string">&quot;&quot;</span>,</span><br><span class="javascript"><span class="hljs-attr">msg</span>:<span class="hljs-string">&quot;&quot;</span></span><br><span class="javascript">&#125;,</span><br><span class="javascript"><span class="hljs-attr">methods</span>:&#123;</span><br><span class="javascript"><span class="hljs-attr">login</span>:<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;</span><br><span class="javascript">app.msg=<span class="hljs-string">&quot;正在登录&quot;</span>;</span><br><span class="javascript">axios.post(<span class="hljs-string">&quot;/api/oauth/login?username=&quot;</span>+app.username+<span class="hljs-string">&quot;&amp;password=&quot;</span>+app.password).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) </span>&#123;</span><br><span class="javascript"><span class="hljs-keyword">if</span> (response.data.flag)&#123;</span><br><span class="javascript">app.msg=<span class="hljs-string">&quot;登录成功&quot;</span>;</span><br><span class="javascript">&#125; <span class="hljs-keyword">else</span>&#123;</span><br><span class="javascript">app.msg=<span class="hljs-string">&quot;登录失败&quot;</span>;</span><br><span class="javascript">&#125;</span><br><span class="javascript">&#125;)</span><br><span class="javascript">&#125;</span><br><span class="javascript">&#125;</span><br><span class="javascript">&#125;)</span><br><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>定义路经过滤，方便统一授权资源</p><p><img src="/images/image-20210807174204477.png" alt="image-20210807174204477"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UrlFilter</span> </span>&#123;<br><br>    <span class="hljs-comment">//所有需要传递令牌的地址</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String filterPath=<span class="hljs-string">&quot;/api/wseckillorder,/api/seckill,/api/wxpay,/api/wxpay/**,/api/worder/**,/api/user/**,/api/address/**,/api/wcart/**,/api/cart/**,/api/categoryReport/**,/api/orderConfig/**,/api/order/**,/api/orderItem/**,/api/orderLog/**,/api/preferential/**,/api/returnCause/**,/api/returnOrder/**,/api/returnOrderItem/**&quot;</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">hasAuthorize</span><span class="hljs-params">(String url)</span></span>&#123;<br><br>        String[] split = filterPath.replace(<span class="hljs-string">&quot;**&quot;</span>, <span class="hljs-string">&quot;&quot;</span>).split(<span class="hljs-string">&quot;,&quot;</span>);<br><br>        <span class="hljs-keyword">for</span> (String value : split) &#123;<br><br>            <span class="hljs-keyword">if</span> (url.startsWith(value))&#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>; <span class="hljs-comment">//代表当前的访问地址是需要传递令牌的</span><br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>; <span class="hljs-comment">//代表当前的访问地址是不需要传递令牌的</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>最后进行测试</p><p>访问：<a href="http://localhost:9200/oauth/toLogin">http://localhost:9200/oauth/toLogin</a></p><p><img src="/images/image-20210807174443284.png" alt="image-20210807174443284"></p></li></ol>]]></content>
    
    
    <categories>
      
      <category>畅购商城项目</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>畅购商城项目第二部分</title>
    <link href="/2021/07/27/1.2%20%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/"/>
    <url>/2021/07/27/1.2%20%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/</url>
    
    <content type="html"><![CDATA[<h1 id="Part07-商品搜索"><a href="#Part07-商品搜索" class="headerlink" title="Part07 商品搜索"></a>Part07 商品搜索</h1><h2 id="1-根据关键字查询"><a href="#1-根据关键字查询" class="headerlink" title="1. 根据关键字查询"></a>1. 根据关键字查询</h2><ol><li><p>changgou_service_search项目创建SearchService接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SearchService</span> </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 全文检索</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> searchMap</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-comment">//他的实现类会抛异常，所以接口里也需要抛出异常</span><br>    <span class="hljs-function">Map <span class="hljs-title">search</span><span class="hljs-params">(Map&lt;String, String&gt; searchMap)</span> <span class="hljs-keyword">throws</span> Exception</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>changgou_service_search项目创建SearchService接口实现类SearchServiceImpl</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SearchServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">SearchService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ElasticsearchTemplate esTemplate;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Map <span class="hljs-title">search</span><span class="hljs-params">(Map&lt;String, String&gt; searchMap)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        Map&lt;String, Object&gt; resultMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br><br>        <span class="hljs-comment">//有条件才查询Es</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> != searchMap) &#123;<br>            <span class="hljs-comment">//组合条件对象</span><br>            BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();<br>            <span class="hljs-comment">//0:关键词</span><br>            <span class="hljs-keyword">if</span> (!StringUtils.isEmpty(searchMap.get(<span class="hljs-string">&quot;keywords&quot;</span>))) &#123;<br>                boolQuery.must(QueryBuilders.matchQuery(<span class="hljs-string">&quot;name&quot;</span>, searchMap.get(<span class="hljs-string">&quot;keywords&quot;</span>)).operator(Operator.AND));<br><br>            &#125;<br><br>            <span class="hljs-comment">//4. 原生搜索实现类</span><br>            NativeSearchQueryBuilder nativeSearchQueryBuilder = <span class="hljs-keyword">new</span> NativeSearchQueryBuilder();<br>            nativeSearchQueryBuilder.withQuery(boolQuery);<br><br>            <span class="hljs-comment">//10: 执行查询, 返回结果对象</span><br>            AggregatedPage&lt;SkuInfo&gt; aggregatedPage = esTemplate.queryForPage(nativeSearchQueryBuilder.build(), SkuInfo.class, <span class="hljs-keyword">new</span> SearchResultMapper() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">AggregatedPage&lt;T&gt; <span class="hljs-title">mapResults</span><span class="hljs-params">(SearchResponse searchResponse, Class&lt;T&gt; aClass, Pageable pageable)</span> </span>&#123;<br><br>                    List&lt;T&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br><br>                    SearchHits hits = searchResponse.getHits();<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> != hits) &#123;<br>                        <span class="hljs-keyword">for</span> (SearchHit hit : hits) &#123;<br>                            SkuInfo skuInfo = JSON.parseObject(hit.getSourceAsString(), SkuInfo.class);<br><br>                            list.add((T) skuInfo);<br>                        &#125;<br>                    &#125;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AggregatedPageImpl&lt;T&gt;(list, pageable, hits.getTotalHits(), searchResponse.getAggregations());<br>                &#125;<br>            &#125;);<br><br>            <span class="hljs-comment">//11. 总条数</span><br>            resultMap.put(<span class="hljs-string">&quot;total&quot;</span>, aggregatedPage.getTotalElements());<br>            <span class="hljs-comment">//12. 总页数</span><br>            resultMap.put(<span class="hljs-string">&quot;totalPages&quot;</span>, aggregatedPage.getTotalPages());<br>            <span class="hljs-comment">//13. 查询结果集合</span><br>            resultMap.put(<span class="hljs-string">&quot;rows&quot;</span>, aggregatedPage.getContent());<br><br>            <span class="hljs-keyword">return</span> resultMap;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>changgou_service_search项目创建SearchController</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/sku_search&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SearchController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ESManagerService esManagerService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SearchService searchService;<br><br>    <span class="hljs-comment">//对搜索入参带有特殊符号进行处理</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handlerSearchMap</span><span class="hljs-params">(Map&lt;String,String&gt; searchMap)</span></span>&#123;<br><br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">null</span> != searchMap)&#123;<br>            Set&lt;Map.Entry&lt;String, String&gt;&gt; entries = searchMap.entrySet();<br>            <span class="hljs-keyword">for</span> (Map.Entry&lt;String, String&gt; entry : entries) &#123;<br>                <span class="hljs-keyword">if</span>(entry.getKey().startsWith(<span class="hljs-string">&quot;spec_&quot;</span>))&#123;<br>                    searchMap.put(entry.getKey(),entry.getValue().replace(<span class="hljs-string">&quot;+&quot;</span>,<span class="hljs-string">&quot;%2B&quot;</span>));<br>                &#125;<br>            &#125;<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 全文检索</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Map <span class="hljs-title">search</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> Map&lt;String, String&gt; paramMap)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-comment">//特殊符号处理</span><br>        handlerSearchMap(paramMap);<br>        Map resultMap = searchService.search(paramMap);<br>        <span class="hljs-keyword">return</span> resultMap;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>测试</p><p>使用postmain访问 <a href="http://localhost:9009/sku_search?keywords=%E6%89%8B%E6%9C%BA">http://localhost:9009/sku_search?keywords=手机</a></p><p>虽然查询出9000多条结果，但是默认只显示10条数据</p><p><img src="/images/image-20210804195339008.png" alt="image-20210804195339008"></p></li></ol><h2 id="2-条件筛选"><a href="#2-条件筛选" class="headerlink" title="2 条件筛选"></a>2 条件筛选</h2><p><img src="/images/image-20210804195611466.png" alt="image-20210804195611466"></p><p>用户有可能会根据分类搜索、品牌搜索，还有可能根据规格搜索，以及价格搜索和排序操作。根据分类和品牌搜索的时候，可以直接根据指定域搜索，而规格搜索的域数据是不确定的，价格是一个区间搜索，所以我们可以分为三段实现，先实现分类、品牌搜素，再实现规格搜索，然后实现价格区间搜索。</p><h3 id="2-1-品牌筛选"><a href="#2-1-品牌筛选" class="headerlink" title="2.1 品牌筛选"></a>2.1 品牌筛选</h3><h4 id="2-1-1-需求分析"><a href="#2-1-1-需求分析" class="headerlink" title="2.1.1 需求分析"></a>2.1.1 需求分析</h4><p>页面每次向后台传入对应的分类和品牌，后台据分类和品牌进行条件过滤即可。</p><h4 id="2-1-2-代码实现"><a href="#2-1-2-代码实现" class="headerlink" title="2.1.2 代码实现"></a>2.1.2 代码实现</h4><p>修改搜索微服务com.changgou.service.SearchServiceImpl的搜索方法，添加品牌过滤</p><p>增加品牌筛选部分 (后面增加部分也都用序号来表示先后顺序) 的代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//1:条件 品牌</span><br><span class="hljs-keyword">if</span> (StringUtils.isNotEmpty(searchMap.get(<span class="hljs-string">&quot;brand&quot;</span>))) &#123;<br>    <span class="hljs-comment">//按照品牌进行过滤查询。这里的brandName是索引库中的一个域值，不是随便写的名字</span><br>    boolQuery.filter(QueryBuilders.termQuery(<span class="hljs-string">&quot;brandName&quot;</span>, searchMap.get(<span class="hljs-string">&quot;brand&quot;</span>)));<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-1-3-测试"><a href="#2-1-3-测试" class="headerlink" title="2.1.3 测试"></a>2.1.3 测试</h4><p>访问地址：<a href="http://localhost:9009/sku_search?keywords=%E6%89%8B%E6%9C%BA&amp;brand=%E5%8D%8E%E4%B8%BA">http://localhost:9009/sku_search?keywords=手机&amp;brand=华为</a></p><p>结果如下：</p><p>可以看到比第一次的数据少了几千条</p><p><img src="/images/image-20210804201208277.png" alt="image-20210804201208277"></p><h3 id="2-2-规格过滤"><a href="#2-2-规格过滤" class="headerlink" title="2.2 规格过滤"></a>2.2 规格过滤</h3><h4 id="2-2-1-需求分析"><a href="#2-2-1-需求分析" class="headerlink" title="2.2.1 需求分析"></a>2.2.1 需求分析</h4><p><img src="/images/image-20210804195611466-1628079276433.png" alt="image-20210804195611466"></p><p>规格这一部分，需要向后台发送规格名字以及规格值，我们可以按照一定要求来发送数据，例如规格名字以特殊前缀提交到后台：<code>spec_网络制式：电信4G、spec_显示屏尺寸：4.0-4.9英寸</code></p><p>后台接到数据后，可以根据前缀spec_来区分是否是规格，如果以<code>spec_xxx</code>开始的数据则为规格数据，需要根据指定规格找信息。</p><p><img src="/images/image-20210804201759706.png" alt="image-20210804201759706"></p><p>上图是规格的索引存储格式，真实数据在spechMap.规格名字.keyword（这个是规格的域）中，所以找数据也是按照如下格式去找：</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gauss">spechMap.规格名字.<span class="hljs-keyword">keyword</span><br></code></pre></td></tr></table></figure><h4 id="2-2-2-代码实现"><a href="#2-2-2-代码实现" class="headerlink" title="2.2.2 代码实现"></a>2.2.2 代码实现</h4><p>修改com.changgou.service.SearchServiceImpl的搜索方法，增加规格查询操作</p><p>增加部分的代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//2:条件 规格</span><br><span class="hljs-keyword">for</span> (String key : searchMap.keySet()) &#123;<br>    <span class="hljs-keyword">if</span> (key.startsWith(<span class="hljs-string">&quot;spec_&quot;</span>)) &#123;<br>        <span class="hljs-comment">//发送请求的路径会涉及到编码和解码，如果不设置下面这一步，传递过来的路径就是错误的</span><br>        String value = searchMap.get(key).replace(<span class="hljs-string">&quot;%2B&quot;</span>, <span class="hljs-string">&quot;+&quot;</span>);<br>        boolQuery.filter(QueryBuilders.termQuery(<span class="hljs-string">&quot;specMap.&quot;</span> + key.substring(<span class="hljs-number">5</span>) + <span class="hljs-string">&quot;.keyword&quot;</span>,value));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-2-3-测试"><a href="#2-2-3-测试" class="headerlink" title="2.2.3 测试"></a>2.2.3 测试</h4><p>访问地址：<a href="http://localhost:9009/sku_search?keywords=%E7%94%B5%E8%A7%86&amp;spec_%E5%B0%BA%E5%AF%B8=%E9%87%91%E8%89%B2">http://localhost:9009/sku_search?keywords=电视&amp;spec_尺寸=金色</a></p><p><img src="/images/image-20210804211201850.png" alt="image-20210804211201850"></p><h3 id="2-3-聚合（分组）查询"><a href="#2-3-聚合（分组）查询" class="headerlink" title="2.3 聚合（分组）查询"></a>2.3 聚合（分组）查询</h3><h4 id="2-3-1-需求分析"><a href="#2-3-1-需求分析" class="headerlink" title="2.3.1 需求分析"></a>2.3.1 需求分析</h4><p><img src="/images/image-20210804195611466-1628083462378.png" alt="image-20210804195611466"></p><p>根据查询的结果返回一个brandList给前端，用于更新品牌展示和规格展示</p><h4 id="2-3-2-代码实现"><a href="#2-3-2-代码实现" class="headerlink" title="2.3.2 代码实现"></a>2.3.2 代码实现</h4><p>1）品牌聚合</p><p>修改com.changgou.service.SearchServiceImpl的搜索方法，增加品牌聚合操作</p><p>增加的代码部分如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//6. 品牌聚合(分组)查询</span><br>String skuBrand = <span class="hljs-string">&quot;skuBrand&quot;</span>;<br><span class="hljs-comment">// terms(skuBrand)设置分组查询之后的列名为skuBrand， field(&quot;brandName&quot;)当前要来操作的分组域</span><br>nativeSearchQueryBuilder.addAggregation(AggregationBuilders.terms(skuBrand).field(<span class="hljs-string">&quot;brandName&quot;</span>));<br><br><span class="hljs-comment">//14. 获取品牌聚合结果</span><br>StringTerms brandTerms = (StringTerms) aggregatedPage.getAggregation(skuBrand);<br><span class="hljs-comment">//流运算，比原始for循环效率高很多</span><br>List&lt;String&gt; brandList = brandTerms.getBuckets().stream().map(bucket -&gt; bucket.getKeyAsString()).collect(Collectors.toList());<br>resultMap.put(<span class="hljs-string">&quot;brandList&quot;</span>, brandList);<br></code></pre></td></tr></table></figure><p>2）规格聚合</p><p>修改com.changgou.service.SearchServiceImpl的搜索方法，增加规格聚合操作</p><p>增加的代码部分如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//7. 规格聚合(分组)查询</span><br>String skuSpec = <span class="hljs-string">&quot;skuSpec&quot;</span>;<br>nativeSearchQueryBuilder.addAggregation(AggregationBuilders.terms(skuSpec).field(<span class="hljs-string">&quot;spec.keyword&quot;</span>));<br><br><span class="hljs-comment">//15. 获取规格聚合结果</span><br>StringTerms specTerms = (StringTerms) aggregatedPage.getAggregation(skuSpec);<br>List&lt;String&gt; specList = specTerms.getBuckets().stream().map(bucket -&gt; bucket.getKeyAsString()).collect(Collectors.toList());<br>resultMap.put(<span class="hljs-string">&quot;specList&quot;</span>, specList);<br><br><span class="hljs-keyword">return</span> resultMap;<br></code></pre></td></tr></table></figure><h4 id="2-3-3-测试"><a href="#2-3-3-测试" class="headerlink" title="2.3.3 测试"></a>2.3.3 测试</h4><p>访问地址：<a href="http://localhost:9009/sku_search?keywords=%E7%94%B5%E8%A7%86">http://localhost:9009/sku_search?keywords=电视</a></p><p>可以看到结果多出来一个brandList</p><p><img src="/images/image-20210804212744912.png" alt="image-20210804212744912"></p><p>访问地址：<a href="http://localhost:9009/sku_search?spec_%E5%B0%BA%E5%AF%B8=%E9%87%91%E8%89%B2">http://localhost:9009/sku_search?spec_尺寸=金色</a></p><p>可以看到结果多出来一个specList</p><p><img src="/images/image-20210804213513056.png" alt="image-20210804213513056"></p><h3 id="2-4-价格区间查询"><a href="#2-4-价格区间查询" class="headerlink" title="2.4 价格区间查询"></a>2.4 价格区间查询</h3><h4 id="2-4-1-需求分析"><a href="#2-4-1-需求分析" class="headerlink" title="2.4.1 需求分析"></a>2.4.1 需求分析</h4><p><img src="/images/image-20210804195611466-1628083462378.png" alt="image-20210804195611466"></p><p>价格区间查询，每次需要将价格传入到后台，前端传入后台的价格大概是<code>price=0-500</code>或者<code>price=500-1000</code>依次类推，最后一个是<code>price=3000</code>,后台可以根据-分割，如果分割得到的结果最多有2个，第1个表示<code>x&lt;price</code>，第2个表示<code>price&lt;=y</code>。</p><h4 id="2-4-2-代码实现"><a href="#2-4-2-代码实现" class="headerlink" title="2.4.2 代码实现"></a>2.4.2 代码实现</h4><p>修改com.changgou.service.impl.SearchServiceImpl的搜索方法，增加价格区间查询操作</p><p>增加的部分代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//3:条件 价格</span><br><span class="hljs-keyword">if</span> (StringUtils.isNotEmpty(searchMap.get(<span class="hljs-string">&quot;price&quot;</span>))) &#123;<br>    String[] p = searchMap.get(<span class="hljs-string">&quot;price&quot;</span>).split(<span class="hljs-string">&quot;-&quot;</span>);<br>    <span class="hljs-keyword">if</span> (p.length == <span class="hljs-number">2</span>) &#123;<br>        boolQuery.filter(QueryBuilders.rangeQuery(<span class="hljs-string">&quot;price&quot;</span>).lte(p[<span class="hljs-number">1</span>]));<br>    &#125;  boolQuery.filter(QueryBuilders.rangeQuery(<span class="hljs-string">&quot;price&quot;</span>).gte(p[<span class="hljs-number">0</span>]));<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-4-3-测试"><a href="#2-4-3-测试" class="headerlink" title="2.4.3 测试"></a>2.4.3 测试</h4><p>访问地址：<a href="http://localhost:9009/sku_search?price=0-500">http://localhost:9009/sku_search?price=0-500</a></p><p>可以看到价格均在这个区间</p><p><img src="/images/image-20210804220238483.png" alt="image-20210804220238483"></p><h2 id="3-搜索分页"><a href="#3-搜索分页" class="headerlink" title="3. 搜索分页"></a>3. 搜索分页</h2><h3 id="3-1-分页分析"><a href="#3-1-分页分析" class="headerlink" title="3.1 分页分析"></a>3.1 分页分析</h3><p><img src="/images/image-20210804230948101.png" alt="image-20210804230948101"></p><p>页面需要实现分页搜索，所以我们后台每次查询的时候，需要实现分页。用户页面每次会传入当前页和每页查询多少条数据，当然如果不传入每页显示多少条数据，默认查询30条即可。</p><p>前端需要传递过来两个参数，分别是当前页数和每页传递多少条数据</p><h3 id="3-2-分页实现"><a href="#3-2-分页实现" class="headerlink" title="3.2 分页实现"></a>3.2 分页实现</h3><p>分页使用PageRequest.of( pageNo- 1, pageSize);实现，第1个参数表示第N页，从0开始，第2个参数表示每页显示多少条</p><p>增加的部分代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//9: 分页</span><br>String pageNum = searchMap.get(<span class="hljs-string">&quot;pageNum&quot;</span>); <span class="hljs-comment">//当前页</span><br>String pageSize = searchMap.get(<span class="hljs-string">&quot;pageSize&quot;</span>); <span class="hljs-comment">//每页显示多少条</span><br><span class="hljs-comment">//如果前端没有传递，进行默认值设置</span><br><span class="hljs-keyword">if</span> (StringUtils.isEmpty(pageNum)) &#123;<br>    pageNum = <span class="hljs-string">&quot;1&quot;</span>;<br>&#125;<br><span class="hljs-keyword">if</span>(StringUtils.isEmpty(pageSize))&#123;<br>    pageSize = <span class="hljs-string">&quot;30&quot;</span>;<br>&#125;<br>nativeSearchQueryBuilder.withPageable(PageRequest.of(Integer.parseInt(pageNum) - <span class="hljs-number">1</span>, Integer.parseInt(pageSize)));<br><br><span class="hljs-comment">//16. 返回当前页</span><br>resultMap.put(<span class="hljs-string">&quot;pageNum&quot;</span>, pageNum);<br></code></pre></td></tr></table></figure><p>测试地址：<a href="http://localhost:9009/sku_search?pageNum=1&amp;pageSize=20">http://localhost:9009/sku_search?pageNum=1&amp;pageSize=20</a></p><p>可以看到总页数不再是1了，其实翻到最下面可以看到当前页为1，但是图片中就不放出来了</p><p><img src="/images/image-20210804232503168.png" alt="image-20210804232503168"></p><h2 id="4-搜索排序"><a href="#4-搜索排序" class="headerlink" title="4. 搜索排序"></a>4. 搜索排序</h2><h3 id="4-1-排序分析"><a href="#4-1-排序分析" class="headerlink" title="4.1 排序分析"></a>4.1 排序分析</h3><p><img src="/images/image-20210804232701584.png" alt="image-20210804232701584"></p><p>排序这里总共有根据价格排序、根据评价排序、根据新品排序、根据销量排序，排序要想实现非常简单，只需要告知排序的域以及排序方式即可实现。</p><p>价格排序：只需要根据价格高低排序即可，降序价格高-&gt;低，升序价格低-&gt;高</p><p>评价排序：评价分为好评、中评、差评，可以在数据库中设计3个列，用来记录好评、中评、差评的量，每次排序的时候，好评的比例来排序，当然还要有条数限制，评价条数需要超过N条。</p><p>新品排序：直接根据商品的发布时间或者更新时间排序。</p><p>销量排序：销量排序除了销售数量外，还应该要有时间段限制。</p><h3 id="4-2-排序实现"><a href="#4-2-排序实现" class="headerlink" title="4.2 排序实现"></a>4.2 排序实现</h3><p>这里我们不单独针对某个功能实现排序，我们只需要在后台接收2个参数，分别是排序域名字和排序方式</p><p>增加部分的代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//8: 排序</span><br><span class="hljs-keyword">if</span> (!StringUtils.isEmpty(searchMap.get(<span class="hljs-string">&quot;sortField&quot;</span>))) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;ASC&quot;</span>.equals(searchMap.get(<span class="hljs-string">&quot;sortRule&quot;</span>))) &#123;<br>        nativeSearchQueryBuilder.withSort(SortBuilders.fieldSort(searchMap.get(<span class="hljs-string">&quot;sortField&quot;</span>)).order(SortOrder.ASC));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        nativeSearchQueryBuilder.withSort(SortBuilders.fieldSort(searchMap.get(<span class="hljs-string">&quot;sortField&quot;</span>)).order(SortOrder.DESC));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>测试路径：<a href="http://localhost:9009/sku_search?pageNum=1&amp;pageSize=1000&amp;sortField=price&amp;sortOrder=DESC">http://localhost:9009/sku_search?pageNum=1&amp;pageSize=1000&amp;sortField=price&amp;sortOrder=DESC</a></p><p>按照价格降序排序，每页显示1000条数据</p><h2 id="5-高亮显示"><a href="#5-高亮显示" class="headerlink" title="5. 高亮显示"></a>5. 高亮显示</h2><h3 id="5-1-高亮分析"><a href="#5-1-高亮分析" class="headerlink" title="5.1 高亮分析"></a>5.1 高亮分析</h3><p><img src="/images/image-20210804233916692.png" alt="image-20210804233916692"></p><p>高亮显示是指根据商品关键字搜索商品的时候，显示的页面对关键字给定了特殊样式，让它显示更加突出，如上图商品搜索中，关键字编程了红色，其实就是给定了红色样式。</p><h3 id="5-2-高亮搜索实现步骤解析"><a href="#5-2-高亮搜索实现步骤解析" class="headerlink" title="5.2 高亮搜索实现步骤解析"></a>5.2 高亮搜索实现步骤解析</h3><p>将之前的搜索换掉，换成高亮搜索，我们需要做3个步骤：</p><ol><li>指定高亮域，也就是设置哪个域需要高亮显示。设置高亮域的时候，需要指定前缀和后缀，也就是关键词用什么html标签包裹，再给该标签</li><li>高亮搜索实现</li><li>将非高亮数据替换成高亮数据</li></ol><p>第1点，例如在百度中搜索数据的时候，会有2个地方高亮显示，分别是标题和描述，商城搜索的时候，只是商品名称高亮显示了。而高亮显示其实就是添加了样式，例如<code>&lt;span style=&quot;color:red;&quot;&gt;笔记本&lt;/span&gt;</code>,而其中span开始标签可以称为前缀，span结束标签可以称为后缀。</p><p>第2点，高亮搜索使用ElasticsearchTemplate实现。</p><p>第3点，高亮搜索后，会搜出非高亮数据和高亮数据，高亮数据会加上第1点中的高亮样式，此时我们需要将非高亮数据换成高亮数据即可。例如非高亮:<code>华为笔记本性能超强悍</code> 高亮数据：<code>华为&lt;span style=&quot;color:red;&quot;笔记本&lt;/span&gt;性能超强悍</code>,将非高亮的换成高亮的，到页面就能显示样式了。</p><h3 id="5-3-高亮代码实现"><a href="#5-3-高亮代码实现" class="headerlink" title="5.3 高亮代码实现"></a>5.3 高亮代码实现</h3><p>删掉之前com.changgou.service.impl.SearchServiceImpl的搜索方法搜索代码，用下面高亮搜索代码替换：</p><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//5:高亮</span><br>HighlightBuilder.Field field = <span class="hljs-keyword">new</span> HighlightBuilder<br>        .Field(<span class="hljs-string">&quot;name&quot;</span>)<br>        .preTags(<span class="hljs-string">&quot;&lt;span style=&#x27;color:red&#x27;&gt;&quot;</span>)<br>        .postTags(<span class="hljs-string">&quot;&lt;/span&gt;&quot;</span>);<br>nativeSearchQueryBuilder.withHighlightFields(field);<br><br><br><span class="hljs-comment">//10: 执行查询, 返回结果对象</span><br>AggregatedPage&lt;SkuInfo&gt; aggregatedPage = esTemplate.queryForPage(nativeSearchQueryBuilder.build(), SkuInfo.class, <span class="hljs-keyword">new</span> SearchResultMapper() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">AggregatedPage&lt;T&gt; <span class="hljs-title">mapResults</span><span class="hljs-params">(SearchResponse searchResponse, Class&lt;T&gt; aClass, Pageable pageable)</span> </span>&#123;<br><br>        List&lt;T&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br><br>        SearchHits hits = searchResponse.getHits();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> != hits) &#123;<br>            <span class="hljs-keyword">for</span> (SearchHit hit : hits) &#123;<br>                SkuInfo skuInfo = JSON.parseObject(hit.getSourceAsString(), SkuInfo.class);<br>                <span class="hljs-comment">//========设置高亮域==========</span><br>                Map&lt;String, HighlightField&gt; highlightFields = hit.getHighlightFields();<br>                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> != highlightFields &amp;&amp; highlightFields.size() &gt; <span class="hljs-number">0</span>) &#123;<br>                    skuInfo.setName(highlightFields.get(<span class="hljs-string">&quot;name&quot;</span>).getFragments()[<span class="hljs-number">0</span>].toString());<br>                &#125;<br>                <span class="hljs-comment">//===========================</span><br>                list.add((T) skuInfo);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AggregatedPageImpl&lt;T&gt;(list, pageable, hits.getTotalHits(), searchResponse.getAggregations());<br>    &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p>测试路径：<a href="http://localhost:9009/sku_search?pageNum=1&amp;pageSize=1000&amp;sortField=price&amp;sortOrder=DESC&amp;keywords=%E7%94%B5%E8%84%91">http://localhost:9009/sku_search?pageNum=1&amp;pageSize=1000&amp;sortField=price&amp;sortOrder=DESC&amp;keywords=电脑</a></p><p>会发现返回结果关键字电脑前后加上了标签，如果是在浏览器上，将会高亮</p><p><img src="/images/image-20210804235641430.png" alt="image-20210804235641430"></p><h1 id="Part08-Thymeleaf"><a href="#Part08-Thymeleaf" class="headerlink" title="Part08 Thymeleaf"></a>Part08 Thymeleaf</h1><h2 id="1-Thymeleaf介绍"><a href="#1-Thymeleaf介绍" class="headerlink" title="1. Thymeleaf介绍"></a>1. Thymeleaf介绍</h2><p>thymeleaf是一个XML/XHTML/HTML5模板引擎，可用于Web与非Web环境中的应用开发。它是一个开源的Java库，基于Apache License 2.0许可，由Daniel Fernández创建，该作者还是Java加密库Jasypt的作者。</p><p>Thymeleaf提供了一个用于整合Spring MVC的可选模块，在应用开发中，你可以使用Thymeleaf来完全代替JSP或其他模板引擎，如Velocity、FreeMarker等。Thymeleaf的主要目标在于提供一种可被浏览器正确显示的、格式良好的模板创建方式，因此也可以用作静态建模。你可以使用它创建经过验证的XML与HTML模板。相对于编写逻辑或代码，开发者只需将标签属性添加到模板中即可。接下来，这些标签属性就会在DOM（文档对象模型）上执行预先制定好的逻辑。</p><p>它的特点便是：开箱即用，Thymeleaf允许您处理六种模板，每种模板称为模板模式：</p><ul><li>XML</li><li>有效的XML</li><li>XHTML</li><li>有效的XHTML</li><li>HTML5</li><li>旧版HTML5</li></ul><p>所有这些模式都指的是格式良好的XML文件，但<em>Legacy HTML5</em>模式除外，它允许您处理HTML5文件，其中包含独立（非关闭）标记，没有值的标记属性或不在引号之间写入的标记属性。为了在这种特定模式下处理文件，Thymeleaf将首先执行转换，将您的文件转换为格式良好的XML文件，这些文件仍然是完全有效的HTML5（实际上是创建HTML5代码的推荐方法）<a href="https://www.thymeleaf.org/doc/tutorials/2.1/usingthymeleaf.html#fn1">1</a>。</p><p>另请注意，验证仅适用于XML和XHTML模板。</p><p>然而，这些并不是Thymeleaf可以处理的唯一模板类型，并且用户始终能够通过指定在此模式下<em>解析</em>模板的方法和<em>编写</em>结果的方式来定义他/她自己的模式。这样，任何可以建模为DOM树（无论是否为XML）的东西都可以被Thymeleaf有效地作为模板处理。</p><h2 id="2-Springboot整合thymeleaf"><a href="#2-Springboot整合thymeleaf" class="headerlink" title="2. Springboot整合thymeleaf"></a>2. Springboot整合thymeleaf</h2><p>使用springboot 来集成使用Thymeleaf可以大大减少单纯使用thymleaf的代码量，所以我们接下来使用springboot集成使用thymeleaf.</p><p>实现的步骤为：</p><ul><li>创建一个sprinboot项目</li><li>添加thymeleaf的起步依赖</li><li>添加spring web的起步依赖</li><li>编写html 使用thymleaf的语法获取变量对应后台传递的值</li><li>编写controller 设置变量的值到model中</li></ul><p>具体代码如下</p><ol><li><p>创建工程，添加pom依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--web起步依赖--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>   <br>    <span class="hljs-comment">&lt;!--thymeleaf配置--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>创建启动类(我这里的名字起的比较随意)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestApplication</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(TestApplication.class, args);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>创建application.yml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">thymeleaf:</span><br>    <span class="hljs-attr">cache:</span> <span class="hljs-literal">false</span> <span class="hljs-comment"># 设置thymeleaf的缓存为false</span><br></code></pre></td></tr></table></figure></li><li><p>创建controller用于测试后台 设置数据到model中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span>  <span class="hljs-comment">// 这里是需要跳转到demo.html页面，不是返回数据，所以用的是@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/test&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestController</span> </span>&#123;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">hello</span><span class="hljs-params">(Model model)</span></span>&#123;<br>        model.addAttribute(<span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-string">&quot;hello thymeleaf&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;demo&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>创建demo.html到resources.templates包下 （注意templates这个包名是固定的，不能乱写）</p><p>注意：</p><ul><li><code>xmlns:th=&quot;http://www.thymeleaf.org&quot;</code>这句声明使用thymeleaf标签, 不能忘了</li><li><code>th:text=&quot;$&#123;hello&#125;</code>使用了EL表达式，通过“hello”这个键获取他的值，controller中已经设置了他的值为“hello thymeleaf”</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span> <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Thymeleaf快速入门<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;hello&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>测试</p><p>访问请求路径：<a href="http://localhost:8080/test/hello">http://localhost:8080/test/hello</a></p><p><img src="/images/image-20210805124816251.png" alt="image-20210805124816251"></p></li></ol><h2 id="3-Thymeleaf基本语法"><a href="#3-Thymeleaf基本语法" class="headerlink" title="3. Thymeleaf基本语法"></a>3. Thymeleaf基本语法</h2><h3 id="3-1-提交表单（th-action）"><a href="#3-1-提交表单（th-action）" class="headerlink" title="3.1 提交表单（th:action）"></a>3.1 提交表单（th:action）</h3><p>编写标签</p><p>注意：</p><ul><li><code>@&#123;/test/hello&#125;</code>定义了表单提交路径</li><li><code>th:type=&quot;text&quot;</code>表明这是一个文本框输入标签</li><li><code>th:name=&quot;id&quot;</code>表明文本框的键的名称为id, 记得传递到控制器方法的形参也要定义为id</li><li><code>&lt;button&gt;提交&lt;/button&gt;</code>定义按钮，名称叫提交</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">th:action</span>=<span class="hljs-string">&quot;@&#123;/test/hello&#125;&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">th:type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">th:name</span>=<span class="hljs-string">&quot;id&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br></code></pre></td></tr></table></figure><p>编写相应的控制类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/hello&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">hello</span><span class="hljs-params">(Model model, String id)</span></span>&#123;<br>    System.out.println(id);<br>    model.addAttribute(<span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-string">&quot;hello thymeleaf&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;demo&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>测试路径：<a href="http://localhost:8080/test/hello">http://localhost:8080/test/hello</a></p><h3 id="3-2-对象遍历（th-each）"><a href="#3-2-对象遍历（th-each）" class="headerlink" title="3.2 对象遍历（th:each）"></a>3.2 对象遍历（th:each）</h3><p>创建包pojo，代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>&#123;    <br>    <span class="hljs-keyword">private</span> Integer id;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> String address;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getId</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setId</span><span class="hljs-params">(Integer id)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(String name)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getAddress</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> address;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAddress</span><span class="hljs-params">(String address)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.address = address;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Controller中添加数据</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/test&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestController</span> </span>&#123;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">hello</span><span class="hljs-params">(Model model, String id)</span></span>&#123;<br>        model.addAttribute(<span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-string">&quot;hello thymeleaf&quot;</span>);<br><br>        List&lt;User&gt; users = <span class="hljs-keyword">new</span> ArrayList&lt;User&gt;();<br>        users.add(<span class="hljs-keyword">new</span> User(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;张三&quot;</span>, <span class="hljs-string">&quot;深圳&quot;</span>));<br>        users.add(<span class="hljs-keyword">new</span> User(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;李四&quot;</span>, <span class="hljs-string">&quot;北京&quot;</span>));<br>        users.add(<span class="hljs-keyword">new</span> User(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;王五&quot;</span>, <span class="hljs-string">&quot;武汉&quot;</span>));<br>        model.addAttribute(<span class="hljs-string">&quot;users&quot;</span>,users);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;demo&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>编写页面标签</p><p>注意：</p><ul><li><code>th:each=&quot;user, userStat:$&#123;users&#125;</code>, th:each表示开启遍历， user表示这个集合中的每一个对象，${users}表示从Model里面拿到的从控制器传递过来的集合，users表示给这个集合取一个集合变量名</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs html">    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>下标<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>编号<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>姓名<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>住址<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">tr</span> <span class="hljs-attr">th:each</span>=<span class="hljs-string">&quot;user, users:$&#123;users&#125;&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><br>            下标：<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;userStat.index&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;user.id&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;user.name&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;user.address&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><br></code></pre></td></tr></table></figure><p>测试路径：<a href="http://localhost:8080/test/hello">http://localhost:8080/test/hello</a></p><h3 id="3-3-遍历Map集合"><a href="#3-3-遍历Map集合" class="headerlink" title="3.3 遍历Map集合"></a>3.3 遍历Map集合</h3><p>Controller中添加map集合</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Map&lt;String,Object&gt; dataMap = <span class="hljs-keyword">new</span> HashMap&lt;String,Object&gt;();<br>dataMap.put(<span class="hljs-string">&quot;No&quot;</span>,<span class="hljs-string">&quot;123&quot;</span>);<br>dataMap.put(<span class="hljs-string">&quot;address&quot;</span>,<span class="hljs-string">&quot;深圳&quot;</span>);<br>model.addAttribute(<span class="hljs-string">&quot;dataMap&quot;</span>,dataMap);<br></code></pre></td></tr></table></figure><p>编写标签语言</p><p>注意： </p><ul><li><code>th:text=&quot;$&#123;map&#125;&quot;</code>会将键值对以 key=value 的形式呈现在浏览器上</li><li><code>$&#123;mapStat.current.key&#125;</code>获取键和值的时候，中间都带了个current</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">th:each</span>=<span class="hljs-string">&quot;map,mapStat:$&#123;dataMap&#125;&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;map&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    key:<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;mapStat.current.key&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>    value:<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;mapStat.current.value&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>    ==============================================<br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure><p>测试路径：<a href="http://localhost:8080/test/hello">http://localhost:8080/test/hello</a></p><p><img src="/images/image-20210805133846850.png" alt="image-20210805133846850"></p><h3 id="3-4-遍历数组"><a href="#3-4-遍历数组" class="headerlink" title="3.4 遍历数组"></a>3.4 遍历数组</h3><p>Controller中添加数组</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//存储一个数组</span><br>String[] names = &#123;<span class="hljs-string">&quot;张三&quot;</span>,<span class="hljs-string">&quot;李四&quot;</span>,<span class="hljs-string">&quot;王五&quot;</span>&#125;;<br>model.addAttribute(<span class="hljs-string">&quot;names&quot;</span>,names);<br></code></pre></td></tr></table></figure><p>编写标签</p><p>注意：</p><ul><li><code>nmStat.count</code>中的count是从1开始计数的，如果换成<code>nmStat.index</code>则是从0开始计数的</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">th:each</span>=<span class="hljs-string">&quot;nm,nmStat:$&#123;names&#125;&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;nmStat.count&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;nm&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>    ==============================================<br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure><p>测试路径：<a href="http://localhost:8080/test/hello">http://localhost:8080/test/hello</a></p><p><img src="/images/image-20210805134433640.png" alt="image-20210805134433640"></p><h3 id="3-5-Date输出"><a href="#3-5-Date输出" class="headerlink" title="3.5 Date输出"></a>3.5 Date输出</h3><p>后台添加日期</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//日期</span><br>model.addAttribute(<span class="hljs-string">&quot;now&quot;</span>,<span class="hljs-keyword">new</span> Date());<br></code></pre></td></tr></table></figure><p>编写标签</p><p>注意：</p><ul><li><code>#dates.format</code>表示调用thymeleaf中的方法</li><li><code>now</code>是从控制器返回过来的键值对中的键</li><li><code>&#39;yyyy-MM-dd hh:ss:mm&#39;</code>设置要显示的日期格式</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;#dates.format(now,&#x27;yyyy-MM-dd hh:ss:mm&#x27;)&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure><p>测试路径：<a href="http://localhost:8080/test/hello">http://localhost:8080/test/hello</a></p><p><img src="/images/image-20210805135336701.png" alt="image-20210805135336701"></p><h3 id="3-6-条件判断（th-if）"><a href="#3-6-条件判断（th-if）" class="headerlink" title="3.6 条件判断（th:if）"></a>3.6 条件判断（th:if）</h3><p>Controller添加代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//if条件</span><br>model.addAttribute(<span class="hljs-string">&quot;age&quot;</span>,<span class="hljs-number">22</span>);<br></code></pre></td></tr></table></figure><p>编写标签</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:if</span>=<span class="hljs-string">&quot;$&#123;(age&gt;=18)&#125;&quot;</span>&gt;</span>终于长大了！<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure><p>测试路径：<a href="http://localhost:8080/test/hello">http://localhost:8080/test/hello</a></p><p><img src="/images/image-20210805135716174.png" alt="image-20210805135716174"></p><h3 id="3-7-模块申明与页面包含"><a href="#3-7-模块申明与页面包含" class="headerlink" title="3.7 模块申明与页面包含"></a>3.7 模块申明与页面包含</h3><p>创建一个footer.html代码如下</p><p>注意：</p><ul><li><code>th:fragment=&quot;copy&quot;</code>定义一个copy模块</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">&quot;Content-Type&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;text/html;charset=charset=utf-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>fragment<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;C&quot;</span> <span class="hljs-attr">th:fragment</span>=<span class="hljs-string">&quot;copy&quot;</span> &gt;</span><br>    关于我们<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br></code></pre></td></tr></table></figure><p>在demo.html中引入模块</p><p>注意：</p><ul><li><code>th:include=&quot;footer::copy&quot;</code>, 表示的是引入footer.html中的被定义为copy的模块</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;A&quot;</span> <span class="hljs-attr">th:include</span>=<span class="hljs-string">&quot;footer::copy&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure><p>测试路径：<a href="http://localhost:8080/test/hello">http://localhost:8080/test/hello</a></p><h2 id="4-搜索页面渲染"><a href="#4-搜索页面渲染" class="headerlink" title="4 搜索页面渲染"></a>4 搜索页面渲染</h2><h3 id="4-1-搜索分析"><a href="#4-1-搜索分析" class="headerlink" title="4.1 搜索分析"></a>4.1 搜索分析</h3><p><img src="/images/image-20210805162300670.png" alt="image-20210805162300670"></p><p>搜索页面要显示的内容主要分为3块:</p><ol><li>搜索的数据结果</li><li>筛选出的数据搜索条件</li><li>用户已经勾选的数据条件</li></ol><h3 id="4-2-搜索实现"><a href="#4-2-搜索实现" class="headerlink" title="4.2 搜索实现"></a>4.2 搜索实现</h3><p><img src="/images/image-20210805162446418.png" alt="image-20210805162446418"></p><p>搜索的业务流程如上图，用户每次搜索的时候，先经过搜索业务工程，搜索业务工程调用搜索微服务工程，然后由thymeleaf渲染出静态化页面后返回给客户端</p><h4 id="4-2-1-搜索工程搭建"><a href="#4-2-1-搜索工程搭建" class="headerlink" title="4.2.1 搜索工程搭建"></a>4.2.1 搜索工程搭建</h4><ol><li><p>在changgou-service_search工程中的pom.xml中引入如下依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>静态资源导入</p><p>将本地笔记中的html页面复制到工程的resources.templates包下</p><p><img src="/images/image-20210805165043549.png" alt="image-20210805165043549"></p><p>将本地笔记中的资源复制到resources.static包下。（这两个包的名字固定）</p><p><img src="/images/image-20210805165243525.png" alt="image-20210805165243525"></p></li><li><p>更改配置文件,在spring下添加内容</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">thymeleaf:</span><br>    <span class="hljs-attr">cache:</span> <span class="hljs-literal">false</span> <span class="hljs-comment"># 不开启缓存</span><br></code></pre></td></tr></table></figure></li></ol><h4 id="4-2-2-基础数据渲染"><a href="#4-2-2-基础数据渲染" class="headerlink" title="4.2.2 基础数据渲染"></a>4.2.2 基础数据渲染</h4><ol><li><p>更新SearchController,定义跳转搜索结果页面方法</p><p>代码如下</p><p>注意：</p><ul><li>由于这里要返回到页面，必须把类上的@RestController给换成@Controller，并把其他需要返回给前端json串的方法上添加@ResponseBody的注解</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//搜索页面   http://localhost:9009//sku_search/list?keywords=手机&amp;brand=华为&amp;spec_网络制式=移动4G</span><br><span class="hljs-comment">//入参：Map</span><br><span class="hljs-comment">//返回值 Map</span><br><span class="hljs-comment">//由于页面是thymeleaf 完成的 属于服务器内页面渲染 跳转页面</span><br><span class="hljs-meta">@GetMapping(&quot;/list&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">search</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> Map&lt;String, String&gt; searchMap, Model model)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>   <br>    <span class="hljs-comment">//特殊符号处理，这个方法被单独抽出来了</span><br>    handlerSearchMap(searchMap);<br>   <br>    <span class="hljs-comment">//执行查询返回值</span><br>    Map&lt;String, Object&gt; resultMap = searchService.search(searchMap);<br>   <br>    <span class="hljs-comment">//把药传递的数据以键值对的形式存储在model中</span><br>    model.addAttribute(<span class="hljs-string">&quot;searchMap&quot;</span>, searchMap);<br>    model.addAttribute(<span class="hljs-string">&quot;result&quot;</span>, resultMap);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;search&quot;</span>;  <span class="hljs-comment">//跳转到search.html页面</span><br>&#125;<br></code></pre></td></tr></table></figure><p>发送请求：<a href="http://localhost:9009//sku_search/list?keywords=%E6%89%8B%E6%9C%BA&amp;brand=%E5%8D%8E%E4%B8%BA&amp;spec_%E7%BD%91%E7%BB%9C%E5%88%B6%E5%BC%8F=%E7%A7%BB%E5%8A%A84G">http://localhost:9009//sku_search/list?keywords=手机&amp;brand=华为&amp;spec_网络制式=移动4G</a></p><p><img src="/images/image-20210805170254574.png" alt="image-20210805170254574"></p></li><li><p>搜索结果页面渲染, 根据用户选择条件回显</p><p>(从search.html的465行开始)</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;bread&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;fl sui-breadcrumb&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;#&quot;</span>&gt;</span>全部结果<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;active&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;searchMap.keywords&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;fl sui-tag&quot;</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 品牌--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;with-x&quot;</span> <span class="hljs-attr">th:if</span>=<span class="hljs-string">&quot;$&#123;#maps.containsKey(searchMap,&#x27;brand&#x27;)&#125;&quot;</span>&gt;</span><br>            品牌:<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;searchMap.brand&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>×<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 价格--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;with-x&quot;</span> <span class="hljs-attr">th:if</span>=<span class="hljs-string">&quot;$&#123;#maps.containsKey(searchMap,&#x27;price&#x27;)&#125;&quot;</span>&gt;</span><br>            价格:<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;searchMap.price&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>×<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 规格--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;with-x&quot;</span> <span class="hljs-attr">th:each</span>=<span class="hljs-string">&quot;sm:$&#123;searchMap&#125;&quot;</span> <span class="hljs-attr">th:if</span>=<span class="hljs-string">&quot;$&#123;#strings.startsWith(sm.key,&#x27;spec_&#x27;)&#125;&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;#strings.replace(sm.key,&#x27;spec_&#x27;,&#x27;&#x27;)&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>:<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;#strings.replace(sm.value,&#x27;%2B&#x27;,&#x27;+&#x27;)&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>×<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;fl sui-form form-dark&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;input-control control-right&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;sui-icon icon-touch-magnifier&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>根据规格参数是否携带品牌决定是否返回品牌列表</p><p>代码从500行开始</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;!-- th:unless和 th:<span class="hljs-keyword">if</span> 的逻辑刚好相反，如果这个map里面有brand的话，返回<span class="hljs-keyword">false</span>--&gt;<br>&lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;type-wrap logo&quot;</span> th:unless=<span class="hljs-string">&quot;$&#123;#maps.containsKey(searchMap,&#x27;brand&#x27;)&#125;&quot;</span>&gt;<br>    &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;fl key brand&quot;</span>&gt;品牌&lt;/div&gt;<br>    &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;value logos&quot;</span>&gt;<br>        &lt;ul <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;logo-list&quot;</span>&gt;<br>            &lt;li th:each=<span class="hljs-string">&quot;brand,brandSate:$&#123;result.brandList&#125;&quot;</span>&gt;<br>                &lt;a th:text=<span class="hljs-string">&quot;$&#123;brand&#125;&quot;</span> th:href=<span class="hljs-string">&quot;@&#123;$&#123;url&#125;(brand=$&#123;brand&#125;)&#125;&quot;</span>&gt;&lt;/a&gt;<br>            &lt;/li&gt;<br>        &lt;/ul&gt;<br>    &lt;/div&gt;<br>    &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;ext&quot;</span>&gt;<br>        &lt;a href=<span class="hljs-string">&quot;javascript:void(0);&quot;</span> <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;sui-btn&quot;</span>&gt;多选&lt;/a&gt;<br>        &lt;a href=<span class="hljs-string">&quot;javascript:void(0);&quot;</span>&gt;更多&lt;/a&gt;<br>    &lt;/div&gt;<br>&lt;/div&gt;<br></code></pre></td></tr></table></figure><p>请求路径：<a href="http://localhost:9009//sku_search/list?keywords=%E6%89%8B%E6%9C%BA&amp;brand=%E5%8D%8E%E4%B8%BA">http://localhost:9009//sku_search/list?keywords=手机&amp;brand=华为</a></p><p>可以发现，品牌列表在传递的参数有品牌的时候不见了</p><p><img src="/images/image-20210805191635785.png" alt="image-20210805191635785"></p></li><li><p>规格数据格式转换及规格、价格显示</p><p>更新搜索业务层实现，将json字符串集合，转换成需要的map形式</p><p>记得在规格结果聚合那里调用下面这个方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 将json字符串集合，转换成需要的map形式</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> specList</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> Map&lt;String, Set&lt;String&gt;&gt; formartSpec(List&lt;String&gt; specList)&#123;<br>    Map&lt;String,Set&lt;String&gt;&gt; resultMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>    <span class="hljs-keyword">if</span> (specList!=<span class="hljs-keyword">null</span> &amp;&amp; specList.size()&gt;<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-keyword">for</span> (String specJsonString : specList) &#123;  <span class="hljs-comment">//&quot;&#123;&#x27;颜色&#x27;: &#x27;黑色&#x27;, &#x27;尺码&#x27;: &#x27;250度&#x27;&#125;&quot;</span><br>            <span class="hljs-comment">//将获取到的json转换为map</span><br>            Map&lt;String,String&gt; specMap = JSON.parseObject(specJsonString, Map.class);<br>            <span class="hljs-keyword">for</span> (String specKey : specMap.keySet()) &#123;<br>                Set&lt;String&gt; specSet = resultMap.get(specKey);<br>                <span class="hljs-keyword">if</span> (specSet == <span class="hljs-keyword">null</span>)&#123;<br>                    specSet = <span class="hljs-keyword">new</span> HashSet&lt;String&gt;();<br>                &#125;<br>                <span class="hljs-comment">//将规格信息存入set中</span><br>                specSet.add(specMap.get(specKey));<br>                <span class="hljs-comment">//将set存入map</span><br>                resultMap.put(specKey,specSet);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> resultMap;<br>&#125;<br></code></pre></td></tr></table></figure><p>更新页面与规格相关部分</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-comment">&lt;!--规格部分--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;type-wrap&quot;</span> <span class="hljs-attr">th:each</span>=<span class="hljs-string">&quot;spec,specStat:$&#123;result.specList&#125;&quot;</span> <span class="hljs-attr">th:unless</span>=<span class="hljs-string">&quot;$&#123;#maps.containsKey(searchMap,&#x27;spec_&#x27;+spec.key)&#125;&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;fl key&quot;</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;spec.key&#125;&quot;</span>&gt;</span><br>   <br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;fl value&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;type-list&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">th:each</span>=<span class="hljs-string">&quot;op,opstat:$&#123;spec.value&#125;&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;op&#125;&quot;</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;$&#123;url&#125;(&#x27;spec_&#x27;+$&#123;spec.key&#125;=$&#123;op&#125;)&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;fl ext&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure><p>更新价格相关代码</p><p>531行开始</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-comment">&lt;!--价格部分--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;type-wrap&quot;</span> <span class="hljs-attr">th:unless</span>=<span class="hljs-string">&quot;$&#123;#maps.containsKey(searchMap,&#x27;price&#x27;)&#125;&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;fl key&quot;</span>&gt;</span>价格<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;fl value&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;type-list&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;0-500元&quot;</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;$&#123;url&#125;(price=&#x27;0-500&#x27;)&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;500-1000元&quot;</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;$&#123;url&#125;(price=&#x27;500-1000&#x27;)&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;1000-1500元&quot;</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;$&#123;url&#125;(price=&#x27;1000-1500&#x27;)&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;1500-2000元&quot;</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;$&#123;url&#125;(price=&#x27;1500-2000&#x27;)&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;2000-3000元&quot;</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;$&#123;url&#125;(price=&#x27;2000-3000&#x27;)&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;3000元以上&quot;</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;$&#123;url&#125;(price=&#x27;3000&#x27;)&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;fl ext&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure><p>请求路径： <a href="http://localhost:9009//sku_search/list?keywords=%E6%89%8B%E6%9C%BA">http://localhost:9009//sku_search/list?keywords=手机</a></p><p>可以看到品牌，规格，价格都有改动</p><p><img src="/images/image-20210805193700666.png" alt="image-20210805193700666"></p></li><li><p>商品列表</p><p>609行开始</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-comment">&lt;!--商品列表--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;goods-list&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;yui3-g&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;yui3-u-1-5&quot;</span> <span class="hljs-attr">th:each</span>=<span class="hljs-string">&quot;sku,skuStat:$&#123;result.rows&#125;&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;list-wrap&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;p-img&quot;</span>&gt;</span><br>                    <span class="hljs-comment">&lt;!--&lt;a th:href=&quot;&#x27;http://192.168.200.128:8081/&#x27;+$&#123;sku.spuId&#125;+&#x27;.html&#x27;&quot;  target=&quot;_blank&quot;&gt;&lt;img th:src=&quot;$&#123;sku.image&#125;&quot; /&gt;&lt;/a&gt;--&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;&#x27;http://192.168.200.128:8081/10000000616300.html&#x27;&quot;</span>  <span class="hljs-attr">target</span>=<span class="hljs-string">&quot;_blank&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">th:src</span>=<span class="hljs-string">&quot;$&#123;sku.image&#125;&quot;</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;price&quot;</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">em</span>&gt;</span>¥<span class="hljs-tag">&lt;/<span class="hljs-name">em</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;sku.price&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;attr&quot;</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">target</span>=<span class="hljs-string">&quot;_blank&quot;</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;&#x27;http://192.168.200.128:8081/10000000616300.html&#x27;&quot;</span> <span class="hljs-attr">th:title</span>=<span class="hljs-string">&quot;$&#123;sku.spec&#125;&quot;</span> <span class="hljs-attr">th:utext</span>=<span class="hljs-string">&quot;$&#123;sku.name&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;commit&quot;</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;command&quot;</span>&gt;</span>已有<span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>2000<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>人评价<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;operate&quot;</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;success-cart.html&quot;</span> <span class="hljs-attr">target</span>=<span class="hljs-string">&quot;_blank&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;sui-btn btn-bordered btn-danger&quot;</span>&gt;</span>加入购物车<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;javascript:void(0);&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;sui-btn btn-bordered&quot;</span>&gt;</span>收藏<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure><p>请求路径：<a href="http://localhost:9009//sku_search/list?keywords=%E7%94%B5%E8%A7%86">http://localhost:9009//sku_search/list?keywords=电视</a></p><p><img src="/images/image-20210805194727321.png" alt="image-20210805194727321"></p></li></ol><h3 id="4-3-关键字搜索"><a href="#4-3-关键字搜索" class="headerlink" title="4.3 关键字搜索"></a>4.3 关键字搜索</h3><p>修改search.html，54行开始</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;search&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">form</span>  <span class="hljs-attr">th:action</span>=<span class="hljs-string">&quot;@&#123;/search/list&#125;&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;sui-form form-inline&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;input-append&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">th:type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;autocomplete&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;keywords&quot;</span>  <span class="hljs-attr">th:value</span>=<span class="hljs-string">&quot;$&#123;searchMap.keywords&#125;&quot;</span>  <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;input-error input-xxlarge&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;sui-btn btn-xlarge btn-danger&quot;</span> <span class="hljs-attr">th:type</span>=<span class="hljs-string">&quot;submit&quot;</span>&gt;</span>搜索<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure><p>测试路径：<a href="http://localhost:9009/sku_search/list?keywords=%E5%8D%8E%E4%B8%BA">http://localhost:9009/sku_search/list?keywords=华为</a></p><p><img src="/images/image-20210805200047392.png" alt="image-20210805200047392"></p><h3 id="4-4-条件搜索实现"><a href="#4-4-条件搜索实现" class="headerlink" title="4.4 条件搜索实现"></a>4.4 条件搜索实现</h3><p><img src="/images/image-20210805200258542.png" alt="image-20210805200258542"></p><p>用户每次点击搜索的时候，其实在上次搜索的基础之上加上了新的搜索条件，也就是在上一次请求的URL后面追加了新的搜索条件，我们可以在后台每次拼接组装出上次搜索的URL，然后每次将URL存入到Model中，页面每次点击不同条件的时候，从Model中取出上次请求的URL，然后再加上新点击的条件参数实现跳转即可。</p><ol><li><p>后台记录搜索URL</p><p>修改SkuController，添加组装URL的方法，并将组装好的URL存储起来,代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//拼装url</span><br>StringBuilder url = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">&quot;/search/list&quot;</span>);<br><span class="hljs-keyword">if</span> (searchMap != <span class="hljs-keyword">null</span> &amp;&amp; searchMap.size()&gt;<span class="hljs-number">0</span>)&#123;<br>    <span class="hljs-comment">//是由查询条件</span><br>    url.append(<span class="hljs-string">&quot;?&quot;</span>);<br>    <span class="hljs-keyword">for</span> (String paramKey : searchMap.keySet()) &#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-string">&quot;sortRule&quot;</span>.equals(paramKey) &amp;&amp; !<span class="hljs-string">&quot;sortField&quot;</span>.equals(paramKey) &amp;&amp; !<span class="hljs-string">&quot;pageNum&quot;</span>.equals(paramKey))&#123;<br>            url.append(paramKey).append(<span class="hljs-string">&quot;=&quot;</span>).append(searchMap.get(paramKey)).append(<span class="hljs-string">&quot;&amp;&quot;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//http://localhost:9009/search/list?keywords=手机&amp;spec_网络制式=4G&amp;</span><br>    String urlString = url.toString();<br>    <span class="hljs-comment">//去除路径上的最后一个&amp;</span><br>    urlString=urlString.substring(<span class="hljs-number">0</span>,urlString.length()-<span class="hljs-number">1</span>);<br>    model.addAttribute(<span class="hljs-string">&quot;url&quot;</span>,urlString);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    model.addAttribute(<span class="hljs-string">&quot;url&quot;</span>,url);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>页面搜索对接</p><p>修改品牌部份</p><p><img src="/images/image-20210805201634600.png" alt="image-20210805201634600"></p><p>修改规格部分</p><p><img src="/images/image-20210805202354898.png" alt="image-20210805202354898"></p><p>修改价格部分</p><p><img src="/images/image-20210805202524337.png" alt="image-20210805202524337"></p><p>测试，点击品牌，规格，价格参数后都会自动拼接到url字符串上</p><p><img src="/images/image-20210805203120830.png" alt="image-20210805203120830"></p></li></ol><h3 id="4-5-移除搜索条件"><a href="#4-5-移除搜索条件" class="headerlink" title="4.5 移除搜索条件"></a>4.5 移除搜索条件</h3><p><img src="/images/image-20210805203243750.png" alt="image-20210805203243750"></p><p>如上图，用户点击条件搜索后，要将选中的条件显示出来，并提供移除条件的<code>x</code>按钮,显示条件我们可以从searchMap中获取，移除其实就是将之前的请求地址中的指定条件删除即可。</p><p>修改search.html，移除分类、品牌、价格、规格搜索条件，代码如下：</p><p>只要修改方框里的内容，其实就是把字符串用空串代替</p><p><img src="/images/image-20210805204605803.png" alt="image-20210805204605803"></p><h3 id="4-6-排序"><a href="#4-6-排序" class="headerlink" title="4.6 排序"></a>4.6 排序</h3><p>修改search.html，实现排序，代码如下：</p><p>603行</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;$&#123;url&#125;(sortRule=&#x27;ASC&#x27;,sortField=&#x27;price&#x27;)&#125;&quot;</span>&gt;</span>价格↑<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;$&#123;url&#125;(sortRule=&#x27;DESC&#x27;,sortField=&#x27;price&#x27;)&#125;&quot;</span>&gt;</span>价格↓<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br></code></pre></td></tr></table></figure><p>测试: 点击价格，看是否进行排序</p><p><img src="/images/image-20210805205025043.png" alt="image-20210805205025043"></p><h3 id="4-7-分页"><a href="#4-7-分页" class="headerlink" title="4.7 分页"></a>4.7 分页</h3><ol><li><p>分页工具类定义</p><p>在common工程中添加Page分页对象，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 分页对象</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &lt;T&gt;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Page</span> &lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span></span>&#123;<br><br><span class="hljs-comment">//当前默认为第一页</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Integer pageNum = <span class="hljs-number">1</span>;<br><span class="hljs-comment">//默认每页显示条件</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Integer pageSize = <span class="hljs-number">20</span>;<br><br><br><span class="hljs-comment">//判断当前页是否为空或是小于1</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Integer <span class="hljs-title">cpn</span><span class="hljs-params">(Integer pageNum)</span></span>&#123;<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">null</span> == pageNum || pageNum &lt; <span class="hljs-number">1</span>)&#123;<br>pageNum = <span class="hljs-number">1</span>;<br>&#125;<br><span class="hljs-keyword">return</span> pageNum;<br>&#125;<br><br><br><span class="hljs-comment">// 页数（第几页）</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> currentpage;<br><br><span class="hljs-comment">// 查询数据库里面对应的数据有多少条</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> total;<span class="hljs-comment">// 从数据库查处的总记录数</span><br><br><span class="hljs-comment">// 每页显示多少分页标签</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> size;<br><br><span class="hljs-comment">// 下页</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> next;<br><br><span class="hljs-keyword">private</span> List&lt;T&gt; list;<br><br><span class="hljs-comment">// 最后一页</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> last;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> lpage;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> rpage;<br><br><span class="hljs-comment">//从哪条开始查</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> start;<br><br><span class="hljs-comment">//全局偏移量</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> offsize = <span class="hljs-number">2</span>;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Page</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">super</span>();<br>&#125;<br><br><span class="hljs-comment">/****</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> currentpage 当前页</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> total 总记录数</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pagesize 每页显示多少条</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCurrentpage</span><span class="hljs-params">(<span class="hljs-keyword">long</span> currentpage,<span class="hljs-keyword">long</span> total,<span class="hljs-keyword">long</span> pagesize)</span> </span>&#123;<br><br><span class="hljs-comment">//如果整除表示正好分N页，如果不能整除在N页的基础上+1页</span><br><span class="hljs-keyword">int</span> totalPages = (<span class="hljs-keyword">int</span>) (total%pagesize==<span class="hljs-number">0</span>? total/pagesize : (total/pagesize)+<span class="hljs-number">1</span>);<br><br><span class="hljs-comment">//总页数</span><br><span class="hljs-keyword">this</span>.last = totalPages;<br><br><span class="hljs-comment">//判断当前页是否越界,如果越界，我们就查最后一页</span><br><span class="hljs-keyword">if</span>(currentpage&gt;totalPages)&#123;<br><span class="hljs-keyword">this</span>.currentpage = totalPages;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br><span class="hljs-keyword">this</span>.currentpage=currentpage;<br>&#125;<br><br><span class="hljs-comment">//计算起始页</span><br><span class="hljs-keyword">this</span>.start = (<span class="hljs-keyword">this</span>.currentpage-<span class="hljs-number">1</span>)*pagesize;<br>&#125;<br>  <br>  <span class="hljs-comment">/****</span><br><span class="hljs-comment"> * 初始化分页</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> total</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> currentpage</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pagesize</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initPage</span><span class="hljs-params">(<span class="hljs-keyword">long</span> total,<span class="hljs-keyword">int</span> currentpage,<span class="hljs-keyword">int</span> pagesize)</span></span>&#123;<br><span class="hljs-comment">//总记录数</span><br><span class="hljs-keyword">this</span>.total = total;<br><span class="hljs-comment">//每页显示多少条</span><br><span class="hljs-keyword">this</span>.size=pagesize;<br><br><span class="hljs-comment">//计算当前页和数据库查询起始值以及总页数</span><br>setCurrentpage(currentpage, total, pagesize);<br><br><span class="hljs-comment">//分页计算</span><br><span class="hljs-keyword">int</span> leftcount =<span class="hljs-keyword">this</span>.offsize,<span class="hljs-comment">//需要向上一页执行多少次</span><br>rightcount =<span class="hljs-keyword">this</span>.offsize;<br><br><span class="hljs-comment">//起点页</span><br><span class="hljs-keyword">this</span>.lpage =currentpage;<br><span class="hljs-comment">//结束页</span><br><span class="hljs-keyword">this</span>.rpage =currentpage;<br><br><span class="hljs-comment">//2点判断</span><br><span class="hljs-keyword">this</span>.lpage = currentpage-leftcount;<span class="hljs-comment">//正常情况下的起点</span><br><span class="hljs-keyword">this</span>.rpage = currentpage+rightcount;<span class="hljs-comment">//正常情况下的终点</span><br><br><span class="hljs-comment">//页差=总页数和结束页的差</span><br><span class="hljs-keyword">int</span> topdiv = <span class="hljs-keyword">this</span>.last-rpage;<span class="hljs-comment">//判断是否大于最大页数</span><br><br><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 起点页</span><br><span class="hljs-comment"> * 1、页差&lt;0  起点页=起点页+页差值</span><br><span class="hljs-comment"> * 2、页差&gt;=0 起点和终点判断</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">this</span>.lpage=topdiv&lt;<span class="hljs-number">0</span>? <span class="hljs-keyword">this</span>.lpage+topdiv:<span class="hljs-keyword">this</span>.lpage;<br><br><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 结束页</span><br><span class="hljs-comment"> * 1、起点页&lt;=0   结束页=|起点页|+1</span><br><span class="hljs-comment"> * 2、起点页&gt;0    结束页</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">this</span>.rpage=<span class="hljs-keyword">this</span>.lpage&lt;=<span class="hljs-number">0</span>? <span class="hljs-keyword">this</span>.rpage+(<span class="hljs-keyword">this</span>.lpage*-<span class="hljs-number">1</span>)+<span class="hljs-number">1</span>: <span class="hljs-keyword">this</span>.rpage;<br><br><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 当起点页&lt;=0  让起点页为第一页</span><br><span class="hljs-comment"> * 否则不管</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">this</span>.lpage=<span class="hljs-keyword">this</span>.lpage&lt;=<span class="hljs-number">0</span>? <span class="hljs-number">1</span>:<span class="hljs-keyword">this</span>.lpage;<br><br><span class="hljs-comment">/***</span><br><span class="hljs-comment"> * 如果结束页&gt;总页数   结束页=总页数</span><br><span class="hljs-comment"> * 否则不管</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">this</span>.rpage=<span class="hljs-keyword">this</span>.rpage&gt;last? <span class="hljs-keyword">this</span>.last:<span class="hljs-keyword">this</span>.rpage;<br>&#125;<br>  <br>  <span class="hljs-comment">/****</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> total   总记录数</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> currentpage当前页</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pagesize每页显示多少条</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Page</span><span class="hljs-params">(<span class="hljs-keyword">long</span> total,<span class="hljs-keyword">int</span> currentpage,<span class="hljs-keyword">int</span> pagesize)</span> </span>&#123;<br>initPage(total,currentpage,pagesize);<br>&#125;<br><br><span class="hljs-comment">//上一页</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getUpper</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">return</span> currentpage&gt;<span class="hljs-number">1</span>? currentpage-<span class="hljs-number">1</span>: currentpage;<br>&#125;<br><br><span class="hljs-comment">//总共有多少页，即末页</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setLast</span><span class="hljs-params">(<span class="hljs-keyword">int</span> last)</span> </span>&#123;<br><span class="hljs-keyword">this</span>.last = (<span class="hljs-keyword">int</span>) (total%size==<span class="hljs-number">0</span>? total/size : (total/size)+<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-comment">/****</span><br><span class="hljs-comment"> * 带有偏移量设置的分页</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> total</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> currentpage</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pagesize</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> offsize</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Page</span><span class="hljs-params">(<span class="hljs-keyword">long</span> total,<span class="hljs-keyword">int</span> currentpage,<span class="hljs-keyword">int</span> pagesize,<span class="hljs-keyword">int</span> offsize)</span> </span>&#123;<br><span class="hljs-keyword">this</span>.offsize = offsize;<br>initPage(total, currentpage, pagesize);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getNext</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">return</span>  currentpage&lt;last? currentpage+<span class="hljs-number">1</span>: last;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setNext</span><span class="hljs-params">(<span class="hljs-keyword">int</span> next)</span> </span>&#123;<br><span class="hljs-keyword">this</span>.next = next;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getCurrentpage</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">return</span> currentpage;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getTotal</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">return</span> total;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setTotal</span><span class="hljs-params">(<span class="hljs-keyword">long</span> total)</span> </span>&#123;<br><span class="hljs-keyword">this</span>.total = total;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getSize</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">return</span> size;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setSize</span><span class="hljs-params">(<span class="hljs-keyword">int</span> size)</span> </span>&#123;<br><span class="hljs-keyword">this</span>.size = size;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getLast</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">return</span> last;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getLpage</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">return</span> lpage;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setLpage</span><span class="hljs-params">(<span class="hljs-keyword">int</span> lpage)</span> </span>&#123;<br><span class="hljs-keyword">this</span>.lpage = lpage;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getRpage</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">return</span> rpage;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setRpage</span><span class="hljs-params">(<span class="hljs-keyword">int</span> rpage)</span> </span>&#123;<br><span class="hljs-keyword">this</span>.rpage = rpage;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getStart</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">return</span> start;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setStart</span><span class="hljs-params">(<span class="hljs-keyword">long</span> start)</span> </span>&#123;<br><span class="hljs-keyword">this</span>.start = start;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCurrentpage</span><span class="hljs-params">(<span class="hljs-keyword">long</span> currentpage)</span> </span>&#123;<br><span class="hljs-keyword">this</span>.currentpage = currentpage;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> the list</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;T&gt; <span class="hljs-title">getList</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">return</span> list;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> list the list to set</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setList</span><span class="hljs-params">(List&lt;T&gt; list)</span> </span>&#123;<br><span class="hljs-keyword">this</span>.list = list;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><span class="hljs-comment">//总记录数</span><br><span class="hljs-comment">//当前页</span><br><span class="hljs-comment">//每页显示多少条</span><br><span class="hljs-keyword">int</span> cpage =<span class="hljs-number">17</span>;<br>Page page = <span class="hljs-keyword">new</span> Page(<span class="hljs-number">1001</span>,cpage,<span class="hljs-number">50</span>,<span class="hljs-number">7</span>);<br>System.out.println(<span class="hljs-string">&quot;开始页:&quot;</span>+page.getLpage()+<span class="hljs-string">&quot;__当前页：&quot;</span>+page.getCurrentpage()+<span class="hljs-string">&quot;__结束页&quot;</span>+page.getRpage()+<span class="hljs-string">&quot;____总页数：&quot;</span>+page.getLast());<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>分页实现</p><p>修改SkuController,实现分页信息封装，代码如下：</p><p>添加到拼接url的上面</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//封装分页数据并返回</span><br><span class="hljs-comment">//1.总记录数</span><br><span class="hljs-comment">//2.当前页</span><br><span class="hljs-comment">//3.每页显示多少条</span><br>Page&lt;SkuInfo&gt; page = <span class="hljs-keyword">new</span> Page&lt;SkuInfo&gt;(<br>        Long.parseLong(String.valueOf( resultMap.get(<span class="hljs-string">&quot;total&quot;</span>))),<br>        Integer.parseInt(String.valueOf(resultMap.get(<span class="hljs-string">&quot;pageNum&quot;</span>))),<br>        Page.pageSize<br>);<br>model.addAttribute(<span class="hljs-string">&quot;page&quot;</span>,page);<br></code></pre></td></tr></table></figure></li><li><p>页面分页实现</p><p>修改search.html，实现分页查询，代码如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;fr page&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;sui-pagination pagination-large&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;prev disabled&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;$&#123;url&#125;(pageNum=$&#123;page.upper&#125;)&#125;&quot;</span>&gt;</span>«上一页<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">th:each</span>=<span class="hljs-string">&quot;i:$&#123;#numbers.sequence(page.lpage,page.rpage)&#125;&quot;</span> <span class="hljs-attr">th:class</span>=<span class="hljs-string">&quot;$&#123;i&#125;==$&#123;page.currentpage&#125;?&#x27;active&#x27;:&#x27;&#x27;&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;$&#123;url&#125;(pageNum=$&#123;i&#125;)&#125;&quot;</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;i&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;next&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;$&#123;url&#125;(pageNum=$&#123;page.next&#125;)&#125;&quot;</span>&gt;</span>下一页»<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>共<span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;page.last&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>页<span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>共<span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;page.total&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>个商品<span class="hljs-symbol">&amp;nbsp;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure></li></ol><h2 id="5-畅购商品详情页"><a href="#5-畅购商品详情页" class="headerlink" title="5. 畅购商品详情页"></a>5. 畅购商品详情页</h2><h3 id="5-1-需求分析"><a href="#5-1-需求分析" class="headerlink" title="5.1 需求分析"></a>5.1 需求分析</h3><p>当系统审核完成商品，需要将商品详情页进行展示，那么采用静态页面生成的方式生成，并部署到高性能的web服务器中进行访问是比较合适的。所以，开发流程如下图所示：</p><p><img src="/images/image-20210805232618788.png" alt="image-20210805232618788"></p><p>此处MQ我们使用Rabbitmq即可。</p><p>执行步骤解释：</p><ul><li>系统管理员（商家运维人员）修改或者审核商品的时候, 会更改数据库中商品上架状态并发送商品id给rabbitMq中的上架交换器</li><li>上架交换器会将商品id发给静态页生成队列</li><li>静态页微服务设置监听器, 监听静态页生成队列, 根据商品id获取商品详细数据并使用thymeleaf的模板技术生成静态页</li></ul><h3 id="5-2-商品静态化微服务创建"><a href="#5-2-商品静态化微服务创建" class="headerlink" title="5.2 商品静态化微服务创建"></a>5.2 商品静态化微服务创建</h3><h4 id="5-2-1-需求分析"><a href="#5-2-1-需求分析" class="headerlink" title="5.2.1 需求分析"></a>5.2.1 需求分析</h4><p>该微服务只用于生成商品静态页，不做其他事情。</p><h4 id="5-2-2-搭建项目"><a href="#5-2-2-搭建项目" class="headerlink" title="5.2.2 搭建项目"></a>5.2.2 搭建项目</h4><ol><li><p>在changgou-service下创建一个名称为changgou_service_page的项目,作为静态化页面生成微服务</p></li><li><p>changgou-service-page中添加起步依赖，如下</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.changgou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>changgou_common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.changgou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>changgou_service_goods_api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>修改application.yml的配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9011</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">page</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.128</span><br>  <span class="hljs-attr">main:</span><br>    <span class="hljs-attr">allow-bean-definition-overriding:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#当遇到同样名字的时候，是否允许覆盖注册</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:6868/eureka</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">hystrix:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">default:</span>   <span class="hljs-comment">#配置全局的feign的调用超时时间  如果 有指定的服务配置 默认的配置不会生效</span><br>        <span class="hljs-attr">connectTimeout:</span> <span class="hljs-number">600000</span> <span class="hljs-comment"># 指定的是 消费者 连接服务提供者的连接超时时间 是否能连接  单位是毫秒</span><br>        <span class="hljs-attr">readTimeout:</span> <span class="hljs-number">600000</span>  <span class="hljs-comment"># 指定的是调用服务提供者的 服务 的超时时间（）  单位是毫秒</span><br><span class="hljs-comment">#hystrix 配置</span><br><span class="hljs-attr">hystrix:</span><br>  <span class="hljs-attr">command:</span><br>    <span class="hljs-attr">default:</span><br>      <span class="hljs-attr">execution:</span><br>        <span class="hljs-attr">timeout:</span><br>          <span class="hljs-comment">#如果enabled设置为false，则请求超时交给ribbon控制</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">isolation:</span><br>          <span class="hljs-attr">strategy:</span> <span class="hljs-string">SEMAPHORE</span><br><span class="hljs-comment"># 生成静态页的位置</span><br><span class="hljs-attr">pagepath:</span> <span class="hljs-string">D:\items</span><br></code></pre></td></tr></table></figure></li><li><p>创建系统启动类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableEurekaClient</span><br><span class="hljs-meta">@EnableFeignClients(basePackages = &quot;com.changgou.goods.feign&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PageApplication</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(PageApplication.class,args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h3 id="5-3-生成静态页"><a href="#5-3-生成静态页" class="headerlink" title="5.3 生成静态页"></a>5.3 生成静态页</h3><h4 id="5-3-1-需求分析"><a href="#5-3-1-需求分析" class="headerlink" title="5.3.1 需求分析"></a>5.3.1 需求分析</h4><p>页面发送请求，传递要生成的静态页的商品的SpuID.后台controller 接收请求，调用thyemleaf的原生API生成商品静态页。</p><p><img src="/images/image-20210805233422423.png" alt="image-20210805233422423"></p><p>上图是要生成的商品详情页，从图片上可以看出需要查询SPU的3个分类作为面包屑显示，同时还需要查询SKU和SPU信息。</p><h4 id="5-3-2-Feign创建"><a href="#5-3-2-Feign创建" class="headerlink" title="5.3.2 Feign创建"></a>5.3.2 Feign创建</h4><p>一会儿需要查询SPU和SKU以及Category，所以我们需要先创建Feign，修改changgou-service-goods-api,添加CategoryFeign，并在CategoryFeign中添加根据ID查询分类数据，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name = &quot;goods&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CategoryFeign</span> </span>&#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/category/&#123;id&#125;&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">findById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>在changgou-service-goods-api,添加SkuFeign,并添加根据SpuID查询Sku集合，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name=&quot;goods&quot;)</span><br><span class="hljs-meta">@RequestMapping(&quot;/sku&quot;)</span>  <span class="hljs-comment">//这个路径拼接到下面方法上也可以</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SkuFeign</span> </span>&#123;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 多条件搜索品牌数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> spuId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/spu/&#123;spuId&#125;&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Sku&gt; <span class="hljs-title">findSkuListBySpuId</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;spuId&quot;)</span> String spuId)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>在changgou-service-goods-api,添加SpuFeign,并添加根据SpuID查询Spu信息，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name = &quot;goods&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SpuFeign</span> </span>&#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/spu/findSpuById/&#123;id&#125;&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">findSpuById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> String id)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="5-3-3-静态页生成代码"><a href="#5-3-3-静态页生成代码" class="headerlink" title="5.3.3 静态页生成代码"></a>5.3.3 静态页生成代码</h4><ol><li><p>创建PageService</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">PageService</span> </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 生成静态化页面</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> spuId</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">generateItemPage</span><span class="hljs-params">(String spuId)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>创建PageServiceImpl</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PageServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">PageService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SpuFeign spuFeign;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CategoryFeign categoryFeign;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SkuFeign skuFeign;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> TemplateEngine templateEngine;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;pagepath&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String pagepath;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">generateItemPage</span><span class="hljs-params">(String spuId)</span> </span>&#123;<br>        <span class="hljs-comment">//获取context对象,用于存放商品详情数据</span><br>        Context context = <span class="hljs-keyword">new</span> Context();<br>        Map&lt;String, Object&gt; itemData = <span class="hljs-keyword">this</span>.findItemData(spuId);<br>        context.setVariables(itemData);<br>        <span class="hljs-comment">//获取商品详情页生成的指定位置</span><br>        File dir = <span class="hljs-keyword">new</span> File(pagepath);<br>        <span class="hljs-comment">//判断商品详情页文件夹是否存在,不存在则创建</span><br>        <span class="hljs-keyword">if</span> (!dir.exists())&#123;<br>            dir.mkdirs();<br>        &#125;<br>        <span class="hljs-comment">//定义输出流,进行文件生成</span><br>        File file = <span class="hljs-keyword">new</span> File(dir+<span class="hljs-string">&quot;/&quot;</span>+spuId+<span class="hljs-string">&quot;.html&quot;</span>);<br>        Writer out = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span>&#123;<br>            out = <span class="hljs-keyword">new</span> PrintWriter(file);<br>            <span class="hljs-comment">//生成文件</span><br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * 1.模板名称</span><br><span class="hljs-comment">             * 2.context对象,包含了模板需要的数据</span><br><span class="hljs-comment">             * 3.输出流,指定文件输出位置</span><br><span class="hljs-comment">             */</span><br>            templateEngine.process(<span class="hljs-string">&quot;item&quot;</span>,context,out);<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            e.printStackTrace();<br>        &#125;<span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-comment">//关闭流</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                out.close();<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-comment">//获取静态化页面数据</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> Map&lt;String, Object&gt; <span class="hljs-title">findItemData</span><span class="hljs-params">(String spuId)</span> </span>&#123;<br><br>        Map&lt;String,Object&gt; resultMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br><br>        <span class="hljs-comment">//获取spu信息</span><br>        Result&lt;Spu&gt; spuResult = spuFeign.findSpuById(spuId);<br>        Spu spu = spuResult.getData();<br>        resultMap.put(<span class="hljs-string">&quot;spu&quot;</span>,spu);<br><br>        <span class="hljs-comment">//获取图片信息</span><br>        <span class="hljs-keyword">if</span> (spu != <span class="hljs-keyword">null</span>)&#123;<br>            <span class="hljs-keyword">if</span>(!StringUtils.isEmpty(spu.getImages()))&#123;<br>                resultMap.put(<span class="hljs-string">&quot;imageList&quot;</span>,spu.getImages().split(<span class="hljs-string">&quot;,&quot;</span>));<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">//获取分类信息</span><br>        Category category1 = (Category) categoryFeign.findById(spu.getCategory1Id()).getData();<br>        resultMap.put(<span class="hljs-string">&quot;category1&quot;</span>,category1);<br>        Category category2 = (Category) categoryFeign.findById(spu.getCategory2Id()).getData();<br>        resultMap.put(<span class="hljs-string">&quot;category2&quot;</span>,category2);<br>        Category category3 = (Category) categoryFeign.findById(spu.getCategory3Id()).getData();<br>        resultMap.put(<span class="hljs-string">&quot;category3&quot;</span>,category3);<br>        <span class="hljs-comment">//获取sku集合信息</span><br>        List&lt;Sku&gt; skuList = skuFeign.findSkuListBySpuId(spuId);<br>        resultMap.put(<span class="hljs-string">&quot;skuList&quot;</span>,skuList);<br><br>        resultMap.put(<span class="hljs-string">&quot;specificationList&quot;</span>, JSON.parseObject(spu.getSpecItems(), Map.class));<br>        <span class="hljs-keyword">return</span> resultMap;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>声明page_create_queue队列,并绑定到商品上架交换机</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RabbitMQConfig</span> </span>&#123;<br><br>    <span class="hljs-comment">//定义交换机名称</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String GOODS_UP_EXCHANGE=<span class="hljs-string">&quot;goods_up_exchange&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String GOODS_DOWN_EXCHANGE=<span class="hljs-string">&quot;goods_down_exchange&quot;</span>;<br><br>    <span class="hljs-comment">//定义队列名称</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String AD_UPDATE_QUEUE=<span class="hljs-string">&quot;ad_update_queue&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SEARCH_ADD_QUEUE=<span class="hljs-string">&quot;search_add_queue&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SEARCH_DEL_QUEUE=<span class="hljs-string">&quot;search_del_queue&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String PAGE_CREATE_QUEUE=<span class="hljs-string">&quot;page_create_queue&quot;</span>;<br><br>    <span class="hljs-comment">//声明队列</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">queue</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(AD_UPDATE_QUEUE);<br>    &#125;<br>    <span class="hljs-meta">@Bean(SEARCH_ADD_QUEUE)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">SEARCH_ADD_QUEUE</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(SEARCH_ADD_QUEUE);<br>    &#125;<br>    <span class="hljs-meta">@Bean(SEARCH_DEL_QUEUE)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">SEARCH_DEL_QUEUE</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(SEARCH_DEL_QUEUE);<br>    &#125;<br>    <span class="hljs-meta">@Bean(PAGE_CREATE_QUEUE)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">PAGE_CREATE_QUEUE</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(PAGE_CREATE_QUEUE);<br>    &#125;<br><br>    <span class="hljs-comment">//声明交换机</span><br>    <span class="hljs-meta">@Bean(GOODS_UP_EXCHANGE)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Exchange <span class="hljs-title">GOODS_UP_EXCHANGE</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> ExchangeBuilder.fanoutExchange(GOODS_UP_EXCHANGE).durable(<span class="hljs-keyword">true</span>).build();<br>    &#125;<br>    <span class="hljs-meta">@Bean(GOODS_DOWN_EXCHANGE)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Exchange <span class="hljs-title">GOODS_DOWN_EXCHANGE</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> ExchangeBuilder.fanoutExchange(GOODS_DOWN_EXCHANGE).durable(<span class="hljs-keyword">true</span>).build();<br>    &#125;<br><br><br>    <span class="hljs-comment">//队列与交换机的绑定</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">GOODS_UP_EXCHANGE_BINDING</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(SEARCH_ADD_QUEUE)</span>Queue queue,<span class="hljs-meta">@Qualifier(GOODS_UP_EXCHANGE)</span>Exchange exchange)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="hljs-string">&quot;&quot;</span>).noargs();<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">PAGE_CREATE_QUEUE_BINDING</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(PAGE_CREATE_QUEUE)</span>Queue queue,<span class="hljs-meta">@Qualifier(GOODS_UP_EXCHANGE)</span>Exchange exchange)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="hljs-string">&quot;&quot;</span>).noargs();<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">GOODS_DOWN_EXCHANGE_BINDING</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(SEARCH_DEL_QUEUE)</span>Queue queue,<span class="hljs-meta">@Qualifier(GOODS_DOWN_EXCHANGE)</span>Exchange exchange)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="hljs-string">&quot;&quot;</span>).noargs();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>创建PageListener监听类,监听page_create_queue队列,获取消息,并生成静态化页面</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PageListener</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> PageService pageService;<br><br>    <span class="hljs-meta">@RabbitListener(queues = RabbitMQConfig.PAGE_CREATE_QUEUE)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiveMessage</span><span class="hljs-params">(String spuId)</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;生成商品详情页面,商品id为: &quot;</span>+spuId);<br>        <span class="hljs-comment">//生成静态化页面</span><br>        pageService.generateItemPage(spuId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>更新canal中消息队列配置类与Page服务一致</p></li><li><p>更新canal中对于spu表的监听类,当商品审核状态从0变1,则将当前spuId发送到消息队列</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//获取最新审核商品</span><br><span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;0&quot;</span>.equals(oldData.get(<span class="hljs-string">&quot;status&quot;</span>)) &amp;&amp; <span class="hljs-string">&quot;1&quot;</span>.equals(newData.get(<span class="hljs-string">&quot;status&quot;</span>)))&#123;<br>  <span class="hljs-comment">//发送商品spuId</span><br>  rabbitTemplate.convertAndSend(RabbitMQConfig.GOODS_UP_EXCHANGE,<span class="hljs-string">&quot;&quot;</span>,newData.get(<span class="hljs-string">&quot;id&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><p>最后记得把list.html拷贝到templates包下</p><h4 id="5-3-4-启动测试"><a href="#5-3-4-启动测试" class="headerlink" title="5.3.4 启动测试"></a>5.3.4 启动测试</h4><p>启动eurekea服务端,数据监控服务,商品服务,静态页生成服务. 将spu表中status字段从0更新为1。在生成的items目录下会看到新增的页面，把css, img等那些静态资源放到与items同级的包下，可以看到，点开页面可以看到下图</p><p><img src="/images/image-20210806141505171.png" alt="image-20210806141505171"></p><h4 id="5-3-5-基于nginx完成静态页访问"><a href="#5-3-5-基于nginx完成静态页访问" class="headerlink" title="5.3.5 基于nginx完成静态页访问"></a>5.3.5 基于nginx完成静态页访问</h4><p>用FileZilla连接到服务器（这里就是我们的虚拟机）</p><p><img src="/images/image-20210806142622109.png" alt="image-20210806142622109"></p><p>把生成的html页面复制到服务器端的html包下</p><p><img src="/images/image-20210806142913422.png" alt="image-20210806142913422"></p><p>然后重启服务器端的nginx</p><p>输入请求路径（端口改为http协议默认端口80了）：<a href="http://192.168.200.128/10000001516600.html">http://192.168.200.128/10000001516600.html</a></p><p>可以发现，通过访问远端服务器也可以访问到图片了</p><p><img src="/images/image-20210806143130888.png" alt="image-20210806143130888"></p>]]></content>
    
    
    <categories>
      
      <category>畅购商城项目</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>畅购商城项目第一部分</title>
    <link href="/2021/07/26/1.1%20%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86/"/>
    <url>/2021/07/26/1.1%20%E7%95%85%E8%B4%AD%E5%95%86%E5%9F%8E%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86/</url>
    
    <content type="html"><![CDATA[<h1 id="Part-01-框架搭建"><a href="#Part-01-框架搭建" class="headerlink" title="Part-01 框架搭建"></a>Part-01 框架搭建</h1><h2 id="1-框架搭建"><a href="#1-框架搭建" class="headerlink" title="1. 框架搭建"></a>1. 框架搭建</h2><h3 id="1-1-项目结构说明"><a href="#1-1-项目结构说明" class="headerlink" title="1.1 项目结构说明"></a>1.1 项目结构说明</h3><p><img src="/images/image-20210726205356384.png" alt="image-20210726205356384"></p><p>各个包的用途</p><ul><li><p>changgou_auth:  （目前还不是太理解这一部分的作用）</p></li><li><p>changgou_common: 用来放返回给前端的result</p></li></ul><p><img src="/images/image-20210726205734286.png" alt="image-20210726205734286"></p><ul><li>changgou_common_db:  （目前还不是太理解这一部分的作用）</li><li>changgou_eureka: 微服务的注册中心，获取不同微服务的地址，便于通信</li><li>changgou_gateway : 网关模块，根据网站的规模和需要，可以将综合逻辑相关的服务用网关路由组合到一起。在这里还可以做鉴权和限流相关操作。</li><li>changgou_reverser: (目前还不是太理解这一部分的作用)</li><li>changgou_service: 微服务模块，该模块用于存放所有独立的微服务工程。</li></ul><p><img src="/images/image-20210726210519758.png" alt="image-20210726210519758"></p><ul><li><p>changgou_service_api: 这里面放了各个微服务对应工程的JavaBean、Feign、以及Hystrix配置，该工程主要对外提供依赖。</p></li><li><p>changgou_transaction_fescar: 分布式事务模块，将分布式事务抽取到该工程中，任何工程如需要使用分布式事务，只需依赖该工程即可。 (目前还不是太理解这一部分的作用)</p></li><li><p>changgou_web: web服务工程，对应功能模块如需要调用多个微服务，可以将他们写入到该模块中，例如网站后台、网站前台等。 (目前还不是太理解这一部分的作用)</p></li></ul><h3 id="1-2-父工程搭建"><a href="#1-2-父工程搭建" class="headerlink" title="1.2 父工程搭建"></a>1.2 父工程搭建</h3><p>首先，创建空项目changgou。下面的所有模块都是用的无模板maven创建的，没有用Spring Initializr。</p><h4 id="1-2-1-一级父工程搭建"><a href="#1-2-1-一级父工程搭建" class="headerlink" title="1.2.1  一级父工程搭建"></a>1.2.1  一级父工程搭建</h4><p>在项目下面创建父工程 changgou_parent</p><p>配置好pom.xml文件，将src文件夹给删除</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.4.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><br>   <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>       <span class="hljs-comment">&lt;!--spring boot项目跳过测试，但是测试类会生成.class文件--&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">skipTests</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">skipTests</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>   <span class="hljs-comment">&lt;!--依赖包--&gt;</span><br>   <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>       <span class="hljs-comment">&lt;!--测试包--&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>       <span class="hljs-comment">&lt;!--这下面的几个包是因为我没加时出异常：“java.lang.TypeNotPresentException: Type javax.xml.bind.JAXBContext not present”   应该和jdk的版本有关系--&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.xml.bind<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jaxb-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.sun.xml.bind<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jaxb-impl<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.glassfish.jaxb<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jaxb-runtime<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.activation<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>activation<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>   <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>               <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>               <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>               <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>Greenwich.SR1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>               <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>               <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>           <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="1-2-2-二级父工程模块搭建"><a href="#1-2-2-二级父工程模块搭建" class="headerlink" title="1.2.2 二级父工程模块搭建"></a>1.2.2 二级父工程模块搭建</h4><p>创建changgou_gateway、changgou_service、changgou_service_api、 </p><p>changgou_web工程，工程全部为pom工程，并将所有工程的src文件删除。</p><h3 id="1-3-Eureka微服务搭建"><a href="#1-3-Eureka微服务搭建" class="headerlink" title="1.3 Eureka微服务搭建"></a>1.3 <strong>Eureka</strong>微服务搭建</h3><ol><li><p>在一级父工程下创建模块changgou_eureka。这个模块是用来当做注册中心服务方的（eureka-server）</p></li><li><p>pom.xml文件引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>       <span class="hljs-comment">&lt;!--eureka-server依赖--&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>创建 appliation.yml 配置文件</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">6868</span> <span class="hljs-comment"># 表明这个服务的端口号是6868，启动以后在网页端输入（localhost:6868）即可访问图形界面</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#由于他是注册中心，所以不用注册到eureka中</span><br>    <span class="hljs-attr">fetch-registry:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#他是给client提供信息的，所以不用从eureka中获取信息</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-comment"># 表明这是一个注册中心，但是要注意在网页端输入 localhost:6868 才能看到图形界面，而不是下面这个带/eureka/的url</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:$&#123;server.port&#125;/eureka/</span><br></code></pre></td></tr></table></figure><p><code>$&#123;server.port&#125;</code>也是一种语言，用来获取配置文件键值对中的值的字符串，在这里就是 6868。            </p></li><li><p>在 java 目录下创建包 com.changgou.eureka，并在 eureka 包下创建启动类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>  <span class="hljs-comment">//表明这是一个服务的启动类</span><br><span class="hljs-meta">@EnableEurekaServer</span>     <span class="hljs-comment">//表明这是eureka-server</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EurekaApplication</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(EurekaApplication.class, args);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li></ol><p>上述步骤完成以后，启动启动类。在浏览器输入<code>localhost:6868</code>, 看是否能顺利打开图形界面。</p><h3 id="1-4-公共模块服务搭建"><a href="#1-4-公共模块服务搭建" class="headerlink" title="1.4 公共模块服务搭建"></a>1.4 公共模块服务搭建</h3><h4 id="1-4-1-全局公共模块"><a href="#1-4-1-全局公共模块" class="headerlink" title="1.4.1 全局公共模块"></a>1.4.1 全局公共模块</h4><ol><li><p>在一级父工程下创建子模块 changgou_common</p></li><li><p>引入 pom.xml 文件依赖（redis, operfeign这俩依赖目前还不知道其用途）</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>       <span class="hljs-comment">&lt;!--web起步依赖。这里导入他，是因为这个包的目的就是创建实体类并将结果封装返回给前端--&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-comment">&lt;!-- redis 使用--&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--这里的响应结果和前端请求的格式都是json格式，所以需要这个包--&gt;</span>    <br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.51<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>创建 com.changgou.entity 包，包下封装相关公共实体类。（这里的entity实体类就按照模板来就行了，因为它是用来和前端交互信息的，写法比较固定）</p><p><img src="/images/image-20210726220028054.png" alt="image-20210726220028054"></p></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 返回结果实体类</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &lt;T&gt;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Result</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> flag;<span class="hljs-comment">//是否成功</span><br>    <span class="hljs-keyword">private</span> Integer code;<span class="hljs-comment">//返回码</span><br>    <span class="hljs-keyword">private</span> String message;<span class="hljs-comment">//返回消息</span><br><br>    <span class="hljs-keyword">private</span> T data;<span class="hljs-comment">//返回数据</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Result</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> flag, Integer code, String message, Object data)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.flag = flag;<br>        <span class="hljs-keyword">this</span>.code = code;<br>        <span class="hljs-keyword">this</span>.message = message;<br>        <span class="hljs-keyword">this</span>.data = (T)data;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Result</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> flag, Integer code, String message)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.flag = flag;<br>        <span class="hljs-keyword">this</span>.code = code;<br>        <span class="hljs-keyword">this</span>.message = message;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Result</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.flag = <span class="hljs-keyword">true</span>;<br>        <span class="hljs-keyword">this</span>.code = StatusCode.OK;<br>        <span class="hljs-keyword">this</span>.message = <span class="hljs-string">&quot;执行成功&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isFlag</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> flag;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setFlag</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> flag)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.flag = flag;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getCode</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> code;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCode</span><span class="hljs-params">(Integer code)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.code = code;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessage</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> message;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setMessage</span><span class="hljs-params">(String message)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.message = message;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">getData</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> data;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setData</span><span class="hljs-params">(T data)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.data = data;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 分页结果类</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &lt;T&gt;</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PageResult</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;<br><br>    <span class="hljs-keyword">private</span> Long total;<span class="hljs-comment">//总记录数</span><br>    <span class="hljs-keyword">private</span> List&lt;T&gt; rows;<span class="hljs-comment">//记录</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PageResult</span><span class="hljs-params">(Long total, List&lt;T&gt; rows)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.total = total;<br>        <span class="hljs-keyword">this</span>.rows = rows;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PageResult</span><span class="hljs-params">()</span> </span>&#123;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getTotal</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> total;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setTotal</span><span class="hljs-params">(Long total)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.total = total;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;T&gt; <span class="hljs-title">getRows</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> rows;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setRows</span><span class="hljs-params">(List&lt;T&gt; rows)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.rows = rows;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 返回码实体类</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StatusCode</span> </span>&#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> OK=<span class="hljs-number">20000</span>;<span class="hljs-comment">//成功</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> ERROR =<span class="hljs-number">20001</span>;<span class="hljs-comment">//失败</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> LOGINERROR =<span class="hljs-number">20002</span>;<span class="hljs-comment">//用户名或密码错误</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> ACCESSERROR =<span class="hljs-number">20003</span>;<span class="hljs-comment">//权限不足</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> REMOTEERROR =<span class="hljs-number">20004</span>;<span class="hljs-comment">//远程调用失败</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> REPERROR =<span class="hljs-number">20005</span>;<span class="hljs-comment">//重复操作</span><br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="1-4-2-数据访问公共模块搭建"><a href="#1-4-2-数据访问公共模块搭建" class="headerlink" title="1.4.2 数据访问公共模块搭建"></a>1.4.2 数据访问公共模块搭建</h4><p>这个公共模块是连接mysql数据库的公共微服务模块，所以需要连接mysql的微服务都继承自此工程。 </p><ol><li><p>创建数据访问公共模块changgou_common_db</p></li><li><p>给 pom.xml 文件引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.changgou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>changgou_common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-comment">&lt;!--通用mapper起步依赖--&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>tk.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mapper-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-comment">&lt;!--MySQL数据库驱动--&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-comment">&lt;!--mybatis分页插件--&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.pagehelper<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>pagehelper-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure></li></ol><h3 id="1-5-商品微服务搭建"><a href="#1-5-商品微服务搭建" class="headerlink" title="1.5 商品微服务搭建"></a>1.5 商品微服务搭建</h3><h4 id="1-5-1-商品微服务API工程搭建"><a href="#1-5-1-商品微服务API工程搭建" class="headerlink" title="1.5.1 商品微服务API工程搭建"></a>1.5.1 商品微服务<strong>API</strong>工程搭建</h4><ol><li><p>二级父工程 changgou_service_api 的 pom.xml 引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-comment">&lt;!--这个包的作用是持久化，具体的说就是在实体类中进行元数据标签的作用，是ORM框架中用到的--&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.persistence<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>persistence-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>compile<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ORM框架可以通过这个元数据标签，使得实体类与数据库中的表建立映射关系。<br>例如javax.persistence.Column标识实体类中的这个属性对应于数据库中的一个字段等等。</p></li><li><p>changgou_service_api 下创建 changgou_service_goods_api 子模块</p></li></ol><h4 id="1-5-2-微服务工程搭建"><a href="#1-5-2-微服务工程搭建" class="headerlink" title="1.5.2 微服务工程搭建"></a>1.5.2 微服务工程搭建</h4><ol><li><p>二级父工程 changgou_service 下创建 changgou_service_goods 子模块 ，pom.xml 文件引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>       <span class="hljs-comment">&lt;!--这个包需要和数据库打交道，所以导入了changgou_common_db依赖，因为在changgou_common_db这个包中导入了数据库的一些依赖--&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.changgou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>changgou_common_db<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-comment">&lt;!--导入changgou_service_goods_api包，是因为这个包里面定义了商品的pojo--&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.changgou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>changgou_service_goods_api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>创建并配置文件application.yml </p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9001</span>      <span class="hljs-comment"># 配置这个商品微服务的端口为 9001</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">goods</span>   <span class="hljs-comment"># 配置这个微服务的名称为 goods</span><br>  <span class="hljs-attr">datasource:</span>     <span class="hljs-comment"># 配置mysql数据库的连接，注意他比spring低一级，注意要连接的数据库的 url 和表名称</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://192.168.200.128:3306/changgou_goods?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">main:</span><br>    <span class="hljs-attr">allow-bean-definition-overriding:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#当遇到同样名字的时候，是否允许覆盖注册</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><span class="hljs-comment"># register-with-eureka，fetch-registry这俩不写的话默认为true，表示他是eureka-client</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:6868/eureka</span> <span class="hljs-comment"># 声明注册中心</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 声明这个实例可以通过ip访问到，而不只是域名</span><br><span class="hljs-attr">feign:</span>   <span class="hljs-comment"># 这里还不熟，后面单独加强</span><br>  <span class="hljs-attr">hystrix:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>   <span class="hljs-comment"># 开启熔断机制</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">default:</span>   <span class="hljs-comment">#配置全局的feign的调用超时时间  如果 有指定的服务配置 默认的配置不会生效</span><br>        <span class="hljs-attr">connectTimeout:</span> <span class="hljs-number">60000</span> <span class="hljs-comment"># 指定的是 消费者 连接服务提供者的连接超时时间 是否能连接  单位是毫秒</span><br>        <span class="hljs-attr">readTimeout:</span> <span class="hljs-number">20000</span>  <span class="hljs-comment"># 指定的是调用服务提供者的 服务 的超时时间（）  单位是毫秒</span><br><span class="hljs-comment">#hystrix 配置</span><br><span class="hljs-attr">hystrix:</span><span class="hljs-comment"># 这里还不熟，后面单独加强</span><br>  <span class="hljs-attr">command:</span><br>    <span class="hljs-attr">default:</span><br>      <span class="hljs-attr">execution:</span><br>        <span class="hljs-attr">timeout:</span><br>          <span class="hljs-comment">#如果enabled设置为false，则请求超时交给ribbon控制</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">isolation:</span><br>          <span class="hljs-attr">strategy:</span> <span class="hljs-string">SEMAPHORE</span><br>          <span class="hljs-attr">thread:</span><br>            <span class="hljs-comment"># 熔断器超时时间，默认：1000/毫秒</span><br>            <span class="hljs-attr">timeoutInMilliseconds:</span> <span class="hljs-number">20000</span><br></code></pre></td></tr></table></figure></li><li><p>创建包com.changgou.goods，并在goods下创建启动类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span>  <span class="hljs-comment">// 表明他是这个服务的启动类</span><br><span class="hljs-meta">@EnableEurekaClient</span>     <span class="hljs-comment">// 表明这个微服务是一个eureka-client</span><br><span class="hljs-meta">@MapperScan(basePackages = &#123;&quot;com.changgou.goods.dao&quot;&#125;)</span>  <span class="hljs-comment">//@MapperScan是tk.mybatis.spring.annotation包下的，用于扫描dao包下的Mapper接口</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GoodsApplication</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run( GoodsApplication.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h2 id="2-商品微服务-品牌增删改查"><a href="#2-商品微服务-品牌增删改查" class="headerlink" title="2. 商品微服务-品牌增删改查"></a>2. 商品微服务-品牌增删改查</h2><p>先实现他的基本需求</p><ol><li>查询全部列表数据 </li><li>根据ID查询实体数据 </li><li>增加 </li><li>修改</li><li>删除</li><li>条件查询</li><li>分页查询</li><li>分页+条件查询 </li></ol><p>再观察他的表结构   (<em>tips: ctrl+enter 是在表格内换行, 直接按 enter会退出表格</em>)</p><table><thead><tr><th>字段名称</th><th>字段含义</th><th>字段类型</th><th>字段长度</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>品牌id</td><td>INT</td><td></td><td></td></tr><tr><td>name</td><td>品牌名称</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>image</td><td>品牌图片地址</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>letter</td><td>品牌的首字母</td><td>CHAR</td><td></td><td></td></tr><tr><td>seq</td><td>排序</td><td>INT</td><td></td><td></td></tr></tbody></table><h3 id="2-1-代码实现"><a href="#2-1-代码实现" class="headerlink" title="2.1 代码实现"></a>2.1 代码实现</h3><p>商品类的整体包结构还是三层架构</p><p><img src="/images/image-20210727122004680.png" alt="image-20210727122004680"></p><h4 id="2-1-1-品牌列表"><a href="#2-1-1-品牌列表" class="headerlink" title="2.1.1 品牌列表"></a>2.1.1 品牌列表</h4><ol><li>在changgou_service_goods_api创建com.changgou.goods.pojo包，pojo包下创建 Brand实体类</li></ol><p><img src="/images/image-20210727120159612.png" alt="image-20210727120159612"></p><p>​    <img src="/images/image-20210727120235587.png" alt="image-20210727120235587"></p><p>​    注意实体类中的<code>@Table(name=&quot;tb_brand&quot;)</code>和<code>@Id</code>这俩注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.changgou.goods.pojo;<br><br><span class="hljs-keyword">import</span> javax.persistence.Id;<br><span class="hljs-keyword">import</span> javax.persistence.Table;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * brand实体类</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Table(name=&quot;tb_brand&quot;)</span>  <span class="hljs-comment">//表明这个类和mysql数据库中的 tb_brand 相对应</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Brand</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;<br><br><span class="hljs-meta">@Id</span>  <span class="hljs-comment">//表明id是表的主键</span><br><span class="hljs-keyword">private</span> Integer id;<span class="hljs-comment">//品牌id</span><br><br><br><br><span class="hljs-keyword">private</span> String name;<span class="hljs-comment">//品牌名称</span><br><span class="hljs-keyword">private</span> String image;<span class="hljs-comment">//品牌图片地址</span><br><span class="hljs-keyword">private</span> String letter;<span class="hljs-comment">//品牌的首字母</span><br><span class="hljs-keyword">private</span> Integer seq;<span class="hljs-comment">//排序</span><br><br><br><span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getId</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">return</span> id;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setId</span><span class="hljs-params">(Integer id)</span> </span>&#123;<br><span class="hljs-keyword">this</span>.id = id;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">return</span> name;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(String name)</span> </span>&#123;<br><span class="hljs-keyword">this</span>.name = name;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getImage</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">return</span> image;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setImage</span><span class="hljs-params">(String image)</span> </span>&#123;<br><span class="hljs-keyword">this</span>.image = image;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getLetter</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">return</span> letter;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setLetter</span><span class="hljs-params">(String letter)</span> </span>&#123;<br><span class="hljs-keyword">this</span>.letter = letter;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getSeq</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">return</span> seq;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setSeq</span><span class="hljs-params">(Integer seq)</span> </span>&#123;<br><span class="hljs-keyword">this</span>.seq = seq;<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li><p>Dao创建 </p><p>在changgou_service_goods微服务下创建com.changgou.goods.dao.BrandMapper接口，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Mapper&lt;T&gt;是一个接口, 继承它以后可以用一些基本的对数据库单表的操作方法,如果查询比较复杂, 则可以自己在BrandMapper中定义方法在注解上完成sql语句的编写</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">BrandMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Mapper</span>&lt;<span class="hljs-title">Brand</span>&gt; </span>&#123; <br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>业务层 (service层)</p><p>创建com.changgou.goods.service.BrandService接口，代码如下： </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">BrandService</span> </span>&#123;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 查询所有</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function">List&lt;Brand&gt; <span class="hljs-title">findAll</span><span class="hljs-params">()</span></span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>创建 com.changgou.goods.service.impl 包，包下创建服务实现类 BrandServiceImpl， 代码如下：</p><p>注意: </p><ul><li>业务层实现类上的 bean 定义<code>@Service</code>不能忘了</li><li>要记得用<code>@Autowired</code>注入BrandMapper这个接口,是通过这个接口去操控数据库的</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BrandServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">BrandService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> BrandMapper brandMapper;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询全部列表</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Brand&gt; <span class="hljs-title">findAll</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> brandMapper.selectAll();<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>控制层 </p><p>控制层 com.changgou.goods包下创建controller包 ，包下创建类</p><p>注意:</p><ul><li><code>@RestController</code> = <code>@ResponseBody</code>+<code>@Controller</code>, <code>@ResponseBody</code>表明这个方法的返回值不是去跳转页面,而是响应给客户端浏览器的响应体. <code>@Controller</code>则是把这个类创建成bean放入spring容器</li><li>由于项目一般前后端分离, 前端项目和后端项目会部署在不同的服务器上, 所以客户端浏览器的请求是跨域的, 会存在请求通过前端到达不了后端的情况,  <code>@CrossOrigin</code>则表明允许跨域, 会解决掉上述问题</li><li><code>@RequestMapping</code>限制了这个控制器的访问路径</li><li><code>@Autowired</code>则是注入<code>BrandService</code>接口, 使用其接口实现类的方法</li><li><code>@GetMapping</code>则是使用了Restful风格, Get 表明这次请求是一次查询</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@CrossOrigin</span><br><span class="hljs-meta">@RequestMapping(&quot;/brand&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BrandController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> BrandService brandService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查询全部数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">findAll</span><span class="hljs-params">()</span></span>&#123;<br>        List&lt;Brand&gt; brandList = brandService.findAll();<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>, StatusCode.OK,<span class="hljs-string">&quot;查询成功&quot;</span>,brandList) ;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li></ol><p>以上是查询全部商品的一个流程, 其他的基本需求流程是一样的, 若需要仔细研究请查看本机上的changgou项目.</p><h2 id="3-公共异常处理"><a href="#3-公共异常处理" class="headerlink" title="3. 公共异常处理"></a>3. 公共异常处理</h2><p>为了代码更容易维护，创建一个类集中处理异常 </p><p>在com.changgou.goods.handler包下创建公共异常处理类BaseExceptionHandler (也可在controller包下直接创建,看自己喜好)</p><p>注意: </p><ul><li><code>@ControllerAdvice</code>表明这是一个增强的<code>@Controller</code>, 是对整个controller进行操作的一个类</li><li><code>@ExceptionHandler(value = Exception.class)</code>表明这个方法是用来处理为<code>Exception</code>的异常</li><li><code>@ResponseBody</code>则是把结果<code>new Result(false, StatusCode.ERROR, &quot;执行出错&quot;)</code>返回给前端</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ControllerAdvice</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseExceptionHandler</span> </span>&#123;<br><br>    <span class="hljs-meta">@ExceptionHandler(value = Exception.class)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">error</span><span class="hljs-params">(Exception e)</span></span>&#123;<br>        e.printStackTrace();        <br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">false</span>, StatusCode.ERROR, <span class="hljs-string">&quot;执行出错&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="Part-02-分布式文件存储"><a href="#Part-02-分布式文件存储" class="headerlink" title="Part-02 分布式文件存储"></a>Part-02 分布式文件存储</h1><h2 id="1-跨域解决方案CORS"><a href="#1-跨域解决方案CORS" class="headerlink" title="1. 跨域解决方案CORS"></a>1. 跨域解决方案CORS</h2><p>所谓同源（即指在同一个域）就是两个页面具有相同的协议（protocol），主机（host）和端口号（port） </p><p>跨域调用，会出现如下错误：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">No</span> <span class="hljs-string">&#x27;Access-Control-Allow-Origin&#x27;</span> <span class="hljs-keyword">header</span> <span class="hljs-keyword">is</span> present <span class="hljs-keyword">on</span> the requested resource. <br>Origin <span class="hljs-string">&#x27;http://localhost:9100&#x27;</span> <span class="hljs-keyword">is</span> therefore <span class="hljs-keyword">not</span> allowed <span class="hljs-keyword">access</span>. The response had HTTP status code <span class="hljs-number">400.</span><br></code></pre></td></tr></table></figure><h2 id="2-通用mapper自定义方法"><a href="#2-通用mapper自定义方法" class="headerlink" title="2. 通用mapper自定义方法"></a>2. 通用<strong>mapper</strong>自定义方法</h2><h3 id="2-1-根据商品分类名称查询品牌列表"><a href="#2-1-根据商品分类名称查询品牌列表" class="headerlink" title="2.1 根据商品分类名称查询品牌列表"></a>2.1 根据商品分类名称查询品牌列表</h3><h4 id="2-1-1-表结构分析"><a href="#2-1-1-表结构分析" class="headerlink" title="2.1.1 表结构分析"></a>2.1.1 表结构分析</h4><p>已知分类与品牌之间的关系属于多对多关系, 通过中间表建立关系</p><p><img src="/images/image-20210727132544864.png" alt="image-20210727132544864"></p><p>​    <img src="/images/image-20210727132633929.png" alt="image-20210727132633929"></p><p><img src="/images/image-20210727132720929.png" alt="image-20210727132720929"></p><p><img src="/images/image-20210727132809184.png" alt="image-20210727132809184"></p><h4 id="2-1-2-代码实现"><a href="#2-1-2-代码实现" class="headerlink" title="2.1.2 代码实现"></a>2.1.2 代码实现</h4><p>由于这是一个复杂查询, Mapper<T>接口中的方法无法直接实现, 所以需要自己定义</p><ol><li><p>修改dao包中的BrandMapper，BrandMapper中新增方法定义 </p><p>注意: </p><ul><li>由于name不能直接写在sql语句里面, 所以需要用变量<code>#&#123;name&#125;</code>代替, 这个参数通过<code>@Param(&quot;name&quot;) String categoryName</code>传过来.</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Select(&quot;SELECT NAME, image FROM tb_brand WHERE id IN (SELECT brand_id FROM tb_category_brand WHERE category_id IN (SELECT id FROM tb_category WHERE NAME=#&#123;name&#125; ORDER BY seq));&quot;)</span><br>   <span class="hljs-function">List&lt;Brand&gt; <span class="hljs-title">findBrandListByCategoryName</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;name&quot;)</span> String categoryName)</span></span>;<br></code></pre></td></tr></table></figure></li><li><p>service层, controller层的流程不变</p></li></ol><h2 id="3-分布式文件存储-FastDFS"><a href="#3-分布式文件存储-FastDFS" class="headerlink" title="3. 分布式文件存储-FastDFS"></a>3. 分布式文件存储-FastDFS</h2><h3 id="3-1-FastDFS简介"><a href="#3-1-FastDFS简介" class="headerlink" title="3.1 FastDFS简介"></a>3.1 FastDFS简介</h3><p>FastDFS是一个开源的轻量级分布式文件系统，它对文件进行管理，功能包括：文件存储、文件同步、文件访问（文件上传、文件下载）等，解决了大容量存储和负载均衡的问题。特别适合以文件为载体的在线服务，如相册网站、视频网站等等。</p><p>FastDFS 架构包括 Tracker server 和 Storage server。客户端请求 Tracker server 进行文件上传、下载，通过Tracker server 调度最终由 Storage server 完成文件上传和下载。</p><p>Tracker server 作用是负载均衡和调度，通过 Tracker server 在文件上传时可以根据一些策略找到Storage server 提供文件上传服务。可以将 tracker 称为追踪服务器或调度服务器。Storage server 作用是文件存储，客户端上传的文件最终存储在 Storage 服务器上，Stora-geserver 没有实现自己的文件系统而是利用操作系统的文件系统来管理文件。 可以将storage称为存储服务器。 </p><img src="/images/image-20210727134921556.png" alt="image-20210727134921556" style="zoom: 67%;" /><h3 id="3-2-上传流程"><a href="#3-2-上传流程" class="headerlink" title="3.2 上传流程"></a>3.2 上传流程</h3><img src="/images/image-20210727135143849.png" alt="image-20210727135143849" style="zoom:67%;" /><p>客户端上传文件后存储服务器将文件 ID 返回给客户端，此文件 ID 用于以后访问该文件的索引信息。文件索引信息包括：组名，虚拟磁盘路径，数据两级目录，文件名。 </p><p><img src="/images/image-20210727135358878.png" alt="image-20210727135358878"></p><p><strong>组名</strong>：文件上传后所在的 storage 组名称，在文件上传成功后有storage 服务器返回，需要客户端自行保存。</p><p><strong>虚拟磁盘路径</strong>：storage 配置的虚拟路径，与磁盘选项store_path对应。如果配置了store_path0 则是 M00，如果配置了 store_path1 则是 M01，以此类推。</p><p><strong>数据两级目录</strong>：storage 服务器在每个虚拟磁盘路径下创建的两级目录，用于存储数据文件。</p><p><strong>文件名</strong>：与文件上传时不同。是由存储服务器根据特定信息生成，文件名包含：源存储服务器 IP 地址、文件创建时间戳、文件大小、随机数和文件拓展名等信息。</p><h3 id="3-3-文件存储微服务搭建"><a href="#3-3-文件存储微服务搭建" class="headerlink" title="3.3 文件存储微服务搭建"></a>3.3 文件存储微服务搭建</h3><ol><li><p>在二级父工程changgou_service下创建文件管理微服务changgou_service_file，该工程主要用于实现文件上传以及文件删除等功能。修改pom.xml，引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>net.oschina.zcx7878<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastdfs-client-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.27.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.changgou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>changgou_common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>在resources文件夹下创建fasfDFS的配置文件<code>fdfs_client.conf</code>, 这个名字要和代码中的对应  (<em>这里的配置端口还不太懂, 没搞清楚这俩端口的区别</em>)</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">connect_timeout</span> = <span class="hljs-number">60</span><br><span class="hljs-attr">network_timeout</span> = <span class="hljs-number">60</span><br><span class="hljs-attr">charset</span> = UTF-<span class="hljs-number">8</span><br><span class="hljs-attr">http.tracker_http_port</span> = <span class="hljs-number">8080</span><br><span class="hljs-attr">tracker_server</span> = <span class="hljs-number">192.168</span>.<span class="hljs-number">200.128</span>:<span class="hljs-number">22122</span><br></code></pre></td></tr></table></figure></li><li><p>在resources文件夹下创建application.yml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">servlet:</span><br>    <span class="hljs-attr">multipart:</span><br>      <span class="hljs-attr">max-file-size:</span> <span class="hljs-string">10MB</span>  <span class="hljs-comment">#限制单个上传的文件最大为10MB</span><br>      <span class="hljs-attr">max-request-size:</span> <span class="hljs-string">10MB</span> <span class="hljs-comment">#限制的总上传数据最大为10MB</span><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9008</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:6868/eureka</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">hystrix:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure></li><li><p>创建com.changgou.file包，创建启动类FileApplication </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableEurekaClient</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileApplication</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(FileApplication.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h3 id="3-4-文件上传"><a href="#3-4-文件上传" class="headerlink" title="3.4 文件上传"></a>3.4 文件上传</h3><p>这里的步骤是固定的, 以后需要用到的话直接把这里的工具类给复制过去</p><ol><li><p>文件信息封装</p><p>文件上传一般都有文件的名字、文件的内容、文件的扩展名、文件的md5值、文件的作者等相关属性，我们可以创建一个对象封装这些属性，代码如下:</p><p>创建com.changgou.file.pojo.FastDFSFile </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FastDFSFile</span> </span>&#123;<br>    <span class="hljs-comment">//文件名字</span><br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-comment">//文件内容</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">byte</span>[] content;<br>    <span class="hljs-comment">//文件扩展名</span><br>    <span class="hljs-keyword">private</span> String ext;<br>    <span class="hljs-comment">//文件MD5摘要值</span><br>    <span class="hljs-keyword">private</span> String md5;<br>    <span class="hljs-comment">//文件创建作者</span><br>    <span class="hljs-keyword">private</span> String author;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">FastDFSFile</span><span class="hljs-params">(String name, <span class="hljs-keyword">byte</span>[] content, String ext, String height,</span></span><br><span class="hljs-params"><span class="hljs-function">                       String width, String author)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>();<br>        <span class="hljs-keyword">this</span>.name = name;<br>        <span class="hljs-keyword">this</span>.content = content;<br>        <span class="hljs-keyword">this</span>.ext = ext;<br>        <span class="hljs-keyword">this</span>.author = author;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">FastDFSFile</span><span class="hljs-params">(String name, <span class="hljs-keyword">byte</span>[] content, String ext)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>();<br>        <span class="hljs-keyword">this</span>.name = name;<br>        <span class="hljs-keyword">this</span>.content = content;<br>        <span class="hljs-keyword">this</span>.ext = ext;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(String name)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span>[] getContent() &#123;<br>        <span class="hljs-keyword">return</span> content;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setContent</span><span class="hljs-params">(<span class="hljs-keyword">byte</span>[] content)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.content = content;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getExt</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> ext;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setExt</span><span class="hljs-params">(String ext)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.ext = ext;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMd5</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> md5;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setMd5</span><span class="hljs-params">(String md5)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.md5 = md5;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getAuthor</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> author;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAuthor</span><span class="hljs-params">(String author)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.author = author;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>文件操作</p><p>创建FastDFSClient类,放在com.changgou.file.util下在该类中实现FastDFS信息获取以及文件的相关操作，代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.changgou.file.util;<br><br><span class="hljs-keyword">import</span> org.csource.common.NameValuePair;<br><span class="hljs-keyword">import</span> org.csource.fastdfs.*;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><span class="hljs-keyword">import</span> org.springframework.core.io.ClassPathResource;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FastDFSClient</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> org.slf4j.Logger logger = LoggerFactory.getLogger(FastDFSClient.class);<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 初始化加载FastDFS的TrackerServer配置</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            String filePath = <span class="hljs-keyword">new</span> ClassPathResource(<span class="hljs-string">&quot;fdfs_client.conf&quot;</span>).getFile().getAbsolutePath();<br>            ClientGlobal.init(filePath);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            logger.error(<span class="hljs-string">&quot;FastDFS Client Init Fail!&quot;</span>,e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 文件上传</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> file</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 1.文件的组名  2.文件的路径信息</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String[] upload(FastDFSFile file) &#123;<br>        <span class="hljs-comment">//获取文件的作者</span><br>        NameValuePair[] meta_list = <span class="hljs-keyword">new</span> NameValuePair[<span class="hljs-number">1</span>];<br>        meta_list[<span class="hljs-number">0</span>] = <span class="hljs-keyword">new</span> NameValuePair(<span class="hljs-string">&quot;author&quot;</span>, file.getAuthor());<br><br>        <span class="hljs-comment">//接收返回数据</span><br>        String[] uploadResults = <span class="hljs-keyword">null</span>;<br>        StorageClient storageClient=<span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//创建StorageClient客户端对象</span><br>            storageClient = getTrackerClient();<br><br>            <span class="hljs-comment">/***</span><br><span class="hljs-comment">             * 文件上传</span><br><span class="hljs-comment">             * 1)文件字节数组</span><br><span class="hljs-comment">             * 2)文件扩展名</span><br><span class="hljs-comment">             * 3)文件作者</span><br><span class="hljs-comment">             */</span><br>            uploadResults = storageClient.upload_file(file.getContent(), file.getExt(), meta_list);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            logger.error(<span class="hljs-string">&quot;Exception when uploadind the file:&quot;</span> + file.getName(), e);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (uploadResults == <span class="hljs-keyword">null</span> &amp;&amp; storageClient!=<span class="hljs-keyword">null</span>) &#123;<br>            logger.error(<span class="hljs-string">&quot;upload file fail, error code:&quot;</span> + storageClient.getErrorCode());<br>        &#125;<br>        <span class="hljs-comment">//获取组名</span><br>        String groupName = uploadResults[<span class="hljs-number">0</span>];<br>        <span class="hljs-comment">//获取文件存储路径</span><br>        String remoteFileName = uploadResults[<span class="hljs-number">1</span>];<br>        <span class="hljs-keyword">return</span> uploadResults;<br>    &#125;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 获取文件信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> groupName:组名</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> remoteFileName：文件存储完整名</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> FileInfo <span class="hljs-title">getFile</span><span class="hljs-params">(String groupName, String remoteFileName)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            StorageClient storageClient = getTrackerClient();<br>            <span class="hljs-keyword">return</span> storageClient.get_file_info(groupName, remoteFileName);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            logger.error(<span class="hljs-string">&quot;Exception: Get File from Fast DFS failed&quot;</span>, e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 文件下载</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> groupName</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> remoteFileName</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InputStream <span class="hljs-title">downFile</span><span class="hljs-params">(String groupName, String remoteFileName)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//创建StorageClient</span><br>            StorageClient storageClient = getTrackerClient();<br><br>            <span class="hljs-comment">//下载文件</span><br>            <span class="hljs-keyword">byte</span>[] fileByte = storageClient.download_file(groupName, remoteFileName);<br>            InputStream ins = <span class="hljs-keyword">new</span> ByteArrayInputStream(fileByte);<br>            <span class="hljs-keyword">return</span> ins;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            logger.error(<span class="hljs-string">&quot;Exception: Get File from Fast DFS failed&quot;</span>, e);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 文件删除</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> groupName</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> remoteFileName</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">deleteFile</span><span class="hljs-params">(String groupName, String remoteFileName)</span></span><br><span class="hljs-function">            <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-comment">//创建StorageClient</span><br>        StorageClient storageClient = getTrackerClient();<br><br>        <span class="hljs-comment">//删除文件</span><br>        <span class="hljs-keyword">int</span> i = storageClient.delete_file(groupName, remoteFileName);<br>    &#125;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 获取Storage组</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> groupName</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> StorageServer[] getStoreStorages(String groupName)<br>            <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">//创建TrackerClient</span><br>        TrackerClient trackerClient = <span class="hljs-keyword">new</span> TrackerClient();<br>        <span class="hljs-comment">//获取TrackerServer</span><br>        TrackerServer trackerServer = trackerClient.getConnection();<br>        <span class="hljs-comment">//获取Storage组</span><br>        <span class="hljs-keyword">return</span> trackerClient.getStoreStorages(trackerServer, groupName);<br>    &#125;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 获取Storage信息,IP和端口</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> groupName</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> remoteFileName</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ServerInfo[] getFetchStorages(String groupName,<br>                                                String remoteFileName) <span class="hljs-keyword">throws</span> IOException &#123;<br>        TrackerClient trackerClient = <span class="hljs-keyword">new</span> TrackerClient();<br>        TrackerServer trackerServer = trackerClient.getConnection();<br>        <span class="hljs-keyword">return</span> trackerClient.getFetchStorages(trackerServer, groupName, remoteFileName);<br>    &#125;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 获取Tracker服务地址</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getTrackerUrl</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;http://&quot;</span>+getTrackerServer().getInetSocketAddress().getHostString()+<span class="hljs-string">&quot;:&quot;</span>+ClientGlobal.getG_tracker_http_port()+<span class="hljs-string">&quot;/&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 获取Storage客户端</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> StorageClient <span class="hljs-title">getTrackerClient</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        TrackerServer trackerServer = getTrackerServer();<br>        StorageClient storageClient = <span class="hljs-keyword">new</span> StorageClient(trackerServer, <span class="hljs-keyword">null</span>);<br>        <span class="hljs-keyword">return</span>  storageClient;<br>    &#125;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 获取Tracker</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> TrackerServer <span class="hljs-title">getTrackerServer</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        TrackerClient trackerClient = <span class="hljs-keyword">new</span> TrackerClient();<br>        TrackerServer trackerServer = trackerClient.getConnection();<br>        <span class="hljs-keyword">return</span>  trackerServer;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>文件上传 </p><p>创建一个FileController，在该控制器中实现文件上传操作，代码如下</p><p>注意:</p><ul><li>Post表示数据提交</li><li>controller方法里的参数一定是从前端传递过来的, 注意参数的名称要和前端取名对应</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/file&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileController</span> </span>&#123;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/upload&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">uploadFile</span><span class="hljs-params">(MultipartFile file)</span></span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span>(file == <span class="hljs-keyword">null</span>)&#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;文件不存在&quot;</span>);<br>            &#125;<br><br>            String originalFilename = file.getOriginalFilename();<br>            <span class="hljs-keyword">if</span>(StringUtils.isEmpty(originalFilename))&#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;文件不存在&quot;</span>);<br>            &#125;<br><br>            String extName = originalFilename.substring(originalFilename.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>) + <span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">byte</span>[] content = file.getBytes();<br><br>            FastDFSFile fastDFSFile = <span class="hljs-keyword">new</span> FastDFSFile(originalFilename, content, extName);<br><br>            String[] uploadResults = FastDFSClient.upload(fastDFSFile);<br><br>            String url = FastDFSClient.getTrackerUrl() + uploadResults[<span class="hljs-number">0</span>] + uploadResults[<span class="hljs-number">1</span>];<br><br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>, StatusCode.OK, <span class="hljs-string">&quot;文件上传成功&quot;</span>, url);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">false</span>, StatusCode.ERROR, <span class="hljs-string">&quot;文件上传失败&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>Postman</strong>测试文件上传 </p><p>测试的时候记得文件名称也取成file, 不然请求参数传到controller那里由于参数和方法里的形参对不上会报错</p></li></ol><h1 id="Part-03-微服务网关鉴权JWT"><a href="#Part-03-微服务网关鉴权JWT" class="headerlink" title="Part-03 微服务网关鉴权JWT"></a>Part-03 微服务网关鉴权JWT</h1><h2 id="1-BCrypt密码加密"><a href="#1-BCrypt密码加密" class="headerlink" title="1. BCrypt密码加密"></a>1. BCrypt密码加密</h2><h3 id="1-1-Bcypt快速入门"><a href="#1-1-Bcypt快速入门" class="headerlink" title="1.1 Bcypt快速入门"></a>1.1 Bcypt快速入门</h3><p>在用户模块，对于用户密码的保护，通常都会进行加密。我们通常对密码进行加密，然后存放在数据库中，在用户进行登录的时候，将其输入的密码进行加密然后与数据库中存放的密文进行比较，以验证用户密码是否正确。目前，MD5和BCrypt比较流行。相对来说, BCrypt比MD5更安全。因为其内部引入的加盐机制. (加盐实际上是随机生成一个29位字符的字符串) </p><p>官网: <a href="http://www.mindrot.org/projects/jBCrypt/">http://www.mindrot.org/projects/jBCrypt/</a></p><p>测试用例</p><p>注意: </p><ul><li>每次程序执行时生成盐值的密文是会变的</li><li>BCrypt不支持反运算(即通过密文得到明文), 只支持密码校验</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.security.crypto.bcrypt.BCrypt; <span class="hljs-comment">//注意这里的包别导错了</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestBCrypt</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-comment">// 1.生成盐</span><br>        String gensalt = BCrypt.gensalt();<br>        System.out.println(<span class="hljs-string">&quot;salt:&quot;</span> + gensalt);<br><br>        <span class="hljs-comment">// 2.生成密码</span><br>        String saltPassword = BCrypt.hashpw(<span class="hljs-string">&quot;123456&quot;</span>, gensalt);<br>        System.out.println(<span class="hljs-string">&quot;密码：&quot;</span> + saltPassword);<br>        <br>        <span class="hljs-comment">// 3.对密码进行校验</span><br>        <span class="hljs-keyword">boolean</span> checkpw = BCrypt.checkpw(<span class="hljs-string">&quot;123456&quot;</span>, saltPassword);<br>        System.out.println(checkpw);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-2-商城新增管理员密码加密"><a href="#1-2-商城新增管理员密码加密" class="headerlink" title="1.2 商城新增管理员密码加密"></a>1.2 商城新增管理员密码加密</h3><p>代码实现</p><p>注意:</p><ul><li>大致的框架都已经完成了,这里只是实现让密码加密这一部分过程</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 增加</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> admin</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">(Admin admin)</span></span>&#123;<br>      <span class="hljs-comment">//获取盐</span><br>      String gensalt = BCrypt.gensalt();<br>      <span class="hljs-comment">//对用户的密码进行加密</span><br>      String hashpw = BCrypt.hashpw(admin.getPassword(), gensalt);<br>      admin.setPassword(hashpw);<br>      adminMapper.insert(admin);<br>  &#125;<br></code></pre></td></tr></table></figure><p>cotroller层代码讲解</p><p>注意：</p><ul><li><code>@RequestBody</code>: 对前端传过来的json串自动赋值给这里的admin新参对象</li><li>数据库表的登录字段名称是<code>login_name</code>, 但是Admin类里是<code>loginName</code>, 不知道为啥这样也可以对应</li><li>启动服务的时候先启动注册中心的，在启动相应的微服务的类，不然会报错 <code>com.netflix.discovery.shared.transport.TransportException: Cannot execute request on any known server</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment">    * 新增数据</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> admin</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@PostMapping</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Admin admin)</span></span>&#123;<br>       adminService.add(admin);<br>       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>,StatusCode.OK,<span class="hljs-string">&quot;添加成功&quot;</span>);<br>   &#125;<br></code></pre></td></tr></table></figure><h3 id="1-3-管理员登录密码验证"><a href="#1-3-管理员登录密码验证" class="headerlink" title="1.3 管理员登录密码验证"></a>1.3 管理员登录密码验证</h3><p>需求分析:</p><p>用户发送请求，输入用户名和密码。后台管理微服务controller接收参数，验证用户名和密码是否正确，如果正确则返回用户登录成功结果, 如果错误则返回登陆失败信息。 </p><p>代码实现</p><ol><li><p>AdminService新增方法定义 login()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 用户登录</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> admin</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">login</span><span class="hljs-params">(Admin admin)</span></span>;<br></code></pre></td></tr></table></figure></li><li><p>AdminServiceImpl实现此方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">login</span><span class="hljs-params">(Admin admin)</span> </span>&#123;<br>       <span class="hljs-comment">// 根据登录名查询管理员</span><br>       Admin admin1 = <span class="hljs-keyword">new</span> Admin();<br>       admin1.setLoginName(admin.getLoginName());<br>       admin1.setStatus(<span class="hljs-string">&quot;1&quot;</span>);<br>       Admin admin2 = adminMapper.selectOne(admin1);<br>       <br>       <span class="hljs-comment">//比对数据库查询出的对象是否存在，存在则返回真，不存在则返回假</span><br>       <span class="hljs-keyword">if</span>(admin2 == <span class="hljs-keyword">null</span>)&#123;<br>           <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>       &#125; <span class="hljs-keyword">else</span> &#123;<br>           <span class="hljs-keyword">return</span> BCrypt.checkpw(admin.getPassword(), admin2.getPassword());<br>       &#125;<br>   <br>   &#125;<br></code></pre></td></tr></table></figure></li><li><p>AdminController新增方法</p><p>注意：</p><ul><li><code>@RequestBody</code>不能少，不然前端传过来的json串无法赋值给admin对象</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/login&quot;)</span>  <span class="hljs-comment">//post 表示会传递json串过来</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">login</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Admin admin)</span></span>&#123;<br>       <span class="hljs-keyword">boolean</span> login = adminService.login(admin);<br>       <span class="hljs-keyword">if</span> (login)&#123;<br>           <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>, StatusCode.OK, <span class="hljs-string">&quot;登录成功&quot;</span>);<br>       &#125; <span class="hljs-keyword">else</span> &#123;<br>           <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">false</span>, StatusCode.LOGINERROR, <span class="hljs-string">&quot;用户名或密码错误&quot;</span>);<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure></li></ol><h2 id="2-JWT-实现微服务鉴权"><a href="#2-JWT-实现微服务鉴权" class="headerlink" title="2. JWT 实现微服务鉴权"></a>2. <strong>JWT</strong> 实现微服务鉴权</h2><h3 id="2-1-什么是微服务鉴权"><a href="#2-1-什么是微服务鉴权" class="headerlink" title="2.1 什么是微服务鉴权"></a>2.1 什么是微服务鉴权</h3><img src="/images/image-20210727205423816.png" alt="image-20210727205423816"  /><p>我们可以采用JWT的方式来实现鉴权校验。</p><h3 id="2-2-JWT"><a href="#2-2-JWT" class="headerlink" title="2.2 JWT"></a>2.2 <strong>JWT</strong></h3><p>JSON Web Token（JWT）是一个非常轻巧的规范。这个规范允许我们使用JWT在用户和服务器之间传递安全可靠的信息。</p><p>一个JWT实际上就是一个字符串，它由三部分组成，头部、载荷与签名。</p><ul><li><p><strong>头部</strong>（<strong>Header</strong>） </p><p>头部用于描述关于该JWT的最基本的信息，例如其类型以及签名所用的算法等。这也可以被表示成一个JSON对象。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;typ&quot;</span>:<span class="hljs-string">&quot;JWT&quot;</span>,<span class="hljs-attr">&quot;alg&quot;</span>:<span class="hljs-string">&quot;HS256&quot;</span>&#125;<br></code></pre></td></tr></table></figure><p>在头部指明了签名算法是HS256算法。 我们进行BASE64编码，编码后的字符串如下：</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">eyJ<span class="hljs-number">0</span>eXAiOiJKV<span class="hljs-number">1</span>QiLCJhbGciOiJIUzI<span class="hljs-number">1</span><span class="hljs-symbol">NiJ9</span><br></code></pre></td></tr></table></figure></li><li><p><strong>载荷</strong>（<strong>payload</strong>）</p><p>载荷就是存放有效信息的地方。</p><p>定义一个payload:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;sub&quot;</span>:<span class="hljs-string">&quot;1234567890&quot;</span>,<span class="hljs-attr">&quot;name&quot;</span>:<span class="hljs-string">&quot;John Doe&quot;</span>,<span class="hljs-attr">&quot;admin&quot;</span>:<span class="hljs-literal">true</span>&#125;<br></code></pre></td></tr></table></figure><p>然后将其进行base64编码，得到Jwt的第二部分</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">eyJzdWIiOiIxMj<span class="hljs-name">M0</span><span class="hljs-symbol">NTY3</span>ODkwIiwibmFtZSI<span class="hljs-number">6</span>Ikpva<span class="hljs-name">G4</span>gR<span class="hljs-name">G9</span>lIiwiYWRtaW<span class="hljs-number">4</span>iO<span class="hljs-symbol">nRydWV9</span><br></code></pre></td></tr></table></figure></li><li><p><strong>签证</strong>（<strong>signature</strong>）</p><p>jwt的第三部分是一个签证信息，这个签证信息由三部分组成：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute"><span class="hljs-nomarkup">header</span></span> (base<span class="hljs-number">64</span>后的)<br><span class="hljs-attribute">payload</span> (base<span class="hljs-number">64</span>后的)<br><span class="hljs-attribute">secret</span> <br></code></pre></td></tr></table></figure><p>然后通过header中声明的加密方式进行加盐secret组合加密，然后就构成了jwt的第三部分（第三部分就包括了一二部分）</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">TJVA<span class="hljs-number">95</span><span class="hljs-keyword">Or</span><span class="hljs-name">M7</span>E<span class="hljs-number">2</span>cBab<span class="hljs-number">30</span>RMHrHDcEfxjoYZgeFO<span class="hljs-symbol">NFh7</span>HgQ<br></code></pre></td></tr></table></figure></li></ul><p>将这三部分用.连接成一个完整的字符串,构成了最终的jwt: </p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9</span>.eyJzdWIiOiIxMjM<span class="hljs-number">0</span>NTY<span class="hljs-number">3</span>ODkwIiwibmFtZSI<span class="hljs-number">6</span>IkpvaG<span class="hljs-number">4</span>gRG<span class="hljs-number">9</span>lIiwiYWRtaW<span class="hljs-number">4</span>iOnRydWV<span class="hljs-number">9</span>.TJVA<span class="hljs-number">95</span>OrM<span class="hljs-number">7</span>E<span class="hljs-number">2</span>cBab<span class="hljs-number">30</span>RMHrHDcEfxjoYZgeFONFh<span class="hljs-number">7</span>HQ<br></code></pre></td></tr></table></figure><h3 id="2-3-JJWT签发与验证token"><a href="#2-3-JJWT签发与验证token" class="headerlink" title="2.3 JJWT签发与验证token"></a>2.3 <strong>JJWT</strong>签发与验证<strong>token</strong></h3><p>JJWT是一个提供端到端的JWT创建和验证的Java库。永远免费和开源(Apache License，版本2.0)，JJWT很容易使用和理解。它被设计成一个以建筑为中心的流畅界面，隐藏了它的大部分复杂性。 </p><p>官方文档： <a href="https://github.com/jwtk/jjwt">https://github.com/jwtk/jjwt</a> </p><h4 id="2-3-1-创建token"><a href="#2-3-1-创建token" class="headerlink" title="2.3.1 创建token"></a>2.3.1 创建<strong>token</strong></h4><ol><li><p>新建项目jwtTest中的pom.xml中添加依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>创建测试类，代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JwtTest</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        JwtBuilder builder = Jwts.builder()<br>                                .setId(<span class="hljs-string">&quot;888&quot;</span>)<br>                                .setSubject(<span class="hljs-string">&quot;小白&quot;</span>)<br>                                .setIssuedAt(<span class="hljs-keyword">new</span> Date())<br>                                .signWith(SignatureAlgorithm.HS256, <span class="hljs-string">&quot;itcast&quot;</span>);<br><br>        System.out.println(builder.compact());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>运行打印结果：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">eyJhbGciOiJIUzI1NiJ9</span>.eyJqdGkiOiI<span class="hljs-number">4</span>ODgiLCJzdWIiOiLlsI_nmb<span class="hljs-number">0</span>iLCJpYXQiOjE<span class="hljs-number">2</span>MjczOTI<span class="hljs-number">3</span>MzR<span class="hljs-number">9</span>.Je<span class="hljs-number">1</span>REFE<span class="hljs-number">0</span>D<span class="hljs-number">0</span>w<span class="hljs-number">9</span>eV<span class="hljs-number">3</span>rUl<span class="hljs-number">6</span>sqQN<span class="hljs-number">4</span>m<span class="hljs-number">3</span>Z-LSShbyn<span class="hljs-number">8</span>JGleEgw<br></code></pre></td></tr></table></figure><p>由于载荷中包含时间，每次生成的jwt是不一样的。</p></li></ol><h4 id="2-3-2-解析token"><a href="#2-3-2-解析token" class="headerlink" title="2.3.2 解析token"></a>2.3.2 解析<strong>token</strong></h4><p>我们刚才已经创建了token ，在web应用中这个操作是由服务端进行然后发给客户端，客户端在下次向服务端发送请求时需要携带这个token，那服务端接到这个token 应该解析出token中的信息（例如用户id）,根据这些信息查询数据库返回相应的结果。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JwtTest</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        JwtBuilder builder = Jwts.builder()<br>                                .setId(<span class="hljs-string">&quot;888&quot;</span>)<br>                                .setSubject(<span class="hljs-string">&quot;小白&quot;</span>)<br>                                .setIssuedAt(<span class="hljs-keyword">new</span> Date())<br>                                .signWith(SignatureAlgorithm.HS256, <span class="hljs-string">&quot;itcast&quot;</span>);<br><br>        String compactJwt = builder.compact();<br>        System.out.println(compactJwt);<br><br>        Claims claims = Jwts.parser().setSigningKey(<span class="hljs-string">&quot;itcast&quot;</span>).parseClaimsJws(compactJwt).getBody();<br>        System.out.println(claims);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gcode">eyJhbGciOiJIUzI<span class="hljs-number">1</span><span class="hljs-symbol">NiJ9</span>.eyJqdGkiOiI<span class="hljs-number">4</span>ODgiLCJzdWIiOiLlsI_<span class="hljs-symbol">nmb0</span>iLCJpYXQiOjE<span class="hljs-number">2</span>MjczOT<span class="hljs-name">M2</span><span class="hljs-symbol">NDN9</span><span class="hljs-number">.2</span>QzU<span class="hljs-number">2</span>Z-MSSGpspIe<span class="hljs-number">9</span>za<span class="hljs-number">7</span>SmkLJT<span class="hljs-number">2</span>tqHv<span class="hljs-number">9</span>mOBQ<span class="hljs-symbol">N1</span>JWqBU<br>&#123;jti=<span class="hljs-number">888</span>, <span class="hljs-keyword">sub</span>=小白, iat=<span class="hljs-number">1627393643</span>&#125;<br></code></pre></td></tr></table></figure><p>试着将token或签名秘钥(代码里面的<code>&quot;itcast&quot;</code>字符串)篡改一下，会发现运行时就会报错，所以解析token也就是验证token.</p><p>还可以设置token的过期时间，自定义claims(载荷里的键值对)等。具体用法可以上网查也可以看本地笔记。</p><h3 id="2-4-畅购微服务鉴权代码实现"><a href="#2-4-畅购微服务鉴权代码实现" class="headerlink" title="2.4 畅购微服务鉴权代码实现"></a>2.4 畅购微服务鉴权代码实现</h3><h4 id="2-4-1-思路分析"><a href="#2-4-1-思路分析" class="headerlink" title="2.4.1 思路分析"></a>2.4.1 思路分析</h4><img src="/images/image-20210727225002149.png" alt="image-20210727225002149" style="zoom:80%;" /><ol><li>用户进入网关开始登陆，网关过滤器进行判断，如果是登录，则路由到后台管理微服务进行登录</li><li>用户登录成功，后台管理微服务签发JWT TOKEN信息返回给用户 </li><li>用户再次进入网关开始访问，网关过滤器接收用户携带的TOKEN </li><li>网关过滤器解析TOKEN ，判断是否有权限，如果有，则放行，如果没有则返回未认证错误</li></ol><h4 id="2-4-2-系统微服务签发token"><a href="#2-4-2-系统微服务签发token" class="headerlink" title="2.4.2 系统微服务签发token"></a>2.4.2 系统微服务签发<strong>token</strong></h4><ol><li><p>在changgou_service_system添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>在changgou_service_system的util包中创建类： JwtUtil (这个工具类会用就行，需要深入学习的时候再学)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * JWT工具类</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JwtUtil</span> </span>&#123;<br><br>    <span class="hljs-comment">//有效期为</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Long JWT_TTL = <span class="hljs-number">3600000L</span>;<span class="hljs-comment">// 60 * 60 *1000  一个小时</span><br>    <span class="hljs-comment">//设置秘钥明文</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String JWT_KEY = <span class="hljs-string">&quot;itcast&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建token</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> subject</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> ttlMillis</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">createJWT</span><span class="hljs-params">(String id, String subject, Long ttlMillis)</span> </span>&#123;<br><br>        SignatureAlgorithm signatureAlgorithm = SignatureAlgorithm.HS256;<br>        <span class="hljs-keyword">long</span> nowMillis = System.currentTimeMillis();<br>        Date now = <span class="hljs-keyword">new</span> Date(nowMillis);<br>        <span class="hljs-keyword">if</span>(ttlMillis==<span class="hljs-keyword">null</span>)&#123;<br>            ttlMillis=JwtUtil.JWT_TTL;<br>        &#125;<br>        <span class="hljs-keyword">long</span> expMillis = nowMillis + ttlMillis;<br>        Date expDate = <span class="hljs-keyword">new</span> Date(expMillis);<br>        SecretKey secretKey = generalKey();<br><br>        JwtBuilder builder = Jwts.builder()<br>                .setId(id)              <span class="hljs-comment">//唯一的ID</span><br>                .setSubject(subject)   <span class="hljs-comment">// 主题  可以是JSON数据</span><br>                .setIssuer(<span class="hljs-string">&quot;admin&quot;</span>)     <span class="hljs-comment">// 签发者</span><br>                .setIssuedAt(now)      <span class="hljs-comment">// 签发时间</span><br>                .signWith(signatureAlgorithm, secretKey) <span class="hljs-comment">//使用HS256对称加密算法签名, 第二个参数为秘钥</span><br>                .setExpiration(expDate);<span class="hljs-comment">// 设置过期时间</span><br>        <span class="hljs-keyword">return</span> builder.compact();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 生成加密后的秘钥 secretKey</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SecretKey <span class="hljs-title">generalKey</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">byte</span>[] encodedKey = Base64.getDecoder().decode(JwtUtil.JWT_KEY);<br>        SecretKey key = <span class="hljs-keyword">new</span> SecretKeySpec(encodedKey, <span class="hljs-number">0</span>, encodedKey.length, <span class="hljs-string">&quot;AES&quot;</span>);<br>        <span class="hljs-keyword">return</span> key;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>修改AdminController的login方法, 用户登录成功 则签发TOKEN</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/login&quot;)</span>  <span class="hljs-comment">//post 表示会传递json串过来</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">login</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Admin admin)</span></span>&#123;<br>       <span class="hljs-keyword">boolean</span> login = adminService.login(admin);<br>       <span class="hljs-keyword">if</span> (login)&#123;  <span class="hljs-comment">//如果验证成功</span><br>           Map&lt;String, String&gt; info = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>           info.put(<span class="hljs-string">&quot;username&quot;</span>, admin.getLoginName());<br>           String token = JwtUtil.createJWT(UUID.randomUUID().toString(), admin.getLoginName(), <span class="hljs-keyword">null</span>);<br>           info.put(<span class="hljs-string">&quot;token&quot;</span>, token);<br>           <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>, StatusCode.OK, <span class="hljs-string">&quot;登录成功&quot;</span>, info);<br>       &#125; <span class="hljs-keyword">else</span> &#123;<br>           <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">false</span>, StatusCode.LOGINERROR, <span class="hljs-string">&quot;用户名或密码错误&quot;</span>);<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure></li></ol><p>使用postman测试</p><h4 id="2-4-3-网关过滤器验证token"><a href="#2-4-3-网关过滤器验证token" class="headerlink" title="2.4.3 网关过滤器验证token"></a>2.4.3 网关过滤器验证<strong>token</strong></h4><ol><li><p>在changgou_gateway_system网关系统添加依赖 </p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>          <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>util包下创建JWTUtil类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * JWT工具类</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JwtUtil</span> </span>&#123;<br><br>    <span class="hljs-comment">//有效期为</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Long JWT_TTL = <span class="hljs-number">3600000L</span>;<span class="hljs-comment">// 60 * 60 *1000  一个小时</span><br>    <span class="hljs-comment">//设置秘钥明文</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String JWT_KEY = <span class="hljs-string">&quot;itcast&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建token</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> subject</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> ttlMillis</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">createJWT</span><span class="hljs-params">(String id, String subject, Long ttlMillis)</span> </span>&#123;<br><br>        SignatureAlgorithm signatureAlgorithm = SignatureAlgorithm.HS256;<br>        <span class="hljs-keyword">long</span> nowMillis = System.currentTimeMillis();<br>        Date now = <span class="hljs-keyword">new</span> Date(nowMillis);<br>        <span class="hljs-keyword">if</span>(ttlMillis==<span class="hljs-keyword">null</span>)&#123;<br>            ttlMillis=JwtUtil.JWT_TTL;<br>        &#125;<br>        <span class="hljs-keyword">long</span> expMillis = nowMillis + ttlMillis;<br>        Date expDate = <span class="hljs-keyword">new</span> Date(expMillis);<br>        SecretKey secretKey = generalKey();<br><br>        JwtBuilder builder = Jwts.builder()<br>                .setId(id)              <span class="hljs-comment">//唯一的ID</span><br>                .setSubject(subject)   <span class="hljs-comment">// 主题  可以是JSON数据</span><br>                .setIssuer(<span class="hljs-string">&quot;admin&quot;</span>)     <span class="hljs-comment">// 签发者</span><br>                .setIssuedAt(now)      <span class="hljs-comment">// 签发时间</span><br>                .signWith(signatureAlgorithm, secretKey) <span class="hljs-comment">//使用HS256对称加密算法签名, 第二个参数为秘钥</span><br>                .setExpiration(expDate);<span class="hljs-comment">// 设置过期时间</span><br>        <span class="hljs-keyword">return</span> builder.compact();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 生成加密后的秘钥 secretKey</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SecretKey <span class="hljs-title">generalKey</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">byte</span>[] encodedKey = Base64.getDecoder().decode(JwtUtil.JWT_KEY);<br>        SecretKey key = <span class="hljs-keyword">new</span> SecretKeySpec(encodedKey, <span class="hljs-number">0</span>, encodedKey.length, <span class="hljs-string">&quot;AES&quot;</span>);<br>        <span class="hljs-keyword">return</span> key;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>创建过滤器，用于token验证</p><p>注意：记得把过滤类放入spring容器中，不要忘了<code>@Component</code>注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthorizeFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">GlobalFilter</span>, <span class="hljs-title">Ordered</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;<br>        <span class="hljs-comment">//1.获取请求</span><br>        ServerHttpRequest request = exchange.getRequest();<br>        <span class="hljs-comment">//2.获取响应</span><br>        ServerHttpResponse response = exchange.getResponse();<br>        <span class="hljs-comment">//3.如果是登录请求则放行</span><br>        <span class="hljs-keyword">if</span>(request.getURI().getPath().contains(<span class="hljs-string">&quot;/admin/login&quot;</span>))&#123;<br>            <span class="hljs-keyword">return</span> chain.filter(exchange);<br>        &#125;<br>        <span class="hljs-comment">//4.获取请求头</span><br>        HttpHeaders headers = request.getHeaders();<br>        <span class="hljs-comment">//5.获取请求头中的令牌。自己写路径的时候记得按照key=Authorization, value=token的形式来，不要瞎起名字</span><br>        String token = headers.getFirst(<span class="hljs-string">&quot;Authorization&quot;</span>);<br>        <span class="hljs-comment">//6.判断请求头中是否有令牌</span><br>        <span class="hljs-keyword">if</span>(StringUtils.isEmpty(token))&#123;<br>            <span class="hljs-comment">//7. 响应中放入返回的状态吗, 没有权限访问</span><br>            response.setStatusCode(HttpStatus.UNAUTHORIZED);<br>            <span class="hljs-comment">//8.返回</span><br>            <span class="hljs-keyword">return</span> response.setComplete();<br>        &#125;<br>        <span class="hljs-comment">//9.如果请求头中有令牌则解析令牌</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            JwtUtil.parseJWT(token);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-comment">//10. 解析jwt令牌出错, 说明令牌过期或者伪造等不合法情况出现</span><br>            response.setStatusCode(HttpStatus.UNAUTHORIZED);<br>            <span class="hljs-comment">//11.返回</span><br>            <span class="hljs-keyword">return</span> response.setComplete();<br>        &#125;<br><br>        <span class="hljs-comment">//12.放行</span><br>        <span class="hljs-keyword">return</span> chain.filter(exchange);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getOrder</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><p>最后再postman中进行测试</p><h1 id="Part-04-商品管理"><a href="#Part-04-商品管理" class="headerlink" title="Part-04 商品管理"></a>Part-04 商品管理</h1><h2 id="1-分布式ID生成解决方案"><a href="#1-分布式ID生成解决方案" class="headerlink" title="1. 分布式ID生成解决方案"></a>1. 分布式<strong>ID</strong>生成解决方案</h2><p>数据太多导致数据库单表性能下降，需要对数据库进行分库分表、数据库多实例部署等，如果此时这张表还按照主键自增，因为已经不在一个机器上了，这种方式会使主键重复。为了避免ID重复，因此需要分布式ID</p><h3 id="1-1-分布式ID生成解决方案"><a href="#1-1-分布式ID生成解决方案" class="headerlink" title="1.1 分布式ID生成解决方案"></a>1.1 分布式<strong>ID</strong>生成解决方案</h3><p>UUID, Redis, 开源算法<strong>snowflake</strong> 都可以实现分布式ID。这里主要讲下开源算法<strong>snowflake</strong> ，其他的如果用到去网上搜博客深入学习。</p><h4 id="1-1-1-开源算法snowflake"><a href="#1-1-1-开源算法snowflake" class="headerlink" title="1.1.1 开源算法snowflake"></a>1.1.1 开源算法<strong>snowflake</strong></h4><p>snowflake是Twitter开源的分布式ID生成算法，结果是一个long型（8字节，64位）的ID。其核心思想是：使用41bit作为毫秒数，10bit作为机器的ID（5个bit是数据中心，5个bit的机器ID），12bit作为毫秒内的流水号（意味着每个节点在每毫秒可以产生 4096 个 ID），最后还有一个符号位，永远是0</p><img src="/images/image-20210728121416974.png" alt="image-20210728121416974" style="zoom:80%;" /><p>快速入门</p><ol><li><p>新建工程，将资料/工具类下的IdWorker.java拷贝到工程中 （这个工具类会用就行了，需要深入学习时再细看）</p></li><li><p>编写代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">snowFlakeTest</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        IdWorker idWorker = <span class="hljs-keyword">new</span> IdWorker(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; ++i) &#123;<br>            <span class="hljs-keyword">long</span> id = idWorker.nextId();<br>            System.out.println(id);<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="1-1-2-配置分布式ID生成器"><a href="#1-1-2-配置分布式ID生成器" class="headerlink" title="1.1.2 配置分布式ID生成器"></a>1.1.2 配置分布式<strong>ID</strong>生成器</h4><ol><li><p>IdWorker.java拷贝到changgou_common工程com.changgou.util包中 （放到common包是因为微服务都要用到他。如果把这个类部署到微服务会很麻烦，要一个一个部署）</p></li><li><p>changgou_service_goods的application.yml添加配置 </p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">workerId:</span> <span class="hljs-number">0</span><br><span class="hljs-attr">datacenterId:</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure></li><li><p>修改GoodsApplication, 增加代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Value(&quot;$&#123;workerId&#125;&quot;)</span><br>   <span class="hljs-keyword">private</span> Integer workerId;<br>   <br>   <span class="hljs-meta">@Value(&quot;$&#123;datacenterId&#125;&quot;)</span><br>   <span class="hljs-keyword">private</span> Integer  datacenterId;<br>   <br>   <span class="hljs-meta">@Bean</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> IdWorker <span class="hljs-title">idWorker</span><span class="hljs-params">()</span></span>&#123;<br>       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> IdWorker(workerId,datacenterId);<br>   &#125;<br></code></pre></td></tr></table></figure></li></ol><h2 id="2-新增和修改商品"><a href="#2-新增和修改商品" class="headerlink" title="2. 新增和修改商品"></a>2. 新增和修改商品</h2><h3 id="2-1-概念与表结构分析"><a href="#2-1-概念与表结构分析" class="headerlink" title="2.1 概念与表结构分析"></a><strong>2.1</strong> 概念与表结构分析</h3><h4 id="2-1-1-SPU与SKU概念"><a href="#2-1-1-SPU与SKU概念" class="headerlink" title="2.1.1 SPU与SKU概念"></a><strong>2.1.1 SPU</strong>与<strong>SKU</strong>概念</h4><p><strong>SPU = Standard Product Unit （标准产品单位）</strong> </p><ul><li><p>概念 : SPU 是商品信息聚合的最小单位，是一组可复用、易检索的标准化信息的集合，该集合描述了一个产品的特性。 </p></li><li><p>通俗点讲，属性值、特性相同的货品就可以称为一个 SPU</p><p>例如：华为<strong>P30</strong> 就是一个 <strong>SPU</strong> </p></li></ul><p><strong>SKU=stock keeping unit ( 库存量单位)</strong></p><ul><li><p>SKU 即库存进出计量的单位， 可以是以件、盒、托盘等为单位。</p></li><li><p>SKU 是物理上不可分割的最小存货单元。在使用时要根据不同业态，不同管理模式来处理。</p><p>例如：华为<strong>P30</strong> 红色 <strong>64G</strong> 就是一个 <strong>SKU</strong></p></li></ul><h4 id="2-1-2-表结构分析"><a href="#2-1-2-表结构分析" class="headerlink" title="2.1.2 表结构分析"></a><strong>2.1.2</strong> 表结构分析</h4><p>tb_spu 表 （SPU表）</p><img src="/images/image-20210728142103218.png" alt="image-20210728142103218"  /><p>tb_sku 表（SKU商品表）</p><p><img src="/images/image-20210728142351938.png" alt="image-20210728142351938"></p><h3 id="2-2-代码实现"><a href="#2-2-代码实现" class="headerlink" title="2.2 代码实现"></a><strong>2.2</strong> 代码实现</h3><h4 id="2-2-1-SPU与SKU列表的保存"><a href="#2-2-1-SPU与SKU列表的保存" class="headerlink" title="2.2.1 SPU与SKU列表的保存"></a>2.2.1 <strong>SPU</strong>与<strong>SKU</strong>列表的保存</h4><ol><li><p>changgou_service_goods_api工程的pojo包中创建组合实体类Goods </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Goods</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span></span>&#123;<br><br>    <span class="hljs-keyword">private</span> Spu spu;<br>    <span class="hljs-keyword">private</span> List&lt;Sku&gt; skuList;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Spu <span class="hljs-title">getSpu</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> spu;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setSpu</span><span class="hljs-params">(Spu spu)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.spu = spu;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Sku&gt; <span class="hljs-title">getSkuList</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> skuList;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setSkuList</span><span class="hljs-params">(List&lt;Sku&gt; skuList)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.skuList = skuList;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>changgou_service_goods工程SpuService新增方法add(Goods goods) </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment">    * 新增</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> goods</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">(Goods goods)</span></span>;<br></code></pre></td></tr></table></figure></li><li><p>changgou_service_goods工程SpuServiceImpl实现此方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br>   <span class="hljs-keyword">private</span> CategoryMapper categoryMapper;<br>   <span class="hljs-meta">@Autowired</span><br>   <span class="hljs-keyword">private</span> SkuMapper skuMapper;<br>   <span class="hljs-meta">@Autowired</span><br>   <span class="hljs-keyword">private</span> BrandMapper brandMapper;<br>   <span class="hljs-meta">@Autowired</span><br>   <span class="hljs-keyword">private</span> IdWorker idWorker;<br>   <br><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 增加</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> goods</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@Transactional</span><br>   <span class="hljs-meta">@Override</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">(Goods goods)</span></span>&#123;<br>   <br>       Spu spu = goods.getSpu();<br>       <span class="hljs-keyword">long</span> spuId = idWorker.nextId();<br>       spu.setId(String.valueOf(spuId));<br>       spu.setIsDelete(<span class="hljs-string">&quot;0&quot;</span>);<br>       spu.setIsMarketable(<span class="hljs-string">&quot;0&quot;</span>);<br>       spu.setStatus(<span class="hljs-string">&quot;0&quot;</span>);<br>       spuMapper.insertSelective(spu);<br>   <br>       saveSkuList(goods);<br>   &#125;<br>   <br>   <span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 保存sku列表。</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> goods</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * 这里单独加一个方法是因为这个操作步骤较多</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">saveSkuList</span><span class="hljs-params">(Goods goods)</span> </span>&#123;<br>       <span class="hljs-comment">//获取spu对象</span><br>       Spu spu = goods.getSpu();<br>       <span class="hljs-comment">//获取当前日期</span><br>       Date date = <span class="hljs-keyword">new</span> Date();<br>       <span class="hljs-comment">//获取品牌对象</span><br>       Brand brand = brandMapper.selectByPrimaryKey(spu.getBrandId());<br>       <span class="hljs-comment">//获取分类对象</span><br>       Category category = categoryMapper.selectByPrimaryKey(spu.getCategory3Id());<br>       <span class="hljs-comment">//获取sku集合对象</span><br>       List&lt;Sku&gt; skuList = goods.getSkuList();<br>   <br>       <span class="hljs-keyword">if</span>(skuList != <span class="hljs-keyword">null</span>)&#123;<br>           <span class="hljs-comment">//小技巧： 直接打 iter 可以快速出来下面的遍历代码</span><br>           <span class="hljs-keyword">for</span> (Sku sku : skuList) &#123;<br>               <span class="hljs-comment">//设置sku主键ID</span><br>               sku.setId(String.valueOf(idWorker.nextId()));<br>               <span class="hljs-comment">//设置sku规格</span><br>               <span class="hljs-keyword">if</span>(sku.getSpec() == <span class="hljs-keyword">null</span> || <span class="hljs-string">&quot;&quot;</span>.equals(sku.getSpec()))&#123;<br>                   sku.setSpec(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>);<br>               &#125;<br>               <span class="hljs-comment">//设置sku名称(商品名称 + 规格)</span><br>               String name = spu.getName();<br>               <span class="hljs-comment">//将规格json字符串转换成Map</span><br>               Map&lt;String, String&gt; specMap = JSON.parseObject(sku.getSpec(), Map.class);<br>               <span class="hljs-keyword">if</span> (specMap != <span class="hljs-keyword">null</span> &amp;&amp; specMap.size() &gt;<span class="hljs-number">0</span>)&#123;<br>                   <span class="hljs-keyword">for</span> (String value : specMap.values()) &#123;<br>                       name += <span class="hljs-string">&quot; &quot;</span>+value;<br>                   &#125;<br>               &#125;<br>   <br>               sku.setName(name);<span class="hljs-comment">//名称</span><br>               sku.setSpuId(spu.getId());<span class="hljs-comment">//设置spu的ID</span><br>               sku.setCreateTime(date);<span class="hljs-comment">//创建日期</span><br>               sku.setUpdateTime(date);<span class="hljs-comment">//修改日期</span><br>               sku.setCategoryId(category.getId());<span class="hljs-comment">//商品分类ID</span><br>               sku.setCategoryName(category.getName());<span class="hljs-comment">//商品分类名称</span><br>               sku.setBrandName(brand.getName());<span class="hljs-comment">//品牌名称</span><br>               skuMapper.insertSelective(sku);<span class="hljs-comment">//插入sku表数据</span><br>           &#125;<br>       &#125;<br>   <br>   &#125;<br></code></pre></td></tr></table></figure></li><li><p>修改SpuController的add方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment">    * 新增数据</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> goods</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@PostMapping</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Goods goods)</span></span>&#123;<br>       spuService.add(goods);<br>       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>,StatusCode.OK,<span class="hljs-string">&quot;添加成功&quot;</span>);<br>   &#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="2-2-2-品牌与分类关联"><a href="#2-2-2-品牌与分类关联" class="headerlink" title="2.2.2 品牌与分类关联"></a>2.2.2 品牌与分类关联</h4><p>将分类ID与SPU的品牌ID 一起插入到tb_category_brand表中</p><ol><li><p>创建实体类</p><p>注意：</p><ul><li>这个表是联合主键，所以categoryId和brandId都有@Id注解</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Table(name=&quot;tb_category_brand&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CategoryBrand</span> </span>&#123;<br><br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-keyword">private</span> Integer categoryId;<br><br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-keyword">private</span> Integer brandId;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getCategoryId</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> categoryId;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCategoryId</span><span class="hljs-params">(Integer categoryId)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.categoryId = categoryId;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getBrandId</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> brandId;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setBrandId</span><span class="hljs-params">(Integer brandId)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.brandId = brandId;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>新建数据访问接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CategoryBrandMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Mapper</span>&lt;<span class="hljs-title">CategoryBrand</span>&gt; </span>&#123;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>SpuServiceImpl引入</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> CategoryBrandMapper categoryBrandMapper;<br></code></pre></td></tr></table></figure></li><li><p>修改SpuServiceImpl的saveSkuList方法，添加分类与品牌之间的关联, 修改后代码如下:</p><p>注意：</p><ul><li>在原基础上添加的部分在两个<code>=</code>之间</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 保存sku列表。</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> goods</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">saveSkuList</span><span class="hljs-params">(Goods goods)</span> </span>&#123;<br>       <span class="hljs-comment">//获取spu对象</span><br>       Spu spu = goods.getSpu();<br>       <span class="hljs-comment">//获取当前日期</span><br>       Date date = <span class="hljs-keyword">new</span> Date();<br>       <span class="hljs-comment">//获取品牌对象</span><br>       Brand brand = brandMapper.selectByPrimaryKey(spu.getBrandId());<br>       <span class="hljs-comment">//获取分类对象</span><br>       Category category = categoryMapper.selectByPrimaryKey(spu.getCategory3Id());<br>   <br>       <span class="hljs-comment">// =========================================</span><br>       <span class="hljs-comment">/**</span><br><span class="hljs-comment">        * 添加分类与品牌之间的关联</span><br><span class="hljs-comment">        */</span><br>       CategoryBrand categoryBrand = <span class="hljs-keyword">new</span> CategoryBrand();<br>       categoryBrand.setBrandId(spu.getBrandId());<br>       categoryBrand.setCategoryId(spu.getCategory3Id());<br>       <span class="hljs-keyword">int</span> count = categoryBrandMapper.selectCount(categoryBrand);<br>       <span class="hljs-comment">//判断是否有这个品牌和分类的关系数据</span><br>       <span class="hljs-keyword">if</span>(count == <span class="hljs-number">0</span>)&#123;<br>           <span class="hljs-comment">//如果没有关系数据则添加品牌和分类关系数据</span><br>           categoryBrandMapper.insert(categoryBrand);<br>       &#125;<br>       <span class="hljs-comment">// =========================================</span><br>       <br>       <span class="hljs-comment">//获取sku集合对象</span><br>       List&lt;Sku&gt; skuList = goods.getSkuList();<br>   <br>       <span class="hljs-keyword">if</span>(skuList != <span class="hljs-keyword">null</span>)&#123;<br>           <span class="hljs-comment">//小技巧： 直接打 iter 可以快速出来下面的遍历代码</span><br>           <span class="hljs-keyword">for</span> (Sku sku : skuList) &#123;<br>               <span class="hljs-comment">//设置sku主键ID</span><br>               sku.setId(String.valueOf(idWorker.nextId()));<br>               <span class="hljs-comment">//设置sku规格</span><br>               <span class="hljs-keyword">if</span>(sku.getSpec() == <span class="hljs-keyword">null</span> || <span class="hljs-string">&quot;&quot;</span>.equals(sku.getSpec()))&#123;<br>                   sku.setSpec(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>);<br>               &#125;<br>               <span class="hljs-comment">//设置sku名称(商品名称 + 规格)</span><br>               String name = spu.getName();<br>               <span class="hljs-comment">//将规格json字符串转换成Map</span><br>               Map&lt;String, String&gt; specMap = JSON.parseObject(sku.getSpec(), Map.class);<br>               <span class="hljs-keyword">if</span> (specMap != <span class="hljs-keyword">null</span> &amp;&amp; specMap.size() &gt;<span class="hljs-number">0</span>)&#123;<br>                   <span class="hljs-keyword">for</span> (String value : specMap.values()) &#123;<br>                       name += <span class="hljs-string">&quot; &quot;</span>+value;<br>                   &#125;<br>               &#125;<br>   <br>               sku.setName(name);<span class="hljs-comment">//名称</span><br>               sku.setSpuId(spu.getId());<span class="hljs-comment">//设置spu的ID</span><br>               sku.setCreateTime(date);<span class="hljs-comment">//创建日期</span><br>               sku.setUpdateTime(date);<span class="hljs-comment">//修改日期</span><br>               sku.setCategoryId(category.getId());<span class="hljs-comment">//商品分类ID</span><br>               sku.setCategoryName(category.getName());<span class="hljs-comment">//商品分类名称</span><br>               sku.setBrandName(brand.getName());<span class="hljs-comment">//品牌名称</span><br>               skuMapper.insertSelective(sku);<span class="hljs-comment">//插入sku表数据</span><br>           &#125;<br>       &#125;<br>   <br>   &#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="2-2-3-根据ID查询商品"><a href="#2-2-3-根据ID查询商品" class="headerlink" title="2.2.3 根据ID查询商品"></a>2.2.3 根据ID查询商品</h4><p>需求：根据id 查询SPU和SKU列表 , 结果以goods对象返回</p><p>代码实现：</p><ol><li><p>changgou_service_goods工程SpuService新增方法定义</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 根据ID查询商品</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-function">Goods <span class="hljs-title">findGoodsById</span><span class="hljs-params">(String id)</span></span>;<br></code></pre></td></tr></table></figure></li><li><p>changgou_service_goods工程SpuServiceImpl实现此方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Goods <span class="hljs-title">findGoodsById</span><span class="hljs-params">(String id)</span> </span>&#123;<br>    <span class="hljs-comment">//查询spu</span><br>    Spu spu = spuMapper.selectByPrimaryKey(id);<br>    <span class="hljs-comment">//查询SKU 列表</span><br>    Example example = <span class="hljs-keyword">new</span> Example(Sku.class);<br>    Example.Criteria criteria = example.createCriteria();<br>    criteria.andEqualTo(<span class="hljs-string">&quot;spuId&quot;</span>, id);<br>    List&lt;Sku&gt; skuList = skuMapper.selectByExample(example);<br>   <br>    <span class="hljs-comment">//封装，返回</span><br>    Goods goods = <span class="hljs-keyword">new</span> Goods();<br>    goods.setSpu(spu);<br>    goods.setSkuList(skuList);<br>    <span class="hljs-keyword">return</span> goods;<br>&#125;<br>   <br></code></pre></td></tr></table></figure></li><li><p>修改SpuController的findById方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">findById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span></span>&#123;<br>    Goods goods = spuService.findGoodsById(id);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>,StatusCode.OK,<span class="hljs-string">&quot;查询成功&quot;</span>,goods);<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="2-2-4-保存修改"><a href="#2-2-4-保存修改" class="headerlink" title="2.2.4 保存修改"></a>2.2.4 保存修改</h4><ol><li><p>changgou_service_goods工程SpuService新增方法定义</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 修改数据</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> goods</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">update</span><span class="hljs-params">(Goods goods)</span></span>;<br></code></pre></td></tr></table></figure></li><li><p>changgou_service_goods工程SpuServiceImpl实现此方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">update</span><span class="hljs-params">(Goods goods)</span> </span>&#123;<br>       <span class="hljs-comment">//取出spu部分</span><br>       Spu spu = goods.getSpu();<br>       spuMapper.updateByPrimaryKey(spu);<br>   <br>       <span class="hljs-comment">//删除原sku列表</span><br>       Example example = <span class="hljs-keyword">new</span> Example(Sku.class);<br>       Example.Criteria criteria = example.createCriteria();<br>       criteria.andEqualTo(<span class="hljs-string">&quot;spuId&quot;</span>, spu.getId());<br>       skuMapper.deleteByExample(example);<br>   <br>       <span class="hljs-comment">//保存sku列表</span><br>       saveSkuList(goods);<br>   &#125;<br></code></pre></td></tr></table></figure></li><li><p>修改SpuController的update方法</p><p>注意：</p><ul><li><code>&#123;id&#125;</code>是把请求路径中对应部分的字符串赋值给id, 并不是要在请求路径中拼接 <code>？id=string</code>这种写法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/***</span><br><span class="hljs-comment">    * 修改数据</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> goods</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@PutMapping(value=&quot;/&#123;id&#125;&quot;)</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">update</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Goods goods,<span class="hljs-meta">@PathVariable</span> String id)</span></span>&#123;<br>       spuService.update(goods);<br>       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>,StatusCode.OK,<span class="hljs-string">&quot;修改成功&quot;</span>);<br>   &#125;<br></code></pre></td></tr></table></figure></li></ol><h2 id="3-商品审核与上下架"><a href="#3-商品审核与上下架" class="headerlink" title="3. 商品审核与上下架"></a>3. 商品审核与上下架</h2><p>需求分析：</p><ul><li>商品新增后，审核状态为0（未审核），默认为下架状态(也为0)</li><li>审核商品，需要校验是否是被删除的商品，如果未删除则修改审核状态为1，并自动上架</li><li>下架商品，需要校验是否是被删除的商品，如果未删除则修改上架状态为0</li><li>上架商品，需要审核状态为1,如果为1,则更改上下架状态为1</li></ul><p>实现思路：</p><ul><li>按照ID查询SPU信息</li><li>判断修改审核、上架下架状态</li><li>保存Spu</li></ul><h3 id="3-1-代码实现"><a href="#3-1-代码实现" class="headerlink" title="3.1 代码实现"></a>3.1 代码实现</h3><h4 id="3-1-1-商品审核"><a href="#3-1-1-商品审核" class="headerlink" title="3.1.1 商品审核"></a>3.1.1 商品审核</h4><p>需要校验是否是被删除的商品，如果未删除则修改审核状态为1，并自动上架</p><ol><li><p>SpuService新增方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 审核</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">audit</span><span class="hljs-params">(String id)</span></span>;<br></code></pre></td></tr></table></figure></li><li><p>SpuServiceImpl实现方法</p><p>注意： </p><ul><li>开启<code>@Transactional</code>事务注解(对于要修改数据库的操作，都加上事务注解)</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">audit</span><span class="hljs-params">(String id)</span> </span>&#123;<br>    <span class="hljs-comment">//查询spu对象</span><br>    Spu spu = spuMapper.selectByPrimaryKey(id);<br>    <span class="hljs-keyword">if</span>(spu == <span class="hljs-keyword">null</span>)&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;当前商品不存在&quot;</span>);<br>    &#125;<br>   <br>    <span class="hljs-comment">//判断当前spu是否处于删除状态</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;1&quot;</span>.equals(spu.getIsDelete()))&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;当前商品处于删除状态&quot;</span>);<br>    &#125;<br>   <br>    <span class="hljs-comment">//不处于删除状态,修改审核状态为1,上下架状态为1</span><br>    spu.setStatus(<span class="hljs-string">&quot;1&quot;</span>);<br>    spu.setIsMarketable(<span class="hljs-string">&quot;1&quot;</span>);<br>   <br>    <span class="hljs-comment">//执行修改操作</span><br>    spuMapper.updateByPrimaryKeySelective(spu);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>SpuController新增方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PutMapping(&quot;/audit/&#123;id&#125;&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">audit</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span></span>&#123;<br>    spuService.audit(id);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>, StatusCode.OK, <span class="hljs-string">&quot;商品审核成功&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="3-1-2-下架商品"><a href="#3-1-2-下架商品" class="headerlink" title="3.1.2 下架商品"></a>3.1.2 下架商品</h4><p>校验是否是被删除的商品，如果未删除则修改上架状态为0</p><ol><li><p>SpuService新增方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 下架商品</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">pull</span><span class="hljs-params">(String id)</span></span>;<br></code></pre></td></tr></table></figure></li><li><p>SpuServiceImpl实现方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">pull</span><span class="hljs-params">(String id)</span> </span>&#123;<br>    <span class="hljs-comment">//查询spu</span><br>    Spu spu = spuMapper.selectByPrimaryKey(id);<br>    <span class="hljs-keyword">if</span> (spu == <span class="hljs-keyword">null</span>)&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;当前商品不存在&quot;</span>);<br>    &#125;<br>   <br>    <span class="hljs-comment">//判断当前商品是否处于删除状态</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;1&quot;</span>.equals(spu.getIsDelete()))&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;当前商品处于删除状态&quot;</span>);<br>    &#125;<br>   <br>    <span class="hljs-comment">//商品处于未删除状态的话,则修改上下架状态为已下架(0)</span><br>    spu.setIsMarketable(<span class="hljs-string">&quot;0&quot;</span>);<br>    spuMapper.updateByPrimaryKeySelective(spu);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>SpuController新增方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PutMapping(&quot;/pull/&#123;id&#125;&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">pull</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span></span>&#123;<br>    spuService.pull(id);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>, StatusCode.OK, <span class="hljs-string">&quot;商品下架成功&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="3-1-3-上架商品"><a href="#3-1-3-上架商品" class="headerlink" title="3.1.3 上架商品"></a>3.1.3 上架商品</h4><p>必须是通过审核的商品才能上架</p><ol><li><p>SpuService新增方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 上架商品</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">put</span><span class="hljs-params">(String id)</span></span>;<br></code></pre></td></tr></table></figure></li><li><p>SpuServiceImpl 实现此方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 上架商品</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">put</span><span class="hljs-params">(String id)</span> </span>&#123;<br>    Spu spu = spuMapper.selectByPrimaryKey(id);<br>    <span class="hljs-keyword">if</span>(!spu.getStatus().equals(<span class="hljs-string">&quot;1&quot;</span>))&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;未通过审核的商品不能上架！&quot;</span>);<br>    &#125;<br>    spu.setIsMarketable(<span class="hljs-string">&quot;1&quot;</span>);<span class="hljs-comment">//上架状态</span><br>    spuMapper.updateByPrimaryKeySelective(spu);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>SpuController新增方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 上架</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@PutMapping(&quot;/put/&#123;id&#125;&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">put</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span></span>&#123;<br>    spuService.put(id);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result();<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h2 id="4-删除与还原商品"><a href="#4-删除与还原商品" class="headerlink" title="4. 删除与还原商品"></a>4. 删除与还原商品</h2><p>需求分析：</p><ul><li>商品列表中的删除商品功能，并非真正的删除(物理删除)，而是采用逻辑删除将删除标记的字段设置为1.</li><li>在回收站中有还原商品的功能，将删除标记的字段设置为0</li><li>在回收站中有删除商品的功能，是真正的物理删除,将数据从数据库中删除掉。</li></ul><p>实现思路：</p><ul><li>商品列表中的删除商品,执行逻辑删除，修改spu表is_delete字段为1</li><li>商品回收站中的还原商品,修改spu表is_delete字段为0</li><li>商品回收站中的删除商品,执行delete操作,进行物理删除</li></ul><h3 id="4-1-代码实现"><a href="#4-1-代码实现" class="headerlink" title="4.1 代码实现"></a>4.1 代码实现</h3><h4 id="4-1-1-逻辑删除商品"><a href="#4-1-1-逻辑删除商品" class="headerlink" title="4.1.1 逻辑删除商品"></a>4.1.1 逻辑删除商品</h4><ol><li><p>修改SpuServiceImpl的delete方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 删除</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">delete</span><span class="hljs-params">(String id)</span></span>&#123;<br>    Spu spu = spuMapper.selectByPrimaryKey(id);<br>    <span class="hljs-comment">//检查是否下架的商品</span><br>    <span class="hljs-keyword">if</span>(!spu.getIsMarketable().equals(<span class="hljs-string">&quot;0&quot;</span>))&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;必须先下架再删除！&quot;</span>);<br>    &#125;<br>    spu.setIsDelete(<span class="hljs-string">&quot;1&quot;</span>);<span class="hljs-comment">//删除</span><br>    spu.setStatus(<span class="hljs-string">&quot;0&quot;</span>);<span class="hljs-comment">//未审核</span><br>    spuMapper.updateByPrimaryKeySelective(spu);<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="4-1-2-还原被删除的商品"><a href="#4-1-2-还原被删除的商品" class="headerlink" title="4.1.2 还原被删除的商品"></a>4.1.2 还原被删除的商品</h4><ol><li><p>SpuService新增方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 恢复数据</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">restore</span><span class="hljs-params">(String id)</span></span>;<br></code></pre></td></tr></table></figure></li><li><p>SpuServiceImpl实现此方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 恢复数据</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">restore</span><span class="hljs-params">(String id)</span> </span>&#123;<br>    Spu spu = spuMapper.selectByPrimaryKey(id);<br>    <span class="hljs-comment">//检查是否删除的商品</span><br>    <span class="hljs-keyword">if</span>(!spu.getIsDelete().equals(<span class="hljs-string">&quot;1&quot;</span>))&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;此商品未删除！&quot;</span>);<br>    &#125;<br>    spu.setIsDelete(<span class="hljs-string">&quot;0&quot;</span>);<span class="hljs-comment">//未删除</span><br>    spu.setStatus(<span class="hljs-string">&quot;0&quot;</span>);<span class="hljs-comment">//未审核</span><br>    spuMapper.updateByPrimaryKeySelective(spu);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>SpuController新增方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 恢复数据</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@PutMapping(&quot;/restore/&#123;id&#125;&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">restore</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span></span>&#123;<br>    spuService.restore(id);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>, StatusCode.OK, <span class="hljs-string">&quot;还原成功&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="4-1-3-物理删除商品"><a href="#4-1-3-物理删除商品" class="headerlink" title="4.1.3 物理删除商品"></a>4.1.3 物理删除商品</h4><p>判断必须逻辑删除商品才能物理删除</p><ol><li><p>SpuService 新增方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 物理删除</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">realDelete</span><span class="hljs-params">(String id)</span></span>;<br></code></pre></td></tr></table></figure></li><li><p>SpuServiceImpl 实现方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">realDelete</span><span class="hljs-params">(String id)</span> </span>&#123;<br>    Spu spu = spuMapper.selectByPrimaryKey(id);<br>    <span class="hljs-comment">//检查是否删除的商品</span><br>    <span class="hljs-keyword">if</span>(!spu.getIsDelete().equals(<span class="hljs-string">&quot;1&quot;</span>))&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;此商品未删除！&quot;</span>);<br>    &#125;<br>    spuMapper.deleteByPrimaryKey(id);<br>    <br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>SpuController新增方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 物理删除</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">    * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-meta">@DeleteMapping(&quot;/realDelete/&#123;id&#125;&quot;)</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">realDelete</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span></span>&#123;<br>       spuService.realDelete(id);<br>       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>, StatusCode.OK, <span class="hljs-string">&quot;物理删除成功&quot;</span>);<br>   &#125;<br></code></pre></td></tr></table></figure></li></ol><h1 id="Part-05-网站首页高可用nginx-lua"><a href="#Part-05-网站首页高可用nginx-lua" class="headerlink" title="Part-05 网站首页高可用nginx+lua"></a>Part-05 网站首页高可用nginx+lua</h1><h2 id="1-Lua"><a href="#1-Lua" class="headerlink" title="1. Lua"></a>1. Lua</h2><h3 id="1-1-Lua介绍"><a href="#1-1-Lua介绍" class="headerlink" title="1.1 Lua介绍"></a>1.1 Lua介绍</h3><p>Lua 是一种轻量小巧的脚本语言，用标准C语言编写并以源代码形式开放， 其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。（如果想要了解他的详细背景去搜对应资料）</p><p><strong>lua 语言具有以下特性</strong>：（还不是很能理解，慢慢理解）</p><ul><li>支持面向过程(procedure-oriented)编程和函数式编程(functional programming)；</li><li>自动内存管理；只提供了一种通用类型的表（table），用它可以实现数组，哈希表，集合，对象；</li><li>语言内置模式匹配；闭包(closure)；函数也可以看做一个值；提供多线程（协同进程，并非操作系统所支持的线程）支持；</li><li>通过闭包和table可以很方便地支持面向对象编程所需要的一些关键机制，比如数据抽象，虚函数，继承和重载等。</li></ul><p><strong>应用场景</strong></p><ul><li>游戏开发</li><li>独立应用脚本</li><li>Web 应用脚本</li><li>扩展和数据库插件如：MySQL Proxy 和 MySQL WorkBench</li><li>安全系统，如入侵检测系统</li><li>redis中嵌套调用实现类似事务的功能</li><li>web容器中应用处理一些过滤 缓存等等的逻辑，例如nginx。</li></ul><h3 id="1-2-lua的安装"><a href="#1-2-lua的安装" class="headerlink" title="1.2 lua的安装"></a>1.2 lua的安装</h3><p>这里省略，有需要去搜具体博客或者本地笔记查看</p><h3 id="1-3-快速入门"><a href="#1-3-快速入门" class="headerlink" title="1.3 快速入门"></a>1.3 快速入门</h3><p>开启和关闭(ctrl + c)lua命令行交互</p><p><img src="/images/image-20210729135124466.png" alt="image-20210729135124466"></p><p>创建hello.lua文件，执行语句：</p><p><img src="/images/image-20210729134904915.png" alt="image-20210729134904915"></p><h3 id="1-4-LUA的基本语法"><a href="#1-4-LUA的基本语法" class="headerlink" title="1.4 LUA的基本语法"></a>1.4 LUA的基本语法</h3><ul><li>lua有交互式编程和脚本式编程。一般采用脚本式编程。</li></ul><h4 id="1-4-1-注释"><a href="#1-4-1-注释" class="headerlink" title="1.4.1 注释"></a>1.4.1 注释</h4><p>单行注释：两个减号是单行注释:</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">--</span><br></code></pre></td></tr></table></figure><p>多行注释：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">--[[</span><br><span class="hljs-comment"> 多行注释</span><br><span class="hljs-comment"> 多行注释</span><br><span class="hljs-comment"> --]]</span><br></code></pre></td></tr></table></figure><h4 id="1-4-2-关键字"><a href="#1-4-2-关键字" class="headerlink" title="1.4.2 关键字"></a>1.4.2 关键字</h4><p>lua的关键字如下：</p><table><thead><tr><th></th><th></th><th></th><th></th></tr></thead><tbody><tr><td>and</td><td>break</td><td>do</td><td>else</td></tr><tr><td>elseif</td><td>end</td><td>false</td><td>for</td></tr><tr><td>function</td><td>if</td><td>in</td><td>local</td></tr><tr><td>nil</td><td>not</td><td>or</td><td>repeat</td></tr><tr><td>return</td><td>then</td><td>true</td><td>until</td></tr><tr><td>while</td><td></td><td></td><td></td></tr></tbody></table><h4 id="1-4-3-定义变量"><a href="#1-4-3-定义变量" class="headerlink" title="1.4.3 定义变量"></a>1.4.3 定义变量</h4><p>全局变量，默认的情况下，定义一个变量都是全局变量，</p><p>如果要用局部变量 需要声明为local.例如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 全局变量赋值</span><br>a=<span class="hljs-number">1</span><br><span class="hljs-comment">-- 局部变量赋值</span><br><span class="hljs-keyword">local</span> b=<span class="hljs-number">2</span> <br></code></pre></td></tr></table></figure><p>如果变量没有初始化：则 它的值为nil</p><h4 id="1-4-4-Lua中的数据类型"><a href="#1-4-4-Lua中的数据类型" class="headerlink" title="1.4.4 Lua中的数据类型"></a>1.4.4 Lua中的数据类型</h4><p>Lua 是动态类型语言，变量不要类型定义,只需要为变量赋值。 值可以存储在变量中，作为参数传递或结果返回。</p><p>Lua 中有 8 个基本类型分别为：nil、boolean、number、string、userdata、function、thread 和 table。</p><table><thead><tr><th>数据类型</th><th>描述</th></tr></thead><tbody><tr><td>nil</td><td>这个最简单，只有值nil属于该类，表示一个无效值（在条件表达式中相当于false）。</td></tr><tr><td>boolean</td><td>包含两个值：false和true。</td></tr><tr><td>number</td><td>表示双精度类型的实浮点数</td></tr><tr><td>string</td><td>字符串由一对双引号或单引号来表示</td></tr><tr><td>function</td><td>由 C 或 Lua 编写的函数</td></tr><tr><td>userdata</td><td>表示任意存储在变量中的C数据结构</td></tr><tr><td>thread</td><td>表示执行的独立线路，用于执行协同程序</td></tr><tr><td>table</td><td>Lua 中的表（table）其实是一个”关联数组”（associative arrays），数组的索引可以是数字、字符串或表类型。在 Lua 里，table 的创建是通过”构造表达式”来完成，最简单构造表达式是{}，用来创建一个空表。</td></tr></tbody></table><h4 id="1-4-5-流程控制"><a href="#1-4-5-流程控制" class="headerlink" title="1.4.5 流程控制"></a>1.4.5 流程控制</h4><p>如下：类似于if else </p><p>注意：</p><ul><li>以<code>end</code>结束</li></ul><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">--[ 0 为 true ]</span><br><span class="hljs-keyword">if</span>(<span class="hljs-number">0</span>) <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;0 为 true&quot;</span>)<br><span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;0 不为true&quot;</span>)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure><h4 id="1-4-6-函数"><a href="#1-4-6-函数" class="headerlink" title="1.4.6 函数"></a>1.4.6 函数</h4><p>lua中也可以定义函数。例如：</p><p>注意：</p><ul><li>函数也是以<code>end</code>结束</li><li>稍微注意下他的字符串拼接方式</li></ul><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">--[[ 函数返回两个值的最大值 --]]</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">max</span><span class="hljs-params">(num1, num2)</span></span><br><br>   <span class="hljs-keyword">if</span> (num1 &gt; num2) <span class="hljs-keyword">then</span><br>      result = num1;<br>   <span class="hljs-keyword">else</span><br>      result = num2;<br>   <span class="hljs-keyword">end</span><br><br>   <span class="hljs-keyword">return</span> result; <br><span class="hljs-keyword">end</span><br><span class="hljs-comment">-- 调用函数</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;两值比较最大值为 &quot;</span>,<span class="hljs-built_in">max</span>(<span class="hljs-number">10</span>,<span class="hljs-number">4</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;两值比较最大值为 &quot;</span>,<span class="hljs-built_in">max</span>(<span class="hljs-number">5</span>,<span class="hljs-number">6</span>))<br></code></pre></td></tr></table></figure><p>执行之后的结果：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs lua">两值比较最大值为     <span class="hljs-number">10</span><br>两值比较最大值为     <span class="hljs-number">6</span><br></code></pre></td></tr></table></figure><h4 id="1-4-7-require-函数"><a href="#1-4-7-require-函数" class="headerlink" title="1.4.7 require 函数"></a>1.4.7 require 函数</h4><p>require 用于 引入其他的模块，类似于java中的类要引用别的类的效果。</p><p>用法：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-built_in">require</span> <span class="hljs-string">&quot;&lt;模块名&gt;&quot;</span><br></code></pre></td></tr></table></figure><h2 id="2-nginx-lua-redis实现广告缓存"><a href="#2-nginx-lua-redis实现广告缓存" class="headerlink" title="2. nginx+lua+redis实现广告缓存"></a>2. nginx+lua+redis实现广告缓存</h2><p>需求分析：</p><ul><li>需要在首页页面不同位置处显示相应的广告</li></ul><h3 id="2-1-nginx"><a href="#2-1-nginx" class="headerlink" title="2.1 nginx"></a>2.1 nginx</h3><p>负载均衡功能</p><img src="/images/image-20210729153602339.png" alt="image-20210729153602339" style="zoom: 80%;" /><p>反向代理功能</p><img src="/images/image-20210729153737126.png" alt="image-20210729153737126" style="zoom:80%;" /><p>http服务器功能</p><img src="/images/image-20210729153818568.png" alt="image-20210729153818568" style="zoom:80%;" /><h3 id="2-2-OpenResty"><a href="#2-2-OpenResty" class="headerlink" title="2.2 OpenResty"></a>2.2 OpenResty</h3><h4 id="2-2-1-OpenResty介绍"><a href="#2-2-1-OpenResty介绍" class="headerlink" title="2.2.1 OpenResty介绍"></a>2.2.1 OpenResty介绍</h4><p>OpenResty(又称：ngx_openresty) 是一个基于 NGINX 的可伸缩的 Web 平台，由中国人章亦春发起，提供了很多高质量的第三方模块。</p><p>OpenResty 是一个强大的 Web 应用服务器，Web 开发人员可以使用 Lua 脚本语言调动 Nginx 支持的各种 C 以及 Lua 模块,更主要的是在性能方面，OpenResty可以 快速构造出足以胜任 10K 乃至1000K以上并发连接响应的超高性能 Web 应用系统。</p><p>360，UPYUN，阿里云，新浪，腾讯网，去哪儿网，酷狗音乐等都是 OpenResty 的深度用户。</p><p>OpenResty 简单理解，就相当于封装了nginx,并且集成了LUA脚本，开发人员只需要简单的为其提供模块就可以实现相关的逻辑，而不再像之前，还需要在nginx中自己编写lua的脚本，再进行调用了。</p><h3 id="2-2-2-OpenResty安装"><a href="#2-2-2-OpenResty安装" class="headerlink" title="2.2.2 OpenResty安装"></a>2.2.2 OpenResty安装</h3><p>具体见本地讲义</p><h4 id="2-2-3-安装nginx"><a href="#2-2-3-安装nginx" class="headerlink" title="2.2.3 安装nginx"></a>2.2.3 安装nginx</h4><p>默认已经安装好了nginx,在目录：/usr/local/openresty/nginx 下。</p><p>修改/usr/local/openresty/nginx/conf/nginx.conf ,将配置文件使用的根设置为root,目的就是将来要使用lua脚本的时候 ，直接可以加载在root下的lua脚本。</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs crmsh"><span class="hljs-comment">#user nobody; 配置文件第一行原来为这样, 现改为下面的配置</span><br><span class="hljs-keyword">user</span> <span class="hljs-title">root</span> root;<br></code></pre></td></tr></table></figure><p>测试访问 <a href="http://192.168.200.128/">http://192.168.200.128</a></p><img src="/images/image-20210729154301413.png" alt="image-20210729154301413" style="zoom: 67%;" /><h3 id="2-3-实现思路"><a href="#2-3-实现思路" class="headerlink" title="2.3 实现思路"></a>2.3 实现思路</h3><h4 id="2-3-1-表结构分析"><a href="#2-3-1-表结构分析" class="headerlink" title="2.3.1 表结构分析"></a>2.3.1 表结构分析</h4><p>tb_ad （广告表）</p><table><thead><tr><th>字段名称</th><th>字段含义</th><th>字段类型</th><th>字段长度</th><th>备注</th></tr></thead><tbody><tr><td>id</td><td>ID</td><td>INT</td><td></td><td></td></tr><tr><td>name</td><td>广告名称</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>position</td><td>广告位置</td><td>VARCHAR</td><td></td><td>系统定义</td></tr><tr><td>start_time</td><td>开始时间</td><td>DATETIME</td><td></td><td></td></tr><tr><td>end_time</td><td>到期时间</td><td>DATETIME</td><td></td><td></td></tr><tr><td>status</td><td>状态</td><td>CHAR</td><td></td><td>0：无效 1:有效</td></tr><tr><td>image</td><td>图片地址</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>url</td><td>URL</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>remarks</td><td>备注</td><td>VARCHAR</td><td></td><td></td></tr><tr><td>web_index_lb</td><td>首页轮播图</td><td></td><td></td><td></td></tr><tr><td>web_index_amusing</td><td>有趣区</td><td></td><td></td><td></td></tr><tr><td>web_index_ea_lb</td><td>家用电器楼层轮播图</td><td></td><td></td><td></td></tr><tr><td>web_index_ea</td><td>家用电器楼层广告</td><td></td><td></td><td></td></tr><tr><td>web_index_mobile_lb</td><td>手机通讯楼层轮播图</td><td></td><td></td><td></td></tr><tr><td>web_index_mobile</td><td>手机通讯楼层广告</td><td></td><td></td><td></td></tr></tbody></table><h4 id="2-3-2-缓存预热与二级缓存查询"><a href="#2-3-2-缓存预热与二级缓存查询" class="headerlink" title="2.3.2 缓存预热与二级缓存查询"></a>2.3.2 缓存预热与二级缓存查询</h4><ol><li><p>编写lua脚本实现缓存预热（将mysql里的数据查询出来存入redis）</p><img src="/images/image-20210729154726183.png" alt="image-20210729154726183" style="zoom:80%;" /></li><li><p>编写lua脚本实现二级缓存读取</p><img src="/images/image-20210729154821590.png" alt="image-20210729154821590" style="zoom:80%;" /><p>就是说客户端查询的时候先查询本地缓存</p></li></ol><h3 id="2-4-代码实现"><a href="#2-4-代码实现" class="headerlink" title="2.4 代码实现"></a>2.4 代码实现</h3><h4 id="2-4-1-缓存预热"><a href="#2-4-1-缓存预热" class="headerlink" title="2.4.1 缓存预热"></a>2.4.1 缓存预热</h4><p>实现思路：</p><p>定义请求：用于查询数据库中的数据更新到redis中。</p><ol><li>连接mysql ，按照广告分类ID读取广告列表，转换为json字符串</li><li>连接redis，将广告列表json字符串存入redis</li></ol><p>定义请求：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">请求：<br>    /ad_update<br>参数：<br>    position  <span class="hljs-comment">--指定广告位置</span><br>返回值：<br>    <span class="hljs-type">json</span><br></code></pre></td></tr></table></figure><p>在/root/lua目录下创建ad_load.lua ，实现连接mysql 查询数据 并存储到redis中。</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs lua">ngx.header.content_type=<span class="hljs-string">&quot;application/json;charset=utf8&quot;</span> <span class="hljs-comment">-- 表明内容以json数据进行传递</span><br><span class="hljs-keyword">local</span> cjson = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;cjson&quot;</span>) <span class="hljs-comment">-- 引入第三方模块，表明支持json</span><br><span class="hljs-keyword">local</span> mysql = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;resty.mysql&quot;</span>) <span class="hljs-comment">-- 引入mysql支持</span><br><span class="hljs-keyword">local</span> uri_args = ngx.req.get_uri_args() <span class="hljs-comment">-- 获取当前请求路径上的参数赋值给uri_args</span><br><span class="hljs-keyword">local</span> position = uri_args[<span class="hljs-string">&quot;position&quot;</span>]  <span class="hljs-comment">-- 获取请求参数中的position的值</span><br><br><span class="hljs-keyword">local</span> db = mysql:new() <span class="hljs-comment">-- 设置一个新的mysql连接</span><br>db:set_timeout(<span class="hljs-number">1000</span>)  <span class="hljs-comment">-- 设置数据库连接的超时时间</span><br><span class="hljs-keyword">local</span> props = &#123;    <span class="hljs-comment">-- 设置要连接的数据库服务器的参数信息</span><br>    host = <span class="hljs-string">&quot;192.168.200.128&quot;</span>,  <br>    port = <span class="hljs-number">3306</span>,  <br>    database = <span class="hljs-string">&quot;changgou_business&quot;</span>,  <br>    user = <span class="hljs-string">&quot;root&quot;</span>,  <br>    password = <span class="hljs-string">&quot;root&quot;</span>  <br>&#125;<br><br><span class="hljs-keyword">local</span> res = db:connect(props)  <span class="hljs-comment">-- 基于上面的参数进行真正的连接</span><br><span class="hljs-keyword">local</span> select_sql = <span class="hljs-string">&quot;select url,image from tb_ad where status =&#x27;1&#x27; and position=&#x27;&quot;</span>..position..<span class="hljs-string">&quot;&#x27; and start_time&lt;= NOW() AND end_time&gt;= NOW()&quot;</span>  <span class="hljs-comment">-- 定义sql语句</span><br>res = db:query(select_sql)  <span class="hljs-comment">-- 执行连接到mysql以后要执行的sql语句</span><br>db:<span class="hljs-built_in">close</span>()  <span class="hljs-comment">-- 关闭数据库的连接</span><br><br><span class="hljs-keyword">local</span> redis = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;resty.redis&quot;</span>) <span class="hljs-comment">-- 引入redis第三方面模块</span><br><span class="hljs-keyword">local</span> red = redis:new() <span class="hljs-comment">-- 设置redis的连接</span><br>red:set_timeout(<span class="hljs-number">2000</span>)  <span class="hljs-comment">-- 设置redis的连接超时时间</span><br><br><span class="hljs-keyword">local</span> ip =<span class="hljs-string">&quot;192.168.200.128&quot;</span>  <span class="hljs-comment">-- 设置redis服务器的ip地址</span><br><span class="hljs-keyword">local</span> port = <span class="hljs-number">6379</span>  <span class="hljs-comment">-- 设置redis服务器的端口号</span><br>red:connect(ip,port) <span class="hljs-comment">-- 开启真正的redis连接</span><br><br>red:set(<span class="hljs-string">&quot;ad_&quot;</span>..position,cjson.encode(res))  <span class="hljs-comment">-- 设置向redis中存放的内容</span><br>red:<span class="hljs-built_in">close</span>() <span class="hljs-comment">-- 关闭连接</span><br><br>ngx.say(<span class="hljs-string">&quot;&#123;flag:true&#125;&quot;</span>)  <span class="hljs-comment">-- 响应给客户端的字符串信息</span><br></code></pre></td></tr></table></figure><p>修改/usr/local/openresty/nginx/conf/nginx.conf文件，代码如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#user  nobody;</span><br><span class="hljs-attribute">user</span> root root;<br><span class="hljs-attribute">worker_processes</span>  <span class="hljs-number">1</span>;<br><br><span class="hljs-comment">#error_log  logs/error.log;</span><br><span class="hljs-comment">#error_log  logs/error.log  notice;</span><br><span class="hljs-comment">#error_log  logs/error.log  info;</span><br><br><span class="hljs-comment">#pid        logs/nginx.pid;</span><br><br><span class="hljs-section">events</span> &#123;<br>    <span class="hljs-attribute">worker_connections</span>  <span class="hljs-number">1024</span>;<br>&#125;<br><br><span class="hljs-section">http</span> &#123;<br>    <span class="hljs-attribute">include</span>       mime.types;<br>    <span class="hljs-attribute">default_type</span>  application/octet-stream;<br>    <span class="hljs-attribute">sendfile</span>        <span class="hljs-literal">on</span>;<br>    <span class="hljs-comment">#tcp_nopush     on;</span><br><br>    <span class="hljs-comment">#keepalive_timeout  0;</span><br>    <span class="hljs-attribute">keepalive_timeout</span>  <span class="hljs-number">65</span>;<br><br>    <span class="hljs-comment">#gzip  on;</span><br><br>    <span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span>  localhost;<br>        <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>        <span class="hljs-comment">#access_log  logs/host.access.log  main;</span><br>        <span class="hljs-comment"># 添加</span><br>        <span class="hljs-attribute">location</span> /ad_update &#123; <span class="hljs-comment"># 这个路径映射到下面这个本地ad_update.lua文件</span><br>            <span class="hljs-attribute">content_by_lua_file</span> /root/lua/ad_update.lua;<br>        &#125;<br>        <br>        <span class="hljs-comment"># redirect server error pages to the static page /50x.html</span><br>        <span class="hljs-comment">#</span><br>        <span class="hljs-attribute">error_page</span>   <span class="hljs-number">500</span> <span class="hljs-number">502</span> <span class="hljs-number">503</span> <span class="hljs-number">504</span>  /50x.html;<br>        <span class="hljs-attribute">location</span> = /50x.html &#123;<br>            <span class="hljs-attribute">root</span>   html;<br>        &#125;        <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>重新启动nginx   (<code>./nginx -s reload</code>)</p><p>测试：<a href="http://192.168.200.128/ad_update?position=web_index_lb">http://192.168.200.128/ad_update?position=web_index_lb</a>   （我这一步没报错，但是数据没输进去，这个bug先放这儿，后面熟悉了再慢慢解决）</p><h4 id="广告缓存读取"><a href="#广告缓存读取" class="headerlink" title="广告缓存读取"></a>广告缓存读取</h4><p>实现思路：</p><ul><li>通过lua脚本直接从redis中获取数据即可。</li></ul><p>定义请求：</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs elixir">请求<span class="hljs-symbol">:/ad_read</span><br>参数：position<br>返回值：json<br></code></pre></td></tr></table></figure><p>在/root/lua目录下创建ad_read.lua</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs lua"><br>ngx.header.content_type=<span class="hljs-string">&quot;application/json;charset=utf8&quot;</span><br><br><span class="hljs-keyword">local</span> uri_args = ngx.req.get_uri_args();<br><span class="hljs-keyword">local</span> position = uri_args[<span class="hljs-string">&quot;position&quot;</span>];<br><br><span class="hljs-keyword">local</span> redis = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;resty.redis&quot;</span>);<br><br><span class="hljs-keyword">local</span> red = redis:new()<br><br>red:set_timeout(<span class="hljs-number">2000</span>)<br><br><span class="hljs-keyword">local</span> ok, err = red:connect(<span class="hljs-string">&quot;192.168.200.128&quot;</span>, <span class="hljs-number">6379</span>)<br><br><span class="hljs-keyword">local</span> rescontent=red:get(<span class="hljs-string">&quot;ad_&quot;</span>..position)<br><br>ngx.say(rescontent)<br><br>red:<span class="hljs-built_in">close</span>()<br></code></pre></td></tr></table></figure><p>在/usr/local/openresty/nginx/conf/nginx.conf中server下添加配置</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> /ad_read &#123;<br>  <span class="hljs-attribute">content_by_lua_file</span> /root/lua/ad_read.lua;<br>&#125;<br></code></pre></td></tr></table></figure><p>测试 <a href="http://192.168.200.128/ad_read?position=web_index_lb">http://192.168.200.128/ad_read?position=web_index_lb</a> 输出</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">[&#123;<span class="hljs-attr">&quot;url&quot;</span>:<span class="hljs-string">&quot;img\/banner1.jpg&quot;</span>,<span class="hljs-attr">&quot;image&quot;</span>:<span class="hljs-string">&quot;img\/banner1.jpg&quot;</span>&#125;,&#123;<span class="hljs-attr">&quot;url&quot;</span>:<span class="hljs-string">&quot;img\/banner2.jpg&quot;</span>,<span class="hljs-attr">&quot;image&quot;</span>:<span class="hljs-string">&quot;img\/banner2.jpg&quot;</span>&#125;]<br></code></pre></td></tr></table></figure><h4 id="2-4-3-二级缓存-加入openresty本地缓存"><a href="#2-4-3-二级缓存-加入openresty本地缓存" class="headerlink" title="2.4.3 二级缓存-加入openresty本地缓存"></a>2.4.3 二级缓存-加入openresty本地缓存</h4><p>如上的方式没有问题，但是如果请求都到redis，redis压力也很大，所以我们一般采用多级缓存的方式来减少下游系统的服务压力</p><p>先查询openresty本地缓存 如果没有再查询redis中的数据<br>修改/root/lua目录下ad_read文件, 内容如下:</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">--设置响应头类型</span><br>ngx.header.content_type=<span class="hljs-string">&quot;application/json;charset=utf8&quot;</span><br><span class="hljs-comment">--获取请求中的参数ID</span><br><span class="hljs-keyword">local</span> uri_args = ngx.req.get_uri_args();<br><span class="hljs-keyword">local</span> position = uri_args[<span class="hljs-string">&quot;position&quot;</span>];<br><br><span class="hljs-comment">--获取本地缓存</span><br><span class="hljs-keyword">local</span> cache_ngx = ngx.shared.dis_cache;<br><span class="hljs-comment">--根据ID 获取本地缓存数据</span><br><span class="hljs-keyword">local</span> adCache = cache_ngx:get(<span class="hljs-string">&#x27;ad_cache_&#x27;</span>..position);<br><br><span class="hljs-keyword">if</span> adCache == <span class="hljs-string">&quot;&quot;</span> <span class="hljs-keyword">or</span> adCache == <span class="hljs-literal">nil</span> <span class="hljs-keyword">then</span><br><br><span class="hljs-comment">--引入redis库</span><br><span class="hljs-keyword">local</span> redis = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;resty.redis&quot;</span>);<br><span class="hljs-comment">--创建redis对象</span><br><span class="hljs-keyword">local</span> red = redis:new()<br><span class="hljs-comment">--设置超时时间</span><br>red:set_timeout(<span class="hljs-number">2000</span>)<br><span class="hljs-comment">--连接</span><br><span class="hljs-keyword">local</span> ok, err = red:connect(<span class="hljs-string">&quot;192.168.200.128&quot;</span>, <span class="hljs-number">6379</span>)<br><span class="hljs-comment">--获取key的值</span><br><span class="hljs-keyword">local</span> rescontent=red:get(<span class="hljs-string">&quot;ad_&quot;</span>..position)<br><span class="hljs-comment">--输出到返回响应中</span><br>ngx.say(rescontent)<br><span class="hljs-comment">--关闭连接</span><br>red:<span class="hljs-built_in">close</span>()<br><span class="hljs-comment">--将redis中获取到的数据存入nginx本地缓存</span><br>cache_ngx:set(<span class="hljs-string">&#x27;ad_cache_&#x27;</span>..position, rescontent, <span class="hljs-number">10</span>*<span class="hljs-number">60</span>);<br><br><span class="hljs-keyword">else</span><br> <span class="hljs-comment">--nginx本地缓存中获取到数据直接输出</span><br> ngx.say(adCache)<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure><p>修改nginx配置文件vi /usr/local/openresty/nginx/conf/nginx.conf ，http节点下添加配置:</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#包含redis初始化模块</span><br><span class="hljs-attribute">lua_shared_dict</span> dis_cache <span class="hljs-number">5m</span>;  <span class="hljs-comment">#共享内存开启</span><br></code></pre></td></tr></table></figure><h4 id="2-4-4-前端页面实现（了解）"><a href="#2-4-4-前端页面实现（了解）" class="headerlink" title="2.4.4 前端页面实现（了解）"></a>2.4.4 前端页面实现（了解）</h4><p>这里先不学，有需要再说。</p><p>待更改完成后用FileZilla连接服务器（在这里就是那台linux虚拟机）</p><p><img src="/images/image-20210729213014273.png" alt="image-20210729213014273"></p><p>连接成功后，把本地的前端页面以及其样式设置的文件和文件夹全部都拷贝到服务器上nginx目录下的html文件夹中</p><p><img src="/images/image-20210729213222244.png" alt="image-20210729213222244"></p><p>最后更改nginx.conf的配置</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># 加载首页</span><br>      <span class="hljs-attribute">location</span> / &#123;<br>          <span class="hljs-attribute">root</span>   html;  <span class="hljs-comment"># 表明页面文件都部署在html文件夹下</span><br>          <span class="hljs-attribute">index</span>  index.html index.htm;  <span class="hljs-comment"># 表明location对应的主页页面</span><br>      &#125;<br></code></pre></td></tr></table></figure><p>配置完成后重启nginx即可</p><p>最后根据首页的<code>location</code>, 在浏览器输入 192.168.200.128 即可完成访问。<code>location</code>的<code>/</code>在地址栏可输也可不输入。看到主页的广告图出现，说明设置成功。</p><h2 id="3-nginx限流"><a href="#3-nginx限流" class="headerlink" title="3 nginx限流"></a>3 nginx限流</h2><p>一般情况下，首页的并发量是比较大的，即使有了多级缓存，如果有大量恶意的请求，也会对系统造成影响。而限流就是保护措施之一。</p><p>nginx提供两种限流的方式：</p><ul><li>一是控制速率</li><li>二是控制并发连接数</li></ul><h3 id="3-1-控制速率"><a href="#3-1-控制速率" class="headerlink" title="3.1 控制速率"></a>3.1 控制速率</h3><p>控制速率的方式之一就是采用漏桶算法</p><h4 id="3-1-1-漏桶算法实现控制速率限流"><a href="#3-1-1-漏桶算法实现控制速率限流" class="headerlink" title="3.1.1 漏桶算法实现控制速率限流"></a>3.1.1 漏桶算法实现控制速率限流</h4><p>漏桶(Leaky Bucket)算法思路很简单,水(请求)先进入到漏桶里,漏桶以一定的速度出水(接口有响应速率),当水流入速度过大会直接溢出(访问频率超过接口响应速率),然后就拒绝请求,可以看出漏桶算法能强行限制数据的传输速率.</p><p>漏桶算法实现 nginx的配置：</p><ul><li><p>修改/usr/local/openresty/nginx/conf/nginx.conf:</p><p>注意：</p><ul><li><p>被<code>#</code>包裹的设置这个算法的地方</p></li><li><p>binary_remote_addr 是一种key，表示基于 remote_addr(客户端IP) 来做限流，binary_ 的目的是压缩内存占用量 </p></li><li><p>zone：定义共享内存区来存储访问信息， myRateLimit:10m 表示一个大小为10M，名字为myRateLimit的内存区域。1M能存储16000 IP地址的访问信息，10M可以存储16W IP地址访问信息。</p></li><li><p>rate 用于设置最大访问速率，rate=10r/s 表示每秒最多处理10个请求。我们这里设置成2 方便测试。</p></li></ul><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#user  nobody;</span><br><span class="hljs-attribute">user</span> root root;<br><span class="hljs-attribute">worker_processes</span>  <span class="hljs-number">1</span>;<br><br><span class="hljs-comment">#error_log  logs/error.log;</span><br><span class="hljs-comment">#error_log  logs/error.log  notice;</span><br><span class="hljs-comment">#error_log  logs/error.log  info;</span><br><br><span class="hljs-comment">#pid        logs/nginx.pid;</span><br><br><br><span class="hljs-section">events</span> &#123;<br>    <span class="hljs-attribute">worker_connections</span>  <span class="hljs-number">1024</span>;<br>&#125;<br><br><br><span class="hljs-section">http</span> &#123;<br>    <span class="hljs-attribute">include</span>       mime.types;<br>    <span class="hljs-attribute">default_type</span>  application/octet-stream;<br><br>    <span class="hljs-comment">#log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br>    <span class="hljs-comment">#                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br>    <span class="hljs-comment">#                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><br>    <span class="hljs-comment">#access_log  logs/access.log  main;</span><br><br>    <span class="hljs-attribute">sendfile</span>        <span class="hljs-literal">on</span>;<br>    <span class="hljs-comment">#tcp_nopush     on;</span><br><br>    <span class="hljs-comment">#keepalive_timeout  0;</span><br>    <span class="hljs-attribute">keepalive_timeout</span>  <span class="hljs-number">65</span>;<br><br>    <span class="hljs-comment">#gzip  on;</span><br>    <span class="hljs-comment">##############################</span><br>    <span class="hljs-attribute">limit_req_zone</span> $binary_remote_addr zone=myRateLimit:<span class="hljs-number">10m</span> rate=2r/s;<br><span class="hljs-comment">###############################</span><br>    <span class="hljs-section">server</span> &#123;  <br>        <span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span>;<br>        <span class="hljs-attribute">server_name</span>  localhost;<br>        <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>        <span class="hljs-attribute">location</span> / &#123;<br>            <span class="hljs-comment">##########################</span><br>            <span class="hljs-attribute">limit_req</span> zone=myRateLimit;<br>            <span class="hljs-comment">##########################</span><br>            <span class="hljs-attribute">root</span>   html;<br>            <span class="hljs-attribute">index</span>  index.html index.htm;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>测试：重新加载配置文件</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">cd <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/openresty/</span>nginx/sbin<br><br>./nginx -s reload<br></code></pre></td></tr></table></figure><p>快速点击，会报错</p><p><img src="/images/image-20210729220115898.png" alt="image-20210729220115898"></p></li></ul><h4 id="3-1-2-处理突发流量"><a href="#3-1-2-处理突发流量" class="headerlink" title="3.1.2 处理突发流量"></a>3.1.2 处理突发流量</h4><p>上面例子限制 2r/s，如果有时正常流量突然增大，超出的请求将被拒绝，无法处理突发流量，可以结合 <strong>burst</strong> 参数使用来解决该问题。</p><p>例如，如下配置表示：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">limit_req</span> zone=myRateLimit burst=<span class="hljs-number">5</span>;<br>        <span class="hljs-attribute">root</span>   html;<br>        <span class="hljs-attribute">index</span>  index.html index.htm;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>burst 译为突发、爆发，表示在超过设定的处理速率后能额外处理的请求数,当 rate=2r/s 时，将1s拆成2份，即每500ms可处理1个请求。</p><p>此处，<strong>burst=5</strong> ，若同时有6个请求到达，Nginx 会处理第一个请求，剩余5个请求将放入队列，然后每隔500ms从队列中获取一个请求进行处理。若请求数大于6，将拒绝处理多余的请求，直接返回503.</p><p>不过，单独使用 burst 参数并不实用。假设 burst=50 ，rate为10r/s，排队中的50个请求虽然每100ms会处理一个，但第50个请求却需要等待 50 * 100ms即 5s，这么长的处理时间自然难以接受。</p><p>因此，burst 往往结合 nodelay 一起使用。</p><p>例如：如下配置：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">limit_req</span> zone=myRateLimit burst=<span class="hljs-number">5</span> nodelay;<br>        <span class="hljs-attribute">root</span>   html;<br>        <span class="hljs-attribute">index</span>  index.html index.htm;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>如上表示：</p><p>处理突发5个请求的时候，没有延迟，等到完成之后，按照正常的速率处理。</p><p>如上两种配置结合就达到了速率稳定，但突然流量也能正常处理的效果。配置代码如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#user  nobody;</span><br><span class="hljs-attribute">user</span> root root;<br><span class="hljs-attribute">worker_processes</span>  <span class="hljs-number">1</span>;<br><br><span class="hljs-comment">#error_log  logs/error.log;</span><br><span class="hljs-comment">#error_log  logs/error.log  notice;</span><br><span class="hljs-comment">#error_log  logs/error.log  info;</span><br><br><span class="hljs-comment">#pid        logs/nginx.pid;</span><br><br><br><span class="hljs-section">events</span> &#123;<br>    <span class="hljs-attribute">worker_connections</span>  <span class="hljs-number">1024</span>;<br>&#125;<br><br><br><span class="hljs-section">http</span> &#123;<br>    <span class="hljs-attribute">include</span>       mime.types;<br>    <span class="hljs-attribute">default_type</span>  application/octet-stream;<br><br>    <span class="hljs-comment">#log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br>    <span class="hljs-comment">#                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br>    <span class="hljs-comment">#                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><br>    <span class="hljs-comment">#access_log  logs/access.log  main;</span><br><br>    <span class="hljs-attribute">sendfile</span>        <span class="hljs-literal">on</span>;<br>    <span class="hljs-comment">#tcp_nopush     on;</span><br><br>    <span class="hljs-comment">#keepalive_timeout  0;</span><br>    <span class="hljs-attribute">keepalive_timeout</span>  <span class="hljs-number">65</span>;<br><br>    <span class="hljs-comment">#gzip  on;</span><br><br>    <span class="hljs-comment"># 设置限流配置</span><br>    <span class="hljs-attribute">limit_req_zone</span> $binary_remote_addr zone=myRateLimit:<span class="hljs-number">10m</span> rate=2r/s;<br><br>    <span class="hljs-section">server</span> &#123;  <br>        <span class="hljs-attribute">listen</span>       <span class="hljs-number">8081</span>;<br>        <span class="hljs-attribute">server_name</span>  localhost;<br>        <span class="hljs-attribute">charset</span> utf-<span class="hljs-number">8</span>;<br>        <span class="hljs-attribute">location</span> / &#123;<br>            <span class="hljs-attribute">limit_req</span> zone=myRateLimit burst = <span class="hljs-number">5</span> nodelay;<br>            <span class="hljs-attribute">root</span>   html;<br>            <span class="hljs-attribute">index</span>  index.html index.htm;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>配置完成以后记得重启nginx （改配置文件需要重启，其他时候不用重启）</p><p>测试：在1秒钟之内可以刷新5次，正常处理。</p><p>但超过之后会报错</p><h1 id="Part-06-数据同步解决方案-canal"><a href="#Part-06-数据同步解决方案-canal" class="headerlink" title="Part-06 数据同步解决方案-canal"></a>Part-06 数据同步解决方案-canal</h1><h2 id="1-canal"><a href="#1-canal" class="headerlink" title="1. canal"></a>1. canal</h2><h3 id="1-1-canal简介"><a href="#1-1-canal简介" class="headerlink" title="1.1 canal简介"></a>1.1 canal简介</h3><p>canal可以用来监控数据库数据的变化，从而获得新增数据，或者修改的数据。</p><p>canal是应对阿里巴巴存在杭州和美国的双机房部署，存在跨机房同步的业务需求而提出的。</p><p>阿里系公司开始逐步的尝试基于数据库的日志解析，获取增量变更进行同步，由此衍生出了增量订阅&amp;消费的业务。</p><img src="/images/image-20210730122738581.png" alt="image-20210730122738581" style="zoom:80%;" /><p>原理相对比较简单：(这里不是太理解)</p><ol><li>canal模拟mysql slave的交互协议，伪装自己为mysql slave，向mysql master发送dump协议</li><li>mysql master收到dump请求，开始推送binary log给slave(也就是canal)</li><li>canal解析binary log对象(原始为byte流)</li></ol><h3 id="1-2-环境部署"><a href="#1-2-环境部署" class="headerlink" title="1.2 环境部署"></a>1.2 环境部署</h3><h4 id="1-2-1-mysql开启binlog模式"><a href="#1-2-1-mysql开启binlog模式" class="headerlink" title="1.2.1 mysql开启binlog模式"></a>1.2.1 mysql开启binlog模式</h4><p>​    这部分看具体博客或者本地笔记</p><h4 id="1-2-2-canal服务端安装配置"><a href="#1-2-2-canal服务端安装配置" class="headerlink" title="1.2.2 canal服务端安装配置"></a>1.2.2 canal服务端安装配置</h4><p>​    这部分看具体博客或者本地笔记都可</p><h3 id="1-3-数据监控微服务"><a href="#1-3-数据监控微服务" class="headerlink" title="1.3 数据监控微服务"></a>1.3 数据监控微服务</h3><p>当用户执行数据库的操作的时候，binlog 日志会被canal捕获到，并解析出数据。我们就可以将解析出来的数据进行相应的逻辑处理。</p><p>我们这里使用的一个开源的项目，它实现了springboot与canal的集成。比原生的canal更加优雅。springboot 没有这个包，需要自己下载并部署到本地仓库</p><ol><li><p>打开网址 <a href="https://github.com/chenqian56131/spring-boot-starter-canal">https://github.com/chenqian56131/spring-boot-starter-canal</a> 下载 spring-boot-starter-canal。（下载到本地的磁盘位置可随便选）</p></li><li><p>下载完成后解压，并打开文件夹到有pom.xml文件的那一级</p><img src="/images/image-20210730125655100.png" alt="image-20210730125655100" style="zoom:80%;" /></li><li><p>在此处输入mvn命令</p><p>注意：</p><ul><li>DskipTests 表明安装的时候跳过测试</li></ul><p><img src="/images/image-20210730125838140.png" alt="image-20210730125838140"></p></li><li><p>BUILD SUCCESS以后可以在本地的maven仓库看到一个xpand包</p><p><img src="/images/image-20210730130053149.png" alt="image-20210730130053149"></p></li></ol><h4 id="1-3-1-微服务搭建"><a href="#1-3-1-微服务搭建" class="headerlink" title="1.3.1 微服务搭建"></a>1.3.1 微服务搭建</h4><ol><li><p>创建工程模块changgou_canal，pom引入依赖</p><p>注意：</p><ul><li>上面那个包就是刚刚下载到本地的包，不然这里会报红</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xpand<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>starter-canal<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.amqp<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-rabbit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>创建包com.changgou.canal ，包下创建启动类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableCanalClient</span> <span class="hljs-comment">//声明当前的服务是canal的客户端</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CanalApplication</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(CanalApplication.class,args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>添加配置文件application.properties</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-meta">canal.client.instances.example.host</span>=<span class="hljs-string">192.168.200.128</span><br><span class="hljs-meta">canal.client.instances.example.port</span>=<span class="hljs-string">11111</span><br><span class="hljs-meta">canal.client.instances.example.batchSize</span>=<span class="hljs-string">1000  # 这里不知道是什么意思</span><br><span class="hljs-meta">spring.rabbitmq.host</span>=<span class="hljs-string">192.168.200.128</span><br></code></pre></td></tr></table></figure></li><li><p>创建com.changgou.canal.listener包，包下创建类</p><p>注意：</p><ul><li><code>@CanalEventListener</code>: 声明当前的类是canal的监听类</li><li><code>@ListenPoint(schema = &quot;changgou_business&quot;, table = &quot;tb_ad&quot;)</code>表明监听的是数据库changgou_business中的tb_ad表</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@CanalEventListener</span> <span class="hljs-comment">//声明当前的类是canal的监听类</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BusinessListener</span> </span>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-meta">@ListenPoint(schema = &quot;changgou_business&quot;, table = &quot;tb_ad&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">adUpdate</span><span class="hljs-params">(CanalEntry.EventType eventType, CanalEntry.RowData rowData)</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;广告表数据发生改变&quot;</span>);<br>        <span class="hljs-comment">//获取改变之前的数据</span><br>        rowData.getBeforeColumnsList().forEach((c)-&gt; System.out.println(<span class="hljs-string">&quot;改变前的数据:&quot;</span>+c.getName()+<span class="hljs-string">&quot;::&quot;</span>+c.getValue()));<br>        System.out.println(<span class="hljs-string">&quot;===================&quot;</span>);<br>        <span class="hljs-comment">//获取改变之后的数据</span><br>        rowData.getAfterColumnsList().forEach((c) -&gt; System.out.println(<span class="hljs-string">&quot;改变之后的数据:&quot;</span>+c.getName()+<span class="hljs-string">&quot;::&quot;</span>+c.getValue())); <span class="hljs-comment">// 获取改变后的那一行的所有字段名和数据</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>测试：启动数据监控微服务，修改changgou_business的tb_ad表，观察控制台输出</p></li></ol><h2 id="2-首页广告缓存更新"><a href="#2-首页广告缓存更新" class="headerlink" title="2. 首页广告缓存更新"></a>2. 首页广告缓存更新</h2><h3 id="2-1-需求分析"><a href="#2-1-需求分析" class="headerlink" title="2.1 需求分析"></a>2.1 需求分析</h3><p>当tb_ad（广告）表的数据发生变化时，更新redis中的广告数据</p><h3 id="2-2-实现思路"><a href="#2-2-实现思路" class="headerlink" title="2.2 实现思路"></a>2.2 实现思路</h3><ol><li><p>修改数据监控微服务，监控tb_ad表，当发生增删改操作时，提取position值（广告位置key），发送到rabbitmq</p></li><li><p>从rabbitmq中提取消息，通过OkHttpClient调用ad_update来实现对广告缓存数据的更新。</p><img src="/images/image-20210730193803227.png" alt="image-20210730193803227" style="zoom:80%;" /></li></ol><p>这个图要理解</p><h3 id="2-3-代码实现"><a href="#2-3-代码实现" class="headerlink" title="2.3 代码实现"></a>2.3 代码实现</h3><h4 id="2-3-1-发送消息到mq"><a href="#2-3-1-发送消息到mq" class="headerlink" title="2.3.1 发送消息到mq"></a>2.3.1 发送消息到mq</h4><ol><li>在rabbitmq管理后台创建队列 ad_update_queue ，用于接收广告更新通知</li></ol><img src="/images/image-20210730194058801.png" alt="image-20210730194058801" style="zoom:80%;" /><ol start="2"><li><p>引入rabbitmq起步依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.amqp<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-rabbit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>配置文件application.properties 添加内容</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-meta">spring.rabbitmq.host</span>=<span class="hljs-string">192.168.200.128</span><br></code></pre></td></tr></table></figure></li><li><p>新增rabbitMQ配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RabbitMQConfig</span> </span>&#123;<br><br>    <span class="hljs-comment">//定义队列名称</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String AD_UPDATE_QUEUE=<span class="hljs-string">&quot;ad_update_queue&quot;</span>;<br>   <br><br>    <span class="hljs-comment">//声明队列</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">queue</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(AD_UPDATE_QUEUE);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>修改BusinessListener类</p><p>注意：</p><ul><li><code>@CanalEventListener</code>表明当前的类是canal的监听类</li><li><code>@ListenPoint(schema = &quot;changgou_business&quot;, table = &quot;tb_ad&quot;)</code>表明监听是哪一个数据库中的哪张表</li><li>关于<code>CanalEntry</code>具体的实现细节先不深入</li><li>RabbitMQ与springboot结合的用法还不熟</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@CanalEventListener</span> <span class="hljs-comment">//声明当前的类是canal的监听类</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BusinessListener</span> </span>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-meta">@ListenPoint(schema = &quot;changgou_business&quot;, table = &quot;tb_ad&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">adUpdate</span><span class="hljs-params">(CanalEntry.EventType eventType, CanalEntry.RowData rowData)</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;广告表数据发生改变&quot;</span>);<br><br>        <span class="hljs-keyword">for</span> (CanalEntry.Column column : rowData.getAfterColumnsList()) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;position&quot;</span>.equals(column.getName()))&#123;<br>                System.out.println(<span class="hljs-string">&quot;发送最新的数据到MQ:&quot;</span>+column.getValue());<br><br>                <span class="hljs-comment">//发送消息</span><br>                rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;&quot;</span>, RabbitMQConfig.AD_UPDATE_QUEUE, column.getValue());<br>            &#125;<br>        &#125;<br>        <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="2-3-2-从mq中提取消息执行更新"><a href="#2-3-2-从mq中提取消息执行更新" class="headerlink" title="2.3.2 从mq中提取消息执行更新"></a>2.3.2 从mq中提取消息执行更新</h4><ol><li><p>changgou_service_business工程pom.xml引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--消息队列依赖--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>okhttp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.9.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>在spring节点下添加rabbitmq配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">rabbitmq:</span><br>  <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.128</span><br></code></pre></td></tr></table></figure></li><li><p>com.changgou.business包下创建listener包，包下创建类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AdListener</span> </span>&#123;<br><br>    <span class="hljs-meta">@RabbitListener(queues = &quot;ad_update_queue&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiveMessage</span><span class="hljs-params">(String message)</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;接收到的消息为:&quot;</span>+message);<br><br>        <span class="hljs-comment">//发起远程调用</span><br>        OkHttpClient okHttpClient = <span class="hljs-keyword">new</span> OkHttpClient();<br>        String url = <span class="hljs-string">&quot;http://192.168.200.128/ad_update?position=&quot;</span>+message;<br>        Request request = <span class="hljs-keyword">new</span> Request.Builder().url(url).build();<br>        Call call = okHttpClient.newCall(request);<br>        call.enqueue(<span class="hljs-keyword">new</span> Callback() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onFailure</span><span class="hljs-params">(Call call, IOException e)</span> </span>&#123;<br>                <span class="hljs-comment">//请求失败</span><br>                e.printStackTrace();<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onResponse</span><span class="hljs-params">(Call call, Response response)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>                <span class="hljs-comment">//请求成功</span><br>                System.out.println(<span class="hljs-string">&quot;请求成功:&quot;</span>+response.message());<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>测试，启动business微服务(前面已经启动了eureka, canal的微服务。不然达不成效果)，观察控制台输出和数据同步效果</p></li></ol><h2 id="3-商品上架索引库导入数据"><a href="#3-商品上架索引库导入数据" class="headerlink" title="3. 商品上架索引库导入数据"></a>3. 商品上架索引库导入数据</h2><h3 id="3-1-需求分析"><a href="#3-1-需求分析" class="headerlink" title="3.1 需求分析"></a>3.1 需求分析</h3><p>商品上架将商品的sku列表导入或更新索引库。</p><h3 id="3-2-实现思路"><a href="#3-2-实现思路" class="headerlink" title="3.2 实现思路"></a>3.2 实现思路</h3><ol><li><p>在数据监控微服务中监控tb_spu表的数据，当tb_spu发生更改且is_marketable为1时，表示商品上架，将spu的id发送到rabbitmq。</p></li><li><p>在rabbitmq管理后台创建商品上架交换器（fanout）。使用分列模式的交换器是考虑商品上架会有很多种逻辑需要处理，导入索引库只是其中一项，另外还有商品详细页静态化等操作。这样我们可以创建导入索引库的队列和商品详细页静态化队列并与商品上架交换器进行绑定。</p></li><li><p>搜索微服务从rabbitmq的导入索引库的队列中提取spu的id，通过feign调用商品微服务得到sku的列表，并且通过调用elasticsearch的高级restAPI 将sku列表导入到索引库。</p><p><img src="/images/image-20210803144338107.png" alt="image-20210803144338107"></p></li></ol><h3 id="3-3-代码实现"><a href="#3-3-代码实现" class="headerlink" title="3.3 代码实现"></a>3.3 代码实现</h3><h4 id="3-3-1-发送消息到mq"><a href="#3-3-1-发送消息到mq" class="headerlink" title="3.3.1 发送消息到mq"></a>3.3.1 发送消息到mq</h4><ol><li><p>在rabbitmq后台创建交换器goods_up_exchange（类型为fanout），创建队列search_add_queue绑定交换器goods_up_exchange,更新rabbitmq配置类</p><p>注意：</p><ul><li><code>@Bean(SEARCH_ADD_QUEUE)</code>是用来声明这个方法返回的bean的名称，便于后面的绑定zhu入。</li><li><code>@Qualifier(SEARCH_ADD_QUEUE)</code>：qualifier注解是按照名称来注入引用类型的bean的，而autowire是按照bean的类型来注入的。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RabbitMQConfig</span> </span>&#123;<br>    <span class="hljs-comment">//交换机名称</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String GOODS_UP_EXCHANGE=<span class="hljs-string">&quot;goods_up_exchange&quot;</span>;<br><br>    <span class="hljs-comment">//定义队列名称</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SEARCH_ADD_QUEUE=<span class="hljs-string">&quot;search_add_queue&quot;</span>;<br><br>    <span class="hljs-comment">//大小写转换快捷键：CTRL+SHIFT+U</span><br>    <span class="hljs-comment">//定义队列名称</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String AD_UPDATE_QUEUE = <span class="hljs-string">&quot;ad_update_queue&quot;</span>;<br><br>    <span class="hljs-comment">//声明队列</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">queue</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(AD_UPDATE_QUEUE);<br>    &#125;<br><br>    <span class="hljs-comment">//声明队列</span><br>    <span class="hljs-meta">@Bean(SEARCH_ADD_QUEUE)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">SEARCH_ADD_QUEUE</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(SEARCH_ADD_QUEUE);<br>    &#125;<br><br>    <span class="hljs-comment">//声明交换机</span><br>    <span class="hljs-meta">@Bean(GOODS_UP_EXCHANGE)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Exchange <span class="hljs-title">GOODS_UP_EXCHANGE</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> ExchangeBuilder.fanoutExchange(GOODS_UP_EXCHANGE).durable(<span class="hljs-keyword">true</span>).build();<br>    &#125;<br><br>    <span class="hljs-comment">//队列绑定交换机</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">SEARCH_ADD_QUEUE_BINDING</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(SEARCH_ADD_QUEUE)</span> Queue queue, <span class="hljs-meta">@Qualifier(GOODS_UP_EXCHANGE)</span> Exchange exchange)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="hljs-string">&quot;&quot;</span>).noargs();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>数据监控微服务新增SpuListener，添加以下代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@CanalEventListener</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpuListener</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-meta">@ListenPoint(schema = &quot;changgou_goods&quot;, table = &quot;tb_spu&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">goodsUp</span><span class="hljs-params">(CanalEntry.EventType eventType, CanalEntry.RowData rowData)</span></span>&#123;<br>        <span class="hljs-comment">//获取改变之前的数据并将这部分数据转换为map</span><br>        Map&lt;String, String&gt; oldData = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        rowData.getBeforeColumnsList().forEach((c)-&gt;oldData.put(c.getName(), c.getValue()));<br><br>        <span class="hljs-comment">//获取改变之后的数据并这部分数据转换为map</span><br>        Map&lt;String,String&gt; newData = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        rowData.getAfterColumnsList().forEach((c)-&gt;newData.put(c.getName(),c.getValue()));<br><br>        <span class="hljs-comment">//获取最新上架的商品 0-&gt;1</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;0&quot;</span>.equals(oldData.get(<span class="hljs-string">&quot;is_marketable&quot;</span>)) &amp;&amp; <span class="hljs-string">&quot;1&quot;</span>.equals(newData.get(<span class="hljs-string">&quot;is_marketable&quot;</span>)))&#123;<br>            <span class="hljs-comment">//将商品的spuid发送到mq</span><br>            rabbitTemplate.convertAndSend(RabbitMQConfig.GOODS_UP_EXCHANGE, <span class="hljs-string">&quot;&quot;</span>, newData.get(<span class="hljs-string">&quot;id&quot;</span>));<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="3-3-2-创建索引结构"><a href="#3-3-2-创建索引结构" class="headerlink" title="3.3.2 创建索引结构"></a>3.3.2 创建索引结构</h4><p>新建changgou_service_search_api模块,并添加索引库实体类</p><ol><li><p>添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.changgou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>changgou_common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>创建实体类</p><p>注意： </p><ul><li><code>@Document</code>标示映射到Elasticsearch文档上的领域对象, <code>indexName = &quot;skuinfo&quot;</code>表明这个索引库的名称是skuinfo，<code>docs</code>表明这个索引库的类型是<code>_doc</code></li><li><code>@Field(index = true, store = true, type = FieldType.Keyword)</code>, 依次表示建立倒排索引，存储文档数据，不需要中文分词的字段设置成@Field(type = FieldType.Keyword)类型，需要中文分词的设置成@Field(analyzer = “ik_max_word”,type = FieldType.Text)类型</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Document(indexName = &quot;skuinfo&quot;, type = &quot;docs&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SkuInfo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;<br>    <span class="hljs-comment">//商品id，同时也是商品编号</span><br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-meta">@Field(index = true, store = true, type = FieldType.Keyword)</span><br>    <span class="hljs-keyword">private</span> Long id;<br><br>    <span class="hljs-comment">//SKU名称</span><br>    <span class="hljs-meta">@Field(index = true, store = true, type = FieldType.Text, analyzer = &quot;ik_smart&quot;)</span><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-comment">//商品价格，单位为：元</span><br>    <span class="hljs-meta">@Field(index = true, store = true, type = FieldType.Double)</span><br>    <span class="hljs-keyword">private</span> Long price;<br><br>    <span class="hljs-comment">//库存数量</span><br>    <span class="hljs-meta">@Field(index = true, store = true, type = FieldType.Integer)</span><br>    <span class="hljs-keyword">private</span> Integer num;<br><br>    <span class="hljs-comment">//商品图片</span><br>    <span class="hljs-meta">@Field(index = false, store = true, type = FieldType.Text)</span><br>    <span class="hljs-keyword">private</span> String image;<br><br>    <span class="hljs-comment">//商品状态，1-正常，2-下架，3-删除</span><br>    <span class="hljs-meta">@Field(index = true, store = true, type = FieldType.Keyword)</span><br>    <span class="hljs-keyword">private</span> String status;<br><br>    <span class="hljs-comment">//创建时间</span><br>    <span class="hljs-keyword">private</span> Date createTime;<br><br>    <span class="hljs-comment">//更新时间</span><br>    <span class="hljs-keyword">private</span> Date updateTime;<br><br>    <span class="hljs-comment">//是否默认</span><br>    <span class="hljs-meta">@Field(index = true, store = true, type = FieldType.Keyword)</span><br>    <span class="hljs-keyword">private</span> String isDefault;<br><br>    <span class="hljs-comment">//SPUID</span><br>    <span class="hljs-meta">@Field(index = true, store = true, type = FieldType.Long)</span><br>    <span class="hljs-keyword">private</span> Long spuId;<br><br>    <span class="hljs-comment">//类目ID</span><br>    <span class="hljs-meta">@Field(index = true, store = true, type = FieldType.Long)</span><br>    <span class="hljs-keyword">private</span> Long categoryId;<br><br>    <span class="hljs-comment">//类目名称</span><br>    <span class="hljs-meta">@Field(index = true, store = true, type = FieldType.Keyword)</span><br>    <span class="hljs-keyword">private</span> String categoryName;<br><br>    <span class="hljs-comment">//品牌名称</span><br>    <span class="hljs-meta">@Field(index = true, store = true, type = FieldType.Keyword)</span><br>    <span class="hljs-keyword">private</span> String brandName;<br><br>    <span class="hljs-comment">//规格</span><br>    <span class="hljs-keyword">private</span> String spec;<br><br>    <span class="hljs-comment">//规格参数</span><br>    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; specMap;<br>    <br>    <span class="hljs-comment">//getter &amp; setter略</span><br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="3-3-3-搜索微服务搭建"><a href="#3-3-3-搜索微服务搭建" class="headerlink" title="3.3.3 搜索微服务搭建"></a>3.3.3 搜索微服务搭建</h4><ol><li><p>创建changgou_service_search模块，pom.xml引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.changgou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>changgou_common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.changgou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>changgou_service_goods_api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.changgou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>changgou_service_search_api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>配置changgou_service_search的application.yml文件</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9009</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">search</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.128</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.128</span><br>  <span class="hljs-attr">main:</span><br>    <span class="hljs-attr">allow-bean-definition-overriding:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#当遇到同样名字的时候，是否允许覆盖注册</span><br>  <span class="hljs-attr">data:</span><br>    <span class="hljs-attr">elasticsearch:</span><br>      <span class="hljs-attr">cluster-name:</span> <span class="hljs-string">elasticsearch</span><br>      <span class="hljs-attr">cluster-nodes:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.128</span><span class="hljs-string">:9300</span><br>  <span class="hljs-attr">thymeleaf:</span><br>    <span class="hljs-attr">cache:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://127.0.0.1:6868/eureka</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">hystrix:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">default:</span>   <span class="hljs-comment">#配置全局的feign的调用超时时间  如果 有指定的服务配置 默认的配置不会生效</span><br>        <span class="hljs-attr">connectTimeout:</span> <span class="hljs-number">600000</span> <span class="hljs-comment"># 指定的是 消费者 连接服务提供者的连接超时时间 是否能连接  单位是毫秒</span><br>        <span class="hljs-attr">readTimeout:</span> <span class="hljs-number">600000</span>  <span class="hljs-comment"># 指定的是调用服务提供者的 服务 的超时时间（）  单位是毫秒</span><br><span class="hljs-comment">#hystrix 配置</span><br><span class="hljs-attr">hystrix:</span><br>  <span class="hljs-attr">command:</span><br>    <span class="hljs-attr">default:</span><br>      <span class="hljs-attr">execution:</span><br>        <span class="hljs-attr">timeout:</span><br>          <span class="hljs-comment">#如果enabled设置为false，则请求超时交给ribbon控制</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>        <span class="hljs-attr">isolation:</span><br>          <span class="hljs-attr">strategy:</span> <span class="hljs-string">SEMAPHORE</span><br></code></pre></td></tr></table></figure></li><li><p>创建com.changgou包，包下创建SearchApplication启动类</p><p>注意：</p><ul><li><code>@EnableFeignClients</code>使用<strong>basePackages</strong>属性字段去指明应用程序在启动的时候需要扫描服务中的标注了@FeignClient注解的接口的包路径</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-meta">@EnableEurekaClient</span><br><span class="hljs-meta">@EnableFeignClients(basePackages = &#123;&quot;com.changgou.goods.feign&quot;&#125;)</span> <br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SearchApplication</span> </span>&#123;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SpringApplication.run(SearchApplication.class,args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>将rabbitmq配置类放入该模块下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RabbitMQConfig</span> </span>&#123;<br><br>    <span class="hljs-comment">//定义交换机名称</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String GOODS_UP_EXCHANGE=<span class="hljs-string">&quot;goods_up_exchange&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String GOODS_DOWN_EXCHANGE=<span class="hljs-string">&quot;goods_down_exchange&quot;</span>;<br><br>    <span class="hljs-comment">//定义队列名称</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String AD_UPDATE_QUEUE=<span class="hljs-string">&quot;ad_update_queue&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SEARCH_ADD_QUEUE=<span class="hljs-string">&quot;search_add_queue&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SEARCH_DEL_QUEUE=<span class="hljs-string">&quot;search_del_queue&quot;</span>;<br><br>    <span class="hljs-comment">//声明队列</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">queue</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(AD_UPDATE_QUEUE);<br>    &#125;<br>    <span class="hljs-meta">@Bean(SEARCH_ADD_QUEUE)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">SEARCH_ADD_QUEUE</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(SEARCH_ADD_QUEUE);<br>    &#125;<br>    <span class="hljs-meta">@Bean(SEARCH_DEL_QUEUE)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">SEARCH_DEL_QUEUE</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(SEARCH_DEL_QUEUE);<br>    &#125;<br><br>    <span class="hljs-comment">//声明交换机</span><br>    <span class="hljs-meta">@Bean(GOODS_UP_EXCHANGE)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Exchange <span class="hljs-title">GOODS_UP_EXCHANGE</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> ExchangeBuilder.fanoutExchange(GOODS_UP_EXCHANGE).durable(<span class="hljs-keyword">true</span>).build();<br>    &#125;<br>    <span class="hljs-meta">@Bean(GOODS_DOWN_EXCHANGE)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Exchange <span class="hljs-title">GOODS_DOWN_EXCHANGE</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> ExchangeBuilder.fanoutExchange(GOODS_DOWN_EXCHANGE).durable(<span class="hljs-keyword">true</span>).build();<br>    &#125;<br><br><br>    <span class="hljs-comment">//队列与交换机的绑定</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">GOODS_UP_EXCHANGE_BINDING</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(SEARCH_ADD_QUEUE)</span>Queue queue,<span class="hljs-meta">@Qualifier(GOODS_UP_EXCHANGE)</span>Exchange exchange)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="hljs-string">&quot;&quot;</span>).noargs();<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">GOODS_DOWN_EXCHANGE_BINDING</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(SEARCH_DEL_QUEUE)</span>Queue queue,<span class="hljs-meta">@Qualifier(GOODS_DOWN_EXCHANGE)</span>Exchange exchange)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="hljs-string">&quot;&quot;</span>).noargs();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="3-3-4-商品服务查询商品信息"><a href="#3-3-4-商品服务查询商品信息" class="headerlink" title="3.3.4 商品服务查询商品信息"></a>3.3.4 商品服务查询商品信息</h4><ol><li><p>SkuController新增方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/spu/&#123;spuId&#125;&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Sku&gt; <span class="hljs-title">findSkuListBySpuId</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String spuId)</span></span>&#123;<br>    Map&lt;String, Object&gt; searchMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>   <br>    <span class="hljs-keyword">if</span> (!<span class="hljs-string">&quot;all&quot;</span>.equals(spuId))&#123;<br>        searchMap.put(<span class="hljs-string">&quot;spuId&quot;</span>,spuId);<br>    &#125;<br>    searchMap.put(<span class="hljs-string">&quot;status&quot;</span>,<span class="hljs-string">&quot;1&quot;</span>);<br>    List&lt;Sku&gt; skuList = skuService.findList(searchMap);<br>   <br>    <span class="hljs-keyword">return</span> skuList;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>changgou_service_goods_api新增common依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.changgou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>changgou_common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>changgou_service_goods_api新增feign包并定义skuFegin接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name=&quot;goods&quot;)</span><br><span class="hljs-meta">@RequestMapping(&quot;/sku&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SkuFeign</span> </span>&#123;<br><br>    <span class="hljs-comment">/***</span><br><span class="hljs-comment">     * 多条件搜索品牌数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> spuId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/spu/&#123;spuId&#125;&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Sku&gt; <span class="hljs-title">findSkuListBySpuId</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;spuId&quot;)</span> String spuId)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="3-3-5-搜索微服务批量导入数据逻辑"><a href="#3-3-5-搜索微服务批量导入数据逻辑" class="headerlink" title="3.3.5 搜索微服务批量导入数据逻辑"></a>3.3.5 搜索微服务批量导入数据逻辑</h4><ol><li><p>创建 com.changgou.search.dao包,并新增ESManagerMapper接口（这里是操作es的详细步骤，其实和操作mysql的比较类似）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ESManagerMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ElasticsearchRepository</span>&lt;<span class="hljs-title">SkuInfo</span>,<span class="hljs-title">Long</span>&gt; </span>&#123;  <span class="hljs-comment">// 括号里表示的是当前要操作的实体类和当前主键的数据类型</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>创建 com.changgou.search.service包，包下创建接口EsManagerService</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ESManagerService</span> </span>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建索引库结构</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">createMappingAndIndex</span><span class="hljs-params">()</span></span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 导入全部数据到ES索引库</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">importAll</span><span class="hljs-params">()</span></span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据spuid导入数据到ES索引库</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> spuId 商品id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">importDataBySpuId</span><span class="hljs-params">(String spuId)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>创建com.changgou.search.service.impl包，包下创建服务实现类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ESManagerServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ESManagerService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ElasticsearchTemplate elasticsearchTemplate;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SkuFeign skuFeign;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ESManagerMapper esManagerMapper;<br><br>    <span class="hljs-comment">//创建索引库结构</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">createMappingAndIndex</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">//创建索引</span><br>        elasticsearchTemplate.createIndex(SkuInfo.class);<br>        <span class="hljs-comment">//创建映射</span><br>        elasticsearchTemplate.putMapping(SkuInfo.class);<br>    &#125;<br><br>    <span class="hljs-comment">//导入全部sku集合进入到索引库</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">importAll</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">//查询sku集合</span><br>        List&lt;Sku&gt; skuList = skuFeign.findSkuListBySpuId(<span class="hljs-string">&quot;all&quot;</span>);<br>        <span class="hljs-keyword">if</span> (skuList == <span class="hljs-keyword">null</span> || skuList.size()&lt;=<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;当前没有数据被查询到,无法导入索引库&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">//skulist转换为json</span><br>        String jsonSkuList = JSON.toJSONString(skuList);<br>        <span class="hljs-comment">//将json转换为skuinfo</span><br>        List&lt;SkuInfo&gt; skuInfoList = JSON.parseArray(jsonSkuList, SkuInfo.class);<br><br>        <span class="hljs-keyword">for</span> (SkuInfo skuInfo : skuInfoList) &#123;<br>            <span class="hljs-comment">//将规格信息转换为map</span><br>            Map specMap = JSON.parseObject(skuInfo.getSpec(), Map.class);<br>            skuInfo.setSpecMap(specMap);<br>        &#125;<br><br>        <span class="hljs-comment">//导入索引库</span><br>        esManagerMapper.saveAll(skuInfoList);<br>    &#125;<br><br>    <span class="hljs-comment">//根据spuid查询skuList,添加到索引库</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">importDataBySpuId</span><span class="hljs-params">(String spuId)</span> </span>&#123;<br>        List&lt;Sku&gt; skuList = skuFeign.findSkuListBySpuId(spuId);<br>        <span class="hljs-keyword">if</span> (skuList == <span class="hljs-keyword">null</span> || skuList.size()&lt;=<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;当前没有数据被查询到,无法导入索引库&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">//将集合转换为json</span><br>        String jsonSkuList = JSON.toJSONString(skuList);<br>        List&lt;SkuInfo&gt; skuInfoList = JSON.parseArray(jsonSkuList, SkuInfo.class);<br><br>        <span class="hljs-keyword">for</span> (SkuInfo skuInfo : skuInfoList) &#123;<br>            <span class="hljs-comment">//将规格信息进行转换</span><br>            Map specMap = JSON.parseObject(skuInfo.getSpec(), Map.class);<br>            skuInfo.setSpecMap(specMap);<br>        &#125;<br><br>        <span class="hljs-comment">//添加索引库</span><br>        esManagerMapper.saveAll(skuInfoList);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>创建com.changgou.search.controller.定义ESManagerController</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/manager&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ESManagerController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ESManagerService esManagerService;<br><br>    <span class="hljs-comment">//创建索引库结构</span><br>    <span class="hljs-meta">@GetMapping(&quot;/create&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">create</span><span class="hljs-params">()</span></span>&#123;<br>        esManagerService.createMappingAndIndex();<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>, StatusCode.OK,<span class="hljs-string">&quot;创建索引库结构成功&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//导入全部数据</span><br>    <span class="hljs-meta">@GetMapping(&quot;/importAll&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">importAll</span><span class="hljs-params">()</span></span>&#123;<br>        esManagerService.importAll();<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Result(<span class="hljs-keyword">true</span>, StatusCode.OK,<span class="hljs-string">&quot;导入全部数据成功&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="3-3-6-接收mq消息执行导入"><a href="#3-3-6-接收mq消息执行导入" class="headerlink" title="3.3.6 接收mq消息执行导入"></a>3.3.6 接收mq消息执行导入</h4><p>changgou_service_search工程创建com.changgou.search.listener包，包下创建类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GoodsUpListener</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ESManagerService esManagerService;<br><br>    <span class="hljs-meta">@RabbitListener(queues = RabbitMQConfig.SEARCH_ADD_QUEUE)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiveMessage</span><span class="hljs-params">(String spuId)</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;接收到的消息为:   &quot;</span>+spuId);<br><br>        <span class="hljs-comment">//查询skulist,并导入到索引库</span><br>        esManagerService.importDataBySpuId(spuId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-3-7-测试"><a href="#3-3-7-测试" class="headerlink" title="3.3.7 测试"></a>3.3.7 测试</h4><ol><li><p>启动环境 eureka 、elasticsearch 、canal服务端、canal数据监控微服务、rabbitmq</p></li><li><p>启动商品微服务、搜索微服务</p></li><li><p>修改tb_spu某记录的is_marketable值为1，观察控制台输出，启动kibana查询记录是否导入成功</p><p>可以看到成功导入3条数据</p><p><img src="/images/image-20210804135358627.png" alt="image-20210804135358627"></p></li></ol><h2 id="4-商品下架索引库删除数据"><a href="#4-商品下架索引库删除数据" class="headerlink" title="4. 商品下架索引库删除数据"></a>4. 商品下架索引库删除数据</h2><h3 id="4-1-需求分析"><a href="#4-1-需求分析" class="headerlink" title="4.1 需求分析"></a>4.1 需求分析</h3><p>商品下架后将商品从索引库中移除。</p><h3 id="4-2-实现思路"><a href="#4-2-实现思路" class="headerlink" title="4.2 实现思路"></a>4.2 实现思路</h3><p>思路与商品上架思路非常相似</p><ol><li><p>在数据监控微服务中监控tb_spu表的数据，当tb_spu发生更改且is_marketable为0时，表示商品下架，将spu的id发送到rabbitmq。</p></li><li><p>在rabbitmq管理后台创建商品下架交换器（fanout）。使用分列模式的交换器是考虑商品下架会有很多种逻辑需要处理，索引库删除数据只是其中一项，另外还有删除商品详细页等操作</p></li><li><p>搜索微服务从rabbitmq的的队列中提取spu的id，通过调用elasticsearch的高级restAPI 将相关的sku列表从索引库删除</p><p><img src="/images/image-20210804135821285.png" alt="image-20210804135821285"></p></li></ol><h3 id="4-3-代码实现"><a href="#4-3-代码实现" class="headerlink" title="4.3 代码实现"></a>4.3 代码实现</h3><ol><li><p><strong>创建交换器与队列</strong></p><p>完成商品下架交换器的创建，队列的创建与绑定，将spuId发送消息到mq</p><p>商品下架交换器：goods_down_exchange</p><p>队列名称： search_delete_queue</p><p>绑定 search_delete_queue到goods_down_exchange</p><p>完善RabbitMQConfig的代码</p><p><img src="/images/image-20210804140359619.png" alt="image-20210804140359619"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RabbitMQConfig</span> </span>&#123;<br>    <span class="hljs-comment">//交换机名称</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String GOODS_UP_EXCHANGE=<span class="hljs-string">&quot;goods_up_exchange&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String GOODS_DOWN_EXCHANGE=<span class="hljs-string">&quot;goods_down_exchange&quot;</span>;<br><br>    <span class="hljs-comment">//定义队列名称 (tips: 大小写转换快捷键：CTRL+SHIFT+U)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SEARCH_ADD_QUEUE=<span class="hljs-string">&quot;search_add_queue&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String AD_UPDATE_QUEUE = <span class="hljs-string">&quot;ad_update_queue&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SEARCH_DEL_QUEUE=<span class="hljs-string">&quot;search_del_queue&quot;</span>;<br><br>    <span class="hljs-comment">//声明队列</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">queue</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(AD_UPDATE_QUEUE);<br>    &#125;<br><br>    <span class="hljs-comment">//声明队列</span><br>    <span class="hljs-meta">@Bean(SEARCH_ADD_QUEUE)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">SEARCH_ADD_QUEUE</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(SEARCH_ADD_QUEUE);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean(SEARCH_DEL_QUEUE)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">SEARCH_DEL_QUEUE</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(SEARCH_DEL_QUEUE);<br>    &#125;<br><br>    <span class="hljs-comment">//声明交换机</span><br>    <span class="hljs-meta">@Bean(GOODS_UP_EXCHANGE)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Exchange <span class="hljs-title">GOODS_UP_EXCHANGE</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> ExchangeBuilder.fanoutExchange(GOODS_UP_EXCHANGE).durable(<span class="hljs-keyword">true</span>).build();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean(GOODS_DOWN_EXCHANGE)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Exchange <span class="hljs-title">GOODS_DOWN_EXCHANGE</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">return</span> ExchangeBuilder.fanoutExchange(GOODS_DOWN_EXCHANGE).durable(<span class="hljs-keyword">true</span>).build();<br>    &#125;<br><br>    <span class="hljs-comment">//队列绑定交换机</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">SEARCH_ADD_QUEUE_BINDING</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(SEARCH_ADD_QUEUE)</span> Queue queue, <span class="hljs-meta">@Qualifier(GOODS_UP_EXCHANGE)</span> Exchange exchange)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="hljs-string">&quot;&quot;</span>).noargs();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">GOODS_DOWN_EXCHANGE_BINDING</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier(SEARCH_DEL_QUEUE)</span>Queue queue,<span class="hljs-meta">@Qualifier(GOODS_DOWN_EXCHANGE)</span>Exchange exchange)</span></span>&#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="hljs-string">&quot;&quot;</span>).noargs();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>由于搜索微服务也会用到消息队列，因此把已经写好的配置类复制一份给它</p><p><img src="/images/image-20210804140812672.png" alt="image-20210804140812672"></p></li><li><p><strong>canal监听下架</strong></p><p>修改changgou_canal的SpuListener的spuUpdate方法，添加以下代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//获取最新下架的商品 1-&gt;0</span><br><span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;1&quot;</span>.equals(oldData.get(<span class="hljs-string">&quot;is_marketable&quot;</span>)) &amp;&amp; <span class="hljs-string">&quot;0&quot;</span>.equals(newData.get(<span class="hljs-string">&quot;is_marketable&quot;</span>)))&#123;<br>    <span class="hljs-comment">//将商品的spuid发送到mq</span><br>    rabbitTemplate.convertAndSend(RabbitMQConfig.GOODS_DOWN_EXCHANGE,<span class="hljs-string">&quot;&quot;</span>,newData.get(<span class="hljs-string">&quot;id&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>根据spuId删除索引数据</strong></p><p>编写业务逻辑，实现根据spuId删除索引库数据的方法。</p><ol><li><p>ESManagerService新增方法定义</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//根据souid删除es索引库中相关的sku数据</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">delDataBySpuId</span><span class="hljs-params">(String spuId)</span></span>;<br></code></pre></td></tr></table></figure></li><li><p>ESManagerServiceImpl实现方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">delDataBySpuId</span><span class="hljs-params">(String spuId)</span> </span>&#123;<br>    List&lt;Sku&gt; skuList = skuFeign.findSkuListBySpuId(spuId);<br>    <span class="hljs-keyword">if</span> (skuList == <span class="hljs-keyword">null</span> || skuList.size()&lt;=<span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;当前没有数据被查询到,无法导入索引库&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span> (Sku sku : skuList) &#123;<br>        esManagerMapper.deleteById(Long.parseLong(sku.getId()));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol></li><li><p><strong>接受mq消息，执行索引库删除</strong></p><p>从rabbitmq中提取消息，调动根据spuId删除索引库数据的方法 changgou_service_search新增监听类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GoodsDelListener</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ESManagerService esManagerService;<br><br>    <span class="hljs-meta">@RabbitListener(queues = RabbitMQConfig.SEARCH_DEL_QUEUE)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiveMessage</span><span class="hljs-params">(String spuId)</span></span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;删除索引库监听类,接收到的spuId:  &quot;</span>+spuId);<br><br>        <span class="hljs-comment">//调用业务层完成索引库数据删除</span><br>        esManagerService.delDataBySpuId(spuId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <categories>
      
      <category>畅购商城项目</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Fluid样式修改</title>
    <link href="/2021/06/28/0.%20fluid%E6%A0%B7%E5%BC%8F%E4%BF%AE%E6%94%B9/"/>
    <url>/2021/06/28/0.%20fluid%E6%A0%B7%E5%BC%8F%E4%BF%AE%E6%94%B9/</url>
    
    <content type="html"><![CDATA[<h1 id="修改fluid主题样式大致流程"><a href="#修改fluid主题样式大致流程" class="headerlink" title="修改fluid主题样式大致流程"></a>修改fluid主题样式大致流程</h1><h2 id="1-定位资源"><a href="#1-定位资源" class="headerlink" title="1. 定位资源"></a>1. 定位资源</h2><ol><li>打开下图文件夹处</li></ol><p><img src="/images/image-20210806152838538.png" alt="image-20210806152838538"></p><ol start="2"><li><p>在此处打开git bash 命令行，并通过<code>code ./</code>打开vscode进行编辑</p><p><img src="/images/image-20210806153104629.png" alt="image-20210806153104629"></p></li></ol><h2 id="2-修改样式"><a href="#2-修改样式" class="headerlink" title="2. 修改样式"></a>2. 修改样式</h2><ol><li><p>在 plugin.js文件中，我去掉了标题的超链接样式，代码如下(注意他的相对位置)</p><p>165行</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-comment">//下面这个函数注释掉最后一行</span><br>initAnchor: function() &#123;<br>  <span class="hljs-keyword">if</span> (!(<span class="hljs-string">&#x27;anchors&#x27;</span> <span class="hljs-keyword">in</span> window)) &#123; return; &#125;<br>   <br>  window<span class="hljs-selector-class">.anchors</span><span class="hljs-selector-class">.options</span> = &#123;<br>    placement: CONFIG<span class="hljs-selector-class">.anchorjs</span><span class="hljs-selector-class">.placement</span>,<br>    visible  : CONFIG<span class="hljs-selector-class">.anchorjs</span><span class="hljs-selector-class">.visible</span><br>    <br>  &#125;;<br>  <span class="hljs-keyword">if</span> (CONFIG<span class="hljs-selector-class">.anchorjs</span>.<span class="hljs-attribute">icon</span>) &#123;<br>    window<span class="hljs-selector-class">.anchors</span><span class="hljs-selector-class">.options</span><span class="hljs-selector-class">.icon</span> = CONFIG<span class="hljs-selector-class">.anchorjs</span>.<span class="hljs-attribute">icon</span>;<br>  &#125;<br>  <span class="hljs-selector-tag">var</span> el = (CONFIG<span class="hljs-selector-class">.anchorjs</span><span class="hljs-selector-class">.element</span> || <span class="hljs-string">&#x27;h1,h2,h3,h4,h5,h6&#x27;</span>)<span class="hljs-selector-class">.split</span>(<span class="hljs-string">&#x27;,&#x27;</span>);<br>  <span class="hljs-selector-tag">var</span> res = <span class="hljs-selector-attr">[]</span>;<br>  <span class="hljs-keyword">for</span> (const item of el) &#123;<br>    res<span class="hljs-selector-class">.push</span>(<span class="hljs-string">&#x27;.markdown-body &gt; &#x27;</span> + item);<br>  &#125;<br>  <span class="hljs-comment">//window.anchors.add(res.join(&#x27;, &#x27;));</span><br>&#125;, <br></code></pre></td></tr></table></figure></li><li><p>在copy.stl文件中，我去掉了代码框右上角的鼠标悬停显示copy的样式，代码如下(注意他的相对位置)</p><p>第一行</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-class">.copy-btn</span><br>  <span class="hljs-comment">//display inline-block</span><br>  <span class="hljs-attribute">display</span> none<br></code></pre></td></tr></table></figure><p><img src="/images/image-20210806153755890.png" alt="image-20210806153755890"></p></li><li><p>在 rewrite.styl文件中，去掉图片的边框阴影</p><p>代码如下 (注释的那一行就是去掉阴影效果)</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-tag">p</span> &gt; <span class="hljs-selector-tag">img</span>, <span class="hljs-selector-tag">p</span> &gt; <span class="hljs-selector-tag">a</span> &gt; <span class="hljs-selector-tag">img</span><br>  <span class="hljs-attribute">max-width</span> <span class="hljs-number">90%</span><br>  <span class="hljs-attribute">margin</span> <span class="hljs-number">1.5rem</span> auto<br>  <span class="hljs-attribute">display</span> block<br>  <span class="hljs-comment">//box-shadow $img-shadow  // 增加边框阴影效果</span><br>  <span class="hljs-attribute">border-radius</span> <span class="hljs-number">3px</span><br></code></pre></td></tr></table></figure></li><li><p>在 post.styl文件中，去掉图片下方名称和间距</p><p>添加了<code>display: none</code>, 表示不显示image-caption</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-class">.markdown-body</span> <span class="hljs-selector-class">.image-caption</span><br>  <span class="hljs-attribute">display</span>: none<br>  <span class="hljs-attribute">font-size</span> .<span class="hljs-number">8rem</span><br>  <span class="hljs-attribute">color</span> var(--post-text-color)<br>  <span class="hljs-attribute">opacity</span> <span class="hljs-number">0.65</span><br>  <span class="hljs-attribute">line-height</span> <span class="hljs-number">1</span><br>  <span class="hljs-attribute">margin</span> -<span class="hljs-number">0.75rem</span> auto <span class="hljs-number">2rem</span><br>  <span class="hljs-attribute">text-align</span> center<br></code></pre></td></tr></table></figure></li></ol><h2 id="3-完成页面部署"><a href="#3-完成页面部署" class="headerlink" title="3. 完成页面部署"></a>3. 完成页面部署</h2><p>待样式更改完毕后，在blog的下一级目录开启git命令行，输入命令</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">hexo</span> g <span class="hljs-comment"># 生成页面</span><br></code></pre></td></tr></table></figure><p>然后开启hexo本地服务,</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">hexo s</span><br></code></pre></td></tr></table></figure><p>浏览器输入网址：localhost:4000，访问博客。可以发现，此时样式已经发生变化</p><p>最后部署到远端仓库</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">hexo d</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
